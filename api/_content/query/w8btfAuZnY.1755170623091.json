{"_path":"/sdi-aig/chapter6","_dir":"sdi-aig","_draft":false,"_partial":false,"_locale":"","title":"設計鍵值儲存系統","description":"ref: CHAPTER 06：DESIGN A KEY-VALUE STORE.md","pageTitle":"Chapter 6 設計鍵值儲存系統","body":{"type":"root","children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ref: "},{"type":"element","tag":"a","props":{"href":"https://github.com/Admol/SystemDesign/blob/main/CHAPTER%2006%EF%BC%9ADESIGN%20A%20KEY-VALUE%20STORE.md","rel":["nofollow"]},"children":[{"type":"text","value":"CHAPTER 06：DESIGN A KEY-VALUE STORE.md"}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ref: "},{"type":"element","tag":"a","props":{"href":"https://tw.annas-archive.org/md5/e89be9442169fe8f89a2fda597797668","rel":["nofollow"]},"children":[{"type":"text","value":"https://tw.annas-archive.org/md5/e89be9442169fe8f89a2fda597797668"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ref: "},{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=8TE2DvpKxvA","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.youtube.com/watch?v=8TE2DvpKxvA"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ref: "},{"type":"element","tag":"a","props":{"href":"https://youtu.be/o6q8zPmfVLU?si=M7Y-FWqM-tuORxn7","rel":["nofollow"]},"children":[{"type":"text","value":"https://youtu.be/o6q8zPmfVLU?si=M7Y-FWqM-tuORxn7"}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"以 C# /.NET 8 與 MSSQL 為主要範例語言／平台，分 2 – 3 次（每次 40‑50 分鐘）循序漸進講解本章重點，並輔以可執行的程式碼片段與示意圖。"}]}]},{"type":"element","tag":"h2","props":{"id":"整體章節重點-birdeye-view"},"children":[{"type":"text","value":"整體章節重點 (Bird‑Eye View)"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Key‑Value Store 基礎"}]},{"type":"text","value":"：資料模型、操作介面 ("},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"put"}]},{"type":"text","value":" / "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"get"}]},{"type":"text","value":")。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"擴充挑戰"}]},{"type":"text","value":"：從單機記憶體雜湊表 → 分散式雜湊表 (DHT)。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CAP 與一致性"}]},{"type":"text","value":"：AP / CP 系統選擇、N / W / R 仲裁參數。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料分區與複本"}]},{"type":"text","value":"：一致性雜湊、跨資料中心複寫。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突處理"}]},{"type":"text","value":"：Vector Clock、最終一致性。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"容錯機制"}]},{"type":"text","value":"：Gossip 偵錯、Sloppy Quorum、Hinted Handoff、Anti‑Entropy & Merkle Tree。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀寫流程"}]},{"type":"text","value":"：Commit Log → MemTable → SSTable；MemTable / Bloom Filter 多層快取。"}]}]},{"type":"element","tag":"h2","props":{"id":"本章要求"},"children":[{"type":"text","value":"本章要求"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"設計出一個可支援以下操作的鍵值儲存系統："}]}]},{"type":"element","tag":"pre","props":{"code":"  - put(key, value) // 插入一組與「key」鍵相關聯的「vlaue」值\n  - get(key) // 取出與「key」鍵相關聯的「vlaue」值\n","language":"c#","meta":"","className":"language-c# shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  -"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" put"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(key, value) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 插入一組與「key」鍵相關聯的「vlaue」值\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"  -"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" get"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(key) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 取出與「key」鍵相關聯的「vlaue」值\n"}]}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"瞭解問題並確立設計的範圍"},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"天底下沒有完美的設計。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n每一種設計都必須在記憶體讀取、寫入與使用方面進行取捨，以達到某種特定的平衡。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n在一致性與可用性之間，也需要進行權衡取捨。"},{"type":"element","tag":"br","props":{},"children":[]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"設計的範圍設定：\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"鍵值對的尺寸很小，小於 10 KB。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"有能力儲存大數據資料。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"高可用性：即使發生故障，系統也可以快速回應。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"高擴展性：系統可進行擴展，以支援大型資料集。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"自動擴展：應該可以根據流量，自動添加/移除伺服器。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"可調整系統一致性的程度。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"低延遲。"}]}]}]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"session1-從零開始認識-keyvalue-store"},"children":[{"type":"text","value":"Session 1 ： 從零開始認識 Key‑Value Store"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"鍵值資料庫（Key-Value Store，也稱鍵值存儲）是一種"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"非關聯式資料庫"}]},{"type":"text","value":"，以 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"「鍵-值對」"}]},{"type":"text","value":" 形式儲存資料。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每筆資料由 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"唯一的鍵（key）"}]},{"type":"text","value":" 識別並對應一個 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"值（value）"}]},{"type":"text","value":"，類似 Dictionary 或 Hash Table 的概念。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"鍵："}]},{"type":"text","value":" 通常為短字串或其雜湊，須具唯一性以快速索引；"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"值："}]},{"type":"text","value":" 可以是任意類型的二進位資料，系統通常將值視為不透明的blob（例如 Redis、Memcached 即採用此模型）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"主流產品 (Redis、DynamoDB…)"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/table-6-1.png"},"children":[]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"session2-單機設計-vs-分散式挑戰"},"children":[{"type":"text","value":"Session 2 ： 單機設計 v.s. 分散式挑戰"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"雜湊表 + 壓縮 + 冷資料落盤"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"何時需要走向分散式 → 大容量、高可用"}]}]},{"type":"element","tag":"h2","props":{"id":"_1-單一伺服器的鍵值儲存系統"},"children":[{"type":"text","value":"(1) 單一伺服器的鍵值儲存系統："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"簡單實作："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"最直接的做法就是把「鍵值對」全部放到記憶體。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"雜湊表（Hash Table） 在記憶體中保存所有鍵值對。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"基本操作包括 put(key, value)（寫入/更新鍵的值）與 get(key)（讀取鍵的值）。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料結構："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"使用如 C# 的 Dictionary<string, string> 即可達成 O(1) 的鍵查詢時間。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"記憶體 vs 磁碟："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"若資料量可能超過記憶體，可透過LRU快取策略將常用資料留在記憶體，不常用資料寫入磁碟檔案；"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"也可採用資料壓縮減少空間。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"容量侷限："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"即使有上述優化，單台伺服器的記憶體與磁碟總有上限，大規模資料最終會超出單機容量。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"此時需要水平擴充（scale out）至分散式鍵值存儲架構。"}]}]}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"_2-分散式鍵值儲存系統"},"children":[{"type":"text","value":"(2) 分散式鍵值儲存系統："}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"分散式鍵值存儲（Distributed Key-Value Store）又稱分散式雜湊表（DHT），透過多部伺服器共同存放整體資料集。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n設計分散式系統時，理解 CAP 定理 極其重要。"},{"type":"element","tag":"br","props":{},"children":[]}]}]},{"type":"element","tag":"h4","props":{"id":"cap-定理簡介"},"children":[{"type":"text","value":"CAP 定理簡介"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CAP 定理，又稱 Brewer 定理，由 Eric Brewer 於 2000 年提出，2002 年經 Seth Gilbert 與 Nancy Lynch 形式化證明。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"定理指出：在一個分散式資料存儲系統中，只能在以下三者中最多同時滿足兩項，無法兼得三者。"}]},{"type":"text","value":" ("},{"type":"element","tag":"a","props":{"href":"https://cloud.tencent.com/developer/article/2355483","rel":["nofollow"],"title":"CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云"},"children":[{"type":"text","value":"腾讯云"}]},{"type":"text","value":")\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"一致性 ( Consistency )、"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"可用性 ( Availability )、"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"分區容錯性 ( Partition Tolerance )"}]}]}]}]},{"type":"element","tag":"h5","props":{"id":"三大屬性定義"},"children":[{"type":"text","value":"三大屬性定義"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性 ( Consistency, C )："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"保證每次讀取都能拿到最新的寫入值，或者返回錯誤，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"也就是「所有節點在同一時間看到相同資料」的強一致性承諾。("},{"type":"element","tag":"a","props":{"href":"https://cloud.tencent.com/developer/article/2355483","rel":["nofollow"],"title":"CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云"},"children":[{"type":"text","value":"腾讯云"}]},{"type":"text","value":")"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可用性 ( Availability, A )："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"系統對每次請求都能在有限時間內做出響應（非錯誤或超時）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"即便部分節點失效，健康節點依然對外提供服務。("},{"type":"element","tag":"a","props":{"href":"https://cloud.tencent.com/developer/article/2355483","rel":["nofollow"],"title":"CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云"},"children":[{"type":"text","value":"腾讯云"}]},{"type":"text","value":")"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分區容錯性 ( Partition Tolerance, P )："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"當系統節點間發生網路分區（訊息丟失或延遲）時，仍能繼續對外提供服務。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"由於大規模分散式系統中網路分區幾乎不可避免，P 通常被視為必須保障的屬性。("},{"type":"element","tag":"a","props":{"href":"https://cloud.tencent.com/developer/article/2355483","rel":["nofollow"],"title":"CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云"},"children":[{"type":"text","value":"腾讯云"}]},{"type":"text","value":")"}]}]}]}]},{"type":"element","tag":"h5","props":{"id":"屬性兩兩組合與典型示例"},"children":[{"type":"text","value":"屬性兩兩組合與典型示例"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-1.png"},"children":[]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CA（一致性 + 可用性，放棄 P）"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"適用於無須考慮網路分區容錯的場景，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例如："},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"單機或單資料中心部署"}]},{"type":"text","value":"的關係型資料庫系統（如 SQL Server 等）。("},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/CAP_theorem?utm_source=chatgpt.com","rel":["nofollow"],"title":"CAP theorem - Wikipedia"},"children":[{"type":"text","value":"維基百科"}]},{"type":"text","value":")"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CP（一致性 + 分區容錯，放棄 A）"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在發生分區容錯時"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"優先保證強一致性，犧牲可用性。"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例如：MongoDB，在分區容錯期間會"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"拒絕服務以確保一致性。"}]},{"type":"text","value":"("},{"type":"element","tag":"a","props":{"href":"https://stackoverflow.com/questions/11292215/where-does-mongodb-stand-in-the-cap-theorem?utm_source=chatgpt.com","rel":["nofollow"],"title":"Where does MongoDB stand in the CAP theorem? - Stack Overflow"},"children":[{"type":"text","value":"Stack Overflow"}]},{"type":"text","value":")"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AP（可用性 + 分區容錯，放棄 C）"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在發生分區容錯時"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"優先保證可用性"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"允許短暫不一致，並透過最終一致性（Reconciliation）進行修復。"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例如：Apache Cassandra，即使分區容錯期間也繼續響應請求，"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可能讀到舊值。"}]},{"type":"text","value":" ("},{"type":"element","tag":"a","props":{"href":"https://stackoverflow.com/questions/20205797/which-part-of-the-cap-theorem-does-cassandra-sacrifice-and-why?utm_source=chatgpt.com","rel":["nofollow"],"title":"partitioning - Which part of the CAP theorem does Cassandra sacrifice and why? - Stack Overflow"},"children":[{"type":"text","value":"Stack Overflow"}]},{"type":"text","value":")"}]}]}]}]},{"type":"element","tag":"h5","props":{"id":"理想情況"},"children":[{"type":"text","value":"理想情況"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-2.png"},"children":[]},{"type":"text","value":"\n在理想情況下，永遠不會發生網路分區容錯的問題："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"寫入 n1 的資料自動就會複製到 n2、n3。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如此可達到一致性與可用性。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h5","props":{"id":"現實世界的分散式系統"},"children":[{"type":"text","value":"現實世界的分散式系統"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-3.png"},"children":[]},{"type":"text","value":"\n在真實環境中，網路分區容錯的發生是不可避免的："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"節點 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n3"}]},{"type":"text","value":" 因故離線，無法與 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n1"}]},{"type":"text","value":"、"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n2"}]},{"type":"text","value":" 溝通；"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"若客戶端將資料寫入 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n1"}]},{"type":"text","value":"／"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n2"}]},{"type":"text","value":"，則資料無法傳遞到 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n3"}]},{"type":"text","value":"；"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"若寫入 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n3"}]},{"type":"text","value":" 卻未傳至 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n1"}]},{"type":"text","value":"／"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n2"}]},{"type":"text","value":"，則後者只能保有舊版資料。"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CP 系統（強一致性優先）"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"發生分區時，拒絕或延後對 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n1"}]},{"type":"text","value":"、"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n2"}]},{"type":"text","value":" 的寫入，確保所有可用節點資料一致，犧牲可用性──"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n銀行系統即屬此類，必須保證餘額一定為最新狀態。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AP 系統（可用性優先）"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"分區期間仍接受讀寫，可能返回舊資料；待網路恢復後再同步至 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"n3"}]},{"type":"text","value":"，最終達成一致。"}]}]}]}]},{"type":"element","tag":"h5","props":{"id":"設計取捨與面試要點-cap"},"children":[{"type":"text","value":"設計取捨與面試要點 - CAP"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"為何必須取捨？"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"分散式系統中網路分區（P）不可避免，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"當發生分區時，系統無法同時保證既讀取最新值(C)、又對所有請求都做出響應(A)。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"必須在一致性與可用性間做出取捨。"}]},{"type":"text","value":"("},{"type":"element","tag":"a","props":{"href":"https://ruanyifeng.com/blog/2018/07/cap.html?utm_source=chatgpt.com","rel":["nofollow"],"title":"CAP 定理的含义 - 阮一峰的网络日志"},"children":[{"type":"text","value":"ruanyifeng.com"}]},{"type":"text","value":")"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"如何依場景選擇？"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"金融支付"}]},{"type":"text","value":"：對資料一致性要求極高，常選 CP ，確保交易正確無誤。("},{"type":"element","tag":"a","props":{"href":"https://www.ibm.com/think/topics/cap-theorem?utm_source=chatgpt.com","rel":["nofollow"],"title":"What is the CAP theorem? - IBM"},"children":[{"type":"text","value":"IBM"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"社交推薦、日誌收集"}]},{"type":"text","value":"：對可用性和吞吐量要求優先，常選 AP 。("},{"type":"element","tag":"a","props":{"href":"https://www.ibm.com/think/topics/cap-theorem?utm_source=chatgpt.com","rel":["nofollow"],"title":"What is the CAP theorem? - IBM"},"children":[{"type":"text","value":"IBM"}]},{"type":"text","value":")"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"內部管理系統"}]},{"type":"text","value":"：網路分區風險較低，可選 CA 以簡化設計。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"面試常見考察點"}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"正確認識 C/A/P 三者含義及差異。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"針對不同業務場景，說明為何在 C/A/P 間做出具體取捨。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"以具體系統（如 Key-Value 儲存）為例，闡述如何實現 CAP（Quorum、Hinted Handoff、Anti-Entropy 等機制）。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"透過以上整理，您可在系統設計面試中清晰闡述 CAP 定理，並結合業務需求給出合理架構選擇。"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"session3-鍵值儲存系統的構成元素"},"children":[{"type":"text","value":"Session 3 ： 鍵值儲存系統的構成元素"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們打算在本節討論以下這些核心元素與技術，與建構出相應的鍵值儲存系統。 "},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n以下內容主要是以三個很受歡迎的鍵值儲存系統為基礎： Dynamo、Cassandra 與 BigTable"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"資料分區 ( data partition )"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"資料複製 ( data replication )"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"一致性"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"不一致問題的解決方式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"故障的處理方式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"系統架構圖"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"寫入途徑"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"讀取途徑"}]}]},{"type":"element","tag":"h2","props":{"id":"資料分區一致性雜湊與水平擴充"},"children":[{"type":"text","value":"資料分區：一致性雜湊與水平擴充"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"當資料規模龐大時，將全部鍵值對存於單一節點(伺服器)，是一種不可行的做法。"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料分區（data partition）："}]},{"type":"text","value":" 將資料拆分到多個節點(伺服器)存放。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料分區面臨兩大挑戰："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料均勻分布："}]},{"type":"text","value":" 確保各節點負載均衡，避免有的節點存了過多資料、成為瓶頸。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"動態伸縮："}]},{"type":"text","value":" 節點數量增加或減少時，儘量減少資料在節點間搬移的成本。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"為解決上述問題"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性雜湊（Consistent Hashing）是一種經典技術。"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性雜湊：將整個雜湊值空間組織成一個雜湊環（Hash Ring）然後將節點和資料鍵都映射到此環上。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-4.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"首先，伺服器會被放到雜湊環上。在圖 6-4 中， s0、s1、....、s7 所代表的8部伺服器全都被放到雜湊環上。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"接著，有一個鍵也進行了雜湊運算，而被放到了同一個雜湊環上。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"存放規則："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"從資料鍵映射點 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"順時針"}]},{"type":"text","value":" 遇到的第一個節點，即為此鍵的負責節點。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"key0 運用存放規則的邏輯，最後保存到 s1 之中。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性雜湊的優點："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"自動水平擴充："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"可平滑地新增/移除節點而無需重新分配全部鍵。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"加入節點，只需重新分配"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"鄰近區域"}]},{"type":"text","value":"的一部分鍵；"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"移除節點，其負載自動攤分給鄰近節點。這滿足動態擴縮需求。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最小資料搬移："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"新增或移除節點時，只需移動環上極少量鍵，不影響其它區段的資料。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"負載均衡 ( 可因應 不均勻性/異質性 的問題 )："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"結合"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"虛擬節點"}]},{"type":"text","value":"機制，能讓節點根據性能配置不同數量的虛擬節點，避免因節點性能差異導致負載不均（容量越大的節點可在環上放置更多虛擬節點，獲取較大區間的鍵）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例： 如果某個伺服器的容量比較大，只要指定比較多的虛擬節點給它就可以了。"}]}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"資料複製高可用性的基石"},"children":[{"type":"text","value":"資料複製：高可用性的基石"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"為了達到高可用性與可靠性 ( relibility )"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"為提升系統"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"容錯性"}]},{"type":"text","value":"與"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"高可用性"}]},{"type":"text","value":"，分散式鍵值存儲通常將資料 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"複製（Replication）"}]},{"type":"text","value":" 至多個節點。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"也就是對每個鍵值對保存多份拷貝，放置於"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"不同節點"}]},{"type":"text","value":"，當部分節點故障時仍能由其他副本提供服務。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"常用的複製策略如下： "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"key0 會被複製到 s1 、 s2 、 s3 ( N=3 )"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-5.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"複製因子 N：就是儲存 N 份"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每筆資料儲存 N 份（包含原始1份+ N-1份副本）"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例如： N=3，此時系統至少需有 N 個節點才能容納所有副本。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"副本選擇：必須確保節點不重複"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Key0 先按上述一致性雜湊的方式找到"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"主存節點"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"再沿雜湊環"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"順時針方向選擇接續的 N-1 個"}]},{"type":"text","value":"獨立節點作為副本存放處。\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例如 N=3 時，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"key0 可存於 s1（主）以及後續的 s2、s3 節點上，共三副本。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"若遇到"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"虛擬節點映射同一實體節點的情況，則跳過重複實體以確保副本分散在不同實體節點。"}]}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"跨機房分佈：提高可靠性"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"為防同機房故障導致副本同時損失，通常會將 N 個副本分布在"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"多個資料中心"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"例如：3個副本可放在三個不同機房，透過高速網路互聯同步。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"透過適當的複製策略，可以實現讀取的高可用："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"即使一兩個節點故障，資料的其他副本仍可提供服務。同時多副本也提高了資料耐久性（不易因單點損毀而永久丟失）。"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"註："}]},{"type":"text","value":" 複製帶來"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性維護"}]},{"type":"text","value":"的挑戰 —— 當多個副本存在時，如何確保各副本的值一致，是後續「一致性」與「衝突解決」部分要解決的問題。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"一致性quorum-機制與最終一致性"},"children":[{"type":"text","value":"一致性：Quorum 機制與最終一致性"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果沒有額外措施，不同副本可能出現數據不一致（如有的收到更新，有的因網路問題未收到）。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如前所述，將資料複製到多個節點可以提高可用性，但也帶來"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"副本間數據同步"}]},{"type":"text","value":"的難題。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"為管理一致性，可採用 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Quorum 共識機制"}]},{"type":"text","value":"調節讀寫操作："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"定義："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"N："}]},{"type":"text","value":" 副本的數量 ( 如下圖 6-6，N=3 )。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W："}]},{"type":"text","value":" 寫入的最低門檻，寫入操作必須至少有 W 個副本回應確認，才視為寫入成功。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"R："}]},{"type":"text","value":" 讀取的最低門檻，讀取操作必須等待至少有 R 個副本回應，才視為讀取成功。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"運作："}]},{"type":"text","value":" 以圖 6-6 為例 N=3 資料被製到 s0、s1、s2。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"協調者 ( coordinator ) ："}]},{"type":"text","value":" 代表客戶端與節點之間代理者 ( proxy ) 的角色。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W=1："}]},{"type":"text","value":" 每次"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入"}]},{"type":"text","value":"，協調者"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"必須至少收到一個 ACK 確認"}]},{"type":"text","value":"，才能回覆客戶端成功。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"不代表資料只寫入"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"1個節點"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果從 s1 收到了確認，就不需要再等待 s0 與 s2 的確認了。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W=2："}]},{"type":"text","value":" 每次"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入"}]},{"type":"text","value":"，協調者"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"必須至少收到二個 ACK 確認"}]},{"type":"text","value":"，才能回覆客戶端成功。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果從 s1 收到了確認，要再等待 s0 或 s2 的確認。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"R=2："}]},{"type":"text","value":" 每次"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀取"}]},{"type":"text","value":"，協調者"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"會並行查詢至少2個副本，並等待回應，最後取其中最新版本後再返回"}]},{"type":"text","value":"，才能回覆客戶端成功。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-6.png"},"children":[]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"延遲 vs 一致性："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"W、R 的選擇代表延遲與一致性的權衡。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"W或R越小：操作響應越快，但返回舊數據的風險增大。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"W或R越大：數據一致性越好，但需等待更多節點，延遲提高。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"強一致性保證的條件："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W=N + R=1 ："}]},{"type":"text","value":" 就表示系統針對快速"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀取"}]},{"type":"text","value":"進行最佳化。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W=1 + R=N ："}]},{"type":"text","value":" 就表示系統針對快速"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入"}]},{"type":"text","value":"進行最佳化。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W + R > N ："}]},{"type":"text","value":" 就可以"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"具有強一致性"}]},{"type":"text","value":"。因為任意一筆資料的讀寫集合會在至少一個共同副本相交，確保讀一定能讀到最新寫入。(例如 N=3，W=R=2)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"W + R <= N ："}]},{"type":"text","value":" 則"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"不能保證"}]},{"type":"text","value":"具有強一致性。"}]}]}]}]},{"type":"element","tag":"h5","props":{"id":"設計取捨與面試要點-一致性模型"},"children":[{"type":"text","value":"設計取捨與面試要點 - 一致性模型"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在設計鍵值儲存系統時，一致性模型確實是一個需要考慮的重要因素。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"一致性模型定義的是資料一致性程度，而實際上確實存在各式各樣不同的一致性模型："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"強一致性："}]},{"type":"text","value":" 任何讀取操作所送回的值，都對應到最新寫入資料項的結果。"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"客戶端絕不會看到過時的資料。"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"弱一致性："}]},{"type":"text","value":" 後續的讀取操作有可能看到的並不是最新的值。"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"客戶端可能不是最新的資料。"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性 ( eventual consistency )："}]},{"type":"text","value":" "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"弱一致性的殊殊形式"}]},{"type":"text","value":"，只要給定足夠的時間，所有資料更新終究都會被傳遞，且所有副本都會是一致的。"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"客戶端會現是等待最新資料的過程。"}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n在我們設計的系統中，\n"},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"為了高可用性"}]},{"type":"text","value":"，預設採用 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性 ( eventual consistency )"}]},{"type":"text","value":" 模型，"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"即 AP 模式： "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"允許在短暫時間內副本之間數據不一致，但保證最終（在沒有新的更新後經過足夠時間）所有副本趨於一致。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這意味："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"系統在寫入時不強制所有副本立即同步成功即可返回成功（如採用 W < N），因此短期內不同節點可能讀到"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"舊值"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"系統在背景持續同步副本，或透過讀取修復機制，確保"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終"}]},{"type":"text","value":"各副本一致。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性容忍暫時不一致"}]},{"type":"text","value":"，換取故障情況下仍可接受讀/寫請求（提高可用性）。例如 Dynamo、Cassandra 即採此模型。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然而，最終一致性模型下，不可避免會出現"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"更新衝突"}]},{"type":"text","value":"的問題："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"當網路分區或並發寫入發生時，不同節點可能各自接受了對同一鍵的不同更新，導致系統存在多個版本的值。接下來我們將介紹如何檢測與解決這些衝突。"}]}]},{"type":"element","tag":"h2","props":{"id":"不一致問題的解決方式版本控制-versioning-與向量時鐘-vector-clock"},"children":[{"type":"text","value":"不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"複製：提高可用性，同時也導致副本間產生不一致的問題。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"\n因此，我們需要一個能夠偵測衝突與協調衝突的版本控制系統。"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本控制："}]},{"type":"text","value":" 把每次的資料修改，全都視為資料的一個全新不可變版本。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"向量時鐘："}]},{"type":"text","value":" 解決兩個版本衝突此類問題的常用技術。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本衝突問題舉例："}]},{"type":"text","value":" 圖6-7 －＞ 圖6-8"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"有 2 個副本 n1 與 n2 具有相同 key=\"name\" 並且值相同為 \"john\" ，我們稱為原始值。 ( 圖 6-7 )\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-7.png"},"children":[]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"某刻 Client A 通過節點 n1 將 name 更新為值 \"johnSanFrancisco\""}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"同時 Client B 通過節點 n2 將 name 更新為值 \"johnNewYork\""}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"由於 A、B 幾乎"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"同時寫入"}]},{"type":"text","value":"，且"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入不同節點"}]},{"type":"text","value":"。 2個副本各自被更新為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"不同值"}]},{"type":"text","value":"。( 圖 6-8 )\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-8.png"},"children":[]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"產生衝突版本："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"key=\"name\" 產生兩個衝突值： v1（值=\"johnSanFrancisco\"）與 v2（值=\"johnNewYork\"）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這種情況下，單靠時間戳無法明確判斷哪個版本為「最新」或「正確」，因為兩次寫入發生在不同節點且近乎同時。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"解決衝突版本："}]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本控制："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"定義："}]},{"type":"text","value":" 把每次的資料修改，全都視為資料的一個全新不可變版本。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"向量時鐘："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"為了解決"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"誰覆蓋誰"}]},{"type":"text","value":"的問題。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"為每個資料項維護一個多維版本向量，用來判定版本間的先後或並行關係。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"定義："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"向量時鐘是"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"與資料相關聯的一對資料"}]},{"type":"text","value":"，其形式為 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"節點(伺服器), 版本"}]}]}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"可用來檢查某個版本是否為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最新版本"}]},{"type":"text","value":"、是否為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"成功的版本"}]},{"type":"text","value":"、或是否"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"與其他版本衝突"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D"}]}]},{"type":"text","value":" 的向量時鐘可能為 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D([S1, v1], [S2, v2], ... [Sn, vn])"}]}]},{"type":"text","value":" 。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"S1...Sn"}]}]},{"type":"text","value":" 是參與此資料項更新的節點ID"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"v1...vn"}]}]},{"type":"text","value":" 是該節點對此資料的更新次數。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"更新規則："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每當資料 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D"}]}]},{"type":"text","value":" 在某節點 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Si"}]}]},{"type":"text","value":" 發生寫入\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果向量時鐘中已存在 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Si, vi]"}]}]},{"type":"text","value":" ，則將 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"vi"}]}]},{"type":"text","value":" 加一（該節點對此資料的版本號+1）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果不存在 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Si, vi]"}]}]},{"type":"text","value":"，則新增 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Si, 1]"}]}]},{"type":"text","value":" 條目，表示該節點首次創建此資料版本。"}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本比較："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"將兩個版本的向量時鐘逐分量比較"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本X"}]},{"type":"text","value":" 的每個節點計數都 <= "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本Y"}]},{"type":"text","value":" 的對應計數"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本X"}]},{"type":"text","value":" "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D(［S0, 1］, [S1, 1])"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本Y"}]},{"type":"text","value":" "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D(［S0, 1］, [S1, 2])"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"則 X 是 Y 的祖先版本（即 X 的所有更新都被 Y 包含，無衝突）。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本X"}]},{"type":"text","value":" 的某幾個節點計數比 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本Y"}]},{"type":"text","value":" 的對應計數或大或小"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本X"}]},{"type":"text","value":" "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D(［S0, 1］, [S1, 2])"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本Y"}]},{"type":"text","value":" "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D(［S0, 2］, [S1, 1])"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"則 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本X"}]},{"type":"text","value":" 與 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本Y"}]},{"type":"text","value":" 發生"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"並行衝突"}]},{"type":"text","value":"（即各有部分更新彼此不包含）。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"目前的應用結論"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Amazon Dynamo 就成功在生產環境使用向量時鐘並未遇到不可控的時鐘膨脹問題。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"向量時鐘仍是實用解決方案。"}]}]}]}]}]}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"向量時鐘的缺點"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"透過以上機制，向量時鐘可以"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"避免隨意覆蓋"}]},{"type":"text","value":"並發寫入造成的數據丟失，保留所有衝突版本供合併。值得注意的是，向量時鐘也有缺點："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"增加客戶端複雜度："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"需要客戶端（或應用層）實現衝突合併邏輯，對開發者提出更高要求。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"一些系統（如 Cassandra）乾脆選擇更簡單的 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最後寫入優先 (Last Write Wins)"}]},{"type":"text","value":" 策略，以縮減實現複雜度，但代價是可能捨棄較新的並發更新。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"開銷隨節點數增加："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"向量時鐘裡 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"server:version"}]}]}]},{"type":"text","value":"  這樣成對資料，其數量可能會"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"快速成長"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在大規模系統中，維護數十上百的節點版本向量"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"會增加存儲和傳輸負擔"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"針對長度設定了一個"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"門檻值"}]},{"type":"text","value":"。超過限制長度，就會"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"刪除掉最舊的成對資料"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"導致，無法正正確判斷前後代關系，造成重新協調效果不佳。"}]}]}]}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"舉例："}]},{"type":"text","value":"\n向量時鐘是用 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D([S1, v1], [S2, v2], ... [Sn, vn])"}]}]},{"type":"text","value":" 來表式。\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D"}]}]},{"type":"text","value":"  ：是資料項\n"},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sn"}]}]},{"type":"text","value":" ：是伺服器編號"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"vn"}]}]},{"type":"text","value":" ：是版本計數器\n如果把資料項 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D"}]}]},{"type":"text","value":" 寫入伺服器 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Si"}]}]},{"type":"text","value":" , 則系統就必須執行以下其中一個任務。\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果  "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Si,vi]"}]}]},{"type":"text","value":" 存在， "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"vi"}]}]},{"type":"text","value":" 就加 1。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"否則的話，就建立一個新的項目 "},{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Si,1]"}]}]},{"type":"text","value":" 。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"透過向量時鐘，我們能"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"檢測"}]},{"type":"text","value":"衝突版本並進一步"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"合併"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"以下用實際例子 ( 圖 6-9 ) 說明其工作流程："},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"假設 N=3 節點 Sx, Sy, Sz"}]},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-9.png"},"children":[]}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"這張流程圖示範整個向量時鐘（Vector Clock）在多節點環境下，如何追蹤版本、偵測衝突並最終合併的機制。"}]}]},{"type":"text","value":"*"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"具體來看："}]}]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D1 → D2"}]},{"type":"text","value":"："}]},{"type":"text","value":" 都是透過 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 來寫入"}]},{"type":"text","value":"， "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 的版本計數器從 1 增到 2"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":"："}]},{"type":"text","value":" 有一客戶端在 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy"}]},{"type":"text","value":" 寫入"}]},{"type":"text","value":"，繼承了 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx:2"}]},{"type":"text","value":"，並在 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy"}]},{"type":"text","value":" 新增 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy:1"}]}]},{"type":"text","value":" ( 因為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy"}]},{"type":"text","value":" "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"第一次處理"}]},{"type":"text","value":" ) ，時鐘變成 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"(Sx:2, Sy:1)"}]},{"type":"text","value":" 。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":"："}]},{"type":"text","value":" 另一個客戶端"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"同時在 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sz"}]},{"type":"text","value":" 上寫入"}]},{"type":"text","value":"，同樣繼承 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx:2"}]},{"type":"text","value":"，並新增 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sz:1"}]},{"type":"text","value":" ( 因為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sz"}]},{"type":"text","value":" "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"第一次處理"}]},{"type":"text","value":" )，時鐘變成 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"(Sx:2, Sz:1)"}]},{"type":"text","value":" 。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突偵測："}]},{"type":"text","value":" 因為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"(Sx:2, Sy:1)"}]},{"type":"text","value":" 跟 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"(Sx:2, Sz:1)"}]},{"type":"text","value":" 彼此各有對方沒有的"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分量"}]},{"type":"text","value":"，無法互相包含，所以被判定為衝突版本。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D5"}]},{"type":"text","value":" 合併："}]},{"type":"text","value":" 在 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"應用層"}]},{"type":"text","value":" 把 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 合併後，"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"由 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 再寫入一次"}]},{"type":"text","value":"，"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 的計數器再 +1（從 2 → 3）， 、合併後的時鐘為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"(Sx:3, Sy:1, Sz:1)"}]},{"type":"text","value":" ，它就 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"包含了之前所有分量，因此成為唯一合法的後繼版本"}]},{"type":"text","value":" 。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"「"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分量"}]},{"type":"text","value":"」這個詞在這裡其實是從數學或向量概念延伸而來，指的是"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"向量中每個維度上的值"}]},{"type":"text","value":"，在向量時鐘（Vector Clock）中，這些「分量」就是"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"每個節點的版本號"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"為什麼叫分量"},"children":[{"type":"text","value":"🔍 為什麼叫「分量」？"}]},{"type":"element","tag":"h4","props":{"id":"數學背景"},"children":[{"type":"text","value":"數學背景："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"向量（Vector）是一組有方向和大小的數字集合，例如 "},{"type":"element","tag":"mjx-container","props":{"className":["MathJax"],"jax":"SVG"},"children":[{"type":"element","tag":"svg","props":{"style":"vertical-align: -0.566ex;","xmlns":"http://www.w3.org/2000/svg","width":"11.28ex","height":"2.262ex","role":"img","focusable":"false","viewBox":"0 -750 4985.9 1000","xmlnsXLink":"http://www.w3.org/1999/xlink"},"children":[{"type":"element","tag":"defs","props":{},"children":[{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-I-1D463","d":"M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-3D","d":"M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-28","d":"M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-31","d":"M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-2C","d":"M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-32","d":"M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-33","d":"M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"},"children":[]},{"type":"element","tag":"path","props":{"id":"MJX-1-TEX-N-29","d":"M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"},"children":[]}]},{"type":"element","tag":"g","props":{"stroke":"currentColor","fill":"currentColor","strokeWidth":"0","transform":"scale(1,-1)"},"children":[{"type":"element","tag":"g","props":{"dataMmlNode":"math"},"children":[{"type":"element","tag":"g","props":{"dataMmlNode":"mi"},"children":[{"type":"element","tag":"use","props":{"dataC":"1D463","xLinkHref":"#MJX-1-TEX-I-1D463"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mo","transform":"translate(762.8,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"3D","xLinkHref":"#MJX-1-TEX-N-3D"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mo","transform":"translate(1818.6,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"28","xLinkHref":"#MJX-1-TEX-N-28"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mn","transform":"translate(2207.6,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"31","xLinkHref":"#MJX-1-TEX-N-31"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mo","transform":"translate(2707.6,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"2C","xLinkHref":"#MJX-1-TEX-N-2C"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mn","transform":"translate(3152.2,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"32","xLinkHref":"#MJX-1-TEX-N-32"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mo","transform":"translate(3652.2,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"2C","xLinkHref":"#MJX-1-TEX-N-2C"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mn","transform":"translate(4096.9,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"33","xLinkHref":"#MJX-1-TEX-N-33"},"children":[]}]},{"type":"element","tag":"g","props":{"dataMmlNode":"mo","transform":"translate(4596.9,0)"},"children":[{"type":"element","tag":"use","props":{"dataC":"29","xLinkHref":"#MJX-1-TEX-N-29"},"children":[]}]}]}]}]}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"向量的每個數字（例如 1、2、3）就是這個向量在各個軸上的「分量」（components）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"中文中「分量」是 vector component 的翻譯。"}]}]},{"type":"element","tag":"h4","props":{"id":"在向量時鐘中的意義"},"children":[{"type":"text","value":"在向量時鐘中的意義："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"向量時鐘用一組 key-value 組來記錄每個節點的版本："}]},{"type":"element","tag":"pre","props":{"code":"{\n \"Sx\": 2,\n \"Sy\": 1,\n \"Sz\": 0\n}\n","language":"json","meta":"","className":"language-json shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" \"Sx\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" \"Sy\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" \"Sz\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這其實就是一個多維的向量，每個節點（如 Sx, Sy, Sz）對應一個「分量」："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sx 的分量是 2"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sy 的分量是 1"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sz 的分量是 0"}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"用分量的好處"},"children":[{"type":"text","value":"✅ 用「分量」的好處："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"可以用來比較兩個向量時鐘是否發生衝突"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"易於理解為「每個節點對這筆資料的貢獻度（或修改次數）」"}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"總結"},"children":[{"type":"text","value":"📘 總結："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"向量時鐘中的「分量」就是： "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"每個節點在向量中對應的版本值"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"叫它「分量」是因為這種結構本身就是一個向量，這個詞也承襲了數學中向量各個維度的稱呼。這在資料庫、分散式系統、版> 本控制等領域中是常見的術語。"}]},{"type":"element","tag":"hr","props":{},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"詳細步驟說明："}]}]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"初始寫入："}]},{"type":"text","value":" （ "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 第1次 寫入此鍵）\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"客戶端把資料項 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D1"}]},{"type":"text","value":" 寫入系統，且這個寫入是由伺服器 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 來處理。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"因此，就有了向量時鐘為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D1([Sx, 1])"}]},{"type":"text","value":"。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"後續覆寫："}]},{"type":"text","value":" （ "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 第2次 更新此鍵，取代了舊版本）\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"另一客戶端讀取了最新的 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D1"}]},{"type":"text","value":" ，並把它改為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D2"}]},{"type":"text","value":" ，仍然是由同一部伺服器 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 進行寫入處理把資料寫回伺服器。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"因此，"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D2"}]},{"type":"text","value":" 繼承自 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D1"}]},{"type":"text","value":"，視為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"同一演進鏈"}]},{"type":"text","value":"，故 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 將其版本遞增為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D2([Sx, 2])"}]},{"type":"text","value":"。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"並行更新1："}]},{"type":"text","value":" （繼承了之前 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx:2"}]},{"type":"text","value":" 的版本，"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"並加入 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy:1"}]}]},{"type":"text","value":" ）\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"第三個客戶端讀取最新 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D2"}]},{"type":"text","value":"，更新為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":"，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"透過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"不同節點 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy"}]}]},{"type":"text","value":" 寫入。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sy"}]},{"type":"text","value":" 不曾寫過該鍵，於是 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":" 的時鐘為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"([Sx,2], [Sy,1])"}]},{"type":"text","value":"。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"並行更新2："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"第四個客戶端也"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀取 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D2"}]},{"type":"text","value":"（與步驟3並行）"}]},{"type":"text","value":"，更新為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":"，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"透過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"另一節點 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sz"}]}]},{"type":"text","value":" 寫入。得到 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 的時鐘 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"([Sx,2], [Sz,1])"}]},{"type":"text","value":"。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突產生："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"現在系統內存在 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 兩條"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"平行分支"}]},{"type":"text","value":"（皆從 D2 演化而來）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":" 的時鐘 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Sx:2, Sy:1]"}]},{"type":"text","value":" 與"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 的時鐘 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"[Sx:2, Sz:1]"}]},{"type":"text","value":" 互相無法比較誰包含誰（各自有對方沒有的分量），判斷為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突版本"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"此時若有讀取請求，\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"系統會"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"同時返回 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 兩個版本"}]},{"type":"text","value":"給客戶端。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"要求客戶端執行"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"應用層合併"}]},{"type":"text","value":"（例如將兩個購物車列表合併）後提交一個最"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"終版本 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D5([Sx,3], [Sy,1], [Sz,1])"}]}]},{"type":"text","value":"。"}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突合併："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"客戶端解析衝突得到最終結果，再寫入系統（假設透過 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" ）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx"}]},{"type":"text","value":" 將合併版本 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D5"}]},{"type":"text","value":" 的時鐘更新為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"([Sx,3], [Sy,1], [Sz,1])"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"因為 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D5"}]},{"type":"text","value":" 包含了之前 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 的所有分量（ "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Sx:3 ≥2, Sy:1 ≥1, Sz:1 ≥1"}]},{"type":"text","value":" ），"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"因此 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D5"}]},{"type":"text","value":" 被視為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"後繼版本"}]},{"type":"text","value":"，舊的 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D3"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"D4"}]},{"type":"text","value":" 可被標記為過時並最終刪除。"}]}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"節點故障與容錯機制gossip-協議sloppy-quorum-與-hinted-handoff"},"children":[{"type":"text","value":"節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在大型分散式系統中，"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"節點故障是常態而非例外"}]},{"type":"text","value":"。\n因此，我們需要"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"機制"}]},{"type":"text","value":"來"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"偵測故障"}]},{"type":"text","value":"以及在"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"故障發生時維持系統的可用性"}]},{"type":"text","value":"。\n本節介紹兩類機制："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"故障偵測："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如何讓所有節點感知彼此的存活狀態，迅速發現節點宕機或網路隔離。\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在分散式系統中，如果某個伺服器說另一伺服器已故障，實際上這樣並不足以認為該伺服器確實已故障。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"原則：至少需要有兩個獨立來源提供相同資訊，我們才能把該伺服器標記為故障。"}]}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"故障應對："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"當部分節點無法服務時，如何暫時接管其職責以及在其恢復後進行數據補償。"}]}]}]}]},{"type":"element","tag":"h4","props":{"id":"_1故障偵測-gossip-協議"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"（1）故障偵測 – Gossip 協議："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"傳統做法："}]},{"type":"text","value":" 是一個節點向全體其它節點定期發送心跳 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"（ all-to-all 心跳 ）"}]},{"type":"text","value":"，但在節點很多時網絡開銷巨大。\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-10.png"},"children":[]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"改進方案是 Gossip（八卦）協議，其特點類似社交場合的流言傳播："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每個節點維護一份成員列表 ( "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"去中心化"}]},{"type":"text","value":" )"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"記錄集群中其他節點的 ID 及其心跳計數器等資訊。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"時鐘1：定時（例如每隔 w 秒），表示「我還活著」。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"各節點獨立地每隔固定時間增加自己的心跳計數。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"時鐘2：定時（例如每隔 𝑡 秒），表示「刷存在感」。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每個節點從成員列表中隨機選擇幾個節點，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"將自己的心跳資訊發送給接收者。\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"接收者：更新對應節點的心跳值，"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"接收者：繼續隨機節點轉發，類似病毒傳播地散播心跳消息。"}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"節點收到某成員的信息："}]},{"type":"text","value":" 會更新本地成員列表，確保彼此盡量最終收斂到一致的最新成員狀態。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"判定失效："}]},{"type":"text","value":" 若成員列表中某節點的心跳值在"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"超過一定時間沒有增長"}]},{"type":"text","value":"（ 例如超過 5 個 heartbeat 週期 ），則認定該節點"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"離線"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"好處："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"透過 Gossip 機制，整個集群能在較小網絡開銷下達成對故障節點的共識。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"由於採隨機對等傳播，Gossip 在大規模節點時的消息數量只線性增加且具高度冗餘，不易有單點瓶頸。"}]}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"圖 6-11 示範："}]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"節點 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"s0"}]},{"type":"text","value":" 偵測到節點 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"s2"}]},{"type":"text","value":" 長時間沒心跳，"}]},{"type":"element","tag":"strong","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"s0"}]},{"type":"text","value":" 將此資訊隨 Gossip 傳給其他節點，最終全網標記 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"s2"}]},{"type":"text","value":" 故障。"}]},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-11.png"},"children":[]}]}]},{"type":"element","tag":"h4","props":{"id":"_2臨時故障應對-sloppy-quorum-hinted-handoff"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"（2）臨時故障應對 – Sloppy Quorum & Hinted Handoff："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"發現節點故障後，系統應繼續提供服務而不強制等待故障節點恢復。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這涉及兩個機制："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Sloppy Quorum（草率仲裁）："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"為了提高可用性，暫時放寬 Quorum 的嚴格一致性要求。"}]},{"type":"text","value":" 在原本需要與特定 N 個副本交互的基礎上，改為："}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"繞過故障節點"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在雜湊環上選擇前 W 個運行狀良好的伺服器進行寫入，即算成功。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀取："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"繞過故障節點"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在雜湊環上選擇前 R 個運行狀良好的伺服器進行讀取，即算成功。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"只要"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"存活節點數量尚 >= W 或 R"}]},{"type":"text","value":"，讀寫操作就不會因單節點故障而被阻斷，提高了可用性。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Hinted Handoff（提示換手）："}]},{"type":"text","value":"\n寫入因 Sloppy Quorum 被臨時寫到代管節點，如何在故障節點恢復後補回缺失的更新？"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"答案是"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"提示換手"}]},{"type":"text","value":"："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"代管寫入的節點會將針對故障節點的更新保存下來（附上「給節點 X 的資料變更」提示）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"等偵測到原故障節點重新上線後，代管者再將這些更新“轉交”回原設置應儲存該資料的節點，完成補寫。"}]}]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"圖 6-12 所示，"}]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"s2 故障期間 s3 代管了本屬於 s2 的更新，當 s2 恢復時，s3 將相關資料交還給 s2。"}]},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-12.png"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"上述兩者的結合增強可用性"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在短暫節點故障期間，系統仍能對外提供近乎正常的服務。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"當節點恢復後又能將資料漸進糾正，實現最終一致。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"犧牲了一定程度的一致性保證"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Sloppy Quorum 犧牲了一定一致性保證，可能讀不到最新寫入（ 因寫到臨時節點 ），但換來的是更高的故障容忍和持續服務能力。"}]}]}]}]},{"type":"element","tag":"h4","props":{"id":"_3永久故障應對-防止資料長期不一致-merkle-tree"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"（3）永久故障應對 – 防止資料長期不一致： Merkle Tree"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果某節點"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"永久失效（ 例如硬碟損毀無法恢復數據 ）"}]},{"type":"text","value":"，則使用上述"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"提示換手也無法把它「喚醒」"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"此時通常透過 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"反熵（Anti-Entropy）機制在存活節點間進行資料修復同步"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"典型手段是使用 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Merkle Tree（梅克爾樹，又稱雜湊樹） 來高效比較大範圍資料："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"透過對資料集合計算出"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"層次化"}]},{"type":"text","value":"的雜湊，\n以"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"快速定位"}]},{"type":"text","value":"哪個區段資料不一致，\n並能"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最小化資料傳輸"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Amazon Dynamo 實作"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"基於 Merkle 樹的反熵協議，確保副本間數據一致性。"}]}]}]},{"type":"element","tag":"pre","props":{"code":"將整個 key 空間分塊，\n(1) 各節點對每塊計算雜湊，構建一棵樹並從根比對，若根相同則所有子樹都相同；\n(2) 若根不同，則只需下探有差異的子樹分支，迅速找出不一致的鍵集合。\n(3) 找到差異後，再進行資料補償同步。\n(4) 透過定期運行 Merkle 樹比較，各副本可在後台修復長期分歧，最終達成一致。\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"將整個 key 空間分塊，\n(1) 各節點對每塊計算雜湊，構建一棵樹並從根比對，若根相同則所有子樹都相同；\n(2) 若根不同，則只需下探有差異的子樹分支，迅速找出不一致的鍵集合。\n(3) 找到差異後，再進行資料補償同步。\n(4) 透過定期運行 Merkle 樹比較，各副本可在後台修復長期分歧，最終達成一致。\n"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"維基百科 Merkle Tree"}]},{"type":"element","tag":"pre","props":{"code":"雜湊樹（hash tree；Merkle tree），\n在密碼學及電腦科學中是一種樹形資料結構，\n每個葉節點均以資料塊的雜湊作為標籤，\n而除了葉節點以外的節點則以其子節點標籤的加密雜湊作為標籤。\n\n雜湊樹能夠高效、安全地驗證大型資料結構的內容，是雜湊鏈的推廣形式。\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"雜湊樹（hash tree；Merkle tree），\n在密碼學及電腦科學中是一種樹形資料結構，\n每個葉節點均以資料塊的雜湊作為標籤，\n而除了葉節點以外的節點則以其子節點標籤的加密雜湊作為標籤。\n\n雜湊樹能夠高效、安全地驗證大型資料結構的內容，是雜湊鏈的推廣形式。\n"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-markle-tree.png"},"children":[]},{"type":"text","value":"\n二元雜湊樹範例。\n雜湊 0-0 和 0-1 分別是資料塊 L1 和 L2 的雜湊值。\n雜湊 0 是將雜湊 0-0 和 0-1 連接後所取得的雜湊值。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"a","props":{"href":"https://www.youtube.com/watch?v=pRwvZzxcH2w","rel":["nofollow"]},"children":[{"type":"text","value":"https://www.youtube.com/watch?v=pRwvZzxcH2w"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h4","props":{"id":"merkle-樹建構流程舉例鍵空間-112"},"children":[{"type":"text","value":"🔍 Merkle 樹建構流程（舉例：鍵空間 1～12）"}]},{"type":"element","tag":"h5","props":{"id":"說明"},"children":[{"type":"text","value":"🎯 說明："}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"假設我們的鍵值範圍是 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"1 到 12"}]},{"type":"text","value":"，以下是如何建構出對應的 Merkle 樹。\n過程中若有異常（如資料不一致），會以"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"特別標記的方塊"}]},{"type":"text","value":"來呈現。"}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h5","props":{"id":"step-1鍵值劃分桶子圖-6-13"},"children":[{"type":"text","value":"🧩 Step 1：鍵值劃分桶子（圖 6-13）"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"將鍵的空間平均劃分為多個「桶子（bucket）」，本例中共 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"4 個桶子"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每個桶子會對應一棵子樹的"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"根節點（root level node）"}]},{"type":"text","value":"，後續用來維護這個桶內的資料結構。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"📌 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"目的："}]},{"type":"text","value":" 降低單一 Merkle 樹過大，提升定位異常的效率。\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-13.png"},"children":[]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h5","props":{"id":"step-2鍵值雜湊圖-6-14"},"children":[{"type":"text","value":"🔐 Step 2：鍵值雜湊（圖 6-14）"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"對每個桶子內的所有鍵值進行"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"統一的 hash 處理"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這些 hash 結果將作為 Merkle Tree 的葉節點（leaf nodes）。\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-14.png"},"children":[]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h5","props":{"id":"step-3建立桶子層級的雜湊節點圖-6-15"},"children":[{"type":"text","value":"🌿 Step 3：建立桶子層級的雜湊節點（圖 6-15）"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每個桶子產生一個對應的 hash node，代表該桶整體資料狀態。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這些節點會作為上層 Merkle Tree 的中繼節點（intermediate nodes）。\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-15.png"},"children":[]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"step-4建構最終的-merkle-樹圖-6-16"},"children":[{"type":"text","value":"🌳 Step 4：建構最終的 Merkle 樹（圖 6-16）"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"從每個桶子的 hash node 開始，"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"兩兩組合並進行 hash"}]},{"type":"text","value":"，逐層向上建構。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"最終會得到一個全域的 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Merkle Root"}]},{"type":"text","value":"，可用來表示整體系統資料的一致性狀態。\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-16.png"},"children":[]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"merkle-tree-優點整理"},"children":[{"type":"text","value":"✅ Merkle Tree 優點整理"}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"特性"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"說明"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"區域性更新"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"只需更新變更桶子對應的子樹及相關 hash，其他部分保持不變"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"快速偵測異常"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"比對 root hash，若不一致即可快速縮小範圍至異常桶子"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"易於擴充"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"桶子數可依據資料規模動態調整，適合大規模分散式系統"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"應用場景"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"區塊鏈、分散式檔案系統（如 IPFS）、資料一致性檢查與同步機制等"}]}]}]}]},{"type":"element","tag":"hr","props":{},"children":[]}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":" \n"},{"type":"element","tag":"pre","props":{"code":"只要使用 Merkle Tree 的做法，\n需要同步的資料量就會與兩個副本之間的差異(而不是所包含資料量)成正比。\n\n在實際的系統中，\n桶子的尺寸有可能相當大。\n舉例來說，我們可能會設定每十億個鍵對應一百萬個桶子，如此一來，每個桶子就包含 1000 個鍵。\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"只要使用 Merkle Tree 的做法，\n需要同步的資料量就會與兩個副本之間的差異(而不是所包含資料量)成正比。\n\n在實際的系統中，\n桶子的尺寸有可能相當大。\n舉例來說，我們可能會設定每十億個鍵對應一百萬個桶子，如此一來，每個桶子就包含 1000 個鍵。\n"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h4","props":{"id":"_4資料中心服務中斷的問題-跨多個資料中心複製資料的做法非常重要"},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"（4）資料中心服務中斷的問題： 跨多個資料中心複製資料的做法非常重要。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"回顧一下"},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"📌 回顧一下"}]}]}]},{"type":"element","tag":"h3","props":{"id":"session-3-階段內容至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰"},"children":[{"type":"text","value":"Session 3 階段內容，至此我們聚焦在分散式鍵值存儲系統中"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性與容錯"}]},{"type":"text","value":"挑戰"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(1) 資料分區：一致性雜湊與水平擴充"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(2) 資料複製：高可用性的基石"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(3) 一致性：Quorum 機制與最終一致性"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(4) 不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"(5) 節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們已構建起一個分散式鍵值存儲的完整藍圖，"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"涵蓋從資料分區、複製到一致性維護、故障處理的各方面。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"主要收穫包括："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性模型選擇："}]},{"type":"text","value":" 綜上，本系統採用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性"}]},{"type":"text","value":"模型，強調高可用性與容錯。但我們也提供參數使其一致性"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可調"}]},{"type":"text","value":"（Consistency Tunable），例如客戶端可根據需求選擇不同 R、W 配置來實現從弱一致到強一致的切換。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"調節一致性的策略："}]},{"type":"text","value":" Quorum 機制允許我們通過調整 W、R "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"在一致性與延遲間找到平衡點"}]},{"type":"text","value":"。對追求最終一致性的系統，可選較小 W、R 以降低延遲；如需強一致，可設定 W+R > N。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突偵測與解決："}]},{"type":"text","value":" 透過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"向量時鐘"}]},{"type":"text","value":"為每個鍵值跟蹤多副本的版本演進史，偵測並行更新造成的衝突。在需要時將多版本交由客戶端合併，確保沒有寫入被無故覆蓋或遺失。儘管增加實現複雜度，但對於高度可用系統而言，這是達成最終一致性的關鍵。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"故障容錯機制："}]},{"type":"text","value":" Gossip 協議提供去中心化且高容錯的故障偵測方案，讓集群快速達成對節點存活狀態的共識。Sloppy Quorum 和 Hinted Handoff 則在節點臨時故障時維持服務不中斷，並在其恢復後自動補齊資料，提升整體可用性。永久性故障下，"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"借助 Merkle 樹等反熵演算法，系統能找出並同步遺失的資料片段。"}]}]}]},{"type":"element","tag":"h2","props":{"id":"最後關注系統的實際架構實作"},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"📌 最後關注系統的實際架構實作"}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"包括資料存儲引擎（寫入/讀取路徑）以及一個使用 C# + MSSQL 的簡易鍵值存儲 API 範例，並探討幾個現代鍵值存儲系統作比較。"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"系統架構圖"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"寫入途徑"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"讀取途徑"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"系統架構圖整體架構與資料存儲引擎"},"children":[{"type":"text","value":"系統架構圖：整體架構與資料存儲引擎"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"綜合前述設計，\n我們的鍵值存儲系統架構可以描述如下："}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"無中心架構（Decentralized）："}]},{"type":"text","value":" 集群中無主從之分，每個節點職責相當（均可作為請求協調者、均存儲部分資料）。這避免單點瓶頸，提升可靠性。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"請求路由："}]},{"type":"text","value":" 客戶端發出的請求（讀或寫），可透過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性雜湊"}]},{"type":"text","value":"機制路由到對應的節點處理。實務中通常由客戶端或中介負責計算鍵的雜湊並選擇節點，或者設置每個節點都能轉發請求到正確節點。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"協調者："}]},{"type":"text","value":" 處理請求的節點扮演"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"協調者"}]},{"type":"text","value":"角色（Coordinator），充當客戶端與存儲節點之間的代理。協調者負責與副本節點通信以完成讀寫 Quorum。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料存儲層："}]},{"type":"text","value":" 每個節點本地維護存儲引擎，包括"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"記憶體快取"}]},{"type":"text","value":"（memtable）與"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"磁碟資料檔"}]},{"type":"text","value":"（如 SSTable）等，用以快速存取和持久化資料。為性能，經常採用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"基於日誌的結構存儲（LSM Tree）"}]},{"type":"text","value":" 模型。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"組件回顧："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分區"}]},{"type":"text","value":"：一致性雜湊確定資料歸屬節點，支撐水平擴展。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"複製"}]},{"type":"text","value":"：多副本存放與跨機房配置保證高可用。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性"}]},{"type":"text","value":"：Quorum 共識 + 調整 R/W 保證讀寫一致性。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突解決"}]},{"type":"text","value":"：向量時鐘 & 客戶端合併應對並發更新。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"故障處理"}]},{"type":"text","value":"：Gossip 偵測 + Sloppy Quorum / Hinted Handoff 保證系統容錯與最終一致。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"圖 6-17 為系統架構示意，展示了沒有中央控制節點下，各節點如何透過雜湊環、複製和協調機制協同工作：\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-17.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"圖 6-18 為分散式鍵值存儲系統的每個節點，去中心化的示意圖。\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-18.png"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"接下來重點說明\n"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料寫入與讀取路徑"}]},{"type":"text","value":"在節點內的處理流程，這對"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"性能和可靠性"}]},{"type":"text","value":"至關重要。"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"寫入途徑資料寫入路徑write-path"},"children":[{"type":"text","value":"寫入途徑：資料寫入路徑（Write Path）"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"對於來自客戶端發出的每一次寫入請求，\n經路由到正確節點後，\n主要執行以下步驟（借鑑 Apache Cassandra 的實作）：\n"},{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-19.png"},"children":[]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"提交日誌 (Commit Log)："}]},{"type":"text","value":" 協調節點首先將寫操作記錄追加到"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"提交日誌文件"}]},{"type":"text","value":"中。這是一個"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"有序寫入的預寫日誌"}]},{"type":"text","value":"，確保即使隨後節點崩潰，重啟時也能從日誌重放恢復未刷入的資料。"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"有序寫磁碟相對快速，確保每次寫入先落盤，提高資料耐久性。"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入記憶體表 (MemTable)："}]},{"type":"text","value":" 同時，將此鍵值對寫入節點的"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"記憶體快取 (memtable)"}]},{"type":"text","value":"。MemTable可理解為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"存於記憶體的排序Map結構，累積近期寫入（尚未刷盤）"}]},{"type":"text","value":"。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"確認 & 複製："}]},{"type":"text","value":" 協調者等待本地（及可能其他副本）的MemTable寫入操作成功返回（達到 W 個ACK）後，即可向客戶端回覆寫入成功。這時數據已經在記憶體中，以及至少 W 個副本的提交日誌中持久化。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"MemTable 刷盤 (Flush to SSTable)："}]},{"type":"text","value":" 隨著寫入不斷進行，MemTable 佔用內存越來越大。當其大小達到預設閾值或時間週期，就觸發"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"刷盤"}]},{"type":"text","value":"：把 MemTable 內容排序後寫出到磁碟上的 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"SSTable（Sorted String Table）"}]},{"type":"text","value":" 檔案。SSTable 是有序的不變（immutable）鍵值集合檔，每次刷盤生成一個新的檔案。"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"刷盤過程同時清空該 MemTable，並打上一個新的 MemTable 寫入後續資料。"}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"檔案合併 (Compaction)："}]},{"type":"text","value":"（可選）為避免 SSTable 檔過多或存在過時版本碎片，後台定期對多個 SSTable 檔案進行"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"壓實（Compaction）"}]},{"type":"text","value":"，合併同一鍵的多版本記錄，棄掉被覆蓋或刪除的舊版本，減少查詢開銷。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"以上流程確保了寫入既"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"快速"}]},{"type":"text","value":"（記憶體操作+有序日誌）又"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"安全"}]},{"type":"text","value":"（日誌在先，防故障丟失）。Cassandra 寫路徑的設計容許高吞吐的隨機寫操作，並通過後續順序刷盤優化磁碟訪問。"}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"實現提示："}]},{"type":"text","value":" 寫路徑強調"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"先寫日誌再寫內存"}]},{"type":"text","value":"，這與傳統關係資料庫 WAL + Buffer Pool 機制類似，稱為「"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"先寫日誌"}]},{"type":"text","value":"」策略。這樣在crash時，可重播日誌保障資料不丟。Cassandra也採此法確保即使節點故障重啟，提交日誌能恢復自上次flush後失去的資料。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"讀取途徑資料讀取路徑read-path"},"children":[{"type":"text","value":"讀取途徑：資料讀取路徑（Read Path）"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"讀取請求的流程相對直觀，\n但需處理資料可能分散在記憶體和多個磁碟檔的情況。節點接到讀取某鍵的請求後："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-20.png"},"children":[]}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"查詢 MemTable："}]},{"type":"text","value":" 優先在"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"記憶體快取"}]},{"type":"text","value":"中查找該鍵。如果命中（資料尚未刷盤，存在於最新 MemTable），直接返回值，讀取結束。這是最快的情況（O(1)雜湊查找，無磁碟IO）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"查詢 Cache 未命中："}]},{"type":"text","value":" 若鍵不在記憶體中（MemTable miss），說明資料要麼在舊的 SSTable 檔，要麼此鍵根本不存在。此時進入磁碟查找流程。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-6-21.png"},"children":[]}]},{"type":"element","tag":"ol","props":{"start":3},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Bloom Filter 篩選："}]},{"type":"text","value":" 為了避免遍歷所有 SSTable 檔案查找，可以使用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Bloom Filter"}]},{"type":"text","value":"為每個 SSTable 加一層索引。Bloom Filter 是一種空間高效的機率型資料結構，可快速測試「某鍵是否"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"不在"}]},{"type":"text","value":"某檔案」。每個 SSTable 存有對應的 Bloom Filter，當查找鍵K時，先讓 Bloom Filter 判斷該 SSTable 是否"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可能"}]},{"type":"text","value":"包含 K。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果 Bloom Filter 判定「不可能在此 SSTable」，則可直接跳過該檔案。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"若判定「可能存在」，才去該 SSTable 中透過檔內索引（二分搜尋等）實際查找。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"透過Bloom Filter，可以大幅減少不必要的磁碟IO。例如某鍵可能僅存在最新幾個檔案，Bloom Filter 將排除大部分與該鍵無關的檔案。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"SSTable 查找："}]},{"type":"text","value":" 對於Bloom Filter結果為可能包含的那些 SSTable，打開檔案（典型為有序IO），利用其內部稽核（如稀疏索引或B樹索引）定位鍵的位置，讀出對應的值。由於SSTable內記錄有序，可以較快速地找到鍵。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"數據返回與合併："}]},{"type":"text","value":" 如果從多個副本節點讀取（R>1情況），協調者會收到多份值，需比較其版本（例如 vector clock 或時間戳）選擇最新的結果返回給客戶端。如果偵測到版本衝突（如之前所述出現多版本），則返回所有版本讓客戶端處理。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀取快取："}]},{"type":"text","value":" 讀取完成後，可將該鍵結果存入"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"頁面快取"}]},{"type":"text","value":"或"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"鍵值快取"}]},{"type":"text","value":"，下次相同鍵訪問時直接命中，提高熱點讀性能。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"總結來說，\n讀路徑的優化重點在於"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"記憶體命中優先"}]},{"type":"text","value":"，\n其次透過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Bloom Filter"}]},{"type":"text","value":"減少磁碟掃描範圍。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"經過這些步驟，\n大部分讀請求可在 O(1) 時間返回（記憶體命中）或以少量有序 IO 完成。\nBloom Filter 雖有極小機率誤判（回傳“可能存在”實際沒有），但不影響正確性，只是多一次空查找，而且誤判率可透過調整位元數控制。"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"session-3-各個組件環環相扣關係的架構圖"},"children":[{"type":"text","value":"Session 3 各個組件環環相扣關係的架構圖："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/img-note.png"},"children":[]}]},{"type":"element","tag":"h3","props":{"id":"_1-起點分散式需求"},"children":[{"type":"text","value":"1. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"起點：分散式需求"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"從單機無法滿足的需求出發（大容量、高可用、可擴展）"}]}]},{"type":"element","tag":"h3","props":{"id":"_2-基礎設計資料分區與複製"},"children":[{"type":"text","value":"2. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"基礎設計：資料分區與複製"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料分區"}]},{"type":"text","value":"：使用一致性雜湊將資料均勻分散到多個節點"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料複製"}]},{"type":"text","value":"：每份資料保存 N 個副本，確保可用性"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"兩者相輔相成：分區決定資料位置，複製保證容錯"}]}]},{"type":"element","tag":"h3","props":{"id":"_3-衍生挑戰一致性問題"},"children":[{"type":"text","value":"3. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衍生挑戰：一致性問題"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"多副本帶來一致性挑戰"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"CAP 定理迫使我們在 AP 和 CP 之間選擇"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"選擇 AP 系統（最終一致性）以保證高可用"}]}]},{"type":"element","tag":"h3","props":{"id":"_4-解決方案一致性與衝突處理"},"children":[{"type":"text","value":"4. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"解決方案：一致性與衝突處理"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Quorum 機制"}]},{"type":"text","value":"：通過 N/W/R 參數調節一致性級別"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"向量時鐘"}]},{"type":"text","value":"：檢測並解決並發更新造成的版本衝突"}]}]},{"type":"element","tag":"h3","props":{"id":"_5-進階挑戰節點故障"},"children":[{"type":"text","value":"5. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"進階挑戰：節點故障"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"故障偵測"}]},{"type":"text","value":"：Gossip 協議去中心化地發現故障節點"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"臨時故障"}]},{"type":"text","value":"：Sloppy Quorum + Hinted Handoff 維持服務"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"永久故障"}]},{"type":"text","value":"：Merkle Tree 進行資料修復"}]}]},{"type":"element","tag":"h3","props":{"id":"_6-最終實現完整系統架構"},"children":[{"type":"text","value":"6. "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終實現：完整系統架構"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"系統架構"}]},{"type":"text","value":"：去中心化設計，協調者模式"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"寫入路徑"}]},{"type":"text","value":"：Commit Log → MemTable → SSTable"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"讀取路徑"}]},{"type":"text","value":"：MemTable 優先，Bloom Filter 優化"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"節點內部"}]},{"type":"text","value":"：LSM Tree 結構，後台 Compaction"}]}]},{"type":"element","tag":"h2","props":{"id":"環環相扣的特點"},"children":[{"type":"text","value":"環環相扣的特點："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"因果關係明確"}]},{"type":"text","value":"：每一層的設計都是為了解決上一層帶來的問題"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"相互依賴"}]},{"type":"text","value":"：各組件不是獨立存在，而是共同構成完整系統"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"持續優化"}]},{"type":"text","value":"：系統運行中的經驗會反饋到各層設計的改進"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個架構展示了分散式鍵值儲存系統設計的完整思路，從需求出發，逐步解決各種挑戰，最終形成一個高可用、可擴展的系統。"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h1","props":{"id":"第六章-總結"},"children":[{"type":"text","value":"第六章 總結"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"經過三個階段的講解，我們完整覆蓋了"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分散式鍵值存儲系統"}]},{"type":"text","value":"從原理到實作的方方面面："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Session 1："}]},{"type":"text","value":" 理解了鍵值資料庫的基本定義。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Session 2："}]},{"type":"text","value":" 單機實現方式，以及擴展到分散式系統時需要面臨的 CAP 抉擇。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Session 3："}]},{"type":"text","value":" 從資料分區/複製方法，到深入探討了為實現高可用而採取最終一致性的系統中，如何利用 quorum 共識調節一致性、用向量時鐘來侦測和解決衝突版本、用 Gossip 和 Hinted Handoff 等機制來實現故障容忍與自癒。並闡述了實際系統架構下資料讀寫的具體流程（MemTable+SSTable 和 Bloom Filter 等實作細節）。此外，我們將該系統與當今主流方案進行了對比，理解不同系統在 CAP 取捨和架構設計上的演進。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"整章核心要點回顧："}]},{"type":"text","value":" (對照下表)"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"為處理"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"海量資料"}]},{"type":"text","value":"：採用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分區/一致性雜湊"}]},{"type":"text","value":"分散鍵到多節點。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"提供"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"高可用讀取"}]},{"type":"text","value":"：透過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"多副本複製"}]},{"type":"text","value":"，甚至跨機房部署。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"支撐"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"高可用寫入"}]},{"type":"text","value":"：允許"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致"}]},{"type":"text","value":"，使用向量時鐘進行版本控制與衝突解決。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可線性擴展"}]},{"type":"text","value":"：增加節點透過一致性雜湊自動攤平負載，虛擬節點支持異構性。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"容忍"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"臨時故障"}]},{"type":"text","value":"：採用 Sloppy Quorum + Hinted Handoff 技術保證服務不中斷。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"應對"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"永久故障"}]},{"type":"text","value":"：利用 Merkle Tree 進行反熵同步。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"跨域高可用"}]},{"type":"text","value":"：多資料中心複製與故障轉移策略，保障局部機房宕機時系統整體仍存活。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"alt text","src":"/images/sdi-aig/06/table-6-2.png"},"children":[]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"c-最小鍵值存儲-api-實作範例"},"children":[{"type":"text","value":"C# 最小鍵值存儲 API 實作範例"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"下面我們將實作一個簡化的鍵值存儲服務，使用 C# (.NET 8 Minimal API) 提供 HTTP 接口，並以 MSSQL 資料庫作為持久層。此範例展示鍵值存儲的核心功能，包括資料的寫入、讀取和版本管理對應我們前述章節的概念。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"資料表設計："}]},{"type":"text","value":" 在 MSSQL 中建立一張 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"KeyValueStore"}]},{"type":"text","value":" 表："}]},{"type":"element","tag":"pre","props":{"code":"CREATE TABLE KeyValueStore (\n    [Key]   NVARCHAR(256) NOT NULL PRIMARY KEY,\n    [Value] NVARCHAR(MAX) NULL,\n    [Version] INT NOT NULL DEFAULT 0\n);\n","language":"sql","meta":"","className":"language-sql shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"CREATE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" TABLE"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" KeyValueStore"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    [Key]   "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"NVARCHAR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"256"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"NOT NULL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" PRIMARY KEY"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    [Value] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"NVARCHAR"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(MAX) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"NULL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    [Version] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"INT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" NOT NULL"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" DEFAULT"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Key"}]},{"type":"text","value":" 欄位作為主鍵存放鍵名稱。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Value"}]},{"type":"text","value":" 欄位存放字串類型的值（實務中可用 VARBINARY(MAX) 存放二進位資料)。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Version"}]},{"type":"text","value":" 欄位記錄此鍵的版本號，用於簡單實現"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本控制"}]},{"type":"text","value":"（每次更新遞增版本）。這對應前述向量時鐘的概念縮減版：我們僅用單一整數表示版本，雖無法處理多副本並發，但可用於樂觀鎖防止寫入覆蓋較新更新。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"接著，我們使用 .NET 8 Minimal API 建立 HTTP 介面，包含 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"PUT"}]},{"type":"text","value":"（寫入/更新鍵）與 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"GET"}]},{"type":"text","value":"（讀取鍵）兩種操作："}]},{"type":"element","tag":"pre","props":{"code":"using Microsoft.Data.SqlClient;\nusing Dapper;\n\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\n\n// Database connection string (modify as appropriate for your environment)\nstring connString = builder.Configuration.GetConnectionString(\"KeyValueDb\");\n\n// 1. GET endpoint: retrieve value by key\napp.MapGet(\"/kv/{key}\", async (string key) =>\n{\n    const string sql = \"SELECT [Value], [Version] FROM KeyValueStore WHERE [Key] = @Key\";\n    await using var conn = new SqlConnection(connString);\n    var result = await conn.QueryFirstOrDefaultAsync<(string Value, int Version)>(sql, new { Key = key });\n    if (result.Value == null)\n    {\n        return Results.NotFound($\"Key '{key}' not found\");\n    }\n    // Return the value and version (as ETag header for concurrency control, e.g.)\n    return Results.Ok(new { Key = key, Value = result.Value, Version = result.Version });\n});\n\n// 2. PUT endpoint: insert or update a key-value\napp.MapPut(\"/kv/{key}\", async (string key, string value) =>\n{\n    await using var conn = new SqlConnection(connString);\n    // Try update first\n    const string updateSql = @\"\n        UPDATE KeyValueStore\n        SET [Value] = @Value, [Version] = [Version] + 1\n        WHERE [Key] = @Key;\n        SELECT @@ROWCOUNT;\";\n    var rows = await conn.ExecuteScalarAsync<int>(updateSql, new { Key = key, Value = value });\n    if (rows == 0)\n    {\n        // If key not exists, insert new record\n        const string insertSql = \"INSERT INTO KeyValueStore([Key],[Value],[Version]) VALUES(@Key, @Value, 0);\";\n        try\n        {\n            await conn.ExecuteAsync(insertSql, new { Key = key, Value = value });\n        }\n        catch (SqlException ex) when (ex.Number == 2627) // PK violation\n        {\n            // Handle race condition: key was inserted by another request in the meantime\n            return Results.Conflict($\"Key '{key}' was inserted by another client.\");\n        }\n    }\n    return Results.NoContent();\n});\n\napp.Run();\n","language":"csharp","meta":"","className":"language-csharp shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"using"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" Microsoft"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"Data"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"SqlClient"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"using"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" Dapper"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" builder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" WebApplication."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"CreateBuilder"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(args);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" app"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" builder."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Build"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// Database connection string (modify as appropriate for your environment)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" connString"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" builder.Configuration."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"GetConnectionString"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"KeyValueDb\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 1. GET endpoint: retrieve value by key\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"MapGet"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"/kv/{key}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" sql"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"SELECT [Value], [Version] FROM KeyValueStore WHERE [Key] = @Key\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" using"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" conn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" SqlConnection"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(connString);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" result"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" conn."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"QueryFirstOrDefaultAsync"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Version"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")>(sql, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { Key "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (result.Value "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" null"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Results."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"NotFound"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"$\"Key '{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}' not found\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // Return the value and version (as ETag header for concurrency control, e.g.)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Results."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Ok"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { Key "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key, Value "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" result.Value, Version "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" result.Version });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"});\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 2. PUT endpoint: insert or update a key-value\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"MapPut"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"/kv/{key}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"async"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=>\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" using"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" conn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" SqlConnection"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(connString);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // Try update first\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" updateSql"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" @\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        UPDATE KeyValueStore\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        SET [Value] = @Value, [Version] = [Version] + 1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        WHERE [Key] = @Key;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"        SELECT @@ROWCOUNT;\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"    var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" rows"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" conn."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"ExecuteScalarAsync"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">(updateSql, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { Key "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key, Value "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" value });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (rows "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // If key not exists, insert new record\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        const"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" insertSql"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" \"INSERT INTO KeyValueStore([Key],[Value],[Version]) VALUES(@Key, @Value, 0);\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        try\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            await"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" conn."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"ExecuteAsync"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(insertSql, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" { Key "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key, Value "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" value });\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        catch"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"SqlException"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ex"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"when"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (ex.Number "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"=="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 2627"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// PK violation\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            // Handle race condition: key was inserted by another request in the meantime\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Results."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Conflict"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"$\"Key '{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}' was inserted by another client.\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" Results."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"NoContent"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"});\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"app."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Run"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"上述程式碼說明："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"我們使用 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Dapper"}]},{"type":"text","value":" 輕量ORM來執行 SQL 查詢，方便地將結果映射為 C# 型別。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"查詢 (GET)"}]},{"type":"text","value":"：透過主鍵查詢資料庫，若找到則返回 JSON，包括鍵和值以及版本號。版本號可以透過 HTTP ETag 頭返回，供客戶端做併發控制（比如更新時帶回去作條件比對）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"更新/插入 (PUT)"}]},{"type":"text","value":"：先嘗試執行 SQL "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"UPDATE"}]},{"type":"text","value":" 語句（利用 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"@@ROWCOUNT"}]},{"type":"text","value":" 判斷是否有行受影響）更新現有記錄的值，並將版本 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Version = Version + 1"}]},{"type":"text","value":"。若 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"UPDATE"}]},{"type":"text","value":" 返回影響行數為0，表示該鍵不存在，進而嘗試執行 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"INSERT"}]},{"type":"text","value":" 新記錄。考慮到可能出現"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"併發"}]},{"type":"text","value":"（兩請求幾乎同時插入同一鍵導致一方PK衝突），捕獲 PK 違規錯誤號2627並返回衝突結果，提醒客戶端該鍵已被其他請求寫入。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"整個 PUT 操作未使用顯式交易（Transaction），但由於我們先嘗試 UPDATE 再 INSERT，兩步間依然有極小窗口可能導致重複插入。因此以 try-catch 捕捉 PK 衝突視為"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性下的衝突解決"}]},{"type":"text","value":"之一種：這裡簡單地告知客戶端衝突，由客戶端決定後續（類似 Dynamo 讀合併寫回模式）。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"對應章節概念："}]},{"type":"text","value":" 這段程式碼體現了數個我們在前面討論的概念："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"Hash Table 存儲"}]},{"type":"text","value":"：我們以資料庫表的 PK 索引模擬鍵值對的 O(1) 查找，類似單機 HashTable。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"持久化與 WAL"}]},{"type":"text","value":"：SQL 資料庫本身在執行 UPDATE/INSERT 時已使用WAL日志確保原子性，我們不需另寫文件日誌。但原理類似我們在寫路徑中強調的先寫提交日誌。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"版本號/衝突控制"}]},{"type":"text","value":"：我們透過 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"Version"}]},{"type":"text","value":" 欄位實現"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"版本控制"}]},{"type":"text","value":"，每次更新+1。這與向量時鐘理念類似但簡化為單一節點序號，用於檢測並發更新：若多客戶端同時讀取同一版本並各自修改，我們可以藉由版本是否匹配來檢測衝突（在此例中，可在 PUT 加入 "},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"WHERE Version = X"}]},{"type":"text","value":" 條件保護，若版本不符則UPDATE無效，提示客戶端重試）。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"最終一致性與衝突"}]},{"type":"text","value":"：我們示範了簡單的"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"衝突處理"}]},{"type":"text","value":"邏輯（PK衝突時返回 409），這映射到 Session 2 談的併發寫入衝突需要協調解決的場景。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"高可用與容錯"}]},{"type":"text","value":"：本範例為簡化單節點服務，未實現 Gossip 等機制。但若擴展為多節點，我們可令每個節點部署此API服務並指向各自後端（如各自的資料庫分片），客戶端透過一致性哈希選節點請求，即可形成一個去中心的分散集群。再搭配資料庫層的同步機制或上層協調，可實現我們設計的 AP 模型。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"em","props":{},"children":[{"type":"text","value":"讀寫流程"}]},{"type":"text","value":"：GET 端點優先查主鍵索引、PUT 端點先寫資料庫（相當於我們設計中寫MemTable和CommitLog），兩者都體現"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"先快取/內存再磁碟"}]},{"type":"text","value":"的思路。雖然我們這裡讓SQL處理細節，但對應Cassandra架構中就是遵循「內存->磁碟、先log再flush」的流程。"}]}]},{"type":"element","tag":"blockquote","props":{},"children":[{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"附註："}]},{"type":"text","value":" 實務中，可用 Entity Framework Core 或其他 ORM 簡化資料訪問，這裡用 Dapper 為直觀展現 SQL 操作。另外，為專注重點，程式碼省略了一些如日誌、更多錯誤處理，以及向量時鐘多節點部分（因單資料庫難以模擬多副本場景）。但其結構已足以作為Minimal Key-Value Store服務的雛形。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h3","props":{"id":"現代鍵值存儲框架演進與比較-20232025"},"children":[{"type":"text","value":"現代鍵值存儲框架演進與比較 (2023–2025)"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如今市面上有眾多鍵值存儲解決方案，各具不同的架構與特性。我們選取其中具代表性的 DynamoDB、TiKV、FoundationDB、etcd、Redis Cluster，結合近年演進，做一番概覽與比較："}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"平台"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"架構/定位"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"CAP 類型"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"一致性協議"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"特點與近年發展"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Amazon DynamoDB"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"AWS 雲托管鍵值資料庫，無縫擴展"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AP"}]},{"type":"text","value":" (預設)"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"提供可選強一致讀"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"單主 Multi-Paxos"}]},{"type":"text","value":" 每分片一主"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"高度可擴展（支援萬億級別請求），預設最終一致但可選"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"強一致讀"}]},{"type":"text","value":"模式。近年新增"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"全局資料表"}]},{"type":"text","value":"實現多區域複製、"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"交易"}]},{"type":"text","value":"支持 (Transaction) 等功能，使之同時滿足嚴格一致場景需求。架構源於 Dynamo 論文但實際實現有別：採用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"單主同步"}]},{"type":"text","value":"複製（每分區一主節點）確保寫一致性，並以"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"多主Region"}]},{"type":"text","value":"實現全球可用。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Apache Cassandra"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"分散式列族資料庫，也提供鍵值接口"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"AP"}]},{"type":"text","value":" (可調一致性)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"無主對等 + Gossip"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"使用 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Hinted Handoff"}]},{"type":"text","value":" 等"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Cassandra 基於 Dynamo 理念實作，無中心，多副本最終一致。特點是採用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"可調一致性"}]},{"type":"text","value":"（客戶端可指定 R/W），提供 TimeUUID 等順序支援。近年版本（4.0以後）加強了 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Audit Logging"}]},{"type":"text","value":" 和 "},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Backpressure"}]},{"type":"text","value":" 等特性。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Redis (Cluster 模式)"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"記憶體鍵值庫，支援集群分片"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"偏AP"}]},{"type":"text","value":"（高可用優先）"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"主從非同步"}]},{"type":"text","value":" (Sentinel自動故障轉移)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"Redis Cluster將資料通過"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"哈希槽分片"}]},{"type":"text","value":"到多節點，每片一主多從。提供快速讀寫（記憶體操作），但"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"一致性較弱"}]},{"type":"text","value":"：主節點異步複製到從節點，故障時可能丟失最近更新。採用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Gossip"}]},{"type":"text","value":"協議維護節點拓撲，Sentinel/Cluster Bus選舉新主。2023年後，Redis 7 引入"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"多線程IO"}]},{"type":"text","value":"與"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"ACL"}]},{"type":"text","value":"改進，但核心集群架構保持簡潔，以性能和簡易性見長。適用快取場景或對一致性要求不高的即時應用。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"TiKV"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"分散式事務鍵值庫（TiDB 的KV層）"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CP"}]},{"type":"text","value":"   (強一致)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Raft 共識"}]},{"type":"text","value":" (每Region三副本)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"TiKV 專注於強一致儲存，採用 Google Percolator 模型提供"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"分散式ACID交易"}]},{"type":"text","value":"。透過 Raft 確保複製一致性，每筆資料三副本。近年 PingCAP 將 TiKV 發展為獨立項目，版本7引入"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Partitioned RaftKV"}]},{"type":"text","value":"引擎，降低寫放大提升效能。TiKV 在 Cloud Native 社區活躍，KubeCon 2023 發表其支援 PB 級數據與 QoS 改進。它適合作為新一代關係資料庫的存儲引擎或需要強一致性的元資料存儲。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"FoundationDB"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"分散式多模 KV 庫（底層Key-Value，頂層可映射文檔、SQL等）"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CP"}]},{"type":"text","value":" (強一致)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"主從 + 任務分離"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"(分層架構+協調服務)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"FoundationDB 提供"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"嚴格 ACID 交易"}]},{"type":"text","value":"的鍵值存儲，將事務處理與存儲層解耦。採用類似集中協調節點 (Resolvers) + 多存儲節點 (Storage Servers) 的設計，以"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"樂觀並發控制"}]},{"type":"text","value":"執行交易，再用"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"多版本"}]},{"type":"text","value":"確保只讀不鎖定。它的複製也使用類似 Raft 的容錯機制（協調器選舉）。Apple 開源後社群活躍，Snowflake 等公司在內部大量使用。近年版本7引入新存儲引擎 Redwood（B+樹結構）提升大值處理效率。FoundationDB 特點在於可透過「Layer」構建高層資料模型，如文檔、SQL，具"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"通用基礎存儲"}]},{"type":"text","value":"潛力，同時保持高性能和分散式一致性。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"etcd"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"分散式一致性KV，主要做配置/註冊"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"CP"}]},{"type":"text","value":" (強一致)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Raft 共識"}]},{"type":"text","value":" (3或5節點組)"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"etcd 是 Kubernetes 等系統的"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"配置中心"}]},{"type":"text","value":"，專注小型資料的強一致儲存。透過 Raft 保證線性一致讀寫，常以奇數節點組成（3或5）集群，任何變更需多數同意。等價於"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"決不容忍腦裂"}]},{"type":"text","value":"、寧可停止服務保證一致性的策略。故在 CAP 上屬 CP 類型，其寫入需要等待同步，大部分操作延遲高於AP系統，但能保證嚴格一致。近年 etcd 強化了快照與壓縮機制減少長期運行時儲存膨脹，並在 Kubernetes 中驗證了其可靠性。不過由於追求一致性，在大量資料存儲上擴展性有限（通常建議數 GB 以內資料量）。"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"指出："},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"Redis/MySQL 僅本地存單副本，而 TiKV/etcd 在三個節點上存三副本（通過 Raft 協議）"}]},{"type":"text","value":"。這直接反映了它們在 CAP 上的取捨差異——Redis/傳統資料庫多為 CA/單機擴展模式，追求可用性但透過主從複製仍可能有不一致；而 TiKV、etcd 堅持 CP 模式，每次寫都經過多節點一致同意。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"總體而言，近年鍵值存儲領域趨勢可以概括為："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"強一致性的崛起："}]},{"type":"text","value":" 在雲原生環境下，像 FoundationDB、TiKV、etcd 等強一致KV廣受關注，因為它們簡化了上層應用的邏輯（不用擔心讀到舊數據）。這些系統大都基於共識演算法（Raft/Paxos）實現，隨著網路和算法優化，其性能也逐步提高，可支持越來越大的集群和資料量。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性的堅守："}]},{"type":"text","value":" 傳統 Dynamo 風格的 AP 系統依然在大規模場景佔有一席，例如 DynamoDB、Cassandra、Riak 等。它們在全球部署、高流量容忍方面具備獨特優勢，並且透過引入"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"輔助功能"}]},{"type":"text","value":"（如 DynamoDB 提供可選強一致讀），在CAP平衡上提供更多彈性。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"內存與持久化融合："}]},{"type":"text","value":" Redis 從純內存Cache演進出 Redis Cluster、再到支援持久化AOF/快照，以及近期的Redis on Flash方案等，說明高速內存KV和持久存儲結合是需求所在。許多系統（如 TiKV 使用 RocksDB LSM 引擎）也著重"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"壓榨硬體"}]},{"type":"text","value":"性能，包含NVMe、optane等新介質的應用。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"多模與易用性："}]},{"type":"text","value":" 新一代KV如 FoundationDB 主打「一個核心，多種模型」，TiKV + TiDB 則展示了將鍵值存儲升級到分散式SQL的可能。這些演進都圍繞讓開發者更容易使用鍵值存儲，同時享受分散式帶來的伸縮與可靠性優勢。"}]}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"h2","props":{"id":"以下額外參考"},"children":[{"type":"text","value":"以下額外參考"}]},{"type":"element","tag":"h3","props":{"id":"資料分區一致性雜湊"},"children":[{"type":"text","value":"資料分區：一致性雜湊"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Virtual Node、負載平均、動態擴縮"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"程式範例"}]},{"type":"text","value":"："},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"ConsistentHashRing"}]},{"type":"text","value":" (C# /.NET 8)"}]}]},{"type":"element","tag":"pre","props":{"code":"public sealed class ConsistentHashRing<T>\n{\n    private readonly SortedDictionary<int, T> _ring = new();\n    private readonly int _replicas;\n    private readonly MD5 _md5 = MD5.Create();\n\n    public ConsistentHashRing(IEnumerable<T> nodes, int replicas = 160)\n    {\n        _replicas = replicas;\n        foreach (var node in nodes) AddNode(node);\n    }\n\n    public void AddNode(T node)\n    {\n        for (int i = 0; i < _replicas; i++)\n        {\n            var hash = Hash($\"{node}-{i}\");\n            _ring[hash] = node;\n        }\n    }\n\n    public void RemoveNode(T node)\n    {\n        for (int i = 0; i < _replicas; i++)\n        {\n            var hash = Hash($\"{node}-{i}\");\n            _ring.Remove(hash);\n        }\n    }\n\n    public T GetNode(string key)\n    {\n        if (!_ring.Any()) throw new InvalidOperationException(\"Ring is empty\");\n        var hash = Hash(key);\n        var kv = _ring.FirstOrDefault(p => p.Key >= hash);\n        return kv.Equals(default(KeyValuePair<int, T>)) ? _ring.First().Value : kv.Value;\n    }\n\n    private int Hash(string input)\n    {\n        var bytes = _md5.ComputeHash(Encoding.UTF8.GetBytes(input));\n        return BitConverter.ToInt32(bytes, 0) & 0x7FFFFFFF; // positive int\n    }\n}\n","language":"csharp","meta":"","className":"language-csharp shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"public"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" sealed"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":" class"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" ConsistentHashRing"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" readonly"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" SortedDictionary"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_ring"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" readonly"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _replicas"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":";\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" readonly"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" MD5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _md5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" MD5."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Create"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"();\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    public"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" ConsistentHashRing"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"IEnumerable"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"> "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"nodes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" replicas"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 160"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        _replicas "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" replicas;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        foreach"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" in"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" nodes) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"AddNode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(node);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    public"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" void"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" AddNode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"; i "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _replicas; i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"++"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"$\"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}-{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            _ring[hash] "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    public"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" void"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" RemoveNode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"; i "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _replicas; i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"++"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"            var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"$\"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"node"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}-{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"i"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"}\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            _ring."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Remove"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(hash);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    public"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" GetNode"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" ("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"!"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"_ring."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Any"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"throw"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" new"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" InvalidOperationException"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Ring is empty\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":");\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(key);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kv"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _ring."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"FirstOrDefault"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"p"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" =>"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" p.Key "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":">="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" hash);\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kv."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Equals"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"KeyValuePair"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"<"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":"T"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":">)) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"?"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _ring."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"First"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"().Value "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" kv.Value;\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    private"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" Hash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"string"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" input"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"        var"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" bytes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" ="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" _md5."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"ComputeHash"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(Encoding.UTF8."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"GetBytes"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(input));\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" BitConverter."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"ToInt32"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(bytes, "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"0"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"&"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":" 0x7FFFFFFF"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"; "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// positive int\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"\nmjx-container[jax=\"SVG\"] {\n  direction: ltr;\n}\n\nmjx-container[jax=\"SVG\"] > svg {\n  overflow: visible;\n  min-height: 1px;\n  min-width: 1px;\n}\n\nmjx-container[jax=\"SVG\"] > svg a {\n  fill: blue;\n  stroke: blue;\n}\n\nmjx-container[jax=\"SVG\"][display=\"true\"] {\n  display: block;\n  text-align: center;\n  margin: 1em 0;\n}\n\nmjx-container[jax=\"SVG\"][display=\"true\"][width=\"full\"] {\n  display: flex;\n}\n\nmjx-container[jax=\"SVG\"][justify=\"left\"] {\n  text-align: left;\n}\n\nmjx-container[jax=\"SVG\"][justify=\"right\"] {\n  text-align: right;\n}\n\ng[data-mml-node=\"merror\"] > g {\n  fill: red;\n  stroke: red;\n}\n\ng[data-mml-node=\"merror\"] > rect[data-background] {\n  fill: yellow;\n  stroke: none;\n}\n\ng[data-mml-node=\"mtable\"] > line[data-line], svg[data-table] > g > line[data-line] {\n  stroke-width: 70px;\n  fill: none;\n}\n\ng[data-mml-node=\"mtable\"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {\n  stroke-width: 70px;\n  fill: none;\n}\n\ng[data-mml-node=\"mtable\"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {\n  stroke-dasharray: 140;\n}\n\ng[data-mml-node=\"mtable\"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {\n  stroke-linecap: round;\n  stroke-dasharray: 0,140;\n}\n\ng[data-mml-node=\"mtable\"] > g > svg {\n  overflow: visible;\n}\n\n[jax=\"SVG\"] mjx-tool {\n  display: inline-block;\n  position: relative;\n  width: 0;\n  height: 0;\n}\n\n[jax=\"SVG\"] mjx-tool > mjx-tip {\n  position: absolute;\n  top: 0;\n  left: 0;\n}\n\nmjx-tool > mjx-tip {\n  display: inline-block;\n  padding: .2em;\n  border: 1px solid #888;\n  font-size: 70%;\n  background-color: #F8F8F8;\n  color: black;\n  box-shadow: 2px 2px 5px #AAAAAA;\n}\n\ng[data-mml-node=\"maction\"][data-toggle] {\n  cursor: pointer;\n}\n\nmjx-status {\n  display: block;\n  position: fixed;\n  left: 1em;\n  bottom: 1em;\n  min-width: 25%;\n  padding: .2em .4em;\n  border: 1px solid #888;\n  font-size: 90%;\n  background-color: #F8F8F8;\n  color: black;\n}\n\nforeignObject[data-mjx-xml] {\n  font-family: initial;\n  line-height: normal;\n  overflow: visible;\n}\n\nmjx-container[jax=\"SVG\"] path[data-c], mjx-container[jax=\"SVG\"] use[data-c] {\n  stroke-width: 3;\n}\n"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"整體章節重點-birdeye-view","depth":2,"text":"整體章節重點 (Bird‑Eye View)"},{"id":"本章要求","depth":2,"text":"本章要求"},{"id":"session1-從零開始認識-keyvalue-store","depth":2,"text":"Session 1 ： 從零開始認識 Key‑Value Store"},{"id":"session2-單機設計-vs-分散式挑戰","depth":2,"text":"Session 2 ： 單機設計 v.s. 分散式挑戰"},{"id":"_1-單一伺服器的鍵值儲存系統","depth":2,"text":"(1) 單一伺服器的鍵值儲存系統："},{"id":"_2-分散式鍵值儲存系統","depth":2,"text":"(2) 分散式鍵值儲存系統："},{"id":"session3-鍵值儲存系統的構成元素","depth":2,"text":"Session 3 ： 鍵值儲存系統的構成元素"},{"id":"資料分區一致性雜湊與水平擴充","depth":2,"text":"資料分區：一致性雜湊與水平擴充"},{"id":"資料複製高可用性的基石","depth":2,"text":"資料複製：高可用性的基石"},{"id":"一致性quorum-機制與最終一致性","depth":2,"text":"一致性：Quorum 機制與最終一致性"},{"id":"不一致問題的解決方式版本控制-versioning-與向量時鐘-vector-clock","depth":2,"text":"不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )","children":[{"id":"為什麼叫分量","depth":3,"text":"🔍 為什麼叫「分量」？"},{"id":"用分量的好處","depth":3,"text":"✅ 用「分量」的好處："},{"id":"總結","depth":3,"text":"📘 總結："}]},{"id":"節點故障與容錯機制gossip-協議sloppy-quorum-與-hinted-handoff","depth":2,"text":"節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff"},{"id":"回顧一下","depth":2,"text":"📌 回顧一下","children":[{"id":"session-3-階段內容至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰","depth":3,"text":"Session 3 階段內容，至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰"}]},{"id":"最後關注系統的實際架構實作","depth":2,"text":"📌 最後關注系統的實際架構實作"},{"id":"系統架構圖整體架構與資料存儲引擎","depth":2,"text":"系統架構圖：整體架構與資料存儲引擎"},{"id":"寫入途徑資料寫入路徑write-path","depth":2,"text":"寫入途徑：資料寫入路徑（Write Path）"},{"id":"讀取途徑資料讀取路徑read-path","depth":2,"text":"讀取途徑：資料讀取路徑（Read Path）"},{"id":"session-3-各個組件環環相扣關係的架構圖","depth":2,"text":"Session 3 各個組件環環相扣關係的架構圖：","children":[{"id":"_1-起點分散式需求","depth":3,"text":"1. 起點：分散式需求"},{"id":"_2-基礎設計資料分區與複製","depth":3,"text":"2. 基礎設計：資料分區與複製"},{"id":"_3-衍生挑戰一致性問題","depth":3,"text":"3. 衍生挑戰：一致性問題"},{"id":"_4-解決方案一致性與衝突處理","depth":3,"text":"4. 解決方案：一致性與衝突處理"},{"id":"_5-進階挑戰節點故障","depth":3,"text":"5. 進階挑戰：節點故障"},{"id":"_6-最終實現完整系統架構","depth":3,"text":"6. 最終實現：完整系統架構"}]},{"id":"環環相扣的特點","depth":2,"text":"環環相扣的特點：","children":[{"id":"c-最小鍵值存儲-api-實作範例","depth":3,"text":"C# 最小鍵值存儲 API 實作範例"},{"id":"現代鍵值存儲框架演進與比較-20232025","depth":3,"text":"現代鍵值存儲框架演進與比較 (2023–2025)"}]},{"id":"以下額外參考","depth":2,"text":"以下額外參考","children":[{"id":"資料分區一致性雜湊","depth":3,"text":"資料分區：一致性雜湊"}]}]}},"_type":"markdown","_id":"content:7.sdi-aig:6.chapter6.md","_source":"content","_file":"7.sdi-aig/6.chapter6.md","_extension":"md"}