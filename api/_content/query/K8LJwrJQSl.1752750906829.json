{"_path":"/workshop/redis-ring","_dir":"workshop","_draft":false,"_partial":false,"_locale":"","title":"Redis Ring","description":"","pageTitle":"Redis Ring","contributors":["frank30941"],"body":{"type":"root","children":[{"type":"element","tag":"h2","props":{"id":"hash-function"},"children":[{"type":"text","value":"Hash Function"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"以下是簡單的 Hash Function 的公式："}]},{"type":"element","tag":"pre","props":{"code":"XXX mod N = Y  (N: number of nodes, Y: node index)\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"XXX mod N = Y  (N: number of nodes, Y: node index)\n"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個公式可以用來計算 key 要存放在哪個 node 上。\n但是這個公式有個問題，就是當 N 增加時，會造成大量的資料重新分配，使資料不平均分配，所以 Redis Ring 使用 "},{"type":"element","tag":"a","props":{"href":"https://en.wikipedia.org/wiki/Cyclic_redundancy_check","rel":["nofollow"]},"children":[{"type":"text","value":"CRC16"}]},{"type":"text","value":" 作為 Hash Function，對於 CRC16 所產生的值範圍是 0 ~ 65535。"}]},{"type":"element","tag":"h2","props":{"id":"redis-ring"},"children":[{"type":"text","value":"Redis Ring"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"每個 node 都是一個 Redis server，而 slot 是一個 0 ~ 16383 的數字，每個 node 負責一個 slot。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"例如：node1 負責 slot 0 ~ 511，node2 負責 slot 512 ~ 1023，以此類推，直到 slot 分配到 16383 為止。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"每個 key 都會被 Hash Function 轉換成一個 slot，並存放在對應的 node 上\n其分配方式如下："}]},{"type":"element","tag":"pre","props":{"code":"slot = CRC16(key) mod 16384\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"slot = CRC16(key) mod 16384\n"}]}]},{"type":"element","tag":"pre","props":{"code":"# 依次序set key value 操作Redis Server\nset book1 abc\nset book2 def\nset book3 ghi\nset book4 jkl\nset book5 mno\nset book6 pqr\nset book7 stu\n\n# Redis叢集資料Slot分流機制\n                          client\n                            |  (依上面次序進行set操作)\n                            V\n                  CRC16(key) mod 16384\n--------------------------------------------------------------\n       Redis               Redis               Redis\n     (Master)            (Master)            (Master)\n    |        |           |       |           |       |\n    V        V           V       V           V       V\n  Redis    Redis       Redis    Redis       Redis    Redis\n(Replica) (Replica)  (Replica) (Replica)  (Replica) (Replica)\n--------------------------------------------------------------\n     book1=abc            book2=def             book3=ghi\n     book4=jkl            book5=mno             book6=pqr\n     book7=stu\n","language":"txt","meta":"","className":"language-txt shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# 依次序set key value 操作Redis Server\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book1 abc\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book2 def\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book3 ghi\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book4 jkl\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book5 mno\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book6 pqr\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"set book7 stu\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{},"children":[]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"# Redis叢集資料Slot分流機制\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"                          client\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"                            |  (依上面次序進行set操作)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"                            V\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"                  CRC16(key) mod 16384\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"--------------------------------------------------------------\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"       Redis               Redis               Redis\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"     (Master)            (Master)            (Master)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    |        |           |       |           |       |\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"    V        V           V       V           V       V\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"  Redis    Redis       Redis    Redis       Redis    Redis\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"(Replica) (Replica)  (Replica) (Replica)  (Replica) (Replica)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"--------------------------------------------------------------\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"     book1=abc            book2=def             book3=ghi\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"     book4=jkl            book5=mno             book6=pqr\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{},"children":[{"type":"text","value":"     book7=stu\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"a","props":{"href":"https://ithelp.ithome.com.tw/articles/10281010?sc=pt","rel":["nofollow"]},"children":[{"type":"text","value":"Day27 Redis架構實戰-Redis叢集Slot分流機制"}]}]},{"type":"element","tag":"h2","props":{"id":"redis-ring-的缺點"},"children":[{"type":"text","value":"Redis Ring 的缺點"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"因為 Redis Ring 是一個同步的集群，所以當一個 node 過載時，會造成整個 Redis Ring 都會變慢。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"且Redis Server集群採用Gossip協議實施無中心式叢集，如果超過1000個主節點時因為Gossip協議需要頻繁的訊息傳輸所以效率會變差，主要是因為網路頻寬的問題，故不建議部署超過1000個主節點"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"對於 Redis Ring 的資料分配，當資料量增加時，會造成資料分配不均勻，所以 Redis Ring 會造成資料分散在不同的 node 上，而不是在同一個 node 上。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"所以根據上述問題 lua script 不能對不同的 node 執行，所以在 lua script 中，不能使用 Redis Ring 的特性。(不過可以使用key{hash}的方式來分配到同一個 node 上,但有傾斜的潛在問題，或是使用pipeline的方式來執行)"}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"hash-function","depth":2,"text":"Hash Function"},{"id":"redis-ring","depth":2,"text":"Redis Ring"},{"id":"redis-ring-的缺點","depth":2,"text":"Redis Ring 的缺點"}]}},"_type":"markdown","_id":"content:2.workshop:redis-ring.md","_source":"content","_file":"2.workshop/redis-ring.md","_extension":"md"}