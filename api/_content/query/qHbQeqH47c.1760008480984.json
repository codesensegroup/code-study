{"_path":"/sdi-aig/chapter4","_dir":"sdi-aig","_draft":false,"_partial":false,"_locale":"","title":"設計網路限速器","description":"ref:https://github.com/Admol/SystemDesign/blob/main/CHAPTER 04：DESIGN A RATE LIMITER.md","pageTitle":"Chapter 4 設計網路限速器","body":{"type":"root","children":[{"type":"element","tag":"h1","props":{"id":"內行人才知道的系統設計面試指南-第四章"},"children":[{"type":"text","value":"內行人才知道的系統設計面試指南-第四章"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"ref:"},{"type":"element","tag":"a","props":{"href":"https://github.com/Admol/SystemDesign/blob/main/CHAPTER%2004%EF%BC%9ADESIGN%20A%20RATE%20LIMITER.md","rel":["nofollow"]},"children":[{"type":"text","value":"https://github.com/Admol/SystemDesign/blob/main/CHAPTER 04：DESIGN A RATE LIMITER.md"}]}]},{"type":"element","tag":"h1","props":{"id":"設計網路限速器"},"children":[{"type":"text","value":"設計網路限速器"}]},{"type":"element","tag":"h2","props":{"id":"前言"},"children":[{"type":"text","value":"前言"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在網路系統中，限速器(rate limiter) 可用來控制客戶端或服務端發送流量的速度。在HTTP的世界裡，網路線速器可以用來限制客戶端在指定時段內發送請求的數量。如果API請求數量超過網路線速器所定義的門檻值，所有額外的調用都會被擋下來。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"使用者每秒最多只能發出兩則貼文"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每天最多只能用同一個IP位置建立10個帳號"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每週最多只能用同一部設備領取5次獎勵"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"限速器好處："}]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"避免DOS(Denial of Service:拒絕服務)攻擊造成資源不足的問題："},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Twitter API: 300/3hr"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Google API: 300/60s"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"降低成本："},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"針對過多的請求作出限制，可以降低伺服器的負擔，讓更多資源分配給具有高優先等級的API。限速的做法對於第三方付費API的公司而言非常重要。例如每次只要用到以下外部API：檢查可用額度、付款、檢索健康記錄等都會被收取一筆費用。以降低成本的角度來說，限制調用次數的做法非常重要。\n案例："},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"如果我們使用Google Maps API製作APP給使用者查詢地點與導航服務"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"•\t"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"每 1,000 次地圖載入"}]},{"type":"text","value":"：收費 $7 美元。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"•\t"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"每 1,000 次地點搜尋 (Places API)"}]},{"type":"text","value":"：收費約 $17 美元。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"•\t"},{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"每 1,000 次導航路線查詢 (Directions API)"}]},{"type":"text","value":"：收費約 $5 美元。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"如果沒有限速可能會面臨非常貴的API成本"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"防止伺服器出現超載："},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"可以利用限速器篩選掉網路機器人或是不當使用者來降低負載"}]}]},{"type":"element","tag":"h2","props":{"id":"第一步驟了解問題並確立設計的範圍"},"children":[{"type":"text","value":"第一步驟—了解問題並確立設計的範圍"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"限速器的做法可以採用各種不同演算法來進行實作，每一種演算法都各有其利弊。面試官與應試者之間的互動，有助於釐清所要建立的是哪種類型的網路線速器。"}]},{"type":"element","tag":"h3","props":{"id":"面試官與應試者對話"},"children":[{"type":"text","value":"面試官與應試者對話"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"應試者：我們要設計哪一種網路限速器？是客戶端網路限速器，還是伺服端API網路限速器？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官：很好的問題。我們就專注於伺服端API網路限速器吧。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"應試者：網路限速器是否要根據IP、使用者ID或其他屬性，來限制API請求？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官：這個網路限速器應該要足夠靈活，以支援不同的限制規則組合。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"應試者：系統的規模有多大？我們要針對新創公司，還是針對擁有龐大使用者的大公司來打造？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官：系統必須能夠處理大量請求。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"應試者：系統要有能力在分散式環境中正常運作？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官：是的。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"應試者：這個限速器是單獨的服務，還是應該在應用程式碼中進行實作？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官：這個設計決策有你來決定。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"應試者：我們需要對受限制的使用者進行通知？"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"面試官：要。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"需求"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"準確限制過多的請求。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"低延遲。網路限速器不應減慢HTTP的回應時間。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"盡可能少用一些記憶體。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"採用分散式的網路限速做法。多部伺服器或多個process行程，可共用同一個網路限速器。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"異常處理能力。當使用者請求受到限制時，要向使用者顯示明確的異常通知。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"高容錯能力。如果網路限速器出現任何問題(例如快取伺服器離線)，也不能影響到整個系統。"}]}]},{"type":"element","tag":"h2","props":{"id":"第二步驟提出高階設計並取得認可"},"children":[{"type":"text","value":"第二步驟—提出高階設計並取得認可"}]},{"type":"element","tag":"h2","props":{"id":"限速器要放在哪裡"},"children":[{"type":"text","value":"限速器要放在哪裡？"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"客戶端實作：\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"一般來說，在客戶端實作網路限速器比較不可靠，因為客戶端的請求很容易被惡意行為惡搞。而且，我們有可能根本就無法控制客戶端的實作。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"伺服器端實作：\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"位於伺服器的網路限速器，直接在ap層處理的限速器"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-1.jpg"},"children":[]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"中間網路限速器"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-2.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"案例："},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-3.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"假設API只能處理2 req/s 而客戶端卻在一秒鐘內發送了3次請求。前兩次請求會被轉送到API伺服器，但是第三次會被擋下來。並返回一個HTTP 429狀態碼。HTTP 429表示使用者發送過多請求。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"基於雲端微服務的流行趨勢，通常可以在API gateway元件進行實作。API gateway是一種具有完整管理功能的服務，可以支援網路限速、SSL終止、身份驗證、IP白名單等功能，也可以針對靜態內容提供服務。目前我們只需要知道API gateway可以只緣網路限速功能就足夠了。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"在設計網路限速器時，一定要先問自己究竟要在伺服端還是在API閘道器實作限速器？這個問題沒有絕對的答案。答案取決你的公司目前現有的技術、工程資源、優先順序、目標等等。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"以下是一些通用原則："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"評估目前現有的技術，例如擅長的程式語言、現有的快取服務等。\n請務必確認目前使用的程式語言是否可以在伺服端有效時做出網路限速器"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"確認符合業務需求的網路限速演算法。如果你是在伺服端實作所有的功能，就可以完全控制所有使用的演算法。但如果使用的是第三方API gateway，選則上可能就會受到一些限制"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果已經才用微服務架構，而且在設計中也有用到API gateway來執行身份驗證、IP白名單等功能，那麼就可以直接在API gateway添加網路限速功能。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"打造自己的網路限速服務，需要花費一些時間。如果並沒有足夠的工程資源來實作網路限速器，也許採用商業化的API gateway是一個更好的選擇。"}]}]},{"type":"element","tag":"h3","props":{"id":"重點"},"children":[{"type":"text","value":"重點："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"限速器有分客戶端與伺服端"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"客戶端與服務端中間還有一種元件叫做API gateway的元件可以使用或實作"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"沒時間或工程資源不足就買商業化的API gateway。"}]}]}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"網路限速演算法"},"children":[{"type":"text","value":"網路限速演算法"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"網路陷入可以用不同的演算法進行實作，而且每一種演算法都有各自的優缺點。本章並不打算專注於演算法，而是從比較高階的角度去理解這些演算法，這樣也有助於我們選擇更符合使用狀況的正確演算法或演算法組合。以下幾種比較受歡迎的演算法列表："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Token桶 (Token bucket)"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Token桶演算法在網路限速方面受到很廣泛的應用。許多網路公司都是採用這種做法，Amazon與Stripe都是使用這種演算法來限制API請求。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Token桶演算法的工作原理如下:"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Token桶指的是先定義好一個容器的容量。Token會以定期的方式、以預設的速度放入桶中。當桶子裝滿後，就不能再繼續放入Token中了。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-4.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Token桶的容量為4。重新填入器(Refiller)會以每秒的速度把Token放入桶中。桶子一但裝滿，而外的Token就會滿出來(overflow)。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每個請求都會消耗掉一個Token。每出現一個請求時，我們都會檢查桶子裡有沒有足夠的Token。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-5.jpg"},"children":[]},{"type":"element","tag":"ol","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果有足夠的Token，我們就會取出一個Token給每一個請求，然後讓該請求通過。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果沒有足夠的Token，該請求就會被丟棄。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Token填充消費以及限速邏輯過程"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-6.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Token桶的大小為4，重新填入的速度為每分鐘4個。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Token桶演算法會用到兩個參數："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"桶子的大小：桶子裡可以放入的最大Token數量"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"重新填入的速度：定期放入桶中的Token數量"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"我們需要多少個桶子？這隨狀況而異，主要取決於限速規則。這裡有一些例子："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"不同的API端點通常需要使用不同的桶子。舉例來說，如果可以讓使用者"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"每秒發佈1則貼文"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"每天增加150個朋友"}]},{"type":"text","value":"、"},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"每秒對5則貼文按讚"}]},{"type":"text","value":"、那麼每個使用者就需要用到三個桶子。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果我們需要根據IP位址對請求做出限制，那麼每個IP位址都需要一個桶子。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果系統每秒最多可以接受10,000個請求，那麼所有請求共用一個桶子就是合理的做法。(如果系統的吞吐量已經是明確的，建立單一桶子會比建立數千個獨立桶子更簡單更有效率)"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"優點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這個演算法很容易進行實作。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"以記憶體的使用來說很有效率。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Token桶可接受短時間內出現流量爆炸的情況。只要桶子裡還有Token，就可以通過請求。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"缺點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這個演算法有兩個參數，分別是桶子的大小與Token重新填入的速度。要對這兩個參數做出適當的調整，可能蠻有挑戰性。"}]}]}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"漏水桶 (Leaking bucket)"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"漏水桶演算法與Token桶的做法很類似，其不同之處在於請求是以固定的速度來進行處理。在進行實作時，通常是採用先進先出(FIFO)的佇列。這個演算法的工作原理如下："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每出現一個請求時系統會檢查佇列是否已滿。如果未滿，就把請求添加到queue中"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果queue已滿，這個請求就會被丟棄。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"請求會從佇列被拉出來，然後以固定的間隔時間進行處理。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-7.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"漏水桶演算法會採用以下兩個參數："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"桶子大小：也就等於是queue大小。這個queue會把請求保存起來，然後以固定的速度進行處理。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"流出的速度：定義的是固定時間間隔(通常是每秒)內處理請求的數量。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"Spotify這家電子商務公司就是使用漏水桶演算法作為網路限速的機制。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"優點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"queue大小是有限的，因此提高記憶體的使用效率。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"請求是以固定的速度進行處理，因此很適合需要穩定流出的速度(outflow rate)的使用狀況。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"缺點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果出現瞬間大量的流量，舊請求就會塞滿queue，此時若未能及時進行處理，新請求的處理速度就會收到影響。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這個演算法有兩個參數。想對這兩個參數做出恰當的調整，也許並沒有那麼容易。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"固定視窗計數器 (Fixed window counter)"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"工作原理："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這個演算法會把時間軸劃分成固定大小的時間視窗，然後指定一個計數器給每個視窗使用。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"每個請求都會讓計數器加一。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"一但計數器達到預先定義的門檻值，新的請求就會被丟棄，直到下一次新的時間視窗開始，計數器歸零之後才能重新接受新的請求。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-8.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"時間單位為1s，系統能接受的速度設定為3 req/s。在每秒的視窗中，如果收到3個以上的請求，而外的請求就會被丟棄。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"這個演算法主要的問題是，時間視窗如果突然出現爆多的流量，實際上被接受的請求就有可能超過雲本設定的限制數量。請考慮以下情況："},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-9.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"系統可接受5 req/min請求，在切換到下一分鐘時就會重新設定，在2:00:00~2:01:00之間有5個請求。但如果觀察2:00:30到2:01:30這一分鐘的視窗，會發現一共通過了10個請求也就是已經到達可接受請求的兩倍。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"優點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"以記憶體的使用來說很有效率。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"容易理解。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在單位時間視窗結束時，都會重設可用的配額，這種做法對於某些使用狀況來說特別合適。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"缺點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果視窗切換時流量激增，就有可能導致系統通過的請求數超過允許的配額。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"滑動視窗日誌記錄 (Sliding window log)"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"因為固定視窗計數器演算法存在一個主要的問題：有可能在視窗切換的前後，接受過多的請求。滑動視窗日誌記錄演算法解決了此問題。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"工作原理："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這個演算法會追蹤請求的時間戳。時間戳資料通常保存在快取(例如Redis的以排序集合)。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果有新請求進來，就刪除所有過時的時間戳。所謂過時的時間戳，就是比目前時間視窗的開始時間更早的時間戳。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"把新請求的時間戳添加到日誌中。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果日誌記錄的數量等於或小於可接受的數量，就接受請求。否則請求就會被拒絕。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-10.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"系統能接受2 req/min。通常日誌記錄所儲存的都是UnixTimestamp。"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"新請求在1:00:01抵達時，日誌是空的。因此請求被接受。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"1:00:30 又來了一個請求，因此1:00:30這個時間戳被添加到日誌中。加入這個時間戳後，日誌記錄數量就變為2，還沒有超過可接受數量。因此請求同樣的被接受了。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"1:00:50 又來了一個請求，這個時間戳同樣的被加入日誌中。加入這個時間戳之後，日誌記錄的數量就變成3了，超過可接受數量2。因此雖然時間戳還是繼續保留在日誌中，但這個請求會被拒絕。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"1:01:40 又來了一個新的請求。從1:00:40到1:01:40這段時間內的請求，都還落在最後一分鐘的範圍內，但1:00:40之前的請求，全部都已經過時了，因此就會從日誌中被移除。移除操作完成之後，日誌記錄的數量就會變回2，於是最新的請求也被接受了。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"優點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"用這個演算法實作出來的限速效果非常準確。在任何滾動的時間視窗內，請求的數量都不會超出限制。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"缺點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這個演算法會用到大量記憶體，因為即使請求被拒絕，時間戳記還是會被保存在記憶體中。"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"滑動視窗計數器 (Sliding window counter)"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"滑動視窗計數器演算法是一種融合”固定視窗計數器”與“滑動視窗日誌記錄”演算法的混合做法。這個演算法可以透過兩種不同的方式來進行實作。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-11.jpg"},"children":[]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"code","props":{"className":""},"children":[{"type":"text","value":"書上寫7 github寫5"}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"假設網路限速器每分鐘最多可接受 7 req/min。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"假設這個限速器前一分鐘已經有5個請求，目前這一分鐘有3個請求。對於目前這一分鐘前30%位置出現的新請求來說，我們可以用以下公式來計算出滾動的一分鐘視窗內請求的數量："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"目前視窗內請求的數量＋前一個視窗內請求數量＊滾動視窗與前一個視窗重疊的百分比。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"使用此公式，我們就可以得到3+5*0.7%=6.5個請求。根據實際的使用狀況，數字可以選擇無條件進入。採用無條件捨去做法得出結果等於6。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"由於網路限速器每分鐘最多可以接受7個請求，因此目前這個請求還可以被接受。不過如果在收到另一個請求，就會達到限制數量。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"優點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"由於我們是根據前一個視窗平均速度來計算出餐考值，因此他可以減緩流量突然出現高峰的問題。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"以記憶體的使用來說很有效率。"}]}]},{"type":"element","tag":"br","props":{},"children":[]},{"type":"text","value":"缺點："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"這種做法只適用於較寬鬆的回溯視窗。實際上這種做法採用的是實際速度的近似值，因為這裡假設前一個視窗裡的請求，在時間上是均勻分佈。不過，在這個問題或許並不如想像中嚴重。根據cloudflare所做的實驗，在4億次請求中，只有0.003%的請求被錯誤地接受或拒絕。"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"高階架構"},"children":[{"type":"text","value":"高階架構"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"網路限速算法的基本架構想法其實很簡單。從比較高階的角度來說，我們需要一個計數器來追蹤同一個使用者、同一個IP位址等等所發送的請求數量。如果數量超過了限制，就不接受該請求。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們應該要把計數器放哪裡？由於磁碟的儲存速度緩慢，因此使用者資料庫並不是好方法。通常會選擇以記憶體快取主要是因為速度快且支援時間過期，以Redis就是實作網路限速器的常見選擇。Redis把資料保存在記憶體的儲存系統提供兩個指令：INCR與EXPIRE。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"INCR：把已儲存計數器值+1"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"EXPIRE：設定計數器的到期時間。如果超過到期時間，計數器就會自動被刪除。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-12.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"實作網路限速器的高階架構工作原理："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"客戶端向網路限速器發送請求"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"網路限速器會從Redis相應的桶子裡取的計數器的值，檢查看看有沒有超出限制。\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果超出限制，請求就會被拒絕。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果未超出限制，就把請求發送到API伺服器。於此同時，系統會把計數器的值+1，然後把值存回Redis"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"第三步驟深入設計"},"children":[{"type":"text","value":"第三步驟—深入設計"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"第二步驟的高階架構設計並沒有回答以下幾個問題："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如何建立網路限速器規則？規則要保存在哪裡？"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"因限速而被拒絕的請求，該做什麼樣的處置？"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在本節會先回答關於限速規則的問題，然後再介紹如何處理被拒絕請求的策略。最後，我們會討論分散式環境下網路限速的做法、詳細的設計、效能最佳化與監控等主題。"}]},{"type":"element","tag":"h2","props":{"id":"限速規則"},"children":[{"type":"text","value":"限速規則"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Lyft公開了他們的限速相關程式碼。因此我們可以窺探其內部程式碼，而且可以從中看到一些限速規則："}]},{"type":"element","tag":"pre","props":{"code":"domain: messaging\ndescriptors:\n  - key: message_type\n    Value: marketing\n    rate_limit:\n      unit: day\n      requests_per_unit: 5\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"domain"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"messaging\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"descriptors"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"message_type\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"marketing\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    rate_limit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      unit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"day\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      requests_per_unit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在上述例子中，系統貝貝摯為每天最多允許5則市場銷售相關訊息。這裡還有另一個範例："}]},{"type":"element","tag":"pre","props":{"code":"domain: messaging\ndescriptors:\n  - key: message_type\n    Value: marketing\n    rate_limit:\n      unit: day\n      requests_per_unit: 5\n","language":"yaml","meta":"","className":"language-yaml shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"domain"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"messaging\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"descriptors"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"  - "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"key"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"message_type\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    Value"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"marketing\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    rate_limit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      unit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"day\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#85E89D;--shiki-default:#22863A;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"      requests_per_unit"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"5\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"這個規則的意思是，客戶端登入的次數一分鐘內不能超過5次。這些規則通常會被寫入設定檔案，然後保存至硬碟中。"}]},{"type":"element","tag":"h2","props":{"id":"超出速度限制"},"children":[{"type":"text","value":"超出速度限制"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果請求次數超出限制，API就會向客戶端送回HTTP回應碼429(過多請求)。根據不同的使用狀況，我們可能會把這些超出速度限制的請求加入queue中，以便稍後再處理。舉例來說，如果有某些訂單因為系統超載而被限速規則擋下來，我們可能還是要先把這個訂單保留起來，等到隨後在進行處理。"}]},{"type":"element","tag":"h3","props":{"id":"網路限速器回應的標頭"},"children":[{"type":"text","value":"網路限速器回應的標頭"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"客戶怎麼知道它有沒有受到限制？客戶怎麼知道還能做出多少次請求，才會受到限制？答案就在HTTP回應的標頭內。網路限速器會把如下的HTTP標頭送回給客戶端："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"X-Ratelimit-Remaining：目前的視窗內，還可接受多少次請求。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"X-Ratelimit-Limit：客戶端在每個時間視窗內可進行多少次請求。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"X-Ratelimit-Retry-After：接下來還要等待幾秒鐘，才能解除限制、再次發送出請求。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如果使用這發送出太多請求，就會有429過多請求的錯誤與X-Ratelimit-Retry-After標頭被送回給客戶。"}]},{"type":"element","tag":"h2","props":{"id":"詳細的設計"},"children":[{"type":"text","value":"詳細的設計"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-13.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"整個系統詳細設計圖"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"限速規則儲存在硬碟中。Worker工作程序會定期從硬碟取出規則，然後將這些規則儲存到快取中(Cached rules)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"客戶端向伺服器端發送請求時，這個請求會先被發送到網路限速器。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"網路限速器會從快取載入規則。然後他會從Redis快取取的計數器的值，以及前一次請求的時間戳。網路限速器可以根據回應做出以下的判斷：\n"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果請求並沒有受到速度的限制，就會被轉送到API伺服器。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果請求受到了速度的限制，網路限速器就會把429過多請求的錯誤送回客戶端。於此同時，這個請求也會被丟棄(dropped)，或是轉送到一個queue。"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"分散式環境下的網路限速器"},"children":[{"type":"text","value":"分散式環境下的網路限速器"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在單一伺服器的環境下，建立網路限速器並不困難。但如果想要擴展系統，支援多個伺服器與平行的執行緒，那就是另外一回事了。這裡會有兩個挑戰："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"競爭狀況(Race-condition)"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"同步問題(Synchronization issue)"}]}]},{"type":"element","tag":"h3","props":{"id":"競爭狀況"},"children":[{"type":"text","value":"競爭狀況"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"如前所述，若從高階角度來看，網路限速器的運作方式如下："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"從Radis讀取計數器的值。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"檢查(計數器+1)有沒有超過門檻值。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"如果沒有，就把Redis裡的計數值+1"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在高度平行的環境下，就有可能發生競爭狀況。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-14.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"假設Redis裡的計數器數值為3。如果有兩個請求都在寫回計數器的值之前讀取了計數器的值，隨後兩個請求都會把計數器的值+1，然後把值寫回計數器，這兩個請求都不會知道還有另一個執行緒的存在。這兩個請求(執行緒)都會認為，他們擁有正確的計數器值4。不過，其實正確的計數器值應該是5才對。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"鎖定機制(Lock)是解決狀況最明顯的一種做法。不過，鎖定機制會大大降低系統的速度。另外還有兩種常用的策略，可以用來解決此問題："}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"Lua腳本與Redis以排序集合資料結構。"}]},{"type":"element","tag":"h3","props":{"id":"同步問題"},"children":[{"type":"text","value":"同步問題"}]},{"type":"element","tag":"hr","props":{},"children":[]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在分散式環境下，同步是另一個必須考慮的重要因素。如果要支援好幾百萬的使用者，單獨一個網路限速伺服器恐怕不足以處理所有的流量。如果使用多個網路限速伺服器，則會有同步的問題。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-15.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"客戶端#1會把請求發送到網路限速器#1，客戶端#2則會把請求發送到限速器#2，由於Web層是無狀態的(stateless)，因此客戶端也有可能把請求發送到另一個不同的網路限速器，如圖右側。如果沒有進行同步處理，網路限速器#1可能就不會有任何關於客戶端#2的資料。如此一來，網路限速器就無法正常運作了。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"其中一種可能解決方案，就是使用所謂的黏性session(sticky session)，讓客戶端自動把流量發送到同一個網路限速器。不過我們建議不要使用這種解決方式，因為這種做法既無法擴展、也不夠靈活。更好的做法應該是使用Redis這類的集中式資料儲存系統。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-16.jpg"},"children":[]}]},{"type":"element","tag":"pre","props":{"code":"1.  用戶端（Client）發出請求\n2.  請求會被分配到其中一個 Rate Limiter 節點（例如 #1 或 #2）\n3.  該節點不會自己保有限速狀態，而是：\n•   從 Redis 查詢該用戶的目前限速資料（例如當前的請求次數）\n•   執行判斷：是否超過限速門檻\n•   若未超過，則使用 Redis 的原子操作遞增請求計數並放行請求\n•   若已超過，則拒絕請求（可回應 429 Too Many Requests）\n"},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"text","value":"1.  用戶端（Client）發出請求\n2.  請求會被分配到其中一個 Rate Limiter 節點（例如 #1 或 #2）\n3.  該節點不會自己保有限速狀態，而是：\n•   從 Redis 查詢該用戶的目前限速資料（例如當前的請求次數）\n•   執行判斷：是否超過限速門檻\n•   若未超過，則使用 Redis 的原子操作遞增請求計數並放行請求\n•   若已超過，則拒絕請求（可回應 429 Too Many Requests）\n"}]}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在 Figure 4-16 架構中，無論請求經由哪一台 Rate Limiter 節點處理，所有限速器都會先從 Redis 中讀取該用戶的限速狀態，並透過 Redis 的原子操作確保一致性。這種設計讓系統能在分散式架構下仍然維持同步，避免每個節點各自為政導致限速失效。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"比起讓節點之間溝通，這種方式更簡單、更一致、也更容易擴展。"}]}]},{"type":"element","tag":"h2","props":{"id":"效能最佳化"},"children":[{"type":"text","value":"效能最佳化"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"效能最佳化是系統設計面試很常見的主題。我們所要討論的改進方式，會涵蓋兩個方面。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"第一，多資料中心的配置方式對於網路限速器來說非常重要，因為遠離資料中心的使用者一定為面臨高延遲的問題。大多數的雲端服務供應商，都會在世界各地建立許多邊緣(edge)伺服器。舉例來說，截至2020年5月20日止，Cloudflare擁有194個邊緣伺服器，分別分佈在地理上各個不同的地區。流量會自動被轉送到距離最近的邊緣伺服器，以降低延遲狀況。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://github.com/Admol/SystemDesign/raw/main/images/chapter4/figure4-17.jpg"},"children":[]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"第二，可運用『終究一致性』(eventual consistency)模型來同步資料。如果你不大了解什麼是終究一致性模型，請參”見第6章：設計鍵值儲存系統”其中討論一致性的章節內容。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"在之前的codesence設計資料密集應用中第5章與第9章也有提到eventual consistency當時的翻譯為最終一致性。看完本書第六章後發現資料密集應用中的最終一致性解釋的較詳細。"}]},{"type":"element","tag":"h2","props":{"id":"設計資料密集型應用-91-一致性保證"},"children":[{"type":"element","tag":"a","props":{"href":"https://vonng.github.io/ddia/#/zh-tw/ch9","rel":["nofollow"]},"children":[{"type":"text","value":"設計資料密集型應用"}]},{"type":"text","value":" 9.1 一致性保證"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"大多數複製的資料庫至少提供了最終一致性，這意味著如果你停止向資料庫寫入資料並等待一段不確定的時間，那麼最終所有的讀取請求都會返回相同的值。換句話說，不一致性是暫時的，最終會自行解決（假設網路中的任何故障最終都會被修復。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"對於應用開發人員而言，最終一致性是很困難的，因為它與普通單執行緒程式中變數的行為有很大區別。如果將一個值賦給一個變數，然後很快地再次讀取，不可能讀到舊的值，或者讀取失敗。資料庫表面上看起來像一個你可以讀寫的變數，但實際上它有更複雜的語義。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"我們在使用弱一致性的資料庫時必須了解弱一致性的局限性,因為錯誤常常很難找到也很難測試，因為應用可能在大多數情況下執行良好。當系統出現故障（例如網路中斷）或高併發時，最終一致性的邊緣情況才會顯現出來。"}]},{"type":"element","tag":"table","props":{},"children":[{"type":"element","tag":"thead","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"th","props":{},"children":[]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"強一致性"}]},{"type":"element","tag":"th","props":{},"children":[{"type":"text","value":"弱一致性"}]}]}]},{"type":"element","tag":"tbody","props":{},"children":[{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"解釋"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"強一至性表示，一旦一個操作（如寫入）完成，該操作的效果會立即反映在接下來所有的讀取操作上，無論這些讀取操作是從哪個節點發出的。"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"在弱一至性模型下，寫入操作的效果可能不會立即反映在隨後的讀取操作中，特別是來自其他節點的讀取操作。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"例子"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"假設你在銀行轉帳，當錢從一個帳戶轉到另一個帳戶後，不管是你自己還是其他任何人，只要查詢餘額，都會立即看到最新的數字。"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"假設你更新了你的社交媒體狀態。你的朋友可能會在幾秒鐘後或幾分鐘後才看到這個更新，取決於各種因素（如網絡延遲、緩存等）。"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"模型"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"線性一致性(linearizability)最強"}]}]},{"type":"element","tag":"td","props":{},"children":[{"type":"element","tag":"strong","props":{},"children":[{"type":"text","value":"最終一致性(Eventual Consistency)"}]}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"容錯性"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"少"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"高"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"所需資源"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"高"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"低"}]}]},{"type":"element","tag":"tr","props":{},"children":[{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"實踐"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"易"}]},{"type":"element","tag":"td","props":{},"children":[{"type":"text","value":"難"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"監控"},"children":[{"type":"text","value":"監控"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"網路限速器安排就緒後，彙整分析資料的工作也很重要，因為這樣才能檢查網路限速器是否以很有效率的方式正常運作。我們主要想去認的是："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"網路限速演算法是否很有效率。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"網路限速規則是否很有效率。"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"舉例來說，如果網路限速規則太嚴格，就會丟棄掉許多正確的請求。在這樣的情況下，我們就會想稍微放寬規則。我們還要注意另一種情況，例如流量突然增加時(比如限時搶購活動)，網路限速器可能也會失敗。在這樣的情況下，我們可以換一種演算法，以應付這種突發的流量。Token桶演算法就很適合這樣的狀況。"}]},{"type":"element","tag":"h2","props":{"id":"第四步驟彙整總結"},"children":[{"type":"text","value":"第四步驟—彙整總結"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"本章討論了幾種不同的網路限速演算法及其優缺點。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"Token桶"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"漏水桶"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"固定視窗計數器"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"滑動視窗日誌記錄"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"滑動視窗計數器"}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"然後，我們也討論了分散式環境下網路限速器的系統架構、效能最佳化與監控的做法。不管是哪一種系統設計面試問題都一樣，如果時間允許的話，你都可以提出一些其他想法："}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"網路限速器的硬性限制vs.軟性限制"},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"硬性限制：請求數量絕不能超過門檻值"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"軟性限制：請求可以在短時間內超過門檻值"}]}]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"不同等級的限速做法。我們在本章只討論應用層(HTTP:第七層)的限速做法。其實在其他層也可以套用限速做法。舉例來說，你可以利用Iptable針對IP位址(IP:第三層)套用限速的做法。請注意：OSI(Open Systems Interconnection：開放系統互聯)模型共有7層，從第1層到第7層分別是—實體層、資料鏈結層、網路層、傳輸層、會話層、表現層、應用層。"},{"type":"element","tag":"br","props":{},"children":[]},{"type":"element","tag":"img","props":{"alt":"image.png","src":"https://cf-assets.www.cloudflare.com/slt3lc6tev37/6ZH2Etm3LlFHTgmkjLmkxp/59ff240fb3ebdc7794ffaa6e1d69b7c2/osi_model_7_layers.png"},"children":[]}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"我們也應該盡量避免自己在客戶端這遭受到速度上限制。在設計客戶端時，最佳的實務做法如下："},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"運用客戶端快取，避免過度頻繁調用API。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"了解速度限制，不要在短時間內發送太多請求。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"在程式碼中捕捉異常或錯誤狀況，好讓客戶端可以優雅地從異常狀況恢復過來。"}]},{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"添加足夠的退避時間(back off time)，好讓邏輯有機會重新進行嘗試。"}]}]}]}]},{"type":"element","tag":"h2","props":{"id":"實際案例"},"children":[{"type":"text","value":"實際案例"}]},{"type":"element","tag":"pre","props":{"code":"flowchart LR\n    A[Client 發出 HTTP Request] --> B[進入 Router]\n    B --> C[log Middleware（前置處理）]\n\n    C --> PCM\n    subgraph PCM[concurrency Middleware （前置處理）]\n        direction TB\n        D1{Semaphore 有空位？}\n        D1 -- 是 --> D2[取得 Semaphore Token]\n        D1 -- 否 --> D3{Queue 有空位？}\n        D3 -- 是 --> D4[請求加入 Queue]\n        D4 --> D5[等待 notify / timeout]\n        D5 --> D6{排隊成功？}\n        D6 -- 是 --> D2\n        D6 -- 否 --> D7[返回 504 Gateway Timeout]\n        D3 -- 否 --> D8[返回 429 Too Many Requests]\n    end\n\n    D2 --> F[Handler（主邏輯處理）]\n\n        \n    F --> G1\n    subgraph CM1[concurrency Middleware （後置處理）]\n        direction TB\n            G1[釋放 Semaphore Token]\n        end\n    G1 --> G[log Middleware（後置處理）]\n    G --> H[回傳 HTTP Response 給 Client]\n\n","language":"mermaid","meta":"","className":"language-mermaid shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"flowchart"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" LR\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    A"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Client 發出 HTTP Request"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" -->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" B"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"進入 Router"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    B "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" C"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"log Middleware"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"（"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"前置處理"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"）"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    C "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" PCM\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    subgraph"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" PCM"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"concurrency Middleware "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"（"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"前置處理"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"）]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        direction TB\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Semaphore 有空位"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"？"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D1 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 是 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D2"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"取得 Semaphore Token"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D1 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 否 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D3"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Queue 有空位"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"？"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D3 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 是 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D4"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"請求加入 Queue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D4 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D5"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"等待 notify / timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D5 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D6"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"{"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"排隊成功"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"？"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D6 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 是 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D2\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D6 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 否 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D7"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"返回 504 Gateway Timeout"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        D3 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"--"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":" 否 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" D8"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"返回 429 Too Many Requests"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    end\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    D2 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" F"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"Handler"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"（"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"主邏輯處理"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"）"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        \n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    F "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" G1\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    subgraph"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" CM1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"concurrency Middleware "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"（"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"後置處理"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"）]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        direction TB\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            G1"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"釋放 Semaphore Token"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        end\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    G1 "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" G"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"log Middleware"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"（"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"後置處理"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"）"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    G "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"-->"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#FFAB70;--shiki-default:#E36209;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" H"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"["}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"回傳 HTTP Response 給 Client"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"]\n"}]}]}]}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"目標：週一維護時會有8小時的洗牌轉檔總共有32台主機會使用這個api、平時客戶端歷史調閱轉檔、自動地端影片救援"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"問題：轉檔期間cpu:99%持續超過3分鐘，且還要考慮再不增加node的情況將預算保持比使用gcp vm相當。"}]},{"type":"element","tag":"p","props":{},"children":[{"type":"text","value":"解法：使用middleware限速器限制api轉檔數量讓cpu保持在70%。"}]},{"type":"element","tag":"ul","props":{},"children":[{"type":"element","tag":"li","props":{},"children":[{"type":"text","value":"code"},{"type":"element","tag":"pre","props":{"code":"// streamConverterAPI/internal/middleware/concurrency_middleware.go\npackage middleware\n\nimport (\n    \"api/internal/model/response/common\"\n    \"api/internal/repository/logger\"\n    \"context\"\n    \"github.com/cockroachdb/errors\"\n    \"log\"\n    \"net/http\"\n    \"time\"\n\n    \"github.com/gin-gonic/gin\"\n)\n// RequestQueueItem 代表被排進佇列等待處理的請求，\n// 使用 notify channel 來通知排到該請求可以開始執行。\ntype RequestQueueItem struct {\n    notify chan struct{}\n}\n\n// ConcurrencyLimiterWithQueue 控制同時處理的請求數，\n// 超過上限的請求會被放進 queue 中等待。\n// 適合用來保護後端資源，例如資料庫、外部 API 等。\ntype ConcurrencyLimiterWithQueue struct {\n    semaphore chan struct{}         // 控制並發數量，作用類似限流 token\n    queue     chan RequestQueueItem // 請求等待佇列\n    ctx       context.Context\n    cancel    context.CancelFunc\n    loggers   logger.ILoggers\n}\n\n// NewConcurrencyLimiterWithQueue 初始化限流器，並啟動處理 queue 的 goroutine。\nfunc NewConcurrencyLimiterWithQueue(loggers logger.ILoggers, maxConcurrency, maxQueue int) *ConcurrencyLimiterWithQueue {\n    ctx, cancel := context.WithCancel(context.Background())\n    cl := &ConcurrencyLimiterWithQueue{\n        semaphore: make(chan struct{}, maxConcurrency),\n        queue:     make(chan RequestQueueItem, maxQueue),\n        ctx:       ctx,\n        cancel:    cancel,\n        loggers:   loggers,\n    }\n\n    // 背景 goroutine 處理 queue 中排隊的請求\n    go cl.processQueue()\n\n    return cl\n}\n\n// Shutdown 清理資源與關閉 queue（應在服務關閉時呼叫）\nfunc (cl *ConcurrencyLimiterWithQueue) Shutdown() {\n    cl.cancel()\n    close(cl.queue)\n}\n\n// processQueue 會不斷從 queue 中取出請求，\n// 等待有空閒資源時發送通知讓請求繼續往下執行。\nfunc (cl *ConcurrencyLimiterWithQueue) processQueue() {\n    for {\n        select {\n        case <-cl.ctx.Done():\n            return\n        case item, ok := <-cl.queue:\n            if !ok {\n                return\n            }\n            // 取得一個可用位元（token）\n            cl.semaphore <- struct{}{}\n            // 通知該請求可以執行\n            close(item.notify)\n            cl.loggers.Info(\"Request dequeued and allowed\", nil)\n        }\n    }\n}\n\n// Handle 是真正綁到 Gin 的 middleware function，\n// 當併發達到上限時，請求會被送進 queue 等待，\n// 若 queue 也滿了，就直接回應 429 Too Many Requests。\nfunc (cl *ConcurrencyLimiterWithQueue) Handle() gin.HandlerFunc {\n    return func(c *gin.Context) {\n        select {\n        // 有空位直接執行\n        case cl.semaphore <- struct{}{}:\n            cl.loggers.Info(\"Request allowed\", c.Request.Body)\n            defer func() {\n                <-cl.semaphore\n                cl.loggers.Info(\"Request completed and semaphore released\", c.Request.Body)\n            }()\n            c.Next()\n            return\n\n        // 沒有空位，放進 queue 嘗試排隊\n        default:\n            notify := make(chan struct{})\n            select {\n            case cl.queue <- RequestQueueItem{notify: notify}:\n                cl.loggers.Info(\"Request enqueued\", c.Request.Body)\n\n                select {\n                // 被通知排到，繼續處理請求\n                case <-notify:\n                    cl.loggers.Info(\"Request dequeued\", c.Request.Body)\n                    defer func() {\n                        <-cl.semaphore\n                        cl.loggers.Info(\"Request completed and semaphore released\", c.Request.Body)\n                    }()\n                    c.Next()\n\n                // 排隊超過時間，自動超時處理\n                case <-time.After(60 * time.Minute):\n                    log.Println(\"Request timed out while waiting in queue\")\n                    c.JSON(http.StatusGatewayTimeout, gin.H{\n                        \"data\": \"\",\n                        \"status\": gin.H{\n                            \"code\":    \"70002\",\n                            \"message\": \"Request timed out\",\n                        },\n                    })\n                    c.Abort()\n                    return\n                }\n\n            // queue 也塞滿了，回應 429\n            default:\n                cl.loggers.Warn(\"Request blocked: queue full\", c.Request.Body)\n                c.JSON(http.StatusTooManyRequests, common.NewResponseErr(\n                    errors.New(\"Too many requests\"),\n                    \"Request blocked: queue full\",\n                    common.ErrTooManyConcurrency,\n                ))\n                c.Abort()\n                return\n            }\n        }\n    }\n}\n","language":"go","meta":"","className":"language-go shiki shiki-themes github-dark github-light monokai","style":""},"children":[{"type":"element","tag":"code","props":{"__ignoreMap":""},"children":[{"type":"element","tag":"span","props":{"class":"line","line":1},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// streamConverterAPI/internal/middleware/concurrency_middleware.go\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":2},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"package"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" middleware\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":3},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":4},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"import"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":5},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"api/internal/model/response/common"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":6},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"api/internal/repository/logger"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":7},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"context"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":8},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"github.com/cockroachdb/errors"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":9},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"log"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":10},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"net/http"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":11},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"time"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":12},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":13},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"    \""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"github.com/gin-gonic/gin"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":14},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":15},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// RequestQueueItem 代表被排進佇列等待處理的請求，\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":16},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 使用 notify channel 來通知排到該請求可以開始執行。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":17},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" RequestQueueItem"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":18},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    notify "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":19},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":20},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":21},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// ConcurrencyLimiterWithQueue 控制同時處理的請求數，\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":22},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 超過上限的請求會被放進 queue 中等待。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":23},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 適合用來保護後端資源，例如資料庫、外部 API 等。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":24},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"type"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"},"children":[{"type":"text","value":" ConcurrencyLimiterWithQueue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":25},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    semaphore "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{}         "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 控制並發數量，作用類似限流 token\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":26},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    queue     "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" RequestQueueItem "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 請求等待佇列\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":27},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ctx       context.Context\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":28},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cancel    context.CancelFunc\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":29},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    loggers   logger.ILoggers\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":30},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":31},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":32},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// NewConcurrencyLimiterWithQueue 初始化限流器，並啟動處理 queue 的 goroutine。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":33},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":" NewConcurrencyLimiterWithQueue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(loggers logger.ILoggers, maxConcurrency, maxQueue "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"},"children":[{"type":"text","value":"int"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":") "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ConcurrencyLimiterWithQueue {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":34},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    ctx, cancel "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" context."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"WithCancel"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(context."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Background"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"())\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":35},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cl "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" &"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ConcurrencyLimiterWithQueue{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":36},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        semaphore: "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{}, maxConcurrency),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":37},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        queue:     "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" RequestQueueItem, maxQueue),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":38},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        ctx:       ctx,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":39},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        cancel:    cancel,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":40},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        loggers:   loggers,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":41},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":42},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":43},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"    // 背景 goroutine 處理 queue 中排隊的請求\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":44},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    go"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cl."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"processQueue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":45},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":46},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cl\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":47},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":48},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":49},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// Shutdown 清理資源與關閉 queue（應在服務關閉時呼叫）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":50},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (cl "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ConcurrencyLimiterWithQueue) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Shutdown"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":51},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    cl."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"cancel"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":52},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"    close"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(cl.queue)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":53},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":54},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":55},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// processQueue 會不斷從 queue 中取出請求，\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":56},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 等待有空閒資源時發送通知讓請求繼續往下執行。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":57},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (cl "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ConcurrencyLimiterWithQueue) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"processQueue"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":58},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    for"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":59},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        select"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":60},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" <-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cl.ctx."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Done"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"():\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":61},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":62},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" item, ok "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" <-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cl.queue:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":63},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            if"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" !"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ok {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":64},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                return\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":65},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":66},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            // 取得一個可用位元（token）\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":67},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            cl.semaphore "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{}{}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":68},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            // 通知該請求可以執行\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":69},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"            close"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(item.notify)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":70},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Info"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request dequeued and allowed\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"nil"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":71},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":72},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":73},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":74},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":75},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// Handle 是真正綁到 Gin 的 middleware function，\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":76},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 當併發達到上限時，請求會被送進 queue 等待，\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":77},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"// 若 queue 也滿了，就直接回應 429 Too Many Requests。\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":78},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" (cl "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"ConcurrencyLimiterWithQueue) "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"},"children":[{"type":"text","value":"Handle"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"() gin.HandlerFunc {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":79},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"    return"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(c "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"*"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"gin.Context) {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":80},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        select"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":81},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // 有空位直接執行\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":82},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cl.semaphore "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{}{}:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":83},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Info"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request allowed\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", c.Request.Body)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":84},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            defer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":85},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                <-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cl.semaphore\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":86},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Info"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request completed and semaphore released\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", c.Request.Body)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":87},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            }()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":88},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            c."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Next"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":89},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            return\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":90},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":91},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"        // 沒有空位，放進 queue 嘗試排隊\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":92},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"        default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":93},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            notify "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":":="}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":" make"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"chan"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" struct"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"{})\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":94},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            select"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":95},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" cl.queue "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"<-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" RequestQueueItem{notify: notify}:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":96},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Info"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request enqueued\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", c.Request.Body)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":97},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":98},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                select"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":99},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"                // 被通知排到，繼續處理請求\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":100},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" <-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"notify:\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":101},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Info"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request dequeued\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", c.Request.Body)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":102},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                    defer"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" func"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"() {\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":103},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                        <-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"cl.semaphore\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":104},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                        cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Info"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request completed and semaphore released\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", c.Request.Body)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":105},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    }()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":106},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    c."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Next"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":107},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":108},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"                // 排隊超過時間，自動超時處理\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":109},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                case"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" <-"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"time."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"After"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"},"children":[{"type":"text","value":"60"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":" *"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":" time.Minute):\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":110},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    log."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Println"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request timed out while waiting in queue\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":")\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":111},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    c."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(http.StatusGatewayTimeout, gin.H{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":112},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                        \"data\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":113},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                        \"status\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": gin.H{\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":114},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                            \"code\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":    "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"70002\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":115},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                            \"message\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":": "}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request timed out\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":116},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                        },\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":117},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    })\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":118},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    c."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Abort"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":119},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                    return\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":120},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":121},"children":[{"type":"element","tag":"span","props":{"emptyLinePlaceholder":true},"children":[{"type":"text","value":"\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":122},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F"},"children":[{"type":"text","value":"            // queue 也塞滿了，回應 429\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":123},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"            default"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":":\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":124},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                cl.loggers."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Warn"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Request blocked: queue full\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":", c.Request.Body)\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":125},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                c."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"JSON"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(http.StatusTooManyRequests, common."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"NewResponseErr"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"(\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":126},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    errors."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"New"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"("}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"\"Too many requests\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"),\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":127},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"},"children":[{"type":"text","value":"                    \"Request blocked: queue full\""}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":",\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":128},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                    common.ErrTooManyConcurrency,\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":129},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                ))\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":130},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"                c."}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF"},"children":[{"type":"text","value":"Abort"}]},{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"()\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":131},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"},"children":[{"type":"text","value":"                return\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":132},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"            }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":133},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"        }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":134},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"    }\n"}]}]},{"type":"element","tag":"span","props":{"class":"line","line":135},"children":[{"type":"element","tag":"span","props":{"style":"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"},"children":[{"type":"text","value":"}\n"}]}]}]}]}]}]},{"type":"element","tag":"style","props":{},"children":[{"type":"text","value":"html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}"}]}],"toc":{"title":"","searchDepth":2,"depth":2,"links":[{"id":"前言","depth":2,"text":"前言"},{"id":"第一步驟了解問題並確立設計的範圍","depth":2,"text":"第一步驟—了解問題並確立設計的範圍","children":[{"id":"面試官與應試者對話","depth":3,"text":"面試官與應試者對話"}]},{"id":"第二步驟提出高階設計並取得認可","depth":2,"text":"第二步驟—提出高階設計並取得認可"},{"id":"限速器要放在哪裡","depth":2,"text":"限速器要放在哪裡？"},{"id":"網路限速演算法","depth":2,"text":"網路限速演算法"},{"id":"高階架構","depth":2,"text":"高階架構"},{"id":"第三步驟深入設計","depth":2,"text":"第三步驟—深入設計"},{"id":"限速規則","depth":2,"text":"限速規則"},{"id":"超出速度限制","depth":2,"text":"超出速度限制","children":[{"id":"網路限速器回應的標頭","depth":3,"text":"網路限速器回應的標頭"}]},{"id":"詳細的設計","depth":2,"text":"詳細的設計"},{"id":"分散式環境下的網路限速器","depth":2,"text":"分散式環境下的網路限速器","children":[{"id":"競爭狀況","depth":3,"text":"競爭狀況"},{"id":"同步問題","depth":3,"text":"同步問題"}]},{"id":"效能最佳化","depth":2,"text":"效能最佳化"},{"id":"設計資料密集型應用-91-一致性保證","depth":2,"text":"設計資料密集型應用 9.1 一致性保證"},{"id":"監控","depth":2,"text":"監控"},{"id":"第四步驟彙整總結","depth":2,"text":"第四步驟—彙整總結"},{"id":"實際案例","depth":2,"text":"實際案例"}]}},"_type":"markdown","_id":"content:7.sdi-aig:4.chapter4.md","_source":"content","_file":"7.sdi-aig/4.chapter4.md","_extension":"md"}