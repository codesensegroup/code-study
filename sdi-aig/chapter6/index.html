<!DOCTYPE html>
<html  lang="en">
<head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>設計鍵值儲存系統 · 摳Sense讀書會筆記</title>
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="twitter:card" content="summary_large_image">
<meta property="og:image" content="https://user-images.githubusercontent.com/904724/185365452-87b7ca7b-6030-4813-a2db-5e65c785bf88.png">
<meta property="og:title" content="設計鍵值儲存系統">
<meta name="description" content="ref: CHAPTER 06：DESIGN A KEY-VALUE STORE.md">
<meta property="og:description" content="ref: CHAPTER 06：DESIGN A KEY-VALUE STORE.md">
<link rel="preload" as="fetch" crossorigin="anonymous" href="/code-study/sdi-aig/chapter6/_payload.json">
<link rel="stylesheet" href="/code-study/_nuxt/entry.3799f3b1.css">
<link rel="stylesheet" href="/code-study/_nuxt/DocumentDrivenNotFound.7238633c.css">
<link rel="stylesheet" href="/code-study/_nuxt/ButtonLink.c4905621.css">
<link rel="stylesheet" href="/code-study/_nuxt/default.39109398.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseCodeInline.21ce328c.css">
<link rel="stylesheet" href="/code-study/_nuxt/Alert.408d0512.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseA.e2976377.css">
<link rel="stylesheet" href="/code-study/_nuxt/DocsPrevNext.0d80e373.css">
<link rel="stylesheet" href="/code-study/_nuxt/DocsToc.855ff635.css">
<link rel="stylesheet" href="/code-study/_nuxt/DocsTocLinks.310b9647.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseP.945916cd.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseHr.c7c78bbe.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseBlockquote.87ef1443.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseH2.df45a763.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseOl.5ddab164.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseLi.ac05b421.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseStrong.263d77e1.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseUl.c9c63ec7.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProsePre.e63e49c6.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseCode.96aa36be.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseImg.018721e2.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseH4.5b64d6f8.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseH5.79b89231.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseEm.26a085fc.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseH3.88c2d983.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseTable.c65fbffe.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseThead.332c0b8a.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseTr.65bec588.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseTh.cb34fc46.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseTd.b09a068a.css">
<link rel="stylesheet" href="/code-study/_nuxt/ProseH1.4070ea3e.css">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/entry.c5a0028a.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/document-driven.380eefc4.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DocumentDrivenEmpty.f229ded5.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ContentRenderer.f53e9e95.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ContentRendererMarkdown.vue.5cb45d98.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DocumentDrivenNotFound.0d198c96.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ButtonLink.4055963e.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/slot.c92705d5.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/node.676c5e99.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/default.5a464b04.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseCodeInline.aa71b64c.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/Alert.5a3b9411.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseA.5f926489.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/EditOnLink.vue.40b59df2.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DocsPrevNext.5a079ae2.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DocsToc.3c0408e7.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DocsTocLinks.eef091f7.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ContentRendererMarkdown.4c0c2400.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/EditOnLink.7200de02.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseP.96993f37.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseHr.430e0636.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseBlockquote.e80ae4e2.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseH2.123fb3ca.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseOl.839a5d7f.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseLi.38aeba7e.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseStrong.a5f88f7a.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseUl.691374a0.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProsePre.e8b70b59.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseCode.30f4d480.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseImg.72c39a5c.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseH4.35f94921.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseH5.436b3573.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseEm.8c36c372.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseH3.061e3baf.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseTable.2a0f5ff4.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseThead.bf28b390.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseTr.ed73a12f.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseTh.baec78a4.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseTbody.afdba4dd.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseTd.00f83cdc.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ProseH1.db2283b2.js">
<link rel="prefetch" as="style" href="/code-study/_nuxt/page.41b64923.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/page.03af7996.js">
<link rel="prefetch" as="style" href="/code-study/_nuxt/useStudio.37ff8fdd.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/useStudio.12427267.js">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/debug.2c550f92.js">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/client-db.1b454549.js">
<link rel="prefetch" as="style" href="/code-study/_nuxt/error-404.e7689c2d.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/error-404.199c4b92.js">
<link rel="prefetch" as="style" href="/code-study/_nuxt/error-500.92b46a75.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/error-500.c2a9c33d.js">
<script type="module" src="/code-study/_nuxt/entry.c5a0028a.js" crossorigin></script><style id="pinceau-runtime-hydratable">@media{.phy[--]{--puid:M3JUDE-v;}.pv-mhGOP5{padding-left:var(--elements-container-padding-mobile);padding-right:var(--elements-container-padding-mobile);}@media (min-width: 475px){.pv-mhGOP5{padding-left:var(--elements-container-padding-xs);padding-right:var(--elements-container-padding-xs);}}@media (min-width: 640px){.pv-mhGOP5{padding-left:var(--elements-container-padding-sm);padding-right:var(--elements-container-padding-sm);}}@media (min-width: 768px){.pv-mhGOP5{padding-left:var(--elements-container-padding-md);padding-right:var(--elements-container-padding-md);}}} </style><style id="pinceau-theme">@media { :root {--pinceau-mq: initial; --docus-search-results-highlight-color: white;--docus-search-results-window-maxHeight: 100%;--docus-search-results-window-maxWidth: 640px;--docus-search-results-window-marginTop: 0;--docus-search-input-borderStyle: solid;--docus-search-input-borderWidth: 1px;--docus-search-backdropFilter: blur(24px);--docus-loadingBar-gradientColorStop3: #0047e1;--docus-loadingBar-gradientColorStop2: #34cdfe;--docus-loadingBar-gradientColorStop1: #00dc82;--docus-loadingBar-height: 3px;--docus-readableLine: 78ch;--docus-footer-height: 145px;--docus-header-height: 64px;--prose-code-inline-padding: 0.2rem 0.375rem 0.2rem 0.375rem;--prose-code-block-backdropFilter: contrast(1);--prose-code-block-border-style: solid;--prose-code-block-border-width: 1px;--prose-tbody-tr-borderBottom-style: dashed;--prose-tbody-tr-borderBottom-width: 1px;--prose-th-textAlign: inherit;--prose-thead-borderBottom-style: solid;--prose-thead-borderBottom-width: 1px;--prose-thead-border-style: solid;--prose-thead-border-width: 0px;--prose-table-textAlign: start;--prose-hr-width: 1px;--prose-hr-style: solid;--prose-li-listStylePosition: outside;--prose-ol-li-markerColor: currentColor;--prose-ol-paddingInlineStart: 21px;--prose-ol-listStyleType: decimal;--prose-ul-li-markerColor: currentColor;--prose-ul-paddingInlineStart: 21px;--prose-ul-listStyleType: disc;--prose-blockquote-border-style: solid;--prose-blockquote-border-width: 4px;--prose-blockquote-quotes: '201C' '201D' '2018' '2019';--prose-blockquote-paddingInlineStart: 24px;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-hasCode-borderBottom: none;--prose-a-border-distance: 2px;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-border-style-hover: solid;--prose-a-border-style-static: dashed;--prose-a-border-width: 1px;--prose-a-color-static: inherit;--prose-a-textDecoration: none;--prose-h6-margin: 3rem 0 2rem;--prose-h5-margin: 3rem 0 2rem;--prose-h4-margin: 3rem 0 2rem;--prose-h3-margin: 3rem 0 2rem;--prose-h2-margin: 3rem 0 2rem;--prose-h1-margin: 0 0 2rem;--typography-lead-loose: 2;--typography-lead-relaxed: 1.625;--typography-lead-normal: 1.5;--typography-lead-snug: 1.375;--typography-lead-tight: 1.25;--typography-lead-none: 1;--typography-lead-10: 2.5rem;--typography-lead-9: 2.25rem;--typography-lead-8: 2rem;--typography-lead-7: 1.75rem;--typography-lead-6: 1.5rem;--typography-lead-5: 1.25rem;--typography-lead-4: 1rem;--typography-lead-3: .75rem;--typography-lead-2: .5rem;--typography-lead-1: .025rem;--typography-fontWeight-black: 900;--typography-fontWeight-extrabold: 800;--typography-fontWeight-bold: 700;--typography-fontWeight-semibold: 600;--typography-fontWeight-medium: 500;--typography-fontWeight-normal: 400;--typography-fontWeight-light: 300;--typography-fontWeight-extralight: 200;--typography-fontWeight-thin: 100;--typography-fontSize-9xl: 128px;--typography-fontSize-8xl: 96px;--typography-fontSize-7xl: 72px;--typography-fontSize-6xl: 60px;--typography-fontSize-5xl: 48px;--typography-fontSize-4xl: 36px;--typography-fontSize-3xl: 30px;--typography-fontSize-2xl: 24px;--typography-fontSize-xl: 20px;--typography-fontSize-lg: 18px;--typography-fontSize-base: 16px;--typography-fontSize-sm: 14px;--typography-fontSize-xs: 12px;--typography-letterSpacing-wide: 0.025em;--typography-letterSpacing-tight: -0.025em;--typography-verticalMargin-base: 24px;--typography-verticalMargin-sm: 16px;--elements-border-secondary-hover: [object Object];--elements-backdrop-background: #fffc;--elements-backdrop-filter: saturate(200%) blur(20px);--elements-container-maxWidth: 80rem;--lead-loose: 2;--lead-relaxed: 1.625;--lead-normal: 1.5;--lead-snug: 1.375;--lead-tight: 1.25;--lead-none: 1;--lead-10: 2.5rem;--lead-9: 2.25rem;--lead-8: 2rem;--lead-7: 1.75rem;--lead-6: 1.5rem;--lead-5: 1.25rem;--lead-4: 1rem;--lead-3: .75rem;--lead-2: .5rem;--lead-1: .025rem;--letterSpacing-widest: 0.1em;--letterSpacing-wider: 0.05em;--letterSpacing-wide: 0.025em;--letterSpacing-normal: 0em;--letterSpacing-tight: -0.025em;--letterSpacing-tighter: -0.05em;--fontSize-9xl: 8rem;--fontSize-8xl: 6rem;--fontSize-7xl: 4.5rem;--fontSize-6xl: 3.75rem;--fontSize-5xl: 3rem;--fontSize-4xl: 2.25rem;--fontSize-3xl: 1.875rem;--fontSize-2xl: 1.5rem;--fontSize-xl: 1.25rem;--fontSize-lg: 1.125rem;--fontSize-base: 1rem;--fontSize-sm: 0.875rem;--fontSize-xs: 0.75rem;--fontWeight-black: 900;--fontWeight-extrabold: 800;--fontWeight-bold: 700;--fontWeight-semibold: 600;--fontWeight-medium: 500;--fontWeight-normal: 400;--fontWeight-light: 300;--fontWeight-extralight: 200;--fontWeight-thin: 100;--font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;--font-serif: ui-serif, Georgia, Cambria, Times New Roman, Times, serif;--font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;--opacity-total: 1;--opacity-high: 0.8;--opacity-medium: 0.5;--opacity-soft: 0.3;--opacity-light: 0.15;--opacity-bright: 0.1;--opacity-noOpacity: 0;--borderWidth-lg: 3px;--borderWidth-md: 2px;--borderWidth-sm: 1px;--borderWidth-noBorder: 0;--space-rem-875: 0.875rem;--space-rem-625: 0.625rem;--space-rem-375: 0.375rem;--space-rem-125: 0.125rem;--space-px: 1px;--space-128: 32rem;--space-96: 24rem;--space-80: 20rem;--space-72: 18rem;--space-64: 16rem;--space-60: 15rem;--space-56: 14rem;--space-52: 13rem;--space-48: 12rem;--space-44: 11rem;--space-40: 10rem;--space-36: 9rem;--space-32: 8rem;--space-28: 7rem;--space-24: 6rem;--space-20: 5rem;--space-16: 4rem;--space-14: 3.5rem;--space-12: 3rem;--space-11: 2.75rem;--space-10: 2.5rem;--space-9: 2.25rem;--space-8: 2rem;--space-7: 1.75rem;--space-6: 1.5rem;--space-5: 1.25rem;--space-4: 1rem;--space-3: 0.75rem;--space-2: 0.5rem;--space-1: 0.25rem;--space-0: 0px;--size-full: 100%;--size-7xl: 80rem;--size-6xl: 72rem;--size-5xl: 64rem;--size-4xl: 56rem;--size-3xl: 48rem;--size-2xl: 42rem;--size-xl: 36rem;--size-lg: 32rem;--size-md: 28rem;--size-sm: 24rem;--size-xs: 20rem;--size-200: 200px;--size-104: 104px;--size-80: 80px;--size-64: 64px;--size-56: 56px;--size-48: 48px;--size-40: 40px;--size-32: 32px;--size-24: 24px;--size-20: 20px;--size-16: 16px;--size-12: 12px;--size-8: 8px;--size-6: 6px;--size-4: 4px;--size-2: 2px;--size-0: 0px;--radii-full: 9999px;--radii-3xl: 1.75rem;--radii-2xl: 1.5rem;--radii-xl: 1rem;--radii-lg: 0.75rem;--radii-md: 0.5rem;--radii-sm: 0.375rem;--radii-xs: 0.25rem;--radii-2xs: 0.125rem;--radii-none: 0px;--shadow-none: 0px 0px 0px 0px transparent;--height-screen: 100vh;--width-screen: 100vw;--color-primary-900: #001A1F;--color-primary-800: #00232B;--color-primary-700: #024757;--color-primary-600: #09A0C1;--color-primary-500: #1AD6FF;--color-primary-400: #55E1FF;--color-primary-300: #82E3FF;--color-primary-200: #C5F2FF;--color-primary-100: #DCF7FF;--color-primary-50: #F1FCFF;--color-ruby-900: #380011;--color-ruby-800: #700021;--color-ruby-700: #a90032;--color-ruby-600: #e10043;--color-ruby-500: #ff1a5e;--color-ruby-400: #ff4079;--color-ruby-300: #ff6694;--color-ruby-200: #ff8dae;--color-ruby-100: #ffb3c9;--color-ruby-50: #ffd9e4;--color-pink-900: #380025;--color-pink-800: #70004b;--color-pink-700: #a90070;--color-pink-600: #e10095;--color-pink-500: #ff1ab2;--color-pink-400: #ff40bf;--color-pink-300: #ff66cc;--color-pink-200: #ff8dd8;--color-pink-100: #ffb3e5;--color-pink-50: #ffd9f2;--color-purple-900: #190038;--color-purple-800: #330070;--color-purple-700: #4c00a9;--color-purple-600: #6500e1;--color-purple-500: #811aff;--color-purple-400: #9640ff;--color-purple-300: #ab66ff;--color-purple-200: #c08dff;--color-purple-100: #d5b3ff;--color-purple-50: #ead9ff;--color-royalblue-900: #0b0531;--color-royalblue-800: #160a62;--color-royalblue-700: #211093;--color-royalblue-600: #2c15c4;--color-royalblue-500: #4127e8;--color-royalblue-400: #614bec;--color-royalblue-300: #806ff0;--color-royalblue-200: #a093f3;--color-royalblue-100: #c0b7f7;--color-royalblue-50: #dfdbfb;--color-indigoblue-900: #001238;--color-indigoblue-800: #002370;--color-indigoblue-700: #0035a9;--color-indigoblue-600: #0047e1;--color-indigoblue-500: #1a62ff;--color-indigoblue-400: #407cff;--color-indigoblue-300: #6696ff;--color-indigoblue-200: #8db0ff;--color-indigoblue-100: #b3cbff;--color-indigoblue-50: #d9e5ff;--color-blue-900: #00131D;--color-blue-800: #002235;--color-blue-700: #014267;--color-blue-600: #0069A6;--color-blue-500: #1AADFF;--color-blue-400: #64C7FF;--color-blue-300: #A1DDFF;--color-blue-200: #C6EAFF;--color-blue-100: #DFF3FF;--color-blue-50: #F2FAFF;--color-lightblue-900: #002e38;--color-lightblue-800: #005c70;--color-lightblue-700: #008aa9;--color-lightblue-600: #00b9e1;--color-lightblue-500: #1ad6ff;--color-lightblue-400: #40ddff;--color-lightblue-300: #66e4ff;--color-lightblue-200: #8deaff;--color-lightblue-100: #b3f1ff;--color-lightblue-50: #d9f8ff;--color-teal-900: #062a28;--color-teal-800: #0b544f;--color-teal-700: #117d77;--color-teal-600: #16a79e;--color-teal-500: #1cd1c6;--color-teal-400: #36e4da;--color-teal-300: #5fe9e1;--color-teal-200: #87efe9;--color-teal-100: #aff4f0;--color-teal-50: #d7faf8;--color-pear-900: #2a2b09;--color-pear-800: #545512;--color-pear-700: #7e801b;--color-pear-600: #a8aa24;--color-pear-500: #d0d32f;--color-pear-400: #d8da52;--color-pear-300: #e0e274;--color-pear-200: #e8e997;--color-pear-100: #eff0ba;--color-pear-50: #f7f8dc;--color-red-900: #1C0301;--color-red-800: #340A01;--color-red-700: #701704;--color-red-600: #BB2402;--color-red-500: #FF3B10;--color-red-400: #FF7353;--color-red-300: #FFA692;--color-red-200: #FFDED7;--color-red-100: #FFF3F0;--color-red-50: #FFF9F8;--color-orange-900: #381800;--color-orange-800: #702f00;--color-orange-700: #a94700;--color-orange-600: #e15e00;--color-orange-500: #ff7a1a;--color-orange-400: #ff9040;--color-orange-300: #ffa666;--color-orange-200: #ffbd8d;--color-orange-100: #ffd3b3;--color-orange-50: #ffe9d9;--color-yellow-900: #1B1500;--color-yellow-800: #292100;--color-yellow-700: #614E02;--color-yellow-600: #CBA408;--color-yellow-500: #FBCA05;--color-yellow-400: #FFDC4E;--color-yellow-300: #FFE372;--color-yellow-200: #FFF0B1;--color-yellow-100: #FFF6D3;--color-yellow-50: #FFFCEE;--color-green-900: #00190F;--color-green-800: #002817;--color-green-700: #006037;--color-green-600: #00B467;--color-green-500: #0DD885;--color-green-400: #3CEEA5;--color-green-300: #86FBCB;--color-green-200: #C3FFE6;--color-green-100: #DEFFF1;--color-green-50: #ECFFF7;--color-gray-900: #121110;--color-gray-800: #201E1B;--color-gray-700: #36332E;--color-gray-600: #67635D;--color-gray-500: #97948F;--color-gray-400: #ADA9A4;--color-gray-300: #DBD9D3;--color-gray-200: #ECEBE8;--color-gray-100: #F6F5F4;--color-gray-50: #FBFBFB;--color-black: #0B0A0A;--color-white: #ffffff;--media-portrait: only screen and (orientation: portrait);--media-landscape: only screen and (orientation: landscape);--media-rm: (prefers-reduced-motion: reduce);--media-2xl: (min-width: 1536px);--media-xl: (min-width: 1280px);--media-lg: (min-width: 1024px);--media-md: (min-width: 768px);--media-sm: (min-width: 640px);--media-xs: (min-width: 475px);--docus-search-results-highlight-backgroundColor: var(--color-primary-500);--docus-search-results-selected-backgroundColor: var(--color-gray-300);--docus-search-results-window-borderRadius: none;--docus-search-results-window-marginX: 0;--docus-search-input-backgroundColor: var(--color-gray-200);--docus-search-input-padding: var(--space-2) var(--space-4);--docus-search-input-gap: var(--space-2);--docus-search-input-fontSize: var(--fontSize-sm);--docus-search-input-borderColor: var(--color-gray-200);--docus-search-input-borderRadius: var(--radii-2xs);--docus-footer-padding: var(--space-4) 0;--docus-header-title-color-hover: var(--color-primary-500);--docus-header-title-color-static: var(--color-gray-900);--docus-header-title-fontWeight: var(--fontWeight-bold);--docus-header-title-fontSize: var(--fontSize-2xl);--docus-header-logo-height: var(--space-6);--docus-body-fontFamily: var(--font-sans);--docus-body-color: var(--color-gray-800);--docus-body-backgroundColor: var(--color-white);--prose-code-inline-fontWeight: var(--typography-fontWeight-normal);--prose-code-inline-fontSize: var(--typography-fontSize-sm);--prose-code-inline-borderRadius: var(--radii-xs);--prose-code-block-pre-padding: var(--typography-verticalMargin-sm);--prose-code-block-margin: var(--typography-verticalMargin-base) 0;--prose-code-block-fontSize: var(--typography-fontSize-sm);--prose-tbody-code-inline-fontSize: var(--typography-fontSize-sm);--prose-tbody-td-padding: var(--typography-verticalMargin-sm);--prose-th-fontWeight: var(--typography-fontWeight-semibold);--prose-th-padding: 0 var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm);--prose-table-lineHeight: var(--typography-lead-6);--prose-table-fontSize: var(--typography-fontSize-sm);--prose-table-margin: var(--typography-verticalMargin-base) 0;--prose-hr-margin: var(--typography-verticalMargin-base) 0;--prose-li-margin: var(--typography-verticalMargin-sm) 0;--prose-ol-margin: var(--typography-verticalMargin-base) 0;--prose-ul-margin: var(--typography-verticalMargin-base) 0;--prose-blockquote-margin: var(--typography-verticalMargin-base) 0;--prose-a-code-border-style: var(--prose-a-border-style-static);--prose-a-code-border-width: var(--prose-a-border-width);--prose-a-fontWeight: var(--typography-fontWeight-medium);--prose-img-margin: var(--typography-verticalMargin-base) 0;--prose-strong-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-iconSize: var(--typography-fontSize-base);--prose-h6-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-lineHeight: var(--typography-lead-normal);--prose-h6-fontSize: var(--typography-fontSize-lg);--prose-h5-iconSize: var(--typography-fontSize-lg);--prose-h5-fontWeight: var(--typography-fontWeight-semibold);--prose-h5-lineHeight: var(--typography-lead-snug);--prose-h5-fontSize: var(--typography-fontSize-xl);--prose-h4-iconSize: var(--typography-fontSize-lg);--prose-h4-letterSpacing: var(--typography-letterSpacing-tight);--prose-h4-fontWeight: var(--typography-fontWeight-semibold);--prose-h4-lineHeight: var(--typography-lead-snug);--prose-h4-fontSize: var(--typography-fontSize-2xl);--prose-h3-iconSize: var(--typography-fontSize-xl);--prose-h3-letterSpacing: var(--typography-letterSpacing-tight);--prose-h3-fontWeight: var(--typography-fontWeight-semibold);--prose-h3-lineHeight: var(--typography-lead-snug);--prose-h3-fontSize: var(--typography-fontSize-3xl);--prose-h2-iconSize: var(--typography-fontSize-2xl);--prose-h2-letterSpacing: var(--typography-letterSpacing-tight);--prose-h2-fontWeight: var(--typography-fontWeight-semibold);--prose-h2-lineHeight: var(--typography-lead-tight);--prose-h2-fontSize: var(--typography-fontSize-4xl);--prose-h1-iconSize: var(--typography-fontSize-3xl);--prose-h1-letterSpacing: var(--typography-letterSpacing-tight);--prose-h1-fontWeight: var(--typography-fontWeight-bold);--prose-h1-lineHeight: var(--typography-lead-tight);--prose-h1-fontSize: var(--typography-fontSize-5xl);--prose-p-br-margin: var(--typography-verticalMargin-base) 0 0 0;--prose-p-margin: var(--typography-verticalMargin-base) 0;--prose-p-lineHeight: var(--typography-lead-normal);--prose-p-fontSize: var(--typography-fontSize-base);--typography-color-secondary-900: var(--color-gray-900);--typography-color-secondary-800: var(--color-gray-800);--typography-color-secondary-700: var(--color-gray-700);--typography-color-secondary-600: var(--color-gray-600);--typography-color-secondary-500: var(--color-gray-500);--typography-color-secondary-400: var(--color-gray-400);--typography-color-secondary-300: var(--color-gray-300);--typography-color-secondary-200: var(--color-gray-200);--typography-color-secondary-100: var(--color-gray-100);--typography-color-secondary-50: var(--color-gray-50);--typography-color-primary-900: var(--color-primary-900);--typography-color-primary-800: var(--color-primary-800);--typography-color-primary-700: var(--color-primary-700);--typography-color-primary-600: var(--color-primary-600);--typography-color-primary-500: var(--color-primary-500);--typography-color-primary-400: var(--color-primary-400);--typography-color-primary-300: var(--color-primary-300);--typography-color-primary-200: var(--color-primary-200);--typography-color-primary-100: var(--color-primary-100);--typography-color-primary-50: var(--color-primary-50);--typography-font-code: var(--font-mono);--typography-font-body: var(--font-sans);--typography-font-display: var(--font-sans);--typography-body-backgroundColor: var(--color-white);--typography-body-color: var(--color-black);--elements-state-danger-borderColor-secondary: var(--color-red-200);--elements-state-danger-borderColor-primary: var(--color-red-100);--elements-state-danger-backgroundColor-secondary: var(--color-red-100);--elements-state-danger-backgroundColor-primary: var(--color-red-50);--elements-state-danger-color-secondary: var(--color-red-600);--elements-state-danger-color-primary: var(--color-red-500);--elements-state-warning-borderColor-secondary: var(--color-yellow-200);--elements-state-warning-borderColor-primary: var(--color-yellow-100);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-100);--elements-state-warning-backgroundColor-primary: var(--color-yellow-50);--elements-state-warning-color-secondary: var(--color-yellow-700);--elements-state-warning-color-primary: var(--color-yellow-600);--elements-state-success-borderColor-secondary: var(--color-green-200);--elements-state-success-borderColor-primary: var(--color-green-100);--elements-state-success-backgroundColor-secondary: var(--color-green-100);--elements-state-success-backgroundColor-primary: var(--color-green-50);--elements-state-success-color-secondary: var(--color-green-600);--elements-state-success-color-primary: var(--color-green-500);--elements-state-info-borderColor-secondary: var(--color-blue-200);--elements-state-info-borderColor-primary: var(--color-blue-100);--elements-state-info-backgroundColor-secondary: var(--color-blue-100);--elements-state-info-backgroundColor-primary: var(--color-blue-50);--elements-state-info-color-secondary: var(--color-blue-600);--elements-state-info-color-primary: var(--color-blue-500);--elements-state-primary-borderColor-secondary: var(--color-primary-200);--elements-state-primary-borderColor-primary: var(--color-primary-100);--elements-state-primary-backgroundColor-secondary: var(--color-primary-100);--elements-state-primary-backgroundColor-primary: var(--color-primary-50);--elements-state-primary-color-secondary: var(--color-primary-700);--elements-state-primary-color-primary: var(--color-primary-600);--elements-surface-secondary-backgroundColor: var(--color-gray-200);--elements-surface-primary-backgroundColor: var(--color-gray-100);--elements-surface-background-base: var(--color-gray-100);--elements-border-secondary-static: var(--color-gray-200);--elements-border-primary-hover: var(--color-gray-200);--elements-border-primary-static: var(--color-gray-100);--elements-container-padding-md: var(--space-6);--elements-container-padding-sm: var(--space-6);--elements-container-padding-xs: var(--space-4);--elements-container-padding-mobile: var(--space-4);--elements-text-secondary-color-hover: var(--color-gray-700);--elements-text-secondary-color-static: var(--color-gray-500);--elements-text-primary-color-static: var(--color-gray-900);--text-6xl-lineHeight: var(--lead-none);--text-6xl-fontSize: var(--fontSize-6xl);--text-5xl-lineHeight: var(--lead-none);--text-5xl-fontSize: var(--fontSize-5xl);--text-4xl-lineHeight: var(--lead-10);--text-4xl-fontSize: var(--fontSize-4xl);--text-3xl-lineHeight: var(--lead-9);--text-3xl-fontSize: var(--fontSize-3xl);--text-2xl-lineHeight: var(--lead-8);--text-2xl-fontSize: var(--fontSize-2xl);--text-xl-lineHeight: var(--lead-7);--text-xl-fontSize: var(--fontSize-xl);--text-lg-lineHeight: var(--lead-7);--text-lg-fontSize: var(--fontSize-lg);--text-base-lineHeight: var(--lead-6);--text-base-fontSize: var(--fontSize-base);--text-sm-lineHeight: var(--lead-5);--text-sm-fontSize: var(--fontSize-sm);--text-xs-lineHeight: var(--lead-4);--text-xs-fontSize: var(--fontSize-xs);--color-shadow: var(--color-gray-400);--color-secondary-900: var(--color-gray-900);--color-secondary-800: var(--color-gray-800);--color-secondary-700: var(--color-gray-700);--color-secondary-600: var(--color-gray-600);--color-secondary-500: var(--color-gray-500);--color-secondary-400: var(--color-gray-400);--color-secondary-300: var(--color-gray-300);--color-secondary-200: var(--color-gray-200);--color-secondary-100: var(--color-gray-100);--color-secondary-50: var(--color-gray-50);--prose-code-inline-backgroundColor: var(--typography-color-secondary-100);--prose-code-inline-color: var(--typography-color-secondary-700);--prose-code-block-backgroundColor: var(--typography-color-secondary-100);--prose-code-block-color: var(--typography-color-secondary-700);--prose-code-block-border-color: var(--typography-color-secondary-200);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-200);--prose-th-color: var(--typography-color-secondary-600);--prose-thead-borderBottom-color: var(--typography-color-secondary-200);--prose-thead-border-color: var(--typography-color-secondary-300);--prose-hr-color: var(--typography-color-secondary-200);--prose-blockquote-border-color: var(--typography-color-secondary-200);--prose-blockquote-color: var(--typography-color-secondary-500);--prose-a-code-background-hover: var(--typography-color-primary-50);--prose-a-code-border-color-hover: var(--typography-color-primary-500);--prose-a-code-border-color-static: var(--typography-color-secondary-400);--prose-a-color-hover: var(--typography-color-primary-500);--shadow-2xl: 0px 25px 50px -12px var(--color-shadow);--shadow-xl: 0px 20px 25px -5px var(--color-shadow), 0px 8px 10px -6px var(--color-shadow);--shadow-lg: 0px 10px 15px -3px var(--color-shadow), 0px 4px 6px -4px var(--color-shadow);--shadow-md: 0px 4px 6px -1px var(--color-shadow), 0px 2px 4px -2px var(--color-shadow);--shadow-sm: 0px 1px 3px 0px var(--color-shadow), 0px 1px 2px -1px var(--color-shadow);--shadow-xs: 0px 1px 2px 0px var(--color-shadow); } }@media { :root.dark {--pinceau-mq: dark; --prose-code-block-backdropFilter: contrast(1);--prose-ol-li-markerColor: currentColor;--prose-ul-li-markerColor: currentColor;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-color-static: inherit;--elements-backdrop-background: #0c0d0ccc;--docus-search-results-selected-backgroundColor: var(--color-gray-700);--docus-search-input-backgroundColor: var(--color-gray-800);--docus-search-input-borderColor: transparent;--docus-header-title-color-static: var(--color-gray-100);--docus-body-color: var(--color-gray-200);--docus-body-backgroundColor: var(--color-black);--typography-body-backgroundColor: var(--color-black);--typography-body-color: var(--color-white);--elements-state-danger-borderColor-secondary: var(--color-red-700);--elements-state-danger-borderColor-primary: var(--color-red-800);--elements-state-danger-backgroundColor-secondary: var(--color-red-800);--elements-state-danger-backgroundColor-primary: var(--color-red-900);--elements-state-danger-color-secondary: var(--color-red-200);--elements-state-danger-color-primary: var(--color-red-300);--elements-state-warning-borderColor-secondary: var(--color-yellow-700);--elements-state-warning-borderColor-primary: var(--color-yellow-800);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-800);--elements-state-warning-backgroundColor-primary: var(--color-yellow-900);--elements-state-warning-color-secondary: var(--color-yellow-200);--elements-state-warning-color-primary: var(--color-yellow-400);--elements-state-success-borderColor-secondary: var(--color-green-700);--elements-state-success-borderColor-primary: var(--color-green-800);--elements-state-success-backgroundColor-secondary: var(--color-green-800);--elements-state-success-backgroundColor-primary: var(--color-green-900);--elements-state-success-color-secondary: var(--color-green-200);--elements-state-success-color-primary: var(--color-green-400);--elements-state-info-borderColor-secondary: var(--color-blue-700);--elements-state-info-borderColor-primary: var(--color-blue-800);--elements-state-info-backgroundColor-secondary: var(--color-blue-800);--elements-state-info-backgroundColor-primary: var(--color-blue-900);--elements-state-info-color-secondary: var(--color-blue-200);--elements-state-info-color-primary: var(--color-blue-400);--elements-state-primary-borderColor-secondary: var(--color-primary-700);--elements-state-primary-borderColor-primary: var(--color-primary-800);--elements-state-primary-backgroundColor-secondary: var(--color-primary-800);--elements-state-primary-backgroundColor-primary: var(--color-primary-900);--elements-state-primary-color-secondary: var(--color-primary-200);--elements-state-primary-color-primary: var(--color-primary-400);--elements-surface-secondary-backgroundColor: var(--color-gray-800);--elements-surface-primary-backgroundColor: var(--color-gray-900);--elements-surface-background-base: var(--color-gray-900);--elements-border-secondary-static: var(--color-gray-800);--elements-border-primary-hover: var(--color-gray-800);--elements-border-primary-static: var(--color-gray-900);--elements-text-secondary-color-hover: var(--color-gray-200);--elements-text-secondary-color-static: var(--color-gray-400);--elements-text-primary-color-static: var(--color-gray-50);--color-shadow: var(--color-gray-800);--prose-code-inline-backgroundColor: var(--typography-color-secondary-800);--prose-code-inline-color: var(--typography-color-secondary-200);--prose-code-block-backgroundColor: var(--typography-color-secondary-900);--prose-code-block-color: var(--typography-color-secondary-200);--prose-code-block-border-color: var(--typography-color-secondary-800);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-800);--prose-th-color: var(--typography-color-secondary-400);--prose-thead-borderBottom-color: var(--typography-color-secondary-800);--prose-thead-border-color: var(--typography-color-secondary-600);--prose-hr-color: var(--typography-color-secondary-800);--prose-blockquote-border-color: var(--typography-color-secondary-700);--prose-blockquote-color: var(--typography-color-secondary-400);--prose-a-code-background-hover: var(--typography-color-primary-900);--prose-a-code-border-color-hover: var(--typography-color-primary-600);--prose-a-code-border-color-static: var(--typography-color-secondary-600);--prose-a-color-hover: var(--typography-color-primary-400); } }@media (min-width: 640px) { :root {--pinceau-mq: sm; --docus-search-results-window-maxHeight: 320px;--docus-search-results-window-marginTop: 20vh;--docus-footer-height: 100px;--docus-search-results-window-borderRadius: var(--radii-xs);--docus-search-results-window-marginX: var(--space-4);--docus-header-logo-height: var(--space-7); } }</style><script>"use strict";(()=>{const a=window,e=document.documentElement,m=["dark","light"],c=window&&window.localStorage&&window.localStorage.getItem&&window.localStorage.getItem("nuxt-color-mode")||"system";let n=c==="system"?d():c;const l=e.getAttribute("data-color-mode-forced");l&&(n=l),i(n),a["__NUXT_COLOR_MODE__"]={preference:c,value:n,getColorScheme:d,addColorScheme:i,removeColorScheme:f};function i(o){const t=""+o+"",s="theme";e.classList?e.classList.add(t):e.className+=" "+t,s&&e.setAttribute("data-"+s,o)}function f(o){const t=""+o+"",s="theme";e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp(t,"g"),""),s&&e.removeAttribute("data-"+s)}function r(o){return a.matchMedia("(prefers-color-scheme"+o+")")}function d(){if(a.matchMedia&&r("").media!=="not all"){for(const o of m)if(r(":"+o).matches)return o}return"light"}})();
</script></head>
<body ><!----><!--teleport anchor--><!----><!--teleport anchor--><div id="__nuxt"><div class="app-layout" data-v-5c2f7786><div class="nuxt-progress" style="width:0%;opacity:0;background-size:Infinity% auto;" data-v-5c2f7786></div><header class="has-dialog" data-v-5c2f7786 data-v-069d8056><div class="container pv-mhGOP5 pc-M3JUDE" data-v-069d8056 data-v-a8d7e2a7><!--[--><div class="section left" data-v-069d8056><!--[--><button aria-label="Menu" data-v-6c45508f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" role="img" class="icon" data-v-6c45508f style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><!--teleport start--><!--teleport end--><!--]--><a href="/code-study/" class="navbar-logo" aria-label="摳Sense讀書會筆記" data-v-069d8056 data-v-f83b7764><span class="title" data-v-f83b7764>摳Sense讀書會筆記</span></a></div><div class="section center" data-v-069d8056><a href="/code-study/" class="navbar-logo" aria-label="摳Sense讀書會筆記" data-v-069d8056 data-v-f83b7764><span class="title" data-v-f83b7764>摳Sense讀書會筆記</span></a><!----></div><div class="section right" data-v-069d8056><!--[--><button type="button" aria-label="Search" data-v-98e4ee4b><span class="content" data-v-98e4ee4b><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-98e4ee4b style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21l-6-6m2-5a7 7 0 1 1-14 0a7 7 0 0 1 14 0"/></svg><span data-v-98e4ee4b>Search</span><span data-v-98e4ee4b><kbd data-v-98e4ee4b>⌘</kbd><kbd data-v-98e4ee4b>K</kbd></span></span></button><!--teleport start--><!--teleport end--><!--]--><div class="social-icons" data-v-069d8056><a href="/code-study/member" class="" rel="noopener noreferrer" title="member" data-v-069d8056 data-v-959a58fc><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-959a58fc style="" width="1em" height="1em" viewBox="0 0 1200 1200" data-v-e610b8e3><path fill="currentColor" d="M596.847 188.488c-103.344 0-187.12 97.81-187.12 218.465c0 83.678 40.296 156.352 99.468 193.047l-68.617 31.801l-182.599 84.688c-17.64 8.821-26.444 23.778-26.444 44.947v201.102c1.451 25.143 16.537 48.577 40.996 48.974h649.62c27.924-2.428 42.05-24.92 42.325-48.974V761.436c0-21.169-8.804-36.126-26.443-44.947l-175.988-84.688l-73.138-34.65c56.744-37.521 95.061-108.624 95.061-190.197c-.001-120.656-83.778-218.466-187.121-218.466m-301.824 76.824c-44.473 1.689-79.719 20.933-106.497 51.596c-29.62 36.918-44.06 80.75-44.339 124.354c1.819 64.478 30.669 125.518 82.029 157.446L21.163 693.997C7.05 699.289 0 711.636 0 731.041v161.398c1.102 21.405 12.216 39.395 33.055 39.703h136.284V761.436c2.255-45.639 23.687-82.529 62.196-100.531l136.247-64.817c10.584-6.175 20.731-14.568 30.433-25.152c-56.176-86.676-63.977-190.491-27.773-281.801c-23.547-14.411-50.01-23.672-75.419-23.823m608.586 0c-29.083.609-55.96 11.319-78.039 26.444c35.217 92.137 25.503 196.016-26.482 276.52c11.467 13.23 23.404 23.377 35.753 30.434l130.965 62.195c39.897 21.881 60.47 59.098 60.866 100.532v170.707h140.235c23.063-1.991 32.893-20.387 33.093-39.704V731.042c0-17.641-7.05-29.987-21.163-37.045l-202.431-96.618c52.498-38.708 78.859-96.72 79.369-156.117c-1.396-47.012-15.757-90.664-44.339-124.354c-29.866-32.399-66.91-51.253-107.827-51.596"/></svg></a><a href="https://github.com/codesensegroup/code-study" rel="noopener noreferrer" target="_blank" title="github" data-v-069d8056 data-v-a02d16b5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-a02d16b5 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></a></div><button aria-label="Color Mode" data-v-069d8056 data-v-87324333><span data-v-87324333>...</span></button></div><!--]--></div></header><main data-v-5c2f7786><!--[--><div class="document-driven-page"><div class="container pv-mhGOP5 pc-yz1mHl docs-page-content fluid has-toc has-aside" data-v-03c0998f data-v-a8d7e2a7><!--[--><aside class="aside-nav" data-v-03c0998f><nav class="app-aside" data-v-03c0998f data-v-3d9a5d42><ul class="docs-aside-tree" data-v-3d9a5d42 data-v-d42239fd><!--[--><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📖</span><span data-v-d42239fd>System Design Interview: An Insider’s Guide</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>01 從 0 到百萬用戶</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter4" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>設計網路限速器</span></span></a><!----></li><li class="has-parent-icon bordered active" data-v-d42239fd><a aria-current="page" href="/code-study/sdi-aig/chapter6" class="router-link-active router-link-exact-active link padded active" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>設計鍵值儲存系統</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📘</span><span data-v-d42239fd>Clean Architecture - 無瑕的程式碼</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>01 什麼是設計與結構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter2" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>02 兩種價值觀的故事</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter3" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>03 範式概述</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter4" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>04 結構化程式設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>05 物件導向程式設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter6" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>06 函數式程式設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter12" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>12 元件</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter13" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>13 元件內聚性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter14" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>14 元件耦合性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter15" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>15 什麼是架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter16" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>16 獨立性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter18" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>18 邊界剖析</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter19" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>19 POLICY AND LEVEL 策略與層次</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter20" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>20 BUSINESS RULES 業務邏輯</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter21" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>21 會尖叫的架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter22" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>22 整潔的架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter23" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>23 Presenter與Humble Object</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter24" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>24 不完全邊界</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter25" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>25 層與邊界</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter30" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>30 資料庫細節</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter31" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>31 WEB是細節</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter32" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>32 框架也只是細節</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter33" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>33 影片銷售系統案例研究</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter34" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Clean Architecture 第34章：The Missing Chapter</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter99" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>99 來自於網路世界的書評</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📕</span><span data-v-d42239fd>資料密集型應用系統設計</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>01 可靠性、可伸縮性和可維護性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter3" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>03 數據儲存與檢索</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter4" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>04 編碼與演化</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>05 複製</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter9" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>09 一致性與共識</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>🏷️</span><span data-v-d42239fd>持續交付2.0：實務導向的DevOps</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>05 持續交付的軟體系統架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter7" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>07 部署流水線原則與工具設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter8" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>08 利於集成的分支策略</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter9" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>09 持續整合</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter10" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>10 自動化測試策略與方法</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter11" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>11 軟件配置管理</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter12" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>12 低風險發佈</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter13" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>13 監測與決策</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter16" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>16 研發推動的DevOps</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📗</span><span data-v-d42239fd>Web API的設計與開發</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/web-api/chapter2" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>第2章 EndPoint設計與請求形式</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/web-api/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>第5章 開發方便更改設計的API</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/web-api/chapter6" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>第6章 開發牢固的WebAPI</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>⚒️</span><span data-v-d42239fd>技術分享</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/gitlab-cicd" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>使用Gitlab做CI/CD</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/grpc" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>gRPC快速入門</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/liquibase" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Liquibase快速入門</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/redis-ring" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Redis Ring</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/redis" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Redis快速入門</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/tdd_part1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>TDD技術分享 - Part1 灌輸</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>🛡️</span><span data-v-d42239fd>API</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/api/components" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Components</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/api/composables" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Composables</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/api/layouts" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Layouts</span></span></a><!----></li><!--]--></ul></li><!--]--></ul></nav></aside><article class="page-body" data-v-03c0998f><div class="flex flex-col" data-v-03c0998f><!----><div class="my-1"><span class="text-xs md:text-sm"> 字數總計：0 個 </span><span class="mx-1">|</span><span class="text-xs md:text-sm"> 閱讀時長：0 分鐘 </span><span class="mx-1">|</span><span class="text-xs md:text-sm" id="busuanzi_container_page_pv"><span>閱讀次數：</span><span id="busuanzi_value_page_pv"></span> 次 </span></div><div class="mt-1 z-10"><!--[--><!--]--></div></div><!--[--><!--[--><div><p data-v-9dc9c102><!--[-->ref: <a href="https://github.com/Admol/SystemDesign/blob/main/CHAPTER%2006%EF%BC%9ADESIGN%20A%20KEY-VALUE%20STORE.md" rel="nofollow" data-v-692834dd><!--[-->CHAPTER 06：DESIGN A KEY-VALUE STORE.md<!--]--></a><!--]--></p><hr data-v-89dedb08><p data-v-9dc9c102><!--[-->ref: <a href="https://tw.annas-archive.org/md5/e89be9442169fe8f89a2fda597797668" rel="nofollow" data-v-692834dd><!--[-->https://tw.annas-archive.org/md5/e89be9442169fe8f89a2fda597797668<!--]--></a><!--]--></p><p data-v-9dc9c102><!--[-->ref: <a href="https://www.youtube.com/watch?v=8TE2DvpKxvA" rel="nofollow" data-v-692834dd><!--[-->https://www.youtube.com/watch?v=8TE2DvpKxvA<!--]--></a><!--]--></p><p data-v-9dc9c102><!--[-->ref: <a href="https://youtu.be/o6q8zPmfVLU?si=M7Y-FWqM-tuORxn7" rel="nofollow" data-v-692834dd><!--[-->https://youtu.be/o6q8zPmfVLU?si=M7Y-FWqM-tuORxn7<!--]--></a><!--]--></p><hr data-v-89dedb08><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->以 C# /.NET 8 與 MSSQL 為主要範例語言／平台，分 2 – 3 次（每次 40‑50 分鐘）循序漸進講解本章重點，並輔以可執行的程式碼片段與示意圖。<!--]--></p><!--]--></blockquote><h2 id="整體章節重點-birdeye-view" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#整體章節重點-birdeye-view" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->整體章節重點 (Bird‑Eye View)<!--]--><!----></a></h2><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Key‑Value Store 基礎<!--]--></strong>：資料模型、操作介面 (<code class="" data-v-2f6bd69d><!--[-->put<!--]--></code> / <code class="" data-v-2f6bd69d><!--[-->get<!--]--></code>)。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->擴充挑戰<!--]--></strong>：從單機記憶體雜湊表 → 分散式雜湊表 (DHT)。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->CAP 與一致性<!--]--></strong>：AP / CP 系統選擇、N / W / R 仲裁參數。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料分區與複本<!--]--></strong>：一致性雜湊、跨資料中心複寫。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->衝突處理<!--]--></strong>：Vector Clock、最終一致性。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->容錯機制<!--]--></strong>：Gossip 偵錯、Sloppy Quorum、Hinted Handoff、Anti‑Entropy &amp; Merkle Tree。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->讀寫流程<!--]--></strong>：Commit Log → MemTable → SSTable；MemTable / Bloom Filter 多層快取。<!--]--></li><!--]--></ol><h2 id="本章要求" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#本章要求" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->本章要求<!--]--><!----></a></h2><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->設計出一個可支援以下操作的鍵值儲存系統：<!--]--></li><!--]--></ul><div class="highlight-c# prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-c# shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">  -</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> put</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(key, value) </span><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// 插入一組與「key」鍵相關聯的「vlaue」值
</span></span><span class="line" line="2"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">  -</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> get</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(key) </span><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// 取出與「key」鍵相關聯的「vlaue」值
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->瞭解問題並確立設計的範圍<blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->天底下沒有完美的設計。<br>
每一種設計都必須在記憶體讀取、寫入與使用方面進行取捨，以達到某種特定的平衡。<br>
在一致性與可用性之間，也需要進行權衡取捨。<br><!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->設計的範圍設定：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->鍵值對的尺寸很小，小於 10 KB。<!--]--></li><li data-v-4c2f5fb9><!--[-->有能力儲存大數據資料。<!--]--></li><li data-v-4c2f5fb9><!--[-->高可用性：即使發生故障，系統也可以快速回應。<!--]--></li><li data-v-4c2f5fb9><!--[-->高擴展性：系統可進行擴展，以支援大型資料集。<!--]--></li><li data-v-4c2f5fb9><!--[-->自動擴展：應該可以根據流量，自動添加/移除伺服器。<!--]--></li><li data-v-4c2f5fb9><!--[-->可調整系統一致性的程度。<!--]--></li><li data-v-4c2f5fb9><!--[-->低延遲。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><hr data-v-89dedb08><h2 id="session1-從零開始認識-keyvalue-store" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#session1-從零開始認識-keyvalue-store" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->Session 1 ： 從零開始認識 Key‑Value Store<!--]--><!----></a></h2><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->鍵值資料庫（Key-Value Store，也稱鍵值存儲）是一種<strong data-v-84b57b07><!--[-->非關聯式資料庫<!--]--></strong>，以 <strong data-v-84b57b07><!--[-->「鍵-值對」<!--]--></strong> 形式儲存資料。<!--]--></li><li data-v-4c2f5fb9><!--[-->每筆資料由 <strong data-v-84b57b07><!--[-->唯一的鍵（key）<!--]--></strong> 識別並對應一個 <strong data-v-84b57b07><!--[-->值（value）<!--]--></strong>，類似 Dictionary 或 Hash Table 的概念。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->鍵：<!--]--></strong> 通常為短字串或其雜湊，須具唯一性以快速索引；<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->值：<!--]--></strong> 可以是任意類型的二進位資料，系統通常將值視為不透明的blob（例如 Redis、Memcached 即採用此模型）。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->主流產品 (Redis、DynamoDB…)<!--]--></strong><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/table-6-1.png" alt="alt text" data-v-2ef15301><!--]--></p><hr data-v-89dedb08><h2 id="session2-單機設計-vs-分散式挑戰" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#session2-單機設計-vs-分散式挑戰" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->Session 2 ： 單機設計 v.s. 分散式挑戰<!--]--><!----></a></h2><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->雜湊表 + 壓縮 + 冷資料落盤<!--]--></li><li data-v-4c2f5fb9><!--[-->何時需要走向分散式 → 大容量、高可用<!--]--></li><!--]--></ul><h2 id="_1-單一伺服器的鍵值儲存系統" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#_1-單一伺服器的鍵值儲存系統" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->(1) 單一伺服器的鍵值儲存系統：<!--]--><!----></a></h2><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->簡單實作：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->最直接的做法就是把「鍵值對」全部放到記憶體。<!--]--></li><li data-v-4c2f5fb9><!--[-->雜湊表（Hash Table） 在記憶體中保存所有鍵值對。<!--]--></li><li data-v-4c2f5fb9><!--[-->基本操作包括 put(key, value)（寫入/更新鍵的值）與 get(key)（讀取鍵的值）。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料結構：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->使用如 C# 的 Dictionary&lt;string, string&gt; 即可達成 O(1) 的鍵查詢時間。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->記憶體 vs 磁碟：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->若資料量可能超過記憶體，可透過LRU快取策略將常用資料留在記憶體，不常用資料寫入磁碟檔案；<!--]--></li><li data-v-4c2f5fb9><!--[-->也可採用資料壓縮減少空間。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->容量侷限：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->即使有上述優化，單台伺服器的記憶體與磁碟總有上限，大規模資料最終會超出單機容量。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->此時需要水平擴充（scale out）至分散式鍵值存儲架構。<!--]--></strong><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><br><h2 id="_2-分散式鍵值儲存系統" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#_2-分散式鍵值儲存系統" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->(2) 分散式鍵值儲存系統：<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->分散式鍵值存儲（Distributed Key-Value Store）又稱分散式雜湊表（DHT），透過多部伺服器共同存放整體資料集。<br>
設計分散式系統時，理解 CAP 定理 極其重要。<br><!--]--></p><!--]--></blockquote><h4 id="cap-定理簡介" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#cap-定理簡介" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[-->CAP 定理簡介<!--]--><!----></a></h4><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->CAP 定理，又稱 Brewer 定理，由 Eric Brewer 於 2000 年提出，2002 年經 Seth Gilbert 與 Nancy Lynch 形式化證明。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->定理指出：在一個分散式資料存儲系統中，只能在以下三者中最多同時滿足兩項，無法兼得三者。<!--]--></strong> (<a href="https://cloud.tencent.com/developer/article/2355483" rel="nofollow" title="CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云" data-v-692834dd><!--[-->腾讯云<!--]--></a>)
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->一致性 ( Consistency )、<!--]--></li><li data-v-4c2f5fb9><!--[-->可用性 ( Availability )、<!--]--></li><li data-v-4c2f5fb9><!--[-->分區容錯性 ( Partition Tolerance )<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><h5 id="三大屬性定義" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#三大屬性定義" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->三大屬性定義<!--]--><!----></a></h5><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->一致性 ( Consistency, C )：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->保證每次讀取都能拿到最新的寫入值，或者返回錯誤，<!--]--></li><li data-v-4c2f5fb9><!--[-->也就是「所有節點在同一時間看到相同資料」的強一致性承諾。(<a href="https://cloud.tencent.com/developer/article/2355483" rel="nofollow" title="CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云" data-v-692834dd><!--[-->腾讯云<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->可用性 ( Availability, A )：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->系統對每次請求都能在有限時間內做出響應（非錯誤或超時）。<!--]--></li><li data-v-4c2f5fb9><!--[-->即便部分節點失效，健康節點依然對外提供服務。(<a href="https://cloud.tencent.com/developer/article/2355483" rel="nofollow" title="CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云" data-v-692834dd><!--[-->腾讯云<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->分區容錯性 ( Partition Tolerance, P )：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->當系統節點間發生網路分區（訊息丟失或延遲）時，仍能繼續對外提供服務。<!--]--></li><li data-v-4c2f5fb9><!--[-->由於大規模分散式系統中網路分區幾乎不可避免，P 通常被視為必須保障的屬性。(<a href="https://cloud.tencent.com/developer/article/2355483" rel="nofollow" title="CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云" data-v-692834dd><!--[-->腾讯云<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><h5 id="屬性兩兩組合與典型示例" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#屬性兩兩組合與典型示例" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->屬性兩兩組合與典型示例<!--]--><!----></a></h5><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-1.png" alt="alt text" data-v-2ef15301><!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->CA（一致性 + 可用性，放棄 P）<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->適用於無須考慮網路分區容錯的場景，<!--]--></li><li data-v-4c2f5fb9><!--[-->例如：<strong data-v-84b57b07><!--[-->單機或單資料中心部署<!--]--></strong>的關係型資料庫系統（如 SQL Server 等）。(<a href="https://en.wikipedia.org/wiki/CAP_theorem?utm_source=chatgpt.com" rel="nofollow" title="CAP theorem - Wikipedia" data-v-692834dd><!--[-->維基百科<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->CP（一致性 + 分區容錯，放棄 A）<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在發生分區容錯時<strong data-v-84b57b07><!--[-->優先保證強一致性，犧牲可用性。<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->例如：MongoDB，在分區容錯期間會<strong data-v-84b57b07><!--[-->拒絕服務以確保一致性。<!--]--></strong>(<a href="https://stackoverflow.com/questions/11292215/where-does-mongodb-stand-in-the-cap-theorem?utm_source=chatgpt.com" rel="nofollow" title="Where does MongoDB stand in the CAP theorem? - Stack Overflow" data-v-692834dd><!--[-->Stack Overflow<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->AP（可用性 + 分區容錯，放棄 C）<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在發生分區容錯時<strong data-v-84b57b07><!--[-->優先保證可用性<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->允許短暫不一致，並透過最終一致性（Reconciliation）進行修復。<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->例如：Apache Cassandra，即使分區容錯期間也繼續響應請求，<strong data-v-84b57b07><!--[-->可能讀到舊值。<!--]--></strong> (<a href="https://stackoverflow.com/questions/20205797/which-part-of-the-cap-theorem-does-cassandra-sacrifice-and-why?utm_source=chatgpt.com" rel="nofollow" title="partitioning - Which part of the CAP theorem does Cassandra sacrifice and why? - Stack Overflow" data-v-692834dd><!--[-->Stack Overflow<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><h5 id="理想情況" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#理想情況" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->理想情況<!--]--><!----></a></h5><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-2.png" alt="alt text" data-v-2ef15301>
在理想情況下，永遠不會發生網路分區容錯的問題：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->寫入 n1 的資料自動就會複製到 n2、n3。<!--]--></li><li data-v-4c2f5fb9><!--[-->如此可達到一致性與可用性。<!--]--></li><!--]--></ul><br><h5 id="現實世界的分散式系統" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#現實世界的分散式系統" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->現實世界的分散式系統<!--]--><!----></a></h5><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-3.png" alt="alt text" data-v-2ef15301>
在真實環境中，網路分區容錯的發生是不可避免的：<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->節點 <strong data-v-84b57b07><!--[-->n3<!--]--></strong> 因故離線，無法與 <strong data-v-84b57b07><!--[-->n1<!--]--></strong>、<strong data-v-84b57b07><!--[-->n2<!--]--></strong> 溝通；<!--]--></li><li data-v-4c2f5fb9><!--[-->若客戶端將資料寫入 <strong data-v-84b57b07><!--[-->n1<!--]--></strong>／<strong data-v-84b57b07><!--[-->n2<!--]--></strong>，則資料無法傳遞到 <strong data-v-84b57b07><!--[-->n3<!--]--></strong>；<!--]--></li><li data-v-4c2f5fb9><!--[-->若寫入 <strong data-v-84b57b07><!--[-->n3<!--]--></strong> 卻未傳至 <strong data-v-84b57b07><!--[-->n1<!--]--></strong>／<strong data-v-84b57b07><!--[-->n2<!--]--></strong>，則後者只能保有舊版資料。<!--]--></li><!--]--></ol><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->CP 系統（強一致性優先）<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->發生分區時，拒絕或延後對 <strong data-v-84b57b07><!--[-->n1<!--]--></strong>、<strong data-v-84b57b07><!--[-->n2<!--]--></strong> 的寫入，確保所有可用節點資料一致，犧牲可用性──<br>
銀行系統即屬此類，必須保證餘額一定為最新狀態。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->AP 系統（可用性優先）<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->分區期間仍接受讀寫，可能返回舊資料；待網路恢復後再同步至 <strong data-v-84b57b07><!--[-->n3<!--]--></strong>，最終達成一致。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><h5 id="設計取捨與面試要點-cap" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#設計取捨與面試要點-cap" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->設計取捨與面試要點 - CAP<!--]--><!----></a></h5><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->為何必須取捨？<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->分散式系統中網路分區（P）不可避免，<!--]--></li><li data-v-4c2f5fb9><!--[-->當發生分區時，系統無法同時保證既讀取最新值(C)、又對所有請求都做出響應(A)。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->必須在一致性與可用性間做出取捨。<!--]--></strong>(<a href="https://ruanyifeng.com/blog/2018/07/cap.html?utm_source=chatgpt.com" rel="nofollow" title="CAP 定理的含义 - 阮一峰的网络日志" data-v-692834dd><!--[-->ruanyifeng.com<!--]--></a>)<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->如何依場景選擇？<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->金融支付<!--]--></strong>：對資料一致性要求極高，常選 CP ，確保交易正確無誤。(<a href="https://www.ibm.com/think/topics/cap-theorem?utm_source=chatgpt.com" rel="nofollow" title="What is the CAP theorem? - IBM" data-v-692834dd><!--[-->IBM<!--]--></a>)<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->社交推薦、日誌收集<!--]--></strong>：對可用性和吞吐量要求優先，常選 AP 。(<a href="https://www.ibm.com/think/topics/cap-theorem?utm_source=chatgpt.com" rel="nofollow" title="What is the CAP theorem? - IBM" data-v-692834dd><!--[-->IBM<!--]--></a>)<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->內部管理系統<!--]--></strong>：網路分區風險較低，可選 CA 以簡化設計。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->面試常見考察點<!--]--></strong><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->正確認識 C/A/P 三者含義及差異。<!--]--></li><li data-v-4c2f5fb9><!--[-->針對不同業務場景，說明為何在 C/A/P 間做出具體取捨。<!--]--></li><li data-v-4c2f5fb9><!--[-->以具體系統（如 Key-Value 儲存）為例，闡述如何實現 CAP（Quorum、Hinted Handoff、Anti-Entropy 等機制）。<!--]--></li><!--]--></ol><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->透過以上整理，您可在系統設計面試中清晰闡述 CAP 定理，並結合業務需求給出合理架構選擇。<!--]--></p><br><hr data-v-89dedb08><h2 id="session3-鍵值儲存系統的構成元素" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#session3-鍵值儲存系統的構成元素" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->Session 3 ： 鍵值儲存系統的構成元素<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->我們打算在本節討論以下這些核心元素與技術，與建構出相應的鍵值儲存系統。 <br>
以下內容主要是以三個很受歡迎的鍵值儲存系統為基礎： Dynamo、Cassandra 與 BigTable<!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->資料分區 ( data partition )<!--]--></li><li data-v-4c2f5fb9><!--[-->資料複製 ( data replication )<!--]--></li><li data-v-4c2f5fb9><!--[-->一致性<!--]--></li><li data-v-4c2f5fb9><!--[-->不一致問題的解決方式<!--]--></li><li data-v-4c2f5fb9><!--[-->故障的處理方式<!--]--></li><li data-v-4c2f5fb9><!--[-->系統架構圖<!--]--></li><li data-v-4c2f5fb9><!--[-->寫入途徑<!--]--></li><li data-v-4c2f5fb9><!--[-->讀取途徑<!--]--></li><!--]--></ul><h2 id="資料分區一致性雜湊與水平擴充" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#資料分區一致性雜湊與水平擴充" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->資料分區：一致性雜湊與水平擴充<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->當資料規模龐大時，將全部鍵值對存於單一節點(伺服器)，是一種不可行的做法。<!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料分區（data partition）：<!--]--></strong> 將資料拆分到多個節點(伺服器)存放。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料分區面臨兩大挑戰：<!--]--></strong><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料均勻分布：<!--]--></strong> 確保各節點負載均衡，避免有的節點存了過多資料、成為瓶頸。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->動態伸縮：<!--]--></strong> 節點數量增加或減少時，儘量減少資料在節點間搬移的成本。<!--]--></li><!--]--></ol><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->為解決上述問題<!--]--></strong><br><strong data-v-84b57b07><!--[-->一致性雜湊（Consistent Hashing）是一種經典技術。<!--]--></strong><br><strong data-v-84b57b07><!--[-->一致性雜湊：將整個雜湊值空間組織成一個雜湊環（Hash Ring）然後將節點和資料鍵都映射到此環上。<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-4.png" alt="alt text" data-v-2ef15301><!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->首先，伺服器會被放到雜湊環上。在圖 6-4 中， s0、s1、....、s7 所代表的8部伺服器全都被放到雜湊環上。<!--]--></li><li data-v-4c2f5fb9><!--[-->接著，有一個鍵也進行了雜湊運算，而被放到了同一個雜湊環上。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->存放規則：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->從資料鍵映射點 <strong data-v-84b57b07><!--[-->順時針<!--]--></strong> 遇到的第一個節點，即為此鍵的負責節點。<!--]--></li><li data-v-4c2f5fb9><!--[-->key0 運用存放規則的邏輯，最後保存到 s1 之中。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->一致性雜湊的優點：<!--]--></strong><!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->自動水平擴充：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->可平滑地新增/移除節點而無需重新分配全部鍵。<!--]--></li><li data-v-4c2f5fb9><!--[-->加入節點，只需重新分配<strong data-v-84b57b07><!--[-->鄰近區域<!--]--></strong>的一部分鍵；<!--]--></li><li data-v-4c2f5fb9><!--[-->移除節點，其負載自動攤分給鄰近節點。這滿足動態擴縮需求。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->最小資料搬移：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->新增或移除節點時，只需移動環上極少量鍵，不影響其它區段的資料。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->負載均衡 ( 可因應 不均勻性/異質性 的問題 )：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->結合<strong data-v-84b57b07><!--[-->虛擬節點<!--]--></strong>機制，能讓節點根據性能配置不同數量的虛擬節點，避免因節點性能差異導致負載不均（容量越大的節點可在環上放置更多虛擬節點，獲取較大區間的鍵）。<!--]--></li><li data-v-4c2f5fb9><!--[-->例： 如果某個伺服器的容量比較大，只要指定比較多的虛擬節點給它就可以了。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><br><h2 id="資料複製高可用性的基石" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#資料複製高可用性的基石" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->資料複製：高可用性的基石<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->為了達到高可用性與可靠性 ( relibility )<!--]--></p><!--]--></blockquote><p data-v-9dc9c102><!--[-->為提升系統<strong data-v-84b57b07><!--[-->容錯性<!--]--></strong>與<strong data-v-84b57b07><!--[-->高可用性<!--]--></strong>，分散式鍵值存儲通常將資料 <strong data-v-84b57b07><!--[-->複製（Replication）<!--]--></strong> 至多個節點。<!--]--></p><p data-v-9dc9c102><!--[-->也就是對每個鍵值對保存多份拷貝，放置於<strong data-v-84b57b07><!--[-->不同節點<!--]--></strong>，當部分節點故障時仍能由其他副本提供服務。<!--]--></p><p data-v-9dc9c102><!--[-->常用的複製策略如下： <strong data-v-84b57b07><!--[-->key0 會被複製到 s1 、 s2 、 s3 ( N=3 )<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-5.png" alt="alt text" data-v-2ef15301><!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->複製因子 N：就是儲存 N 份<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->每筆資料儲存 N 份（包含原始1份+ N-1份副本）<!--]--></li><li data-v-4c2f5fb9><!--[-->例如： N=3，此時系統至少需有 N 個節點才能容納所有副本。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->副本選擇：必須確保節點不重複<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Key0 先按上述一致性雜湊的方式找到<strong data-v-84b57b07><!--[-->主存節點<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->再沿雜湊環<strong data-v-84b57b07><!--[-->順時針方向選擇接續的 N-1 個<!--]--></strong>獨立節點作為副本存放處。
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->例如 N=3 時，<!--]--></li><li data-v-4c2f5fb9><!--[-->key0 可存於 s1（主）以及後續的 s2、s3 節點上，共三副本。<!--]--></li><li data-v-4c2f5fb9><!--[-->若遇到<strong data-v-84b57b07><!--[-->虛擬節點映射同一實體節點的情況，則跳過重複實體以確保副本分散在不同實體節點。<!--]--></strong><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->跨機房分佈：提高可靠性<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->為防同機房故障導致副本同時損失，通常會將 N 個副本分布在<strong data-v-84b57b07><!--[-->多個資料中心<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->例如：3個副本可放在三個不同機房，透過高速網路互聯同步。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->透過適當的複製策略，可以實現讀取的高可用：<!--]--></p><p data-v-9dc9c102><!--[-->即使一兩個節點故障，資料的其他副本仍可提供服務。同時多副本也提高了資料耐久性（不易因單點損毀而永久丟失）。<!--]--></p><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->註：<!--]--></strong> 複製帶來<strong data-v-84b57b07><!--[-->一致性維護<!--]--></strong>的挑戰 —— 當多個副本存在時，如何確保各副本的值一致，是後續「一致性」與「衝突解決」部分要解決的問題。<!--]--></p><!--]--></blockquote><br><h2 id="一致性quorum-機制與最終一致性" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#一致性quorum-機制與最終一致性" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->一致性：Quorum 機制與最終一致性<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->如果沒有額外措施，不同副本可能出現數據不一致（如有的收到更新，有的因網路問題未收到）。<!--]--></p><!--]--></blockquote><p data-v-9dc9c102><!--[-->如前所述，將資料複製到多個節點可以提高可用性，但也帶來<strong data-v-84b57b07><!--[-->副本間數據同步<!--]--></strong>的難題。<!--]--></p><p data-v-9dc9c102><!--[-->為管理一致性，可採用 <strong data-v-84b57b07><!--[-->Quorum 共識機制<!--]--></strong>調節讀寫操作：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->定義：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->N：<!--]--></strong> 副本的數量 ( 如下圖 6-6，N=3 )。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W：<!--]--></strong> 寫入的最低門檻，寫入操作必須至少有 W 個副本回應確認，才視為寫入成功。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->R：<!--]--></strong> 讀取的最低門檻，讀取操作必須等待至少有 R 個副本回應，才視為讀取成功。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->運作：<!--]--></strong> 以圖 6-6 為例 N=3 資料被製到 s0、s1、s2。<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->協調者 ( coordinator ) ：<!--]--></strong> 代表客戶端與節點之間代理者 ( proxy ) 的角色。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W=1：<!--]--></strong> 每次<strong data-v-84b57b07><!--[-->寫入<!--]--></strong>，協調者<strong data-v-84b57b07><!--[-->必須至少收到一個 ACK 確認<!--]--></strong>，才能回覆客戶端成功。<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->不代表資料只寫入<strong data-v-84b57b07><!--[-->1個節點<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->如果從 s1 收到了確認，就不需要再等待 s0 與 s2 的確認了。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W=2：<!--]--></strong> 每次<strong data-v-84b57b07><!--[-->寫入<!--]--></strong>，協調者<strong data-v-84b57b07><!--[-->必須至少收到二個 ACK 確認<!--]--></strong>，才能回覆客戶端成功。<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果從 s1 收到了確認，要再等待 s0 或 s2 的確認。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->R=2：<!--]--></strong> 每次<strong data-v-84b57b07><!--[-->讀取<!--]--></strong>，協調者<strong data-v-84b57b07><!--[-->會並行查詢至少2個副本，並等待回應，最後取其中最新版本後再返回<!--]--></strong>，才能回覆客戶端成功。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-6.png" alt="alt text" data-v-2ef15301><!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->延遲 vs 一致性：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->W、R 的選擇代表延遲與一致性的權衡。<!--]--></li><li data-v-4c2f5fb9><!--[-->W或R越小：操作響應越快，但返回舊數據的風險增大。<!--]--></li><li data-v-4c2f5fb9><!--[-->W或R越大：數據一致性越好，但需等待更多節點，延遲提高。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->強一致性保證的條件：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W=N + R=1 ：<!--]--></strong> 就表示系統針對快速<strong data-v-84b57b07><!--[-->讀取<!--]--></strong>進行最佳化。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W=1 + R=N ：<!--]--></strong> 就表示系統針對快速<strong data-v-84b57b07><!--[-->寫入<!--]--></strong>進行最佳化。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W + R &gt; N ：<!--]--></strong> 就可以<strong data-v-84b57b07><!--[-->具有強一致性<!--]--></strong>。因為任意一筆資料的讀寫集合會在至少一個共同副本相交，確保讀一定能讀到最新寫入。(例如 N=3，W=R=2)<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->W + R &lt;= N ：<!--]--></strong> 則<strong data-v-84b57b07><!--[-->不能保證<!--]--></strong>具有強一致性。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><h5 id="設計取捨與面試要點-一致性模型" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#設計取捨與面試要點-一致性模型" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->設計取捨與面試要點 - 一致性模型<!--]--><!----></a></h5><p data-v-9dc9c102><!--[-->在設計鍵值儲存系統時，一致性模型確實是一個需要考慮的重要因素。<!--]--></p><p data-v-9dc9c102><!--[-->一致性模型定義的是資料一致性程度，而實際上確實存在各式各樣不同的一致性模型：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->強一致性：<!--]--></strong> 任何讀取操作所送回的值，都對應到最新寫入資料項的結果。<strong data-v-84b57b07><!--[-->客戶端絕不會看到過時的資料。<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->弱一致性：<!--]--></strong> 後續的讀取操作有可能看到的並不是最新的值。<strong data-v-84b57b07><!--[-->客戶端可能不是最新的資料。<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->最終一致性 ( eventual consistency )：<!--]--></strong> <strong data-v-84b57b07><!--[-->弱一致性的殊殊形式<!--]--></strong>，只要給定足夠的時間，所有資料更新終究都會被傳遞，且所有副本都會是一致的。<strong data-v-84b57b07><!--[-->客戶端會現是等待最新資料的過程。<!--]--></strong><!--]--></li><!--]--></ul><br>
在我們設計的系統中，
<p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->為了高可用性<!--]--></strong>，預設採用 <strong data-v-84b57b07><!--[-->最終一致性 ( eventual consistency )<!--]--></strong> 模型，<!--]--></p><p data-v-9dc9c102><!--[-->即 AP 模式： <code class="" data-v-2f6bd69d><!--[-->允許在短暫時間內副本之間數據不一致，但保證最終（在沒有新的更新後經過足夠時間）所有副本趨於一致。<!--]--></code><!--]--></p><p data-v-9dc9c102><!--[-->這意味：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->系統在寫入時不強制所有副本立即同步成功即可返回成功（如採用 W &lt; N），因此短期內不同節點可能讀到<strong data-v-84b57b07><!--[-->舊值<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->系統在背景持續同步副本，或透過讀取修復機制，確保<strong data-v-84b57b07><!--[-->最終<!--]--></strong>各副本一致。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->最終一致性容忍暫時不一致<!--]--></strong>，換取故障情況下仍可接受讀/寫請求（提高可用性）。例如 Dynamo、Cassandra 即採此模型。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->然而，最終一致性模型下，不可避免會出現<strong data-v-84b57b07><!--[-->更新衝突<!--]--></strong>的問題：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->當網路分區或並發寫入發生時，不同節點可能各自接受了對同一鍵的不同更新，導致系統存在多個版本的值。接下來我們將介紹如何檢測與解決這些衝突。<!--]--></li><!--]--></ul><h2 id="不一致問題的解決方式版本控制-versioning-與向量時鐘-vector-clock" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#不一致問題的解決方式版本控制-versioning-與向量時鐘-vector-clock" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->複製：提高可用性，同時也導致副本間產生不一致的問題。<br>
因此，我們需要一個能夠偵測衝突與協調衝突的版本控制系統。<!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本控制：<!--]--></strong> 把每次的資料修改，全都視為資料的一個全新不可變版本。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->向量時鐘：<!--]--></strong> 解決兩個版本衝突此類問題的常用技術。<!--]--></li><!--]--></ul><br><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->版本衝突問題舉例：<!--]--></strong> 圖6-7 －＞ 圖6-8<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->有 2 個副本 n1 與 n2 具有相同 key=&quot;name&quot; 並且值相同為 &quot;john&quot; ，我們稱為原始值。 ( 圖 6-7 )
<img src="/code-study/images/sdi-aig/06/img-6-7.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><br><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->某刻 Client A 通過節點 n1 將 name 更新為值 &quot;johnSanFrancisco&quot;<!--]--></li><li data-v-4c2f5fb9><!--[-->同時 Client B 通過節點 n2 將 name 更新為值 &quot;johnNewYork&quot;<!--]--></li><li data-v-4c2f5fb9><!--[-->由於 A、B 幾乎<strong data-v-84b57b07><!--[-->同時寫入<!--]--></strong>，且<strong data-v-84b57b07><!--[-->寫入不同節點<!--]--></strong>。 2個副本各自被更新為<strong data-v-84b57b07><!--[-->不同值<!--]--></strong>。( 圖 6-8 )
<img src="/code-study/images/sdi-aig/06/img-6-8.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->產生衝突版本：<!--]--></strong><!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->key=&quot;name&quot; 產生兩個衝突值： v1（值=&quot;johnSanFrancisco&quot;）與 v2（值=&quot;johnNewYork&quot;）。<!--]--></li><li data-v-4c2f5fb9><!--[-->這種情況下，單靠時間戳無法明確判斷哪個版本為「最新」或「正確」，因為兩次寫入發生在不同節點且近乎同時。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->解決衝突版本：<!--]--></strong><!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本控制：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->定義：<!--]--></strong> 把每次的資料修改，全都視為資料的一個全新不可變版本。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->向量時鐘：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->為了解決<strong data-v-84b57b07><!--[-->誰覆蓋誰<!--]--></strong>的問題。<!--]--></li><li data-v-4c2f5fb9><!--[-->為每個資料項維護一個多維版本向量，用來判定版本間的先後或並行關係。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->定義：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->向量時鐘是<strong data-v-84b57b07><!--[-->與資料相關聯的一對資料<!--]--></strong>，其形式為 <em data-v-b3b2ffd9><!--[--><strong data-v-84b57b07><!--[--><span>節點(伺服器), 版本</span><!--]--></strong><!--]--></em>。<!--]--></li><li data-v-4c2f5fb9><!--[-->可用來檢查某個版本是否為<strong data-v-84b57b07><!--[-->最新版本<!--]--></strong>、是否為<strong data-v-84b57b07><!--[-->成功的版本<!--]--></strong>、或是否<strong data-v-84b57b07><!--[-->與其他版本衝突<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->如 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D<!--]--></code><!--]--></em> 的向量時鐘可能為 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D([S1, v1], [S2, v2], ... [Sn, vn])<!--]--></code><!--]--></em> 。<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->S1...Sn<!--]--></code><!--]--></em> 是參與此資料項更新的節點ID<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->v1...vn<!--]--></code><!--]--></em> 是該節點對此資料的更新次數。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->更新規則：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->每當資料 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D<!--]--></code><!--]--></em> 在某節點 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->Si<!--]--></code><!--]--></em> 發生寫入
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果向量時鐘中已存在 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->[Si, vi]<!--]--></code><!--]--></em> ，則將 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->vi<!--]--></code><!--]--></em> 加一（該節點對此資料的版本號+1）。<!--]--></li><li data-v-4c2f5fb9><!--[-->如果不存在 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->[Si, vi]<!--]--></code><!--]--></em>，則新增 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->[Si, 1]<!--]--></code><!--]--></em> 條目，表示該節點首次創建此資料版本。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本比較：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->將兩個版本的向量時鐘逐分量比較<!--]--></li><li data-v-4c2f5fb9><!--[-->如果 <strong data-v-84b57b07><!--[-->版本X<!--]--></strong> 的每個節點計數都 &lt;= <strong data-v-84b57b07><!--[-->版本Y<!--]--></strong> 的對應計數<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本X<!--]--></strong> <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D(［S0, 1］, [S1, 1])<!--]--></code><!--]--></em><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本Y<!--]--></strong> <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D(［S0, 1］, [S1, 2])<!--]--></code><!--]--></em><!--]--></li><li data-v-4c2f5fb9><!--[-->則 X 是 Y 的祖先版本（即 X 的所有更新都被 Y 包含，無衝突）。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[-->如果 <strong data-v-84b57b07><!--[-->版本X<!--]--></strong> 的某幾個節點計數比 <strong data-v-84b57b07><!--[-->版本Y<!--]--></strong> 的對應計數或大或小<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本X<!--]--></strong> <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D(［S0, 1］, [S1, 2])<!--]--></code><!--]--></em><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->版本Y<!--]--></strong> <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D(［S0, 2］, [S1, 1])<!--]--></code><!--]--></em><!--]--></li><li data-v-4c2f5fb9><!--[-->則 <strong data-v-84b57b07><!--[-->版本X<!--]--></strong> 與 <strong data-v-84b57b07><!--[-->版本Y<!--]--></strong> 發生<strong data-v-84b57b07><!--[-->並行衝突<!--]--></strong>（即各有部分更新彼此不包含）。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->目前的應用結論<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Amazon Dynamo 就成功在生產環境使用向量時鐘並未遇到不可控的時鐘膨脹問題。<!--]--></li><li data-v-4c2f5fb9><!--[-->向量時鐘仍是實用解決方案。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->向量時鐘的缺點<!--]--></strong><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->透過以上機制，向量時鐘可以<strong data-v-84b57b07><!--[-->避免隨意覆蓋<!--]--></strong>並發寫入造成的數據丟失，保留所有衝突版本供合併。值得注意的是，向量時鐘也有缺點：<!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->增加客戶端複雜度：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->需要客戶端（或應用層）實現衝突合併邏輯，對開發者提出更高要求。<!--]--></li><li data-v-4c2f5fb9><!--[-->一些系統（如 Cassandra）乾脆選擇更簡單的 <strong data-v-84b57b07><!--[-->最後寫入優先 (Last Write Wins)<!--]--></strong> 策略，以縮減實現複雜度，但代價是可能捨棄較新的並發更新。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->開銷隨節點數增加：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->向量時鐘裡 <strong data-v-84b57b07><!--[--><em data-v-b3b2ffd9><!--[--><span>server:version</span><!--]--></em><!--]--></strong>  這樣成對資料，其數量可能會<strong data-v-84b57b07><!--[-->快速成長<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->在大規模系統中，維護數十上百的節點版本向量<strong data-v-84b57b07><!--[-->會增加存儲和傳輸負擔<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->針對長度設定了一個<strong data-v-84b57b07><!--[-->門檻值<!--]--></strong>。超過限制長度，就會<strong data-v-84b57b07><!--[-->刪除掉最舊的成對資料<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->導致，無法正正確判斷前後代關系，造成重新協調效果不佳。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><br><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->舉例：<!--]--></strong>
向量時鐘是用 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D([S1, v1], [S2, v2], ... [Sn, vn])<!--]--></code><!--]--></em> 來表式。
<em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D<!--]--></code><!--]--></em>  ：是資料項
<em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->Sn<!--]--></code><!--]--></em> ：是伺服器編號<br><em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->vn<!--]--></code><!--]--></em> ：是版本計數器
如果把資料項 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->D<!--]--></code><!--]--></em> 寫入伺服器 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->Si<!--]--></code><!--]--></em> , 則系統就必須執行以下其中一個任務。
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果  <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->[Si,vi]<!--]--></code><!--]--></em> 存在， <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->vi<!--]--></code><!--]--></em> 就加 1。<!--]--></li><li data-v-4c2f5fb9><!--[-->否則的話，就建立一個新的項目 <em data-v-b3b2ffd9><!--[--><code class="" data-v-2f6bd69d><!--[-->[Si,1]<!--]--></code><!--]--></em> 。<!--]--></li><li data-v-4c2f5fb9><!--[-->透過向量時鐘，我們能<strong data-v-84b57b07><!--[-->檢測<!--]--></strong>衝突版本並進一步<strong data-v-84b57b07><!--[-->合併<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->以下用實際例子 ( 圖 6-9 ) 說明其工作流程：<strong data-v-84b57b07><!--[-->假設 N=3 節點 Sx, Sy, Sz<!--]--></strong><img src="/code-study/images/sdi-aig/06/img-6-9.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><em data-v-b3b2ffd9><!--[--><strong data-v-84b57b07><!--[-->這張流程圖示範整個向量時鐘（Vector Clock）在多節點環境下，如何追蹤版本、偵測衝突並最終合併的機制。<!--]--></strong><!--]--></em>*<!--]--></p><p data-v-9dc9c102><!--[--><em data-v-b3b2ffd9><!--[--><strong data-v-84b57b07><!--[-->具體來看：<!--]--></strong><!--]--></em><!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->D1 → D2<!--]--></code>：<!--]--></strong> 都是透過 <strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 來寫入<!--]--></strong>， <strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 的版本計數器從 1 增到 2<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code>：<!--]--></strong> 有一客戶端在 <strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->Sy<!--]--></code> 寫入<!--]--></strong>，繼承了 <code class="" data-v-2f6bd69d><!--[-->Sx:2<!--]--></code>，並在 <strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->Sy<!--]--></code> 新增 <code class="" data-v-2f6bd69d><!--[-->Sy:1<!--]--></code><!--]--></strong> ( 因為 <code class="" data-v-2f6bd69d><!--[-->Sy<!--]--></code> <strong data-v-84b57b07><!--[-->第一次處理<!--]--></strong> ) ，時鐘變成 <code class="" data-v-2f6bd69d><!--[-->(Sx:2, Sy:1)<!--]--></code> 。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code>：<!--]--></strong> 另一個客戶端<strong data-v-84b57b07><!--[-->同時在 <code class="" data-v-2f6bd69d><!--[-->Sz<!--]--></code> 上寫入<!--]--></strong>，同樣繼承 <code class="" data-v-2f6bd69d><!--[-->Sx:2<!--]--></code>，並新增 <code class="" data-v-2f6bd69d><!--[-->Sz:1<!--]--></code> ( 因為 <code class="" data-v-2f6bd69d><!--[-->Sz<!--]--></code> <strong data-v-84b57b07><!--[-->第一次處理<!--]--></strong> )，時鐘變成 <code class="" data-v-2f6bd69d><!--[-->(Sx:2, Sz:1)<!--]--></code> 。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->衝突偵測：<!--]--></strong> 因為 <code class="" data-v-2f6bd69d><!--[-->(Sx:2, Sy:1)<!--]--></code> 跟 <code class="" data-v-2f6bd69d><!--[-->(Sx:2, Sz:1)<!--]--></code> 彼此各有對方沒有的<strong data-v-84b57b07><!--[-->分量<!--]--></strong>，無法互相包含，所以被判定為衝突版本。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->D5<!--]--></code> 合併：<!--]--></strong> 在 <strong data-v-84b57b07><!--[-->應用層<!--]--></strong> 把 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code>、<code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 合併後，<strong data-v-84b57b07><!--[-->由 <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 再寫入一次<!--]--></strong>，<code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 的計數器再 +1（從 2 → 3）， 、合併後的時鐘為 <code class="" data-v-2f6bd69d><!--[-->(Sx:3, Sy:1, Sz:1)<!--]--></code> ，它就 <strong data-v-84b57b07><!--[-->包含了之前所有分量，因此成為唯一合法的後繼版本<!--]--></strong> 。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->「<strong data-v-84b57b07><!--[-->分量<!--]--></strong>」這個詞在這裡其實是從數學或向量概念延伸而來，指的是<strong data-v-84b57b07><!--[-->向量中每個維度上的值<!--]--></strong>，在向量時鐘（Vector Clock）中，這些「分量」就是<strong data-v-84b57b07><!--[-->每個節點的版本號<!--]--></strong>。<!--]--></p><blockquote data-v-96397147><!--[--><hr data-v-89dedb08><h3 id="為什麼叫分量" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#為什麼叫分量" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->🔍 為什麼叫「分量」？<!--]--><!----></a></h3><h4 id="數學背景" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#數學背景" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[-->數學背景：<!--]--><!----></a></h4><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->向量（Vector）是一組有方向和大小的數字集合，例如 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.28ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 4985.9 1000" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><path id="MJX-1-TEX-I-1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path><path id="MJX-1-TEX-N-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path><path id="MJX-1-TEX-N-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path><path id="MJX-1-TEX-N-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path><path id="MJX-1-TEX-N-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path><path id="MJX-1-TEX-N-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path id="MJX-1-TEX-N-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path><path id="MJX-1-TEX-N-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></defs><g stroke="currentColor" fill="currentColor" strokeWidth="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><use data-c="1D463" xlink:href="#MJX-1-TEX-I-1D463"></use></g><g data-mml-node="mo" transform="translate(762.8,0)"><use data-c="3D" xlink:href="#MJX-1-TEX-N-3D"></use></g><g data-mml-node="mo" transform="translate(1818.6,0)"><use data-c="28" xlink:href="#MJX-1-TEX-N-28"></use></g><g data-mml-node="mn" transform="translate(2207.6,0)"><use data-c="31" xlink:href="#MJX-1-TEX-N-31"></use></g><g data-mml-node="mo" transform="translate(2707.6,0)"><use data-c="2C" xlink:href="#MJX-1-TEX-N-2C"></use></g><g data-mml-node="mn" transform="translate(3152.2,0)"><use data-c="32" xlink:href="#MJX-1-TEX-N-32"></use></g><g data-mml-node="mo" transform="translate(3652.2,0)"><use data-c="2C" xlink:href="#MJX-1-TEX-N-2C"></use></g><g data-mml-node="mn" transform="translate(4096.9,0)"><use data-c="33" xlink:href="#MJX-1-TEX-N-33"></use></g><g data-mml-node="mo" transform="translate(4596.9,0)"><use data-c="29" xlink:href="#MJX-1-TEX-N-29"></use></g></g></g></svg></mjx-container>。<!--]--></li><li data-v-4c2f5fb9><!--[-->向量的每個數字（例如 1、2、3）就是這個向量在各個軸上的「分量」（components）。<!--]--></li><li data-v-4c2f5fb9><!--[-->中文中「分量」是 vector component 的翻譯。<!--]--></li><!--]--></ul><h4 id="在向量時鐘中的意義" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#在向量時鐘中的意義" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[-->在向量時鐘中的意義：<!--]--><!----></a></h4><p data-v-9dc9c102><!--[-->向量時鐘用一組 key-value 組來記錄每個節點的版本：<!--]--></p><div class="highlight-json prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-json shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{
</span></span><span class="line" line="2"><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"> &quot;Sx&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">2</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">,
</span></span><span class="line" line="3"><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"> &quot;Sy&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">1</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">,
</span></span><span class="line" line="4"><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"> &quot;Sz&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">0
</span></span><span class="line" line="5"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->這其實就是一個多維的向量，每個節點（如 Sx, Sy, Sz）對應一個「分量」：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Sx 的分量是 2<!--]--></li><li data-v-4c2f5fb9><!--[-->Sy 的分量是 1<!--]--></li><li data-v-4c2f5fb9><!--[-->Sz 的分量是 0<!--]--></li><!--]--></ul><hr data-v-89dedb08><h3 id="用分量的好處" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#用分量的好處" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->✅ 用「分量」的好處：<!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->可以用來比較兩個向量時鐘是否發生衝突<!--]--></li><li data-v-4c2f5fb9><!--[-->易於理解為「每個節點對這筆資料的貢獻度（或修改次數）」<!--]--></li><!--]--></ul><hr data-v-89dedb08><h3 id="總結" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#總結" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->📘 總結：<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->向量時鐘中的「分量」就是： <strong data-v-84b57b07><!--[-->每個節點在向量中對應的版本值<!--]--></strong>。<!--]--></p><p data-v-9dc9c102><!--[-->叫它「分量」是因為這種結構本身就是一個向量，這個詞也承襲了數學中向量各個維度的稱呼。這在資料庫、分散式系統、版&gt; 本控制等領域中是常見的術語。<!--]--></p><hr data-v-89dedb08><!--]--></blockquote><p data-v-9dc9c102><!--[--><em data-v-b3b2ffd9><!--[--><strong data-v-84b57b07><!--[-->詳細步驟說明：<!--]--></strong><!--]--></em><!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->初始寫入：<!--]--></strong> （ <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 第1次 寫入此鍵）
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->客戶端把資料項 <code class="" data-v-2f6bd69d><!--[-->D1<!--]--></code> 寫入系統，且這個寫入是由伺服器 <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 來處理。<!--]--></li><li data-v-4c2f5fb9><!--[-->因此，就有了向量時鐘為 <code class="" data-v-2f6bd69d><!--[-->D1([Sx, 1])<!--]--></code>。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->後續覆寫：<!--]--></strong> （ <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 第2次 更新此鍵，取代了舊版本）
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->另一客戶端讀取了最新的 <code class="" data-v-2f6bd69d><!--[-->D1<!--]--></code> ，並把它改為 <code class="" data-v-2f6bd69d><!--[-->D2<!--]--></code> ，仍然是由同一部伺服器 <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 進行寫入處理把資料寫回伺服器。<!--]--></li><li data-v-4c2f5fb9><!--[-->因此，<code class="" data-v-2f6bd69d><!--[-->D2<!--]--></code> 繼承自 <code class="" data-v-2f6bd69d><!--[-->D1<!--]--></code>，視為<strong data-v-84b57b07><!--[-->同一演進鏈<!--]--></strong>，故 <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 將其版本遞增為 <code class="" data-v-2f6bd69d><!--[-->D2([Sx, 2])<!--]--></code>。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->並行更新1：<!--]--></strong> （繼承了之前 <code class="" data-v-2f6bd69d><!--[-->Sx:2<!--]--></code> 的版本，<strong data-v-84b57b07><!--[-->並加入 <code class="" data-v-2f6bd69d><!--[-->Sy:1<!--]--></code><!--]--></strong> ）
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->第三個客戶端讀取最新 <code class="" data-v-2f6bd69d><!--[-->D2<!--]--></code>，更新為 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code>，<!--]--></li><li data-v-4c2f5fb9><!--[-->透過<strong data-v-84b57b07><!--[-->不同節點 <code class="" data-v-2f6bd69d><!--[-->Sy<!--]--></code><!--]--></strong> 寫入。<!--]--></li><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->Sy<!--]--></code> 不曾寫過該鍵，於是 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code> 的時鐘為 <code class="" data-v-2f6bd69d><!--[-->([Sx,2], [Sy,1])<!--]--></code>。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->並行更新2：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->第四個客戶端也<strong data-v-84b57b07><!--[-->讀取 <code class="" data-v-2f6bd69d><!--[-->D2<!--]--></code>（與步驟3並行）<!--]--></strong>，更新為 <code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code>，<!--]--></li><li data-v-4c2f5fb9><!--[-->透過<strong data-v-84b57b07><!--[-->另一節點 <code class="" data-v-2f6bd69d><!--[-->Sz<!--]--></code><!--]--></strong> 寫入。得到 <code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 的時鐘 <code class="" data-v-2f6bd69d><!--[-->([Sx,2], [Sz,1])<!--]--></code>。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->衝突產生：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->現在系統內存在 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code> 和 <code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 兩條<strong data-v-84b57b07><!--[-->平行分支<!--]--></strong>（皆從 D2 演化而來）。<!--]--></li><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code> 的時鐘 <code class="" data-v-2f6bd69d><!--[-->[Sx:2, Sy:1]<!--]--></code> 與<!--]--></li><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 的時鐘 <code class="" data-v-2f6bd69d><!--[-->[Sx:2, Sz:1]<!--]--></code> 互相無法比較誰包含誰（各自有對方沒有的分量），判斷為<strong data-v-84b57b07><!--[-->衝突版本<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->此時若有讀取請求，
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->系統會<strong data-v-84b57b07><!--[-->同時返回 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code> 和 <code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 兩個版本<!--]--></strong>給客戶端。<!--]--></li><li data-v-4c2f5fb9><!--[-->要求客戶端執行<strong data-v-84b57b07><!--[-->應用層合併<!--]--></strong>（例如將兩個購物車列表合併）後提交一個最<strong data-v-84b57b07><!--[-->終版本 <code class="" data-v-2f6bd69d><!--[-->D5([Sx,3], [Sy,1], [Sz,1])<!--]--></code><!--]--></strong>。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->衝突合併：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->客戶端解析衝突得到最終結果，再寫入系統（假設透過 <code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> ）。<!--]--></li><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->Sx<!--]--></code> 將合併版本 <code class="" data-v-2f6bd69d><!--[-->D5<!--]--></code> 的時鐘更新為 <code class="" data-v-2f6bd69d><!--[-->([Sx,3], [Sy,1], [Sz,1])<!--]--></code>。<!--]--></li><li data-v-4c2f5fb9><!--[-->因為 <code class="" data-v-2f6bd69d><!--[-->D5<!--]--></code> 包含了之前 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code>、<code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 的所有分量（ <code class="" data-v-2f6bd69d><!--[-->Sx:3 ≥2, Sy:1 ≥1, Sz:1 ≥1<!--]--></code> ），<!--]--></li><li data-v-4c2f5fb9><!--[-->因此 <code class="" data-v-2f6bd69d><!--[-->D5<!--]--></code> 被視為<strong data-v-84b57b07><!--[-->後繼版本<!--]--></strong>，舊的 <code class="" data-v-2f6bd69d><!--[-->D3<!--]--></code>、<code class="" data-v-2f6bd69d><!--[-->D4<!--]--></code> 可被標記為過時並最終刪除。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><br><h2 id="節點故障與容錯機制gossip-協議sloppy-quorum-與-hinted-handoff" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#節點故障與容錯機制gossip-協議sloppy-quorum-與-hinted-handoff" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->在大型分散式系統中，<strong data-v-84b57b07><!--[-->節點故障是常態而非例外<!--]--></strong>。
因此，我們需要<strong data-v-84b57b07><!--[-->機制<!--]--></strong>來<strong data-v-84b57b07><!--[-->偵測故障<!--]--></strong>以及在<strong data-v-84b57b07><!--[-->故障發生時維持系統的可用性<!--]--></strong>。
本節介紹兩類機制：<!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->故障偵測：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如何讓所有節點感知彼此的存活狀態，迅速發現節點宕機或網路隔離。
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在分散式系統中，如果某個伺服器說另一伺服器已故障，實際上這樣並不足以認為該伺服器確實已故障。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->原則：至少需要有兩個獨立來源提供相同資訊，我們才能把該伺服器標記為故障。<!--]--></strong><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->故障應對：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->當部分節點無法服務時，如何暫時接管其職責以及在其恢復後進行數據補償。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><h4 id="_1故障偵測-gossip-協議" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#_1故障偵測-gossip-協議" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[--><strong data-v-84b57b07><!--[-->（1）故障偵測 – Gossip 協議：<!--]--></strong><!--]--><!----></a></h4><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->傳統做法：<!--]--></strong> 是一個節點向全體其它節點定期發送心跳 <strong data-v-84b57b07><!--[-->（ all-to-all 心跳 ）<!--]--></strong>，但在節點很多時網絡開銷巨大。
<img src="/code-study/images/sdi-aig/06/img-6-10.png" alt="alt text" data-v-2ef15301><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->改進方案是 Gossip（八卦）協議，其特點類似社交場合的流言傳播：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->每個節點維護一份成員列表 ( <strong data-v-84b57b07><!--[-->去中心化<!--]--></strong> )<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->記錄集群中其他節點的 ID 及其心跳計數器等資訊。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[-->時鐘1：定時（例如每隔 w 秒），表示「我還活著」。<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->各節點獨立地每隔固定時間增加自己的心跳計數。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[-->時鐘2：定時（例如每隔 𝑡 秒），表示「刷存在感」。<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->每個節點從成員列表中隨機選擇幾個節點，<!--]--></li><li data-v-4c2f5fb9><!--[-->將自己的心跳資訊發送給接收者。
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->接收者：更新對應節點的心跳值，<!--]--></li><li data-v-4c2f5fb9><!--[-->接收者：繼續隨機節點轉發，類似病毒傳播地散播心跳消息。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->節點收到某成員的信息：<!--]--></strong> 會更新本地成員列表，確保彼此盡量最終收斂到一致的最新成員狀態。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->判定失效：<!--]--></strong> 若成員列表中某節點的心跳值在<strong data-v-84b57b07><!--[-->超過一定時間沒有增長<!--]--></strong>（ 例如超過 5 個 heartbeat 週期 ），則認定該節點<strong data-v-84b57b07><!--[-->離線<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->好處：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->透過 Gossip 機制，整個集群能在較小網絡開銷下達成對故障節點的共識。<!--]--></li><li data-v-4c2f5fb9><!--[-->由於採隨機對等傳播，Gossip 在大規模節點時的消息數量只線性增加且具高度冗餘，不易有單點瓶頸。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><br><strong data-v-84b57b07><!--[-->圖 6-11 示範：<!--]--></strong><strong data-v-84b57b07><!--[-->節點 <code class="" data-v-2f6bd69d><!--[-->s0<!--]--></code> 偵測到節點 <code class="" data-v-2f6bd69d><!--[-->s2<!--]--></code> 長時間沒心跳，<!--]--></strong><strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->s0<!--]--></code> 將此資訊隨 Gossip 傳給其他節點，最終全網標記 <code class="" data-v-2f6bd69d><!--[-->s2<!--]--></code> 故障。<!--]--></strong><img src="/code-study/images/sdi-aig/06/img-6-11.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><h4 id="_2臨時故障應對-sloppy-quorum-hinted-handoff" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#_2臨時故障應對-sloppy-quorum-hinted-handoff" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[--><strong data-v-84b57b07><!--[-->（2）臨時故障應對 – Sloppy Quorum &amp; Hinted Handoff：<!--]--></strong><!--]--><!----></a></h4><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->發現節點故障後，系統應繼續提供服務而不強制等待故障節點恢復。<!--]--></li><li data-v-4c2f5fb9><!--[-->這涉及兩個機制：<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Sloppy Quorum（草率仲裁）：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->為了提高可用性，暫時放寬 Quorum 的嚴格一致性要求。<!--]--></strong> 在原本需要與特定 N 個副本交互的基礎上，改為：<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->寫入：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->繞過故障節點<!--]--></li><li data-v-4c2f5fb9><!--[-->在雜湊環上選擇前 W 個運行狀良好的伺服器進行寫入，即算成功。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->讀取：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->繞過故障節點<!--]--></li><li data-v-4c2f5fb9><!--[-->在雜湊環上選擇前 R 個運行狀良好的伺服器進行讀取，即算成功。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[-->只要<strong data-v-84b57b07><!--[-->存活節點數量尚 &gt;= W 或 R<!--]--></strong>，讀寫操作就不會因單節點故障而被阻斷，提高了可用性。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Hinted Handoff（提示換手）：<!--]--></strong>
寫入因 Sloppy Quorum 被臨時寫到代管節點，如何在故障節點恢復後補回缺失的更新？<br>答案是<strong data-v-84b57b07><!--[-->提示換手<!--]--></strong>：<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->代管寫入的節點會將針對故障節點的更新保存下來（附上「給節點 X 的資料變更」提示）。<!--]--></li><li data-v-4c2f5fb9><!--[-->等偵測到原故障節點重新上線後，代管者再將這些更新“轉交”回原設置應儲存該資料的節點，完成補寫。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><br><strong data-v-84b57b07><!--[-->圖 6-12 所示，<!--]--></strong><strong data-v-84b57b07><!--[-->s2 故障期間 s3 代管了本屬於 s2 的更新，當 s2 恢復時，s3 將相關資料交還給 s2。<!--]--></strong><img src="/code-study/images/sdi-aig/06/img-6-12.png" alt="alt text" data-v-2ef15301><br><strong data-v-84b57b07><!--[-->上述兩者的結合增強可用性<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在短暫節點故障期間，系統仍能對外提供近乎正常的服務。<!--]--></li><li data-v-4c2f5fb9><!--[-->當節點恢復後又能將資料漸進糾正，實現最終一致。<!--]--></li><!--]--></ul><br><strong data-v-84b57b07><!--[-->犧牲了一定程度的一致性保證<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Sloppy Quorum 犧牲了一定一致性保證，可能讀不到最新寫入（ 因寫到臨時節點 ），但換來的是更高的故障容忍和持續服務能力。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><h4 id="_3永久故障應對-防止資料長期不一致-merkle-tree" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#_3永久故障應對-防止資料長期不一致-merkle-tree" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[--><strong data-v-84b57b07><!--[-->（3）永久故障應對 – 防止資料長期不一致： Merkle Tree<!--]--></strong><!--]--><!----></a></h4><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果某節點<strong data-v-84b57b07><!--[-->永久失效（ 例如硬碟損毀無法恢復數據 ）<!--]--></strong>，則使用上述<strong data-v-84b57b07><!--[-->提示換手也無法把它「喚醒」<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->此時通常透過 <strong data-v-84b57b07><!--[-->反熵（Anti-Entropy）機制在存活節點間進行資料修復同步<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->典型手段是使用 <strong data-v-84b57b07><!--[-->Merkle Tree（梅克爾樹，又稱雜湊樹） 來高效比較大範圍資料：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->透過對資料集合計算出<strong data-v-84b57b07><!--[-->層次化<!--]--></strong>的雜湊，
以<strong data-v-84b57b07><!--[-->快速定位<!--]--></strong>哪個區段資料不一致，
並能<strong data-v-84b57b07><!--[-->最小化資料傳輸<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->Amazon Dynamo 實作<strong data-v-84b57b07><!--[-->基於 Merkle 樹的反熵協議，確保副本間數據一致性。<!--]--></strong><!--]--></li><!--]--></ul><div class="highlight-null prose-code" data-v-a67e2655><!----><!--[--><pre class="" style=""><!--[--><code>將整個 key 空間分塊，
(1) 各節點對每塊計算雜湊，構建一棵樹並從根比對，若根相同則所有子樹都相同；
(2) 若根不同，則只需下探有差異的子樹分支，迅速找出不一致的鍵集合。
(3) 找到差異後，再進行資料補償同步。
(4) 透過定期運行 Merkle 樹比較，各副本可在後台修復長期分歧，最終達成一致。
</code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->維基百科 Merkle Tree<!--]--></strong><div class="highlight-null prose-code" data-v-a67e2655><!----><!--[--><pre class="" style=""><!--[--><code>雜湊樹（hash tree；Merkle tree），
在密碼學及電腦科學中是一種樹形資料結構，
每個葉節點均以資料塊的雜湊作為標籤，
而除了葉節點以外的節點則以其子節點標籤的加密雜湊作為標籤。

雜湊樹能夠高效、安全地驗證大型資料結構的內容，是雜湊鏈的推廣形式。
</code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><br><img src="/code-study/images/sdi-aig/06/img-markle-tree.png" alt="alt text" data-v-2ef15301>
二元雜湊樹範例。
雜湊 0-0 和 0-1 分別是資料塊 L1 和 L2 的雜湊值。
雜湊 0 是將雜湊 0-0 和 0-1 連接後所取得的雜湊值。<br><a href="https://www.youtube.com/watch?v=pRwvZzxcH2w" rel="nofollow" data-v-692834dd><!--[-->https://www.youtube.com/watch?v=pRwvZzxcH2w<!--]--></a><hr data-v-89dedb08><h4 id="merkle-樹建構流程舉例鍵空間-112" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#merkle-樹建構流程舉例鍵空間-112" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[-->🔍 Merkle 樹建構流程（舉例：鍵空間 1～12）<!--]--><!----></a></h4><h5 id="說明" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#說明" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->🎯 說明：<!--]--><!----></a></h5><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->假設我們的鍵值範圍是 <code class="" data-v-2f6bd69d><!--[-->1 到 12<!--]--></code>，以下是如何建構出對應的 Merkle 樹。
過程中若有異常（如資料不一致），會以<strong data-v-84b57b07><!--[-->特別標記的方塊<!--]--></strong>來呈現。<!--]--></p><!--]--></blockquote><hr data-v-89dedb08><h5 id="step-1鍵值劃分桶子圖-6-13" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#step-1鍵值劃分桶子圖-6-13" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->🧩 Step 1：鍵值劃分桶子（圖 6-13）<!--]--><!----></a></h5><blockquote data-v-96397147><!--[--><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->將鍵的空間平均劃分為多個「桶子（bucket）」，本例中共 <strong data-v-84b57b07><!--[-->4 個桶子<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->每個桶子會對應一棵子樹的<strong data-v-84b57b07><!--[-->根節點（root level node）<!--]--></strong>，後續用來維護這個桶內的資料結構。<!--]--></li><li data-v-4c2f5fb9><!--[-->📌 <strong data-v-84b57b07><!--[-->目的：<!--]--></strong> 降低單一 Merkle 樹過大，提升定位異常的效率。
<img src="/code-study/images/sdi-aig/06/img-6-13.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><!--]--></blockquote><hr data-v-89dedb08><h5 id="step-2鍵值雜湊圖-6-14" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#step-2鍵值雜湊圖-6-14" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->🔐 Step 2：鍵值雜湊（圖 6-14）<!--]--><!----></a></h5><blockquote data-v-96397147><!--[--><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->對每個桶子內的所有鍵值進行<strong data-v-84b57b07><!--[-->統一的 hash 處理<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->這些 hash 結果將作為 Merkle Tree 的葉節點（leaf nodes）。
<img src="/code-study/images/sdi-aig/06/img-6-14.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><!--]--></blockquote><hr data-v-89dedb08><h5 id="step-3建立桶子層級的雜湊節點圖-6-15" data-v-637c86f5><a aria-current="page" href="/code-study/sdi-aig/chapter6#step-3建立桶子層級的雜湊節點圖-6-15" class="router-link-active router-link-exact-active" data-v-637c86f5><!--[-->🌿 Step 3：建立桶子層級的雜湊節點（圖 6-15）<!--]--><!----></a></h5><blockquote data-v-96397147><!--[--><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->每個桶子產生一個對應的 hash node，代表該桶整體資料狀態。<!--]--></li><li data-v-4c2f5fb9><!--[-->這些節點會作為上層 Merkle Tree 的中繼節點（intermediate nodes）。
<img src="/code-study/images/sdi-aig/06/img-6-15.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><!--]--></blockquote><hr data-v-89dedb08><h3 id="step-4建構最終的-merkle-樹圖-6-16" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#step-4建構最終的-merkle-樹圖-6-16" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->🌳 Step 4：建構最終的 Merkle 樹（圖 6-16）<!--]--><!----></a></h3><blockquote data-v-96397147><!--[--><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->從每個桶子的 hash node 開始，<strong data-v-84b57b07><!--[-->兩兩組合並進行 hash<!--]--></strong>，逐層向上建構。<!--]--></li><li data-v-4c2f5fb9><!--[-->最終會得到一個全域的 <strong data-v-84b57b07><!--[-->Merkle Root<!--]--></strong>，可用來表示整體系統資料的一致性狀態。
<img src="/code-study/images/sdi-aig/06/img-6-16.png" alt="alt text" data-v-2ef15301><!--]--></li><!--]--></ul><!--]--></blockquote><hr data-v-89dedb08><h3 id="merkle-tree-優點整理" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#merkle-tree-優點整理" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->✅ Merkle Tree 優點整理<!--]--><!----></a></h3><div class="table-wrapper" data-v-78f198db><table data-v-78f198db><!--[--><thead data-v-81e7d1ab><!--[--><tr data-v-759aaa1b><!--[--><th data-v-40ddd69b><!--[-->特性<!--]--></th><th data-v-40ddd69b><!--[-->說明<!--]--></th><!--]--></tr><!--]--></thead><tbody><!--[--><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->區域性更新<!--]--></td><td data-v-5f84e3ba><!--[-->只需更新變更桶子對應的子樹及相關 hash，其他部分保持不變<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->快速偵測異常<!--]--></td><td data-v-5f84e3ba><!--[-->比對 root hash，若不一致即可快速縮小範圍至異常桶子<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->易於擴充<!--]--></td><td data-v-5f84e3ba><!--[-->桶子數可依據資料規模動態調整，適合大規模分散式系統<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->應用場景<!--]--></td><td data-v-5f84e3ba><!--[-->區塊鏈、分散式檔案系統（如 IPFS）、資料一致性檢查與同步機制等<!--]--></td><!--]--></tr><!--]--></tbody><!--]--></table></div><hr data-v-89dedb08><!--]--></li><!--]--></ul><br> 
<div class="highlight-null prose-code" data-v-a67e2655><!----><!--[--><pre class="" style=""><!--[--><code>只要使用 Merkle Tree 的做法，
需要同步的資料量就會與兩個副本之間的差異(而不是所包含資料量)成正比。

在實際的系統中，
桶子的尺寸有可能相當大。
舉例來說，我們可能會設定每十億個鍵對應一百萬個桶子，如此一來，每個桶子就包含 1000 個鍵。
</code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><br><h4 id="_4資料中心服務中斷的問題-跨多個資料中心複製資料的做法非常重要" data-v-57e8d291><a aria-current="page" href="/code-study/sdi-aig/chapter6#_4資料中心服務中斷的問題-跨多個資料中心複製資料的做法非常重要" class="router-link-active router-link-exact-active" data-v-57e8d291><!--[--><strong data-v-84b57b07><!--[-->（4）資料中心服務中斷的問題： 跨多個資料中心複製資料的做法非常重要。<!--]--></strong><!--]--><!----></a></h4><br><h2 id="回顧一下" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#回顧一下" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[--><em data-v-b3b2ffd9><!--[--><strong data-v-84b57b07><!--[-->📌 回顧一下<!--]--></strong><!--]--></em><!--]--><!----></a></h2><h3 id="session-3-階段內容至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#session-3-階段內容至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->Session 3 階段內容，至此我們聚焦在分散式鍵值存儲系統中<strong data-v-84b57b07><!--[-->一致性與容錯<!--]--></strong>挑戰<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->(1) 資料分區：一致性雜湊與水平擴充<!--]--></p><p data-v-9dc9c102><!--[-->(2) 資料複製：高可用性的基石<!--]--></p><p data-v-9dc9c102><!--[-->(3) 一致性：Quorum 機制與最終一致性<!--]--></p><p data-v-9dc9c102><!--[-->(4) 不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )<!--]--></p><p data-v-9dc9c102><!--[-->(5) 節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff<!--]--></p><p data-v-9dc9c102><!--[-->我們已構建起一個分散式鍵值存儲的完整藍圖，<!--]--></p><p data-v-9dc9c102><!--[-->涵蓋從資料分區、複製到一致性維護、故障處理的各方面。<!--]--></p><p data-v-9dc9c102><!--[-->主要收穫包括：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->一致性模型選擇：<!--]--></strong> 綜上，本系統採用<strong data-v-84b57b07><!--[-->最終一致性<!--]--></strong>模型，強調高可用性與容錯。但我們也提供參數使其一致性<strong data-v-84b57b07><!--[-->可調<!--]--></strong>（Consistency Tunable），例如客戶端可根據需求選擇不同 R、W 配置來實現從弱一致到強一致的切換。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->調節一致性的策略：<!--]--></strong> Quorum 機制允許我們通過調整 W、R <strong data-v-84b57b07><!--[-->在一致性與延遲間找到平衡點<!--]--></strong>。對追求最終一致性的系統，可選較小 W、R 以降低延遲；如需強一致，可設定 W+R &gt; N。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->衝突偵測與解決：<!--]--></strong> 透過<strong data-v-84b57b07><!--[-->向量時鐘<!--]--></strong>為每個鍵值跟蹤多副本的版本演進史，偵測並行更新造成的衝突。在需要時將多版本交由客戶端合併，確保沒有寫入被無故覆蓋或遺失。儘管增加實現複雜度，但對於高度可用系統而言，這是達成最終一致性的關鍵。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->故障容錯機制：<!--]--></strong> Gossip 協議提供去中心化且高容錯的故障偵測方案，讓集群快速達成對節點存活狀態的共識。Sloppy Quorum 和 Hinted Handoff 則在節點臨時故障時維持服務不中斷，並在其恢復後自動補齊資料，提升整體可用性。永久性故障下，<strong data-v-84b57b07><!--[-->借助 Merkle 樹等反熵演算法，系統能找出並同步遺失的資料片段。<!--]--></strong><!--]--></li><!--]--></ul><h2 id="最後關注系統的實際架構實作" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#最後關注系統的實際架構實作" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[--><em data-v-b3b2ffd9><!--[--><strong data-v-84b57b07><!--[-->📌 最後關注系統的實際架構實作<!--]--></strong><!--]--></em><!--]--><!----></a></h2><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->包括資料存儲引擎（寫入/讀取路徑）以及一個使用 C# + MSSQL 的簡易鍵值存儲 API 範例，並探討幾個現代鍵值存儲系統作比較。<!--]--></strong><!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->系統架構圖<!--]--></li><li data-v-4c2f5fb9><!--[-->寫入途徑<!--]--></li><li data-v-4c2f5fb9><!--[-->讀取途徑<!--]--></li><!--]--></ul><br><h2 id="系統架構圖整體架構與資料存儲引擎" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#系統架構圖整體架構與資料存儲引擎" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->系統架構圖：整體架構與資料存儲引擎<!--]--><!----></a></h2><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[-->綜合前述設計，
我們的鍵值存儲系統架構可以描述如下：<!--]--></p><!--]--></blockquote><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->無中心架構（Decentralized）：<!--]--></strong> 集群中無主從之分，每個節點職責相當（均可作為請求協調者、均存儲部分資料）。這避免單點瓶頸，提升可靠性。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->請求路由：<!--]--></strong> 客戶端發出的請求（讀或寫），可透過<strong data-v-84b57b07><!--[-->一致性雜湊<!--]--></strong>機制路由到對應的節點處理。實務中通常由客戶端或中介負責計算鍵的雜湊並選擇節點，或者設置每個節點都能轉發請求到正確節點。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->協調者：<!--]--></strong> 處理請求的節點扮演<strong data-v-84b57b07><!--[-->協調者<!--]--></strong>角色（Coordinator），充當客戶端與存儲節點之間的代理。協調者負責與副本節點通信以完成讀寫 Quorum。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料存儲層：<!--]--></strong> 每個節點本地維護存儲引擎，包括<strong data-v-84b57b07><!--[-->記憶體快取<!--]--></strong>（memtable）與<strong data-v-84b57b07><!--[-->磁碟資料檔<!--]--></strong>（如 SSTable）等，用以快速存取和持久化資料。為性能，經常採用<strong data-v-84b57b07><!--[-->基於日誌的結構存儲（LSM Tree）<!--]--></strong> 模型。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->組件回顧：<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->分區<!--]--></strong>：一致性雜湊確定資料歸屬節點，支撐水平擴展。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->複製<!--]--></strong>：多副本存放與跨機房配置保證高可用。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->一致性<!--]--></strong>：Quorum 共識 + 調整 R/W 保證讀寫一致性。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->衝突解決<!--]--></strong>：向量時鐘 &amp; 客戶端合併應對並發更新。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->故障處理<!--]--></strong>：Gossip 偵測 + Sloppy Quorum / Hinted Handoff 保證系統容錯與最終一致。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->圖 6-17 為系統架構示意，展示了沒有中央控制節點下，各節點如何透過雜湊環、複製和協調機制協同工作：
<img src="/code-study/images/sdi-aig/06/img-6-17.png" alt="alt text" data-v-2ef15301><!--]--></p><p data-v-9dc9c102><!--[-->圖 6-18 為分散式鍵值存儲系統的每個節點，去中心化的示意圖。
<img src="/code-study/images/sdi-aig/06/img-6-18.png" alt="alt text" data-v-2ef15301><!--]--></p><p data-v-9dc9c102><!--[-->接下來重點說明
<strong data-v-84b57b07><!--[-->資料寫入與讀取路徑<!--]--></strong>在節點內的處理流程，這對<strong data-v-84b57b07><!--[-->性能和可靠性<!--]--></strong>至關重要。<!--]--></p><br><h2 id="寫入途徑資料寫入路徑write-path" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#寫入途徑資料寫入路徑write-path" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->寫入途徑：資料寫入路徑（Write Path）<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->對於來自客戶端發出的每一次寫入請求，
經路由到正確節點後，
主要執行以下步驟（借鑑 Apache Cassandra 的實作）：
<img src="/code-study/images/sdi-aig/06/img-6-19.png" alt="alt text" data-v-2ef15301><!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->提交日誌 (Commit Log)：<!--]--></strong> 協調節點首先將寫操作記錄追加到<strong data-v-84b57b07><!--[-->提交日誌文件<!--]--></strong>中。這是一個<strong data-v-84b57b07><!--[-->有序寫入的預寫日誌<!--]--></strong>，確保即使隨後節點崩潰，重啟時也能從日誌重放恢復未刷入的資料。<strong data-v-84b57b07><!--[-->有序寫磁碟相對快速，確保每次寫入先落盤，提高資料耐久性。<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->寫入記憶體表 (MemTable)：<!--]--></strong> 同時，將此鍵值對寫入節點的<strong data-v-84b57b07><!--[-->記憶體快取 (memtable)<!--]--></strong>。MemTable可理解為<strong data-v-84b57b07><!--[-->存於記憶體的排序Map結構，累積近期寫入（尚未刷盤）<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->確認 &amp; 複製：<!--]--></strong> 協調者等待本地（及可能其他副本）的MemTable寫入操作成功返回（達到 W 個ACK）後，即可向客戶端回覆寫入成功。這時數據已經在記憶體中，以及至少 W 個副本的提交日誌中持久化。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->MemTable 刷盤 (Flush to SSTable)：<!--]--></strong> 隨著寫入不斷進行，MemTable 佔用內存越來越大。當其大小達到預設閾值或時間週期，就觸發<strong data-v-84b57b07><!--[-->刷盤<!--]--></strong>：把 MemTable 內容排序後寫出到磁碟上的 <strong data-v-84b57b07><!--[-->SSTable（Sorted String Table）<!--]--></strong> 檔案。SSTable 是有序的不變（immutable）鍵值集合檔，每次刷盤生成一個新的檔案。<strong data-v-84b57b07><!--[-->刷盤過程同時清空該 MemTable，並打上一個新的 MemTable 寫入後續資料。<!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->檔案合併 (Compaction)：<!--]--></strong>（可選）為避免 SSTable 檔過多或存在過時版本碎片，後台定期對多個 SSTable 檔案進行<strong data-v-84b57b07><!--[-->壓實（Compaction）<!--]--></strong>，合併同一鍵的多版本記錄，棄掉被覆蓋或刪除的舊版本，減少查詢開銷。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->以上流程確保了寫入既<strong data-v-84b57b07><!--[-->快速<!--]--></strong>（記憶體操作+有序日誌）又<strong data-v-84b57b07><!--[-->安全<!--]--></strong>（日誌在先，防故障丟失）。Cassandra 寫路徑的設計容許高吞吐的隨機寫操作，並通過後續順序刷盤優化磁碟訪問。<!--]--></p><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->實現提示：<!--]--></strong> 寫路徑強調<strong data-v-84b57b07><!--[-->先寫日誌再寫內存<!--]--></strong>，這與傳統關係資料庫 WAL + Buffer Pool 機制類似，稱為「<strong data-v-84b57b07><!--[-->先寫日誌<!--]--></strong>」策略。這樣在crash時，可重播日誌保障資料不丟。Cassandra也採此法確保即使節點故障重啟，提交日誌能恢復自上次flush後失去的資料。<!--]--></p><!--]--></blockquote><br><h2 id="讀取途徑資料讀取路徑read-path" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#讀取途徑資料讀取路徑read-path" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->讀取途徑：資料讀取路徑（Read Path）<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->讀取請求的流程相對直觀，
但需處理資料可能分散在記憶體和多個磁碟檔的情況。節點接到讀取某鍵的請求後：<!--]--></p><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-20.png" alt="alt text" data-v-2ef15301><!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->查詢 MemTable：<!--]--></strong> 優先在<strong data-v-84b57b07><!--[-->記憶體快取<!--]--></strong>中查找該鍵。如果命中（資料尚未刷盤，存在於最新 MemTable），直接返回值，讀取結束。這是最快的情況（O(1)雜湊查找，無磁碟IO）。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->查詢 Cache 未命中：<!--]--></strong> 若鍵不在記憶體中（MemTable miss），說明資料要麼在舊的 SSTable 檔，要麼此鍵根本不存在。此時進入磁碟查找流程。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-6-21.png" alt="alt text" data-v-2ef15301><!--]--></p><ol start="3" data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Bloom Filter 篩選：<!--]--></strong> 為了避免遍歷所有 SSTable 檔案查找，可以使用<strong data-v-84b57b07><!--[-->Bloom Filter<!--]--></strong>為每個 SSTable 加一層索引。Bloom Filter 是一種空間高效的機率型資料結構，可快速測試「某鍵是否<strong data-v-84b57b07><!--[-->不在<!--]--></strong>某檔案」。每個 SSTable 存有對應的 Bloom Filter，當查找鍵K時，先讓 Bloom Filter 判斷該 SSTable 是否<strong data-v-84b57b07><!--[-->可能<!--]--></strong>包含 K。<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果 Bloom Filter 判定「不可能在此 SSTable」，則可直接跳過該檔案。<!--]--></li><li data-v-4c2f5fb9><!--[-->若判定「可能存在」，才去該 SSTable 中透過檔內索引（二分搜尋等）實際查找。<!--]--></li><li data-v-4c2f5fb9><!--[-->透過Bloom Filter，可以大幅減少不必要的磁碟IO。例如某鍵可能僅存在最新幾個檔案，Bloom Filter 將排除大部分與該鍵無關的檔案。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->SSTable 查找：<!--]--></strong> 對於Bloom Filter結果為可能包含的那些 SSTable，打開檔案（典型為有序IO），利用其內部稽核（如稀疏索引或B樹索引）定位鍵的位置，讀出對應的值。由於SSTable內記錄有序，可以較快速地找到鍵。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->數據返回與合併：<!--]--></strong> 如果從多個副本節點讀取（R&gt;1情況），協調者會收到多份值，需比較其版本（例如 vector clock 或時間戳）選擇最新的結果返回給客戶端。如果偵測到版本衝突（如之前所述出現多版本），則返回所有版本讓客戶端處理。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->讀取快取：<!--]--></strong> 讀取完成後，可將該鍵結果存入<strong data-v-84b57b07><!--[-->頁面快取<!--]--></strong>或<strong data-v-84b57b07><!--[-->鍵值快取<!--]--></strong>，下次相同鍵訪問時直接命中，提高熱點讀性能。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->總結來說，
讀路徑的優化重點在於<strong data-v-84b57b07><!--[-->記憶體命中優先<!--]--></strong>，
其次透過<strong data-v-84b57b07><!--[-->Bloom Filter<!--]--></strong>減少磁碟掃描範圍。<!--]--></p><p data-v-9dc9c102><!--[-->經過這些步驟，
大部分讀請求可在 O(1) 時間返回（記憶體命中）或以少量有序 IO 完成。
Bloom Filter 雖有極小機率誤判（回傳“可能存在”實際沒有），但不影響正確性，只是多一次空查找，而且誤判率可透過調整位元數控制。<!--]--></p><br><hr data-v-89dedb08><h2 id="session-3-各個組件環環相扣關係的架構圖" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#session-3-各個組件環環相扣關係的架構圖" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->Session 3 各個組件環環相扣關係的架構圖：<!--]--><!----></a></h2><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/img-note.png" alt="alt text" data-v-2ef15301><!--]--></p><h3 id="_1-起點分散式需求" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#_1-起點分散式需求" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->1. <strong data-v-84b57b07><!--[-->起點：分散式需求<!--]--></strong><!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->從單機無法滿足的需求出發（大容量、高可用、可擴展）<!--]--></li><!--]--></ul><h3 id="_2-基礎設計資料分區與複製" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#_2-基礎設計資料分區與複製" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->2. <strong data-v-84b57b07><!--[-->基礎設計：資料分區與複製<!--]--></strong><!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料分區<!--]--></strong>：使用一致性雜湊將資料均勻分散到多個節點<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料複製<!--]--></strong>：每份資料保存 N 個副本，確保可用性<!--]--></li><li data-v-4c2f5fb9><!--[-->兩者相輔相成：分區決定資料位置，複製保證容錯<!--]--></li><!--]--></ul><h3 id="_3-衍生挑戰一致性問題" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#_3-衍生挑戰一致性問題" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->3. <strong data-v-84b57b07><!--[-->衍生挑戰：一致性問題<!--]--></strong><!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->多副本帶來一致性挑戰<!--]--></li><li data-v-4c2f5fb9><!--[-->CAP 定理迫使我們在 AP 和 CP 之間選擇<!--]--></li><li data-v-4c2f5fb9><!--[-->選擇 AP 系統（最終一致性）以保證高可用<!--]--></li><!--]--></ul><h3 id="_4-解決方案一致性與衝突處理" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#_4-解決方案一致性與衝突處理" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->4. <strong data-v-84b57b07><!--[-->解決方案：一致性與衝突處理<!--]--></strong><!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Quorum 機制<!--]--></strong>：通過 N/W/R 參數調節一致性級別<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->向量時鐘<!--]--></strong>：檢測並解決並發更新造成的版本衝突<!--]--></li><!--]--></ul><h3 id="_5-進階挑戰節點故障" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#_5-進階挑戰節點故障" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->5. <strong data-v-84b57b07><!--[-->進階挑戰：節點故障<!--]--></strong><!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->故障偵測<!--]--></strong>：Gossip 協議去中心化地發現故障節點<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->臨時故障<!--]--></strong>：Sloppy Quorum + Hinted Handoff 維持服務<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->永久故障<!--]--></strong>：Merkle Tree 進行資料修復<!--]--></li><!--]--></ul><h3 id="_6-最終實現完整系統架構" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#_6-最終實現完整系統架構" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->6. <strong data-v-84b57b07><!--[-->最終實現：完整系統架構<!--]--></strong><!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->系統架構<!--]--></strong>：去中心化設計，協調者模式<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->寫入路徑<!--]--></strong>：Commit Log → MemTable → SSTable<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->讀取路徑<!--]--></strong>：MemTable 優先，Bloom Filter 優化<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->節點內部<!--]--></strong>：LSM Tree 結構，後台 Compaction<!--]--></li><!--]--></ul><h2 id="環環相扣的特點" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#環環相扣的特點" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->環環相扣的特點：<!--]--><!----></a></h2><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->因果關係明確<!--]--></strong>：每一層的設計都是為了解決上一層帶來的問題<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->相互依賴<!--]--></strong>：各組件不是獨立存在，而是共同構成完整系統<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->持續優化<!--]--></strong>：系統運行中的經驗會反饋到各層設計的改進<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->這個架構展示了分散式鍵值儲存系統設計的完整思路，從需求出發，逐步解決各種挑戰，最終形成一個高可用、可擴展的系統。<!--]--></p><hr data-v-89dedb08><h1 id="第六章-總結" data-v-2001208a><a aria-current="page" href="/code-study/sdi-aig/chapter6#第六章-總結" class="router-link-active router-link-exact-active" data-v-2001208a><!--[-->第六章 總結<!--]--><!----></a></h1><p data-v-9dc9c102><!--[-->經過三個階段的講解，我們完整覆蓋了<strong data-v-84b57b07><!--[-->分散式鍵值存儲系統<!--]--></strong>從原理到實作的方方面面：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Session 1：<!--]--></strong> 理解了鍵值資料庫的基本定義。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Session 2：<!--]--></strong> 單機實現方式，以及擴展到分散式系統時需要面臨的 CAP 抉擇。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Session 3：<!--]--></strong> 從資料分區/複製方法，到深入探討了為實現高可用而採取最終一致性的系統中，如何利用 quorum 共識調節一致性、用向量時鐘來侦測和解決衝突版本、用 Gossip 和 Hinted Handoff 等機制來實現故障容忍與自癒。並闡述了實際系統架構下資料讀寫的具體流程（MemTable+SSTable 和 Bloom Filter 等實作細節）。此外，我們將該系統與當今主流方案進行了對比，理解不同系統在 CAP 取捨和架構設計上的演進。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->整章核心要點回顧：<!--]--></strong> (對照下表)<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->為處理<strong data-v-84b57b07><!--[-->海量資料<!--]--></strong>：採用<strong data-v-84b57b07><!--[-->分區/一致性雜湊<!--]--></strong>分散鍵到多節點。<!--]--></li><li data-v-4c2f5fb9><!--[-->提供<strong data-v-84b57b07><!--[-->高可用讀取<!--]--></strong>：透過<strong data-v-84b57b07><!--[-->多副本複製<!--]--></strong>，甚至跨機房部署。<!--]--></li><li data-v-4c2f5fb9><!--[-->支撐<strong data-v-84b57b07><!--[-->高可用寫入<!--]--></strong>：允許<strong data-v-84b57b07><!--[-->最終一致<!--]--></strong>，使用向量時鐘進行版本控制與衝突解決。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->可線性擴展<!--]--></strong>：增加節點透過一致性雜湊自動攤平負載，虛擬節點支持異構性。<!--]--></li><li data-v-4c2f5fb9><!--[-->容忍<strong data-v-84b57b07><!--[-->臨時故障<!--]--></strong>：採用 Sloppy Quorum + Hinted Handoff 技術保證服務不中斷。<!--]--></li><li data-v-4c2f5fb9><!--[-->應對<strong data-v-84b57b07><!--[-->永久故障<!--]--></strong>：利用 Merkle Tree 進行反熵同步。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->跨域高可用<!--]--></strong>：多資料中心複製與故障轉移策略，保障局部機房宕機時系統整體仍存活。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><img src="/code-study/images/sdi-aig/06/table-6-2.png" alt="alt text" data-v-2ef15301><!--]--></p><hr data-v-89dedb08><hr data-v-89dedb08><h3 id="c-最小鍵值存儲-api-實作範例" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#c-最小鍵值存儲-api-實作範例" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->C# 最小鍵值存儲 API 實作範例<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->下面我們將實作一個簡化的鍵值存儲服務，使用 C# (.NET 8 Minimal API) 提供 HTTP 接口，並以 MSSQL 資料庫作為持久層。此範例展示鍵值存儲的核心功能，包括資料的寫入、讀取和版本管理對應我們前述章節的概念。<!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->資料表設計：<!--]--></strong> 在 MSSQL 中建立一張 <code class="" data-v-2f6bd69d><!--[-->KeyValueStore<!--]--></code> 表：<!--]--></p><div class="highlight-sql prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-sql shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">CREATE</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> TABLE</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> KeyValueStore</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (
</span></span><span class="line" line="2"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    [Key]   </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">NVARCHAR</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">256</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">NOT NULL</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> PRIMARY KEY</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">,
</span></span><span class="line" line="3"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    [Value] </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">NVARCHAR</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(MAX) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">NULL</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">,
</span></span><span class="line" line="4"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    [Version] </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">INT</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> NOT NULL</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> DEFAULT</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 0
</span></span><span class="line" line="5"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->Key<!--]--></code> 欄位作為主鍵存放鍵名稱。<!--]--></li><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->Value<!--]--></code> 欄位存放字串類型的值（實務中可用 VARBINARY(MAX) 存放二進位資料)。<!--]--></li><li data-v-4c2f5fb9><!--[--><code class="" data-v-2f6bd69d><!--[-->Version<!--]--></code> 欄位記錄此鍵的版本號，用於簡單實現<strong data-v-84b57b07><!--[-->版本控制<!--]--></strong>（每次更新遞增版本）。這對應前述向量時鐘的概念縮減版：我們僅用單一整數表示版本，雖無法處理多副本並發，但可用於樂觀鎖防止寫入覆蓋較新更新。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->接著，我們使用 .NET 8 Minimal API 建立 HTTP 介面，包含 <strong data-v-84b57b07><!--[-->PUT<!--]--></strong>（寫入/更新鍵）與 <strong data-v-84b57b07><!--[-->GET<!--]--></strong>（讀取鍵）兩種操作：<!--]--></p><div class="highlight-csharp prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-csharp shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">using</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> Microsoft</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">Data</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">SqlClient</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">;
</span></span><span class="line" line="2"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">using</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> Dapper</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">;
</span></span><span class="line" line="3"><span emptylineplaceholder="true">
</span></span><span class="line" line="4"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> builder</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> WebApplication.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">CreateBuilder</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(args);
</span></span><span class="line" line="5"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> app</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> builder.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Build</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">();
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// Database connection string (modify as appropriate for your environment)
</span></span><span class="line" line="8"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> connString</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> builder.Configuration.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">GetConnectionString</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;KeyValueDb&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// 1. GET endpoint: retrieve value by key
</span></span><span class="line" line="11"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">app.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">MapGet</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;/kv/{key}&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">async</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> key</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=&gt;
</span></span><span class="line" line="12"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{
</span></span><span class="line" line="13"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    const</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> sql</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> &quot;SELECT [Value], [Version] FROM KeyValueStore WHERE [Key] = @Key&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">;
</span></span><span class="line" line="14"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    await</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> using</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"> var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> conn</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> new</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> SqlConnection</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(connString);
</span></span><span class="line" line="15"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">    var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> result</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> await</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> conn.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">QueryFirstOrDefaultAsync</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&lt;(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> Value</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> Version</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)&gt;(sql, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">new</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> { Key </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> key });
</span></span><span class="line" line="16"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (result.Value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">==</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> null</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="17"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="18"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> Results.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">NotFound</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">$&quot;Key &#39;{</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">key</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">}&#39; not found&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span><span class="line" line="19"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="20"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">    // Return the value and version (as ETag header for concurrency control, e.g.)
</span></span><span class="line" line="21"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> Results.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Ok</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">new</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> { Key </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> key, Value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> result.Value, Version </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> result.Version });
</span></span><span class="line" line="22"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">});
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// 2. PUT endpoint: insert or update a key-value
</span></span><span class="line" line="25"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">app.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">MapPut</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;/kv/{key}&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">async</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> key</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> value</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=&gt;
</span></span><span class="line" line="26"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{
</span></span><span class="line" line="27"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    await</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> using</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"> var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> conn</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> new</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> SqlConnection</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(connString);
</span></span><span class="line" line="28"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">    // Try update first
</span></span><span class="line" line="29"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    const</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> updateSql</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> @&quot;
</span></span><span class="line" line="30"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">        UPDATE KeyValueStore
</span></span><span class="line" line="31"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">        SET [Value] = @Value, [Version] = [Version] + 1
</span></span><span class="line" line="32"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">        WHERE [Key] = @Key;
</span></span><span class="line" line="33"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">        SELECT @@ROWCOUNT;&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">;
</span></span><span class="line" line="34"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">    var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> rows</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> await</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> conn.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">ExecuteScalarAsync</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&lt;</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&gt;(updateSql, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">new</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> { Key </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> key, Value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> value });
</span></span><span class="line" line="35"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (rows </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">==</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="36"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="37"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">        // If key not exists, insert new record
</span></span><span class="line" line="38"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        const</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> insertSql</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> &quot;INSERT INTO KeyValueStore([Key],[Value],[Version]) VALUES(@Key, @Value, 0);&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">;
</span></span><span class="line" line="39"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        try
</span></span><span class="line" line="40"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        {
</span></span><span class="line" line="41"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">            await</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> conn.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">ExecuteAsync</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(insertSql, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">new</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> { Key </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> key, Value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> value });
</span></span><span class="line" line="42"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }
</span></span><span class="line" line="43"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        catch</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">SqlException</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> ex</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">when</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (ex.Number </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">==</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 2627</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// PK violation
</span></span><span class="line" line="44"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        {
</span></span><span class="line" line="45"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">            // Handle race condition: key was inserted by another request in the meantime
</span></span><span class="line" line="46"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">            return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> Results.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Conflict</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">$&quot;Key &#39;{</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">key</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">}&#39; was inserted by another client.&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span><span class="line" line="47"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }
</span></span><span class="line" line="48"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="49"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> Results.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">NoContent</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">();
</span></span><span class="line" line="50"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">});
</span></span><span class="line" line="51"><span emptylineplaceholder="true">
</span></span><span class="line" line="52"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">app.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Run</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">();
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->上述程式碼說明：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->我們使用 <strong data-v-84b57b07><!--[-->Dapper<!--]--></strong> 輕量ORM來執行 SQL 查詢，方便地將結果映射為 C# 型別。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->查詢 (GET)<!--]--></strong>：透過主鍵查詢資料庫，若找到則返回 JSON，包括鍵和值以及版本號。版本號可以透過 HTTP ETag 頭返回，供客戶端做併發控制（比如更新時帶回去作條件比對）。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->更新/插入 (PUT)<!--]--></strong>：先嘗試執行 SQL <code class="" data-v-2f6bd69d><!--[-->UPDATE<!--]--></code> 語句（利用 <code class="" data-v-2f6bd69d><!--[-->@@ROWCOUNT<!--]--></code> 判斷是否有行受影響）更新現有記錄的值，並將版本 <code class="" data-v-2f6bd69d><!--[-->Version = Version + 1<!--]--></code>。若 <code class="" data-v-2f6bd69d><!--[-->UPDATE<!--]--></code> 返回影響行數為0，表示該鍵不存在，進而嘗試執行 <code class="" data-v-2f6bd69d><!--[-->INSERT<!--]--></code> 新記錄。考慮到可能出現<strong data-v-84b57b07><!--[-->併發<!--]--></strong>（兩請求幾乎同時插入同一鍵導致一方PK衝突），捕獲 PK 違規錯誤號2627並返回衝突結果，提醒客戶端該鍵已被其他請求寫入。<!--]--></li><li data-v-4c2f5fb9><!--[-->整個 PUT 操作未使用顯式交易（Transaction），但由於我們先嘗試 UPDATE 再 INSERT，兩步間依然有極小窗口可能導致重複插入。因此以 try-catch 捕捉 PK 衝突視為<strong data-v-84b57b07><!--[-->最終一致性下的衝突解決<!--]--></strong>之一種：這裡簡單地告知客戶端衝突，由客戶端決定後續（類似 Dynamo 讀合併寫回模式）。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->對應章節概念：<!--]--></strong> 這段程式碼體現了數個我們在前面討論的概念：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[-->Hash Table 存儲<!--]--></em>：我們以資料庫表的 PK 索引模擬鍵值對的 O(1) 查找，類似單機 HashTable。<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[-->持久化與 WAL<!--]--></em>：SQL 資料庫本身在執行 UPDATE/INSERT 時已使用WAL日志確保原子性，我們不需另寫文件日誌。但原理類似我們在寫路徑中強調的先寫提交日誌。<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[-->版本號/衝突控制<!--]--></em>：我們透過 <code class="" data-v-2f6bd69d><!--[-->Version<!--]--></code> 欄位實現<strong data-v-84b57b07><!--[-->版本控制<!--]--></strong>，每次更新+1。這與向量時鐘理念類似但簡化為單一節點序號，用於檢測並發更新：若多客戶端同時讀取同一版本並各自修改，我們可以藉由版本是否匹配來檢測衝突（在此例中，可在 PUT 加入 <code class="" data-v-2f6bd69d><!--[-->WHERE Version = X<!--]--></code> 條件保護，若版本不符則UPDATE無效，提示客戶端重試）。<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[-->最終一致性與衝突<!--]--></em>：我們示範了簡單的<strong data-v-84b57b07><!--[-->衝突處理<!--]--></strong>邏輯（PK衝突時返回 409），這映射到 Session 2 談的併發寫入衝突需要協調解決的場景。<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[-->高可用與容錯<!--]--></em>：本範例為簡化單節點服務，未實現 Gossip 等機制。但若擴展為多節點，我們可令每個節點部署此API服務並指向各自後端（如各自的資料庫分片），客戶端透過一致性哈希選節點請求，即可形成一個去中心的分散集群。再搭配資料庫層的同步機制或上層協調，可實現我們設計的 AP 模型。<!--]--></li><li data-v-4c2f5fb9><!--[--><em data-v-b3b2ffd9><!--[-->讀寫流程<!--]--></em>：GET 端點優先查主鍵索引、PUT 端點先寫資料庫（相當於我們設計中寫MemTable和CommitLog），兩者都體現<strong data-v-84b57b07><!--[-->先快取/內存再磁碟<!--]--></strong>的思路。雖然我們這裡讓SQL處理細節，但對應Cassandra架構中就是遵循「內存-&gt;磁碟、先log再flush」的流程。<!--]--></li><!--]--></ul><blockquote data-v-96397147><!--[--><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->附註：<!--]--></strong> 實務中，可用 Entity Framework Core 或其他 ORM 簡化資料訪問，這裡用 Dapper 為直觀展現 SQL 操作。另外，為專注重點，程式碼省略了一些如日誌、更多錯誤處理，以及向量時鐘多節點部分（因單資料庫難以模擬多副本場景）。但其結構已足以作為Minimal Key-Value Store服務的雛形。<!--]--></p><!--]--></blockquote><br><hr data-v-89dedb08><h3 id="現代鍵值存儲框架演進與比較-20232025" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#現代鍵值存儲框架演進與比較-20232025" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->現代鍵值存儲框架演進與比較 (2023–2025)<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->如今市面上有眾多鍵值存儲解決方案，各具不同的架構與特性。我們選取其中具代表性的 DynamoDB、TiKV、FoundationDB、etcd、Redis Cluster，結合近年演進，做一番概覽與比較：<!--]--></p><div class="table-wrapper" data-v-78f198db><table data-v-78f198db><!--[--><thead data-v-81e7d1ab><!--[--><tr data-v-759aaa1b><!--[--><th data-v-40ddd69b><!--[-->平台<!--]--></th><th data-v-40ddd69b><!--[-->架構/定位<!--]--></th><th data-v-40ddd69b><!--[-->CAP 類型<!--]--></th><th data-v-40ddd69b><!--[-->一致性協議<!--]--></th><th data-v-40ddd69b><!--[-->特點與近年發展<!--]--></th><!--]--></tr><!--]--></thead><tbody><!--[--><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->Amazon DynamoDB<!--]--></strong><!--]--></td><td data-v-5f84e3ba><!--[-->AWS 雲托管鍵值資料庫，無縫擴展<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->AP<!--]--></strong> (預設)<br>提供可選強一致讀<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->單主 Multi-Paxos<!--]--></strong> 每分片一主<!--]--></td><td data-v-5f84e3ba><!--[-->高度可擴展（支援萬億級別請求），預設最終一致但可選<strong data-v-84b57b07><!--[-->強一致讀<!--]--></strong>模式。近年新增<strong data-v-84b57b07><!--[-->全局資料表<!--]--></strong>實現多區域複製、<strong data-v-84b57b07><!--[-->交易<!--]--></strong>支持 (Transaction) 等功能，使之同時滿足嚴格一致場景需求。架構源於 Dynamo 論文但實際實現有別：採用<strong data-v-84b57b07><!--[-->單主同步<!--]--></strong>複製（每分區一主節點）確保寫一致性，並以<strong data-v-84b57b07><!--[-->多主Region<!--]--></strong>實現全球可用。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->Apache Cassandra<!--]--></strong><!--]--></td><td data-v-5f84e3ba><!--[-->分散式列族資料庫，也提供鍵值接口<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->AP<!--]--></strong> (可調一致性)<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->無主對等 + Gossip<!--]--></strong><br>使用 <strong data-v-84b57b07><!--[-->Hinted Handoff<!--]--></strong> 等<!--]--></td><td data-v-5f84e3ba><!--[-->Cassandra 基於 Dynamo 理念實作，無中心，多副本最終一致。特點是採用<strong data-v-84b57b07><!--[-->可調一致性<!--]--></strong>（客戶端可指定 R/W），提供 TimeUUID 等順序支援。近年版本（4.0以後）加強了 <strong data-v-84b57b07><!--[-->Audit Logging<!--]--></strong> 和 <strong data-v-84b57b07><!--[-->Backpressure<!--]--></strong> 等特性。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->Redis (Cluster 模式)<!--]--></strong><!--]--></td><td data-v-5f84e3ba><!--[-->記憶體鍵值庫，支援集群分片<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->偏AP<!--]--></strong>（高可用優先）<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->主從非同步<!--]--></strong> (Sentinel自動故障轉移)<!--]--></td><td data-v-5f84e3ba><!--[-->Redis Cluster將資料通過<strong data-v-84b57b07><!--[-->哈希槽分片<!--]--></strong>到多節點，每片一主多從。提供快速讀寫（記憶體操作），但<strong data-v-84b57b07><!--[-->一致性較弱<!--]--></strong>：主節點異步複製到從節點，故障時可能丟失最近更新。採用<strong data-v-84b57b07><!--[-->Gossip<!--]--></strong>協議維護節點拓撲，Sentinel/Cluster Bus選舉新主。2023年後，Redis 7 引入<strong data-v-84b57b07><!--[-->多線程IO<!--]--></strong>與<strong data-v-84b57b07><!--[-->ACL<!--]--></strong>改進，但核心集群架構保持簡潔，以性能和簡易性見長。適用快取場景或對一致性要求不高的即時應用。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->TiKV<!--]--></strong><!--]--></td><td data-v-5f84e3ba><!--[-->分散式事務鍵值庫（TiDB 的KV層）<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->CP<!--]--></strong>   (強一致)<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->Raft 共識<!--]--></strong> (每Region三副本)<!--]--></td><td data-v-5f84e3ba><!--[-->TiKV 專注於強一致儲存，採用 Google Percolator 模型提供<strong data-v-84b57b07><!--[-->分散式ACID交易<!--]--></strong>。透過 Raft 確保複製一致性，每筆資料三副本。近年 PingCAP 將 TiKV 發展為獨立項目，版本7引入<strong data-v-84b57b07><!--[-->Partitioned RaftKV<!--]--></strong>引擎，降低寫放大提升效能。TiKV 在 Cloud Native 社區活躍，KubeCon 2023 發表其支援 PB 級數據與 QoS 改進。它適合作為新一代關係資料庫的存儲引擎或需要強一致性的元資料存儲。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->FoundationDB<!--]--></strong><!--]--></td><td data-v-5f84e3ba><!--[-->分散式多模 KV 庫（底層Key-Value，頂層可映射文檔、SQL等）<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->CP<!--]--></strong> (強一致)<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->主從 + 任務分離<!--]--></strong><br>(分層架構+協調服務)<!--]--></td><td data-v-5f84e3ba><!--[-->FoundationDB 提供<strong data-v-84b57b07><!--[-->嚴格 ACID 交易<!--]--></strong>的鍵值存儲，將事務處理與存儲層解耦。採用類似集中協調節點 (Resolvers) + 多存儲節點 (Storage Servers) 的設計，以<strong data-v-84b57b07><!--[-->樂觀並發控制<!--]--></strong>執行交易，再用<strong data-v-84b57b07><!--[-->多版本<!--]--></strong>確保只讀不鎖定。它的複製也使用類似 Raft 的容錯機制（協調器選舉）。Apple 開源後社群活躍，Snowflake 等公司在內部大量使用。近年版本7引入新存儲引擎 Redwood（B+樹結構）提升大值處理效率。FoundationDB 特點在於可透過「Layer」構建高層資料模型，如文檔、SQL，具<strong data-v-84b57b07><!--[-->通用基礎存儲<!--]--></strong>潛力，同時保持高性能和分散式一致性。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->etcd<!--]--></strong><!--]--></td><td data-v-5f84e3ba><!--[-->分散式一致性KV，主要做配置/註冊<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->CP<!--]--></strong> (強一致)<!--]--></td><td data-v-5f84e3ba><!--[--><strong data-v-84b57b07><!--[-->Raft 共識<!--]--></strong> (3或5節點組)<!--]--></td><td data-v-5f84e3ba><!--[-->etcd 是 Kubernetes 等系統的<strong data-v-84b57b07><!--[-->配置中心<!--]--></strong>，專注小型資料的強一致儲存。透過 Raft 保證線性一致讀寫，常以奇數節點組成（3或5）集群，任何變更需多數同意。等價於<strong data-v-84b57b07><!--[-->決不容忍腦裂<!--]--></strong>、寧可停止服務保證一致性的策略。故在 CAP 上屬 CP 類型，其寫入需要等待同步，大部分操作延遲高於AP系統，但能保證嚴格一致。近年 etcd 強化了快照與壓縮機制減少長期運行時儲存膨脹，並在 Kubernetes 中驗證了其可靠性。不過由於追求一致性，在大量資料存儲上擴展性有限（通常建議數 GB 以內資料量）。<!--]--></td><!--]--></tr><!--]--></tbody><!--]--></table></div><p data-v-9dc9c102><!--[-->指出：<strong data-v-84b57b07><!--[-->Redis/MySQL 僅本地存單副本，而 TiKV/etcd 在三個節點上存三副本（通過 Raft 協議）<!--]--></strong>。這直接反映了它們在 CAP 上的取捨差異——Redis/傳統資料庫多為 CA/單機擴展模式，追求可用性但透過主從複製仍可能有不一致；而 TiKV、etcd 堅持 CP 模式，每次寫都經過多節點一致同意。<!--]--></p><p data-v-9dc9c102><!--[-->總體而言，近年鍵值存儲領域趨勢可以概括為：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->強一致性的崛起：<!--]--></strong> 在雲原生環境下，像 FoundationDB、TiKV、etcd 等強一致KV廣受關注，因為它們簡化了上層應用的邏輯（不用擔心讀到舊數據）。這些系統大都基於共識演算法（Raft/Paxos）實現，隨著網路和算法優化，其性能也逐步提高，可支持越來越大的集群和資料量。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->最終一致性的堅守：<!--]--></strong> 傳統 Dynamo 風格的 AP 系統依然在大規模場景佔有一席，例如 DynamoDB、Cassandra、Riak 等。它們在全球部署、高流量容忍方面具備獨特優勢，並且透過引入<strong data-v-84b57b07><!--[-->輔助功能<!--]--></strong>（如 DynamoDB 提供可選強一致讀），在CAP平衡上提供更多彈性。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->內存與持久化融合：<!--]--></strong> Redis 從純內存Cache演進出 Redis Cluster、再到支援持久化AOF/快照，以及近期的Redis on Flash方案等，說明高速內存KV和持久存儲結合是需求所在。許多系統（如 TiKV 使用 RocksDB LSM 引擎）也著重<strong data-v-84b57b07><!--[-->壓榨硬體<!--]--></strong>性能，包含NVMe、optane等新介質的應用。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->多模與易用性：<!--]--></strong> 新一代KV如 FoundationDB 主打「一個核心，多種模型」，TiKV + TiDB 則展示了將鍵值存儲升級到分散式SQL的可能。這些演進都圍繞讓開發者更容易使用鍵值存儲，同時享受分散式帶來的伸縮與可靠性優勢。<!--]--></li><!--]--></ul><hr data-v-89dedb08><h2 id="以下額外參考" data-v-70b0c1e2><a aria-current="page" href="/code-study/sdi-aig/chapter6#以下額外參考" class="router-link-active router-link-exact-active" data-v-70b0c1e2><!--[-->以下額外參考<!--]--><!----></a></h2><h3 id="資料分區一致性雜湊" data-v-4cf5bb93><a aria-current="page" href="/code-study/sdi-aig/chapter6#資料分區一致性雜湊" class="router-link-active router-link-exact-active" data-v-4cf5bb93><!--[-->資料分區：一致性雜湊<!--]--><!----></a></h3><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Virtual Node、負載平均、動態擴縮<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->程式範例<!--]--></strong>：<code class="" data-v-2f6bd69d><!--[-->ConsistentHashRing<!--]--></code> (C# /.NET 8)<!--]--></li><!--]--></ul><div class="highlight-csharp prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-csharp shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> sealed</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic"> class</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> ConsistentHashRing</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&lt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">T</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&gt;
</span></span><span class="line" line="2"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{
</span></span><span class="line" line="3"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    private</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> readonly</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> SortedDictionary</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&lt;</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">T</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&gt; </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2">_ring</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> new</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">();
</span></span><span class="line" line="4"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    private</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> readonly</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> int</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> _replicas</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">;
</span></span><span class="line" line="5"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    private</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> readonly</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> MD5</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> _md5</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> MD5.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Create</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">();
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    public</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> ConsistentHashRing</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">IEnumerable</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&lt;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">T</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&gt; </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2">nodes</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> replicas</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 160</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="8"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="9"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        _replicas </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> replicas;
</span></span><span class="line" line="10"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        foreach</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> node</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> in</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> nodes) </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">AddNode</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(node);
</span></span><span class="line" line="11"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> void</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> AddNode</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">T</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> node</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="14"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="15"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        for</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> i</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">; i </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">&lt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> _replicas; i</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">++</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="16"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        {
</span></span><span class="line" line="17"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">            var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> hash</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> Hash</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">$&quot;{</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">node</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">}-{</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">i</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">}&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span><span class="line" line="18"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            _ring[hash] </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> node;
</span></span><span class="line" line="19"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }
</span></span><span class="line" line="20"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="21"><span emptylineplaceholder="true">
</span></span><span class="line" line="22"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    public</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> void</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> RemoveNode</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">T</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> node</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="23"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="24"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        for</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> i</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">; i </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">&lt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> _replicas; i</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">++</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="25"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        {
</span></span><span class="line" line="26"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">            var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> hash</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> Hash</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">$&quot;{</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">node</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">}-{</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">i</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">}&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span><span class="line" line="27"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            _ring.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Remove</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(hash);
</span></span><span class="line" line="28"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }
</span></span><span class="line" line="29"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="30"><span emptylineplaceholder="true">
</span></span><span class="line" line="31"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    public</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> T</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> GetNode</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> key</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="32"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="33"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">!</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">_ring.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Any</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">throw</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> new</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline"> InvalidOperationException</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Ring is empty&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">);
</span></span><span class="line" line="34"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">        var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> hash</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> Hash</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(key);
</span></span><span class="line" line="35"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">        var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> kv</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> _ring.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">FirstOrDefault</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2">p</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =&gt;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> p.Key </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">&gt;=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> hash);
</span></span><span class="line" line="36"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> kv.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Equals</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">default</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">KeyValuePair</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&lt;</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline">T</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">&gt;)) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">?</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> _ring.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">First</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">().Value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> kv.Value;
</span></span><span class="line" line="37"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="38"><span emptylineplaceholder="true">
</span></span><span class="line" line="39"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    private</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> int</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> Hash</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">string</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> input</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="40"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    {
</span></span><span class="line" line="41"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic">        var</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2"> bytes</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> =</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> _md5.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">ComputeHash</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(Encoding.UTF8.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">GetBytes</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(input));
</span></span><span class="line" line="42"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> BitConverter.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">ToInt32</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(bytes, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">&amp;</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 0x7FFFFFFF</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">; </span><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">// positive int
</span></span><span class="line" line="43"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="44"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><style>html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}</style><style>
mjx-container[jax=&quot;SVG&quot;] {
  direction: ltr;
}

mjx-container[jax=&quot;SVG&quot;] &gt; svg {
  overflow: visible;
  min-height: 1px;
  min-width: 1px;
}

mjx-container[jax=&quot;SVG&quot;] &gt; svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax=&quot;SVG&quot;][display=&quot;true&quot;] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax=&quot;SVG&quot;][display=&quot;true&quot;][width=&quot;full&quot;] {
  display: flex;
}

mjx-container[jax=&quot;SVG&quot;][justify=&quot;left&quot;] {
  text-align: left;
}

mjx-container[jax=&quot;SVG&quot;][justify=&quot;right&quot;] {
  text-align: right;
}

g[data-mml-node=&quot;merror&quot;] &gt; g {
  fill: red;
  stroke: red;
}

g[data-mml-node=&quot;merror&quot;] &gt; rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node=&quot;mtable&quot;] &gt; line[data-line], svg[data-table] &gt; g &gt; line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node=&quot;mtable&quot;] &gt; rect[data-frame], svg[data-table] &gt; g &gt; rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node=&quot;mtable&quot;] &gt; .mjx-dashed, svg[data-table] &gt; g &gt; .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node=&quot;mtable&quot;] &gt; .mjx-dotted, svg[data-table] &gt; g &gt; .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node=&quot;mtable&quot;] &gt; g &gt; svg {
  overflow: visible;
}

[jax=&quot;SVG&quot;] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax=&quot;SVG&quot;] mjx-tool &gt; mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool &gt; mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node=&quot;maction&quot;][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

mjx-container[jax=&quot;SVG&quot;] path[data-c], mjx-container[jax=&quot;SVG&quot;] use[data-c] {
  stroke-width: 3;
}
</style></div><!--]--><!--]--><!--[--><div class="docs-page-bottom" data-v-03c0998f data-v-70e24a2d><div class="edit-link" data-v-70e24a2d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-70e24a2d style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="currentColor" d="M21 12a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H5a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1m-15 .76V17a1 1 0 0 0 1 1h4.24a1 1 0 0 0 .71-.29l6.92-6.93L21.71 8a1 1 0 0 0 0-1.42l-4.24-4.29a1 1 0 0 0-1.42 0l-2.82 2.83l-6.94 6.93a1 1 0 0 0-.29.71m10.76-8.35l2.83 2.83l-1.42 1.42l-2.83-2.83ZM8 13.17l5.93-5.93l2.83 2.83L10.83 16H8Z"/></svg><!--[--><a href="https://github.com/codesensegroup/code-study/edit/master/content/7.sdi-aig/6.chapter6.md" rel="noopener noreferrer" data-v-70e24a2d data-v-692834dd><!--[--><span data-v-70e24a2d> 在GitHub上在編輯此頁面 </span><!--]--></a><!--]--></div></div><div class="docs-prev-next" data-v-03c0998f data-v-30e1aea1><a href="/code-study/sdi-aig/chapter4" class="prev" data-v-30e1aea1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-30e1aea1 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m11 17l-5-5m0 0l5-5m-5 5h12"/></svg><div class="wrapper" data-v-30e1aea1><span class="directory" data-v-30e1aea1>Sdi Aig</span><span class="title" data-v-30e1aea1>設計網路限速器</span></div></a><!----></div><!--]--></article><div class="toc" data-v-03c0998f><div class="toc-wrapper" data-v-03c0998f><button data-v-03c0998f><span class="title" data-v-03c0998f>Table of Contents</span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-03c0998f style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5l7 7l-7 7"/></svg></button><div class="docs-toc-wrapper" data-v-03c0998f><div class="docs-toc" data-v-03c0998f data-v-ebd2b6b2><!--[--><div class="docs-toc-title" data-v-ebd2b6b2><span data-v-ebd2b6b2>Table of Contents</span></div><ul class="docs-toc-links" data-v-ebd2b6b2 data-v-a97df893><!--[--><li class="depth-2" data-v-a97df893><a href="#整體章節重點-birdeye-view" class="" data-v-a97df893>整體章節重點 (Bird‑Eye View)</a><!----></li><li class="depth-2" data-v-a97df893><a href="#本章要求" class="" data-v-a97df893>本章要求</a><!----></li><li class="depth-2" data-v-a97df893><a href="#session1-從零開始認識-keyvalue-store" class="" data-v-a97df893>Session 1 ： 從零開始認識 Key‑Value Store</a><!----></li><li class="depth-2" data-v-a97df893><a href="#session2-單機設計-vs-分散式挑戰" class="" data-v-a97df893>Session 2 ： 單機設計 v.s. 分散式挑戰</a><!----></li><li class="depth-2" data-v-a97df893><a href="#_1-單一伺服器的鍵值儲存系統" class="" data-v-a97df893>(1) 單一伺服器的鍵值儲存系統：</a><!----></li><li class="depth-2" data-v-a97df893><a href="#_2-分散式鍵值儲存系統" class="" data-v-a97df893>(2) 分散式鍵值儲存系統：</a><!----></li><li class="depth-2" data-v-a97df893><a href="#session3-鍵值儲存系統的構成元素" class="" data-v-a97df893>Session 3 ： 鍵值儲存系統的構成元素</a><!----></li><li class="depth-2" data-v-a97df893><a href="#資料分區一致性雜湊與水平擴充" class="" data-v-a97df893>資料分區：一致性雜湊與水平擴充</a><!----></li><li class="depth-2" data-v-a97df893><a href="#資料複製高可用性的基石" class="" data-v-a97df893>資料複製：高可用性的基石</a><!----></li><li class="depth-2" data-v-a97df893><a href="#一致性quorum-機制與最終一致性" class="" data-v-a97df893>一致性：Quorum 機制與最終一致性</a><!----></li><li class="depth-2" data-v-a97df893><a href="#不一致問題的解決方式版本控制-versioning-與向量時鐘-vector-clock" class="" data-v-a97df893>不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#為什麼叫分量" class="" data-v-a97df893>🔍 為什麼叫「分量」？</a><!----></li><li class="depth-3" data-v-a97df893><a href="#用分量的好處" class="" data-v-a97df893>✅ 用「分量」的好處：</a><!----></li><li class="depth-3" data-v-a97df893><a href="#總結" class="" data-v-a97df893>📘 總結：</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#節點故障與容錯機制gossip-協議sloppy-quorum-與-hinted-handoff" class="" data-v-a97df893>節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff</a><!----></li><li class="depth-2" data-v-a97df893><a href="#回顧一下" class="" data-v-a97df893>📌 回顧一下</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#session-3-階段內容至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰" class="" data-v-a97df893>Session 3 階段內容，至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#最後關注系統的實際架構實作" class="" data-v-a97df893>📌 最後關注系統的實際架構實作</a><!----></li><li class="depth-2" data-v-a97df893><a href="#系統架構圖整體架構與資料存儲引擎" class="" data-v-a97df893>系統架構圖：整體架構與資料存儲引擎</a><!----></li><li class="depth-2" data-v-a97df893><a href="#寫入途徑資料寫入路徑write-path" class="" data-v-a97df893>寫入途徑：資料寫入路徑（Write Path）</a><!----></li><li class="depth-2" data-v-a97df893><a href="#讀取途徑資料讀取路徑read-path" class="" data-v-a97df893>讀取途徑：資料讀取路徑（Read Path）</a><!----></li><li class="depth-2" data-v-a97df893><a href="#session-3-各個組件環環相扣關係的架構圖" class="" data-v-a97df893>Session 3 各個組件環環相扣關係的架構圖：</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#_1-起點分散式需求" class="" data-v-a97df893>1. 起點：分散式需求</a><!----></li><li class="depth-3" data-v-a97df893><a href="#_2-基礎設計資料分區與複製" class="" data-v-a97df893>2. 基礎設計：資料分區與複製</a><!----></li><li class="depth-3" data-v-a97df893><a href="#_3-衍生挑戰一致性問題" class="" data-v-a97df893>3. 衍生挑戰：一致性問題</a><!----></li><li class="depth-3" data-v-a97df893><a href="#_4-解決方案一致性與衝突處理" class="" data-v-a97df893>4. 解決方案：一致性與衝突處理</a><!----></li><li class="depth-3" data-v-a97df893><a href="#_5-進階挑戰節點故障" class="" data-v-a97df893>5. 進階挑戰：節點故障</a><!----></li><li class="depth-3" data-v-a97df893><a href="#_6-最終實現完整系統架構" class="" data-v-a97df893>6. 最終實現：完整系統架構</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#環環相扣的特點" class="" data-v-a97df893>環環相扣的特點：</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#c-最小鍵值存儲-api-實作範例" class="" data-v-a97df893>C# 最小鍵值存儲 API 實作範例</a><!----></li><li class="depth-3" data-v-a97df893><a href="#現代鍵值存儲框架演進與比較-20232025" class="" data-v-a97df893>現代鍵值存儲框架演進與比較 (2023–2025)</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#以下額外參考" class="" data-v-a97df893>以下額外參考</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#資料分區一致性雜湊" class="" data-v-a97df893>資料分區：一致性雜湊</a><!----></li><!--]--></ul></li><!--]--></ul><!--]--></div></div></div></div><!--]--></div></div><!--]--></main><footer class="h-20 relative w-full z-20 text-center flex flex-col items-center justify-center" data-v-5c2f7786 data-v-47825797><div class="font-light" data-v-47825797>© 2022 Code Sense</div><div class="busuanzi flex" data-v-47825797><span class="flex" id="busuanzi_container_site_uv" data-v-47825797><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 20 20" fill="currentColor" class="mt-1 mr-1 w-4 h-4" data-v-47825797><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><span class="site-uv" title="訪客總數" data-v-47825797><span id="busuanzi_value_site_uv" data-v-47825797></span></span></span><span class="mx-2" data-v-47825797>|</span><span class="flex" id="busuanzi_container_site_pv" data-v-47825797><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 20 20" fill="currentColor" class="mt-1 mr-1 w-4 h-4" data-v-47825797><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg><span class="site-pv" title="總瀏覽次數" data-v-47825797><span id="busuanzi_value_site_pv" data-v-47825797></span></span></span></div></footer></div></div><script type="application/json" id="__NUXT_DATA__" data-ssr="true" data-src="/code-study/sdi-aig/chapter6/_payload.json">[{"state":1,"_errors":9876,"serverRendered":5,"path":11,"prerenderedAt":9878},["Reactive",2],{"$scolor-mode":3,"$sdd-pages":7,"$sdd-surrounds":9637,"$sdd-globals":9649,"$sdd-navigation":9651,"$sicons":9845,"$sasideScroll":9867,"$sdocus-docs-aside-collapse-map-/":9868,"$sdocus-docs-aside-collapse-map-/sdi-aig":9869,"$sdocus-docs-aside-collapse-map-/clean-arch":9870,"$sdocus-docs-aside-collapse-map-/ddia":9871,"$sdocus-docs-aside-collapse-map-/cicd-2.0":9872,"$sdocus-docs-aside-collapse-map-/web-api":9873,"$sdocus-docs-aside-collapse-map-/workshop":9874,"$sdocus-docs-aside-collapse-map-/api":9875},{"preference":4,"value":4,"unknown":5,"forced":6},"system",true,false,["ShallowRef",8],["ShallowReactive",9],{"/sdi-aig/chapter6":10},{"_path":11,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":14,"description":15,"pageTitle":16,"body":17,"_type":9632,"_id":9633,"_source":9634,"_file":9635,"_extension":9636,"layout":9356},"/sdi-aig/chapter6","sdi-aig","","設計鍵值儲存系統","ref: CHAPTER 06：DESIGN A KEY-VALUE STORE.md","Chapter 6 設計鍵值儲存系統",{"type":18,"children":19,"toc":9585},"root",[20,37,41,51,61,71,74,83,90,181,186,195,258,334,337,343,412,421,424,430,443,449,539,542,548,564,571,617,623,708,713,720,849,854,863,876,879,884,893,967,1024,1030,1154,1159,1162,1165,1171,1184,1227,1233,1241,1285,1309,1316,1357,1365,1445,1448,1454,1462,1488,1500,1510,1517,1625,1630,1635,1655,1658,1664,1672,1684,1696,1854,1861,1965,1971,1976,1981,2036,2039,2041,2058,2068,2073,2109,2121,2129,2135,2148,2171,2174,2184,2196,2199,2242,2250,2263,2271,2687,2813,2816,2961,2974,2985,3243,3267,3636,3647,4145,4148,4154,4190,4241,4250,4448,4457,4635,4644,5055,5058,5060,5068,5071,5080,5083,5095,5108,5113,5118,5123,5128,5133,5138,5143,5148,5224,5236,5244,5259,5262,5268,5276,5414,5423,5432,5451,5454,5460,5469,5580,5599,5626,5629,5635,5640,5647,5676,5683,5779,5797,5802,5805,5808,5814,5821,5832,5840,5851,5879,5890,5908,5919,5941,5952,5985,5996,6039,6045,6078,6083,6086,6093,6105,6138,6148,6250,6257,6260,6263,6269,6274,6291,6427,6467,6486,7681,7686,7774,7784,7878,7891,7894,7897,7903,7908,8349,8361,8366,8423,8426,8431,8437,8461,9574,9580],{"type":21,"tag":22,"props":23,"children":24},"element","p",{},[25,28],{"type":26,"value":27},"text","ref: ",{"type":21,"tag":29,"props":30,"children":34},"a",{"href":31,"rel":32},"https://github.com/Admol/SystemDesign/blob/main/CHAPTER%2006%EF%BC%9ADESIGN%20A%20KEY-VALUE%20STORE.md",[33],"nofollow",[35],{"type":26,"value":36},"CHAPTER 06：DESIGN A KEY-VALUE STORE.md",{"type":21,"tag":38,"props":39,"children":40},"hr",{},[],{"type":21,"tag":22,"props":42,"children":43},{},[44,45],{"type":26,"value":27},{"type":21,"tag":29,"props":46,"children":49},{"href":47,"rel":48},"https://tw.annas-archive.org/md5/e89be9442169fe8f89a2fda597797668",[33],[50],{"type":26,"value":47},{"type":21,"tag":22,"props":52,"children":53},{},[54,55],{"type":26,"value":27},{"type":21,"tag":29,"props":56,"children":59},{"href":57,"rel":58},"https://www.youtube.com/watch?v=8TE2DvpKxvA",[33],[60],{"type":26,"value":57},{"type":21,"tag":22,"props":62,"children":63},{},[64,65],{"type":26,"value":27},{"type":21,"tag":29,"props":66,"children":69},{"href":67,"rel":68},"https://youtu.be/o6q8zPmfVLU?si=M7Y-FWqM-tuORxn7",[33],[70],{"type":26,"value":67},{"type":21,"tag":38,"props":72,"children":73},{},[],{"type":21,"tag":75,"props":76,"children":77},"blockquote",{},[78],{"type":21,"tag":22,"props":79,"children":80},{},[81],{"type":26,"value":82},"以 C# /.NET 8 與 MSSQL 為主要範例語言／平台，分 2 – 3 次（每次 40‑50 分鐘）循序漸進講解本章重點，並輔以可執行的程式碼片段與示意圖。",{"type":21,"tag":84,"props":85,"children":87},"h2",{"id":86},"整體章節重點-birdeye-view",[88],{"type":26,"value":89},"整體章節重點 (Bird‑Eye View)",{"type":21,"tag":91,"props":92,"children":93},"ol",{},[94,121,131,141,151,161,171],{"type":21,"tag":95,"props":96,"children":97},"li",{},[98,104,106,112,114,119],{"type":21,"tag":99,"props":100,"children":101},"strong",{},[102],{"type":26,"value":103},"Key‑Value Store 基礎",{"type":26,"value":105},"：資料模型、操作介面 (",{"type":21,"tag":107,"props":108,"children":109},"code",{"className":13},[110],{"type":26,"value":111},"put",{"type":26,"value":113}," / ",{"type":21,"tag":107,"props":115,"children":116},{"className":13},[117],{"type":26,"value":118},"get",{"type":26,"value":120},")。",{"type":21,"tag":95,"props":122,"children":123},{},[124,129],{"type":21,"tag":99,"props":125,"children":126},{},[127],{"type":26,"value":128},"擴充挑戰",{"type":26,"value":130},"：從單機記憶體雜湊表 → 分散式雜湊表 (DHT)。",{"type":21,"tag":95,"props":132,"children":133},{},[134,139],{"type":21,"tag":99,"props":135,"children":136},{},[137],{"type":26,"value":138},"CAP 與一致性",{"type":26,"value":140},"：AP / CP 系統選擇、N / W / R 仲裁參數。",{"type":21,"tag":95,"props":142,"children":143},{},[144,149],{"type":21,"tag":99,"props":145,"children":146},{},[147],{"type":26,"value":148},"資料分區與複本",{"type":26,"value":150},"：一致性雜湊、跨資料中心複寫。",{"type":21,"tag":95,"props":152,"children":153},{},[154,159],{"type":21,"tag":99,"props":155,"children":156},{},[157],{"type":26,"value":158},"衝突處理",{"type":26,"value":160},"：Vector Clock、最終一致性。",{"type":21,"tag":95,"props":162,"children":163},{},[164,169],{"type":21,"tag":99,"props":165,"children":166},{},[167],{"type":26,"value":168},"容錯機制",{"type":26,"value":170},"：Gossip 偵錯、Sloppy Quorum、Hinted Handoff、Anti‑Entropy & Merkle Tree。",{"type":21,"tag":95,"props":172,"children":173},{},[174,179],{"type":21,"tag":99,"props":175,"children":176},{},[177],{"type":26,"value":178},"讀寫流程",{"type":26,"value":180},"：Commit Log → MemTable → SSTable；MemTable / Bloom Filter 多層快取。",{"type":21,"tag":84,"props":182,"children":184},{"id":183},"本章要求",[185],{"type":26,"value":183},{"type":21,"tag":187,"props":188,"children":189},"ul",{},[190],{"type":21,"tag":95,"props":191,"children":192},{},[193],{"type":26,"value":194},"設計出一個可支援以下操作的鍵值儲存系統：",{"type":21,"tag":196,"props":197,"children":201},"pre",{"code":198,"language":199,"meta":13,"className":200,"style":13},"  - put(key, value) // 插入一組與「key」鍵相關聯的「vlaue」值\n  - get(key) // 取出與「key」鍵相關聯的「vlaue」值\n","c#","language-c# shiki shiki-themes github-dark github-light monokai",[202],{"type":21,"tag":107,"props":203,"children":204},{"__ignoreMap":13},[205,235],{"type":21,"tag":206,"props":207,"children":210},"span",{"class":208,"line":209},"line",1,[211,217,223,229],{"type":21,"tag":206,"props":212,"children":214},{"style":213},"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672",[215],{"type":26,"value":216},"  -",{"type":21,"tag":206,"props":218,"children":220},{"style":219},"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E",[221],{"type":26,"value":222}," put",{"type":21,"tag":206,"props":224,"children":226},{"style":225},"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2",[227],{"type":26,"value":228},"(key, value) ",{"type":21,"tag":206,"props":230,"children":232},{"style":231},"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F",[233],{"type":26,"value":234},"// 插入一組與「key」鍵相關聯的「vlaue」值\n",{"type":21,"tag":206,"props":236,"children":238},{"class":208,"line":237},2,[239,243,248,253],{"type":21,"tag":206,"props":240,"children":241},{"style":213},[242],{"type":26,"value":216},{"type":21,"tag":206,"props":244,"children":245},{"style":219},[246],{"type":26,"value":247}," get",{"type":21,"tag":206,"props":249,"children":250},{"style":225},[251],{"type":26,"value":252},"(key) ",{"type":21,"tag":206,"props":254,"children":255},{"style":231},[256],{"type":26,"value":257},"// 取出與「key」鍵相關聯的「vlaue」值\n",{"type":21,"tag":187,"props":259,"children":260},{},[261],{"type":21,"tag":95,"props":262,"children":263},{},[264,266,288],{"type":26,"value":265},"瞭解問題並確立設計的範圍",{"type":21,"tag":75,"props":267,"children":268},{},[269],{"type":21,"tag":22,"props":270,"children":271},{},[272,274,278,280,283,285],{"type":26,"value":273},"天底下沒有完美的設計。",{"type":21,"tag":275,"props":276,"children":277},"br",{},[],{"type":26,"value":279},"\n每一種設計都必須在記憶體讀取、寫入與使用方面進行取捨，以達到某種特定的平衡。",{"type":21,"tag":275,"props":281,"children":282},{},[],{"type":26,"value":284},"\n在一致性與可用性之間，也需要進行權衡取捨。",{"type":21,"tag":275,"props":286,"children":287},{},[],{"type":21,"tag":187,"props":289,"children":290},{},[291],{"type":21,"tag":95,"props":292,"children":293},{},[294,296],{"type":26,"value":295},"設計的範圍設定：\n",{"type":21,"tag":187,"props":297,"children":298},{},[299,304,309,314,319,324,329],{"type":21,"tag":95,"props":300,"children":301},{},[302],{"type":26,"value":303},"鍵值對的尺寸很小，小於 10 KB。",{"type":21,"tag":95,"props":305,"children":306},{},[307],{"type":26,"value":308},"有能力儲存大數據資料。",{"type":21,"tag":95,"props":310,"children":311},{},[312],{"type":26,"value":313},"高可用性：即使發生故障，系統也可以快速回應。",{"type":21,"tag":95,"props":315,"children":316},{},[317],{"type":26,"value":318},"高擴展性：系統可進行擴展，以支援大型資料集。",{"type":21,"tag":95,"props":320,"children":321},{},[322],{"type":26,"value":323},"自動擴展：應該可以根據流量，自動添加/移除伺服器。",{"type":21,"tag":95,"props":325,"children":326},{},[327],{"type":26,"value":328},"可調整系統一致性的程度。",{"type":21,"tag":95,"props":330,"children":331},{},[332],{"type":26,"value":333},"低延遲。",{"type":21,"tag":38,"props":335,"children":336},{},[],{"type":21,"tag":84,"props":338,"children":340},{"id":339},"session1-從零開始認識-keyvalue-store",[341],{"type":26,"value":342},"Session 1 ： 從零開始認識 Key‑Value Store",{"type":21,"tag":187,"props":344,"children":345},{},[346,365,384,394,404],{"type":21,"tag":95,"props":347,"children":348},{},[349,351,356,358,363],{"type":26,"value":350},"鍵值資料庫（Key-Value Store，也稱鍵值存儲）是一種",{"type":21,"tag":99,"props":352,"children":353},{},[354],{"type":26,"value":355},"非關聯式資料庫",{"type":26,"value":357},"，以 ",{"type":21,"tag":99,"props":359,"children":360},{},[361],{"type":26,"value":362},"「鍵-值對」",{"type":26,"value":364}," 形式儲存資料。",{"type":21,"tag":95,"props":366,"children":367},{},[368,370,375,377,382],{"type":26,"value":369},"每筆資料由 ",{"type":21,"tag":99,"props":371,"children":372},{},[373],{"type":26,"value":374},"唯一的鍵（key）",{"type":26,"value":376}," 識別並對應一個 ",{"type":21,"tag":99,"props":378,"children":379},{},[380],{"type":26,"value":381},"值（value）",{"type":26,"value":383},"，類似 Dictionary 或 Hash Table 的概念。",{"type":21,"tag":95,"props":385,"children":386},{},[387,392],{"type":21,"tag":99,"props":388,"children":389},{},[390],{"type":26,"value":391},"鍵：",{"type":26,"value":393}," 通常為短字串或其雜湊，須具唯一性以快速索引；",{"type":21,"tag":95,"props":395,"children":396},{},[397,402],{"type":21,"tag":99,"props":398,"children":399},{},[400],{"type":26,"value":401},"值：",{"type":26,"value":403}," 可以是任意類型的二進位資料，系統通常將值視為不透明的blob（例如 Redis、Memcached 即採用此模型）。",{"type":21,"tag":95,"props":405,"children":406},{},[407],{"type":21,"tag":99,"props":408,"children":409},{},[410],{"type":26,"value":411},"主流產品 (Redis、DynamoDB…)",{"type":21,"tag":22,"props":413,"children":414},{},[415],{"type":21,"tag":416,"props":417,"children":420},"img",{"alt":418,"src":419},"alt text","/images/sdi-aig/06/table-6-1.png",[],{"type":21,"tag":38,"props":422,"children":423},{},[],{"type":21,"tag":84,"props":425,"children":427},{"id":426},"session2-單機設計-vs-分散式挑戰",[428],{"type":26,"value":429},"Session 2 ： 單機設計 v.s. 分散式挑戰",{"type":21,"tag":187,"props":431,"children":432},{},[433,438],{"type":21,"tag":95,"props":434,"children":435},{},[436],{"type":26,"value":437},"雜湊表 + 壓縮 + 冷資料落盤",{"type":21,"tag":95,"props":439,"children":440},{},[441],{"type":26,"value":442},"何時需要走向分散式 → 大容量、高可用",{"type":21,"tag":84,"props":444,"children":446},{"id":445},"_1-單一伺服器的鍵值儲存系統",[447],{"type":26,"value":448},"(1) 單一伺服器的鍵值儲存系統：",{"type":21,"tag":187,"props":450,"children":451},{},[452,478,494,515],{"type":21,"tag":95,"props":453,"children":454},{},[455,460],{"type":21,"tag":99,"props":456,"children":457},{},[458],{"type":26,"value":459},"簡單實作：",{"type":21,"tag":187,"props":461,"children":462},{},[463,468,473],{"type":21,"tag":95,"props":464,"children":465},{},[466],{"type":26,"value":467},"最直接的做法就是把「鍵值對」全部放到記憶體。",{"type":21,"tag":95,"props":469,"children":470},{},[471],{"type":26,"value":472},"雜湊表（Hash Table） 在記憶體中保存所有鍵值對。",{"type":21,"tag":95,"props":474,"children":475},{},[476],{"type":26,"value":477},"基本操作包括 put(key, value)（寫入/更新鍵的值）與 get(key)（讀取鍵的值）。",{"type":21,"tag":95,"props":479,"children":480},{},[481,486],{"type":21,"tag":99,"props":482,"children":483},{},[484],{"type":26,"value":485},"資料結構：",{"type":21,"tag":187,"props":487,"children":488},{},[489],{"type":21,"tag":95,"props":490,"children":491},{},[492],{"type":26,"value":493},"使用如 C# 的 Dictionary\u003Cstring, string> 即可達成 O(1) 的鍵查詢時間。",{"type":21,"tag":95,"props":495,"children":496},{},[497,502],{"type":21,"tag":99,"props":498,"children":499},{},[500],{"type":26,"value":501},"記憶體 vs 磁碟：",{"type":21,"tag":187,"props":503,"children":504},{},[505,510],{"type":21,"tag":95,"props":506,"children":507},{},[508],{"type":26,"value":509},"若資料量可能超過記憶體，可透過LRU快取策略將常用資料留在記憶體，不常用資料寫入磁碟檔案；",{"type":21,"tag":95,"props":511,"children":512},{},[513],{"type":26,"value":514},"也可採用資料壓縮減少空間。",{"type":21,"tag":95,"props":516,"children":517},{},[518,523],{"type":21,"tag":99,"props":519,"children":520},{},[521],{"type":26,"value":522},"容量侷限：",{"type":21,"tag":187,"props":524,"children":525},{},[526,531],{"type":21,"tag":95,"props":527,"children":528},{},[529],{"type":26,"value":530},"即使有上述優化，單台伺服器的記憶體與磁碟總有上限，大規模資料最終會超出單機容量。",{"type":21,"tag":95,"props":532,"children":533},{},[534],{"type":21,"tag":99,"props":535,"children":536},{},[537],{"type":26,"value":538},"此時需要水平擴充（scale out）至分散式鍵值存儲架構。",{"type":21,"tag":275,"props":540,"children":541},{},[],{"type":21,"tag":84,"props":543,"children":545},{"id":544},"_2-分散式鍵值儲存系統",[546],{"type":26,"value":547},"(2) 分散式鍵值儲存系統：",{"type":21,"tag":75,"props":549,"children":550},{},[551],{"type":21,"tag":22,"props":552,"children":553},{},[554,556,559,561],{"type":26,"value":555},"分散式鍵值存儲（Distributed Key-Value Store）又稱分散式雜湊表（DHT），透過多部伺服器共同存放整體資料集。",{"type":21,"tag":275,"props":557,"children":558},{},[],{"type":26,"value":560},"\n設計分散式系統時，理解 CAP 定理 極其重要。",{"type":21,"tag":275,"props":562,"children":563},{},[],{"type":21,"tag":565,"props":566,"children":568},"h4",{"id":567},"cap-定理簡介",[569],{"type":26,"value":570},"CAP 定理簡介",{"type":21,"tag":187,"props":572,"children":573},{},[574,579],{"type":21,"tag":95,"props":575,"children":576},{},[577],{"type":26,"value":578},"CAP 定理，又稱 Brewer 定理，由 Eric Brewer 於 2000 年提出，2002 年經 Seth Gilbert 與 Nancy Lynch 形式化證明。",{"type":21,"tag":95,"props":580,"children":581},{},[582,587,589,597,599],{"type":21,"tag":99,"props":583,"children":584},{},[585],{"type":26,"value":586},"定理指出：在一個分散式資料存儲系統中，只能在以下三者中最多同時滿足兩項，無法兼得三者。",{"type":26,"value":588}," (",{"type":21,"tag":29,"props":590,"children":594},{"href":591,"rel":592,"title":593},"https://cloud.tencent.com/developer/article/2355483",[33],"CAP定理一文带你速解（通俗易懂，图文并茂）-腾讯云开发者社区-腾讯云",[595],{"type":26,"value":596},"腾讯云",{"type":26,"value":598},")\n",{"type":21,"tag":187,"props":600,"children":601},{},[602,607,612],{"type":21,"tag":95,"props":603,"children":604},{},[605],{"type":26,"value":606},"一致性 ( Consistency )、",{"type":21,"tag":95,"props":608,"children":609},{},[610],{"type":26,"value":611},"可用性 ( Availability )、",{"type":21,"tag":95,"props":613,"children":614},{},[615],{"type":26,"value":616},"分區容錯性 ( Partition Tolerance )",{"type":21,"tag":618,"props":619,"children":621},"h5",{"id":620},"三大屬性定義",[622],{"type":26,"value":620},{"type":21,"tag":187,"props":624,"children":625},{},[626,654,681],{"type":21,"tag":95,"props":627,"children":628},{},[629,634],{"type":21,"tag":99,"props":630,"children":631},{},[632],{"type":26,"value":633},"一致性 ( Consistency, C )：",{"type":21,"tag":187,"props":635,"children":636},{},[637,642],{"type":21,"tag":95,"props":638,"children":639},{},[640],{"type":26,"value":641},"保證每次讀取都能拿到最新的寫入值，或者返回錯誤，",{"type":21,"tag":95,"props":643,"children":644},{},[645,647,652],{"type":26,"value":646},"也就是「所有節點在同一時間看到相同資料」的強一致性承諾。(",{"type":21,"tag":29,"props":648,"children":650},{"href":591,"rel":649,"title":593},[33],[651],{"type":26,"value":596},{"type":26,"value":653},")",{"type":21,"tag":95,"props":655,"children":656},{},[657,662],{"type":21,"tag":99,"props":658,"children":659},{},[660],{"type":26,"value":661},"可用性 ( Availability, A )：",{"type":21,"tag":187,"props":663,"children":664},{},[665,670],{"type":21,"tag":95,"props":666,"children":667},{},[668],{"type":26,"value":669},"系統對每次請求都能在有限時間內做出響應（非錯誤或超時）。",{"type":21,"tag":95,"props":671,"children":672},{},[673,675,680],{"type":26,"value":674},"即便部分節點失效，健康節點依然對外提供服務。(",{"type":21,"tag":29,"props":676,"children":678},{"href":591,"rel":677,"title":593},[33],[679],{"type":26,"value":596},{"type":26,"value":653},{"type":21,"tag":95,"props":682,"children":683},{},[684,689],{"type":21,"tag":99,"props":685,"children":686},{},[687],{"type":26,"value":688},"分區容錯性 ( Partition Tolerance, P )：",{"type":21,"tag":187,"props":690,"children":691},{},[692,697],{"type":21,"tag":95,"props":693,"children":694},{},[695],{"type":26,"value":696},"當系統節點間發生網路分區（訊息丟失或延遲）時，仍能繼續對外提供服務。",{"type":21,"tag":95,"props":698,"children":699},{},[700,702,707],{"type":26,"value":701},"由於大規模分散式系統中網路分區幾乎不可避免，P 通常被視為必須保障的屬性。(",{"type":21,"tag":29,"props":703,"children":705},{"href":591,"rel":704,"title":593},[33],[706],{"type":26,"value":596},{"type":26,"value":653},{"type":21,"tag":618,"props":709,"children":711},{"id":710},"屬性兩兩組合與典型示例",[712],{"type":26,"value":710},{"type":21,"tag":22,"props":714,"children":715},{},[716],{"type":21,"tag":416,"props":717,"children":719},{"alt":418,"src":718},"/images/sdi-aig/06/img-6-1.png",[],{"type":21,"tag":91,"props":721,"children":722},{},[723,760,802],{"type":21,"tag":95,"props":724,"children":725},{},[726,731],{"type":21,"tag":99,"props":727,"children":728},{},[729],{"type":26,"value":730},"CA（一致性 + 可用性，放棄 P）",{"type":21,"tag":187,"props":732,"children":733},{},[734,739],{"type":21,"tag":95,"props":735,"children":736},{},[737],{"type":26,"value":738},"適用於無須考慮網路分區容錯的場景，",{"type":21,"tag":95,"props":740,"children":741},{},[742,744,749,751,759],{"type":26,"value":743},"例如：",{"type":21,"tag":99,"props":745,"children":746},{},[747],{"type":26,"value":748},"單機或單資料中心部署",{"type":26,"value":750},"的關係型資料庫系統（如 SQL Server 等）。(",{"type":21,"tag":29,"props":752,"children":756},{"href":753,"rel":754,"title":755},"https://en.wikipedia.org/wiki/CAP_theorem?utm_source=chatgpt.com",[33],"CAP theorem - Wikipedia",[757],{"type":26,"value":758},"維基百科",{"type":26,"value":653},{"type":21,"tag":95,"props":761,"children":762},{},[763,768],{"type":21,"tag":99,"props":764,"children":765},{},[766],{"type":26,"value":767},"CP（一致性 + 分區容錯，放棄 A）",{"type":21,"tag":187,"props":769,"children":770},{},[771,781],{"type":21,"tag":95,"props":772,"children":773},{},[774,776],{"type":26,"value":775},"在發生分區容錯時",{"type":21,"tag":99,"props":777,"children":778},{},[779],{"type":26,"value":780},"優先保證強一致性，犧牲可用性。",{"type":21,"tag":95,"props":782,"children":783},{},[784,786,791,793,801],{"type":26,"value":785},"例如：MongoDB，在分區容錯期間會",{"type":21,"tag":99,"props":787,"children":788},{},[789],{"type":26,"value":790},"拒絕服務以確保一致性。",{"type":26,"value":792},"(",{"type":21,"tag":29,"props":794,"children":798},{"href":795,"rel":796,"title":797},"https://stackoverflow.com/questions/11292215/where-does-mongodb-stand-in-the-cap-theorem?utm_source=chatgpt.com",[33],"Where does MongoDB stand in the CAP theorem? - Stack Overflow",[799],{"type":26,"value":800},"Stack Overflow",{"type":26,"value":653},{"type":21,"tag":95,"props":803,"children":804},{},[805,810],{"type":21,"tag":99,"props":806,"children":807},{},[808],{"type":26,"value":809},"AP（可用性 + 分區容錯，放棄 C）",{"type":21,"tag":187,"props":811,"children":812},{},[813,822,830],{"type":21,"tag":95,"props":814,"children":815},{},[816,817],{"type":26,"value":775},{"type":21,"tag":99,"props":818,"children":819},{},[820],{"type":26,"value":821},"優先保證可用性",{"type":21,"tag":95,"props":823,"children":824},{},[825],{"type":21,"tag":99,"props":826,"children":827},{},[828],{"type":26,"value":829},"允許短暫不一致，並透過最終一致性（Reconciliation）進行修復。",{"type":21,"tag":95,"props":831,"children":832},{},[833,835,840,841,848],{"type":26,"value":834},"例如：Apache Cassandra，即使分區容錯期間也繼續響應請求，",{"type":21,"tag":99,"props":836,"children":837},{},[838],{"type":26,"value":839},"可能讀到舊值。",{"type":26,"value":588},{"type":21,"tag":29,"props":842,"children":846},{"href":843,"rel":844,"title":845},"https://stackoverflow.com/questions/20205797/which-part-of-the-cap-theorem-does-cassandra-sacrifice-and-why?utm_source=chatgpt.com",[33],"partitioning - Which part of the CAP theorem does Cassandra sacrifice and why? - Stack Overflow",[847],{"type":26,"value":800},{"type":26,"value":653},{"type":21,"tag":618,"props":850,"children":852},{"id":851},"理想情況",[853],{"type":26,"value":851},{"type":21,"tag":22,"props":855,"children":856},{},[857,861],{"type":21,"tag":416,"props":858,"children":860},{"alt":418,"src":859},"/images/sdi-aig/06/img-6-2.png",[],{"type":26,"value":862},"\n在理想情況下，永遠不會發生網路分區容錯的問題：",{"type":21,"tag":187,"props":864,"children":865},{},[866,871],{"type":21,"tag":95,"props":867,"children":868},{},[869],{"type":26,"value":870},"寫入 n1 的資料自動就會複製到 n2、n3。",{"type":21,"tag":95,"props":872,"children":873},{},[874],{"type":26,"value":875},"如此可達到一致性與可用性。",{"type":21,"tag":275,"props":877,"children":878},{},[],{"type":21,"tag":618,"props":880,"children":882},{"id":881},"現實世界的分散式系統",[883],{"type":26,"value":881},{"type":21,"tag":22,"props":885,"children":886},{},[887,891],{"type":21,"tag":416,"props":888,"children":890},{"alt":418,"src":889},"/images/sdi-aig/06/img-6-3.png",[],{"type":26,"value":892},"\n在真實環境中，網路分區容錯的發生是不可避免的：",{"type":21,"tag":91,"props":894,"children":895},{},[896,922,945],{"type":21,"tag":95,"props":897,"children":898},{},[899,901,906,908,913,915,920],{"type":26,"value":900},"節點 ",{"type":21,"tag":99,"props":902,"children":903},{},[904],{"type":26,"value":905},"n3",{"type":26,"value":907}," 因故離線，無法與 ",{"type":21,"tag":99,"props":909,"children":910},{},[911],{"type":26,"value":912},"n1",{"type":26,"value":914},"、",{"type":21,"tag":99,"props":916,"children":917},{},[918],{"type":26,"value":919},"n2",{"type":26,"value":921}," 溝通；",{"type":21,"tag":95,"props":923,"children":924},{},[925,927,931,933,937,939,943],{"type":26,"value":926},"若客戶端將資料寫入 ",{"type":21,"tag":99,"props":928,"children":929},{},[930],{"type":26,"value":912},{"type":26,"value":932},"／",{"type":21,"tag":99,"props":934,"children":935},{},[936],{"type":26,"value":919},{"type":26,"value":938},"，則資料無法傳遞到 ",{"type":21,"tag":99,"props":940,"children":941},{},[942],{"type":26,"value":905},{"type":26,"value":944},"；",{"type":21,"tag":95,"props":946,"children":947},{},[948,950,954,956,960,961,965],{"type":26,"value":949},"若寫入 ",{"type":21,"tag":99,"props":951,"children":952},{},[953],{"type":26,"value":905},{"type":26,"value":955}," 卻未傳至 ",{"type":21,"tag":99,"props":957,"children":958},{},[959],{"type":26,"value":912},{"type":26,"value":932},{"type":21,"tag":99,"props":962,"children":963},{},[964],{"type":26,"value":919},{"type":26,"value":966},"，則後者只能保有舊版資料。",{"type":21,"tag":187,"props":968,"children":969},{},[970,1002],{"type":21,"tag":95,"props":971,"children":972},{},[973,978],{"type":21,"tag":99,"props":974,"children":975},{},[976],{"type":26,"value":977},"CP 系統（強一致性優先）",{"type":21,"tag":187,"props":979,"children":980},{},[981],{"type":21,"tag":95,"props":982,"children":983},{},[984,986,990,991,995,997,1000],{"type":26,"value":985},"發生分區時，拒絕或延後對 ",{"type":21,"tag":99,"props":987,"children":988},{},[989],{"type":26,"value":912},{"type":26,"value":914},{"type":21,"tag":99,"props":992,"children":993},{},[994],{"type":26,"value":919},{"type":26,"value":996}," 的寫入，確保所有可用節點資料一致，犧牲可用性──",{"type":21,"tag":275,"props":998,"children":999},{},[],{"type":26,"value":1001},"\n銀行系統即屬此類，必須保證餘額一定為最新狀態。",{"type":21,"tag":95,"props":1003,"children":1004},{},[1005,1010],{"type":21,"tag":99,"props":1006,"children":1007},{},[1008],{"type":26,"value":1009},"AP 系統（可用性優先）",{"type":21,"tag":187,"props":1011,"children":1012},{},[1013],{"type":21,"tag":95,"props":1014,"children":1015},{},[1016,1018,1022],{"type":26,"value":1017},"分區期間仍接受讀寫，可能返回舊資料；待網路恢復後再同步至 ",{"type":21,"tag":99,"props":1019,"children":1020},{},[1021],{"type":26,"value":905},{"type":26,"value":1023},"，最終達成一致。",{"type":21,"tag":618,"props":1025,"children":1027},{"id":1026},"設計取捨與面試要點-cap",[1028],{"type":26,"value":1029},"設計取捨與面試要點 - CAP",{"type":21,"tag":187,"props":1031,"children":1032},{},[1033,1072,1128],{"type":21,"tag":95,"props":1034,"children":1035},{},[1036,1041],{"type":21,"tag":99,"props":1037,"children":1038},{},[1039],{"type":26,"value":1040},"為何必須取捨？",{"type":21,"tag":187,"props":1042,"children":1043},{},[1044,1049,1054],{"type":21,"tag":95,"props":1045,"children":1046},{},[1047],{"type":26,"value":1048},"分散式系統中網路分區（P）不可避免，",{"type":21,"tag":95,"props":1050,"children":1051},{},[1052],{"type":26,"value":1053},"當發生分區時，系統無法同時保證既讀取最新值(C)、又對所有請求都做出響應(A)。",{"type":21,"tag":95,"props":1055,"children":1056},{},[1057,1062,1063,1071],{"type":21,"tag":99,"props":1058,"children":1059},{},[1060],{"type":26,"value":1061},"必須在一致性與可用性間做出取捨。",{"type":26,"value":792},{"type":21,"tag":29,"props":1064,"children":1068},{"href":1065,"rel":1066,"title":1067},"https://ruanyifeng.com/blog/2018/07/cap.html?utm_source=chatgpt.com",[33],"CAP 定理的含义 - 阮一峰的网络日志",[1069],{"type":26,"value":1070},"ruanyifeng.com",{"type":26,"value":653},{"type":21,"tag":95,"props":1073,"children":1074},{},[1075,1080],{"type":21,"tag":99,"props":1076,"children":1077},{},[1078],{"type":26,"value":1079},"如何依場景選擇？",{"type":21,"tag":187,"props":1081,"children":1082},{},[1083,1102,1118],{"type":21,"tag":95,"props":1084,"children":1085},{},[1086,1091,1093,1101],{"type":21,"tag":99,"props":1087,"children":1088},{},[1089],{"type":26,"value":1090},"金融支付",{"type":26,"value":1092},"：對資料一致性要求極高，常選 CP ，確保交易正確無誤。(",{"type":21,"tag":29,"props":1094,"children":1098},{"href":1095,"rel":1096,"title":1097},"https://www.ibm.com/think/topics/cap-theorem?utm_source=chatgpt.com",[33],"What is the CAP theorem? - IBM",[1099],{"type":26,"value":1100},"IBM",{"type":26,"value":653},{"type":21,"tag":95,"props":1103,"children":1104},{},[1105,1110,1112,1117],{"type":21,"tag":99,"props":1106,"children":1107},{},[1108],{"type":26,"value":1109},"社交推薦、日誌收集",{"type":26,"value":1111},"：對可用性和吞吐量要求優先，常選 AP 。(",{"type":21,"tag":29,"props":1113,"children":1115},{"href":1095,"rel":1114,"title":1097},[33],[1116],{"type":26,"value":1100},{"type":26,"value":653},{"type":21,"tag":95,"props":1119,"children":1120},{},[1121,1126],{"type":21,"tag":99,"props":1122,"children":1123},{},[1124],{"type":26,"value":1125},"內部管理系統",{"type":26,"value":1127},"：網路分區風險較低，可選 CA 以簡化設計。",{"type":21,"tag":95,"props":1129,"children":1130},{},[1131,1136],{"type":21,"tag":99,"props":1132,"children":1133},{},[1134],{"type":26,"value":1135},"面試常見考察點",{"type":21,"tag":91,"props":1137,"children":1138},{},[1139,1144,1149],{"type":21,"tag":95,"props":1140,"children":1141},{},[1142],{"type":26,"value":1143},"正確認識 C/A/P 三者含義及差異。",{"type":21,"tag":95,"props":1145,"children":1146},{},[1147],{"type":26,"value":1148},"針對不同業務場景，說明為何在 C/A/P 間做出具體取捨。",{"type":21,"tag":95,"props":1150,"children":1151},{},[1152],{"type":26,"value":1153},"以具體系統（如 Key-Value 儲存）為例，闡述如何實現 CAP（Quorum、Hinted Handoff、Anti-Entropy 等機制）。",{"type":21,"tag":22,"props":1155,"children":1156},{},[1157],{"type":26,"value":1158},"透過以上整理，您可在系統設計面試中清晰闡述 CAP 定理，並結合業務需求給出合理架構選擇。",{"type":21,"tag":275,"props":1160,"children":1161},{},[],{"type":21,"tag":38,"props":1163,"children":1164},{},[],{"type":21,"tag":84,"props":1166,"children":1168},{"id":1167},"session3-鍵值儲存系統的構成元素",[1169],{"type":26,"value":1170},"Session 3 ： 鍵值儲存系統的構成元素",{"type":21,"tag":75,"props":1172,"children":1173},{},[1174],{"type":21,"tag":22,"props":1175,"children":1176},{},[1177,1179,1182],{"type":26,"value":1178},"我們打算在本節討論以下這些核心元素與技術，與建構出相應的鍵值儲存系統。 ",{"type":21,"tag":275,"props":1180,"children":1181},{},[],{"type":26,"value":1183},"\n以下內容主要是以三個很受歡迎的鍵值儲存系統為基礎： Dynamo、Cassandra 與 BigTable",{"type":21,"tag":187,"props":1185,"children":1186},{},[1187,1192,1197,1202,1207,1212,1217,1222],{"type":21,"tag":95,"props":1188,"children":1189},{},[1190],{"type":26,"value":1191},"資料分區 ( data partition )",{"type":21,"tag":95,"props":1193,"children":1194},{},[1195],{"type":26,"value":1196},"資料複製 ( data replication )",{"type":21,"tag":95,"props":1198,"children":1199},{},[1200],{"type":26,"value":1201},"一致性",{"type":21,"tag":95,"props":1203,"children":1204},{},[1205],{"type":26,"value":1206},"不一致問題的解決方式",{"type":21,"tag":95,"props":1208,"children":1209},{},[1210],{"type":26,"value":1211},"故障的處理方式",{"type":21,"tag":95,"props":1213,"children":1214},{},[1215],{"type":26,"value":1216},"系統架構圖",{"type":21,"tag":95,"props":1218,"children":1219},{},[1220],{"type":26,"value":1221},"寫入途徑",{"type":21,"tag":95,"props":1223,"children":1224},{},[1225],{"type":26,"value":1226},"讀取途徑",{"type":21,"tag":84,"props":1228,"children":1230},{"id":1229},"資料分區一致性雜湊與水平擴充",[1231],{"type":26,"value":1232},"資料分區：一致性雜湊與水平擴充",{"type":21,"tag":75,"props":1234,"children":1235},{},[1236],{"type":21,"tag":22,"props":1237,"children":1238},{},[1239],{"type":26,"value":1240},"當資料規模龐大時，將全部鍵值對存於單一節點(伺服器)，是一種不可行的做法。",{"type":21,"tag":187,"props":1242,"children":1243},{},[1244,1254],{"type":21,"tag":95,"props":1245,"children":1246},{},[1247,1252],{"type":21,"tag":99,"props":1248,"children":1249},{},[1250],{"type":26,"value":1251},"資料分區（data partition）：",{"type":26,"value":1253}," 將資料拆分到多個節點(伺服器)存放。",{"type":21,"tag":95,"props":1255,"children":1256},{},[1257,1262],{"type":21,"tag":99,"props":1258,"children":1259},{},[1260],{"type":26,"value":1261},"資料分區面臨兩大挑戰：",{"type":21,"tag":91,"props":1263,"children":1264},{},[1265,1275],{"type":21,"tag":95,"props":1266,"children":1267},{},[1268,1273],{"type":21,"tag":99,"props":1269,"children":1270},{},[1271],{"type":26,"value":1272},"資料均勻分布：",{"type":26,"value":1274}," 確保各節點負載均衡，避免有的節點存了過多資料、成為瓶頸。",{"type":21,"tag":95,"props":1276,"children":1277},{},[1278,1283],{"type":21,"tag":99,"props":1279,"children":1280},{},[1281],{"type":26,"value":1282},"動態伸縮：",{"type":26,"value":1284}," 節點數量增加或減少時，儘量減少資料在節點間搬移的成本。",{"type":21,"tag":22,"props":1286,"children":1287},{},[1288,1293,1296,1301,1304],{"type":21,"tag":99,"props":1289,"children":1290},{},[1291],{"type":26,"value":1292},"為解決上述問題",{"type":21,"tag":275,"props":1294,"children":1295},{},[],{"type":21,"tag":99,"props":1297,"children":1298},{},[1299],{"type":26,"value":1300},"一致性雜湊（Consistent Hashing）是一種經典技術。",{"type":21,"tag":275,"props":1302,"children":1303},{},[],{"type":21,"tag":99,"props":1305,"children":1306},{},[1307],{"type":26,"value":1308},"一致性雜湊：將整個雜湊值空間組織成一個雜湊環（Hash Ring）然後將節點和資料鍵都映射到此環上。",{"type":21,"tag":22,"props":1310,"children":1311},{},[1312],{"type":21,"tag":416,"props":1313,"children":1315},{"alt":418,"src":1314},"/images/sdi-aig/06/img-6-4.png",[],{"type":21,"tag":187,"props":1317,"children":1318},{},[1319,1324,1329],{"type":21,"tag":95,"props":1320,"children":1321},{},[1322],{"type":26,"value":1323},"首先，伺服器會被放到雜湊環上。在圖 6-4 中， s0、s1、....、s7 所代表的8部伺服器全都被放到雜湊環上。",{"type":21,"tag":95,"props":1325,"children":1326},{},[1327],{"type":26,"value":1328},"接著，有一個鍵也進行了雜湊運算，而被放到了同一個雜湊環上。",{"type":21,"tag":95,"props":1330,"children":1331},{},[1332,1337],{"type":21,"tag":99,"props":1333,"children":1334},{},[1335],{"type":26,"value":1336},"存放規則：",{"type":21,"tag":187,"props":1338,"children":1339},{},[1340,1352],{"type":21,"tag":95,"props":1341,"children":1342},{},[1343,1345,1350],{"type":26,"value":1344},"從資料鍵映射點 ",{"type":21,"tag":99,"props":1346,"children":1347},{},[1348],{"type":26,"value":1349},"順時針",{"type":26,"value":1351}," 遇到的第一個節點，即為此鍵的負責節點。",{"type":21,"tag":95,"props":1353,"children":1354},{},[1355],{"type":26,"value":1356},"key0 運用存放規則的邏輯，最後保存到 s1 之中。",{"type":21,"tag":22,"props":1358,"children":1359},{},[1360],{"type":21,"tag":99,"props":1361,"children":1362},{},[1363],{"type":26,"value":1364},"一致性雜湊的優點：",{"type":21,"tag":187,"props":1366,"children":1367},{},[1368,1401,1417],{"type":21,"tag":95,"props":1369,"children":1370},{},[1371,1376],{"type":21,"tag":99,"props":1372,"children":1373},{},[1374],{"type":26,"value":1375},"自動水平擴充：",{"type":21,"tag":187,"props":1377,"children":1378},{},[1379,1384,1396],{"type":21,"tag":95,"props":1380,"children":1381},{},[1382],{"type":26,"value":1383},"可平滑地新增/移除節點而無需重新分配全部鍵。",{"type":21,"tag":95,"props":1385,"children":1386},{},[1387,1389,1394],{"type":26,"value":1388},"加入節點，只需重新分配",{"type":21,"tag":99,"props":1390,"children":1391},{},[1392],{"type":26,"value":1393},"鄰近區域",{"type":26,"value":1395},"的一部分鍵；",{"type":21,"tag":95,"props":1397,"children":1398},{},[1399],{"type":26,"value":1400},"移除節點，其負載自動攤分給鄰近節點。這滿足動態擴縮需求。",{"type":21,"tag":95,"props":1402,"children":1403},{},[1404,1409],{"type":21,"tag":99,"props":1405,"children":1406},{},[1407],{"type":26,"value":1408},"最小資料搬移：",{"type":21,"tag":187,"props":1410,"children":1411},{},[1412],{"type":21,"tag":95,"props":1413,"children":1414},{},[1415],{"type":26,"value":1416},"新增或移除節點時，只需移動環上極少量鍵，不影響其它區段的資料。",{"type":21,"tag":95,"props":1418,"children":1419},{},[1420,1425],{"type":21,"tag":99,"props":1421,"children":1422},{},[1423],{"type":26,"value":1424},"負載均衡 ( 可因應 不均勻性/異質性 的問題 )：",{"type":21,"tag":187,"props":1426,"children":1427},{},[1428,1440],{"type":21,"tag":95,"props":1429,"children":1430},{},[1431,1433,1438],{"type":26,"value":1432},"結合",{"type":21,"tag":99,"props":1434,"children":1435},{},[1436],{"type":26,"value":1437},"虛擬節點",{"type":26,"value":1439},"機制，能讓節點根據性能配置不同數量的虛擬節點，避免因節點性能差異導致負載不均（容量越大的節點可在環上放置更多虛擬節點，獲取較大區間的鍵）。",{"type":21,"tag":95,"props":1441,"children":1442},{},[1443],{"type":26,"value":1444},"例： 如果某個伺服器的容量比較大，只要指定比較多的虛擬節點給它就可以了。",{"type":21,"tag":275,"props":1446,"children":1447},{},[],{"type":21,"tag":84,"props":1449,"children":1451},{"id":1450},"資料複製高可用性的基石",[1452],{"type":26,"value":1453},"資料複製：高可用性的基石",{"type":21,"tag":75,"props":1455,"children":1456},{},[1457],{"type":21,"tag":22,"props":1458,"children":1459},{},[1460],{"type":26,"value":1461},"為了達到高可用性與可靠性 ( relibility )",{"type":21,"tag":22,"props":1463,"children":1464},{},[1465,1467,1472,1474,1479,1481,1486],{"type":26,"value":1466},"為提升系統",{"type":21,"tag":99,"props":1468,"children":1469},{},[1470],{"type":26,"value":1471},"容錯性",{"type":26,"value":1473},"與",{"type":21,"tag":99,"props":1475,"children":1476},{},[1477],{"type":26,"value":1478},"高可用性",{"type":26,"value":1480},"，分散式鍵值存儲通常將資料 ",{"type":21,"tag":99,"props":1482,"children":1483},{},[1484],{"type":26,"value":1485},"複製（Replication）",{"type":26,"value":1487}," 至多個節點。",{"type":21,"tag":22,"props":1489,"children":1490},{},[1491,1493,1498],{"type":26,"value":1492},"也就是對每個鍵值對保存多份拷貝，放置於",{"type":21,"tag":99,"props":1494,"children":1495},{},[1496],{"type":26,"value":1497},"不同節點",{"type":26,"value":1499},"，當部分節點故障時仍能由其他副本提供服務。",{"type":21,"tag":22,"props":1501,"children":1502},{},[1503,1505],{"type":26,"value":1504},"常用的複製策略如下： ",{"type":21,"tag":99,"props":1506,"children":1507},{},[1508],{"type":26,"value":1509},"key0 會被複製到 s1 、 s2 、 s3 ( N=3 )",{"type":21,"tag":22,"props":1511,"children":1512},{},[1513],{"type":21,"tag":416,"props":1514,"children":1516},{"alt":418,"src":1515},"/images/sdi-aig/06/img-6-5.png",[],{"type":21,"tag":187,"props":1518,"children":1519},{},[1520,1541,1597],{"type":21,"tag":95,"props":1521,"children":1522},{},[1523,1528],{"type":21,"tag":99,"props":1524,"children":1525},{},[1526],{"type":26,"value":1527},"複製因子 N：就是儲存 N 份",{"type":21,"tag":187,"props":1529,"children":1530},{},[1531,1536],{"type":21,"tag":95,"props":1532,"children":1533},{},[1534],{"type":26,"value":1535},"每筆資料儲存 N 份（包含原始1份+ N-1份副本）",{"type":21,"tag":95,"props":1537,"children":1538},{},[1539],{"type":26,"value":1540},"例如： N=3，此時系統至少需有 N 個節點才能容納所有副本。",{"type":21,"tag":95,"props":1542,"children":1543},{},[1544,1549],{"type":21,"tag":99,"props":1545,"children":1546},{},[1547],{"type":26,"value":1548},"副本選擇：必須確保節點不重複",{"type":21,"tag":187,"props":1550,"children":1551},{},[1552,1562],{"type":21,"tag":95,"props":1553,"children":1554},{},[1555,1557],{"type":26,"value":1556},"Key0 先按上述一致性雜湊的方式找到",{"type":21,"tag":99,"props":1558,"children":1559},{},[1560],{"type":26,"value":1561},"主存節點",{"type":21,"tag":95,"props":1563,"children":1564},{},[1565,1567,1572,1574],{"type":26,"value":1566},"再沿雜湊環",{"type":21,"tag":99,"props":1568,"children":1569},{},[1570],{"type":26,"value":1571},"順時針方向選擇接續的 N-1 個",{"type":26,"value":1573},"獨立節點作為副本存放處。\n",{"type":21,"tag":187,"props":1575,"children":1576},{},[1577,1582,1587],{"type":21,"tag":95,"props":1578,"children":1579},{},[1580],{"type":26,"value":1581},"例如 N=3 時，",{"type":21,"tag":95,"props":1583,"children":1584},{},[1585],{"type":26,"value":1586},"key0 可存於 s1（主）以及後續的 s2、s3 節點上，共三副本。",{"type":21,"tag":95,"props":1588,"children":1589},{},[1590,1592],{"type":26,"value":1591},"若遇到",{"type":21,"tag":99,"props":1593,"children":1594},{},[1595],{"type":26,"value":1596},"虛擬節點映射同一實體節點的情況，則跳過重複實體以確保副本分散在不同實體節點。",{"type":21,"tag":95,"props":1598,"children":1599},{},[1600,1605],{"type":21,"tag":99,"props":1601,"children":1602},{},[1603],{"type":26,"value":1604},"跨機房分佈：提高可靠性",{"type":21,"tag":187,"props":1606,"children":1607},{},[1608,1620],{"type":21,"tag":95,"props":1609,"children":1610},{},[1611,1613,1618],{"type":26,"value":1612},"為防同機房故障導致副本同時損失，通常會將 N 個副本分布在",{"type":21,"tag":99,"props":1614,"children":1615},{},[1616],{"type":26,"value":1617},"多個資料中心",{"type":26,"value":1619},"。",{"type":21,"tag":95,"props":1621,"children":1622},{},[1623],{"type":26,"value":1624},"例如：3個副本可放在三個不同機房，透過高速網路互聯同步。",{"type":21,"tag":22,"props":1626,"children":1627},{},[1628],{"type":26,"value":1629},"透過適當的複製策略，可以實現讀取的高可用：",{"type":21,"tag":22,"props":1631,"children":1632},{},[1633],{"type":26,"value":1634},"即使一兩個節點故障，資料的其他副本仍可提供服務。同時多副本也提高了資料耐久性（不易因單點損毀而永久丟失）。",{"type":21,"tag":75,"props":1636,"children":1637},{},[1638],{"type":21,"tag":22,"props":1639,"children":1640},{},[1641,1646,1648,1653],{"type":21,"tag":99,"props":1642,"children":1643},{},[1644],{"type":26,"value":1645},"註：",{"type":26,"value":1647}," 複製帶來",{"type":21,"tag":99,"props":1649,"children":1650},{},[1651],{"type":26,"value":1652},"一致性維護",{"type":26,"value":1654},"的挑戰 —— 當多個副本存在時，如何確保各副本的值一致，是後續「一致性」與「衝突解決」部分要解決的問題。",{"type":21,"tag":275,"props":1656,"children":1657},{},[],{"type":21,"tag":84,"props":1659,"children":1661},{"id":1660},"一致性quorum-機制與最終一致性",[1662],{"type":26,"value":1663},"一致性：Quorum 機制與最終一致性",{"type":21,"tag":75,"props":1665,"children":1666},{},[1667],{"type":21,"tag":22,"props":1668,"children":1669},{},[1670],{"type":26,"value":1671},"如果沒有額外措施，不同副本可能出現數據不一致（如有的收到更新，有的因網路問題未收到）。",{"type":21,"tag":22,"props":1673,"children":1674},{},[1675,1677,1682],{"type":26,"value":1676},"如前所述，將資料複製到多個節點可以提高可用性，但也帶來",{"type":21,"tag":99,"props":1678,"children":1679},{},[1680],{"type":26,"value":1681},"副本間數據同步",{"type":26,"value":1683},"的難題。",{"type":21,"tag":22,"props":1685,"children":1686},{},[1687,1689,1694],{"type":26,"value":1688},"為管理一致性，可採用 ",{"type":21,"tag":99,"props":1690,"children":1691},{},[1692],{"type":26,"value":1693},"Quorum 共識機制",{"type":26,"value":1695},"調節讀寫操作：",{"type":21,"tag":187,"props":1697,"children":1698},{},[1699,1740],{"type":21,"tag":95,"props":1700,"children":1701},{},[1702,1707],{"type":21,"tag":99,"props":1703,"children":1704},{},[1705],{"type":26,"value":1706},"定義：",{"type":21,"tag":187,"props":1708,"children":1709},{},[1710,1720,1730],{"type":21,"tag":95,"props":1711,"children":1712},{},[1713,1718],{"type":21,"tag":99,"props":1714,"children":1715},{},[1716],{"type":26,"value":1717},"N：",{"type":26,"value":1719}," 副本的數量 ( 如下圖 6-6，N=3 )。",{"type":21,"tag":95,"props":1721,"children":1722},{},[1723,1728],{"type":21,"tag":99,"props":1724,"children":1725},{},[1726],{"type":26,"value":1727},"W：",{"type":26,"value":1729}," 寫入的最低門檻，寫入操作必須至少有 W 個副本回應確認，才視為寫入成功。",{"type":21,"tag":95,"props":1731,"children":1732},{},[1733,1738],{"type":21,"tag":99,"props":1734,"children":1735},{},[1736],{"type":26,"value":1737},"R：",{"type":26,"value":1739}," 讀取的最低門檻，讀取操作必須等待至少有 R 個副本回應，才視為讀取成功。",{"type":21,"tag":95,"props":1741,"children":1742},{},[1743,1748,1750],{"type":21,"tag":99,"props":1744,"children":1745},{},[1746],{"type":26,"value":1747},"運作：",{"type":26,"value":1749}," 以圖 6-6 為例 N=3 資料被製到 s0、s1、s2。",{"type":21,"tag":187,"props":1751,"children":1752},{},[1753,1763,1805,1833],{"type":21,"tag":95,"props":1754,"children":1755},{},[1756,1761],{"type":21,"tag":99,"props":1757,"children":1758},{},[1759],{"type":26,"value":1760},"協調者 ( coordinator ) ：",{"type":26,"value":1762}," 代表客戶端與節點之間代理者 ( proxy ) 的角色。",{"type":21,"tag":95,"props":1764,"children":1765},{},[1766,1771,1773,1778,1780,1785,1787],{"type":21,"tag":99,"props":1767,"children":1768},{},[1769],{"type":26,"value":1770},"W=1：",{"type":26,"value":1772}," 每次",{"type":21,"tag":99,"props":1774,"children":1775},{},[1776],{"type":26,"value":1777},"寫入",{"type":26,"value":1779},"，協調者",{"type":21,"tag":99,"props":1781,"children":1782},{},[1783],{"type":26,"value":1784},"必須至少收到一個 ACK 確認",{"type":26,"value":1786},"，才能回覆客戶端成功。",{"type":21,"tag":187,"props":1788,"children":1789},{},[1790,1800],{"type":21,"tag":95,"props":1791,"children":1792},{},[1793,1795],{"type":26,"value":1794},"不代表資料只寫入",{"type":21,"tag":99,"props":1796,"children":1797},{},[1798],{"type":26,"value":1799},"1個節點",{"type":21,"tag":95,"props":1801,"children":1802},{},[1803],{"type":26,"value":1804},"如果從 s1 收到了確認，就不需要再等待 s0 與 s2 的確認了。",{"type":21,"tag":95,"props":1806,"children":1807},{},[1808,1813,1814,1818,1819,1824,1825],{"type":21,"tag":99,"props":1809,"children":1810},{},[1811],{"type":26,"value":1812},"W=2：",{"type":26,"value":1772},{"type":21,"tag":99,"props":1815,"children":1816},{},[1817],{"type":26,"value":1777},{"type":26,"value":1779},{"type":21,"tag":99,"props":1820,"children":1821},{},[1822],{"type":26,"value":1823},"必須至少收到二個 ACK 確認",{"type":26,"value":1786},{"type":21,"tag":187,"props":1826,"children":1827},{},[1828],{"type":21,"tag":95,"props":1829,"children":1830},{},[1831],{"type":26,"value":1832},"如果從 s1 收到了確認，要再等待 s0 或 s2 的確認。",{"type":21,"tag":95,"props":1834,"children":1835},{},[1836,1841,1842,1847,1848,1853],{"type":21,"tag":99,"props":1837,"children":1838},{},[1839],{"type":26,"value":1840},"R=2：",{"type":26,"value":1772},{"type":21,"tag":99,"props":1843,"children":1844},{},[1845],{"type":26,"value":1846},"讀取",{"type":26,"value":1779},{"type":21,"tag":99,"props":1849,"children":1850},{},[1851],{"type":26,"value":1852},"會並行查詢至少2個副本，並等待回應，最後取其中最新版本後再返回",{"type":26,"value":1786},{"type":21,"tag":22,"props":1855,"children":1856},{},[1857],{"type":21,"tag":416,"props":1858,"children":1860},{"alt":418,"src":1859},"/images/sdi-aig/06/img-6-6.png",[],{"type":21,"tag":187,"props":1862,"children":1863},{},[1864,1890],{"type":21,"tag":95,"props":1865,"children":1866},{},[1867,1872],{"type":21,"tag":99,"props":1868,"children":1869},{},[1870],{"type":26,"value":1871},"延遲 vs 一致性：",{"type":21,"tag":187,"props":1873,"children":1874},{},[1875,1880,1885],{"type":21,"tag":95,"props":1876,"children":1877},{},[1878],{"type":26,"value":1879},"W、R 的選擇代表延遲與一致性的權衡。",{"type":21,"tag":95,"props":1881,"children":1882},{},[1883],{"type":26,"value":1884},"W或R越小：操作響應越快，但返回舊數據的風險增大。",{"type":21,"tag":95,"props":1886,"children":1887},{},[1888],{"type":26,"value":1889},"W或R越大：數據一致性越好，但需等待更多節點，延遲提高。",{"type":21,"tag":95,"props":1891,"children":1892},{},[1893,1898],{"type":21,"tag":99,"props":1894,"children":1895},{},[1896],{"type":26,"value":1897},"強一致性保證的條件：",{"type":21,"tag":187,"props":1899,"children":1900},{},[1901,1917,1931,1948],{"type":21,"tag":95,"props":1902,"children":1903},{},[1904,1909,1911,1915],{"type":21,"tag":99,"props":1905,"children":1906},{},[1907],{"type":26,"value":1908},"W=N + R=1 ：",{"type":26,"value":1910}," 就表示系統針對快速",{"type":21,"tag":99,"props":1912,"children":1913},{},[1914],{"type":26,"value":1846},{"type":26,"value":1916},"進行最佳化。",{"type":21,"tag":95,"props":1918,"children":1919},{},[1920,1925,1926,1930],{"type":21,"tag":99,"props":1921,"children":1922},{},[1923],{"type":26,"value":1924},"W=1 + R=N ：",{"type":26,"value":1910},{"type":21,"tag":99,"props":1927,"children":1928},{},[1929],{"type":26,"value":1777},{"type":26,"value":1916},{"type":21,"tag":95,"props":1932,"children":1933},{},[1934,1939,1941,1946],{"type":21,"tag":99,"props":1935,"children":1936},{},[1937],{"type":26,"value":1938},"W + R > N ：",{"type":26,"value":1940}," 就可以",{"type":21,"tag":99,"props":1942,"children":1943},{},[1944],{"type":26,"value":1945},"具有強一致性",{"type":26,"value":1947},"。因為任意一筆資料的讀寫集合會在至少一個共同副本相交，確保讀一定能讀到最新寫入。(例如 N=3，W=R=2)",{"type":21,"tag":95,"props":1949,"children":1950},{},[1951,1956,1958,1963],{"type":21,"tag":99,"props":1952,"children":1953},{},[1954],{"type":26,"value":1955},"W + R \u003C= N ：",{"type":26,"value":1957}," 則",{"type":21,"tag":99,"props":1959,"children":1960},{},[1961],{"type":26,"value":1962},"不能保證",{"type":26,"value":1964},"具有強一致性。",{"type":21,"tag":618,"props":1966,"children":1968},{"id":1967},"設計取捨與面試要點-一致性模型",[1969],{"type":26,"value":1970},"設計取捨與面試要點 - 一致性模型",{"type":21,"tag":22,"props":1972,"children":1973},{},[1974],{"type":26,"value":1975},"在設計鍵值儲存系統時，一致性模型確實是一個需要考慮的重要因素。",{"type":21,"tag":22,"props":1977,"children":1978},{},[1979],{"type":26,"value":1980},"一致性模型定義的是資料一致性程度，而實際上確實存在各式各樣不同的一致性模型：",{"type":21,"tag":187,"props":1982,"children":1983},{},[1984,1999,2014],{"type":21,"tag":95,"props":1985,"children":1986},{},[1987,1992,1994],{"type":21,"tag":99,"props":1988,"children":1989},{},[1990],{"type":26,"value":1991},"強一致性：",{"type":26,"value":1993}," 任何讀取操作所送回的值，都對應到最新寫入資料項的結果。",{"type":21,"tag":99,"props":1995,"children":1996},{},[1997],{"type":26,"value":1998},"客戶端絕不會看到過時的資料。",{"type":21,"tag":95,"props":2000,"children":2001},{},[2002,2007,2009],{"type":21,"tag":99,"props":2003,"children":2004},{},[2005],{"type":26,"value":2006},"弱一致性：",{"type":26,"value":2008}," 後續的讀取操作有可能看到的並不是最新的值。",{"type":21,"tag":99,"props":2010,"children":2011},{},[2012],{"type":26,"value":2013},"客戶端可能不是最新的資料。",{"type":21,"tag":95,"props":2015,"children":2016},{},[2017,2022,2024,2029,2031],{"type":21,"tag":99,"props":2018,"children":2019},{},[2020],{"type":26,"value":2021},"最終一致性 ( eventual consistency )：",{"type":26,"value":2023}," ",{"type":21,"tag":99,"props":2025,"children":2026},{},[2027],{"type":26,"value":2028},"弱一致性的殊殊形式",{"type":26,"value":2030},"，只要給定足夠的時間，所有資料更新終究都會被傳遞，且所有副本都會是一致的。",{"type":21,"tag":99,"props":2032,"children":2033},{},[2034],{"type":26,"value":2035},"客戶端會現是等待最新資料的過程。",{"type":21,"tag":275,"props":2037,"children":2038},{},[],{"type":26,"value":2040},"\n在我們設計的系統中，\n",{"type":21,"tag":22,"props":2042,"children":2043},{},[2044,2049,2051,2056],{"type":21,"tag":99,"props":2045,"children":2046},{},[2047],{"type":26,"value":2048},"為了高可用性",{"type":26,"value":2050},"，預設採用 ",{"type":21,"tag":99,"props":2052,"children":2053},{},[2054],{"type":26,"value":2055},"最終一致性 ( eventual consistency )",{"type":26,"value":2057}," 模型，",{"type":21,"tag":22,"props":2059,"children":2060},{},[2061,2063],{"type":26,"value":2062},"即 AP 模式： ",{"type":21,"tag":107,"props":2064,"children":2065},{"className":13},[2066],{"type":26,"value":2067},"允許在短暫時間內副本之間數據不一致，但保證最終（在沒有新的更新後經過足夠時間）所有副本趨於一致。",{"type":21,"tag":22,"props":2069,"children":2070},{},[2071],{"type":26,"value":2072},"這意味：",{"type":21,"tag":187,"props":2074,"children":2075},{},[2076,2087,2099],{"type":21,"tag":95,"props":2077,"children":2078},{},[2079,2081,2086],{"type":26,"value":2080},"系統在寫入時不強制所有副本立即同步成功即可返回成功（如採用 W \u003C N），因此短期內不同節點可能讀到",{"type":21,"tag":99,"props":2082,"children":2083},{},[2084],{"type":26,"value":2085},"舊值",{"type":26,"value":1619},{"type":21,"tag":95,"props":2088,"children":2089},{},[2090,2092,2097],{"type":26,"value":2091},"系統在背景持續同步副本，或透過讀取修復機制，確保",{"type":21,"tag":99,"props":2093,"children":2094},{},[2095],{"type":26,"value":2096},"最終",{"type":26,"value":2098},"各副本一致。",{"type":21,"tag":95,"props":2100,"children":2101},{},[2102,2107],{"type":21,"tag":99,"props":2103,"children":2104},{},[2105],{"type":26,"value":2106},"最終一致性容忍暫時不一致",{"type":26,"value":2108},"，換取故障情況下仍可接受讀/寫請求（提高可用性）。例如 Dynamo、Cassandra 即採此模型。",{"type":21,"tag":22,"props":2110,"children":2111},{},[2112,2114,2119],{"type":26,"value":2113},"然而，最終一致性模型下，不可避免會出現",{"type":21,"tag":99,"props":2115,"children":2116},{},[2117],{"type":26,"value":2118},"更新衝突",{"type":26,"value":2120},"的問題：",{"type":21,"tag":187,"props":2122,"children":2123},{},[2124],{"type":21,"tag":95,"props":2125,"children":2126},{},[2127],{"type":26,"value":2128},"當網路分區或並發寫入發生時，不同節點可能各自接受了對同一鍵的不同更新，導致系統存在多個版本的值。接下來我們將介紹如何檢測與解決這些衝突。",{"type":21,"tag":84,"props":2130,"children":2132},{"id":2131},"不一致問題的解決方式版本控制-versioning-與向量時鐘-vector-clock",[2133],{"type":26,"value":2134},"不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )",{"type":21,"tag":75,"props":2136,"children":2137},{},[2138],{"type":21,"tag":22,"props":2139,"children":2140},{},[2141,2143,2146],{"type":26,"value":2142},"複製：提高可用性，同時也導致副本間產生不一致的問題。",{"type":21,"tag":275,"props":2144,"children":2145},{},[],{"type":26,"value":2147},"\n因此，我們需要一個能夠偵測衝突與協調衝突的版本控制系統。",{"type":21,"tag":187,"props":2149,"children":2150},{},[2151,2161],{"type":21,"tag":95,"props":2152,"children":2153},{},[2154,2159],{"type":21,"tag":99,"props":2155,"children":2156},{},[2157],{"type":26,"value":2158},"版本控制：",{"type":26,"value":2160}," 把每次的資料修改，全都視為資料的一個全新不可變版本。",{"type":21,"tag":95,"props":2162,"children":2163},{},[2164,2169],{"type":21,"tag":99,"props":2165,"children":2166},{},[2167],{"type":26,"value":2168},"向量時鐘：",{"type":26,"value":2170}," 解決兩個版本衝突此類問題的常用技術。",{"type":21,"tag":275,"props":2172,"children":2173},{},[],{"type":21,"tag":22,"props":2175,"children":2176},{},[2177,2182],{"type":21,"tag":99,"props":2178,"children":2179},{},[2180],{"type":26,"value":2181},"版本衝突問題舉例：",{"type":26,"value":2183}," 圖6-7 －＞ 圖6-8",{"type":21,"tag":187,"props":2185,"children":2186},{},[2187],{"type":21,"tag":95,"props":2188,"children":2189},{},[2190,2192],{"type":26,"value":2191},"有 2 個副本 n1 與 n2 具有相同 key=\"name\" 並且值相同為 \"john\" ，我們稱為原始值。 ( 圖 6-7 )\n",{"type":21,"tag":416,"props":2193,"children":2195},{"alt":418,"src":2194},"/images/sdi-aig/06/img-6-7.png",[],{"type":21,"tag":275,"props":2197,"children":2198},{},[],{"type":21,"tag":187,"props":2200,"children":2201},{},[2202,2207,2212],{"type":21,"tag":95,"props":2203,"children":2204},{},[2205],{"type":26,"value":2206},"某刻 Client A 通過節點 n1 將 name 更新為值 \"johnSanFrancisco\"",{"type":21,"tag":95,"props":2208,"children":2209},{},[2210],{"type":26,"value":2211},"同時 Client B 通過節點 n2 將 name 更新為值 \"johnNewYork\"",{"type":21,"tag":95,"props":2213,"children":2214},{},[2215,2217,2222,2224,2229,2231,2236,2238],{"type":26,"value":2216},"由於 A、B 幾乎",{"type":21,"tag":99,"props":2218,"children":2219},{},[2220],{"type":26,"value":2221},"同時寫入",{"type":26,"value":2223},"，且",{"type":21,"tag":99,"props":2225,"children":2226},{},[2227],{"type":26,"value":2228},"寫入不同節點",{"type":26,"value":2230},"。 2個副本各自被更新為",{"type":21,"tag":99,"props":2232,"children":2233},{},[2234],{"type":26,"value":2235},"不同值",{"type":26,"value":2237},"。( 圖 6-8 )\n",{"type":21,"tag":416,"props":2239,"children":2241},{"alt":418,"src":2240},"/images/sdi-aig/06/img-6-8.png",[],{"type":21,"tag":22,"props":2243,"children":2244},{},[2245],{"type":21,"tag":99,"props":2246,"children":2247},{},[2248],{"type":26,"value":2249},"產生衝突版本：",{"type":21,"tag":187,"props":2251,"children":2252},{},[2253,2258],{"type":21,"tag":95,"props":2254,"children":2255},{},[2256],{"type":26,"value":2257},"key=\"name\" 產生兩個衝突值： v1（值=\"johnSanFrancisco\"）與 v2（值=\"johnNewYork\"）。",{"type":21,"tag":95,"props":2259,"children":2260},{},[2261],{"type":26,"value":2262},"這種情況下，單靠時間戳無法明確判斷哪個版本為「最新」或「正確」，因為兩次寫入發生在不同節點且近乎同時。",{"type":21,"tag":22,"props":2264,"children":2265},{},[2266],{"type":21,"tag":99,"props":2267,"children":2268},{},[2269],{"type":26,"value":2270},"解決衝突版本：",{"type":21,"tag":91,"props":2272,"children":2273},{},[2274,2292],{"type":21,"tag":95,"props":2275,"children":2276},{},[2277,2281],{"type":21,"tag":99,"props":2278,"children":2279},{},[2280],{"type":26,"value":2158},{"type":21,"tag":187,"props":2282,"children":2283},{},[2284],{"type":21,"tag":95,"props":2285,"children":2286},{},[2287,2291],{"type":21,"tag":99,"props":2288,"children":2289},{},[2290],{"type":26,"value":1706},{"type":26,"value":2160},{"type":21,"tag":95,"props":2293,"children":2294},{},[2295,2299],{"type":21,"tag":99,"props":2296,"children":2297},{},[2298],{"type":26,"value":2168},{"type":21,"tag":187,"props":2300,"children":2301},{},[2302,2314,2319,2430,2517],{"type":21,"tag":95,"props":2303,"children":2304},{},[2305,2307,2312],{"type":26,"value":2306},"為了解決",{"type":21,"tag":99,"props":2308,"children":2309},{},[2310],{"type":26,"value":2311},"誰覆蓋誰",{"type":26,"value":2313},"的問題。",{"type":21,"tag":95,"props":2315,"children":2316},{},[2317],{"type":26,"value":2318},"為每個資料項維護一個多維版本向量，用來判定版本間的先後或並行關係。",{"type":21,"tag":95,"props":2320,"children":2321},{},[2322,2326],{"type":21,"tag":99,"props":2323,"children":2324},{},[2325],{"type":26,"value":1706},{"type":21,"tag":187,"props":2327,"children":2328},{},[2329,2354,2379,2404,2417],{"type":21,"tag":95,"props":2330,"children":2331},{},[2332,2334,2339,2341,2353],{"type":26,"value":2333},"向量時鐘是",{"type":21,"tag":99,"props":2335,"children":2336},{},[2337],{"type":26,"value":2338},"與資料相關聯的一對資料",{"type":26,"value":2340},"，其形式為 ",{"type":21,"tag":2342,"props":2343,"children":2344},"em",{},[2345],{"type":21,"tag":99,"props":2346,"children":2347},{},[2348],{"type":21,"tag":206,"props":2349,"children":2350},{},[2351],{"type":26,"value":2352},"節點(伺服器), 版本",{"type":26,"value":1619},{"type":21,"tag":95,"props":2355,"children":2356},{},[2357,2359,2364,2366,2371,2373,2378],{"type":26,"value":2358},"可用來檢查某個版本是否為",{"type":21,"tag":99,"props":2360,"children":2361},{},[2362],{"type":26,"value":2363},"最新版本",{"type":26,"value":2365},"、是否為",{"type":21,"tag":99,"props":2367,"children":2368},{},[2369],{"type":26,"value":2370},"成功的版本",{"type":26,"value":2372},"、或是否",{"type":21,"tag":99,"props":2374,"children":2375},{},[2376],{"type":26,"value":2377},"與其他版本衝突",{"type":26,"value":1619},{"type":21,"tag":95,"props":2380,"children":2381},{},[2382,2384,2392,2394,2402],{"type":26,"value":2383},"如 ",{"type":21,"tag":2342,"props":2385,"children":2386},{},[2387],{"type":21,"tag":107,"props":2388,"children":2389},{"className":13},[2390],{"type":26,"value":2391},"D",{"type":26,"value":2393}," 的向量時鐘可能為 ",{"type":21,"tag":2342,"props":2395,"children":2396},{},[2397],{"type":21,"tag":107,"props":2398,"children":2399},{"className":13},[2400],{"type":26,"value":2401},"D([S1, v1], [S2, v2], ... [Sn, vn])",{"type":26,"value":2403}," 。",{"type":21,"tag":95,"props":2405,"children":2406},{},[2407,2415],{"type":21,"tag":2342,"props":2408,"children":2409},{},[2410],{"type":21,"tag":107,"props":2411,"children":2412},{"className":13},[2413],{"type":26,"value":2414},"S1...Sn",{"type":26,"value":2416}," 是參與此資料項更新的節點ID",{"type":21,"tag":95,"props":2418,"children":2419},{},[2420,2428],{"type":21,"tag":2342,"props":2421,"children":2422},{},[2423],{"type":21,"tag":107,"props":2424,"children":2425},{"className":13},[2426],{"type":26,"value":2427},"v1...vn",{"type":26,"value":2429}," 是該節點對此資料的更新次數。",{"type":21,"tag":95,"props":2431,"children":2432},{},[2433,2438],{"type":21,"tag":99,"props":2434,"children":2435},{},[2436],{"type":26,"value":2437},"更新規則：",{"type":21,"tag":187,"props":2439,"children":2440},{},[2441],{"type":21,"tag":95,"props":2442,"children":2443},{},[2444,2446,2453,2455,2463,2465],{"type":26,"value":2445},"每當資料 ",{"type":21,"tag":2342,"props":2447,"children":2448},{},[2449],{"type":21,"tag":107,"props":2450,"children":2451},{"className":13},[2452],{"type":26,"value":2391},{"type":26,"value":2454}," 在某節點 ",{"type":21,"tag":2342,"props":2456,"children":2457},{},[2458],{"type":21,"tag":107,"props":2459,"children":2460},{"className":13},[2461],{"type":26,"value":2462},"Si",{"type":26,"value":2464}," 發生寫入\n",{"type":21,"tag":187,"props":2466,"children":2467},{},[2468,2493],{"type":21,"tag":95,"props":2469,"children":2470},{},[2471,2473,2481,2483,2491],{"type":26,"value":2472},"如果向量時鐘中已存在 ",{"type":21,"tag":2342,"props":2474,"children":2475},{},[2476],{"type":21,"tag":107,"props":2477,"children":2478},{"className":13},[2479],{"type":26,"value":2480},"[Si, vi]",{"type":26,"value":2482}," ，則將 ",{"type":21,"tag":2342,"props":2484,"children":2485},{},[2486],{"type":21,"tag":107,"props":2487,"children":2488},{"className":13},[2489],{"type":26,"value":2490},"vi",{"type":26,"value":2492}," 加一（該節點對此資料的版本號+1）。",{"type":21,"tag":95,"props":2494,"children":2495},{},[2496,2498,2505,2507,2515],{"type":26,"value":2497},"如果不存在 ",{"type":21,"tag":2342,"props":2499,"children":2500},{},[2501],{"type":21,"tag":107,"props":2502,"children":2503},{"className":13},[2504],{"type":26,"value":2480},{"type":26,"value":2506},"，則新增 ",{"type":21,"tag":2342,"props":2508,"children":2509},{},[2510],{"type":21,"tag":107,"props":2511,"children":2512},{"className":13},[2513],{"type":26,"value":2514},"[Si, 1]",{"type":26,"value":2516}," 條目，表示該節點首次創建此資料版本。",{"type":21,"tag":95,"props":2518,"children":2519},{},[2520,2525],{"type":21,"tag":99,"props":2521,"children":2522},{},[2523],{"type":26,"value":2524},"版本比較：",{"type":21,"tag":187,"props":2526,"children":2527},{},[2528,2533,2592,2666],{"type":21,"tag":95,"props":2529,"children":2530},{},[2531],{"type":26,"value":2532},"將兩個版本的向量時鐘逐分量比較",{"type":21,"tag":95,"props":2534,"children":2535},{},[2536,2538,2543,2545,2550,2552],{"type":26,"value":2537},"如果 ",{"type":21,"tag":99,"props":2539,"children":2540},{},[2541],{"type":26,"value":2542},"版本X",{"type":26,"value":2544}," 的每個節點計數都 \u003C= ",{"type":21,"tag":99,"props":2546,"children":2547},{},[2548],{"type":26,"value":2549},"版本Y",{"type":26,"value":2551}," 的對應計數",{"type":21,"tag":187,"props":2553,"children":2554},{},[2555,2571,2587],{"type":21,"tag":95,"props":2556,"children":2557},{},[2558,2562,2563],{"type":21,"tag":99,"props":2559,"children":2560},{},[2561],{"type":26,"value":2542},{"type":26,"value":2023},{"type":21,"tag":2342,"props":2564,"children":2565},{},[2566],{"type":21,"tag":107,"props":2567,"children":2568},{"className":13},[2569],{"type":26,"value":2570},"D(［S0, 1］, [S1, 1])",{"type":21,"tag":95,"props":2572,"children":2573},{},[2574,2578,2579],{"type":21,"tag":99,"props":2575,"children":2576},{},[2577],{"type":26,"value":2549},{"type":26,"value":2023},{"type":21,"tag":2342,"props":2580,"children":2581},{},[2582],{"type":21,"tag":107,"props":2583,"children":2584},{"className":13},[2585],{"type":26,"value":2586},"D(［S0, 1］, [S1, 2])",{"type":21,"tag":95,"props":2588,"children":2589},{},[2590],{"type":26,"value":2591},"則 X 是 Y 的祖先版本（即 X 的所有更新都被 Y 包含，無衝突）。",{"type":21,"tag":95,"props":2593,"children":2594},{},[2595,2596,2600,2602,2606,2608],{"type":26,"value":2537},{"type":21,"tag":99,"props":2597,"children":2598},{},[2599],{"type":26,"value":2542},{"type":26,"value":2601}," 的某幾個節點計數比 ",{"type":21,"tag":99,"props":2603,"children":2604},{},[2605],{"type":26,"value":2549},{"type":26,"value":2607}," 的對應計數或大或小",{"type":21,"tag":187,"props":2609,"children":2610},{},[2611,2626,2642],{"type":21,"tag":95,"props":2612,"children":2613},{},[2614,2618,2619],{"type":21,"tag":99,"props":2615,"children":2616},{},[2617],{"type":26,"value":2542},{"type":26,"value":2023},{"type":21,"tag":2342,"props":2620,"children":2621},{},[2622],{"type":21,"tag":107,"props":2623,"children":2624},{"className":13},[2625],{"type":26,"value":2586},{"type":21,"tag":95,"props":2627,"children":2628},{},[2629,2633,2634],{"type":21,"tag":99,"props":2630,"children":2631},{},[2632],{"type":26,"value":2549},{"type":26,"value":2023},{"type":21,"tag":2342,"props":2635,"children":2636},{},[2637],{"type":21,"tag":107,"props":2638,"children":2639},{"className":13},[2640],{"type":26,"value":2641},"D(［S0, 2］, [S1, 1])",{"type":21,"tag":95,"props":2643,"children":2644},{},[2645,2647,2651,2653,2657,2659,2664],{"type":26,"value":2646},"則 ",{"type":21,"tag":99,"props":2648,"children":2649},{},[2650],{"type":26,"value":2542},{"type":26,"value":2652}," 與 ",{"type":21,"tag":99,"props":2654,"children":2655},{},[2656],{"type":26,"value":2549},{"type":26,"value":2658}," 發生",{"type":21,"tag":99,"props":2660,"children":2661},{},[2662],{"type":26,"value":2663},"並行衝突",{"type":26,"value":2665},"（即各有部分更新彼此不包含）。",{"type":21,"tag":95,"props":2667,"children":2668},{},[2669,2674],{"type":21,"tag":99,"props":2670,"children":2671},{},[2672],{"type":26,"value":2673},"目前的應用結論",{"type":21,"tag":187,"props":2675,"children":2676},{},[2677,2682],{"type":21,"tag":95,"props":2678,"children":2679},{},[2680],{"type":26,"value":2681},"Amazon Dynamo 就成功在生產環境使用向量時鐘並未遇到不可控的時鐘膨脹問題。",{"type":21,"tag":95,"props":2683,"children":2684},{},[2685],{"type":26,"value":2686},"向量時鐘仍是實用解決方案。",{"type":21,"tag":187,"props":2688,"children":2689},{},[2690],{"type":21,"tag":95,"props":2691,"children":2692},{},[2693,2698,2713],{"type":21,"tag":99,"props":2694,"children":2695},{},[2696],{"type":26,"value":2697},"向量時鐘的缺點",{"type":21,"tag":75,"props":2699,"children":2700},{},[2701],{"type":21,"tag":22,"props":2702,"children":2703},{},[2704,2706,2711],{"type":26,"value":2705},"透過以上機制，向量時鐘可以",{"type":21,"tag":99,"props":2707,"children":2708},{},[2709],{"type":26,"value":2710},"避免隨意覆蓋",{"type":26,"value":2712},"並發寫入造成的數據丟失，保留所有衝突版本供合併。值得注意的是，向量時鐘也有缺點：",{"type":21,"tag":187,"props":2714,"children":2715},{},[2716,2744],{"type":21,"tag":95,"props":2717,"children":2718},{},[2719,2724],{"type":21,"tag":99,"props":2720,"children":2721},{},[2722],{"type":26,"value":2723},"增加客戶端複雜度：",{"type":21,"tag":187,"props":2725,"children":2726},{},[2727,2732],{"type":21,"tag":95,"props":2728,"children":2729},{},[2730],{"type":26,"value":2731},"需要客戶端（或應用層）實現衝突合併邏輯，對開發者提出更高要求。",{"type":21,"tag":95,"props":2733,"children":2734},{},[2735,2737,2742],{"type":26,"value":2736},"一些系統（如 Cassandra）乾脆選擇更簡單的 ",{"type":21,"tag":99,"props":2738,"children":2739},{},[2740],{"type":26,"value":2741},"最後寫入優先 (Last Write Wins)",{"type":26,"value":2743}," 策略，以縮減實現複雜度，但代價是可能捨棄較新的並發更新。",{"type":21,"tag":95,"props":2745,"children":2746},{},[2747,2752],{"type":21,"tag":99,"props":2748,"children":2749},{},[2750],{"type":26,"value":2751},"開銷隨節點數增加：",{"type":21,"tag":187,"props":2753,"children":2754},{},[2755,2779,2790,2808],{"type":21,"tag":95,"props":2756,"children":2757},{},[2758,2760,2771,2773,2778],{"type":26,"value":2759},"向量時鐘裡 ",{"type":21,"tag":99,"props":2761,"children":2762},{},[2763],{"type":21,"tag":2342,"props":2764,"children":2765},{},[2766],{"type":21,"tag":206,"props":2767,"children":2768},{},[2769],{"type":26,"value":2770},"server:version",{"type":26,"value":2772},"  這樣成對資料，其數量可能會",{"type":21,"tag":99,"props":2774,"children":2775},{},[2776],{"type":26,"value":2777},"快速成長",{"type":26,"value":1619},{"type":21,"tag":95,"props":2780,"children":2781},{},[2782,2784,2789],{"type":26,"value":2783},"在大規模系統中，維護數十上百的節點版本向量",{"type":21,"tag":99,"props":2785,"children":2786},{},[2787],{"type":26,"value":2788},"會增加存儲和傳輸負擔",{"type":26,"value":1619},{"type":21,"tag":95,"props":2791,"children":2792},{},[2793,2795,2800,2802,2807],{"type":26,"value":2794},"針對長度設定了一個",{"type":21,"tag":99,"props":2796,"children":2797},{},[2798],{"type":26,"value":2799},"門檻值",{"type":26,"value":2801},"。超過限制長度，就會",{"type":21,"tag":99,"props":2803,"children":2804},{},[2805],{"type":26,"value":2806},"刪除掉最舊的成對資料",{"type":26,"value":1619},{"type":21,"tag":95,"props":2809,"children":2810},{},[2811],{"type":26,"value":2812},"導致，無法正正確判斷前後代關系，造成重新協調效果不佳。",{"type":21,"tag":275,"props":2814,"children":2815},{},[],{"type":21,"tag":187,"props":2817,"children":2818},{},[2819],{"type":21,"tag":95,"props":2820,"children":2821},{},[2822,2827,2829,2836,2838,2845,2847,2855,2857,2860,2868,2870,2877,2879,2886,2888],{"type":21,"tag":99,"props":2823,"children":2824},{},[2825],{"type":26,"value":2826},"舉例：",{"type":26,"value":2828},"\n向量時鐘是用 ",{"type":21,"tag":2342,"props":2830,"children":2831},{},[2832],{"type":21,"tag":107,"props":2833,"children":2834},{"className":13},[2835],{"type":26,"value":2401},{"type":26,"value":2837}," 來表式。\n",{"type":21,"tag":2342,"props":2839,"children":2840},{},[2841],{"type":21,"tag":107,"props":2842,"children":2843},{"className":13},[2844],{"type":26,"value":2391},{"type":26,"value":2846},"  ：是資料項\n",{"type":21,"tag":2342,"props":2848,"children":2849},{},[2850],{"type":21,"tag":107,"props":2851,"children":2852},{"className":13},[2853],{"type":26,"value":2854},"Sn",{"type":26,"value":2856}," ：是伺服器編號",{"type":21,"tag":275,"props":2858,"children":2859},{},[],{"type":21,"tag":2342,"props":2861,"children":2862},{},[2863],{"type":21,"tag":107,"props":2864,"children":2865},{"className":13},[2866],{"type":26,"value":2867},"vn",{"type":26,"value":2869}," ：是版本計數器\n如果把資料項 ",{"type":21,"tag":2342,"props":2871,"children":2872},{},[2873],{"type":21,"tag":107,"props":2874,"children":2875},{"className":13},[2876],{"type":26,"value":2391},{"type":26,"value":2878}," 寫入伺服器 ",{"type":21,"tag":2342,"props":2880,"children":2881},{},[2882],{"type":21,"tag":107,"props":2883,"children":2884},{"className":13},[2885],{"type":26,"value":2462},{"type":26,"value":2887}," , 則系統就必須執行以下其中一個任務。\n",{"type":21,"tag":187,"props":2889,"children":2890},{},[2891,2915,2929,2947],{"type":21,"tag":95,"props":2892,"children":2893},{},[2894,2896,2904,2906,2913],{"type":26,"value":2895},"如果  ",{"type":21,"tag":2342,"props":2897,"children":2898},{},[2899],{"type":21,"tag":107,"props":2900,"children":2901},{"className":13},[2902],{"type":26,"value":2903},"[Si,vi]",{"type":26,"value":2905}," 存在， ",{"type":21,"tag":2342,"props":2907,"children":2908},{},[2909],{"type":21,"tag":107,"props":2910,"children":2911},{"className":13},[2912],{"type":26,"value":2490},{"type":26,"value":2914}," 就加 1。",{"type":21,"tag":95,"props":2916,"children":2917},{},[2918,2920,2928],{"type":26,"value":2919},"否則的話，就建立一個新的項目 ",{"type":21,"tag":2342,"props":2921,"children":2922},{},[2923],{"type":21,"tag":107,"props":2924,"children":2925},{"className":13},[2926],{"type":26,"value":2927},"[Si,1]",{"type":26,"value":2403},{"type":21,"tag":95,"props":2930,"children":2931},{},[2932,2934,2939,2941,2946],{"type":26,"value":2933},"透過向量時鐘，我們能",{"type":21,"tag":99,"props":2935,"children":2936},{},[2937],{"type":26,"value":2938},"檢測",{"type":26,"value":2940},"衝突版本並進一步",{"type":21,"tag":99,"props":2942,"children":2943},{},[2944],{"type":26,"value":2945},"合併",{"type":26,"value":1619},{"type":21,"tag":95,"props":2948,"children":2949},{},[2950,2952,2957],{"type":26,"value":2951},"以下用實際例子 ( 圖 6-9 ) 說明其工作流程：",{"type":21,"tag":99,"props":2953,"children":2954},{},[2955],{"type":26,"value":2956},"假設 N=3 節點 Sx, Sy, Sz",{"type":21,"tag":416,"props":2958,"children":2960},{"alt":418,"src":2959},"/images/sdi-aig/06/img-6-9.png",[],{"type":21,"tag":22,"props":2962,"children":2963},{},[2964,2972],{"type":21,"tag":2342,"props":2965,"children":2966},{},[2967],{"type":21,"tag":99,"props":2968,"children":2969},{},[2970],{"type":26,"value":2971},"這張流程圖示範整個向量時鐘（Vector Clock）在多節點環境下，如何追蹤版本、偵測衝突並最終合併的機制。",{"type":26,"value":2973},"*",{"type":21,"tag":22,"props":2975,"children":2976},{},[2977],{"type":21,"tag":2342,"props":2978,"children":2979},{},[2980],{"type":21,"tag":99,"props":2981,"children":2982},{},[2983],{"type":26,"value":2984},"具體來看：",{"type":21,"tag":91,"props":2986,"children":2987},{},[2988,3025,3092,3149,3178],{"type":21,"tag":95,"props":2989,"children":2990},{},[2991,3001,3003,3013,3015,3024],{"type":21,"tag":99,"props":2992,"children":2993},{},[2994,2999],{"type":21,"tag":107,"props":2995,"children":2996},{"className":13},[2997],{"type":26,"value":2998},"D1 → D2",{"type":26,"value":3000},"：",{"type":26,"value":3002}," 都是透過 ",{"type":21,"tag":99,"props":3004,"children":3005},{},[3006,3011],{"type":21,"tag":107,"props":3007,"children":3008},{"className":13},[3009],{"type":26,"value":3010},"Sx",{"type":26,"value":3012}," 來寫入",{"type":26,"value":3014},"， ",{"type":21,"tag":99,"props":3016,"children":3017},{},[3018,3022],{"type":21,"tag":107,"props":3019,"children":3020},{"className":13},[3021],{"type":26,"value":3010},{"type":26,"value":3023}," 的版本計數器從 1 增到 2",{"type":26,"value":1619},{"type":21,"tag":95,"props":3026,"children":3027},{},[3028,3037,3039,3049,3051,3056,3058,3072,3074,3078,3079,3084,3086,3091],{"type":21,"tag":99,"props":3029,"children":3030},{},[3031,3036],{"type":21,"tag":107,"props":3032,"children":3033},{"className":13},[3034],{"type":26,"value":3035},"D3",{"type":26,"value":3000},{"type":26,"value":3038}," 有一客戶端在 ",{"type":21,"tag":99,"props":3040,"children":3041},{},[3042,3047],{"type":21,"tag":107,"props":3043,"children":3044},{"className":13},[3045],{"type":26,"value":3046},"Sy",{"type":26,"value":3048}," 寫入",{"type":26,"value":3050},"，繼承了 ",{"type":21,"tag":107,"props":3052,"children":3053},{"className":13},[3054],{"type":26,"value":3055},"Sx:2",{"type":26,"value":3057},"，並在 ",{"type":21,"tag":99,"props":3059,"children":3060},{},[3061,3065,3067],{"type":21,"tag":107,"props":3062,"children":3063},{"className":13},[3064],{"type":26,"value":3046},{"type":26,"value":3066}," 新增 ",{"type":21,"tag":107,"props":3068,"children":3069},{"className":13},[3070],{"type":26,"value":3071},"Sy:1",{"type":26,"value":3073}," ( 因為 ",{"type":21,"tag":107,"props":3075,"children":3076},{"className":13},[3077],{"type":26,"value":3046},{"type":26,"value":2023},{"type":21,"tag":99,"props":3080,"children":3081},{},[3082],{"type":26,"value":3083},"第一次處理",{"type":26,"value":3085}," ) ，時鐘變成 ",{"type":21,"tag":107,"props":3087,"children":3088},{"className":13},[3089],{"type":26,"value":3090},"(Sx:2, Sy:1)",{"type":26,"value":2403},{"type":21,"tag":95,"props":3093,"children":3094},{},[3095,3104,3106,3118,3120,3124,3126,3131,3132,3136,3137,3141,3143,3148],{"type":21,"tag":99,"props":3096,"children":3097},{},[3098,3103],{"type":21,"tag":107,"props":3099,"children":3100},{"className":13},[3101],{"type":26,"value":3102},"D4",{"type":26,"value":3000},{"type":26,"value":3105}," 另一個客戶端",{"type":21,"tag":99,"props":3107,"children":3108},{},[3109,3111,3116],{"type":26,"value":3110},"同時在 ",{"type":21,"tag":107,"props":3112,"children":3113},{"className":13},[3114],{"type":26,"value":3115},"Sz",{"type":26,"value":3117}," 上寫入",{"type":26,"value":3119},"，同樣繼承 ",{"type":21,"tag":107,"props":3121,"children":3122},{"className":13},[3123],{"type":26,"value":3055},{"type":26,"value":3125},"，並新增 ",{"type":21,"tag":107,"props":3127,"children":3128},{"className":13},[3129],{"type":26,"value":3130},"Sz:1",{"type":26,"value":3073},{"type":21,"tag":107,"props":3133,"children":3134},{"className":13},[3135],{"type":26,"value":3115},{"type":26,"value":2023},{"type":21,"tag":99,"props":3138,"children":3139},{},[3140],{"type":26,"value":3083},{"type":26,"value":3142}," )，時鐘變成 ",{"type":21,"tag":107,"props":3144,"children":3145},{"className":13},[3146],{"type":26,"value":3147},"(Sx:2, Sz:1)",{"type":26,"value":2403},{"type":21,"tag":95,"props":3150,"children":3151},{},[3152,3157,3159,3163,3165,3169,3171,3176],{"type":21,"tag":99,"props":3153,"children":3154},{},[3155],{"type":26,"value":3156},"衝突偵測：",{"type":26,"value":3158}," 因為 ",{"type":21,"tag":107,"props":3160,"children":3161},{"className":13},[3162],{"type":26,"value":3090},{"type":26,"value":3164}," 跟 ",{"type":21,"tag":107,"props":3166,"children":3167},{"className":13},[3168],{"type":26,"value":3147},{"type":26,"value":3170}," 彼此各有對方沒有的",{"type":21,"tag":99,"props":3172,"children":3173},{},[3174],{"type":26,"value":3175},"分量",{"type":26,"value":3177},"，無法互相包含，所以被判定為衝突版本。",{"type":21,"tag":95,"props":3179,"children":3180},{},[3181,3191,3193,3198,3200,3204,3205,3209,3211,3222,3224,3228,3230,3235,3237,3242],{"type":21,"tag":99,"props":3182,"children":3183},{},[3184,3189],{"type":21,"tag":107,"props":3185,"children":3186},{"className":13},[3187],{"type":26,"value":3188},"D5",{"type":26,"value":3190}," 合併：",{"type":26,"value":3192}," 在 ",{"type":21,"tag":99,"props":3194,"children":3195},{},[3196],{"type":26,"value":3197},"應用層",{"type":26,"value":3199}," 把 ",{"type":21,"tag":107,"props":3201,"children":3202},{"className":13},[3203],{"type":26,"value":3035},{"type":26,"value":914},{"type":21,"tag":107,"props":3206,"children":3207},{"className":13},[3208],{"type":26,"value":3102},{"type":26,"value":3210}," 合併後，",{"type":21,"tag":99,"props":3212,"children":3213},{},[3214,3216,3220],{"type":26,"value":3215},"由 ",{"type":21,"tag":107,"props":3217,"children":3218},{"className":13},[3219],{"type":26,"value":3010},{"type":26,"value":3221}," 再寫入一次",{"type":26,"value":3223},"，",{"type":21,"tag":107,"props":3225,"children":3226},{"className":13},[3227],{"type":26,"value":3010},{"type":26,"value":3229}," 的計數器再 +1（從 2 → 3）， 、合併後的時鐘為 ",{"type":21,"tag":107,"props":3231,"children":3232},{"className":13},[3233],{"type":26,"value":3234},"(Sx:3, Sy:1, Sz:1)",{"type":26,"value":3236}," ，它就 ",{"type":21,"tag":99,"props":3238,"children":3239},{},[3240],{"type":26,"value":3241},"包含了之前所有分量，因此成為唯一合法的後繼版本",{"type":26,"value":2403},{"type":21,"tag":22,"props":3244,"children":3245},{},[3246,3248,3252,3254,3259,3261,3266],{"type":26,"value":3247},"「",{"type":21,"tag":99,"props":3249,"children":3250},{},[3251],{"type":26,"value":3175},{"type":26,"value":3253},"」這個詞在這裡其實是從數學或向量概念延伸而來，指的是",{"type":21,"tag":99,"props":3255,"children":3256},{},[3257],{"type":26,"value":3258},"向量中每個維度上的值",{"type":26,"value":3260},"，在向量時鐘（Vector Clock）中，這些「分量」就是",{"type":21,"tag":99,"props":3262,"children":3263},{},[3264],{"type":26,"value":3265},"每個節點的版本號",{"type":26,"value":1619},{"type":21,"tag":75,"props":3268,"children":3269},{},[3270,3273,3280,3286,3461,3467,3472,3563,3568,3586,3589,3595,3608,3611,3617,3628,3633],{"type":21,"tag":38,"props":3271,"children":3272},{},[],{"type":21,"tag":3274,"props":3275,"children":3277},"h3",{"id":3276},"為什麼叫分量",[3278],{"type":26,"value":3279},"🔍 為什麼叫「分量」？",{"type":21,"tag":565,"props":3281,"children":3283},{"id":3282},"數學背景",[3284],{"type":26,"value":3285},"數學背景：",{"type":21,"tag":187,"props":3287,"children":3288},{},[3289,3451,3456],{"type":21,"tag":95,"props":3290,"children":3291},{},[3292,3294,3450],{"type":26,"value":3293},"向量（Vector）是一組有方向和大小的數字集合，例如 ",{"type":21,"tag":3295,"props":3296,"children":3300},"mjx-container",{"className":3297,"jax":3299},[3298],"MathJax","SVG",[3301],{"type":21,"tag":3302,"props":3303,"children":3311},"svg",{"style":3304,"xmlns":3305,"width":3306,"height":3307,"role":416,"focusable":3308,"viewBox":3309,"xmlnsXLink":3310},"vertical-align: -0.566ex;","http://www.w3.org/2000/svg","11.28ex","2.262ex","false","0 -750 4985.9 1000","http://www.w3.org/1999/xlink",[3312,3357],{"type":21,"tag":3313,"props":3314,"children":3315},"defs",{},[3316,3322,3327,3332,3337,3342,3347,3352],{"type":21,"tag":3317,"props":3318,"children":3321},"path",{"id":3319,"d":3320},"MJX-1-TEX-I-1D463","M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z",[],{"type":21,"tag":3317,"props":3323,"children":3326},{"id":3324,"d":3325},"MJX-1-TEX-N-3D","M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z",[],{"type":21,"tag":3317,"props":3328,"children":3331},{"id":3329,"d":3330},"MJX-1-TEX-N-28","M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z",[],{"type":21,"tag":3317,"props":3333,"children":3336},{"id":3334,"d":3335},"MJX-1-TEX-N-31","M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z",[],{"type":21,"tag":3317,"props":3338,"children":3341},{"id":3339,"d":3340},"MJX-1-TEX-N-2C","M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z",[],{"type":21,"tag":3317,"props":3343,"children":3346},{"id":3344,"d":3345},"MJX-1-TEX-N-32","M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z",[],{"type":21,"tag":3317,"props":3348,"children":3351},{"id":3349,"d":3350},"MJX-1-TEX-N-33","M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z",[],{"type":21,"tag":3317,"props":3353,"children":3356},{"id":3354,"d":3355},"MJX-1-TEX-N-29","M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z",[],{"type":21,"tag":3358,"props":3359,"children":3363},"g",{"stroke":3360,"fill":3360,"strokeWidth":3361,"transform":3362},"currentColor","0","scale(1,-1)",[3364],{"type":21,"tag":3358,"props":3365,"children":3367},{"dataMmlNode":3366},"math",[3368,3378,3388,3397,3407,3416,3425,3432,3441],{"type":21,"tag":3358,"props":3369,"children":3371},{"dataMmlNode":3370},"mi",[3372],{"type":21,"tag":3373,"props":3374,"children":3377},"use",{"dataC":3375,"xLinkHref":3376},"1D463","#MJX-1-TEX-I-1D463",[],{"type":21,"tag":3358,"props":3379,"children":3382},{"dataMmlNode":3380,"transform":3381},"mo","translate(762.8,0)",[3383],{"type":21,"tag":3373,"props":3384,"children":3387},{"dataC":3385,"xLinkHref":3386},"3D","#MJX-1-TEX-N-3D",[],{"type":21,"tag":3358,"props":3389,"children":3391},{"dataMmlNode":3380,"transform":3390},"translate(1818.6,0)",[3392],{"type":21,"tag":3373,"props":3393,"children":3396},{"dataC":3394,"xLinkHref":3395},"28","#MJX-1-TEX-N-28",[],{"type":21,"tag":3358,"props":3398,"children":3401},{"dataMmlNode":3399,"transform":3400},"mn","translate(2207.6,0)",[3402],{"type":21,"tag":3373,"props":3403,"children":3406},{"dataC":3404,"xLinkHref":3405},"31","#MJX-1-TEX-N-31",[],{"type":21,"tag":3358,"props":3408,"children":3410},{"dataMmlNode":3380,"transform":3409},"translate(2707.6,0)",[3411],{"type":21,"tag":3373,"props":3412,"children":3415},{"dataC":3413,"xLinkHref":3414},"2C","#MJX-1-TEX-N-2C",[],{"type":21,"tag":3358,"props":3417,"children":3419},{"dataMmlNode":3399,"transform":3418},"translate(3152.2,0)",[3420],{"type":21,"tag":3373,"props":3421,"children":3424},{"dataC":3422,"xLinkHref":3423},"32","#MJX-1-TEX-N-32",[],{"type":21,"tag":3358,"props":3426,"children":3428},{"dataMmlNode":3380,"transform":3427},"translate(3652.2,0)",[3429],{"type":21,"tag":3373,"props":3430,"children":3431},{"dataC":3413,"xLinkHref":3414},[],{"type":21,"tag":3358,"props":3433,"children":3435},{"dataMmlNode":3399,"transform":3434},"translate(4096.9,0)",[3436],{"type":21,"tag":3373,"props":3437,"children":3440},{"dataC":3438,"xLinkHref":3439},"33","#MJX-1-TEX-N-33",[],{"type":21,"tag":3358,"props":3442,"children":3444},{"dataMmlNode":3380,"transform":3443},"translate(4596.9,0)",[3445],{"type":21,"tag":3373,"props":3446,"children":3449},{"dataC":3447,"xLinkHref":3448},"29","#MJX-1-TEX-N-29",[],{"type":26,"value":1619},{"type":21,"tag":95,"props":3452,"children":3453},{},[3454],{"type":26,"value":3455},"向量的每個數字（例如 1、2、3）就是這個向量在各個軸上的「分量」（components）。",{"type":21,"tag":95,"props":3457,"children":3458},{},[3459],{"type":26,"value":3460},"中文中「分量」是 vector component 的翻譯。",{"type":21,"tag":565,"props":3462,"children":3464},{"id":3463},"在向量時鐘中的意義",[3465],{"type":26,"value":3466},"在向量時鐘中的意義：",{"type":21,"tag":22,"props":3468,"children":3469},{},[3470],{"type":26,"value":3471},"向量時鐘用一組 key-value 組來記錄每個節點的版本：",{"type":21,"tag":196,"props":3473,"children":3477},{"code":3474,"language":3475,"meta":13,"className":3476,"style":13},"{\n \"Sx\": 2,\n \"Sy\": 1,\n \"Sz\": 0\n}\n","json","language-json shiki shiki-themes github-dark github-light monokai",[3478],{"type":21,"tag":107,"props":3479,"children":3480},{"__ignoreMap":13},[3481,3489,3514,3536,3554],{"type":21,"tag":206,"props":3482,"children":3483},{"class":208,"line":209},[3484],{"type":21,"tag":206,"props":3485,"children":3486},{"style":225},[3487],{"type":26,"value":3488},"{\n",{"type":21,"tag":206,"props":3490,"children":3491},{"class":208,"line":237},[3492,3498,3503,3509],{"type":21,"tag":206,"props":3493,"children":3495},{"style":3494},"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic",[3496],{"type":26,"value":3497}," \"Sx\"",{"type":21,"tag":206,"props":3499,"children":3500},{"style":225},[3501],{"type":26,"value":3502},": ",{"type":21,"tag":206,"props":3504,"children":3506},{"style":3505},"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF",[3507],{"type":26,"value":3508},"2",{"type":21,"tag":206,"props":3510,"children":3511},{"style":225},[3512],{"type":26,"value":3513},",\n",{"type":21,"tag":206,"props":3515,"children":3517},{"class":208,"line":3516},3,[3518,3523,3527,3532],{"type":21,"tag":206,"props":3519,"children":3520},{"style":3494},[3521],{"type":26,"value":3522}," \"Sy\"",{"type":21,"tag":206,"props":3524,"children":3525},{"style":225},[3526],{"type":26,"value":3502},{"type":21,"tag":206,"props":3528,"children":3529},{"style":3505},[3530],{"type":26,"value":3531},"1",{"type":21,"tag":206,"props":3533,"children":3534},{"style":225},[3535],{"type":26,"value":3513},{"type":21,"tag":206,"props":3537,"children":3539},{"class":208,"line":3538},4,[3540,3545,3549],{"type":21,"tag":206,"props":3541,"children":3542},{"style":3494},[3543],{"type":26,"value":3544}," \"Sz\"",{"type":21,"tag":206,"props":3546,"children":3547},{"style":225},[3548],{"type":26,"value":3502},{"type":21,"tag":206,"props":3550,"children":3551},{"style":3505},[3552],{"type":26,"value":3553},"0\n",{"type":21,"tag":206,"props":3555,"children":3557},{"class":208,"line":3556},5,[3558],{"type":21,"tag":206,"props":3559,"children":3560},{"style":225},[3561],{"type":26,"value":3562},"}\n",{"type":21,"tag":22,"props":3564,"children":3565},{},[3566],{"type":26,"value":3567},"這其實就是一個多維的向量，每個節點（如 Sx, Sy, Sz）對應一個「分量」：",{"type":21,"tag":187,"props":3569,"children":3570},{},[3571,3576,3581],{"type":21,"tag":95,"props":3572,"children":3573},{},[3574],{"type":26,"value":3575},"Sx 的分量是 2",{"type":21,"tag":95,"props":3577,"children":3578},{},[3579],{"type":26,"value":3580},"Sy 的分量是 1",{"type":21,"tag":95,"props":3582,"children":3583},{},[3584],{"type":26,"value":3585},"Sz 的分量是 0",{"type":21,"tag":38,"props":3587,"children":3588},{},[],{"type":21,"tag":3274,"props":3590,"children":3592},{"id":3591},"用分量的好處",[3593],{"type":26,"value":3594},"✅ 用「分量」的好處：",{"type":21,"tag":187,"props":3596,"children":3597},{},[3598,3603],{"type":21,"tag":95,"props":3599,"children":3600},{},[3601],{"type":26,"value":3602},"可以用來比較兩個向量時鐘是否發生衝突",{"type":21,"tag":95,"props":3604,"children":3605},{},[3606],{"type":26,"value":3607},"易於理解為「每個節點對這筆資料的貢獻度（或修改次數）」",{"type":21,"tag":38,"props":3609,"children":3610},{},[],{"type":21,"tag":3274,"props":3612,"children":3614},{"id":3613},"總結",[3615],{"type":26,"value":3616},"📘 總結：",{"type":21,"tag":22,"props":3618,"children":3619},{},[3620,3622,3627],{"type":26,"value":3621},"向量時鐘中的「分量」就是： ",{"type":21,"tag":99,"props":3623,"children":3624},{},[3625],{"type":26,"value":3626},"每個節點在向量中對應的版本值",{"type":26,"value":1619},{"type":21,"tag":22,"props":3629,"children":3630},{},[3631],{"type":26,"value":3632},"叫它「分量」是因為這種結構本身就是一個向量，這個詞也承襲了數學中向量各個維度的稱呼。這在資料庫、分散式系統、版> 本控制等領域中是常見的術語。",{"type":21,"tag":38,"props":3634,"children":3635},{},[],{"type":21,"tag":22,"props":3637,"children":3638},{},[3639],{"type":21,"tag":2342,"props":3640,"children":3641},{},[3642],{"type":21,"tag":99,"props":3643,"children":3644},{},[3645],{"type":26,"value":3646},"詳細步驟說明：",{"type":21,"tag":91,"props":3648,"children":3649},{},[3650,3698,3776,3859,3919,4044],{"type":21,"tag":95,"props":3651,"children":3652},{},[3653,3658,3660,3664,3666],{"type":21,"tag":99,"props":3654,"children":3655},{},[3656],{"type":26,"value":3657},"初始寫入：",{"type":26,"value":3659}," （ ",{"type":21,"tag":107,"props":3661,"children":3662},{"className":13},[3663],{"type":26,"value":3010},{"type":26,"value":3665}," 第1次 寫入此鍵）\n",{"type":21,"tag":187,"props":3667,"children":3668},{},[3669,3687],{"type":21,"tag":95,"props":3670,"children":3671},{},[3672,3674,3679,3681,3685],{"type":26,"value":3673},"客戶端把資料項 ",{"type":21,"tag":107,"props":3675,"children":3676},{"className":13},[3677],{"type":26,"value":3678},"D1",{"type":26,"value":3680}," 寫入系統，且這個寫入是由伺服器 ",{"type":21,"tag":107,"props":3682,"children":3683},{"className":13},[3684],{"type":26,"value":3010},{"type":26,"value":3686}," 來處理。",{"type":21,"tag":95,"props":3688,"children":3689},{},[3690,3692,3697],{"type":26,"value":3691},"因此，就有了向量時鐘為 ",{"type":21,"tag":107,"props":3693,"children":3694},{"className":13},[3695],{"type":26,"value":3696},"D1([Sx, 1])",{"type":26,"value":1619},{"type":21,"tag":95,"props":3699,"children":3700},{},[3701,3706,3707,3711,3713],{"type":21,"tag":99,"props":3702,"children":3703},{},[3704],{"type":26,"value":3705},"後續覆寫：",{"type":26,"value":3659},{"type":21,"tag":107,"props":3708,"children":3709},{"className":13},[3710],{"type":26,"value":3010},{"type":26,"value":3712}," 第2次 更新此鍵，取代了舊版本）\n",{"type":21,"tag":187,"props":3714,"children":3715},{},[3716,3740],{"type":21,"tag":95,"props":3717,"children":3718},{},[3719,3721,3725,3727,3732,3734,3738],{"type":26,"value":3720},"另一客戶端讀取了最新的 ",{"type":21,"tag":107,"props":3722,"children":3723},{"className":13},[3724],{"type":26,"value":3678},{"type":26,"value":3726}," ，並把它改為 ",{"type":21,"tag":107,"props":3728,"children":3729},{"className":13},[3730],{"type":26,"value":3731},"D2",{"type":26,"value":3733}," ，仍然是由同一部伺服器 ",{"type":21,"tag":107,"props":3735,"children":3736},{"className":13},[3737],{"type":26,"value":3010},{"type":26,"value":3739}," 進行寫入處理把資料寫回伺服器。",{"type":21,"tag":95,"props":3741,"children":3742},{},[3743,3745,3749,3751,3755,3757,3762,3764,3768,3770,3775],{"type":26,"value":3744},"因此，",{"type":21,"tag":107,"props":3746,"children":3747},{"className":13},[3748],{"type":26,"value":3731},{"type":26,"value":3750}," 繼承自 ",{"type":21,"tag":107,"props":3752,"children":3753},{"className":13},[3754],{"type":26,"value":3678},{"type":26,"value":3756},"，視為",{"type":21,"tag":99,"props":3758,"children":3759},{},[3760],{"type":26,"value":3761},"同一演進鏈",{"type":26,"value":3763},"，故 ",{"type":21,"tag":107,"props":3765,"children":3766},{"className":13},[3767],{"type":26,"value":3010},{"type":26,"value":3769}," 將其版本遞增為 ",{"type":21,"tag":107,"props":3771,"children":3772},{"className":13},[3773],{"type":26,"value":3774},"D2([Sx, 2])",{"type":26,"value":1619},{"type":21,"tag":95,"props":3777,"children":3778},{},[3779,3784,3786,3790,3792,3801,3803],{"type":21,"tag":99,"props":3780,"children":3781},{},[3782],{"type":26,"value":3783},"並行更新1：",{"type":26,"value":3785}," （繼承了之前 ",{"type":21,"tag":107,"props":3787,"children":3788},{"className":13},[3789],{"type":26,"value":3055},{"type":26,"value":3791}," 的版本，",{"type":21,"tag":99,"props":3793,"children":3794},{},[3795,3797],{"type":26,"value":3796},"並加入 ",{"type":21,"tag":107,"props":3798,"children":3799},{"className":13},[3800],{"type":26,"value":3071},{"type":26,"value":3802}," ）\n",{"type":21,"tag":187,"props":3804,"children":3805},{},[3806,3822,3838],{"type":21,"tag":95,"props":3807,"children":3808},{},[3809,3811,3815,3817,3821],{"type":26,"value":3810},"第三個客戶端讀取最新 ",{"type":21,"tag":107,"props":3812,"children":3813},{"className":13},[3814],{"type":26,"value":3731},{"type":26,"value":3816},"，更新為 ",{"type":21,"tag":107,"props":3818,"children":3819},{"className":13},[3820],{"type":26,"value":3035},{"type":26,"value":3223},{"type":21,"tag":95,"props":3823,"children":3824},{},[3825,3827,3836],{"type":26,"value":3826},"透過",{"type":21,"tag":99,"props":3828,"children":3829},{},[3830,3832],{"type":26,"value":3831},"不同節點 ",{"type":21,"tag":107,"props":3833,"children":3834},{"className":13},[3835],{"type":26,"value":3046},{"type":26,"value":3837}," 寫入。",{"type":21,"tag":95,"props":3839,"children":3840},{},[3841,3845,3847,3851,3853,3858],{"type":21,"tag":107,"props":3842,"children":3843},{"className":13},[3844],{"type":26,"value":3046},{"type":26,"value":3846}," 不曾寫過該鍵，於是 ",{"type":21,"tag":107,"props":3848,"children":3849},{"className":13},[3850],{"type":26,"value":3035},{"type":26,"value":3852}," 的時鐘為 ",{"type":21,"tag":107,"props":3854,"children":3855},{"className":13},[3856],{"type":26,"value":3857},"([Sx,2], [Sy,1])",{"type":26,"value":1619},{"type":21,"tag":95,"props":3860,"children":3861},{},[3862,3867],{"type":21,"tag":99,"props":3863,"children":3864},{},[3865],{"type":26,"value":3866},"並行更新2：",{"type":21,"tag":187,"props":3868,"children":3869},{},[3870,3892],{"type":21,"tag":95,"props":3871,"children":3872},{},[3873,3875,3886,3887,3891],{"type":26,"value":3874},"第四個客戶端也",{"type":21,"tag":99,"props":3876,"children":3877},{},[3878,3880,3884],{"type":26,"value":3879},"讀取 ",{"type":21,"tag":107,"props":3881,"children":3882},{"className":13},[3883],{"type":26,"value":3731},{"type":26,"value":3885},"（與步驟3並行）",{"type":26,"value":3816},{"type":21,"tag":107,"props":3888,"children":3889},{"className":13},[3890],{"type":26,"value":3102},{"type":26,"value":3223},{"type":21,"tag":95,"props":3893,"children":3894},{},[3895,3896,3905,3907,3911,3913,3918],{"type":26,"value":3826},{"type":21,"tag":99,"props":3897,"children":3898},{},[3899,3901],{"type":26,"value":3900},"另一節點 ",{"type":21,"tag":107,"props":3902,"children":3903},{"className":13},[3904],{"type":26,"value":3115},{"type":26,"value":3906}," 寫入。得到 ",{"type":21,"tag":107,"props":3908,"children":3909},{"className":13},[3910],{"type":26,"value":3102},{"type":26,"value":3912}," 的時鐘 ",{"type":21,"tag":107,"props":3914,"children":3915},{"className":13},[3916],{"type":26,"value":3917},"([Sx,2], [Sz,1])",{"type":26,"value":1619},{"type":21,"tag":95,"props":3920,"children":3921},{},[3922,3927],{"type":21,"tag":99,"props":3923,"children":3924},{},[3925],{"type":26,"value":3926},"衝突產生：",{"type":21,"tag":187,"props":3928,"children":3929},{},[3930,3954,3969,3990],{"type":21,"tag":95,"props":3931,"children":3932},{},[3933,3935,3939,3941,3945,3947,3952],{"type":26,"value":3934},"現在系統內存在 ",{"type":21,"tag":107,"props":3936,"children":3937},{"className":13},[3938],{"type":26,"value":3035},{"type":26,"value":3940}," 和 ",{"type":21,"tag":107,"props":3942,"children":3943},{"className":13},[3944],{"type":26,"value":3102},{"type":26,"value":3946}," 兩條",{"type":21,"tag":99,"props":3948,"children":3949},{},[3950],{"type":26,"value":3951},"平行分支",{"type":26,"value":3953},"（皆從 D2 演化而來）。",{"type":21,"tag":95,"props":3955,"children":3956},{},[3957,3961,3962,3967],{"type":21,"tag":107,"props":3958,"children":3959},{"className":13},[3960],{"type":26,"value":3035},{"type":26,"value":3912},{"type":21,"tag":107,"props":3963,"children":3964},{"className":13},[3965],{"type":26,"value":3966},"[Sx:2, Sy:1]",{"type":26,"value":3968}," 與",{"type":21,"tag":95,"props":3970,"children":3971},{},[3972,3976,3977,3982,3984,3989],{"type":21,"tag":107,"props":3973,"children":3974},{"className":13},[3975],{"type":26,"value":3102},{"type":26,"value":3912},{"type":21,"tag":107,"props":3978,"children":3979},{"className":13},[3980],{"type":26,"value":3981},"[Sx:2, Sz:1]",{"type":26,"value":3983}," 互相無法比較誰包含誰（各自有對方沒有的分量），判斷為",{"type":21,"tag":99,"props":3985,"children":3986},{},[3987],{"type":26,"value":3988},"衝突版本",{"type":26,"value":1619},{"type":21,"tag":95,"props":3991,"children":3992},{},[3993,3995],{"type":26,"value":3994},"此時若有讀取請求，\n",{"type":21,"tag":187,"props":3996,"children":3997},{},[3998,4021],{"type":21,"tag":95,"props":3999,"children":4000},{},[4001,4003,4019],{"type":26,"value":4002},"系統會",{"type":21,"tag":99,"props":4004,"children":4005},{},[4006,4008,4012,4013,4017],{"type":26,"value":4007},"同時返回 ",{"type":21,"tag":107,"props":4009,"children":4010},{"className":13},[4011],{"type":26,"value":3035},{"type":26,"value":3940},{"type":21,"tag":107,"props":4014,"children":4015},{"className":13},[4016],{"type":26,"value":3102},{"type":26,"value":4018}," 兩個版本",{"type":26,"value":4020},"給客戶端。",{"type":21,"tag":95,"props":4022,"children":4023},{},[4024,4026,4031,4033,4043],{"type":26,"value":4025},"要求客戶端執行",{"type":21,"tag":99,"props":4027,"children":4028},{},[4029],{"type":26,"value":4030},"應用層合併",{"type":26,"value":4032},"（例如將兩個購物車列表合併）後提交一個最",{"type":21,"tag":99,"props":4034,"children":4035},{},[4036,4038],{"type":26,"value":4037},"終版本 ",{"type":21,"tag":107,"props":4039,"children":4040},{"className":13},[4041],{"type":26,"value":4042},"D5([Sx,3], [Sy,1], [Sz,1])",{"type":26,"value":1619},{"type":21,"tag":95,"props":4045,"children":4046},{},[4047,4052],{"type":21,"tag":99,"props":4048,"children":4049},{},[4050],{"type":26,"value":4051},"衝突合併：",{"type":21,"tag":187,"props":4053,"children":4054},{},[4055,4066,4087,4116],{"type":21,"tag":95,"props":4056,"children":4057},{},[4058,4060,4064],{"type":26,"value":4059},"客戶端解析衝突得到最終結果，再寫入系統（假設透過 ",{"type":21,"tag":107,"props":4061,"children":4062},{"className":13},[4063],{"type":26,"value":3010},{"type":26,"value":4065}," ）。",{"type":21,"tag":95,"props":4067,"children":4068},{},[4069,4073,4075,4079,4081,4086],{"type":21,"tag":107,"props":4070,"children":4071},{"className":13},[4072],{"type":26,"value":3010},{"type":26,"value":4074}," 將合併版本 ",{"type":21,"tag":107,"props":4076,"children":4077},{"className":13},[4078],{"type":26,"value":3188},{"type":26,"value":4080}," 的時鐘更新為 ",{"type":21,"tag":107,"props":4082,"children":4083},{"className":13},[4084],{"type":26,"value":4085},"([Sx,3], [Sy,1], [Sz,1])",{"type":26,"value":1619},{"type":21,"tag":95,"props":4088,"children":4089},{},[4090,4092,4096,4098,4102,4103,4107,4109,4114],{"type":26,"value":4091},"因為 ",{"type":21,"tag":107,"props":4093,"children":4094},{"className":13},[4095],{"type":26,"value":3188},{"type":26,"value":4097}," 包含了之前 ",{"type":21,"tag":107,"props":4099,"children":4100},{"className":13},[4101],{"type":26,"value":3035},{"type":26,"value":914},{"type":21,"tag":107,"props":4104,"children":4105},{"className":13},[4106],{"type":26,"value":3102},{"type":26,"value":4108}," 的所有分量（ ",{"type":21,"tag":107,"props":4110,"children":4111},{"className":13},[4112],{"type":26,"value":4113},"Sx:3 ≥2, Sy:1 ≥1, Sz:1 ≥1",{"type":26,"value":4115}," ），",{"type":21,"tag":95,"props":4117,"children":4118},{},[4119,4121,4125,4127,4132,4134,4138,4139,4143],{"type":26,"value":4120},"因此 ",{"type":21,"tag":107,"props":4122,"children":4123},{"className":13},[4124],{"type":26,"value":3188},{"type":26,"value":4126}," 被視為",{"type":21,"tag":99,"props":4128,"children":4129},{},[4130],{"type":26,"value":4131},"後繼版本",{"type":26,"value":4133},"，舊的 ",{"type":21,"tag":107,"props":4135,"children":4136},{"className":13},[4137],{"type":26,"value":3035},{"type":26,"value":914},{"type":21,"tag":107,"props":4140,"children":4141},{"className":13},[4142],{"type":26,"value":3102},{"type":26,"value":4144}," 可被標記為過時並最終刪除。",{"type":21,"tag":275,"props":4146,"children":4147},{},[],{"type":21,"tag":84,"props":4149,"children":4151},{"id":4150},"節點故障與容錯機制gossip-協議sloppy-quorum-與-hinted-handoff",[4152],{"type":26,"value":4153},"節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff",{"type":21,"tag":75,"props":4155,"children":4156},{},[4157],{"type":21,"tag":22,"props":4158,"children":4159},{},[4160,4162,4167,4169,4174,4176,4181,4183,4188],{"type":26,"value":4161},"在大型分散式系統中，",{"type":21,"tag":99,"props":4163,"children":4164},{},[4165],{"type":26,"value":4166},"節點故障是常態而非例外",{"type":26,"value":4168},"。\n因此，我們需要",{"type":21,"tag":99,"props":4170,"children":4171},{},[4172],{"type":26,"value":4173},"機制",{"type":26,"value":4175},"來",{"type":21,"tag":99,"props":4177,"children":4178},{},[4179],{"type":26,"value":4180},"偵測故障",{"type":26,"value":4182},"以及在",{"type":21,"tag":99,"props":4184,"children":4185},{},[4186],{"type":26,"value":4187},"故障發生時維持系統的可用性",{"type":26,"value":4189},"。\n本節介紹兩類機制：",{"type":21,"tag":187,"props":4191,"children":4192},{},[4193,4225],{"type":21,"tag":95,"props":4194,"children":4195},{},[4196,4201],{"type":21,"tag":99,"props":4197,"children":4198},{},[4199],{"type":26,"value":4200},"故障偵測：",{"type":21,"tag":187,"props":4202,"children":4203},{},[4204],{"type":21,"tag":95,"props":4205,"children":4206},{},[4207,4209],{"type":26,"value":4208},"如何讓所有節點感知彼此的存活狀態，迅速發現節點宕機或網路隔離。\n",{"type":21,"tag":187,"props":4210,"children":4211},{},[4212,4217],{"type":21,"tag":95,"props":4213,"children":4214},{},[4215],{"type":26,"value":4216},"在分散式系統中，如果某個伺服器說另一伺服器已故障，實際上這樣並不足以認為該伺服器確實已故障。",{"type":21,"tag":95,"props":4218,"children":4219},{},[4220],{"type":21,"tag":99,"props":4221,"children":4222},{},[4223],{"type":26,"value":4224},"原則：至少需要有兩個獨立來源提供相同資訊，我們才能把該伺服器標記為故障。",{"type":21,"tag":95,"props":4226,"children":4227},{},[4228,4233],{"type":21,"tag":99,"props":4229,"children":4230},{},[4231],{"type":26,"value":4232},"故障應對：",{"type":21,"tag":187,"props":4234,"children":4235},{},[4236],{"type":21,"tag":95,"props":4237,"children":4238},{},[4239],{"type":26,"value":4240},"當部分節點無法服務時，如何暫時接管其職責以及在其恢復後進行數據補償。",{"type":21,"tag":565,"props":4242,"children":4244},{"id":4243},"_1故障偵測-gossip-協議",[4245],{"type":21,"tag":99,"props":4246,"children":4247},{},[4248],{"type":26,"value":4249},"（1）故障偵測 – Gossip 協議：",{"type":21,"tag":187,"props":4251,"children":4252},{},[4253,4274],{"type":21,"tag":95,"props":4254,"children":4255},{},[4256,4261,4263,4268,4270],{"type":21,"tag":99,"props":4257,"children":4258},{},[4259],{"type":26,"value":4260},"傳統做法：",{"type":26,"value":4262}," 是一個節點向全體其它節點定期發送心跳 ",{"type":21,"tag":99,"props":4264,"children":4265},{},[4266],{"type":26,"value":4267},"（ all-to-all 心跳 ）",{"type":26,"value":4269},"，但在節點很多時網絡開銷巨大。\n",{"type":21,"tag":416,"props":4271,"children":4273},{"alt":418,"src":4272},"/images/sdi-aig/06/img-6-10.png",[],{"type":21,"tag":95,"props":4275,"children":4276},{},[4277,4282,4403,4406,4411,4429,4444],{"type":21,"tag":99,"props":4278,"children":4279},{},[4280],{"type":26,"value":4281},"改進方案是 Gossip（八卦）協議，其特點類似社交場合的流言傳播：",{"type":21,"tag":187,"props":4283,"children":4284},{},[4285,4305,4318,4349,4359,4382],{"type":21,"tag":95,"props":4286,"children":4287},{},[4288,4290,4295,4297],{"type":26,"value":4289},"每個節點維護一份成員列表 ( ",{"type":21,"tag":99,"props":4291,"children":4292},{},[4293],{"type":26,"value":4294},"去中心化",{"type":26,"value":4296}," )",{"type":21,"tag":187,"props":4298,"children":4299},{},[4300],{"type":21,"tag":95,"props":4301,"children":4302},{},[4303],{"type":26,"value":4304},"記錄集群中其他節點的 ID 及其心跳計數器等資訊。",{"type":21,"tag":95,"props":4306,"children":4307},{},[4308,4310],{"type":26,"value":4309},"時鐘1：定時（例如每隔 w 秒），表示「我還活著」。",{"type":21,"tag":187,"props":4311,"children":4312},{},[4313],{"type":21,"tag":95,"props":4314,"children":4315},{},[4316],{"type":26,"value":4317},"各節點獨立地每隔固定時間增加自己的心跳計數。",{"type":21,"tag":95,"props":4319,"children":4320},{},[4321,4323],{"type":26,"value":4322},"時鐘2：定時（例如每隔 𝑡 秒），表示「刷存在感」。",{"type":21,"tag":187,"props":4324,"children":4325},{},[4326,4331],{"type":21,"tag":95,"props":4327,"children":4328},{},[4329],{"type":26,"value":4330},"每個節點從成員列表中隨機選擇幾個節點，",{"type":21,"tag":95,"props":4332,"children":4333},{},[4334,4336],{"type":26,"value":4335},"將自己的心跳資訊發送給接收者。\n",{"type":21,"tag":187,"props":4337,"children":4338},{},[4339,4344],{"type":21,"tag":95,"props":4340,"children":4341},{},[4342],{"type":26,"value":4343},"接收者：更新對應節點的心跳值，",{"type":21,"tag":95,"props":4345,"children":4346},{},[4347],{"type":26,"value":4348},"接收者：繼續隨機節點轉發，類似病毒傳播地散播心跳消息。",{"type":21,"tag":95,"props":4350,"children":4351},{},[4352,4357],{"type":21,"tag":99,"props":4353,"children":4354},{},[4355],{"type":26,"value":4356},"節點收到某成員的信息：",{"type":26,"value":4358}," 會更新本地成員列表，確保彼此盡量最終收斂到一致的最新成員狀態。",{"type":21,"tag":95,"props":4360,"children":4361},{},[4362,4367,4369,4374,4376,4381],{"type":21,"tag":99,"props":4363,"children":4364},{},[4365],{"type":26,"value":4366},"判定失效：",{"type":26,"value":4368}," 若成員列表中某節點的心跳值在",{"type":21,"tag":99,"props":4370,"children":4371},{},[4372],{"type":26,"value":4373},"超過一定時間沒有增長",{"type":26,"value":4375},"（ 例如超過 5 個 heartbeat 週期 ），則認定該節點",{"type":21,"tag":99,"props":4377,"children":4378},{},[4379],{"type":26,"value":4380},"離線",{"type":26,"value":1619},{"type":21,"tag":95,"props":4383,"children":4384},{},[4385,4390],{"type":21,"tag":99,"props":4386,"children":4387},{},[4388],{"type":26,"value":4389},"好處：",{"type":21,"tag":187,"props":4391,"children":4392},{},[4393,4398],{"type":21,"tag":95,"props":4394,"children":4395},{},[4396],{"type":26,"value":4397},"透過 Gossip 機制，整個集群能在較小網絡開銷下達成對故障節點的共識。",{"type":21,"tag":95,"props":4399,"children":4400},{},[4401],{"type":26,"value":4402},"由於採隨機對等傳播，Gossip 在大規模節點時的消息數量只線性增加且具高度冗餘，不易有單點瓶頸。",{"type":21,"tag":275,"props":4404,"children":4405},{},[],{"type":21,"tag":99,"props":4407,"children":4408},{},[4409],{"type":26,"value":4410},"圖 6-11 示範：",{"type":21,"tag":99,"props":4412,"children":4413},{},[4414,4415,4420,4422,4427],{"type":26,"value":900},{"type":21,"tag":107,"props":4416,"children":4417},{"className":13},[4418],{"type":26,"value":4419},"s0",{"type":26,"value":4421}," 偵測到節點 ",{"type":21,"tag":107,"props":4423,"children":4424},{"className":13},[4425],{"type":26,"value":4426},"s2",{"type":26,"value":4428}," 長時間沒心跳，",{"type":21,"tag":99,"props":4430,"children":4431},{},[4432,4436,4438,4442],{"type":21,"tag":107,"props":4433,"children":4434},{"className":13},[4435],{"type":26,"value":4419},{"type":26,"value":4437}," 將此資訊隨 Gossip 傳給其他節點，最終全網標記 ",{"type":21,"tag":107,"props":4439,"children":4440},{"className":13},[4441],{"type":26,"value":4426},{"type":26,"value":4443}," 故障。",{"type":21,"tag":416,"props":4445,"children":4447},{"alt":418,"src":4446},"/images/sdi-aig/06/img-6-11.png",[],{"type":21,"tag":565,"props":4449,"children":4451},{"id":4450},"_2臨時故障應對-sloppy-quorum-hinted-handoff",[4452],{"type":21,"tag":99,"props":4453,"children":4454},{},[4455],{"type":26,"value":4456},"（2）臨時故障應對 – Sloppy Quorum & Hinted Handoff：",{"type":21,"tag":187,"props":4458,"children":4459},{},[4460,4465],{"type":21,"tag":95,"props":4461,"children":4462},{},[4463],{"type":26,"value":4464},"發現節點故障後，系統應繼續提供服務而不強制等待故障節點恢復。",{"type":21,"tag":95,"props":4466,"children":4467},{},[4468,4470,4581,4584,4589,4594,4598,4601,4606,4619,4622,4627],{"type":26,"value":4469},"這涉及兩個機制：",{"type":21,"tag":187,"props":4471,"children":4472},{},[4473,4547],{"type":21,"tag":95,"props":4474,"children":4475},{},[4476,4481],{"type":21,"tag":99,"props":4477,"children":4478},{},[4479],{"type":26,"value":4480},"Sloppy Quorum（草率仲裁）：",{"type":21,"tag":187,"props":4482,"children":4483},{},[4484,4494,4515,4535],{"type":21,"tag":95,"props":4485,"children":4486},{},[4487,4492],{"type":21,"tag":99,"props":4488,"children":4489},{},[4490],{"type":26,"value":4491},"為了提高可用性，暫時放寬 Quorum 的嚴格一致性要求。",{"type":26,"value":4493}," 在原本需要與特定 N 個副本交互的基礎上，改為：",{"type":21,"tag":95,"props":4495,"children":4496},{},[4497,4502],{"type":21,"tag":99,"props":4498,"children":4499},{},[4500],{"type":26,"value":4501},"寫入：",{"type":21,"tag":187,"props":4503,"children":4504},{},[4505,4510],{"type":21,"tag":95,"props":4506,"children":4507},{},[4508],{"type":26,"value":4509},"繞過故障節點",{"type":21,"tag":95,"props":4511,"children":4512},{},[4513],{"type":26,"value":4514},"在雜湊環上選擇前 W 個運行狀良好的伺服器進行寫入，即算成功。",{"type":21,"tag":95,"props":4516,"children":4517},{},[4518,4523],{"type":21,"tag":99,"props":4519,"children":4520},{},[4521],{"type":26,"value":4522},"讀取：",{"type":21,"tag":187,"props":4524,"children":4525},{},[4526,4530],{"type":21,"tag":95,"props":4527,"children":4528},{},[4529],{"type":26,"value":4509},{"type":21,"tag":95,"props":4531,"children":4532},{},[4533],{"type":26,"value":4534},"在雜湊環上選擇前 R 個運行狀良好的伺服器進行讀取，即算成功。",{"type":21,"tag":95,"props":4536,"children":4537},{},[4538,4540,4545],{"type":26,"value":4539},"只要",{"type":21,"tag":99,"props":4541,"children":4542},{},[4543],{"type":26,"value":4544},"存活節點數量尚 >= W 或 R",{"type":26,"value":4546},"，讀寫操作就不會因單節點故障而被阻斷，提高了可用性。",{"type":21,"tag":95,"props":4548,"children":4549},{},[4550,4555,4557,4560,4562,4567,4568],{"type":21,"tag":99,"props":4551,"children":4552},{},[4553],{"type":26,"value":4554},"Hinted Handoff（提示換手）：",{"type":26,"value":4556},"\n寫入因 Sloppy Quorum 被臨時寫到代管節點，如何在故障節點恢復後補回缺失的更新？",{"type":21,"tag":275,"props":4558,"children":4559},{},[],{"type":26,"value":4561},"答案是",{"type":21,"tag":99,"props":4563,"children":4564},{},[4565],{"type":26,"value":4566},"提示換手",{"type":26,"value":3000},{"type":21,"tag":187,"props":4569,"children":4570},{},[4571,4576],{"type":21,"tag":95,"props":4572,"children":4573},{},[4574],{"type":26,"value":4575},"代管寫入的節點會將針對故障節點的更新保存下來（附上「給節點 X 的資料變更」提示）。",{"type":21,"tag":95,"props":4577,"children":4578},{},[4579],{"type":26,"value":4580},"等偵測到原故障節點重新上線後，代管者再將這些更新“轉交”回原設置應儲存該資料的節點，完成補寫。",{"type":21,"tag":275,"props":4582,"children":4583},{},[],{"type":21,"tag":99,"props":4585,"children":4586},{},[4587],{"type":26,"value":4588},"圖 6-12 所示，",{"type":21,"tag":99,"props":4590,"children":4591},{},[4592],{"type":26,"value":4593},"s2 故障期間 s3 代管了本屬於 s2 的更新，當 s2 恢復時，s3 將相關資料交還給 s2。",{"type":21,"tag":416,"props":4595,"children":4597},{"alt":418,"src":4596},"/images/sdi-aig/06/img-6-12.png",[],{"type":21,"tag":275,"props":4599,"children":4600},{},[],{"type":21,"tag":99,"props":4602,"children":4603},{},[4604],{"type":26,"value":4605},"上述兩者的結合增強可用性",{"type":21,"tag":187,"props":4607,"children":4608},{},[4609,4614],{"type":21,"tag":95,"props":4610,"children":4611},{},[4612],{"type":26,"value":4613},"在短暫節點故障期間，系統仍能對外提供近乎正常的服務。",{"type":21,"tag":95,"props":4615,"children":4616},{},[4617],{"type":26,"value":4618},"當節點恢復後又能將資料漸進糾正，實現最終一致。",{"type":21,"tag":275,"props":4620,"children":4621},{},[],{"type":21,"tag":99,"props":4623,"children":4624},{},[4625],{"type":26,"value":4626},"犧牲了一定程度的一致性保證",{"type":21,"tag":187,"props":4628,"children":4629},{},[4630],{"type":21,"tag":95,"props":4631,"children":4632},{},[4633],{"type":26,"value":4634},"Sloppy Quorum 犧牲了一定一致性保證，可能讀不到最新寫入（ 因寫到臨時節點 ），但換來的是更高的故障容忍和持續服務能力。",{"type":21,"tag":565,"props":4636,"children":4638},{"id":4637},"_3永久故障應對-防止資料長期不一致-merkle-tree",[4639],{"type":21,"tag":99,"props":4640,"children":4641},{},[4642],{"type":26,"value":4643},"（3）永久故障應對 – 防止資料長期不一致： Merkle Tree",{"type":21,"tag":187,"props":4645,"children":4646},{},[4647,4665,4676,4732],{"type":21,"tag":95,"props":4648,"children":4649},{},[4650,4652,4657,4659,4664],{"type":26,"value":4651},"如果某節點",{"type":21,"tag":99,"props":4653,"children":4654},{},[4655],{"type":26,"value":4656},"永久失效（ 例如硬碟損毀無法恢復數據 ）",{"type":26,"value":4658},"，則使用上述",{"type":21,"tag":99,"props":4660,"children":4661},{},[4662],{"type":26,"value":4663},"提示換手也無法把它「喚醒」",{"type":26,"value":1619},{"type":21,"tag":95,"props":4666,"children":4667},{},[4668,4670,4675],{"type":26,"value":4669},"此時通常透過 ",{"type":21,"tag":99,"props":4671,"children":4672},{},[4673],{"type":26,"value":4674},"反熵（Anti-Entropy）機制在存活節點間進行資料修復同步",{"type":26,"value":1619},{"type":21,"tag":95,"props":4677,"children":4678},{},[4679,4681,4686,4724],{"type":26,"value":4680},"典型手段是使用 ",{"type":21,"tag":99,"props":4682,"children":4683},{},[4684],{"type":26,"value":4685},"Merkle Tree（梅克爾樹，又稱雜湊樹） 來高效比較大範圍資料：",{"type":21,"tag":187,"props":4687,"children":4688},{},[4689,4714],{"type":21,"tag":95,"props":4690,"children":4691},{},[4692,4694,4699,4701,4706,4708,4713],{"type":26,"value":4693},"透過對資料集合計算出",{"type":21,"tag":99,"props":4695,"children":4696},{},[4697],{"type":26,"value":4698},"層次化",{"type":26,"value":4700},"的雜湊，\n以",{"type":21,"tag":99,"props":4702,"children":4703},{},[4704],{"type":26,"value":4705},"快速定位",{"type":26,"value":4707},"哪個區段資料不一致，\n並能",{"type":21,"tag":99,"props":4709,"children":4710},{},[4711],{"type":26,"value":4712},"最小化資料傳輸",{"type":26,"value":1619},{"type":21,"tag":95,"props":4715,"children":4716},{},[4717,4719],{"type":26,"value":4718},"Amazon Dynamo 實作",{"type":21,"tag":99,"props":4720,"children":4721},{},[4722],{"type":26,"value":4723},"基於 Merkle 樹的反熵協議，確保副本間數據一致性。",{"type":21,"tag":196,"props":4725,"children":4727},{"code":4726},"將整個 key 空間分塊，\n(1) 各節點對每塊計算雜湊，構建一棵樹並從根比對，若根相同則所有子樹都相同；\n(2) 若根不同，則只需下探有差異的子樹分支，迅速找出不一致的鍵集合。\n(3) 找到差異後，再進行資料補償同步。\n(4) 透過定期運行 Merkle 樹比較，各副本可在後台修復長期分歧，最終達成一致。\n",[4728],{"type":21,"tag":107,"props":4729,"children":4730},{"__ignoreMap":13},[4731],{"type":26,"value":4726},{"type":21,"tag":95,"props":4733,"children":4734},{},[4735,4740,4748,4751,4755,4757,4760,4766,4769,4775,4781,4803,4806,4812,4857,4860,4866,4892,4895,4901,4921,4924,4930,4964,4967,4973,5052],{"type":21,"tag":99,"props":4736,"children":4737},{},[4738],{"type":26,"value":4739},"維基百科 Merkle Tree",{"type":21,"tag":196,"props":4741,"children":4743},{"code":4742},"雜湊樹（hash tree；Merkle tree），\n在密碼學及電腦科學中是一種樹形資料結構，\n每個葉節點均以資料塊的雜湊作為標籤，\n而除了葉節點以外的節點則以其子節點標籤的加密雜湊作為標籤。\n\n雜湊樹能夠高效、安全地驗證大型資料結構的內容，是雜湊鏈的推廣形式。\n",[4744],{"type":21,"tag":107,"props":4745,"children":4746},{"__ignoreMap":13},[4747],{"type":26,"value":4742},{"type":21,"tag":275,"props":4749,"children":4750},{},[],{"type":21,"tag":416,"props":4752,"children":4754},{"alt":418,"src":4753},"/images/sdi-aig/06/img-markle-tree.png",[],{"type":26,"value":4756},"\n二元雜湊樹範例。\n雜湊 0-0 和 0-1 分別是資料塊 L1 和 L2 的雜湊值。\n雜湊 0 是將雜湊 0-0 和 0-1 連接後所取得的雜湊值。",{"type":21,"tag":275,"props":4758,"children":4759},{},[],{"type":21,"tag":29,"props":4761,"children":4764},{"href":4762,"rel":4763},"https://www.youtube.com/watch?v=pRwvZzxcH2w",[33],[4765],{"type":26,"value":4762},{"type":21,"tag":38,"props":4767,"children":4768},{},[],{"type":21,"tag":565,"props":4770,"children":4772},{"id":4771},"merkle-樹建構流程舉例鍵空間-112",[4773],{"type":26,"value":4774},"🔍 Merkle 樹建構流程（舉例：鍵空間 1～12）",{"type":21,"tag":618,"props":4776,"children":4778},{"id":4777},"說明",[4779],{"type":26,"value":4780},"🎯 說明：",{"type":21,"tag":75,"props":4782,"children":4783},{},[4784],{"type":21,"tag":22,"props":4785,"children":4786},{},[4787,4789,4794,4796,4801],{"type":26,"value":4788},"假設我們的鍵值範圍是 ",{"type":21,"tag":107,"props":4790,"children":4791},{"className":13},[4792],{"type":26,"value":4793},"1 到 12",{"type":26,"value":4795},"，以下是如何建構出對應的 Merkle 樹。\n過程中若有異常（如資料不一致），會以",{"type":21,"tag":99,"props":4797,"children":4798},{},[4799],{"type":26,"value":4800},"特別標記的方塊",{"type":26,"value":4802},"來呈現。",{"type":21,"tag":38,"props":4804,"children":4805},{},[],{"type":21,"tag":618,"props":4807,"children":4809},{"id":4808},"step-1鍵值劃分桶子圖-6-13",[4810],{"type":26,"value":4811},"🧩 Step 1：鍵值劃分桶子（圖 6-13）",{"type":21,"tag":75,"props":4813,"children":4814},{},[4815],{"type":21,"tag":187,"props":4816,"children":4817},{},[4818,4829,4841],{"type":21,"tag":95,"props":4819,"children":4820},{},[4821,4823,4828],{"type":26,"value":4822},"將鍵的空間平均劃分為多個「桶子（bucket）」，本例中共 ",{"type":21,"tag":99,"props":4824,"children":4825},{},[4826],{"type":26,"value":4827},"4 個桶子",{"type":26,"value":1619},{"type":21,"tag":95,"props":4830,"children":4831},{},[4832,4834,4839],{"type":26,"value":4833},"每個桶子會對應一棵子樹的",{"type":21,"tag":99,"props":4835,"children":4836},{},[4837],{"type":26,"value":4838},"根節點（root level node）",{"type":26,"value":4840},"，後續用來維護這個桶內的資料結構。",{"type":21,"tag":95,"props":4842,"children":4843},{},[4844,4846,4851,4853],{"type":26,"value":4845},"📌 ",{"type":21,"tag":99,"props":4847,"children":4848},{},[4849],{"type":26,"value":4850},"目的：",{"type":26,"value":4852}," 降低單一 Merkle 樹過大，提升定位異常的效率。\n",{"type":21,"tag":416,"props":4854,"children":4856},{"alt":418,"src":4855},"/images/sdi-aig/06/img-6-13.png",[],{"type":21,"tag":38,"props":4858,"children":4859},{},[],{"type":21,"tag":618,"props":4861,"children":4863},{"id":4862},"step-2鍵值雜湊圖-6-14",[4864],{"type":26,"value":4865},"🔐 Step 2：鍵值雜湊（圖 6-14）",{"type":21,"tag":75,"props":4867,"children":4868},{},[4869],{"type":21,"tag":187,"props":4870,"children":4871},{},[4872,4883],{"type":21,"tag":95,"props":4873,"children":4874},{},[4875,4877,4882],{"type":26,"value":4876},"對每個桶子內的所有鍵值進行",{"type":21,"tag":99,"props":4878,"children":4879},{},[4880],{"type":26,"value":4881},"統一的 hash 處理",{"type":26,"value":1619},{"type":21,"tag":95,"props":4884,"children":4885},{},[4886,4888],{"type":26,"value":4887},"這些 hash 結果將作為 Merkle Tree 的葉節點（leaf nodes）。\n",{"type":21,"tag":416,"props":4889,"children":4891},{"alt":418,"src":4890},"/images/sdi-aig/06/img-6-14.png",[],{"type":21,"tag":38,"props":4893,"children":4894},{},[],{"type":21,"tag":618,"props":4896,"children":4898},{"id":4897},"step-3建立桶子層級的雜湊節點圖-6-15",[4899],{"type":26,"value":4900},"🌿 Step 3：建立桶子層級的雜湊節點（圖 6-15）",{"type":21,"tag":75,"props":4902,"children":4903},{},[4904],{"type":21,"tag":187,"props":4905,"children":4906},{},[4907,4912],{"type":21,"tag":95,"props":4908,"children":4909},{},[4910],{"type":26,"value":4911},"每個桶子產生一個對應的 hash node，代表該桶整體資料狀態。",{"type":21,"tag":95,"props":4913,"children":4914},{},[4915,4917],{"type":26,"value":4916},"這些節點會作為上層 Merkle Tree 的中繼節點（intermediate nodes）。\n",{"type":21,"tag":416,"props":4918,"children":4920},{"alt":418,"src":4919},"/images/sdi-aig/06/img-6-15.png",[],{"type":21,"tag":38,"props":4922,"children":4923},{},[],{"type":21,"tag":3274,"props":4925,"children":4927},{"id":4926},"step-4建構最終的-merkle-樹圖-6-16",[4928],{"type":26,"value":4929},"🌳 Step 4：建構最終的 Merkle 樹（圖 6-16）",{"type":21,"tag":75,"props":4931,"children":4932},{},[4933],{"type":21,"tag":187,"props":4934,"children":4935},{},[4936,4948],{"type":21,"tag":95,"props":4937,"children":4938},{},[4939,4941,4946],{"type":26,"value":4940},"從每個桶子的 hash node 開始，",{"type":21,"tag":99,"props":4942,"children":4943},{},[4944],{"type":26,"value":4945},"兩兩組合並進行 hash",{"type":26,"value":4947},"，逐層向上建構。",{"type":21,"tag":95,"props":4949,"children":4950},{},[4951,4953,4958,4960],{"type":26,"value":4952},"最終會得到一個全域的 ",{"type":21,"tag":99,"props":4954,"children":4955},{},[4956],{"type":26,"value":4957},"Merkle Root",{"type":26,"value":4959},"，可用來表示整體系統資料的一致性狀態。\n",{"type":21,"tag":416,"props":4961,"children":4963},{"alt":418,"src":4962},"/images/sdi-aig/06/img-6-16.png",[],{"type":21,"tag":38,"props":4965,"children":4966},{},[],{"type":21,"tag":3274,"props":4968,"children":4970},{"id":4969},"merkle-tree-優點整理",[4971],{"type":26,"value":4972},"✅ Merkle Tree 優點整理",{"type":21,"tag":4974,"props":4975,"children":4976},"table",{},[4977,4995],{"type":21,"tag":4978,"props":4979,"children":4980},"thead",{},[4981],{"type":21,"tag":4982,"props":4983,"children":4984},"tr",{},[4985,4991],{"type":21,"tag":4986,"props":4987,"children":4988},"th",{},[4989],{"type":26,"value":4990},"特性",{"type":21,"tag":4986,"props":4992,"children":4993},{},[4994],{"type":26,"value":4777},{"type":21,"tag":4996,"props":4997,"children":4998},"tbody",{},[4999,5013,5026,5039],{"type":21,"tag":4982,"props":5000,"children":5001},{},[5002,5008],{"type":21,"tag":5003,"props":5004,"children":5005},"td",{},[5006],{"type":26,"value":5007},"區域性更新",{"type":21,"tag":5003,"props":5009,"children":5010},{},[5011],{"type":26,"value":5012},"只需更新變更桶子對應的子樹及相關 hash，其他部分保持不變",{"type":21,"tag":4982,"props":5014,"children":5015},{},[5016,5021],{"type":21,"tag":5003,"props":5017,"children":5018},{},[5019],{"type":26,"value":5020},"快速偵測異常",{"type":21,"tag":5003,"props":5022,"children":5023},{},[5024],{"type":26,"value":5025},"比對 root hash，若不一致即可快速縮小範圍至異常桶子",{"type":21,"tag":4982,"props":5027,"children":5028},{},[5029,5034],{"type":21,"tag":5003,"props":5030,"children":5031},{},[5032],{"type":26,"value":5033},"易於擴充",{"type":21,"tag":5003,"props":5035,"children":5036},{},[5037],{"type":26,"value":5038},"桶子數可依據資料規模動態調整，適合大規模分散式系統",{"type":21,"tag":4982,"props":5040,"children":5041},{},[5042,5047],{"type":21,"tag":5003,"props":5043,"children":5044},{},[5045],{"type":26,"value":5046},"應用場景",{"type":21,"tag":5003,"props":5048,"children":5049},{},[5050],{"type":26,"value":5051},"區塊鏈、分散式檔案系統（如 IPFS）、資料一致性檢查與同步機制等",{"type":21,"tag":38,"props":5053,"children":5054},{},[],{"type":21,"tag":275,"props":5056,"children":5057},{},[],{"type":26,"value":5059}," \n",{"type":21,"tag":196,"props":5061,"children":5063},{"code":5062},"只要使用 Merkle Tree 的做法，\n需要同步的資料量就會與兩個副本之間的差異(而不是所包含資料量)成正比。\n\n在實際的系統中，\n桶子的尺寸有可能相當大。\n舉例來說，我們可能會設定每十億個鍵對應一百萬個桶子，如此一來，每個桶子就包含 1000 個鍵。\n",[5064],{"type":21,"tag":107,"props":5065,"children":5066},{"__ignoreMap":13},[5067],{"type":26,"value":5062},{"type":21,"tag":275,"props":5069,"children":5070},{},[],{"type":21,"tag":565,"props":5072,"children":5074},{"id":5073},"_4資料中心服務中斷的問題-跨多個資料中心複製資料的做法非常重要",[5075],{"type":21,"tag":99,"props":5076,"children":5077},{},[5078],{"type":26,"value":5079},"（4）資料中心服務中斷的問題： 跨多個資料中心複製資料的做法非常重要。",{"type":21,"tag":275,"props":5081,"children":5082},{},[],{"type":21,"tag":84,"props":5084,"children":5086},{"id":5085},"回顧一下",[5087],{"type":21,"tag":2342,"props":5088,"children":5089},{},[5090],{"type":21,"tag":99,"props":5091,"children":5092},{},[5093],{"type":26,"value":5094},"📌 回顧一下",{"type":21,"tag":3274,"props":5096,"children":5098},{"id":5097},"session-3-階段內容至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰",[5099,5101,5106],{"type":26,"value":5100},"Session 3 階段內容，至此我們聚焦在分散式鍵值存儲系統中",{"type":21,"tag":99,"props":5102,"children":5103},{},[5104],{"type":26,"value":5105},"一致性與容錯",{"type":26,"value":5107},"挑戰",{"type":21,"tag":22,"props":5109,"children":5110},{},[5111],{"type":26,"value":5112},"(1) 資料分區：一致性雜湊與水平擴充",{"type":21,"tag":22,"props":5114,"children":5115},{},[5116],{"type":26,"value":5117},"(2) 資料複製：高可用性的基石",{"type":21,"tag":22,"props":5119,"children":5120},{},[5121],{"type":26,"value":5122},"(3) 一致性：Quorum 機制與最終一致性",{"type":21,"tag":22,"props":5124,"children":5125},{},[5126],{"type":26,"value":5127},"(4) 不一致問題的解決方式：版本控制 ( Versioning ) 與向量時鐘 ( Vector Clock )",{"type":21,"tag":22,"props":5129,"children":5130},{},[5131],{"type":26,"value":5132},"(5) 節點故障與容錯機制：Gossip 協議、Sloppy Quorum 與 Hinted Handoff",{"type":21,"tag":22,"props":5134,"children":5135},{},[5136],{"type":26,"value":5137},"我們已構建起一個分散式鍵值存儲的完整藍圖，",{"type":21,"tag":22,"props":5139,"children":5140},{},[5141],{"type":26,"value":5142},"涵蓋從資料分區、複製到一致性維護、故障處理的各方面。",{"type":21,"tag":22,"props":5144,"children":5145},{},[5146],{"type":26,"value":5147},"主要收穫包括：",{"type":21,"tag":187,"props":5149,"children":5150},{},[5151,5175,5192,5209],{"type":21,"tag":95,"props":5152,"children":5153},{},[5154,5159,5161,5166,5168,5173],{"type":21,"tag":99,"props":5155,"children":5156},{},[5157],{"type":26,"value":5158},"一致性模型選擇：",{"type":26,"value":5160}," 綜上，本系統採用",{"type":21,"tag":99,"props":5162,"children":5163},{},[5164],{"type":26,"value":5165},"最終一致性",{"type":26,"value":5167},"模型，強調高可用性與容錯。但我們也提供參數使其一致性",{"type":21,"tag":99,"props":5169,"children":5170},{},[5171],{"type":26,"value":5172},"可調",{"type":26,"value":5174},"（Consistency Tunable），例如客戶端可根據需求選擇不同 R、W 配置來實現從弱一致到強一致的切換。",{"type":21,"tag":95,"props":5176,"children":5177},{},[5178,5183,5185,5190],{"type":21,"tag":99,"props":5179,"children":5180},{},[5181],{"type":26,"value":5182},"調節一致性的策略：",{"type":26,"value":5184}," Quorum 機制允許我們通過調整 W、R ",{"type":21,"tag":99,"props":5186,"children":5187},{},[5188],{"type":26,"value":5189},"在一致性與延遲間找到平衡點",{"type":26,"value":5191},"。對追求最終一致性的系統，可選較小 W、R 以降低延遲；如需強一致，可設定 W+R > N。",{"type":21,"tag":95,"props":5193,"children":5194},{},[5195,5200,5202,5207],{"type":21,"tag":99,"props":5196,"children":5197},{},[5198],{"type":26,"value":5199},"衝突偵測與解決：",{"type":26,"value":5201}," 透過",{"type":21,"tag":99,"props":5203,"children":5204},{},[5205],{"type":26,"value":5206},"向量時鐘",{"type":26,"value":5208},"為每個鍵值跟蹤多副本的版本演進史，偵測並行更新造成的衝突。在需要時將多版本交由客戶端合併，確保沒有寫入被無故覆蓋或遺失。儘管增加實現複雜度，但對於高度可用系統而言，這是達成最終一致性的關鍵。",{"type":21,"tag":95,"props":5210,"children":5211},{},[5212,5217,5219],{"type":21,"tag":99,"props":5213,"children":5214},{},[5215],{"type":26,"value":5216},"故障容錯機制：",{"type":26,"value":5218}," Gossip 協議提供去中心化且高容錯的故障偵測方案，讓集群快速達成對節點存活狀態的共識。Sloppy Quorum 和 Hinted Handoff 則在節點臨時故障時維持服務不中斷，並在其恢復後自動補齊資料，提升整體可用性。永久性故障下，",{"type":21,"tag":99,"props":5220,"children":5221},{},[5222],{"type":26,"value":5223},"借助 Merkle 樹等反熵演算法，系統能找出並同步遺失的資料片段。",{"type":21,"tag":84,"props":5225,"children":5227},{"id":5226},"最後關注系統的實際架構實作",[5228],{"type":21,"tag":2342,"props":5229,"children":5230},{},[5231],{"type":21,"tag":99,"props":5232,"children":5233},{},[5234],{"type":26,"value":5235},"📌 最後關注系統的實際架構實作",{"type":21,"tag":22,"props":5237,"children":5238},{},[5239],{"type":21,"tag":99,"props":5240,"children":5241},{},[5242],{"type":26,"value":5243},"包括資料存儲引擎（寫入/讀取路徑）以及一個使用 C# + MSSQL 的簡易鍵值存儲 API 範例，並探討幾個現代鍵值存儲系統作比較。",{"type":21,"tag":187,"props":5245,"children":5246},{},[5247,5251,5255],{"type":21,"tag":95,"props":5248,"children":5249},{},[5250],{"type":26,"value":1216},{"type":21,"tag":95,"props":5252,"children":5253},{},[5254],{"type":26,"value":1221},{"type":21,"tag":95,"props":5256,"children":5257},{},[5258],{"type":26,"value":1226},{"type":21,"tag":275,"props":5260,"children":5261},{},[],{"type":21,"tag":84,"props":5263,"children":5265},{"id":5264},"系統架構圖整體架構與資料存儲引擎",[5266],{"type":26,"value":5267},"系統架構圖：整體架構與資料存儲引擎",{"type":21,"tag":75,"props":5269,"children":5270},{},[5271],{"type":21,"tag":22,"props":5272,"children":5273},{},[5274],{"type":26,"value":5275},"綜合前述設計，\n我們的鍵值存儲系統架構可以描述如下：",{"type":21,"tag":187,"props":5277,"children":5278},{},[5279,5289,5306,5323,5354],{"type":21,"tag":95,"props":5280,"children":5281},{},[5282,5287],{"type":21,"tag":99,"props":5283,"children":5284},{},[5285],{"type":26,"value":5286},"無中心架構（Decentralized）：",{"type":26,"value":5288}," 集群中無主從之分，每個節點職責相當（均可作為請求協調者、均存儲部分資料）。這避免單點瓶頸，提升可靠性。",{"type":21,"tag":95,"props":5290,"children":5291},{},[5292,5297,5299,5304],{"type":21,"tag":99,"props":5293,"children":5294},{},[5295],{"type":26,"value":5296},"請求路由：",{"type":26,"value":5298}," 客戶端發出的請求（讀或寫），可透過",{"type":21,"tag":99,"props":5300,"children":5301},{},[5302],{"type":26,"value":5303},"一致性雜湊",{"type":26,"value":5305},"機制路由到對應的節點處理。實務中通常由客戶端或中介負責計算鍵的雜湊並選擇節點，或者設置每個節點都能轉發請求到正確節點。",{"type":21,"tag":95,"props":5307,"children":5308},{},[5309,5314,5316,5321],{"type":21,"tag":99,"props":5310,"children":5311},{},[5312],{"type":26,"value":5313},"協調者：",{"type":26,"value":5315}," 處理請求的節點扮演",{"type":21,"tag":99,"props":5317,"children":5318},{},[5319],{"type":26,"value":5320},"協調者",{"type":26,"value":5322},"角色（Coordinator），充當客戶端與存儲節點之間的代理。協調者負責與副本節點通信以完成讀寫 Quorum。",{"type":21,"tag":95,"props":5324,"children":5325},{},[5326,5331,5333,5338,5340,5345,5347,5352],{"type":21,"tag":99,"props":5327,"children":5328},{},[5329],{"type":26,"value":5330},"資料存儲層：",{"type":26,"value":5332}," 每個節點本地維護存儲引擎，包括",{"type":21,"tag":99,"props":5334,"children":5335},{},[5336],{"type":26,"value":5337},"記憶體快取",{"type":26,"value":5339},"（memtable）與",{"type":21,"tag":99,"props":5341,"children":5342},{},[5343],{"type":26,"value":5344},"磁碟資料檔",{"type":26,"value":5346},"（如 SSTable）等，用以快速存取和持久化資料。為性能，經常採用",{"type":21,"tag":99,"props":5348,"children":5349},{},[5350],{"type":26,"value":5351},"基於日誌的結構存儲（LSM Tree）",{"type":26,"value":5353}," 模型。",{"type":21,"tag":95,"props":5355,"children":5356},{},[5357,5362],{"type":21,"tag":99,"props":5358,"children":5359},{},[5360],{"type":26,"value":5361},"組件回顧：",{"type":21,"tag":187,"props":5363,"children":5364},{},[5365,5375,5385,5394,5404],{"type":21,"tag":95,"props":5366,"children":5367},{},[5368,5373],{"type":21,"tag":99,"props":5369,"children":5370},{},[5371],{"type":26,"value":5372},"分區",{"type":26,"value":5374},"：一致性雜湊確定資料歸屬節點，支撐水平擴展。",{"type":21,"tag":95,"props":5376,"children":5377},{},[5378,5383],{"type":21,"tag":99,"props":5379,"children":5380},{},[5381],{"type":26,"value":5382},"複製",{"type":26,"value":5384},"：多副本存放與跨機房配置保證高可用。",{"type":21,"tag":95,"props":5386,"children":5387},{},[5388,5392],{"type":21,"tag":99,"props":5389,"children":5390},{},[5391],{"type":26,"value":1201},{"type":26,"value":5393},"：Quorum 共識 + 調整 R/W 保證讀寫一致性。",{"type":21,"tag":95,"props":5395,"children":5396},{},[5397,5402],{"type":21,"tag":99,"props":5398,"children":5399},{},[5400],{"type":26,"value":5401},"衝突解決",{"type":26,"value":5403},"：向量時鐘 & 客戶端合併應對並發更新。",{"type":21,"tag":95,"props":5405,"children":5406},{},[5407,5412],{"type":21,"tag":99,"props":5408,"children":5409},{},[5410],{"type":26,"value":5411},"故障處理",{"type":26,"value":5413},"：Gossip 偵測 + Sloppy Quorum / Hinted Handoff 保證系統容錯與最終一致。",{"type":21,"tag":22,"props":5415,"children":5416},{},[5417,5419],{"type":26,"value":5418},"圖 6-17 為系統架構示意，展示了沒有中央控制節點下，各節點如何透過雜湊環、複製和協調機制協同工作：\n",{"type":21,"tag":416,"props":5420,"children":5422},{"alt":418,"src":5421},"/images/sdi-aig/06/img-6-17.png",[],{"type":21,"tag":22,"props":5424,"children":5425},{},[5426,5428],{"type":26,"value":5427},"圖 6-18 為分散式鍵值存儲系統的每個節點，去中心化的示意圖。\n",{"type":21,"tag":416,"props":5429,"children":5431},{"alt":418,"src":5430},"/images/sdi-aig/06/img-6-18.png",[],{"type":21,"tag":22,"props":5433,"children":5434},{},[5435,5437,5442,5444,5449],{"type":26,"value":5436},"接下來重點說明\n",{"type":21,"tag":99,"props":5438,"children":5439},{},[5440],{"type":26,"value":5441},"資料寫入與讀取路徑",{"type":26,"value":5443},"在節點內的處理流程，這對",{"type":21,"tag":99,"props":5445,"children":5446},{},[5447],{"type":26,"value":5448},"性能和可靠性",{"type":26,"value":5450},"至關重要。",{"type":21,"tag":275,"props":5452,"children":5453},{},[],{"type":21,"tag":84,"props":5455,"children":5457},{"id":5456},"寫入途徑資料寫入路徑write-path",[5458],{"type":26,"value":5459},"寫入途徑：資料寫入路徑（Write Path）",{"type":21,"tag":22,"props":5461,"children":5462},{},[5463,5465],{"type":26,"value":5464},"對於來自客戶端發出的每一次寫入請求，\n經路由到正確節點後，\n主要執行以下步驟（借鑑 Apache Cassandra 的實作）：\n",{"type":21,"tag":416,"props":5466,"children":5468},{"alt":418,"src":5467},"/images/sdi-aig/06/img-6-19.png",[],{"type":21,"tag":91,"props":5470,"children":5471},{},[5472,5501,5524,5534,5563],{"type":21,"tag":95,"props":5473,"children":5474},{},[5475,5480,5482,5487,5489,5494,5496],{"type":21,"tag":99,"props":5476,"children":5477},{},[5478],{"type":26,"value":5479},"提交日誌 (Commit Log)：",{"type":26,"value":5481}," 協調節點首先將寫操作記錄追加到",{"type":21,"tag":99,"props":5483,"children":5484},{},[5485],{"type":26,"value":5486},"提交日誌文件",{"type":26,"value":5488},"中。這是一個",{"type":21,"tag":99,"props":5490,"children":5491},{},[5492],{"type":26,"value":5493},"有序寫入的預寫日誌",{"type":26,"value":5495},"，確保即使隨後節點崩潰，重啟時也能從日誌重放恢復未刷入的資料。",{"type":21,"tag":99,"props":5497,"children":5498},{},[5499],{"type":26,"value":5500},"有序寫磁碟相對快速，確保每次寫入先落盤，提高資料耐久性。",{"type":21,"tag":95,"props":5502,"children":5503},{},[5504,5509,5511,5516,5518,5523],{"type":21,"tag":99,"props":5505,"children":5506},{},[5507],{"type":26,"value":5508},"寫入記憶體表 (MemTable)：",{"type":26,"value":5510}," 同時，將此鍵值對寫入節點的",{"type":21,"tag":99,"props":5512,"children":5513},{},[5514],{"type":26,"value":5515},"記憶體快取 (memtable)",{"type":26,"value":5517},"。MemTable可理解為",{"type":21,"tag":99,"props":5519,"children":5520},{},[5521],{"type":26,"value":5522},"存於記憶體的排序Map結構，累積近期寫入（尚未刷盤）",{"type":26,"value":1619},{"type":21,"tag":95,"props":5525,"children":5526},{},[5527,5532],{"type":21,"tag":99,"props":5528,"children":5529},{},[5530],{"type":26,"value":5531},"確認 & 複製：",{"type":26,"value":5533}," 協調者等待本地（及可能其他副本）的MemTable寫入操作成功返回（達到 W 個ACK）後，即可向客戶端回覆寫入成功。這時數據已經在記憶體中，以及至少 W 個副本的提交日誌中持久化。",{"type":21,"tag":95,"props":5535,"children":5536},{},[5537,5542,5544,5549,5551,5556,5558],{"type":21,"tag":99,"props":5538,"children":5539},{},[5540],{"type":26,"value":5541},"MemTable 刷盤 (Flush to SSTable)：",{"type":26,"value":5543}," 隨著寫入不斷進行，MemTable 佔用內存越來越大。當其大小達到預設閾值或時間週期，就觸發",{"type":21,"tag":99,"props":5545,"children":5546},{},[5547],{"type":26,"value":5548},"刷盤",{"type":26,"value":5550},"：把 MemTable 內容排序後寫出到磁碟上的 ",{"type":21,"tag":99,"props":5552,"children":5553},{},[5554],{"type":26,"value":5555},"SSTable（Sorted String Table）",{"type":26,"value":5557}," 檔案。SSTable 是有序的不變（immutable）鍵值集合檔，每次刷盤生成一個新的檔案。",{"type":21,"tag":99,"props":5559,"children":5560},{},[5561],{"type":26,"value":5562},"刷盤過程同時清空該 MemTable，並打上一個新的 MemTable 寫入後續資料。",{"type":21,"tag":95,"props":5564,"children":5565},{},[5566,5571,5573,5578],{"type":21,"tag":99,"props":5567,"children":5568},{},[5569],{"type":26,"value":5570},"檔案合併 (Compaction)：",{"type":26,"value":5572},"（可選）為避免 SSTable 檔過多或存在過時版本碎片，後台定期對多個 SSTable 檔案進行",{"type":21,"tag":99,"props":5574,"children":5575},{},[5576],{"type":26,"value":5577},"壓實（Compaction）",{"type":26,"value":5579},"，合併同一鍵的多版本記錄，棄掉被覆蓋或刪除的舊版本，減少查詢開銷。",{"type":21,"tag":22,"props":5581,"children":5582},{},[5583,5585,5590,5592,5597],{"type":26,"value":5584},"以上流程確保了寫入既",{"type":21,"tag":99,"props":5586,"children":5587},{},[5588],{"type":26,"value":5589},"快速",{"type":26,"value":5591},"（記憶體操作+有序日誌）又",{"type":21,"tag":99,"props":5593,"children":5594},{},[5595],{"type":26,"value":5596},"安全",{"type":26,"value":5598},"（日誌在先，防故障丟失）。Cassandra 寫路徑的設計容許高吞吐的隨機寫操作，並通過後續順序刷盤優化磁碟訪問。",{"type":21,"tag":75,"props":5600,"children":5601},{},[5602],{"type":21,"tag":22,"props":5603,"children":5604},{},[5605,5610,5612,5617,5619,5624],{"type":21,"tag":99,"props":5606,"children":5607},{},[5608],{"type":26,"value":5609},"實現提示：",{"type":26,"value":5611}," 寫路徑強調",{"type":21,"tag":99,"props":5613,"children":5614},{},[5615],{"type":26,"value":5616},"先寫日誌再寫內存",{"type":26,"value":5618},"，這與傳統關係資料庫 WAL + Buffer Pool 機制類似，稱為「",{"type":21,"tag":99,"props":5620,"children":5621},{},[5622],{"type":26,"value":5623},"先寫日誌",{"type":26,"value":5625},"」策略。這樣在crash時，可重播日誌保障資料不丟。Cassandra也採此法確保即使節點故障重啟，提交日誌能恢復自上次flush後失去的資料。",{"type":21,"tag":275,"props":5627,"children":5628},{},[],{"type":21,"tag":84,"props":5630,"children":5632},{"id":5631},"讀取途徑資料讀取路徑read-path",[5633],{"type":26,"value":5634},"讀取途徑：資料讀取路徑（Read Path）",{"type":21,"tag":22,"props":5636,"children":5637},{},[5638],{"type":26,"value":5639},"讀取請求的流程相對直觀，\n但需處理資料可能分散在記憶體和多個磁碟檔的情況。節點接到讀取某鍵的請求後：",{"type":21,"tag":22,"props":5641,"children":5642},{},[5643],{"type":21,"tag":416,"props":5644,"children":5646},{"alt":418,"src":5645},"/images/sdi-aig/06/img-6-20.png",[],{"type":21,"tag":91,"props":5648,"children":5649},{},[5650,5666],{"type":21,"tag":95,"props":5651,"children":5652},{},[5653,5658,5660,5664],{"type":21,"tag":99,"props":5654,"children":5655},{},[5656],{"type":26,"value":5657},"查詢 MemTable：",{"type":26,"value":5659}," 優先在",{"type":21,"tag":99,"props":5661,"children":5662},{},[5663],{"type":26,"value":5337},{"type":26,"value":5665},"中查找該鍵。如果命中（資料尚未刷盤，存在於最新 MemTable），直接返回值，讀取結束。這是最快的情況（O(1)雜湊查找，無磁碟IO）。",{"type":21,"tag":95,"props":5667,"children":5668},{},[5669,5674],{"type":21,"tag":99,"props":5670,"children":5671},{},[5672],{"type":26,"value":5673},"查詢 Cache 未命中：",{"type":26,"value":5675}," 若鍵不在記憶體中（MemTable miss），說明資料要麼在舊的 SSTable 檔，要麼此鍵根本不存在。此時進入磁碟查找流程。",{"type":21,"tag":22,"props":5677,"children":5678},{},[5679],{"type":21,"tag":416,"props":5680,"children":5682},{"alt":418,"src":5681},"/images/sdi-aig/06/img-6-21.png",[],{"type":21,"tag":91,"props":5684,"children":5685},{"start":3516},[5686,5735,5745,5755],{"type":21,"tag":95,"props":5687,"children":5688},{},[5689,5694,5696,5701,5703,5708,5710,5715,5717],{"type":21,"tag":99,"props":5690,"children":5691},{},[5692],{"type":26,"value":5693},"Bloom Filter 篩選：",{"type":26,"value":5695}," 為了避免遍歷所有 SSTable 檔案查找，可以使用",{"type":21,"tag":99,"props":5697,"children":5698},{},[5699],{"type":26,"value":5700},"Bloom Filter",{"type":26,"value":5702},"為每個 SSTable 加一層索引。Bloom Filter 是一種空間高效的機率型資料結構，可快速測試「某鍵是否",{"type":21,"tag":99,"props":5704,"children":5705},{},[5706],{"type":26,"value":5707},"不在",{"type":26,"value":5709},"某檔案」。每個 SSTable 存有對應的 Bloom Filter，當查找鍵K時，先讓 Bloom Filter 判斷該 SSTable 是否",{"type":21,"tag":99,"props":5711,"children":5712},{},[5713],{"type":26,"value":5714},"可能",{"type":26,"value":5716},"包含 K。",{"type":21,"tag":187,"props":5718,"children":5719},{},[5720,5725,5730],{"type":21,"tag":95,"props":5721,"children":5722},{},[5723],{"type":26,"value":5724},"如果 Bloom Filter 判定「不可能在此 SSTable」，則可直接跳過該檔案。",{"type":21,"tag":95,"props":5726,"children":5727},{},[5728],{"type":26,"value":5729},"若判定「可能存在」，才去該 SSTable 中透過檔內索引（二分搜尋等）實際查找。",{"type":21,"tag":95,"props":5731,"children":5732},{},[5733],{"type":26,"value":5734},"透過Bloom Filter，可以大幅減少不必要的磁碟IO。例如某鍵可能僅存在最新幾個檔案，Bloom Filter 將排除大部分與該鍵無關的檔案。",{"type":21,"tag":95,"props":5736,"children":5737},{},[5738,5743],{"type":21,"tag":99,"props":5739,"children":5740},{},[5741],{"type":26,"value":5742},"SSTable 查找：",{"type":26,"value":5744}," 對於Bloom Filter結果為可能包含的那些 SSTable，打開檔案（典型為有序IO），利用其內部稽核（如稀疏索引或B樹索引）定位鍵的位置，讀出對應的值。由於SSTable內記錄有序，可以較快速地找到鍵。",{"type":21,"tag":95,"props":5746,"children":5747},{},[5748,5753],{"type":21,"tag":99,"props":5749,"children":5750},{},[5751],{"type":26,"value":5752},"數據返回與合併：",{"type":26,"value":5754}," 如果從多個副本節點讀取（R>1情況），協調者會收到多份值，需比較其版本（例如 vector clock 或時間戳）選擇最新的結果返回給客戶端。如果偵測到版本衝突（如之前所述出現多版本），則返回所有版本讓客戶端處理。",{"type":21,"tag":95,"props":5756,"children":5757},{},[5758,5763,5765,5770,5772,5777],{"type":21,"tag":99,"props":5759,"children":5760},{},[5761],{"type":26,"value":5762},"讀取快取：",{"type":26,"value":5764}," 讀取完成後，可將該鍵結果存入",{"type":21,"tag":99,"props":5766,"children":5767},{},[5768],{"type":26,"value":5769},"頁面快取",{"type":26,"value":5771},"或",{"type":21,"tag":99,"props":5773,"children":5774},{},[5775],{"type":26,"value":5776},"鍵值快取",{"type":26,"value":5778},"，下次相同鍵訪問時直接命中，提高熱點讀性能。",{"type":21,"tag":22,"props":5780,"children":5781},{},[5782,5784,5789,5791,5795],{"type":26,"value":5783},"總結來說，\n讀路徑的優化重點在於",{"type":21,"tag":99,"props":5785,"children":5786},{},[5787],{"type":26,"value":5788},"記憶體命中優先",{"type":26,"value":5790},"，\n其次透過",{"type":21,"tag":99,"props":5792,"children":5793},{},[5794],{"type":26,"value":5700},{"type":26,"value":5796},"減少磁碟掃描範圍。",{"type":21,"tag":22,"props":5798,"children":5799},{},[5800],{"type":26,"value":5801},"經過這些步驟，\n大部分讀請求可在 O(1) 時間返回（記憶體命中）或以少量有序 IO 完成。\nBloom Filter 雖有極小機率誤判（回傳“可能存在”實際沒有），但不影響正確性，只是多一次空查找，而且誤判率可透過調整位元數控制。",{"type":21,"tag":275,"props":5803,"children":5804},{},[],{"type":21,"tag":38,"props":5806,"children":5807},{},[],{"type":21,"tag":84,"props":5809,"children":5811},{"id":5810},"session-3-各個組件環環相扣關係的架構圖",[5812],{"type":26,"value":5813},"Session 3 各個組件環環相扣關係的架構圖：",{"type":21,"tag":22,"props":5815,"children":5816},{},[5817],{"type":21,"tag":416,"props":5818,"children":5820},{"alt":418,"src":5819},"/images/sdi-aig/06/img-note.png",[],{"type":21,"tag":3274,"props":5822,"children":5824},{"id":5823},"_1-起點分散式需求",[5825,5827],{"type":26,"value":5826},"1. ",{"type":21,"tag":99,"props":5828,"children":5829},{},[5830],{"type":26,"value":5831},"起點：分散式需求",{"type":21,"tag":187,"props":5833,"children":5834},{},[5835],{"type":21,"tag":95,"props":5836,"children":5837},{},[5838],{"type":26,"value":5839},"從單機無法滿足的需求出發（大容量、高可用、可擴展）",{"type":21,"tag":3274,"props":5841,"children":5843},{"id":5842},"_2-基礎設計資料分區與複製",[5844,5846],{"type":26,"value":5845},"2. ",{"type":21,"tag":99,"props":5847,"children":5848},{},[5849],{"type":26,"value":5850},"基礎設計：資料分區與複製",{"type":21,"tag":187,"props":5852,"children":5853},{},[5854,5864,5874],{"type":21,"tag":95,"props":5855,"children":5856},{},[5857,5862],{"type":21,"tag":99,"props":5858,"children":5859},{},[5860],{"type":26,"value":5861},"資料分區",{"type":26,"value":5863},"：使用一致性雜湊將資料均勻分散到多個節點",{"type":21,"tag":95,"props":5865,"children":5866},{},[5867,5872],{"type":21,"tag":99,"props":5868,"children":5869},{},[5870],{"type":26,"value":5871},"資料複製",{"type":26,"value":5873},"：每份資料保存 N 個副本，確保可用性",{"type":21,"tag":95,"props":5875,"children":5876},{},[5877],{"type":26,"value":5878},"兩者相輔相成：分區決定資料位置，複製保證容錯",{"type":21,"tag":3274,"props":5880,"children":5882},{"id":5881},"_3-衍生挑戰一致性問題",[5883,5885],{"type":26,"value":5884},"3. ",{"type":21,"tag":99,"props":5886,"children":5887},{},[5888],{"type":26,"value":5889},"衍生挑戰：一致性問題",{"type":21,"tag":187,"props":5891,"children":5892},{},[5893,5898,5903],{"type":21,"tag":95,"props":5894,"children":5895},{},[5896],{"type":26,"value":5897},"多副本帶來一致性挑戰",{"type":21,"tag":95,"props":5899,"children":5900},{},[5901],{"type":26,"value":5902},"CAP 定理迫使我們在 AP 和 CP 之間選擇",{"type":21,"tag":95,"props":5904,"children":5905},{},[5906],{"type":26,"value":5907},"選擇 AP 系統（最終一致性）以保證高可用",{"type":21,"tag":3274,"props":5909,"children":5911},{"id":5910},"_4-解決方案一致性與衝突處理",[5912,5914],{"type":26,"value":5913},"4. ",{"type":21,"tag":99,"props":5915,"children":5916},{},[5917],{"type":26,"value":5918},"解決方案：一致性與衝突處理",{"type":21,"tag":187,"props":5920,"children":5921},{},[5922,5932],{"type":21,"tag":95,"props":5923,"children":5924},{},[5925,5930],{"type":21,"tag":99,"props":5926,"children":5927},{},[5928],{"type":26,"value":5929},"Quorum 機制",{"type":26,"value":5931},"：通過 N/W/R 參數調節一致性級別",{"type":21,"tag":95,"props":5933,"children":5934},{},[5935,5939],{"type":21,"tag":99,"props":5936,"children":5937},{},[5938],{"type":26,"value":5206},{"type":26,"value":5940},"：檢測並解決並發更新造成的版本衝突",{"type":21,"tag":3274,"props":5942,"children":5944},{"id":5943},"_5-進階挑戰節點故障",[5945,5947],{"type":26,"value":5946},"5. ",{"type":21,"tag":99,"props":5948,"children":5949},{},[5950],{"type":26,"value":5951},"進階挑戰：節點故障",{"type":21,"tag":187,"props":5953,"children":5954},{},[5955,5965,5975],{"type":21,"tag":95,"props":5956,"children":5957},{},[5958,5963],{"type":21,"tag":99,"props":5959,"children":5960},{},[5961],{"type":26,"value":5962},"故障偵測",{"type":26,"value":5964},"：Gossip 協議去中心化地發現故障節點",{"type":21,"tag":95,"props":5966,"children":5967},{},[5968,5973],{"type":21,"tag":99,"props":5969,"children":5970},{},[5971],{"type":26,"value":5972},"臨時故障",{"type":26,"value":5974},"：Sloppy Quorum + Hinted Handoff 維持服務",{"type":21,"tag":95,"props":5976,"children":5977},{},[5978,5983],{"type":21,"tag":99,"props":5979,"children":5980},{},[5981],{"type":26,"value":5982},"永久故障",{"type":26,"value":5984},"：Merkle Tree 進行資料修復",{"type":21,"tag":3274,"props":5986,"children":5988},{"id":5987},"_6-最終實現完整系統架構",[5989,5991],{"type":26,"value":5990},"6. ",{"type":21,"tag":99,"props":5992,"children":5993},{},[5994],{"type":26,"value":5995},"最終實現：完整系統架構",{"type":21,"tag":187,"props":5997,"children":5998},{},[5999,6009,6019,6029],{"type":21,"tag":95,"props":6000,"children":6001},{},[6002,6007],{"type":21,"tag":99,"props":6003,"children":6004},{},[6005],{"type":26,"value":6006},"系統架構",{"type":26,"value":6008},"：去中心化設計，協調者模式",{"type":21,"tag":95,"props":6010,"children":6011},{},[6012,6017],{"type":21,"tag":99,"props":6013,"children":6014},{},[6015],{"type":26,"value":6016},"寫入路徑",{"type":26,"value":6018},"：Commit Log → MemTable → SSTable",{"type":21,"tag":95,"props":6020,"children":6021},{},[6022,6027],{"type":21,"tag":99,"props":6023,"children":6024},{},[6025],{"type":26,"value":6026},"讀取路徑",{"type":26,"value":6028},"：MemTable 優先，Bloom Filter 優化",{"type":21,"tag":95,"props":6030,"children":6031},{},[6032,6037],{"type":21,"tag":99,"props":6033,"children":6034},{},[6035],{"type":26,"value":6036},"節點內部",{"type":26,"value":6038},"：LSM Tree 結構，後台 Compaction",{"type":21,"tag":84,"props":6040,"children":6042},{"id":6041},"環環相扣的特點",[6043],{"type":26,"value":6044},"環環相扣的特點：",{"type":21,"tag":91,"props":6046,"children":6047},{},[6048,6058,6068],{"type":21,"tag":95,"props":6049,"children":6050},{},[6051,6056],{"type":21,"tag":99,"props":6052,"children":6053},{},[6054],{"type":26,"value":6055},"因果關係明確",{"type":26,"value":6057},"：每一層的設計都是為了解決上一層帶來的問題",{"type":21,"tag":95,"props":6059,"children":6060},{},[6061,6066],{"type":21,"tag":99,"props":6062,"children":6063},{},[6064],{"type":26,"value":6065},"相互依賴",{"type":26,"value":6067},"：各組件不是獨立存在，而是共同構成完整系統",{"type":21,"tag":95,"props":6069,"children":6070},{},[6071,6076],{"type":21,"tag":99,"props":6072,"children":6073},{},[6074],{"type":26,"value":6075},"持續優化",{"type":26,"value":6077},"：系統運行中的經驗會反饋到各層設計的改進",{"type":21,"tag":22,"props":6079,"children":6080},{},[6081],{"type":26,"value":6082},"這個架構展示了分散式鍵值儲存系統設計的完整思路，從需求出發，逐步解決各種挑戰，最終形成一個高可用、可擴展的系統。",{"type":21,"tag":38,"props":6084,"children":6085},{},[],{"type":21,"tag":6087,"props":6088,"children":6090},"h1",{"id":6089},"第六章-總結",[6091],{"type":26,"value":6092},"第六章 總結",{"type":21,"tag":22,"props":6094,"children":6095},{},[6096,6098,6103],{"type":26,"value":6097},"經過三個階段的講解，我們完整覆蓋了",{"type":21,"tag":99,"props":6099,"children":6100},{},[6101],{"type":26,"value":6102},"分散式鍵值存儲系統",{"type":26,"value":6104},"從原理到實作的方方面面：",{"type":21,"tag":187,"props":6106,"children":6107},{},[6108,6118,6128],{"type":21,"tag":95,"props":6109,"children":6110},{},[6111,6116],{"type":21,"tag":99,"props":6112,"children":6113},{},[6114],{"type":26,"value":6115},"Session 1：",{"type":26,"value":6117}," 理解了鍵值資料庫的基本定義。",{"type":21,"tag":95,"props":6119,"children":6120},{},[6121,6126],{"type":21,"tag":99,"props":6122,"children":6123},{},[6124],{"type":26,"value":6125},"Session 2：",{"type":26,"value":6127}," 單機實現方式，以及擴展到分散式系統時需要面臨的 CAP 抉擇。",{"type":21,"tag":95,"props":6129,"children":6130},{},[6131,6136],{"type":21,"tag":99,"props":6132,"children":6133},{},[6134],{"type":26,"value":6135},"Session 3：",{"type":26,"value":6137}," 從資料分區/複製方法，到深入探討了為實現高可用而採取最終一致性的系統中，如何利用 quorum 共識調節一致性、用向量時鐘來侦測和解決衝突版本、用 Gossip 和 Hinted Handoff 等機制來實現故障容忍與自癒。並闡述了實際系統架構下資料讀寫的具體流程（MemTable+SSTable 和 Bloom Filter 等實作細節）。此外，我們將該系統與當今主流方案進行了對比，理解不同系統在 CAP 取捨和架構設計上的演進。",{"type":21,"tag":22,"props":6139,"children":6140},{},[6141,6146],{"type":21,"tag":99,"props":6142,"children":6143},{},[6144],{"type":26,"value":6145},"整章核心要點回顧：",{"type":26,"value":6147}," (對照下表)",{"type":21,"tag":187,"props":6149,"children":6150},{},[6151,6170,6189,6208,6218,6229,6240],{"type":21,"tag":95,"props":6152,"children":6153},{},[6154,6156,6161,6163,6168],{"type":26,"value":6155},"為處理",{"type":21,"tag":99,"props":6157,"children":6158},{},[6159],{"type":26,"value":6160},"海量資料",{"type":26,"value":6162},"：採用",{"type":21,"tag":99,"props":6164,"children":6165},{},[6166],{"type":26,"value":6167},"分區/一致性雜湊",{"type":26,"value":6169},"分散鍵到多節點。",{"type":21,"tag":95,"props":6171,"children":6172},{},[6173,6175,6180,6182,6187],{"type":26,"value":6174},"提供",{"type":21,"tag":99,"props":6176,"children":6177},{},[6178],{"type":26,"value":6179},"高可用讀取",{"type":26,"value":6181},"：透過",{"type":21,"tag":99,"props":6183,"children":6184},{},[6185],{"type":26,"value":6186},"多副本複製",{"type":26,"value":6188},"，甚至跨機房部署。",{"type":21,"tag":95,"props":6190,"children":6191},{},[6192,6194,6199,6201,6206],{"type":26,"value":6193},"支撐",{"type":21,"tag":99,"props":6195,"children":6196},{},[6197],{"type":26,"value":6198},"高可用寫入",{"type":26,"value":6200},"：允許",{"type":21,"tag":99,"props":6202,"children":6203},{},[6204],{"type":26,"value":6205},"最終一致",{"type":26,"value":6207},"，使用向量時鐘進行版本控制與衝突解決。",{"type":21,"tag":95,"props":6209,"children":6210},{},[6211,6216],{"type":21,"tag":99,"props":6212,"children":6213},{},[6214],{"type":26,"value":6215},"可線性擴展",{"type":26,"value":6217},"：增加節點透過一致性雜湊自動攤平負載，虛擬節點支持異構性。",{"type":21,"tag":95,"props":6219,"children":6220},{},[6221,6223,6227],{"type":26,"value":6222},"容忍",{"type":21,"tag":99,"props":6224,"children":6225},{},[6226],{"type":26,"value":5972},{"type":26,"value":6228},"：採用 Sloppy Quorum + Hinted Handoff 技術保證服務不中斷。",{"type":21,"tag":95,"props":6230,"children":6231},{},[6232,6234,6238],{"type":26,"value":6233},"應對",{"type":21,"tag":99,"props":6235,"children":6236},{},[6237],{"type":26,"value":5982},{"type":26,"value":6239},"：利用 Merkle Tree 進行反熵同步。",{"type":21,"tag":95,"props":6241,"children":6242},{},[6243,6248],{"type":21,"tag":99,"props":6244,"children":6245},{},[6246],{"type":26,"value":6247},"跨域高可用",{"type":26,"value":6249},"：多資料中心複製與故障轉移策略，保障局部機房宕機時系統整體仍存活。",{"type":21,"tag":22,"props":6251,"children":6252},{},[6253],{"type":21,"tag":416,"props":6254,"children":6256},{"alt":418,"src":6255},"/images/sdi-aig/06/table-6-2.png",[],{"type":21,"tag":38,"props":6258,"children":6259},{},[],{"type":21,"tag":38,"props":6261,"children":6262},{},[],{"type":21,"tag":3274,"props":6264,"children":6266},{"id":6265},"c-最小鍵值存儲-api-實作範例",[6267],{"type":26,"value":6268},"C# 最小鍵值存儲 API 實作範例",{"type":21,"tag":22,"props":6270,"children":6271},{},[6272],{"type":26,"value":6273},"下面我們將實作一個簡化的鍵值存儲服務，使用 C# (.NET 8 Minimal API) 提供 HTTP 接口，並以 MSSQL 資料庫作為持久層。此範例展示鍵值存儲的核心功能，包括資料的寫入、讀取和版本管理對應我們前述章節的概念。",{"type":21,"tag":22,"props":6275,"children":6276},{},[6277,6282,6284,6289],{"type":21,"tag":99,"props":6278,"children":6279},{},[6280],{"type":26,"value":6281},"資料表設計：",{"type":26,"value":6283}," 在 MSSQL 中建立一張 ",{"type":21,"tag":107,"props":6285,"children":6286},{"className":13},[6287],{"type":26,"value":6288},"KeyValueStore",{"type":26,"value":6290}," 表：",{"type":21,"tag":196,"props":6292,"children":6296},{"code":6293,"language":6294,"meta":13,"className":6295,"style":13},"CREATE TABLE KeyValueStore (\n    [Key]   NVARCHAR(256) NOT NULL PRIMARY KEY,\n    [Value] NVARCHAR(MAX) NULL,\n    [Version] INT NOT NULL DEFAULT 0\n);\n","sql","language-sql shiki shiki-themes github-dark github-light monokai",[6297],{"type":21,"tag":107,"props":6298,"children":6299},{"__ignoreMap":13},[6300,6323,6364,6390,6419],{"type":21,"tag":206,"props":6301,"children":6302},{"class":208,"line":209},[6303,6308,6313,6318],{"type":21,"tag":206,"props":6304,"children":6305},{"style":213},[6306],{"type":26,"value":6307},"CREATE",{"type":21,"tag":206,"props":6309,"children":6310},{"style":213},[6311],{"type":26,"value":6312}," TABLE",{"type":21,"tag":206,"props":6314,"children":6315},{"style":219},[6316],{"type":26,"value":6317}," KeyValueStore",{"type":21,"tag":206,"props":6319,"children":6320},{"style":225},[6321],{"type":26,"value":6322}," (\n",{"type":21,"tag":206,"props":6324,"children":6325},{"class":208,"line":237},[6326,6331,6336,6340,6345,6350,6355,6360],{"type":21,"tag":206,"props":6327,"children":6328},{"style":225},[6329],{"type":26,"value":6330},"    [Key]   ",{"type":21,"tag":206,"props":6332,"children":6333},{"style":213},[6334],{"type":26,"value":6335},"NVARCHAR",{"type":21,"tag":206,"props":6337,"children":6338},{"style":225},[6339],{"type":26,"value":792},{"type":21,"tag":206,"props":6341,"children":6342},{"style":3505},[6343],{"type":26,"value":6344},"256",{"type":21,"tag":206,"props":6346,"children":6347},{"style":225},[6348],{"type":26,"value":6349},") ",{"type":21,"tag":206,"props":6351,"children":6352},{"style":213},[6353],{"type":26,"value":6354},"NOT NULL",{"type":21,"tag":206,"props":6356,"children":6357},{"style":213},[6358],{"type":26,"value":6359}," PRIMARY KEY",{"type":21,"tag":206,"props":6361,"children":6362},{"style":225},[6363],{"type":26,"value":3513},{"type":21,"tag":206,"props":6365,"children":6366},{"class":208,"line":3516},[6367,6372,6376,6381,6386],{"type":21,"tag":206,"props":6368,"children":6369},{"style":225},[6370],{"type":26,"value":6371},"    [Value] ",{"type":21,"tag":206,"props":6373,"children":6374},{"style":213},[6375],{"type":26,"value":6335},{"type":21,"tag":206,"props":6377,"children":6378},{"style":225},[6379],{"type":26,"value":6380},"(MAX) ",{"type":21,"tag":206,"props":6382,"children":6383},{"style":213},[6384],{"type":26,"value":6385},"NULL",{"type":21,"tag":206,"props":6387,"children":6388},{"style":225},[6389],{"type":26,"value":3513},{"type":21,"tag":206,"props":6391,"children":6392},{"class":208,"line":3538},[6393,6398,6404,6409,6414],{"type":21,"tag":206,"props":6394,"children":6395},{"style":225},[6396],{"type":26,"value":6397},"    [Version] ",{"type":21,"tag":206,"props":6399,"children":6401},{"style":6400},"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#66D9EF;--shiki-dark-font-style:inherit;--shiki-default-font-style:inherit;--shiki-sepia-font-style:italic",[6402],{"type":26,"value":6403},"INT",{"type":21,"tag":206,"props":6405,"children":6406},{"style":213},[6407],{"type":26,"value":6408}," NOT NULL",{"type":21,"tag":206,"props":6410,"children":6411},{"style":213},[6412],{"type":26,"value":6413}," DEFAULT",{"type":21,"tag":206,"props":6415,"children":6416},{"style":3505},[6417],{"type":26,"value":6418}," 0\n",{"type":21,"tag":206,"props":6420,"children":6421},{"class":208,"line":3556},[6422],{"type":21,"tag":206,"props":6423,"children":6424},{"style":225},[6425],{"type":26,"value":6426},");\n",{"type":21,"tag":187,"props":6428,"children":6429},{},[6430,6440,6450],{"type":21,"tag":95,"props":6431,"children":6432},{},[6433,6438],{"type":21,"tag":107,"props":6434,"children":6435},{"className":13},[6436],{"type":26,"value":6437},"Key",{"type":26,"value":6439}," 欄位作為主鍵存放鍵名稱。",{"type":21,"tag":95,"props":6441,"children":6442},{},[6443,6448],{"type":21,"tag":107,"props":6444,"children":6445},{"className":13},[6446],{"type":26,"value":6447},"Value",{"type":26,"value":6449}," 欄位存放字串類型的值（實務中可用 VARBINARY(MAX) 存放二進位資料)。",{"type":21,"tag":95,"props":6451,"children":6452},{},[6453,6458,6460,6465],{"type":21,"tag":107,"props":6454,"children":6455},{"className":13},[6456],{"type":26,"value":6457},"Version",{"type":26,"value":6459}," 欄位記錄此鍵的版本號，用於簡單實現",{"type":21,"tag":99,"props":6461,"children":6462},{},[6463],{"type":26,"value":6464},"版本控制",{"type":26,"value":6466},"（每次更新遞增版本）。這對應前述向量時鐘的概念縮減版：我們僅用單一整數表示版本，雖無法處理多副本並發，但可用於樂觀鎖防止寫入覆蓋較新更新。",{"type":21,"tag":22,"props":6468,"children":6469},{},[6470,6472,6477,6479,6484],{"type":26,"value":6471},"接著，我們使用 .NET 8 Minimal API 建立 HTTP 介面，包含 ",{"type":21,"tag":99,"props":6473,"children":6474},{},[6475],{"type":26,"value":6476},"PUT",{"type":26,"value":6478},"（寫入/更新鍵）與 ",{"type":21,"tag":99,"props":6480,"children":6481},{},[6482],{"type":26,"value":6483},"GET",{"type":26,"value":6485},"（讀取鍵）兩種操作：",{"type":21,"tag":196,"props":6487,"children":6491},{"code":6488,"language":6489,"meta":13,"className":6490,"style":13},"using Microsoft.Data.SqlClient;\nusing Dapper;\n\nvar builder = WebApplication.CreateBuilder(args);\nvar app = builder.Build();\n\n// Database connection string (modify as appropriate for your environment)\nstring connString = builder.Configuration.GetConnectionString(\"KeyValueDb\");\n\n// 1. GET endpoint: retrieve value by key\napp.MapGet(\"/kv/{key}\", async (string key) =>\n{\n    const string sql = \"SELECT [Value], [Version] FROM KeyValueStore WHERE [Key] = @Key\";\n    await using var conn = new SqlConnection(connString);\n    var result = await conn.QueryFirstOrDefaultAsync\u003C(string Value, int Version)>(sql, new { Key = key });\n    if (result.Value == null)\n    {\n        return Results.NotFound($\"Key '{key}' not found\");\n    }\n    // Return the value and version (as ETag header for concurrency control, e.g.)\n    return Results.Ok(new { Key = key, Value = result.Value, Version = result.Version });\n});\n\n// 2. PUT endpoint: insert or update a key-value\napp.MapPut(\"/kv/{key}\", async (string key, string value) =>\n{\n    await using var conn = new SqlConnection(connString);\n    // Try update first\n    const string updateSql = @\"\n        UPDATE KeyValueStore\n        SET [Value] = @Value, [Version] = [Version] + 1\n        WHERE [Key] = @Key;\n        SELECT @@ROWCOUNT;\";\n    var rows = await conn.ExecuteScalarAsync\u003Cint>(updateSql, new { Key = key, Value = value });\n    if (rows == 0)\n    {\n        // If key not exists, insert new record\n        const string insertSql = \"INSERT INTO KeyValueStore([Key],[Value],[Version]) VALUES(@Key, @Value, 0);\";\n        try\n        {\n            await conn.ExecuteAsync(insertSql, new { Key = key, Value = value });\n        }\n        catch (SqlException ex) when (ex.Number == 2627) // PK violation\n        {\n            // Handle race condition: key was inserted by another request in the meantime\n            return Results.Conflict($\"Key '{key}' was inserted by another client.\");\n        }\n    }\n    return Results.NoContent();\n});\n\napp.Run();\n","csharp","language-csharp shiki shiki-themes github-dark github-light monokai",[6492],{"type":21,"tag":107,"props":6493,"children":6494},{"__ignoreMap":13},[6495,6533,6549,6557,6591,6622,6630,6639,6681,6689,6698,6753,6761,6793,6836,6922,6950,6959,7001,7010,7019,7076,7085,7093,7102,7164,7172,7208,7217,7243,7252,7261,7270,7283,7352,7378,7386,7395,7426,7435,7444,7491,7500,7555,7563,7572,7611,7619,7627,7648,7656,7664],{"type":21,"tag":206,"props":6496,"children":6497},{"class":208,"line":209},[6498,6503,6509,6514,6519,6523,6528],{"type":21,"tag":206,"props":6499,"children":6500},{"style":213},[6501],{"type":26,"value":6502},"using",{"type":21,"tag":206,"props":6504,"children":6506},{"style":6505},"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E;--shiki-dark-text-decoration:inherit;--shiki-default-text-decoration:inherit;--shiki-sepia-text-decoration:underline",[6507],{"type":26,"value":6508}," Microsoft",{"type":21,"tag":206,"props":6510,"children":6511},{"style":225},[6512],{"type":26,"value":6513},".",{"type":21,"tag":206,"props":6515,"children":6516},{"style":6505},[6517],{"type":26,"value":6518},"Data",{"type":21,"tag":206,"props":6520,"children":6521},{"style":225},[6522],{"type":26,"value":6513},{"type":21,"tag":206,"props":6524,"children":6525},{"style":6505},[6526],{"type":26,"value":6527},"SqlClient",{"type":21,"tag":206,"props":6529,"children":6530},{"style":225},[6531],{"type":26,"value":6532},";\n",{"type":21,"tag":206,"props":6534,"children":6535},{"class":208,"line":237},[6536,6540,6545],{"type":21,"tag":206,"props":6537,"children":6538},{"style":213},[6539],{"type":26,"value":6502},{"type":21,"tag":206,"props":6541,"children":6542},{"style":6505},[6543],{"type":26,"value":6544}," Dapper",{"type":21,"tag":206,"props":6546,"children":6547},{"style":225},[6548],{"type":26,"value":6532},{"type":21,"tag":206,"props":6550,"children":6551},{"class":208,"line":3516},[6552],{"type":21,"tag":206,"props":6553,"children":6554},{"emptyLinePlaceholder":5},[6555],{"type":26,"value":6556},"\n",{"type":21,"tag":206,"props":6558,"children":6559},{"class":208,"line":3538},[6560,6565,6571,6576,6581,6586],{"type":21,"tag":206,"props":6561,"children":6562},{"style":6400},[6563],{"type":26,"value":6564},"var",{"type":21,"tag":206,"props":6566,"children":6568},{"style":6567},"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#F8F8F2",[6569],{"type":26,"value":6570}," builder",{"type":21,"tag":206,"props":6572,"children":6573},{"style":213},[6574],{"type":26,"value":6575}," =",{"type":21,"tag":206,"props":6577,"children":6578},{"style":225},[6579],{"type":26,"value":6580}," WebApplication.",{"type":21,"tag":206,"props":6582,"children":6583},{"style":219},[6584],{"type":26,"value":6585},"CreateBuilder",{"type":21,"tag":206,"props":6587,"children":6588},{"style":225},[6589],{"type":26,"value":6590},"(args);\n",{"type":21,"tag":206,"props":6592,"children":6593},{"class":208,"line":3556},[6594,6598,6603,6607,6612,6617],{"type":21,"tag":206,"props":6595,"children":6596},{"style":6400},[6597],{"type":26,"value":6564},{"type":21,"tag":206,"props":6599,"children":6600},{"style":6567},[6601],{"type":26,"value":6602}," app",{"type":21,"tag":206,"props":6604,"children":6605},{"style":213},[6606],{"type":26,"value":6575},{"type":21,"tag":206,"props":6608,"children":6609},{"style":225},[6610],{"type":26,"value":6611}," builder.",{"type":21,"tag":206,"props":6613,"children":6614},{"style":219},[6615],{"type":26,"value":6616},"Build",{"type":21,"tag":206,"props":6618,"children":6619},{"style":225},[6620],{"type":26,"value":6621},"();\n",{"type":21,"tag":206,"props":6623,"children":6625},{"class":208,"line":6624},6,[6626],{"type":21,"tag":206,"props":6627,"children":6628},{"emptyLinePlaceholder":5},[6629],{"type":26,"value":6556},{"type":21,"tag":206,"props":6631,"children":6633},{"class":208,"line":6632},7,[6634],{"type":21,"tag":206,"props":6635,"children":6636},{"style":231},[6637],{"type":26,"value":6638},"// Database connection string (modify as appropriate for your environment)\n",{"type":21,"tag":206,"props":6640,"children":6642},{"class":208,"line":6641},8,[6643,6648,6653,6657,6662,6667,6671,6677],{"type":21,"tag":206,"props":6644,"children":6645},{"style":213},[6646],{"type":26,"value":6647},"string",{"type":21,"tag":206,"props":6649,"children":6650},{"style":6567},[6651],{"type":26,"value":6652}," connString",{"type":21,"tag":206,"props":6654,"children":6655},{"style":213},[6656],{"type":26,"value":6575},{"type":21,"tag":206,"props":6658,"children":6659},{"style":225},[6660],{"type":26,"value":6661}," builder.Configuration.",{"type":21,"tag":206,"props":6663,"children":6664},{"style":219},[6665],{"type":26,"value":6666},"GetConnectionString",{"type":21,"tag":206,"props":6668,"children":6669},{"style":225},[6670],{"type":26,"value":792},{"type":21,"tag":206,"props":6672,"children":6674},{"style":6673},"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74",[6675],{"type":26,"value":6676},"\"KeyValueDb\"",{"type":21,"tag":206,"props":6678,"children":6679},{"style":225},[6680],{"type":26,"value":6426},{"type":21,"tag":206,"props":6682,"children":6684},{"class":208,"line":6683},9,[6685],{"type":21,"tag":206,"props":6686,"children":6687},{"emptyLinePlaceholder":5},[6688],{"type":26,"value":6556},{"type":21,"tag":206,"props":6690,"children":6692},{"class":208,"line":6691},10,[6693],{"type":21,"tag":206,"props":6694,"children":6695},{"style":231},[6696],{"type":26,"value":6697},"// 1. GET endpoint: retrieve value by key\n",{"type":21,"tag":206,"props":6699,"children":6701},{"class":208,"line":6700},11,[6702,6707,6712,6716,6721,6726,6731,6735,6739,6744,6748],{"type":21,"tag":206,"props":6703,"children":6704},{"style":225},[6705],{"type":26,"value":6706},"app.",{"type":21,"tag":206,"props":6708,"children":6709},{"style":219},[6710],{"type":26,"value":6711},"MapGet",{"type":21,"tag":206,"props":6713,"children":6714},{"style":225},[6715],{"type":26,"value":792},{"type":21,"tag":206,"props":6717,"children":6718},{"style":6673},[6719],{"type":26,"value":6720},"\"/kv/{key}\"",{"type":21,"tag":206,"props":6722,"children":6723},{"style":225},[6724],{"type":26,"value":6725},", ",{"type":21,"tag":206,"props":6727,"children":6728},{"style":213},[6729],{"type":26,"value":6730},"async",{"type":21,"tag":206,"props":6732,"children":6733},{"style":225},[6734],{"type":26,"value":588},{"type":21,"tag":206,"props":6736,"children":6737},{"style":213},[6738],{"type":26,"value":6647},{"type":21,"tag":206,"props":6740,"children":6741},{"style":6567},[6742],{"type":26,"value":6743}," key",{"type":21,"tag":206,"props":6745,"children":6746},{"style":225},[6747],{"type":26,"value":6349},{"type":21,"tag":206,"props":6749,"children":6750},{"style":213},[6751],{"type":26,"value":6752},"=>\n",{"type":21,"tag":206,"props":6754,"children":6756},{"class":208,"line":6755},12,[6757],{"type":21,"tag":206,"props":6758,"children":6759},{"style":225},[6760],{"type":26,"value":3488},{"type":21,"tag":206,"props":6762,"children":6764},{"class":208,"line":6763},13,[6765,6770,6775,6780,6784,6789],{"type":21,"tag":206,"props":6766,"children":6767},{"style":213},[6768],{"type":26,"value":6769},"    const",{"type":21,"tag":206,"props":6771,"children":6772},{"style":213},[6773],{"type":26,"value":6774}," string",{"type":21,"tag":206,"props":6776,"children":6777},{"style":6567},[6778],{"type":26,"value":6779}," sql",{"type":21,"tag":206,"props":6781,"children":6782},{"style":213},[6783],{"type":26,"value":6575},{"type":21,"tag":206,"props":6785,"children":6786},{"style":6673},[6787],{"type":26,"value":6788}," \"SELECT [Value], [Version] FROM KeyValueStore WHERE [Key] = @Key\"",{"type":21,"tag":206,"props":6790,"children":6791},{"style":225},[6792],{"type":26,"value":6532},{"type":21,"tag":206,"props":6794,"children":6796},{"class":208,"line":6795},14,[6797,6802,6807,6812,6817,6821,6826,6831],{"type":21,"tag":206,"props":6798,"children":6799},{"style":213},[6800],{"type":26,"value":6801},"    await",{"type":21,"tag":206,"props":6803,"children":6804},{"style":213},[6805],{"type":26,"value":6806}," using",{"type":21,"tag":206,"props":6808,"children":6809},{"style":6400},[6810],{"type":26,"value":6811}," var",{"type":21,"tag":206,"props":6813,"children":6814},{"style":6567},[6815],{"type":26,"value":6816}," conn",{"type":21,"tag":206,"props":6818,"children":6819},{"style":213},[6820],{"type":26,"value":6575},{"type":21,"tag":206,"props":6822,"children":6823},{"style":213},[6824],{"type":26,"value":6825}," new",{"type":21,"tag":206,"props":6827,"children":6828},{"style":6505},[6829],{"type":26,"value":6830}," SqlConnection",{"type":21,"tag":206,"props":6832,"children":6833},{"style":225},[6834],{"type":26,"value":6835},"(connString);\n",{"type":21,"tag":206,"props":6837,"children":6839},{"class":208,"line":6838},15,[6840,6845,6850,6854,6859,6864,6869,6874,6878,6883,6887,6892,6897,6902,6907,6912,6917],{"type":21,"tag":206,"props":6841,"children":6842},{"style":6400},[6843],{"type":26,"value":6844},"    var",{"type":21,"tag":206,"props":6846,"children":6847},{"style":6567},[6848],{"type":26,"value":6849}," result",{"type":21,"tag":206,"props":6851,"children":6852},{"style":213},[6853],{"type":26,"value":6575},{"type":21,"tag":206,"props":6855,"children":6856},{"style":213},[6857],{"type":26,"value":6858}," await",{"type":21,"tag":206,"props":6860,"children":6861},{"style":225},[6862],{"type":26,"value":6863}," conn.",{"type":21,"tag":206,"props":6865,"children":6866},{"style":219},[6867],{"type":26,"value":6868},"QueryFirstOrDefaultAsync",{"type":21,"tag":206,"props":6870,"children":6871},{"style":225},[6872],{"type":26,"value":6873},"\u003C(",{"type":21,"tag":206,"props":6875,"children":6876},{"style":213},[6877],{"type":26,"value":6647},{"type":21,"tag":206,"props":6879,"children":6880},{"style":6567},[6881],{"type":26,"value":6882}," Value",{"type":21,"tag":206,"props":6884,"children":6885},{"style":225},[6886],{"type":26,"value":6725},{"type":21,"tag":206,"props":6888,"children":6889},{"style":213},[6890],{"type":26,"value":6891},"int",{"type":21,"tag":206,"props":6893,"children":6894},{"style":6567},[6895],{"type":26,"value":6896}," Version",{"type":21,"tag":206,"props":6898,"children":6899},{"style":225},[6900],{"type":26,"value":6901},")>(sql, ",{"type":21,"tag":206,"props":6903,"children":6904},{"style":213},[6905],{"type":26,"value":6906},"new",{"type":21,"tag":206,"props":6908,"children":6909},{"style":225},[6910],{"type":26,"value":6911}," { Key ",{"type":21,"tag":206,"props":6913,"children":6914},{"style":213},[6915],{"type":26,"value":6916},"=",{"type":21,"tag":206,"props":6918,"children":6919},{"style":225},[6920],{"type":26,"value":6921}," key });\n",{"type":21,"tag":206,"props":6923,"children":6925},{"class":208,"line":6924},16,[6926,6931,6936,6941,6946],{"type":21,"tag":206,"props":6927,"children":6928},{"style":213},[6929],{"type":26,"value":6930},"    if",{"type":21,"tag":206,"props":6932,"children":6933},{"style":225},[6934],{"type":26,"value":6935}," (result.Value ",{"type":21,"tag":206,"props":6937,"children":6938},{"style":213},[6939],{"type":26,"value":6940},"==",{"type":21,"tag":206,"props":6942,"children":6943},{"style":3505},[6944],{"type":26,"value":6945}," null",{"type":21,"tag":206,"props":6947,"children":6948},{"style":225},[6949],{"type":26,"value":598},{"type":21,"tag":206,"props":6951,"children":6953},{"class":208,"line":6952},17,[6954],{"type":21,"tag":206,"props":6955,"children":6956},{"style":225},[6957],{"type":26,"value":6958},"    {\n",{"type":21,"tag":206,"props":6960,"children":6962},{"class":208,"line":6961},18,[6963,6968,6973,6978,6982,6987,6992,6997],{"type":21,"tag":206,"props":6964,"children":6965},{"style":213},[6966],{"type":26,"value":6967},"        return",{"type":21,"tag":206,"props":6969,"children":6970},{"style":225},[6971],{"type":26,"value":6972}," Results.",{"type":21,"tag":206,"props":6974,"children":6975},{"style":219},[6976],{"type":26,"value":6977},"NotFound",{"type":21,"tag":206,"props":6979,"children":6980},{"style":225},[6981],{"type":26,"value":792},{"type":21,"tag":206,"props":6983,"children":6984},{"style":6673},[6985],{"type":26,"value":6986},"$\"Key '{",{"type":21,"tag":206,"props":6988,"children":6989},{"style":225},[6990],{"type":26,"value":6991},"key",{"type":21,"tag":206,"props":6993,"children":6994},{"style":6673},[6995],{"type":26,"value":6996},"}' not found\"",{"type":21,"tag":206,"props":6998,"children":6999},{"style":225},[7000],{"type":26,"value":6426},{"type":21,"tag":206,"props":7002,"children":7004},{"class":208,"line":7003},19,[7005],{"type":21,"tag":206,"props":7006,"children":7007},{"style":225},[7008],{"type":26,"value":7009},"    }\n",{"type":21,"tag":206,"props":7011,"children":7013},{"class":208,"line":7012},20,[7014],{"type":21,"tag":206,"props":7015,"children":7016},{"style":231},[7017],{"type":26,"value":7018},"    // Return the value and version (as ETag header for concurrency control, e.g.)\n",{"type":21,"tag":206,"props":7020,"children":7022},{"class":208,"line":7021},21,[7023,7028,7032,7037,7041,7045,7049,7053,7058,7062,7067,7071],{"type":21,"tag":206,"props":7024,"children":7025},{"style":213},[7026],{"type":26,"value":7027},"    return",{"type":21,"tag":206,"props":7029,"children":7030},{"style":225},[7031],{"type":26,"value":6972},{"type":21,"tag":206,"props":7033,"children":7034},{"style":219},[7035],{"type":26,"value":7036},"Ok",{"type":21,"tag":206,"props":7038,"children":7039},{"style":225},[7040],{"type":26,"value":792},{"type":21,"tag":206,"props":7042,"children":7043},{"style":213},[7044],{"type":26,"value":6906},{"type":21,"tag":206,"props":7046,"children":7047},{"style":225},[7048],{"type":26,"value":6911},{"type":21,"tag":206,"props":7050,"children":7051},{"style":213},[7052],{"type":26,"value":6916},{"type":21,"tag":206,"props":7054,"children":7055},{"style":225},[7056],{"type":26,"value":7057}," key, Value ",{"type":21,"tag":206,"props":7059,"children":7060},{"style":213},[7061],{"type":26,"value":6916},{"type":21,"tag":206,"props":7063,"children":7064},{"style":225},[7065],{"type":26,"value":7066}," result.Value, Version ",{"type":21,"tag":206,"props":7068,"children":7069},{"style":213},[7070],{"type":26,"value":6916},{"type":21,"tag":206,"props":7072,"children":7073},{"style":225},[7074],{"type":26,"value":7075}," result.Version });\n",{"type":21,"tag":206,"props":7077,"children":7079},{"class":208,"line":7078},22,[7080],{"type":21,"tag":206,"props":7081,"children":7082},{"style":225},[7083],{"type":26,"value":7084},"});\n",{"type":21,"tag":206,"props":7086,"children":7088},{"class":208,"line":7087},23,[7089],{"type":21,"tag":206,"props":7090,"children":7091},{"emptyLinePlaceholder":5},[7092],{"type":26,"value":6556},{"type":21,"tag":206,"props":7094,"children":7096},{"class":208,"line":7095},24,[7097],{"type":21,"tag":206,"props":7098,"children":7099},{"style":231},[7100],{"type":26,"value":7101},"// 2. PUT endpoint: insert or update a key-value\n",{"type":21,"tag":206,"props":7103,"children":7105},{"class":208,"line":7104},25,[7106,7110,7115,7119,7123,7127,7131,7135,7139,7143,7147,7151,7156,7160],{"type":21,"tag":206,"props":7107,"children":7108},{"style":225},[7109],{"type":26,"value":6706},{"type":21,"tag":206,"props":7111,"children":7112},{"style":219},[7113],{"type":26,"value":7114},"MapPut",{"type":21,"tag":206,"props":7116,"children":7117},{"style":225},[7118],{"type":26,"value":792},{"type":21,"tag":206,"props":7120,"children":7121},{"style":6673},[7122],{"type":26,"value":6720},{"type":21,"tag":206,"props":7124,"children":7125},{"style":225},[7126],{"type":26,"value":6725},{"type":21,"tag":206,"props":7128,"children":7129},{"style":213},[7130],{"type":26,"value":6730},{"type":21,"tag":206,"props":7132,"children":7133},{"style":225},[7134],{"type":26,"value":588},{"type":21,"tag":206,"props":7136,"children":7137},{"style":213},[7138],{"type":26,"value":6647},{"type":21,"tag":206,"props":7140,"children":7141},{"style":6567},[7142],{"type":26,"value":6743},{"type":21,"tag":206,"props":7144,"children":7145},{"style":225},[7146],{"type":26,"value":6725},{"type":21,"tag":206,"props":7148,"children":7149},{"style":213},[7150],{"type":26,"value":6647},{"type":21,"tag":206,"props":7152,"children":7153},{"style":6567},[7154],{"type":26,"value":7155}," value",{"type":21,"tag":206,"props":7157,"children":7158},{"style":225},[7159],{"type":26,"value":6349},{"type":21,"tag":206,"props":7161,"children":7162},{"style":213},[7163],{"type":26,"value":6752},{"type":21,"tag":206,"props":7165,"children":7167},{"class":208,"line":7166},26,[7168],{"type":21,"tag":206,"props":7169,"children":7170},{"style":225},[7171],{"type":26,"value":3488},{"type":21,"tag":206,"props":7173,"children":7175},{"class":208,"line":7174},27,[7176,7180,7184,7188,7192,7196,7200,7204],{"type":21,"tag":206,"props":7177,"children":7178},{"style":213},[7179],{"type":26,"value":6801},{"type":21,"tag":206,"props":7181,"children":7182},{"style":213},[7183],{"type":26,"value":6806},{"type":21,"tag":206,"props":7185,"children":7186},{"style":6400},[7187],{"type":26,"value":6811},{"type":21,"tag":206,"props":7189,"children":7190},{"style":6567},[7191],{"type":26,"value":6816},{"type":21,"tag":206,"props":7193,"children":7194},{"style":213},[7195],{"type":26,"value":6575},{"type":21,"tag":206,"props":7197,"children":7198},{"style":213},[7199],{"type":26,"value":6825},{"type":21,"tag":206,"props":7201,"children":7202},{"style":6505},[7203],{"type":26,"value":6830},{"type":21,"tag":206,"props":7205,"children":7206},{"style":225},[7207],{"type":26,"value":6835},{"type":21,"tag":206,"props":7209,"children":7211},{"class":208,"line":7210},28,[7212],{"type":21,"tag":206,"props":7213,"children":7214},{"style":231},[7215],{"type":26,"value":7216},"    // Try update first\n",{"type":21,"tag":206,"props":7218,"children":7220},{"class":208,"line":7219},29,[7221,7225,7229,7234,7238],{"type":21,"tag":206,"props":7222,"children":7223},{"style":213},[7224],{"type":26,"value":6769},{"type":21,"tag":206,"props":7226,"children":7227},{"style":213},[7228],{"type":26,"value":6774},{"type":21,"tag":206,"props":7230,"children":7231},{"style":6567},[7232],{"type":26,"value":7233}," updateSql",{"type":21,"tag":206,"props":7235,"children":7236},{"style":213},[7237],{"type":26,"value":6575},{"type":21,"tag":206,"props":7239,"children":7240},{"style":6673},[7241],{"type":26,"value":7242}," @\"\n",{"type":21,"tag":206,"props":7244,"children":7246},{"class":208,"line":7245},30,[7247],{"type":21,"tag":206,"props":7248,"children":7249},{"style":6673},[7250],{"type":26,"value":7251},"        UPDATE KeyValueStore\n",{"type":21,"tag":206,"props":7253,"children":7255},{"class":208,"line":7254},31,[7256],{"type":21,"tag":206,"props":7257,"children":7258},{"style":6673},[7259],{"type":26,"value":7260},"        SET [Value] = @Value, [Version] = [Version] + 1\n",{"type":21,"tag":206,"props":7262,"children":7264},{"class":208,"line":7263},32,[7265],{"type":21,"tag":206,"props":7266,"children":7267},{"style":6673},[7268],{"type":26,"value":7269},"        WHERE [Key] = @Key;\n",{"type":21,"tag":206,"props":7271,"children":7273},{"class":208,"line":7272},33,[7274,7279],{"type":21,"tag":206,"props":7275,"children":7276},{"style":6673},[7277],{"type":26,"value":7278},"        SELECT @@ROWCOUNT;\"",{"type":21,"tag":206,"props":7280,"children":7281},{"style":225},[7282],{"type":26,"value":6532},{"type":21,"tag":206,"props":7284,"children":7286},{"class":208,"line":7285},34,[7287,7291,7296,7300,7304,7308,7313,7318,7322,7327,7331,7335,7339,7343,7347],{"type":21,"tag":206,"props":7288,"children":7289},{"style":6400},[7290],{"type":26,"value":6844},{"type":21,"tag":206,"props":7292,"children":7293},{"style":6567},[7294],{"type":26,"value":7295}," rows",{"type":21,"tag":206,"props":7297,"children":7298},{"style":213},[7299],{"type":26,"value":6575},{"type":21,"tag":206,"props":7301,"children":7302},{"style":213},[7303],{"type":26,"value":6858},{"type":21,"tag":206,"props":7305,"children":7306},{"style":225},[7307],{"type":26,"value":6863},{"type":21,"tag":206,"props":7309,"children":7310},{"style":219},[7311],{"type":26,"value":7312},"ExecuteScalarAsync",{"type":21,"tag":206,"props":7314,"children":7315},{"style":225},[7316],{"type":26,"value":7317},"\u003C",{"type":21,"tag":206,"props":7319,"children":7320},{"style":213},[7321],{"type":26,"value":6891},{"type":21,"tag":206,"props":7323,"children":7324},{"style":225},[7325],{"type":26,"value":7326},">(updateSql, ",{"type":21,"tag":206,"props":7328,"children":7329},{"style":213},[7330],{"type":26,"value":6906},{"type":21,"tag":206,"props":7332,"children":7333},{"style":225},[7334],{"type":26,"value":6911},{"type":21,"tag":206,"props":7336,"children":7337},{"style":213},[7338],{"type":26,"value":6916},{"type":21,"tag":206,"props":7340,"children":7341},{"style":225},[7342],{"type":26,"value":7057},{"type":21,"tag":206,"props":7344,"children":7345},{"style":213},[7346],{"type":26,"value":6916},{"type":21,"tag":206,"props":7348,"children":7349},{"style":225},[7350],{"type":26,"value":7351}," value });\n",{"type":21,"tag":206,"props":7353,"children":7355},{"class":208,"line":7354},35,[7356,7360,7365,7369,7374],{"type":21,"tag":206,"props":7357,"children":7358},{"style":213},[7359],{"type":26,"value":6930},{"type":21,"tag":206,"props":7361,"children":7362},{"style":225},[7363],{"type":26,"value":7364}," (rows ",{"type":21,"tag":206,"props":7366,"children":7367},{"style":213},[7368],{"type":26,"value":6940},{"type":21,"tag":206,"props":7370,"children":7371},{"style":3505},[7372],{"type":26,"value":7373}," 0",{"type":21,"tag":206,"props":7375,"children":7376},{"style":225},[7377],{"type":26,"value":598},{"type":21,"tag":206,"props":7379,"children":7381},{"class":208,"line":7380},36,[7382],{"type":21,"tag":206,"props":7383,"children":7384},{"style":225},[7385],{"type":26,"value":6958},{"type":21,"tag":206,"props":7387,"children":7389},{"class":208,"line":7388},37,[7390],{"type":21,"tag":206,"props":7391,"children":7392},{"style":231},[7393],{"type":26,"value":7394},"        // If key not exists, insert new record\n",{"type":21,"tag":206,"props":7396,"children":7398},{"class":208,"line":7397},38,[7399,7404,7408,7413,7417,7422],{"type":21,"tag":206,"props":7400,"children":7401},{"style":213},[7402],{"type":26,"value":7403},"        const",{"type":21,"tag":206,"props":7405,"children":7406},{"style":213},[7407],{"type":26,"value":6774},{"type":21,"tag":206,"props":7409,"children":7410},{"style":6567},[7411],{"type":26,"value":7412}," insertSql",{"type":21,"tag":206,"props":7414,"children":7415},{"style":213},[7416],{"type":26,"value":6575},{"type":21,"tag":206,"props":7418,"children":7419},{"style":6673},[7420],{"type":26,"value":7421}," \"INSERT INTO KeyValueStore([Key],[Value],[Version]) VALUES(@Key, @Value, 0);\"",{"type":21,"tag":206,"props":7423,"children":7424},{"style":225},[7425],{"type":26,"value":6532},{"type":21,"tag":206,"props":7427,"children":7429},{"class":208,"line":7428},39,[7430],{"type":21,"tag":206,"props":7431,"children":7432},{"style":213},[7433],{"type":26,"value":7434},"        try\n",{"type":21,"tag":206,"props":7436,"children":7438},{"class":208,"line":7437},40,[7439],{"type":21,"tag":206,"props":7440,"children":7441},{"style":225},[7442],{"type":26,"value":7443},"        {\n",{"type":21,"tag":206,"props":7445,"children":7447},{"class":208,"line":7446},41,[7448,7453,7457,7462,7467,7471,7475,7479,7483,7487],{"type":21,"tag":206,"props":7449,"children":7450},{"style":213},[7451],{"type":26,"value":7452},"            await",{"type":21,"tag":206,"props":7454,"children":7455},{"style":225},[7456],{"type":26,"value":6863},{"type":21,"tag":206,"props":7458,"children":7459},{"style":219},[7460],{"type":26,"value":7461},"ExecuteAsync",{"type":21,"tag":206,"props":7463,"children":7464},{"style":225},[7465],{"type":26,"value":7466},"(insertSql, ",{"type":21,"tag":206,"props":7468,"children":7469},{"style":213},[7470],{"type":26,"value":6906},{"type":21,"tag":206,"props":7472,"children":7473},{"style":225},[7474],{"type":26,"value":6911},{"type":21,"tag":206,"props":7476,"children":7477},{"style":213},[7478],{"type":26,"value":6916},{"type":21,"tag":206,"props":7480,"children":7481},{"style":225},[7482],{"type":26,"value":7057},{"type":21,"tag":206,"props":7484,"children":7485},{"style":213},[7486],{"type":26,"value":6916},{"type":21,"tag":206,"props":7488,"children":7489},{"style":225},[7490],{"type":26,"value":7351},{"type":21,"tag":206,"props":7492,"children":7494},{"class":208,"line":7493},42,[7495],{"type":21,"tag":206,"props":7496,"children":7497},{"style":225},[7498],{"type":26,"value":7499},"        }\n",{"type":21,"tag":206,"props":7501,"children":7503},{"class":208,"line":7502},43,[7504,7509,7513,7518,7523,7527,7532,7537,7541,7546,7550],{"type":21,"tag":206,"props":7505,"children":7506},{"style":213},[7507],{"type":26,"value":7508},"        catch",{"type":21,"tag":206,"props":7510,"children":7511},{"style":225},[7512],{"type":26,"value":588},{"type":21,"tag":206,"props":7514,"children":7515},{"style":6505},[7516],{"type":26,"value":7517},"SqlException",{"type":21,"tag":206,"props":7519,"children":7520},{"style":6567},[7521],{"type":26,"value":7522}," ex",{"type":21,"tag":206,"props":7524,"children":7525},{"style":225},[7526],{"type":26,"value":6349},{"type":21,"tag":206,"props":7528,"children":7529},{"style":213},[7530],{"type":26,"value":7531},"when",{"type":21,"tag":206,"props":7533,"children":7534},{"style":225},[7535],{"type":26,"value":7536}," (ex.Number ",{"type":21,"tag":206,"props":7538,"children":7539},{"style":213},[7540],{"type":26,"value":6940},{"type":21,"tag":206,"props":7542,"children":7543},{"style":3505},[7544],{"type":26,"value":7545}," 2627",{"type":21,"tag":206,"props":7547,"children":7548},{"style":225},[7549],{"type":26,"value":6349},{"type":21,"tag":206,"props":7551,"children":7552},{"style":231},[7553],{"type":26,"value":7554},"// PK violation\n",{"type":21,"tag":206,"props":7556,"children":7558},{"class":208,"line":7557},44,[7559],{"type":21,"tag":206,"props":7560,"children":7561},{"style":225},[7562],{"type":26,"value":7443},{"type":21,"tag":206,"props":7564,"children":7566},{"class":208,"line":7565},45,[7567],{"type":21,"tag":206,"props":7568,"children":7569},{"style":231},[7570],{"type":26,"value":7571},"            // Handle race condition: key was inserted by another request in the meantime\n",{"type":21,"tag":206,"props":7573,"children":7575},{"class":208,"line":7574},46,[7576,7581,7585,7590,7594,7598,7602,7607],{"type":21,"tag":206,"props":7577,"children":7578},{"style":213},[7579],{"type":26,"value":7580},"            return",{"type":21,"tag":206,"props":7582,"children":7583},{"style":225},[7584],{"type":26,"value":6972},{"type":21,"tag":206,"props":7586,"children":7587},{"style":219},[7588],{"type":26,"value":7589},"Conflict",{"type":21,"tag":206,"props":7591,"children":7592},{"style":225},[7593],{"type":26,"value":792},{"type":21,"tag":206,"props":7595,"children":7596},{"style":6673},[7597],{"type":26,"value":6986},{"type":21,"tag":206,"props":7599,"children":7600},{"style":225},[7601],{"type":26,"value":6991},{"type":21,"tag":206,"props":7603,"children":7604},{"style":6673},[7605],{"type":26,"value":7606},"}' was inserted by another client.\"",{"type":21,"tag":206,"props":7608,"children":7609},{"style":225},[7610],{"type":26,"value":6426},{"type":21,"tag":206,"props":7612,"children":7614},{"class":208,"line":7613},47,[7615],{"type":21,"tag":206,"props":7616,"children":7617},{"style":225},[7618],{"type":26,"value":7499},{"type":21,"tag":206,"props":7620,"children":7622},{"class":208,"line":7621},48,[7623],{"type":21,"tag":206,"props":7624,"children":7625},{"style":225},[7626],{"type":26,"value":7009},{"type":21,"tag":206,"props":7628,"children":7630},{"class":208,"line":7629},49,[7631,7635,7639,7644],{"type":21,"tag":206,"props":7632,"children":7633},{"style":213},[7634],{"type":26,"value":7027},{"type":21,"tag":206,"props":7636,"children":7637},{"style":225},[7638],{"type":26,"value":6972},{"type":21,"tag":206,"props":7640,"children":7641},{"style":219},[7642],{"type":26,"value":7643},"NoContent",{"type":21,"tag":206,"props":7645,"children":7646},{"style":225},[7647],{"type":26,"value":6621},{"type":21,"tag":206,"props":7649,"children":7651},{"class":208,"line":7650},50,[7652],{"type":21,"tag":206,"props":7653,"children":7654},{"style":225},[7655],{"type":26,"value":7084},{"type":21,"tag":206,"props":7657,"children":7659},{"class":208,"line":7658},51,[7660],{"type":21,"tag":206,"props":7661,"children":7662},{"emptyLinePlaceholder":5},[7663],{"type":26,"value":6556},{"type":21,"tag":206,"props":7665,"children":7667},{"class":208,"line":7666},52,[7668,7672,7677],{"type":21,"tag":206,"props":7669,"children":7670},{"style":225},[7671],{"type":26,"value":6706},{"type":21,"tag":206,"props":7673,"children":7674},{"style":219},[7675],{"type":26,"value":7676},"Run",{"type":21,"tag":206,"props":7678,"children":7679},{"style":225},[7680],{"type":26,"value":6621},{"type":21,"tag":22,"props":7682,"children":7683},{},[7684],{"type":26,"value":7685},"上述程式碼說明：",{"type":21,"tag":187,"props":7687,"children":7688},{},[7689,7701,7711,7762],{"type":21,"tag":95,"props":7690,"children":7691},{},[7692,7694,7699],{"type":26,"value":7693},"我們使用 ",{"type":21,"tag":99,"props":7695,"children":7696},{},[7697],{"type":26,"value":7698},"Dapper",{"type":26,"value":7700}," 輕量ORM來執行 SQL 查詢，方便地將結果映射為 C# 型別。",{"type":21,"tag":95,"props":7702,"children":7703},{},[7704,7709],{"type":21,"tag":99,"props":7705,"children":7706},{},[7707],{"type":26,"value":7708},"查詢 (GET)",{"type":26,"value":7710},"：透過主鍵查詢資料庫，若找到則返回 JSON，包括鍵和值以及版本號。版本號可以透過 HTTP ETag 頭返回，供客戶端做併發控制（比如更新時帶回去作條件比對）。",{"type":21,"tag":95,"props":7712,"children":7713},{},[7714,7719,7721,7726,7728,7733,7735,7740,7742,7746,7748,7753,7755,7760],{"type":21,"tag":99,"props":7715,"children":7716},{},[7717],{"type":26,"value":7718},"更新/插入 (PUT)",{"type":26,"value":7720},"：先嘗試執行 SQL ",{"type":21,"tag":107,"props":7722,"children":7723},{"className":13},[7724],{"type":26,"value":7725},"UPDATE",{"type":26,"value":7727}," 語句（利用 ",{"type":21,"tag":107,"props":7729,"children":7730},{"className":13},[7731],{"type":26,"value":7732},"@@ROWCOUNT",{"type":26,"value":7734}," 判斷是否有行受影響）更新現有記錄的值，並將版本 ",{"type":21,"tag":107,"props":7736,"children":7737},{"className":13},[7738],{"type":26,"value":7739},"Version = Version + 1",{"type":26,"value":7741},"。若 ",{"type":21,"tag":107,"props":7743,"children":7744},{"className":13},[7745],{"type":26,"value":7725},{"type":26,"value":7747}," 返回影響行數為0，表示該鍵不存在，進而嘗試執行 ",{"type":21,"tag":107,"props":7749,"children":7750},{"className":13},[7751],{"type":26,"value":7752},"INSERT",{"type":26,"value":7754}," 新記錄。考慮到可能出現",{"type":21,"tag":99,"props":7756,"children":7757},{},[7758],{"type":26,"value":7759},"併發",{"type":26,"value":7761},"（兩請求幾乎同時插入同一鍵導致一方PK衝突），捕獲 PK 違規錯誤號2627並返回衝突結果，提醒客戶端該鍵已被其他請求寫入。",{"type":21,"tag":95,"props":7763,"children":7764},{},[7765,7767,7772],{"type":26,"value":7766},"整個 PUT 操作未使用顯式交易（Transaction），但由於我們先嘗試 UPDATE 再 INSERT，兩步間依然有極小窗口可能導致重複插入。因此以 try-catch 捕捉 PK 衝突視為",{"type":21,"tag":99,"props":7768,"children":7769},{},[7770],{"type":26,"value":7771},"最終一致性下的衝突解決",{"type":26,"value":7773},"之一種：這裡簡單地告知客戶端衝突，由客戶端決定後續（類似 Dynamo 讀合併寫回模式）。",{"type":21,"tag":22,"props":7775,"children":7776},{},[7777,7782],{"type":21,"tag":99,"props":7778,"children":7779},{},[7780],{"type":26,"value":7781},"對應章節概念：",{"type":26,"value":7783}," 這段程式碼體現了數個我們在前面討論的概念：",{"type":21,"tag":187,"props":7785,"children":7786},{},[7787,7797,7807,7836,7852,7862],{"type":21,"tag":95,"props":7788,"children":7789},{},[7790,7795],{"type":21,"tag":2342,"props":7791,"children":7792},{},[7793],{"type":26,"value":7794},"Hash Table 存儲",{"type":26,"value":7796},"：我們以資料庫表的 PK 索引模擬鍵值對的 O(1) 查找，類似單機 HashTable。",{"type":21,"tag":95,"props":7798,"children":7799},{},[7800,7805],{"type":21,"tag":2342,"props":7801,"children":7802},{},[7803],{"type":26,"value":7804},"持久化與 WAL",{"type":26,"value":7806},"：SQL 資料庫本身在執行 UPDATE/INSERT 時已使用WAL日志確保原子性，我們不需另寫文件日誌。但原理類似我們在寫路徑中強調的先寫提交日誌。",{"type":21,"tag":95,"props":7808,"children":7809},{},[7810,7815,7817,7821,7823,7827,7829,7834],{"type":21,"tag":2342,"props":7811,"children":7812},{},[7813],{"type":26,"value":7814},"版本號/衝突控制",{"type":26,"value":7816},"：我們透過 ",{"type":21,"tag":107,"props":7818,"children":7819},{"className":13},[7820],{"type":26,"value":6457},{"type":26,"value":7822}," 欄位實現",{"type":21,"tag":99,"props":7824,"children":7825},{},[7826],{"type":26,"value":6464},{"type":26,"value":7828},"，每次更新+1。這與向量時鐘理念類似但簡化為單一節點序號，用於檢測並發更新：若多客戶端同時讀取同一版本並各自修改，我們可以藉由版本是否匹配來檢測衝突（在此例中，可在 PUT 加入 ",{"type":21,"tag":107,"props":7830,"children":7831},{"className":13},[7832],{"type":26,"value":7833},"WHERE Version = X",{"type":26,"value":7835}," 條件保護，若版本不符則UPDATE無效，提示客戶端重試）。",{"type":21,"tag":95,"props":7837,"children":7838},{},[7839,7844,7846,7850],{"type":21,"tag":2342,"props":7840,"children":7841},{},[7842],{"type":26,"value":7843},"最終一致性與衝突",{"type":26,"value":7845},"：我們示範了簡單的",{"type":21,"tag":99,"props":7847,"children":7848},{},[7849],{"type":26,"value":158},{"type":26,"value":7851},"邏輯（PK衝突時返回 409），這映射到 Session 2 談的併發寫入衝突需要協調解決的場景。",{"type":21,"tag":95,"props":7853,"children":7854},{},[7855,7860],{"type":21,"tag":2342,"props":7856,"children":7857},{},[7858],{"type":26,"value":7859},"高可用與容錯",{"type":26,"value":7861},"：本範例為簡化單節點服務，未實現 Gossip 等機制。但若擴展為多節點，我們可令每個節點部署此API服務並指向各自後端（如各自的資料庫分片），客戶端透過一致性哈希選節點請求，即可形成一個去中心的分散集群。再搭配資料庫層的同步機制或上層協調，可實現我們設計的 AP 模型。",{"type":21,"tag":95,"props":7863,"children":7864},{},[7865,7869,7871,7876],{"type":21,"tag":2342,"props":7866,"children":7867},{},[7868],{"type":26,"value":178},{"type":26,"value":7870},"：GET 端點優先查主鍵索引、PUT 端點先寫資料庫（相當於我們設計中寫MemTable和CommitLog），兩者都體現",{"type":21,"tag":99,"props":7872,"children":7873},{},[7874],{"type":26,"value":7875},"先快取/內存再磁碟",{"type":26,"value":7877},"的思路。雖然我們這裡讓SQL處理細節，但對應Cassandra架構中就是遵循「內存->磁碟、先log再flush」的流程。",{"type":21,"tag":75,"props":7879,"children":7880},{},[7881],{"type":21,"tag":22,"props":7882,"children":7883},{},[7884,7889],{"type":21,"tag":99,"props":7885,"children":7886},{},[7887],{"type":26,"value":7888},"附註：",{"type":26,"value":7890}," 實務中，可用 Entity Framework Core 或其他 ORM 簡化資料訪問，這裡用 Dapper 為直觀展現 SQL 操作。另外，為專注重點，程式碼省略了一些如日誌、更多錯誤處理，以及向量時鐘多節點部分（因單資料庫難以模擬多副本場景）。但其結構已足以作為Minimal Key-Value Store服務的雛形。",{"type":21,"tag":275,"props":7892,"children":7893},{},[],{"type":21,"tag":38,"props":7895,"children":7896},{},[],{"type":21,"tag":3274,"props":7898,"children":7900},{"id":7899},"現代鍵值存儲框架演進與比較-20232025",[7901],{"type":26,"value":7902},"現代鍵值存儲框架演進與比較 (2023–2025)",{"type":21,"tag":22,"props":7904,"children":7905},{},[7906],{"type":26,"value":7907},"如今市面上有眾多鍵值存儲解決方案，各具不同的架構與特性。我們選取其中具代表性的 DynamoDB、TiKV、FoundationDB、etcd、Redis Cluster，結合近年演進，做一番概覽與比較：",{"type":21,"tag":4974,"props":7909,"children":7910},{},[7911,7942],{"type":21,"tag":4978,"props":7912,"children":7913},{},[7914],{"type":21,"tag":4982,"props":7915,"children":7916},{},[7917,7922,7927,7932,7937],{"type":21,"tag":4986,"props":7918,"children":7919},{},[7920],{"type":26,"value":7921},"平台",{"type":21,"tag":4986,"props":7923,"children":7924},{},[7925],{"type":26,"value":7926},"架構/定位",{"type":21,"tag":4986,"props":7928,"children":7929},{},[7930],{"type":26,"value":7931},"CAP 類型",{"type":21,"tag":4986,"props":7933,"children":7934},{},[7935],{"type":26,"value":7936},"一致性協議",{"type":21,"tag":4986,"props":7938,"children":7939},{},[7940],{"type":26,"value":7941},"特點與近年發展",{"type":21,"tag":4996,"props":7943,"children":7944},{},[7945,8026,8096,8171,8226,8297],{"type":21,"tag":4982,"props":7946,"children":7947},{},[7948,7956,7961,7976,7986],{"type":21,"tag":5003,"props":7949,"children":7950},{},[7951],{"type":21,"tag":99,"props":7952,"children":7953},{},[7954],{"type":26,"value":7955},"Amazon DynamoDB",{"type":21,"tag":5003,"props":7957,"children":7958},{},[7959],{"type":26,"value":7960},"AWS 雲托管鍵值資料庫，無縫擴展",{"type":21,"tag":5003,"props":7962,"children":7963},{},[7964,7969,7971,7974],{"type":21,"tag":99,"props":7965,"children":7966},{},[7967],{"type":26,"value":7968},"AP",{"type":26,"value":7970}," (預設)",{"type":21,"tag":275,"props":7972,"children":7973},{},[],{"type":26,"value":7975},"提供可選強一致讀",{"type":21,"tag":5003,"props":7977,"children":7978},{},[7979,7984],{"type":21,"tag":99,"props":7980,"children":7981},{},[7982],{"type":26,"value":7983},"單主 Multi-Paxos",{"type":26,"value":7985}," 每分片一主",{"type":21,"tag":5003,"props":7987,"children":7988},{},[7989,7991,7996,7998,8003,8005,8010,8012,8017,8019,8024],{"type":26,"value":7990},"高度可擴展（支援萬億級別請求），預設最終一致但可選",{"type":21,"tag":99,"props":7992,"children":7993},{},[7994],{"type":26,"value":7995},"強一致讀",{"type":26,"value":7997},"模式。近年新增",{"type":21,"tag":99,"props":7999,"children":8000},{},[8001],{"type":26,"value":8002},"全局資料表",{"type":26,"value":8004},"實現多區域複製、",{"type":21,"tag":99,"props":8006,"children":8007},{},[8008],{"type":26,"value":8009},"交易",{"type":26,"value":8011},"支持 (Transaction) 等功能，使之同時滿足嚴格一致場景需求。架構源於 Dynamo 論文但實際實現有別：採用",{"type":21,"tag":99,"props":8013,"children":8014},{},[8015],{"type":26,"value":8016},"單主同步",{"type":26,"value":8018},"複製（每分區一主節點）確保寫一致性，並以",{"type":21,"tag":99,"props":8020,"children":8021},{},[8022],{"type":26,"value":8023},"多主Region",{"type":26,"value":8025},"實現全球可用。",{"type":21,"tag":4982,"props":8027,"children":8028},{},[8029,8037,8042,8051,8071],{"type":21,"tag":5003,"props":8030,"children":8031},{},[8032],{"type":21,"tag":99,"props":8033,"children":8034},{},[8035],{"type":26,"value":8036},"Apache Cassandra",{"type":21,"tag":5003,"props":8038,"children":8039},{},[8040],{"type":26,"value":8041},"分散式列族資料庫，也提供鍵值接口",{"type":21,"tag":5003,"props":8043,"children":8044},{},[8045,8049],{"type":21,"tag":99,"props":8046,"children":8047},{},[8048],{"type":26,"value":7968},{"type":26,"value":8050}," (可調一致性)",{"type":21,"tag":5003,"props":8052,"children":8053},{},[8054,8059,8062,8064,8069],{"type":21,"tag":99,"props":8055,"children":8056},{},[8057],{"type":26,"value":8058},"無主對等 + Gossip",{"type":21,"tag":275,"props":8060,"children":8061},{},[],{"type":26,"value":8063},"使用 ",{"type":21,"tag":99,"props":8065,"children":8066},{},[8067],{"type":26,"value":8068},"Hinted Handoff",{"type":26,"value":8070}," 等",{"type":21,"tag":5003,"props":8072,"children":8073},{},[8074,8076,8081,8083,8088,8089,8094],{"type":26,"value":8075},"Cassandra 基於 Dynamo 理念實作，無中心，多副本最終一致。特點是採用",{"type":21,"tag":99,"props":8077,"children":8078},{},[8079],{"type":26,"value":8080},"可調一致性",{"type":26,"value":8082},"（客戶端可指定 R/W），提供 TimeUUID 等順序支援。近年版本（4.0以後）加強了 ",{"type":21,"tag":99,"props":8084,"children":8085},{},[8086],{"type":26,"value":8087},"Audit Logging",{"type":26,"value":3940},{"type":21,"tag":99,"props":8090,"children":8091},{},[8092],{"type":26,"value":8093},"Backpressure",{"type":26,"value":8095}," 等特性。",{"type":21,"tag":4982,"props":8097,"children":8098},{},[8099,8107,8112,8122,8132],{"type":21,"tag":5003,"props":8100,"children":8101},{},[8102],{"type":21,"tag":99,"props":8103,"children":8104},{},[8105],{"type":26,"value":8106},"Redis (Cluster 模式)",{"type":21,"tag":5003,"props":8108,"children":8109},{},[8110],{"type":26,"value":8111},"記憶體鍵值庫，支援集群分片",{"type":21,"tag":5003,"props":8113,"children":8114},{},[8115,8120],{"type":21,"tag":99,"props":8116,"children":8117},{},[8118],{"type":26,"value":8119},"偏AP",{"type":26,"value":8121},"（高可用優先）",{"type":21,"tag":5003,"props":8123,"children":8124},{},[8125,8130],{"type":21,"tag":99,"props":8126,"children":8127},{},[8128],{"type":26,"value":8129},"主從非同步",{"type":26,"value":8131}," (Sentinel自動故障轉移)",{"type":21,"tag":5003,"props":8133,"children":8134},{},[8135,8137,8142,8144,8149,8151,8156,8158,8163,8164,8169],{"type":26,"value":8136},"Redis Cluster將資料通過",{"type":21,"tag":99,"props":8138,"children":8139},{},[8140],{"type":26,"value":8141},"哈希槽分片",{"type":26,"value":8143},"到多節點，每片一主多從。提供快速讀寫（記憶體操作），但",{"type":21,"tag":99,"props":8145,"children":8146},{},[8147],{"type":26,"value":8148},"一致性較弱",{"type":26,"value":8150},"：主節點異步複製到從節點，故障時可能丟失最近更新。採用",{"type":21,"tag":99,"props":8152,"children":8153},{},[8154],{"type":26,"value":8155},"Gossip",{"type":26,"value":8157},"協議維護節點拓撲，Sentinel/Cluster Bus選舉新主。2023年後，Redis 7 引入",{"type":21,"tag":99,"props":8159,"children":8160},{},[8161],{"type":26,"value":8162},"多線程IO",{"type":26,"value":1473},{"type":21,"tag":99,"props":8165,"children":8166},{},[8167],{"type":26,"value":8168},"ACL",{"type":26,"value":8170},"改進，但核心集群架構保持簡潔，以性能和簡易性見長。適用快取場景或對一致性要求不高的即時應用。",{"type":21,"tag":4982,"props":8172,"children":8173},{},[8174,8182,8187,8197,8207],{"type":21,"tag":5003,"props":8175,"children":8176},{},[8177],{"type":21,"tag":99,"props":8178,"children":8179},{},[8180],{"type":26,"value":8181},"TiKV",{"type":21,"tag":5003,"props":8183,"children":8184},{},[8185],{"type":26,"value":8186},"分散式事務鍵值庫（TiDB 的KV層）",{"type":21,"tag":5003,"props":8188,"children":8189},{},[8190,8195],{"type":21,"tag":99,"props":8191,"children":8192},{},[8193],{"type":26,"value":8194},"CP",{"type":26,"value":8196},"   (強一致)",{"type":21,"tag":5003,"props":8198,"children":8199},{},[8200,8205],{"type":21,"tag":99,"props":8201,"children":8202},{},[8203],{"type":26,"value":8204},"Raft 共識",{"type":26,"value":8206}," (每Region三副本)",{"type":21,"tag":5003,"props":8208,"children":8209},{},[8210,8212,8217,8219,8224],{"type":26,"value":8211},"TiKV 專注於強一致儲存，採用 Google Percolator 模型提供",{"type":21,"tag":99,"props":8213,"children":8214},{},[8215],{"type":26,"value":8216},"分散式ACID交易",{"type":26,"value":8218},"。透過 Raft 確保複製一致性，每筆資料三副本。近年 PingCAP 將 TiKV 發展為獨立項目，版本7引入",{"type":21,"tag":99,"props":8220,"children":8221},{},[8222],{"type":26,"value":8223},"Partitioned RaftKV",{"type":26,"value":8225},"引擎，降低寫放大提升效能。TiKV 在 Cloud Native 社區活躍，KubeCon 2023 發表其支援 PB 級數據與 QoS 改進。它適合作為新一代關係資料庫的存儲引擎或需要強一致性的元資料存儲。",{"type":21,"tag":4982,"props":8227,"children":8228},{},[8229,8237,8242,8251,8264],{"type":21,"tag":5003,"props":8230,"children":8231},{},[8232],{"type":21,"tag":99,"props":8233,"children":8234},{},[8235],{"type":26,"value":8236},"FoundationDB",{"type":21,"tag":5003,"props":8238,"children":8239},{},[8240],{"type":26,"value":8241},"分散式多模 KV 庫（底層Key-Value，頂層可映射文檔、SQL等）",{"type":21,"tag":5003,"props":8243,"children":8244},{},[8245,8249],{"type":21,"tag":99,"props":8246,"children":8247},{},[8248],{"type":26,"value":8194},{"type":26,"value":8250}," (強一致)",{"type":21,"tag":5003,"props":8252,"children":8253},{},[8254,8259,8262],{"type":21,"tag":99,"props":8255,"children":8256},{},[8257],{"type":26,"value":8258},"主從 + 任務分離",{"type":21,"tag":275,"props":8260,"children":8261},{},[],{"type":26,"value":8263},"(分層架構+協調服務)",{"type":21,"tag":5003,"props":8265,"children":8266},{},[8267,8269,8274,8276,8281,8283,8288,8290,8295],{"type":26,"value":8268},"FoundationDB 提供",{"type":21,"tag":99,"props":8270,"children":8271},{},[8272],{"type":26,"value":8273},"嚴格 ACID 交易",{"type":26,"value":8275},"的鍵值存儲，將事務處理與存儲層解耦。採用類似集中協調節點 (Resolvers) + 多存儲節點 (Storage Servers) 的設計，以",{"type":21,"tag":99,"props":8277,"children":8278},{},[8279],{"type":26,"value":8280},"樂觀並發控制",{"type":26,"value":8282},"執行交易，再用",{"type":21,"tag":99,"props":8284,"children":8285},{},[8286],{"type":26,"value":8287},"多版本",{"type":26,"value":8289},"確保只讀不鎖定。它的複製也使用類似 Raft 的容錯機制（協調器選舉）。Apple 開源後社群活躍，Snowflake 等公司在內部大量使用。近年版本7引入新存儲引擎 Redwood（B+樹結構）提升大值處理效率。FoundationDB 特點在於可透過「Layer」構建高層資料模型，如文檔、SQL，具",{"type":21,"tag":99,"props":8291,"children":8292},{},[8293],{"type":26,"value":8294},"通用基礎存儲",{"type":26,"value":8296},"潛力，同時保持高性能和分散式一致性。",{"type":21,"tag":4982,"props":8298,"children":8299},{},[8300,8308,8313,8321,8330],{"type":21,"tag":5003,"props":8301,"children":8302},{},[8303],{"type":21,"tag":99,"props":8304,"children":8305},{},[8306],{"type":26,"value":8307},"etcd",{"type":21,"tag":5003,"props":8309,"children":8310},{},[8311],{"type":26,"value":8312},"分散式一致性KV，主要做配置/註冊",{"type":21,"tag":5003,"props":8314,"children":8315},{},[8316,8320],{"type":21,"tag":99,"props":8317,"children":8318},{},[8319],{"type":26,"value":8194},{"type":26,"value":8250},{"type":21,"tag":5003,"props":8322,"children":8323},{},[8324,8328],{"type":21,"tag":99,"props":8325,"children":8326},{},[8327],{"type":26,"value":8204},{"type":26,"value":8329}," (3或5節點組)",{"type":21,"tag":5003,"props":8331,"children":8332},{},[8333,8335,8340,8342,8347],{"type":26,"value":8334},"etcd 是 Kubernetes 等系統的",{"type":21,"tag":99,"props":8336,"children":8337},{},[8338],{"type":26,"value":8339},"配置中心",{"type":26,"value":8341},"，專注小型資料的強一致儲存。透過 Raft 保證線性一致讀寫，常以奇數節點組成（3或5）集群，任何變更需多數同意。等價於",{"type":21,"tag":99,"props":8343,"children":8344},{},[8345],{"type":26,"value":8346},"決不容忍腦裂",{"type":26,"value":8348},"、寧可停止服務保證一致性的策略。故在 CAP 上屬 CP 類型，其寫入需要等待同步，大部分操作延遲高於AP系統，但能保證嚴格一致。近年 etcd 強化了快照與壓縮機制減少長期運行時儲存膨脹，並在 Kubernetes 中驗證了其可靠性。不過由於追求一致性，在大量資料存儲上擴展性有限（通常建議數 GB 以內資料量）。",{"type":21,"tag":22,"props":8350,"children":8351},{},[8352,8354,8359],{"type":26,"value":8353},"指出：",{"type":21,"tag":99,"props":8355,"children":8356},{},[8357],{"type":26,"value":8358},"Redis/MySQL 僅本地存單副本，而 TiKV/etcd 在三個節點上存三副本（通過 Raft 協議）",{"type":26,"value":8360},"。這直接反映了它們在 CAP 上的取捨差異——Redis/傳統資料庫多為 CA/單機擴展模式，追求可用性但透過主從複製仍可能有不一致；而 TiKV、etcd 堅持 CP 模式，每次寫都經過多節點一致同意。",{"type":21,"tag":22,"props":8362,"children":8363},{},[8364],{"type":26,"value":8365},"總體而言，近年鍵值存儲領域趨勢可以概括為：",{"type":21,"tag":187,"props":8367,"children":8368},{},[8369,8379,8396,8413],{"type":21,"tag":95,"props":8370,"children":8371},{},[8372,8377],{"type":21,"tag":99,"props":8373,"children":8374},{},[8375],{"type":26,"value":8376},"強一致性的崛起：",{"type":26,"value":8378}," 在雲原生環境下，像 FoundationDB、TiKV、etcd 等強一致KV廣受關注，因為它們簡化了上層應用的邏輯（不用擔心讀到舊數據）。這些系統大都基於共識演算法（Raft/Paxos）實現，隨著網路和算法優化，其性能也逐步提高，可支持越來越大的集群和資料量。",{"type":21,"tag":95,"props":8380,"children":8381},{},[8382,8387,8389,8394],{"type":21,"tag":99,"props":8383,"children":8384},{},[8385],{"type":26,"value":8386},"最終一致性的堅守：",{"type":26,"value":8388}," 傳統 Dynamo 風格的 AP 系統依然在大規模場景佔有一席，例如 DynamoDB、Cassandra、Riak 等。它們在全球部署、高流量容忍方面具備獨特優勢，並且透過引入",{"type":21,"tag":99,"props":8390,"children":8391},{},[8392],{"type":26,"value":8393},"輔助功能",{"type":26,"value":8395},"（如 DynamoDB 提供可選強一致讀），在CAP平衡上提供更多彈性。",{"type":21,"tag":95,"props":8397,"children":8398},{},[8399,8404,8406,8411],{"type":21,"tag":99,"props":8400,"children":8401},{},[8402],{"type":26,"value":8403},"內存與持久化融合：",{"type":26,"value":8405}," Redis 從純內存Cache演進出 Redis Cluster、再到支援持久化AOF/快照，以及近期的Redis on Flash方案等，說明高速內存KV和持久存儲結合是需求所在。許多系統（如 TiKV 使用 RocksDB LSM 引擎）也著重",{"type":21,"tag":99,"props":8407,"children":8408},{},[8409],{"type":26,"value":8410},"壓榨硬體",{"type":26,"value":8412},"性能，包含NVMe、optane等新介質的應用。",{"type":21,"tag":95,"props":8414,"children":8415},{},[8416,8421],{"type":21,"tag":99,"props":8417,"children":8418},{},[8419],{"type":26,"value":8420},"多模與易用性：",{"type":26,"value":8422}," 新一代KV如 FoundationDB 主打「一個核心，多種模型」，TiKV + TiDB 則展示了將鍵值存儲升級到分散式SQL的可能。這些演進都圍繞讓開發者更容易使用鍵值存儲，同時享受分散式帶來的伸縮與可靠性優勢。",{"type":21,"tag":38,"props":8424,"children":8425},{},[],{"type":21,"tag":84,"props":8427,"children":8429},{"id":8428},"以下額外參考",[8430],{"type":26,"value":8428},{"type":21,"tag":3274,"props":8432,"children":8434},{"id":8433},"資料分區一致性雜湊",[8435],{"type":26,"value":8436},"資料分區：一致性雜湊",{"type":21,"tag":187,"props":8438,"children":8439},{},[8440,8445],{"type":21,"tag":95,"props":8441,"children":8442},{},[8443],{"type":26,"value":8444},"Virtual Node、負載平均、動態擴縮",{"type":21,"tag":95,"props":8446,"children":8447},{},[8448,8453,8454,8459],{"type":21,"tag":99,"props":8449,"children":8450},{},[8451],{"type":26,"value":8452},"程式範例",{"type":26,"value":3000},{"type":21,"tag":107,"props":8455,"children":8456},{"className":13},[8457],{"type":26,"value":8458},"ConsistentHashRing",{"type":26,"value":8460}," (C# /.NET 8)",{"type":21,"tag":196,"props":8462,"children":8464},{"code":8463,"language":6489,"meta":13,"className":6490,"style":13},"public sealed class ConsistentHashRing\u003CT>\n{\n    private readonly SortedDictionary\u003Cint, T> _ring = new();\n    private readonly int _replicas;\n    private readonly MD5 _md5 = MD5.Create();\n\n    public ConsistentHashRing(IEnumerable\u003CT> nodes, int replicas = 160)\n    {\n        _replicas = replicas;\n        foreach (var node in nodes) AddNode(node);\n    }\n\n    public void AddNode(T node)\n    {\n        for (int i = 0; i \u003C _replicas; i++)\n        {\n            var hash = Hash($\"{node}-{i}\");\n            _ring[hash] = node;\n        }\n    }\n\n    public void RemoveNode(T node)\n    {\n        for (int i = 0; i \u003C _replicas; i++)\n        {\n            var hash = Hash($\"{node}-{i}\");\n            _ring.Remove(hash);\n        }\n    }\n\n    public T GetNode(string key)\n    {\n        if (!_ring.Any()) throw new InvalidOperationException(\"Ring is empty\");\n        var hash = Hash(key);\n        var kv = _ring.FirstOrDefault(p => p.Key >= hash);\n        return kv.Equals(default(KeyValuePair\u003Cint, T>)) ? _ring.First().Value : kv.Value;\n    }\n\n    private int Hash(string input)\n    {\n        var bytes = _md5.ComputeHash(Encoding.UTF8.GetBytes(input));\n        return BitConverter.ToInt32(bytes, 0) & 0x7FFFFFFF; // positive int\n    }\n}\n",[8465],{"type":21,"tag":107,"props":8466,"children":8467},{"__ignoreMap":13},[8468,8505,8512,8568,8593,8632,8639,8703,8710,8727,8768,8775,8782,8815,8822,8874,8881,8936,8953,8960,8967,8974,9006,9013,9060,9067,9114,9132,9139,9146,9153,9186,9193,9252,9277,9331,9416,9423,9430,9462,9469,9510,9560,9567],{"type":21,"tag":206,"props":8469,"children":8470},{"class":208,"line":209},[8471,8476,8481,8486,8491,8495,8500],{"type":21,"tag":206,"props":8472,"children":8473},{"style":213},[8474],{"type":26,"value":8475},"public",{"type":21,"tag":206,"props":8477,"children":8478},{"style":213},[8479],{"type":26,"value":8480}," sealed",{"type":21,"tag":206,"props":8482,"children":8483},{"style":6400},[8484],{"type":26,"value":8485}," class",{"type":21,"tag":206,"props":8487,"children":8488},{"style":6505},[8489],{"type":26,"value":8490}," ConsistentHashRing",{"type":21,"tag":206,"props":8492,"children":8493},{"style":225},[8494],{"type":26,"value":7317},{"type":21,"tag":206,"props":8496,"children":8497},{"style":6505},[8498],{"type":26,"value":8499},"T",{"type":21,"tag":206,"props":8501,"children":8502},{"style":225},[8503],{"type":26,"value":8504},">\n",{"type":21,"tag":206,"props":8506,"children":8507},{"class":208,"line":237},[8508],{"type":21,"tag":206,"props":8509,"children":8510},{"style":225},[8511],{"type":26,"value":3488},{"type":21,"tag":206,"props":8513,"children":8514},{"class":208,"line":3516},[8515,8520,8525,8530,8534,8538,8542,8546,8551,8556,8560,8564],{"type":21,"tag":206,"props":8516,"children":8517},{"style":213},[8518],{"type":26,"value":8519},"    private",{"type":21,"tag":206,"props":8521,"children":8522},{"style":213},[8523],{"type":26,"value":8524}," readonly",{"type":21,"tag":206,"props":8526,"children":8527},{"style":6505},[8528],{"type":26,"value":8529}," SortedDictionary",{"type":21,"tag":206,"props":8531,"children":8532},{"style":225},[8533],{"type":26,"value":7317},{"type":21,"tag":206,"props":8535,"children":8536},{"style":213},[8537],{"type":26,"value":6891},{"type":21,"tag":206,"props":8539,"children":8540},{"style":225},[8541],{"type":26,"value":6725},{"type":21,"tag":206,"props":8543,"children":8544},{"style":6505},[8545],{"type":26,"value":8499},{"type":21,"tag":206,"props":8547,"children":8548},{"style":225},[8549],{"type":26,"value":8550},"> ",{"type":21,"tag":206,"props":8552,"children":8553},{"style":6567},[8554],{"type":26,"value":8555},"_ring",{"type":21,"tag":206,"props":8557,"children":8558},{"style":213},[8559],{"type":26,"value":6575},{"type":21,"tag":206,"props":8561,"children":8562},{"style":213},[8563],{"type":26,"value":6825},{"type":21,"tag":206,"props":8565,"children":8566},{"style":225},[8567],{"type":26,"value":6621},{"type":21,"tag":206,"props":8569,"children":8570},{"class":208,"line":3538},[8571,8575,8579,8584,8589],{"type":21,"tag":206,"props":8572,"children":8573},{"style":213},[8574],{"type":26,"value":8519},{"type":21,"tag":206,"props":8576,"children":8577},{"style":213},[8578],{"type":26,"value":8524},{"type":21,"tag":206,"props":8580,"children":8581},{"style":213},[8582],{"type":26,"value":8583}," int",{"type":21,"tag":206,"props":8585,"children":8586},{"style":6567},[8587],{"type":26,"value":8588}," _replicas",{"type":21,"tag":206,"props":8590,"children":8591},{"style":225},[8592],{"type":26,"value":6532},{"type":21,"tag":206,"props":8594,"children":8595},{"class":208,"line":3556},[8596,8600,8604,8609,8614,8618,8623,8628],{"type":21,"tag":206,"props":8597,"children":8598},{"style":213},[8599],{"type":26,"value":8519},{"type":21,"tag":206,"props":8601,"children":8602},{"style":213},[8603],{"type":26,"value":8524},{"type":21,"tag":206,"props":8605,"children":8606},{"style":6505},[8607],{"type":26,"value":8608}," MD5",{"type":21,"tag":206,"props":8610,"children":8611},{"style":6567},[8612],{"type":26,"value":8613}," _md5",{"type":21,"tag":206,"props":8615,"children":8616},{"style":213},[8617],{"type":26,"value":6575},{"type":21,"tag":206,"props":8619,"children":8620},{"style":225},[8621],{"type":26,"value":8622}," MD5.",{"type":21,"tag":206,"props":8624,"children":8625},{"style":219},[8626],{"type":26,"value":8627},"Create",{"type":21,"tag":206,"props":8629,"children":8630},{"style":225},[8631],{"type":26,"value":6621},{"type":21,"tag":206,"props":8633,"children":8634},{"class":208,"line":6624},[8635],{"type":21,"tag":206,"props":8636,"children":8637},{"emptyLinePlaceholder":5},[8638],{"type":26,"value":6556},{"type":21,"tag":206,"props":8640,"children":8641},{"class":208,"line":6632},[8642,8647,8651,8655,8660,8664,8668,8672,8677,8681,8685,8690,8694,8699],{"type":21,"tag":206,"props":8643,"children":8644},{"style":213},[8645],{"type":26,"value":8646},"    public",{"type":21,"tag":206,"props":8648,"children":8649},{"style":219},[8650],{"type":26,"value":8490},{"type":21,"tag":206,"props":8652,"children":8653},{"style":225},[8654],{"type":26,"value":792},{"type":21,"tag":206,"props":8656,"children":8657},{"style":6505},[8658],{"type":26,"value":8659},"IEnumerable",{"type":21,"tag":206,"props":8661,"children":8662},{"style":225},[8663],{"type":26,"value":7317},{"type":21,"tag":206,"props":8665,"children":8666},{"style":6505},[8667],{"type":26,"value":8499},{"type":21,"tag":206,"props":8669,"children":8670},{"style":225},[8671],{"type":26,"value":8550},{"type":21,"tag":206,"props":8673,"children":8674},{"style":6567},[8675],{"type":26,"value":8676},"nodes",{"type":21,"tag":206,"props":8678,"children":8679},{"style":225},[8680],{"type":26,"value":6725},{"type":21,"tag":206,"props":8682,"children":8683},{"style":213},[8684],{"type":26,"value":6891},{"type":21,"tag":206,"props":8686,"children":8687},{"style":6567},[8688],{"type":26,"value":8689}," replicas",{"type":21,"tag":206,"props":8691,"children":8692},{"style":213},[8693],{"type":26,"value":6575},{"type":21,"tag":206,"props":8695,"children":8696},{"style":3505},[8697],{"type":26,"value":8698}," 160",{"type":21,"tag":206,"props":8700,"children":8701},{"style":225},[8702],{"type":26,"value":598},{"type":21,"tag":206,"props":8704,"children":8705},{"class":208,"line":6641},[8706],{"type":21,"tag":206,"props":8707,"children":8708},{"style":225},[8709],{"type":26,"value":6958},{"type":21,"tag":206,"props":8711,"children":8712},{"class":208,"line":6683},[8713,8718,8722],{"type":21,"tag":206,"props":8714,"children":8715},{"style":225},[8716],{"type":26,"value":8717},"        _replicas ",{"type":21,"tag":206,"props":8719,"children":8720},{"style":213},[8721],{"type":26,"value":6916},{"type":21,"tag":206,"props":8723,"children":8724},{"style":225},[8725],{"type":26,"value":8726}," replicas;\n",{"type":21,"tag":206,"props":8728,"children":8729},{"class":208,"line":6691},[8730,8735,8739,8743,8748,8753,8758,8763],{"type":21,"tag":206,"props":8731,"children":8732},{"style":213},[8733],{"type":26,"value":8734},"        foreach",{"type":21,"tag":206,"props":8736,"children":8737},{"style":225},[8738],{"type":26,"value":588},{"type":21,"tag":206,"props":8740,"children":8741},{"style":6400},[8742],{"type":26,"value":6564},{"type":21,"tag":206,"props":8744,"children":8745},{"style":6567},[8746],{"type":26,"value":8747}," node",{"type":21,"tag":206,"props":8749,"children":8750},{"style":213},[8751],{"type":26,"value":8752}," in",{"type":21,"tag":206,"props":8754,"children":8755},{"style":225},[8756],{"type":26,"value":8757}," nodes) ",{"type":21,"tag":206,"props":8759,"children":8760},{"style":219},[8761],{"type":26,"value":8762},"AddNode",{"type":21,"tag":206,"props":8764,"children":8765},{"style":225},[8766],{"type":26,"value":8767},"(node);\n",{"type":21,"tag":206,"props":8769,"children":8770},{"class":208,"line":6700},[8771],{"type":21,"tag":206,"props":8772,"children":8773},{"style":225},[8774],{"type":26,"value":7009},{"type":21,"tag":206,"props":8776,"children":8777},{"class":208,"line":6755},[8778],{"type":21,"tag":206,"props":8779,"children":8780},{"emptyLinePlaceholder":5},[8781],{"type":26,"value":6556},{"type":21,"tag":206,"props":8783,"children":8784},{"class":208,"line":6763},[8785,8789,8794,8799,8803,8807,8811],{"type":21,"tag":206,"props":8786,"children":8787},{"style":213},[8788],{"type":26,"value":8646},{"type":21,"tag":206,"props":8790,"children":8791},{"style":213},[8792],{"type":26,"value":8793}," void",{"type":21,"tag":206,"props":8795,"children":8796},{"style":219},[8797],{"type":26,"value":8798}," AddNode",{"type":21,"tag":206,"props":8800,"children":8801},{"style":225},[8802],{"type":26,"value":792},{"type":21,"tag":206,"props":8804,"children":8805},{"style":6505},[8806],{"type":26,"value":8499},{"type":21,"tag":206,"props":8808,"children":8809},{"style":6567},[8810],{"type":26,"value":8747},{"type":21,"tag":206,"props":8812,"children":8813},{"style":225},[8814],{"type":26,"value":598},{"type":21,"tag":206,"props":8816,"children":8817},{"class":208,"line":6795},[8818],{"type":21,"tag":206,"props":8819,"children":8820},{"style":225},[8821],{"type":26,"value":6958},{"type":21,"tag":206,"props":8823,"children":8824},{"class":208,"line":6838},[8825,8830,8834,8838,8843,8847,8851,8856,8860,8865,8870],{"type":21,"tag":206,"props":8826,"children":8827},{"style":213},[8828],{"type":26,"value":8829},"        for",{"type":21,"tag":206,"props":8831,"children":8832},{"style":225},[8833],{"type":26,"value":588},{"type":21,"tag":206,"props":8835,"children":8836},{"style":213},[8837],{"type":26,"value":6891},{"type":21,"tag":206,"props":8839,"children":8840},{"style":6567},[8841],{"type":26,"value":8842}," i",{"type":21,"tag":206,"props":8844,"children":8845},{"style":213},[8846],{"type":26,"value":6575},{"type":21,"tag":206,"props":8848,"children":8849},{"style":3505},[8850],{"type":26,"value":7373},{"type":21,"tag":206,"props":8852,"children":8853},{"style":225},[8854],{"type":26,"value":8855},"; i ",{"type":21,"tag":206,"props":8857,"children":8858},{"style":213},[8859],{"type":26,"value":7317},{"type":21,"tag":206,"props":8861,"children":8862},{"style":225},[8863],{"type":26,"value":8864}," _replicas; i",{"type":21,"tag":206,"props":8866,"children":8867},{"style":213},[8868],{"type":26,"value":8869},"++",{"type":21,"tag":206,"props":8871,"children":8872},{"style":225},[8873],{"type":26,"value":598},{"type":21,"tag":206,"props":8875,"children":8876},{"class":208,"line":6924},[8877],{"type":21,"tag":206,"props":8878,"children":8879},{"style":225},[8880],{"type":26,"value":7443},{"type":21,"tag":206,"props":8882,"children":8883},{"class":208,"line":6952},[8884,8889,8894,8898,8903,8907,8912,8917,8922,8927,8932],{"type":21,"tag":206,"props":8885,"children":8886},{"style":6400},[8887],{"type":26,"value":8888},"            var",{"type":21,"tag":206,"props":8890,"children":8891},{"style":6567},[8892],{"type":26,"value":8893}," hash",{"type":21,"tag":206,"props":8895,"children":8896},{"style":213},[8897],{"type":26,"value":6575},{"type":21,"tag":206,"props":8899,"children":8900},{"style":219},[8901],{"type":26,"value":8902}," Hash",{"type":21,"tag":206,"props":8904,"children":8905},{"style":225},[8906],{"type":26,"value":792},{"type":21,"tag":206,"props":8908,"children":8909},{"style":6673},[8910],{"type":26,"value":8911},"$\"{",{"type":21,"tag":206,"props":8913,"children":8914},{"style":225},[8915],{"type":26,"value":8916},"node",{"type":21,"tag":206,"props":8918,"children":8919},{"style":6673},[8920],{"type":26,"value":8921},"}-{",{"type":21,"tag":206,"props":8923,"children":8924},{"style":225},[8925],{"type":26,"value":8926},"i",{"type":21,"tag":206,"props":8928,"children":8929},{"style":6673},[8930],{"type":26,"value":8931},"}\"",{"type":21,"tag":206,"props":8933,"children":8934},{"style":225},[8935],{"type":26,"value":6426},{"type":21,"tag":206,"props":8937,"children":8938},{"class":208,"line":6961},[8939,8944,8948],{"type":21,"tag":206,"props":8940,"children":8941},{"style":225},[8942],{"type":26,"value":8943},"            _ring[hash] ",{"type":21,"tag":206,"props":8945,"children":8946},{"style":213},[8947],{"type":26,"value":6916},{"type":21,"tag":206,"props":8949,"children":8950},{"style":225},[8951],{"type":26,"value":8952}," node;\n",{"type":21,"tag":206,"props":8954,"children":8955},{"class":208,"line":7003},[8956],{"type":21,"tag":206,"props":8957,"children":8958},{"style":225},[8959],{"type":26,"value":7499},{"type":21,"tag":206,"props":8961,"children":8962},{"class":208,"line":7012},[8963],{"type":21,"tag":206,"props":8964,"children":8965},{"style":225},[8966],{"type":26,"value":7009},{"type":21,"tag":206,"props":8968,"children":8969},{"class":208,"line":7021},[8970],{"type":21,"tag":206,"props":8971,"children":8972},{"emptyLinePlaceholder":5},[8973],{"type":26,"value":6556},{"type":21,"tag":206,"props":8975,"children":8976},{"class":208,"line":7078},[8977,8981,8985,8990,8994,8998,9002],{"type":21,"tag":206,"props":8978,"children":8979},{"style":213},[8980],{"type":26,"value":8646},{"type":21,"tag":206,"props":8982,"children":8983},{"style":213},[8984],{"type":26,"value":8793},{"type":21,"tag":206,"props":8986,"children":8987},{"style":219},[8988],{"type":26,"value":8989}," RemoveNode",{"type":21,"tag":206,"props":8991,"children":8992},{"style":225},[8993],{"type":26,"value":792},{"type":21,"tag":206,"props":8995,"children":8996},{"style":6505},[8997],{"type":26,"value":8499},{"type":21,"tag":206,"props":8999,"children":9000},{"style":6567},[9001],{"type":26,"value":8747},{"type":21,"tag":206,"props":9003,"children":9004},{"style":225},[9005],{"type":26,"value":598},{"type":21,"tag":206,"props":9007,"children":9008},{"class":208,"line":7087},[9009],{"type":21,"tag":206,"props":9010,"children":9011},{"style":225},[9012],{"type":26,"value":6958},{"type":21,"tag":206,"props":9014,"children":9015},{"class":208,"line":7095},[9016,9020,9024,9028,9032,9036,9040,9044,9048,9052,9056],{"type":21,"tag":206,"props":9017,"children":9018},{"style":213},[9019],{"type":26,"value":8829},{"type":21,"tag":206,"props":9021,"children":9022},{"style":225},[9023],{"type":26,"value":588},{"type":21,"tag":206,"props":9025,"children":9026},{"style":213},[9027],{"type":26,"value":6891},{"type":21,"tag":206,"props":9029,"children":9030},{"style":6567},[9031],{"type":26,"value":8842},{"type":21,"tag":206,"props":9033,"children":9034},{"style":213},[9035],{"type":26,"value":6575},{"type":21,"tag":206,"props":9037,"children":9038},{"style":3505},[9039],{"type":26,"value":7373},{"type":21,"tag":206,"props":9041,"children":9042},{"style":225},[9043],{"type":26,"value":8855},{"type":21,"tag":206,"props":9045,"children":9046},{"style":213},[9047],{"type":26,"value":7317},{"type":21,"tag":206,"props":9049,"children":9050},{"style":225},[9051],{"type":26,"value":8864},{"type":21,"tag":206,"props":9053,"children":9054},{"style":213},[9055],{"type":26,"value":8869},{"type":21,"tag":206,"props":9057,"children":9058},{"style":225},[9059],{"type":26,"value":598},{"type":21,"tag":206,"props":9061,"children":9062},{"class":208,"line":7104},[9063],{"type":21,"tag":206,"props":9064,"children":9065},{"style":225},[9066],{"type":26,"value":7443},{"type":21,"tag":206,"props":9068,"children":9069},{"class":208,"line":7166},[9070,9074,9078,9082,9086,9090,9094,9098,9102,9106,9110],{"type":21,"tag":206,"props":9071,"children":9072},{"style":6400},[9073],{"type":26,"value":8888},{"type":21,"tag":206,"props":9075,"children":9076},{"style":6567},[9077],{"type":26,"value":8893},{"type":21,"tag":206,"props":9079,"children":9080},{"style":213},[9081],{"type":26,"value":6575},{"type":21,"tag":206,"props":9083,"children":9084},{"style":219},[9085],{"type":26,"value":8902},{"type":21,"tag":206,"props":9087,"children":9088},{"style":225},[9089],{"type":26,"value":792},{"type":21,"tag":206,"props":9091,"children":9092},{"style":6673},[9093],{"type":26,"value":8911},{"type":21,"tag":206,"props":9095,"children":9096},{"style":225},[9097],{"type":26,"value":8916},{"type":21,"tag":206,"props":9099,"children":9100},{"style":6673},[9101],{"type":26,"value":8921},{"type":21,"tag":206,"props":9103,"children":9104},{"style":225},[9105],{"type":26,"value":8926},{"type":21,"tag":206,"props":9107,"children":9108},{"style":6673},[9109],{"type":26,"value":8931},{"type":21,"tag":206,"props":9111,"children":9112},{"style":225},[9113],{"type":26,"value":6426},{"type":21,"tag":206,"props":9115,"children":9116},{"class":208,"line":7174},[9117,9122,9127],{"type":21,"tag":206,"props":9118,"children":9119},{"style":225},[9120],{"type":26,"value":9121},"            _ring.",{"type":21,"tag":206,"props":9123,"children":9124},{"style":219},[9125],{"type":26,"value":9126},"Remove",{"type":21,"tag":206,"props":9128,"children":9129},{"style":225},[9130],{"type":26,"value":9131},"(hash);\n",{"type":21,"tag":206,"props":9133,"children":9134},{"class":208,"line":7210},[9135],{"type":21,"tag":206,"props":9136,"children":9137},{"style":225},[9138],{"type":26,"value":7499},{"type":21,"tag":206,"props":9140,"children":9141},{"class":208,"line":7219},[9142],{"type":21,"tag":206,"props":9143,"children":9144},{"style":225},[9145],{"type":26,"value":7009},{"type":21,"tag":206,"props":9147,"children":9148},{"class":208,"line":7245},[9149],{"type":21,"tag":206,"props":9150,"children":9151},{"emptyLinePlaceholder":5},[9152],{"type":26,"value":6556},{"type":21,"tag":206,"props":9154,"children":9155},{"class":208,"line":7254},[9156,9160,9165,9170,9174,9178,9182],{"type":21,"tag":206,"props":9157,"children":9158},{"style":213},[9159],{"type":26,"value":8646},{"type":21,"tag":206,"props":9161,"children":9162},{"style":6505},[9163],{"type":26,"value":9164}," T",{"type":21,"tag":206,"props":9166,"children":9167},{"style":219},[9168],{"type":26,"value":9169}," GetNode",{"type":21,"tag":206,"props":9171,"children":9172},{"style":225},[9173],{"type":26,"value":792},{"type":21,"tag":206,"props":9175,"children":9176},{"style":213},[9177],{"type":26,"value":6647},{"type":21,"tag":206,"props":9179,"children":9180},{"style":6567},[9181],{"type":26,"value":6743},{"type":21,"tag":206,"props":9183,"children":9184},{"style":225},[9185],{"type":26,"value":598},{"type":21,"tag":206,"props":9187,"children":9188},{"class":208,"line":7263},[9189],{"type":21,"tag":206,"props":9190,"children":9191},{"style":225},[9192],{"type":26,"value":6958},{"type":21,"tag":206,"props":9194,"children":9195},{"class":208,"line":7272},[9196,9201,9205,9210,9215,9220,9225,9230,9234,9239,9243,9248],{"type":21,"tag":206,"props":9197,"children":9198},{"style":213},[9199],{"type":26,"value":9200},"        if",{"type":21,"tag":206,"props":9202,"children":9203},{"style":225},[9204],{"type":26,"value":588},{"type":21,"tag":206,"props":9206,"children":9207},{"style":213},[9208],{"type":26,"value":9209},"!",{"type":21,"tag":206,"props":9211,"children":9212},{"style":225},[9213],{"type":26,"value":9214},"_ring.",{"type":21,"tag":206,"props":9216,"children":9217},{"style":219},[9218],{"type":26,"value":9219},"Any",{"type":21,"tag":206,"props":9221,"children":9222},{"style":225},[9223],{"type":26,"value":9224},"()) ",{"type":21,"tag":206,"props":9226,"children":9227},{"style":213},[9228],{"type":26,"value":9229},"throw",{"type":21,"tag":206,"props":9231,"children":9232},{"style":213},[9233],{"type":26,"value":6825},{"type":21,"tag":206,"props":9235,"children":9236},{"style":6505},[9237],{"type":26,"value":9238}," InvalidOperationException",{"type":21,"tag":206,"props":9240,"children":9241},{"style":225},[9242],{"type":26,"value":792},{"type":21,"tag":206,"props":9244,"children":9245},{"style":6673},[9246],{"type":26,"value":9247},"\"Ring is empty\"",{"type":21,"tag":206,"props":9249,"children":9250},{"style":225},[9251],{"type":26,"value":6426},{"type":21,"tag":206,"props":9253,"children":9254},{"class":208,"line":7285},[9255,9260,9264,9268,9272],{"type":21,"tag":206,"props":9256,"children":9257},{"style":6400},[9258],{"type":26,"value":9259},"        var",{"type":21,"tag":206,"props":9261,"children":9262},{"style":6567},[9263],{"type":26,"value":8893},{"type":21,"tag":206,"props":9265,"children":9266},{"style":213},[9267],{"type":26,"value":6575},{"type":21,"tag":206,"props":9269,"children":9270},{"style":219},[9271],{"type":26,"value":8902},{"type":21,"tag":206,"props":9273,"children":9274},{"style":225},[9275],{"type":26,"value":9276},"(key);\n",{"type":21,"tag":206,"props":9278,"children":9279},{"class":208,"line":7354},[9280,9284,9289,9293,9298,9303,9307,9311,9316,9321,9326],{"type":21,"tag":206,"props":9281,"children":9282},{"style":6400},[9283],{"type":26,"value":9259},{"type":21,"tag":206,"props":9285,"children":9286},{"style":6567},[9287],{"type":26,"value":9288}," kv",{"type":21,"tag":206,"props":9290,"children":9291},{"style":213},[9292],{"type":26,"value":6575},{"type":21,"tag":206,"props":9294,"children":9295},{"style":225},[9296],{"type":26,"value":9297}," _ring.",{"type":21,"tag":206,"props":9299,"children":9300},{"style":219},[9301],{"type":26,"value":9302},"FirstOrDefault",{"type":21,"tag":206,"props":9304,"children":9305},{"style":225},[9306],{"type":26,"value":792},{"type":21,"tag":206,"props":9308,"children":9309},{"style":6567},[9310],{"type":26,"value":22},{"type":21,"tag":206,"props":9312,"children":9313},{"style":213},[9314],{"type":26,"value":9315}," =>",{"type":21,"tag":206,"props":9317,"children":9318},{"style":225},[9319],{"type":26,"value":9320}," p.Key ",{"type":21,"tag":206,"props":9322,"children":9323},{"style":213},[9324],{"type":26,"value":9325},">=",{"type":21,"tag":206,"props":9327,"children":9328},{"style":225},[9329],{"type":26,"value":9330}," hash);\n",{"type":21,"tag":206,"props":9332,"children":9333},{"class":208,"line":7380},[9334,9338,9343,9348,9352,9357,9361,9366,9370,9374,9378,9382,9387,9392,9396,9401,9406,9411],{"type":21,"tag":206,"props":9335,"children":9336},{"style":213},[9337],{"type":26,"value":6967},{"type":21,"tag":206,"props":9339,"children":9340},{"style":225},[9341],{"type":26,"value":9342}," kv.",{"type":21,"tag":206,"props":9344,"children":9345},{"style":219},[9346],{"type":26,"value":9347},"Equals",{"type":21,"tag":206,"props":9349,"children":9350},{"style":225},[9351],{"type":26,"value":792},{"type":21,"tag":206,"props":9353,"children":9354},{"style":213},[9355],{"type":26,"value":9356},"default",{"type":21,"tag":206,"props":9358,"children":9359},{"style":225},[9360],{"type":26,"value":792},{"type":21,"tag":206,"props":9362,"children":9363},{"style":6505},[9364],{"type":26,"value":9365},"KeyValuePair",{"type":21,"tag":206,"props":9367,"children":9368},{"style":225},[9369],{"type":26,"value":7317},{"type":21,"tag":206,"props":9371,"children":9372},{"style":213},[9373],{"type":26,"value":6891},{"type":21,"tag":206,"props":9375,"children":9376},{"style":225},[9377],{"type":26,"value":6725},{"type":21,"tag":206,"props":9379,"children":9380},{"style":6505},[9381],{"type":26,"value":8499},{"type":21,"tag":206,"props":9383,"children":9384},{"style":225},[9385],{"type":26,"value":9386},">)) ",{"type":21,"tag":206,"props":9388,"children":9389},{"style":213},[9390],{"type":26,"value":9391},"?",{"type":21,"tag":206,"props":9393,"children":9394},{"style":225},[9395],{"type":26,"value":9297},{"type":21,"tag":206,"props":9397,"children":9398},{"style":219},[9399],{"type":26,"value":9400},"First",{"type":21,"tag":206,"props":9402,"children":9403},{"style":225},[9404],{"type":26,"value":9405},"().Value ",{"type":21,"tag":206,"props":9407,"children":9408},{"style":213},[9409],{"type":26,"value":9410},":",{"type":21,"tag":206,"props":9412,"children":9413},{"style":225},[9414],{"type":26,"value":9415}," kv.Value;\n",{"type":21,"tag":206,"props":9417,"children":9418},{"class":208,"line":7388},[9419],{"type":21,"tag":206,"props":9420,"children":9421},{"style":225},[9422],{"type":26,"value":7009},{"type":21,"tag":206,"props":9424,"children":9425},{"class":208,"line":7397},[9426],{"type":21,"tag":206,"props":9427,"children":9428},{"emptyLinePlaceholder":5},[9429],{"type":26,"value":6556},{"type":21,"tag":206,"props":9431,"children":9432},{"class":208,"line":7428},[9433,9437,9441,9445,9449,9453,9458],{"type":21,"tag":206,"props":9434,"children":9435},{"style":213},[9436],{"type":26,"value":8519},{"type":21,"tag":206,"props":9438,"children":9439},{"style":213},[9440],{"type":26,"value":8583},{"type":21,"tag":206,"props":9442,"children":9443},{"style":219},[9444],{"type":26,"value":8902},{"type":21,"tag":206,"props":9446,"children":9447},{"style":225},[9448],{"type":26,"value":792},{"type":21,"tag":206,"props":9450,"children":9451},{"style":213},[9452],{"type":26,"value":6647},{"type":21,"tag":206,"props":9454,"children":9455},{"style":6567},[9456],{"type":26,"value":9457}," input",{"type":21,"tag":206,"props":9459,"children":9460},{"style":225},[9461],{"type":26,"value":598},{"type":21,"tag":206,"props":9463,"children":9464},{"class":208,"line":7437},[9465],{"type":21,"tag":206,"props":9466,"children":9467},{"style":225},[9468],{"type":26,"value":6958},{"type":21,"tag":206,"props":9470,"children":9471},{"class":208,"line":7446},[9472,9476,9481,9485,9490,9495,9500,9505],{"type":21,"tag":206,"props":9473,"children":9474},{"style":6400},[9475],{"type":26,"value":9259},{"type":21,"tag":206,"props":9477,"children":9478},{"style":6567},[9479],{"type":26,"value":9480}," bytes",{"type":21,"tag":206,"props":9482,"children":9483},{"style":213},[9484],{"type":26,"value":6575},{"type":21,"tag":206,"props":9486,"children":9487},{"style":225},[9488],{"type":26,"value":9489}," _md5.",{"type":21,"tag":206,"props":9491,"children":9492},{"style":219},[9493],{"type":26,"value":9494},"ComputeHash",{"type":21,"tag":206,"props":9496,"children":9497},{"style":225},[9498],{"type":26,"value":9499},"(Encoding.UTF8.",{"type":21,"tag":206,"props":9501,"children":9502},{"style":219},[9503],{"type":26,"value":9504},"GetBytes",{"type":21,"tag":206,"props":9506,"children":9507},{"style":225},[9508],{"type":26,"value":9509},"(input));\n",{"type":21,"tag":206,"props":9511,"children":9512},{"class":208,"line":7493},[9513,9517,9522,9527,9532,9536,9540,9545,9550,9555],{"type":21,"tag":206,"props":9514,"children":9515},{"style":213},[9516],{"type":26,"value":6967},{"type":21,"tag":206,"props":9518,"children":9519},{"style":225},[9520],{"type":26,"value":9521}," BitConverter.",{"type":21,"tag":206,"props":9523,"children":9524},{"style":219},[9525],{"type":26,"value":9526},"ToInt32",{"type":21,"tag":206,"props":9528,"children":9529},{"style":225},[9530],{"type":26,"value":9531},"(bytes, ",{"type":21,"tag":206,"props":9533,"children":9534},{"style":3505},[9535],{"type":26,"value":3361},{"type":21,"tag":206,"props":9537,"children":9538},{"style":225},[9539],{"type":26,"value":6349},{"type":21,"tag":206,"props":9541,"children":9542},{"style":213},[9543],{"type":26,"value":9544},"&",{"type":21,"tag":206,"props":9546,"children":9547},{"style":3505},[9548],{"type":26,"value":9549}," 0x7FFFFFFF",{"type":21,"tag":206,"props":9551,"children":9552},{"style":225},[9553],{"type":26,"value":9554},"; ",{"type":21,"tag":206,"props":9556,"children":9557},{"style":231},[9558],{"type":26,"value":9559},"// positive int\n",{"type":21,"tag":206,"props":9561,"children":9562},{"class":208,"line":7502},[9563],{"type":21,"tag":206,"props":9564,"children":9565},{"style":225},[9566],{"type":26,"value":7009},{"type":21,"tag":206,"props":9568,"children":9569},{"class":208,"line":7557},[9570],{"type":21,"tag":206,"props":9571,"children":9572},{"style":225},[9573],{"type":26,"value":3562},{"type":21,"tag":9575,"props":9576,"children":9577},"style",{},[9578],{"type":26,"value":9579},"html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"type":21,"tag":9575,"props":9581,"children":9582},{},[9583],{"type":26,"value":9584},"\nmjx-container[jax=\"SVG\"] {\n  direction: ltr;\n}\n\nmjx-container[jax=\"SVG\"] > svg {\n  overflow: visible;\n  min-height: 1px;\n  min-width: 1px;\n}\n\nmjx-container[jax=\"SVG\"] > svg a {\n  fill: blue;\n  stroke: blue;\n}\n\nmjx-container[jax=\"SVG\"][display=\"true\"] {\n  display: block;\n  text-align: center;\n  margin: 1em 0;\n}\n\nmjx-container[jax=\"SVG\"][display=\"true\"][width=\"full\"] {\n  display: flex;\n}\n\nmjx-container[jax=\"SVG\"][justify=\"left\"] {\n  text-align: left;\n}\n\nmjx-container[jax=\"SVG\"][justify=\"right\"] {\n  text-align: right;\n}\n\ng[data-mml-node=\"merror\"] > g {\n  fill: red;\n  stroke: red;\n}\n\ng[data-mml-node=\"merror\"] > rect[data-background] {\n  fill: yellow;\n  stroke: none;\n}\n\ng[data-mml-node=\"mtable\"] > line[data-line], svg[data-table] > g > line[data-line] {\n  stroke-width: 70px;\n  fill: none;\n}\n\ng[data-mml-node=\"mtable\"] > rect[data-frame], svg[data-table] > g > rect[data-frame] {\n  stroke-width: 70px;\n  fill: none;\n}\n\ng[data-mml-node=\"mtable\"] > .mjx-dashed, svg[data-table] > g > .mjx-dashed {\n  stroke-dasharray: 140;\n}\n\ng[data-mml-node=\"mtable\"] > .mjx-dotted, svg[data-table] > g > .mjx-dotted {\n  stroke-linecap: round;\n  stroke-dasharray: 0,140;\n}\n\ng[data-mml-node=\"mtable\"] > g > svg {\n  overflow: visible;\n}\n\n[jax=\"SVG\"] mjx-tool {\n  display: inline-block;\n  position: relative;\n  width: 0;\n  height: 0;\n}\n\n[jax=\"SVG\"] mjx-tool > mjx-tip {\n  position: absolute;\n  top: 0;\n  left: 0;\n}\n\nmjx-tool > mjx-tip {\n  display: inline-block;\n  padding: .2em;\n  border: 1px solid #888;\n  font-size: 70%;\n  background-color: #F8F8F8;\n  color: black;\n  box-shadow: 2px 2px 5px #AAAAAA;\n}\n\ng[data-mml-node=\"maction\"][data-toggle] {\n  cursor: pointer;\n}\n\nmjx-status {\n  display: block;\n  position: fixed;\n  left: 1em;\n  bottom: 1em;\n  min-width: 25%;\n  padding: .2em .4em;\n  border: 1px solid #888;\n  font-size: 90%;\n  background-color: #F8F8F8;\n  color: black;\n}\n\nforeignObject[data-mjx-xml] {\n  font-family: initial;\n  line-height: normal;\n  overflow: visible;\n}\n\nmjx-container[jax=\"SVG\"] path[data-c], mjx-container[jax=\"SVG\"] use[data-c] {\n  stroke-width: 3;\n}\n",{"title":13,"searchDepth":237,"depth":237,"links":9586},[9587,9588,9589,9590,9591,9592,9593,9594,9595,9596,9597,9602,9603,9607,9608,9609,9610,9611,9625,9629],{"id":86,"depth":237,"text":89},{"id":183,"depth":237,"text":183},{"id":339,"depth":237,"text":342},{"id":426,"depth":237,"text":429},{"id":445,"depth":237,"text":448},{"id":544,"depth":237,"text":547},{"id":1167,"depth":237,"text":1170},{"id":1229,"depth":237,"text":1232},{"id":1450,"depth":237,"text":1453},{"id":1660,"depth":237,"text":1663},{"id":2131,"depth":237,"text":2134,"children":9598},[9599,9600,9601],{"id":3276,"depth":3516,"text":3279},{"id":3591,"depth":3516,"text":3594},{"id":3613,"depth":3516,"text":3616},{"id":4150,"depth":237,"text":4153},{"id":5085,"depth":237,"text":5094,"children":9604},[9605],{"id":5097,"depth":3516,"text":9606},"Session 3 階段內容，至此我們聚焦在分散式鍵值存儲系統中一致性與容錯挑戰",{"id":5226,"depth":237,"text":5235},{"id":5264,"depth":237,"text":5267},{"id":5456,"depth":237,"text":5459},{"id":5631,"depth":237,"text":5634},{"id":5810,"depth":237,"text":5813,"children":9612},[9613,9615,9617,9619,9621,9623],{"id":5823,"depth":3516,"text":9614},"1. 起點：分散式需求",{"id":5842,"depth":3516,"text":9616},"2. 基礎設計：資料分區與複製",{"id":5881,"depth":3516,"text":9618},"3. 衍生挑戰：一致性問題",{"id":5910,"depth":3516,"text":9620},"4. 解決方案：一致性與衝突處理",{"id":5943,"depth":3516,"text":9622},"5. 進階挑戰：節點故障",{"id":5987,"depth":3516,"text":9624},"6. 最終實現：完整系統架構",{"id":6041,"depth":237,"text":6044,"children":9626},[9627,9628],{"id":6265,"depth":3516,"text":6268},{"id":7899,"depth":3516,"text":7902},{"id":8428,"depth":237,"text":8428,"children":9630},[9631],{"id":8433,"depth":3516,"text":8436},"markdown","content:7.sdi-aig:6.chapter6.md","content","7.sdi-aig/6.chapter6.md","md",["ShallowRef",9638],["ShallowReactive",9639],{"/sdi-aig/chapter6":9640},[9641,9648],{"_path":9642,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":9643,"description":9644,"pageTitle":9645,"_type":9632,"_id":9646,"_source":9634,"_file":9647,"_extension":9636},"/sdi-aig/chapter4","設計網路限速器","ref:https://github.com/Admol/SystemDesign/blob/main/CHAPTER 04：DESIGN A RATE LIMITER.md","Chapter 4 設計網路限速器","content:7.sdi-aig:4.chapter4.md","7.sdi-aig/4.chapter4.md",null,["ShallowRef",9650],{},[9652,9666,9689,9703,9735,9755,9835],{"title":9653,"_path":9654,"children":9655,"icon":9665},"API","/api",[9656,9659,9662],{"title":9657,"_path":9658},"Components","/api/components",{"title":9660,"_path":9661},"Composables","/api/composables",{"title":9663,"_path":9664},"Layouts","/api/layouts","🛡️",{"title":9667,"_path":9668,"children":9669,"icon":9688},"技術分享","/workshop",[9670,9673,9676,9679,9682,9685],{"title":9671,"_path":9672},"使用Gitlab做CI/CD","/workshop/gitlab-cicd",{"title":9674,"_path":9675},"gRPC快速入門","/workshop/grpc",{"title":9677,"_path":9678},"Liquibase快速入門","/workshop/liquibase",{"title":9680,"_path":9681},"Redis Ring","/workshop/redis-ring",{"title":9683,"_path":9684},"Redis快速入門","/workshop/redis",{"title":9686,"_path":9687},"TDD技術分享 - Part1 灌輸","/workshop/tdd_part1","⚒️",{"title":9690,"_path":9691,"children":9692,"icon":9702},"Web API的設計與開發","/web-api",[9693,9696,9699],{"title":9694,"_path":9695},"第2章 EndPoint設計與請求形式","/web-api/chapter2",{"title":9697,"_path":9698},"第5章 開發方便更改設計的API","/web-api/chapter5",{"title":9700,"_path":9701},"第6章 開發牢固的WebAPI","/web-api/chapter6","📗",{"title":9704,"_path":9705,"children":9706,"icon":9734},"持續交付2.0：實務導向的DevOps","/cicd-2.0",[9707,9710,9713,9716,9719,9722,9725,9728,9731],{"title":9708,"_path":9709},"05 持續交付的軟體系統架構","/cicd-2.0/chapter5",{"title":9711,"_path":9712},"07 部署流水線原則與工具設計","/cicd-2.0/chapter7",{"title":9714,"_path":9715},"08 利於集成的分支策略","/cicd-2.0/chapter8",{"title":9717,"_path":9718},"09 持續整合","/cicd-2.0/chapter9",{"title":9720,"_path":9721},"10 自動化測試策略與方法","/cicd-2.0/chapter10",{"title":9723,"_path":9724},"11 軟件配置管理","/cicd-2.0/chapter11",{"title":9726,"_path":9727},"12 低風險發佈","/cicd-2.0/chapter12",{"title":9729,"_path":9730},"13 監測與決策","/cicd-2.0/chapter13",{"title":9732,"_path":9733},"16 研發推動的DevOps","/cicd-2.0/chapter16","🏷️",{"title":9736,"_path":9737,"children":9738,"icon":9754},"資料密集型應用系統設計","/ddia",[9739,9742,9745,9748,9751],{"title":9740,"_path":9741},"01 可靠性、可伸縮性和可維護性","/ddia/chapter1",{"title":9743,"_path":9744},"03 數據儲存與檢索","/ddia/chapter3",{"title":9746,"_path":9747},"04 編碼與演化","/ddia/chapter4",{"title":9749,"_path":9750},"05 複製","/ddia/chapter5",{"title":9752,"_path":9753},"09 一致性與共識","/ddia/chapter9","📕",{"title":9756,"_path":9757,"children":9758,"icon":9834},"Clean Architecture - 無瑕的程式碼","/clean-arch",[9759,9762,9765,9768,9771,9774,9777,9780,9783,9786,9789,9792,9795,9798,9801,9804,9807,9810,9813,9816,9819,9822,9825,9828,9831],{"title":9760,"_path":9761},"01 什麼是設計與結構","/clean-arch/chapter1",{"title":9763,"_path":9764},"02 兩種價值觀的故事","/clean-arch/chapter2",{"title":9766,"_path":9767},"03 範式概述","/clean-arch/chapter3",{"title":9769,"_path":9770},"04 結構化程式設計","/clean-arch/chapter4",{"title":9772,"_path":9773},"05 物件導向程式設計","/clean-arch/chapter5",{"title":9775,"_path":9776},"06 函數式程式設計","/clean-arch/chapter6",{"title":9778,"_path":9779},"12 元件","/clean-arch/chapter12",{"title":9781,"_path":9782},"13 元件內聚性","/clean-arch/chapter13",{"title":9784,"_path":9785},"14 元件耦合性","/clean-arch/chapter14",{"title":9787,"_path":9788},"15 什麼是架構","/clean-arch/chapter15",{"title":9790,"_path":9791},"16 獨立性","/clean-arch/chapter16",{"title":9793,"_path":9794},"18 邊界剖析","/clean-arch/chapter18",{"title":9796,"_path":9797},"19 POLICY AND LEVEL 策略與層次","/clean-arch/chapter19",{"title":9799,"_path":9800},"20 BUSINESS RULES 業務邏輯","/clean-arch/chapter20",{"title":9802,"_path":9803},"21 會尖叫的架構","/clean-arch/chapter21",{"title":9805,"_path":9806},"22 整潔的架構","/clean-arch/chapter22",{"title":9808,"_path":9809},"23 Presenter與Humble Object","/clean-arch/chapter23",{"title":9811,"_path":9812},"24 不完全邊界","/clean-arch/chapter24",{"title":9814,"_path":9815},"25 層與邊界","/clean-arch/chapter25",{"title":9817,"_path":9818},"30 資料庫細節","/clean-arch/chapter30",{"title":9820,"_path":9821},"31 WEB是細節","/clean-arch/chapter31",{"title":9823,"_path":9824},"32 框架也只是細節","/clean-arch/chapter32",{"title":9826,"_path":9827},"33 影片銷售系統案例研究","/clean-arch/chapter33",{"title":9829,"_path":9830},"Clean Architecture 第34章：The Missing Chapter","/clean-arch/chapter34",{"title":9832,"_path":9833},"99 來自於網路世界的書評","/clean-arch/chapter99","📘",{"title":9836,"_path":9837,"children":9838,"icon":9844},"System Design Interview: An Insider’s Guide","/sdi-aig",[9839,9842,9843],{"title":9840,"_path":9841},"01 從 0 到百萬用戶","/sdi-aig/chapter1",{"title":9643,"_path":9642},{"title":14,"_path":11},"📖",{"📖":-1,"📘":-1,"📕":-1,"🏷️":-1,"📗":-1,"⚒️":-1,"🛡️":-1,"heroicons-outline:menu":9846,"el:group":9849,"mdi:github":9852,"lucide:chevrons-up-down":9854,"uil:edit":9856,"heroicons-outline:arrow-sm-left":9858,"heroicons-outline:chevron-right":9860,"heroicons-outline:search":9862,"ph:copy":9864},{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9848},0,"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 6h16M4 12h16M4 18h16\"/>",{"left":9847,"top":9847,"width":9850,"height":9850,"rotate":9847,"vFlip":6,"hFlip":6,"body":9851},1200,"\u003Cpath fill=\"currentColor\" d=\"M596.847 188.488c-103.344 0-187.12 97.81-187.12 218.465c0 83.678 40.296 156.352 99.468 193.047l-68.617 31.801l-182.599 84.688c-17.64 8.821-26.444 23.778-26.444 44.947v201.102c1.451 25.143 16.537 48.577 40.996 48.974h649.62c27.924-2.428 42.05-24.92 42.325-48.974V761.436c0-21.169-8.804-36.126-26.443-44.947l-175.988-84.688l-73.138-34.65c56.744-37.521 95.061-108.624 95.061-190.197c-.001-120.656-83.778-218.466-187.121-218.466m-301.824 76.824c-44.473 1.689-79.719 20.933-106.497 51.596c-29.62 36.918-44.06 80.75-44.339 124.354c1.819 64.478 30.669 125.518 82.029 157.446L21.163 693.997C7.05 699.289 0 711.636 0 731.041v161.398c1.102 21.405 12.216 39.395 33.055 39.703h136.284V761.436c2.255-45.639 23.687-82.529 62.196-100.531l136.247-64.817c10.584-6.175 20.731-14.568 30.433-25.152c-56.176-86.676-63.977-190.491-27.773-281.801c-23.547-14.411-50.01-23.672-75.419-23.823m608.586 0c-29.083.609-55.96 11.319-78.039 26.444c35.217 92.137 25.503 196.016-26.482 276.52c11.467 13.23 23.404 23.377 35.753 30.434l130.965 62.195c39.897 21.881 60.47 59.098 60.866 100.532v170.707h140.235c23.063-1.991 32.893-20.387 33.093-39.704V731.042c0-17.641-7.05-29.987-21.163-37.045l-202.431-96.618c52.498-38.708 78.859-96.72 79.369-156.117c-1.396-47.012-15.757-90.664-44.339-124.354c-29.866-32.399-66.91-51.253-107.827-51.596\"/>",{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9853},"\u003Cpath fill=\"currentColor\" d=\"M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2\"/>",{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9855},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m7 15l5 5l5-5M7 9l5-5l5 5\"/>",{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9857},"\u003Cpath fill=\"currentColor\" d=\"M21 12a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H5a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1m-15 .76V17a1 1 0 0 0 1 1h4.24a1 1 0 0 0 .71-.29l6.92-6.93L21.71 8a1 1 0 0 0 0-1.42l-4.24-4.29a1 1 0 0 0-1.42 0l-2.82 2.83l-6.94 6.93a1 1 0 0 0-.29.71m10.76-8.35l2.83 2.83l-1.42 1.42l-2.83-2.83ZM8 13.17l5.93-5.93l2.83 2.83L10.83 16H8Z\"/>",{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9859},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m11 17l-5-5m0 0l5-5m-5 5h12\"/>",{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9861},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m9 5l7 7l-7 7\"/>",{"left":9847,"top":9847,"width":7095,"height":7095,"rotate":9847,"vFlip":6,"hFlip":6,"body":9863},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m21 21l-6-6m2-5a7 7 0 1 1-14 0a7 7 0 0 1 14 0\"/>",{"left":9847,"top":9847,"width":9865,"height":9865,"rotate":9847,"vFlip":6,"hFlip":6,"body":9866},256,"\u003Cpath fill=\"currentColor\" d=\"M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z\"/>",{"parentPath":9837,"scrollTop":9847},{},{},{},{},{},{},{},{},["Reactive",9877],{"search-api":9648},1755170660808]</script>
<script>window.__NUXT__={};window.__NUXT__.config={public:{baseURL:"/code-study",mdc:{components:{prose:true,map:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}},content:{locales:[],defaultLocale:"",integrity:1755170623091,experimental:{stripQueryParameters:false,advanceQuery:false,clientDB:false},respectPathCase:false,api:{baseURL:"/api/_content"},navigation:{fields:["icon","titleTemplate","header","main","aside","footer","layout"]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:{theme:{dark:"github-dark",default:"github-light",sepia:"monokai"},preload:["c","cpp","java","bash","xml","powershell","csharp","c#","go","kotlin","proto","sh","shell","zsh","graphql","groovy","json","js","ts","html","css","vue","diff","shell","markdown","yaml","bash","ini"]},wsUrl:"",documentDriven:{page:true,navigation:true,surround:true,globals:{},layoutFallbacks:["theme"],injectPage:true},host:"",trailingSlash:false,search:"",contentHead:true,anchorLinks:{depth:4,exclude:[1]}},studio:{apiURL:"https://api.nuxt.studio"}},app:{baseURL:"/code-study",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body>
</html>