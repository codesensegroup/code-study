<!DOCTYPE html><html  lang="en"><head><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script type="importmap">{"imports":{"#entry":"/code-study/_nuxt/ko5jF9Y4.js"}}</script>
<title>09 一致性與共識 · 摳Sense讀書會筆記</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css" integrity="sha384-nB0miv6/jRmo5UMMR1wu3Gz6NLsoTkbqJghGIsx//Rlm+ZU03BU6SQNC66uf4l5+" crossorigin="anonymous">
<link rel="stylesheet" href="/code-study/_nuxt/entry.BaZfWR0X.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/DocumentDrivenNotFound.CH12xUgv.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ButtonLink.CiHQPHFO.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/default.BxSkjkFi.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseCodeInline.D2HJFQ1V.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/Alert.CauIGjJl.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseA.CHHaMahR.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/DocsPrevNext.KK0Wl1GO.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/DocsToc.3wHDilVr.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/DocsTocLinks.B2G6lxVR.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseP.D6hPlGvL.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseH1.SK43DhZp.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseH2.BG86M9YX.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseOl.DjPfratS.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseLi.CPvn4_eJ.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseStrong.DzlBpK_d.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseH3._koEKAPK.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseUl.BSDK8kCD.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseImg.CJZNi3Gh.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProsePre.B_fgAJq0.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseCode.mwTQbX3I.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseHr.CpBphPj0.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseTable.CuPqIqJo.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseThead.CRoeMcLU.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseTr.I9ZwkyT-.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseTh.DmoeLdw1.css" crossorigin>
<link rel="stylesheet" href="/code-study/_nuxt/ProseTd.Bc0WDrR1.css" crossorigin>
<link rel="preload" as="fetch" crossorigin="anonymous" href="/code-study/ddia/chapter9/_payload.json?8cb8952e-8b29-4692-9461-5c70d236bedc">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/ko5jF9Y4.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BJ4Q8_ga.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/C6TvmlRA.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/5dLcJFMn.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/Dp8dPEIm.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/9P3INT99.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/k0enEmya.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BJQ9lrfB.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/CVqeu3Rq.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/Bhn6muSk.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DdtfIAH0.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/QgGg4LvU.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/D8QrgnA3.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/5RP-v-VL.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BR_Sw9bY.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/CY11XVj5.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/vyDeLAoW.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/D-711uwZ.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/C62fM8zs.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DS5fHMnS.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/a1Uh2cUi.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DE0Xt0-p.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BEPjY746.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DFEcEmNg.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/0TPDRSEL.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DO-mG5BM.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/C85jgjSv.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/Dg8wkmwO.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/CS5aIcNJ.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BzDQzfIq.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/D4ZPmCz8.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/C_LD2Rh4.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/Cou2muTE.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/CpHxhouX.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BPu6WoIR.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/5M0FIew6.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/BlzXUCxz.js">
<link rel="modulepreload" as="script" crossorigin href="/code-study/_nuxt/DiQ9qaOi.js">
<link rel="preload" as="fetch" fetchpriority="low" crossorigin="anonymous" href="/code-study/_nuxt/builds/meta/8cb8952e-8b29-4692-9461-5c70d236bedc.json">
<link rel="prefetch" as="style" crossorigin href="/code-study/_nuxt/page.VdPUBxEb.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/DKbjN6Ot.js">
<link rel="prefetch" as="style" crossorigin href="/code-study/_nuxt/useStudio.BIRZTPEK.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/BL6fkFjm.js">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/BH5fhO4q.js">
<link rel="prefetch" as="style" crossorigin href="/code-study/_nuxt/error-404.D8YodvPl.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/D6E8pPTb.js">
<link rel="prefetch" as="style" crossorigin href="/code-study/_nuxt/error-500.BOC1npTo.css">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/BD5fGnPI.js">
<link rel="prefetch" as="script" crossorigin href="/code-study/_nuxt/CKV1Bsxh.js">
<meta name="referrer" content="no-referrer-when-downgrade">
<meta name="twitter:card" content="summary_large_image">
<meta property="og:title" content="09 一致性與共識">
<meta name="description" content="The best place to start your documentation.">
<meta property="og:description" content="The best place to start your documentation.">
<meta property="og:image" content="https://user-images.githubusercontent.com/904724/185365452-87b7ca7b-6030-4813-a2db-5e65c785bf88.png">
<script type="module" src="/code-study/_nuxt/ko5jF9Y4.js" crossorigin></script><style id="pinceau-runtime-hydratable">@media{.phy[--]{--puid:9Rc_fR-v;}.pv-XtF7rb{padding-left:var(--elements-container-padding-mobile);padding-right:var(--elements-container-padding-mobile);}@media (min-width: 475px){.pv-XtF7rb{padding-left:var(--elements-container-padding-xs);padding-right:var(--elements-container-padding-xs);}}@media (min-width: 640px){.pv-XtF7rb{padding-left:var(--elements-container-padding-sm);padding-right:var(--elements-container-padding-sm);}}@media (min-width: 768px){.pv-XtF7rb{padding-left:var(--elements-container-padding-md);padding-right:var(--elements-container-padding-md);}}} </style><style id="pinceau-theme">@media { :root {--pinceau-mq: initial; --docus-search-results-highlight-color: white;--docus-search-results-window-maxHeight: 100%;--docus-search-results-window-maxWidth: 640px;--docus-search-results-window-marginTop: 0;--docus-search-input-borderStyle: solid;--docus-search-input-borderWidth: 1px;--docus-search-backdropFilter: blur(24px);--docus-loadingBar-gradientColorStop3: #0047e1;--docus-loadingBar-gradientColorStop2: #34cdfe;--docus-loadingBar-gradientColorStop1: #00dc82;--docus-loadingBar-height: 3px;--docus-readableLine: 78ch;--docus-footer-height: 145px;--docus-header-height: 64px;--prose-code-inline-padding: 0.2rem 0.375rem 0.2rem 0.375rem;--prose-code-block-backdropFilter: contrast(1);--prose-code-block-border-style: solid;--prose-code-block-border-width: 1px;--prose-tbody-tr-borderBottom-style: dashed;--prose-tbody-tr-borderBottom-width: 1px;--prose-th-textAlign: inherit;--prose-thead-borderBottom-style: solid;--prose-thead-borderBottom-width: 1px;--prose-thead-border-style: solid;--prose-thead-border-width: 0px;--prose-table-textAlign: start;--prose-hr-width: 1px;--prose-hr-style: solid;--prose-li-listStylePosition: outside;--prose-ol-li-markerColor: currentColor;--prose-ol-paddingInlineStart: 21px;--prose-ol-listStyleType: decimal;--prose-ul-li-markerColor: currentColor;--prose-ul-paddingInlineStart: 21px;--prose-ul-listStyleType: disc;--prose-blockquote-border-style: solid;--prose-blockquote-border-width: 4px;--prose-blockquote-quotes: '201C' '201D' '2018' '2019';--prose-blockquote-paddingInlineStart: 24px;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-hasCode-borderBottom: none;--prose-a-border-distance: 2px;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-border-style-hover: solid;--prose-a-border-style-static: dashed;--prose-a-border-width: 1px;--prose-a-color-static: inherit;--prose-a-textDecoration: none;--prose-h6-margin: 3rem 0 2rem;--prose-h5-margin: 3rem 0 2rem;--prose-h4-margin: 3rem 0 2rem;--prose-h3-margin: 3rem 0 2rem;--prose-h2-margin: 3rem 0 2rem;--prose-h1-margin: 0 0 2rem;--typography-lead-loose: 2;--typography-lead-relaxed: 1.625;--typography-lead-normal: 1.5;--typography-lead-snug: 1.375;--typography-lead-tight: 1.25;--typography-lead-none: 1;--typography-lead-10: 2.5rem;--typography-lead-9: 2.25rem;--typography-lead-8: 2rem;--typography-lead-7: 1.75rem;--typography-lead-6: 1.5rem;--typography-lead-5: 1.25rem;--typography-lead-4: 1rem;--typography-lead-3: .75rem;--typography-lead-2: .5rem;--typography-lead-1: .025rem;--typography-fontWeight-black: 900;--typography-fontWeight-extrabold: 800;--typography-fontWeight-bold: 700;--typography-fontWeight-semibold: 600;--typography-fontWeight-medium: 500;--typography-fontWeight-normal: 400;--typography-fontWeight-light: 300;--typography-fontWeight-extralight: 200;--typography-fontWeight-thin: 100;--typography-fontSize-9xl: 128px;--typography-fontSize-8xl: 96px;--typography-fontSize-7xl: 72px;--typography-fontSize-6xl: 60px;--typography-fontSize-5xl: 48px;--typography-fontSize-4xl: 36px;--typography-fontSize-3xl: 30px;--typography-fontSize-2xl: 24px;--typography-fontSize-xl: 20px;--typography-fontSize-lg: 18px;--typography-fontSize-base: 16px;--typography-fontSize-sm: 14px;--typography-fontSize-xs: 12px;--typography-letterSpacing-wide: 0.025em;--typography-letterSpacing-tight: -0.025em;--typography-verticalMargin-base: 24px;--typography-verticalMargin-sm: 16px;--elements-border-secondary-hover: [object Object];--elements-backdrop-background: #fffc;--elements-backdrop-filter: saturate(200%) blur(20px);--elements-container-maxWidth: 80rem;--lead-loose: 2;--lead-relaxed: 1.625;--lead-normal: 1.5;--lead-snug: 1.375;--lead-tight: 1.25;--lead-none: 1;--lead-10: 2.5rem;--lead-9: 2.25rem;--lead-8: 2rem;--lead-7: 1.75rem;--lead-6: 1.5rem;--lead-5: 1.25rem;--lead-4: 1rem;--lead-3: .75rem;--lead-2: .5rem;--lead-1: .025rem;--letterSpacing-widest: 0.1em;--letterSpacing-wider: 0.05em;--letterSpacing-wide: 0.025em;--letterSpacing-normal: 0em;--letterSpacing-tight: -0.025em;--letterSpacing-tighter: -0.05em;--fontSize-9xl: 8rem;--fontSize-8xl: 6rem;--fontSize-7xl: 4.5rem;--fontSize-6xl: 3.75rem;--fontSize-5xl: 3rem;--fontSize-4xl: 2.25rem;--fontSize-3xl: 1.875rem;--fontSize-2xl: 1.5rem;--fontSize-xl: 1.25rem;--fontSize-lg: 1.125rem;--fontSize-base: 1rem;--fontSize-sm: 0.875rem;--fontSize-xs: 0.75rem;--fontWeight-black: 900;--fontWeight-extrabold: 800;--fontWeight-bold: 700;--fontWeight-semibold: 600;--fontWeight-medium: 500;--fontWeight-normal: 400;--fontWeight-light: 300;--fontWeight-extralight: 200;--fontWeight-thin: 100;--font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace;--font-serif: ui-serif, Georgia, Cambria, Times New Roman, Times, serif;--font-sans: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;--opacity-total: 1;--opacity-high: 0.8;--opacity-medium: 0.5;--opacity-soft: 0.3;--opacity-light: 0.15;--opacity-bright: 0.1;--opacity-noOpacity: 0;--borderWidth-lg: 3px;--borderWidth-md: 2px;--borderWidth-sm: 1px;--borderWidth-noBorder: 0;--space-rem-875: 0.875rem;--space-rem-625: 0.625rem;--space-rem-375: 0.375rem;--space-rem-125: 0.125rem;--space-px: 1px;--space-128: 32rem;--space-96: 24rem;--space-80: 20rem;--space-72: 18rem;--space-64: 16rem;--space-60: 15rem;--space-56: 14rem;--space-52: 13rem;--space-48: 12rem;--space-44: 11rem;--space-40: 10rem;--space-36: 9rem;--space-32: 8rem;--space-28: 7rem;--space-24: 6rem;--space-20: 5rem;--space-16: 4rem;--space-14: 3.5rem;--space-12: 3rem;--space-11: 2.75rem;--space-10: 2.5rem;--space-9: 2.25rem;--space-8: 2rem;--space-7: 1.75rem;--space-6: 1.5rem;--space-5: 1.25rem;--space-4: 1rem;--space-3: 0.75rem;--space-2: 0.5rem;--space-1: 0.25rem;--space-0: 0px;--size-full: 100%;--size-7xl: 80rem;--size-6xl: 72rem;--size-5xl: 64rem;--size-4xl: 56rem;--size-3xl: 48rem;--size-2xl: 42rem;--size-xl: 36rem;--size-lg: 32rem;--size-md: 28rem;--size-sm: 24rem;--size-xs: 20rem;--size-200: 200px;--size-104: 104px;--size-80: 80px;--size-64: 64px;--size-56: 56px;--size-48: 48px;--size-40: 40px;--size-32: 32px;--size-24: 24px;--size-20: 20px;--size-16: 16px;--size-12: 12px;--size-8: 8px;--size-6: 6px;--size-4: 4px;--size-2: 2px;--size-0: 0px;--radii-full: 9999px;--radii-3xl: 1.75rem;--radii-2xl: 1.5rem;--radii-xl: 1rem;--radii-lg: 0.75rem;--radii-md: 0.5rem;--radii-sm: 0.375rem;--radii-xs: 0.25rem;--radii-2xs: 0.125rem;--radii-none: 0px;--shadow-none: 0px 0px 0px 0px transparent;--height-screen: 100vh;--width-screen: 100vw;--color-primary-900: #001A1F;--color-primary-800: #00232B;--color-primary-700: #024757;--color-primary-600: #09A0C1;--color-primary-500: #1AD6FF;--color-primary-400: #55E1FF;--color-primary-300: #82E3FF;--color-primary-200: #C5F2FF;--color-primary-100: #DCF7FF;--color-primary-50: #F1FCFF;--color-ruby-900: #380011;--color-ruby-800: #700021;--color-ruby-700: #a90032;--color-ruby-600: #e10043;--color-ruby-500: #ff1a5e;--color-ruby-400: #ff4079;--color-ruby-300: #ff6694;--color-ruby-200: #ff8dae;--color-ruby-100: #ffb3c9;--color-ruby-50: #ffd9e4;--color-pink-900: #380025;--color-pink-800: #70004b;--color-pink-700: #a90070;--color-pink-600: #e10095;--color-pink-500: #ff1ab2;--color-pink-400: #ff40bf;--color-pink-300: #ff66cc;--color-pink-200: #ff8dd8;--color-pink-100: #ffb3e5;--color-pink-50: #ffd9f2;--color-purple-900: #190038;--color-purple-800: #330070;--color-purple-700: #4c00a9;--color-purple-600: #6500e1;--color-purple-500: #811aff;--color-purple-400: #9640ff;--color-purple-300: #ab66ff;--color-purple-200: #c08dff;--color-purple-100: #d5b3ff;--color-purple-50: #ead9ff;--color-royalblue-900: #0b0531;--color-royalblue-800: #160a62;--color-royalblue-700: #211093;--color-royalblue-600: #2c15c4;--color-royalblue-500: #4127e8;--color-royalblue-400: #614bec;--color-royalblue-300: #806ff0;--color-royalblue-200: #a093f3;--color-royalblue-100: #c0b7f7;--color-royalblue-50: #dfdbfb;--color-indigoblue-900: #001238;--color-indigoblue-800: #002370;--color-indigoblue-700: #0035a9;--color-indigoblue-600: #0047e1;--color-indigoblue-500: #1a62ff;--color-indigoblue-400: #407cff;--color-indigoblue-300: #6696ff;--color-indigoblue-200: #8db0ff;--color-indigoblue-100: #b3cbff;--color-indigoblue-50: #d9e5ff;--color-blue-900: #00131D;--color-blue-800: #002235;--color-blue-700: #014267;--color-blue-600: #0069A6;--color-blue-500: #1AADFF;--color-blue-400: #64C7FF;--color-blue-300: #A1DDFF;--color-blue-200: #C6EAFF;--color-blue-100: #DFF3FF;--color-blue-50: #F2FAFF;--color-lightblue-900: #002e38;--color-lightblue-800: #005c70;--color-lightblue-700: #008aa9;--color-lightblue-600: #00b9e1;--color-lightblue-500: #1ad6ff;--color-lightblue-400: #40ddff;--color-lightblue-300: #66e4ff;--color-lightblue-200: #8deaff;--color-lightblue-100: #b3f1ff;--color-lightblue-50: #d9f8ff;--color-teal-900: #062a28;--color-teal-800: #0b544f;--color-teal-700: #117d77;--color-teal-600: #16a79e;--color-teal-500: #1cd1c6;--color-teal-400: #36e4da;--color-teal-300: #5fe9e1;--color-teal-200: #87efe9;--color-teal-100: #aff4f0;--color-teal-50: #d7faf8;--color-pear-900: #2a2b09;--color-pear-800: #545512;--color-pear-700: #7e801b;--color-pear-600: #a8aa24;--color-pear-500: #d0d32f;--color-pear-400: #d8da52;--color-pear-300: #e0e274;--color-pear-200: #e8e997;--color-pear-100: #eff0ba;--color-pear-50: #f7f8dc;--color-red-900: #1C0301;--color-red-800: #340A01;--color-red-700: #701704;--color-red-600: #BB2402;--color-red-500: #FF3B10;--color-red-400: #FF7353;--color-red-300: #FFA692;--color-red-200: #FFDED7;--color-red-100: #FFF3F0;--color-red-50: #FFF9F8;--color-orange-900: #381800;--color-orange-800: #702f00;--color-orange-700: #a94700;--color-orange-600: #e15e00;--color-orange-500: #ff7a1a;--color-orange-400: #ff9040;--color-orange-300: #ffa666;--color-orange-200: #ffbd8d;--color-orange-100: #ffd3b3;--color-orange-50: #ffe9d9;--color-yellow-900: #1B1500;--color-yellow-800: #292100;--color-yellow-700: #614E02;--color-yellow-600: #CBA408;--color-yellow-500: #FBCA05;--color-yellow-400: #FFDC4E;--color-yellow-300: #FFE372;--color-yellow-200: #FFF0B1;--color-yellow-100: #FFF6D3;--color-yellow-50: #FFFCEE;--color-green-900: #00190F;--color-green-800: #002817;--color-green-700: #006037;--color-green-600: #00B467;--color-green-500: #0DD885;--color-green-400: #3CEEA5;--color-green-300: #86FBCB;--color-green-200: #C3FFE6;--color-green-100: #DEFFF1;--color-green-50: #ECFFF7;--color-gray-900: #121110;--color-gray-800: #201E1B;--color-gray-700: #36332E;--color-gray-600: #67635D;--color-gray-500: #97948F;--color-gray-400: #ADA9A4;--color-gray-300: #DBD9D3;--color-gray-200: #ECEBE8;--color-gray-100: #F6F5F4;--color-gray-50: #FBFBFB;--color-black: #0B0A0A;--color-white: #ffffff;--media-portrait: only screen and (orientation: portrait);--media-landscape: only screen and (orientation: landscape);--media-rm: (prefers-reduced-motion: reduce);--media-2xl: (min-width: 1536px);--media-xl: (min-width: 1280px);--media-lg: (min-width: 1024px);--media-md: (min-width: 768px);--media-sm: (min-width: 640px);--media-xs: (min-width: 475px);--docus-search-results-highlight-backgroundColor: var(--color-primary-500);--docus-search-results-selected-backgroundColor: var(--color-gray-300);--docus-search-results-window-borderRadius: none;--docus-search-results-window-marginX: 0;--docus-search-input-backgroundColor: var(--color-gray-200);--docus-search-input-padding: var(--space-2) var(--space-4);--docus-search-input-gap: var(--space-2);--docus-search-input-fontSize: var(--fontSize-sm);--docus-search-input-borderColor: var(--color-gray-200);--docus-search-input-borderRadius: var(--radii-2xs);--docus-footer-padding: var(--space-4) 0;--docus-header-title-color-hover: var(--color-primary-500);--docus-header-title-color-static: var(--color-gray-900);--docus-header-title-fontWeight: var(--fontWeight-bold);--docus-header-title-fontSize: var(--fontSize-2xl);--docus-header-logo-height: var(--space-6);--docus-body-fontFamily: var(--font-sans);--docus-body-color: var(--color-gray-800);--docus-body-backgroundColor: var(--color-white);--prose-code-inline-fontWeight: var(--typography-fontWeight-normal);--prose-code-inline-fontSize: var(--typography-fontSize-sm);--prose-code-inline-borderRadius: var(--radii-xs);--prose-code-block-pre-padding: var(--typography-verticalMargin-sm);--prose-code-block-margin: var(--typography-verticalMargin-base) 0;--prose-code-block-fontSize: var(--typography-fontSize-sm);--prose-tbody-code-inline-fontSize: var(--typography-fontSize-sm);--prose-tbody-td-padding: var(--typography-verticalMargin-sm);--prose-th-fontWeight: var(--typography-fontWeight-semibold);--prose-th-padding: 0 var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm) var(--typography-verticalMargin-sm);--prose-table-lineHeight: var(--typography-lead-6);--prose-table-fontSize: var(--typography-fontSize-sm);--prose-table-margin: var(--typography-verticalMargin-base) 0;--prose-hr-margin: var(--typography-verticalMargin-base) 0;--prose-li-margin: var(--typography-verticalMargin-sm) 0;--prose-ol-margin: var(--typography-verticalMargin-base) 0;--prose-ul-margin: var(--typography-verticalMargin-base) 0;--prose-blockquote-margin: var(--typography-verticalMargin-base) 0;--prose-a-code-border-style: var(--prose-a-border-style-static);--prose-a-code-border-width: var(--prose-a-border-width);--prose-a-fontWeight: var(--typography-fontWeight-medium);--prose-img-margin: var(--typography-verticalMargin-base) 0;--prose-strong-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-iconSize: var(--typography-fontSize-base);--prose-h6-fontWeight: var(--typography-fontWeight-semibold);--prose-h6-lineHeight: var(--typography-lead-normal);--prose-h6-fontSize: var(--typography-fontSize-lg);--prose-h5-iconSize: var(--typography-fontSize-lg);--prose-h5-fontWeight: var(--typography-fontWeight-semibold);--prose-h5-lineHeight: var(--typography-lead-snug);--prose-h5-fontSize: var(--typography-fontSize-xl);--prose-h4-iconSize: var(--typography-fontSize-lg);--prose-h4-letterSpacing: var(--typography-letterSpacing-tight);--prose-h4-fontWeight: var(--typography-fontWeight-semibold);--prose-h4-lineHeight: var(--typography-lead-snug);--prose-h4-fontSize: var(--typography-fontSize-2xl);--prose-h3-iconSize: var(--typography-fontSize-xl);--prose-h3-letterSpacing: var(--typography-letterSpacing-tight);--prose-h3-fontWeight: var(--typography-fontWeight-semibold);--prose-h3-lineHeight: var(--typography-lead-snug);--prose-h3-fontSize: var(--typography-fontSize-3xl);--prose-h2-iconSize: var(--typography-fontSize-2xl);--prose-h2-letterSpacing: var(--typography-letterSpacing-tight);--prose-h2-fontWeight: var(--typography-fontWeight-semibold);--prose-h2-lineHeight: var(--typography-lead-tight);--prose-h2-fontSize: var(--typography-fontSize-4xl);--prose-h1-iconSize: var(--typography-fontSize-3xl);--prose-h1-letterSpacing: var(--typography-letterSpacing-tight);--prose-h1-fontWeight: var(--typography-fontWeight-bold);--prose-h1-lineHeight: var(--typography-lead-tight);--prose-h1-fontSize: var(--typography-fontSize-5xl);--prose-p-br-margin: var(--typography-verticalMargin-base) 0 0 0;--prose-p-margin: var(--typography-verticalMargin-base) 0;--prose-p-lineHeight: var(--typography-lead-normal);--prose-p-fontSize: var(--typography-fontSize-base);--typography-color-secondary-900: var(--color-gray-900);--typography-color-secondary-800: var(--color-gray-800);--typography-color-secondary-700: var(--color-gray-700);--typography-color-secondary-600: var(--color-gray-600);--typography-color-secondary-500: var(--color-gray-500);--typography-color-secondary-400: var(--color-gray-400);--typography-color-secondary-300: var(--color-gray-300);--typography-color-secondary-200: var(--color-gray-200);--typography-color-secondary-100: var(--color-gray-100);--typography-color-secondary-50: var(--color-gray-50);--typography-color-primary-900: var(--color-primary-900);--typography-color-primary-800: var(--color-primary-800);--typography-color-primary-700: var(--color-primary-700);--typography-color-primary-600: var(--color-primary-600);--typography-color-primary-500: var(--color-primary-500);--typography-color-primary-400: var(--color-primary-400);--typography-color-primary-300: var(--color-primary-300);--typography-color-primary-200: var(--color-primary-200);--typography-color-primary-100: var(--color-primary-100);--typography-color-primary-50: var(--color-primary-50);--typography-font-code: var(--font-mono);--typography-font-body: var(--font-sans);--typography-font-display: var(--font-sans);--typography-body-backgroundColor: var(--color-white);--typography-body-color: var(--color-black);--elements-state-danger-borderColor-secondary: var(--color-red-200);--elements-state-danger-borderColor-primary: var(--color-red-100);--elements-state-danger-backgroundColor-secondary: var(--color-red-100);--elements-state-danger-backgroundColor-primary: var(--color-red-50);--elements-state-danger-color-secondary: var(--color-red-600);--elements-state-danger-color-primary: var(--color-red-500);--elements-state-warning-borderColor-secondary: var(--color-yellow-200);--elements-state-warning-borderColor-primary: var(--color-yellow-100);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-100);--elements-state-warning-backgroundColor-primary: var(--color-yellow-50);--elements-state-warning-color-secondary: var(--color-yellow-700);--elements-state-warning-color-primary: var(--color-yellow-600);--elements-state-success-borderColor-secondary: var(--color-green-200);--elements-state-success-borderColor-primary: var(--color-green-100);--elements-state-success-backgroundColor-secondary: var(--color-green-100);--elements-state-success-backgroundColor-primary: var(--color-green-50);--elements-state-success-color-secondary: var(--color-green-600);--elements-state-success-color-primary: var(--color-green-500);--elements-state-info-borderColor-secondary: var(--color-blue-200);--elements-state-info-borderColor-primary: var(--color-blue-100);--elements-state-info-backgroundColor-secondary: var(--color-blue-100);--elements-state-info-backgroundColor-primary: var(--color-blue-50);--elements-state-info-color-secondary: var(--color-blue-600);--elements-state-info-color-primary: var(--color-blue-500);--elements-state-primary-borderColor-secondary: var(--color-primary-200);--elements-state-primary-borderColor-primary: var(--color-primary-100);--elements-state-primary-backgroundColor-secondary: var(--color-primary-100);--elements-state-primary-backgroundColor-primary: var(--color-primary-50);--elements-state-primary-color-secondary: var(--color-primary-700);--elements-state-primary-color-primary: var(--color-primary-600);--elements-surface-secondary-backgroundColor: var(--color-gray-200);--elements-surface-primary-backgroundColor: var(--color-gray-100);--elements-surface-background-base: var(--color-gray-100);--elements-border-secondary-static: var(--color-gray-200);--elements-border-primary-hover: var(--color-gray-200);--elements-border-primary-static: var(--color-gray-100);--elements-container-padding-md: var(--space-6);--elements-container-padding-sm: var(--space-6);--elements-container-padding-xs: var(--space-4);--elements-container-padding-mobile: var(--space-4);--elements-text-secondary-color-hover: var(--color-gray-700);--elements-text-secondary-color-static: var(--color-gray-500);--elements-text-primary-color-static: var(--color-gray-900);--text-6xl-lineHeight: var(--lead-none);--text-6xl-fontSize: var(--fontSize-6xl);--text-5xl-lineHeight: var(--lead-none);--text-5xl-fontSize: var(--fontSize-5xl);--text-4xl-lineHeight: var(--lead-10);--text-4xl-fontSize: var(--fontSize-4xl);--text-3xl-lineHeight: var(--lead-9);--text-3xl-fontSize: var(--fontSize-3xl);--text-2xl-lineHeight: var(--lead-8);--text-2xl-fontSize: var(--fontSize-2xl);--text-xl-lineHeight: var(--lead-7);--text-xl-fontSize: var(--fontSize-xl);--text-lg-lineHeight: var(--lead-7);--text-lg-fontSize: var(--fontSize-lg);--text-base-lineHeight: var(--lead-6);--text-base-fontSize: var(--fontSize-base);--text-sm-lineHeight: var(--lead-5);--text-sm-fontSize: var(--fontSize-sm);--text-xs-lineHeight: var(--lead-4);--text-xs-fontSize: var(--fontSize-xs);--color-shadow: var(--color-gray-400);--color-secondary-900: var(--color-gray-900);--color-secondary-800: var(--color-gray-800);--color-secondary-700: var(--color-gray-700);--color-secondary-600: var(--color-gray-600);--color-secondary-500: var(--color-gray-500);--color-secondary-400: var(--color-gray-400);--color-secondary-300: var(--color-gray-300);--color-secondary-200: var(--color-gray-200);--color-secondary-100: var(--color-gray-100);--color-secondary-50: var(--color-gray-50);--prose-code-inline-backgroundColor: var(--typography-color-secondary-100);--prose-code-inline-color: var(--typography-color-secondary-700);--prose-code-block-backgroundColor: var(--typography-color-secondary-100);--prose-code-block-color: var(--typography-color-secondary-700);--prose-code-block-border-color: var(--typography-color-secondary-200);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-200);--prose-th-color: var(--typography-color-secondary-600);--prose-thead-borderBottom-color: var(--typography-color-secondary-200);--prose-thead-border-color: var(--typography-color-secondary-300);--prose-hr-color: var(--typography-color-secondary-200);--prose-blockquote-border-color: var(--typography-color-secondary-200);--prose-blockquote-color: var(--typography-color-secondary-500);--prose-a-code-background-hover: var(--typography-color-primary-50);--prose-a-code-border-color-hover: var(--typography-color-primary-500);--prose-a-code-border-color-static: var(--typography-color-secondary-400);--prose-a-color-hover: var(--typography-color-primary-500);--shadow-2xl: 0px 25px 50px -12px var(--color-shadow);--shadow-xl: 0px 20px 25px -5px var(--color-shadow), 0px 8px 10px -6px var(--color-shadow);--shadow-lg: 0px 10px 15px -3px var(--color-shadow), 0px 4px 6px -4px var(--color-shadow);--shadow-md: 0px 4px 6px -1px var(--color-shadow), 0px 2px 4px -2px var(--color-shadow);--shadow-sm: 0px 1px 3px 0px var(--color-shadow), 0px 1px 2px -1px var(--color-shadow);--shadow-xs: 0px 1px 2px 0px var(--color-shadow); } }@media { :root.dark {--pinceau-mq: dark; --prose-code-block-backdropFilter: contrast(1);--prose-ol-li-markerColor: currentColor;--prose-ul-li-markerColor: currentColor;--prose-a-code-color-hover: currentColor;--prose-a-code-color-static: currentColor;--prose-a-border-color-hover: currentColor;--prose-a-border-color-static: currentColor;--prose-a-color-static: inherit;--elements-backdrop-background: #0c0d0ccc;--docus-search-results-selected-backgroundColor: var(--color-gray-700);--docus-search-input-backgroundColor: var(--color-gray-800);--docus-search-input-borderColor: transparent;--docus-header-title-color-static: var(--color-gray-100);--docus-body-color: var(--color-gray-200);--docus-body-backgroundColor: var(--color-black);--typography-body-backgroundColor: var(--color-black);--typography-body-color: var(--color-white);--elements-state-danger-borderColor-secondary: var(--color-red-700);--elements-state-danger-borderColor-primary: var(--color-red-800);--elements-state-danger-backgroundColor-secondary: var(--color-red-800);--elements-state-danger-backgroundColor-primary: var(--color-red-900);--elements-state-danger-color-secondary: var(--color-red-200);--elements-state-danger-color-primary: var(--color-red-300);--elements-state-warning-borderColor-secondary: var(--color-yellow-700);--elements-state-warning-borderColor-primary: var(--color-yellow-800);--elements-state-warning-backgroundColor-secondary: var(--color-yellow-800);--elements-state-warning-backgroundColor-primary: var(--color-yellow-900);--elements-state-warning-color-secondary: var(--color-yellow-200);--elements-state-warning-color-primary: var(--color-yellow-400);--elements-state-success-borderColor-secondary: var(--color-green-700);--elements-state-success-borderColor-primary: var(--color-green-800);--elements-state-success-backgroundColor-secondary: var(--color-green-800);--elements-state-success-backgroundColor-primary: var(--color-green-900);--elements-state-success-color-secondary: var(--color-green-200);--elements-state-success-color-primary: var(--color-green-400);--elements-state-info-borderColor-secondary: var(--color-blue-700);--elements-state-info-borderColor-primary: var(--color-blue-800);--elements-state-info-backgroundColor-secondary: var(--color-blue-800);--elements-state-info-backgroundColor-primary: var(--color-blue-900);--elements-state-info-color-secondary: var(--color-blue-200);--elements-state-info-color-primary: var(--color-blue-400);--elements-state-primary-borderColor-secondary: var(--color-primary-700);--elements-state-primary-borderColor-primary: var(--color-primary-800);--elements-state-primary-backgroundColor-secondary: var(--color-primary-800);--elements-state-primary-backgroundColor-primary: var(--color-primary-900);--elements-state-primary-color-secondary: var(--color-primary-200);--elements-state-primary-color-primary: var(--color-primary-400);--elements-surface-secondary-backgroundColor: var(--color-gray-800);--elements-surface-primary-backgroundColor: var(--color-gray-900);--elements-surface-background-base: var(--color-gray-900);--elements-border-secondary-static: var(--color-gray-800);--elements-border-primary-hover: var(--color-gray-800);--elements-border-primary-static: var(--color-gray-900);--elements-text-secondary-color-hover: var(--color-gray-200);--elements-text-secondary-color-static: var(--color-gray-400);--elements-text-primary-color-static: var(--color-gray-50);--color-shadow: var(--color-gray-800);--prose-code-inline-backgroundColor: var(--typography-color-secondary-800);--prose-code-inline-color: var(--typography-color-secondary-200);--prose-code-block-backgroundColor: var(--typography-color-secondary-900);--prose-code-block-color: var(--typography-color-secondary-200);--prose-code-block-border-color: var(--typography-color-secondary-800);--prose-tbody-tr-borderBottom-color: var(--typography-color-secondary-800);--prose-th-color: var(--typography-color-secondary-400);--prose-thead-borderBottom-color: var(--typography-color-secondary-800);--prose-thead-border-color: var(--typography-color-secondary-600);--prose-hr-color: var(--typography-color-secondary-800);--prose-blockquote-border-color: var(--typography-color-secondary-700);--prose-blockquote-color: var(--typography-color-secondary-400);--prose-a-code-background-hover: var(--typography-color-primary-900);--prose-a-code-border-color-hover: var(--typography-color-primary-600);--prose-a-code-border-color-static: var(--typography-color-secondary-600);--prose-a-color-hover: var(--typography-color-primary-400); } }@media (min-width: 640px) { :root {--pinceau-mq: sm; --docus-search-results-window-maxHeight: 320px;--docus-search-results-window-marginTop: 20vh;--docus-footer-height: 100px;--docus-search-results-window-borderRadius: var(--radii-xs);--docus-search-results-window-marginX: var(--space-4);--docus-header-logo-height: var(--space-7); } }</style><script>"use strict";(()=>{const t=window,e=document.documentElement,c=["dark","light"],n=getStorageValue("localStorage","nuxt-color-mode")||"system";let i=n==="system"?u():n;const r=e.getAttribute("data-color-mode-forced");r&&(i=r),l(i),t["__NUXT_COLOR_MODE__"]={preference:n,value:i,getColorScheme:u,addColorScheme:l,removeColorScheme:d};function l(o){const s=""+o+"",a="theme";e.classList?e.classList.add(s):e.className+=" "+s,a&&e.setAttribute("data-"+a,o)}function d(o){const s=""+o+"",a="theme";e.classList?e.classList.remove(s):e.className=e.className.replace(new RegExp(s,"g"),""),a&&e.removeAttribute("data-"+a)}function f(o){return t.matchMedia("(prefers-color-scheme"+o+")")}function u(){if(t.matchMedia&&f("").media!=="not all"){for(const o of c)if(f(":"+o).matches)return o}return"light"}})();function getStorageValue(t,e){switch(t){case"localStorage":return window.localStorage.getItem(e);case"sessionStorage":return window.sessionStorage.getItem(e);case"cookie":return getCookie(e);default:return null}}function getCookie(t){const c=("; "+window.document.cookie).split("; "+t+"=");if(c.length===2)return c.pop()?.split(";").shift()}</script></head><body><!--teleport start anchor--><!----><!--teleport anchor--><!--teleport start anchor--><!----><!--teleport anchor--><div id="__nuxt"><div class="app-layout" data-v-5c2f7786><div class="nuxt-progress" style="width:0%;opacity:0;background-size:Infinity% auto;" data-v-5c2f7786></div><header class="has-dialog" data-v-5c2f7786 data-v-069d8056><div class="container pv-XtF7rb pc-9Rc_fR" data-v-069d8056 data-v-a8d7e2a7><!--[--><div class="section left" data-v-069d8056><!--[--><button aria-label="Menu" data-v-6c45508f><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" role="img" class="icon" data-v-6c45508f style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><!--teleport start--><!--teleport end--><!--]--><a href="/code-study/" class="navbar-logo" aria-label="摳Sense讀書會筆記" data-v-069d8056 data-v-f83b7764><span class="title" data-v-f83b7764>摳Sense讀書會筆記</span></a></div><div class="section center" data-v-069d8056><a href="/code-study/" class="navbar-logo" aria-label="摳Sense讀書會筆記" data-v-069d8056 data-v-f83b7764><span class="title" data-v-f83b7764>摳Sense讀書會筆記</span></a><!----></div><div class="section right" data-v-069d8056><!--[--><button type="button" aria-label="Search" data-v-d9f83610><span class="content" data-v-d9f83610><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-d9f83610 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m21 21l-6-6m2-5a7 7 0 1 1-14 0a7 7 0 0 1 14 0"/></svg><span data-v-d9f83610>Search</span><span data-v-d9f83610><kbd data-v-d9f83610>⌘</kbd><kbd data-v-d9f83610>K</kbd></span></span></button><!--teleport start--><!--teleport end--><!--]--><div class="social-icons" data-v-069d8056><a href="/code-study/member" class="" rel="noopener noreferrer" title="member" data-v-069d8056 data-v-959a58fc><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-959a58fc style="" width="1em" height="1em" viewBox="0 0 1200 1200" data-v-e610b8e3><path fill="currentColor" d="M596.847 188.488c-103.344 0-187.12 97.81-187.12 218.465c0 83.678 40.296 156.352 99.468 193.047l-68.617 31.801l-182.599 84.688c-17.64 8.821-26.444 23.778-26.444 44.947v201.102c1.451 25.143 16.537 48.577 40.996 48.974h649.62c27.924-2.428 42.05-24.92 42.325-48.974V761.436c0-21.169-8.804-36.126-26.443-44.947l-175.988-84.688l-73.138-34.65c56.744-37.521 95.061-108.624 95.061-190.197c-.001-120.656-83.778-218.466-187.121-218.466m-301.824 76.824c-44.473 1.689-79.719 20.933-106.497 51.596c-29.62 36.918-44.06 80.75-44.339 124.354c1.819 64.478 30.669 125.518 82.029 157.446L21.163 693.997C7.05 699.289 0 711.636 0 731.041v161.398c1.102 21.405 12.216 39.395 33.055 39.703h136.284V761.436c2.255-45.639 23.687-82.529 62.196-100.531l136.247-64.817c10.584-6.175 20.731-14.568 30.433-25.152c-56.176-86.676-63.977-190.491-27.773-281.801c-23.547-14.411-50.01-23.672-75.419-23.823m608.586 0c-29.083.609-55.96 11.319-78.039 26.444c35.217 92.137 25.503 196.016-26.482 276.52c11.467 13.23 23.404 23.377 35.753 30.434l130.965 62.195c39.897 21.881 60.47 59.098 60.866 100.532v170.707h140.235c23.063-1.991 32.893-20.387 33.093-39.704V731.042c0-17.641-7.05-29.987-21.163-37.045l-202.431-96.618c52.498-38.708 78.859-96.72 79.369-156.117c-1.396-47.012-15.757-90.664-44.339-124.354c-29.866-32.399-66.91-51.253-107.827-51.596"/></svg></a><a href="https://github.com/codesensegroup/code-study" rel="noopener noreferrer" target="_blank" title="github" data-v-069d8056 data-v-a02d16b5><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-a02d16b5 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="currentColor" d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2"/></svg></a></div><button aria-label="Color Mode" data-v-069d8056 data-v-87324333><span data-v-87324333>...</span></button></div><!--]--></div></header><main data-v-5c2f7786><!--[--><div class="document-driven-page"><div class="container pv-XtF7rb pc-3cRhXZ docs-page-content fluid has-toc has-aside" data-v-a6339876 data-v-a8d7e2a7><!--[--><aside class="aside-nav" data-v-a6339876><nav class="app-aside" data-v-a6339876 data-v-3d9a5d42><ul class="docs-aside-tree" data-v-3d9a5d42 data-v-d42239fd><!--[--><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📖</span><span data-v-d42239fd>System Design Interview: An Insider’s Guide</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>01 從 0 到百萬用戶</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter4" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>04 設計網路限速器</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter6" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>06 設計鍵值儲存系統</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter7" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>07 設計可用於分散式系統的唯一ID生成器</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter8" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>08 設計短網址生成器</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/sdi-aig/chapter9" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>09 設計網路爬蟲</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📘</span><span data-v-d42239fd>Clean Architecture - 無瑕的程式碼</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>01 什麼是設計與結構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter2" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>02 兩種價值觀的故事</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter3" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>03 範式概述</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter4" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>04 結構化程式設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>05 物件導向程式設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter6" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>06 函數式程式設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter12" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>12 元件</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter13" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>13 元件內聚性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter14" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>14 元件耦合性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter15" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>15 什麼是架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter16" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>16 獨立性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter18" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>18 邊界剖析</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter19" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>19 POLICY AND LEVEL 策略與層次</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter20" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>20 BUSINESS RULES 業務邏輯</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter21" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>21 會尖叫的架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter22" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>22 整潔的架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter23" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>23 Presenter與Humble Object</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter24" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>24 不完全邊界</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter25" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>25 層與邊界</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter30" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>30 資料庫細節</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter31" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>31 WEB是細節</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter32" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>32 框架也只是細節</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter33" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>33 影片銷售系統案例研究</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter34" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Clean Architecture 第34章：The Missing Chapter</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/clean-arch/chapter99" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>99 來自於網路世界的書評</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📕</span><span data-v-d42239fd>資料密集型應用系統設計</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>01 可靠性、可伸縮性和可維護性</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter3" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>03 數據儲存與檢索</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter4" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>04 編碼與演化</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/ddia/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>05 複製</span></span></a><!----></li><li class="has-parent-icon bordered active" data-v-d42239fd><a aria-current="page" href="/code-study/ddia/chapter9" class="router-link-active router-link-exact-active link padded active" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>09 一致性與共識</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>🏷️</span><span data-v-d42239fd>持續交付2.0：實務導向的DevOps</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>05 持續交付的軟體系統架構</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter7" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>07 部署流水線原則與工具設計</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter8" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>08 利於集成的分支策略</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter9" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>09 持續整合</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter10" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>10 自動化測試策略與方法</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter11" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>11 軟件配置管理</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter12" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>12 低風險發佈</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter13" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>13 監測與決策</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/cicd-2.0/chapter16" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>16 研發推動的DevOps</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>📗</span><span data-v-d42239fd>Web API的設計與開發</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/web-api/chapter2" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>第2章 EndPoint設計與請求形式</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/web-api/chapter5" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>第5章 開發方便更改設計的API</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/web-api/chapter6" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>第6章 開發牢固的WebAPI</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>⚒️</span><span data-v-d42239fd>技術分享</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/gitlab-cicd" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>使用Gitlab做CI/CD</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/grpc" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>gRPC快速入門</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/liquibase" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Liquibase快速入門</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/redis" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Redis快速入門</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/redis-ring" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Redis Ring</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/workshop/tdd_part1" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>TDD技術分享 - Part1 灌輸</span></span></a><!----></li><!--]--></ul></li><li class="" data-v-d42239fd><button class="title-collapsible-button" data-v-d42239fd><span class="content" data-v-d42239fd><span class="icon" style="font-size:1em;line-height:1em;width:1em;height:1em;" data-v-d42239fd data-v-e610b8e3>🛡️</span><span data-v-d42239fd>API</span></span><span data-v-d42239fd><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon collapsible-icon" data-v-d42239fd style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m7 15l5 5l5-5M7 9l5-5l5 5"/></svg></span></button><ul class="docs-aside-tree recursive" style="display:none;" data-v-d42239fd data-v-d42239fd><!--[--><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/api/components" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Components</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/api/composables" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Composables</span></span></a><!----></li><li class="has-parent-icon bordered" data-v-d42239fd><a href="/code-study/api/layouts" class="link padded" data-v-d42239fd><span class="content" data-v-d42239fd><!----><span data-v-d42239fd>Layouts</span></span></a><!----></li><!--]--></ul></li><!--]--></ul></nav></aside><article class="page-body" data-v-a6339876><div class="flex flex-col" data-v-a6339876><!----><div class="my-1"><span class="text-xs md:text-sm"> 字數總計：0 個 </span><span class="mx-1">|</span><span class="text-xs md:text-sm"> 閱讀時長：0 分鐘 </span><span class="mx-1">|</span><span class="text-xs md:text-sm" id="busuanzi_container_page_pv"><span>閱讀次數：</span><span id="busuanzi_value_page_pv"></span> 次 </span></div><div class="mt-1 z-10"><!--[--><!--]--></div></div><!--[--><!--[--><div><h1 id="設計資料密集型應用-ch9" data-v-2001208a><a href="#設計資料密集型應用-ch9" data-v-2001208a><!--[-->設計資料密集型應用-ch9<!--]--><!----></a></h1><h2 id="一致性與共識" data-v-70b0c1e2><a href="#一致性與共識" data-v-70b0c1e2><!--[-->一致性與共識<!--]--><!----></a></h2><h2 id="目錄" data-v-70b0c1e2><a href="#目錄" data-v-70b0c1e2><!--[-->目錄<!--]--><!----></a></h2><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->9.1 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%b8%80%e8%87%b4%e6%80%a7%e4%bf%9d%e8%ad%89" rel="nofollow" data-v-692834dd><!--[-->一致性保證<!--]--></a><!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->9.2 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7" rel="nofollow" data-v-692834dd><!--[-->線性一致性<!--]--></a><!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->9.3 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%a0%86%e5%ba%8f%e4%bf%9d%e8%ad%89" rel="nofollow" data-v-692834dd><!--[-->順序保證<!--]--></a><!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->9.4 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%88%86%e6%95%a3%e5%bc%8f%e4%ba%8b%e5%8b%99%e8%88%87%e5%85%b1%e8%ad%98" rel="nofollow" data-v-692834dd><!--[--><del>分散式事務與共識</del><!--]--></a><!--]--></strong><!--]--></li><li data-v-4c2f5fb9><!--[-->9.5 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%b5%90" rel="nofollow" data-v-692834dd><!--[--><del>本章小結</del><!--]--></a><!--]--></strong><!--]--></li><!--]--></ul><h2 id="_91-一致性保證" data-v-70b0c1e2><a href="#_91-一致性保證" data-v-70b0c1e2><!--[-->9.1 一致性保證<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->大多數複製的資料庫至少提供了最終一致性，這意味著如果你停止向資料庫寫入資料並等待一段不確定的時間，那麼最終所有的讀取請求都會返回相同的值。換句話說，不一致性是暫時的，最終會自行解決（假設網路中的任何故障最終都會被修復。<!--]--></p><p data-v-9dc9c102><!--[-->對於應用開發人員而言，最終一致性是很困難的，因為它與普通單執行緒程式中變數的行為有很大區別。如果將一個值賦給一個變數，然後很快地再次讀取，不可能讀到舊的值，或者讀取失敗。資料庫表面上看起來像一個你可以讀寫的變數，但實際上它有更複雜的語義。<!--]--></p><p data-v-9dc9c102><!--[-->我們在使用弱一致性的資料庫時必須了解弱一致性的局限性,因為錯誤常常很難找到也很難測試，因為應用可能在大多數情況下執行良好。當系統出現故障（例如網路中斷）或高併發時，最終一致性的邊緣情況才會顯現出來。<!--]--></p><div class="table-wrapper" data-v-78f198db><table data-v-78f198db><!--[--><thead data-v-81e7d1ab><!--[--><tr data-v-759aaa1b><!--[--><th data-v-40ddd69b><!--[--><!--]--></th><th data-v-40ddd69b><!--[-->強一致性<!--]--></th><th data-v-40ddd69b><!--[-->弱一致性<!--]--></th><!--]--></tr><!--]--></thead><tbody><!--[--><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->解釋<!--]--></td><td data-v-5f84e3ba><!--[-->強一至性表示，一旦一個操作（如寫入）完成，該操作的效果會立即反映在接下來所有的讀取操作上，無論這些讀取操作是從哪個節點發出的。<!--]--></td><td data-v-5f84e3ba><!--[-->在弱一至性模型下，寫入操作的效果可能不會立即反映在隨後的讀取操作中，特別是來自其他節點的讀取操作。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->例子<!--]--></td><td data-v-5f84e3ba><!--[-->假設你在銀行轉帳，當錢從一個帳戶轉到另一個帳戶後，不管是你自己還是其他任何人，只要查詢餘額，都會立即看到最新的數字。<!--]--></td><td data-v-5f84e3ba><!--[-->假設你更新了你的社交媒體狀態。你的朋友可能會在幾秒鐘後或幾分鐘後才看到這個更新，取決於各種因素（如網絡延遲、緩存等）。<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->模型<!--]--></td><td data-v-5f84e3ba><!--[-->線性一致性(linearizability)最強<!--]--></td><td data-v-5f84e3ba><!--[-->最終一致性(Eventual Consistency)<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->容錯性<!--]--></td><td data-v-5f84e3ba><!--[-->少<!--]--></td><td data-v-5f84e3ba><!--[-->高<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->所需資源<!--]--></td><td data-v-5f84e3ba><!--[-->高<!--]--></td><td data-v-5f84e3ba><!--[-->低<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->實踐<!--]--></td><td data-v-5f84e3ba><!--[-->易<!--]--></td><td data-v-5f84e3ba><!--[-->難<!--]--></td><!--]--></tr><!--]--></tbody><!--]--></table></div><h2 id="_92-線性一致性" data-v-70b0c1e2><a href="#_92-線性一致性" data-v-70b0c1e2><!--[-->9.2 線性一致性<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->在最終一致的資料庫，如果你在同一時刻問兩個不同副本相同的問題，可能會得到兩個不同的答案。這很讓人困惑。如果資料庫可以提供只有一個副本的假象（即，只有一個數據副本），那麼事情就簡單太多了。每個客戶端都會有相同的資料檢視，且不必擔心複製滯後了。<!--]--></p><p data-v-9dc9c102><!--[-->這種抽象的想法也稱為<strong data-v-84b57b07><!--[-->原子一致性（atomic consistency）<!--]--></strong>【7】，<strong data-v-84b57b07><!--[-->強一致性（strong consistency）<!--]--></strong>，<strong data-v-84b57b07><!--[-->立即一致性（immediate consistency）<!--]--></strong> 或 <strong data-v-84b57b07><!--[-->外部一致性（external consistency ）<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-1.png" alt="圖 9-1 這個系統是非線性一致的，導致了球迷的困惑" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-1 這個系統是非線性一致的，導致了球迷的困惑<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->描述：<!--]--></p><p data-v-9dc9c102><!--[-->計分員成功寫入德國獲勝到Leader<!--]--></p><p data-v-9dc9c102><!--[-->Leader開始寫入Foll1 Foll2<!--]--></p><p data-v-9dc9c102><!--[-->Alice用手機看到德國贏了然後Bob因為Leader寫入的時間差以為比賽還在進行<!--]--></p><h2 id="是什麼東西可以讓系統線性一致" data-v-70b0c1e2><a href="#是什麼東西可以讓系統線性一致" data-v-70b0c1e2><!--[-->是什麼東西可以讓系統線性一致**？**<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->真正的想法就是如何讓操作多個資料庫像在單一操作一個資料庫一樣<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-2.png" alt="圖 9-2 如果讀取請求與寫入請求併發，則可能會返回舊值或新值" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-2 如果讀取請求與寫入請求併發，則可能會返回舊值或新值<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->x稱為暫存器,可以是鍵或是資料庫的行或是資料庫的一個文件<!--]--></p><p data-v-9dc9c102><!--[-->描述：<!--]--></p><p data-v-9dc9c102><!--[-->A與B會在C寫入中產生不確定性<!--]--></p><h3 id="test" data-v-4cf5bb93><a href="#test" data-v-4cf5bb93><!--[-->test<!--]--><!----></a></h3><div class="highlight-go prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-go shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">package</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> main
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">import</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (
</span></span><span class="line" line="4"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">log</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="5"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">math/rand</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="6"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">sync</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="7"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">time</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="8"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">type</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> DB</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> struct</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="11"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    Value </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">int
</span></span><span class="line" line="12"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="13"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">type</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> Client</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> struct</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="14"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    Name </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">string
</span></span><span class="line" line="15"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    wg   </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">sync</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">WaitGroup
</span></span><span class="line" line="16"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">c </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Client</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Read</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">db</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> *</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">DB</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) {
</span></span><span class="line" line="19"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    defer</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> c.wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Done</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="20"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    for</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> i </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">; i </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">&lt;</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> 3</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">; i</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">++</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="21"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        time.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Sleep</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(time.Millisecond </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> time.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Duration</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(rand.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Intn</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">10</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)))
</span></span><span class="line" line="22"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Printf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">%s</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> x=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">%d</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> %v</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> \n</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, c.Name, db.Value, time.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Now</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">().</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">UnixMilli</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">())
</span></span><span class="line" line="23"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="24"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">c </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Client</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Write</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">db</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> *</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">DB</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">i</span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic"> int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) {
</span></span><span class="line" line="27"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    defer</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> c.wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Done</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="28"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    time.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Sleep</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(time.Millisecond </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> time.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Duration</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(rand.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Intn</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">10</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)))
</span></span><span class="line" line="29"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    db.Value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> i
</span></span><span class="line" line="30"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="31"><span emptylineplaceholder="true">
</span></span><span class="line" line="32"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> main</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">() {
</span></span><span class="line" line="33"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    rand.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Seed</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(time.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Now</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">().</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">UnixNano</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">())
</span></span><span class="line" line="34"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    wg </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> &amp;</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">sync</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">WaitGroup</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{}
</span></span><span class="line" line="35"><span emptylineplaceholder="true">
</span></span><span class="line" line="36"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Add</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">3</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="37"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    db </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> &amp;</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">DB</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{Value: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="38"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    clientA </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> &amp;</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Client</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{Name: </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;ClientA&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, wg: wg}
</span></span><span class="line" line="39"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    clientB </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> &amp;</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Client</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{Name: </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;ClientB&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, wg: wg}
</span></span><span class="line" line="40"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    clientC </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> &amp;</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Client</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{Name: </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;ClientC&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, wg: wg}
</span></span><span class="line" line="41"><span emptylineplaceholder="true">
</span></span><span class="line" line="42"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    go</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> clientA.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Read</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(db)
</span></span><span class="line" line="43"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    go</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> clientB.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Read</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(db)
</span></span><span class="line" line="44"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    go</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> clientC.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Write</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(db, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">1</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="45"><span emptylineplaceholder="true">
</span></span><span class="line" line="46"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Wait</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="47"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="48"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">/*
</span></span><span class="line" line="49"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/01 17:34:13 ClientA x=0 1693560853277 
</span></span><span class="line" line="50"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/01 17:34:13 ClientA x=0 1693560853278 
</span></span><span class="line" line="51"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/01 17:34:13 ClientB x=0 1693560853278 
</span></span><span class="line" line="52"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/01 17:34:13 ClientA x=0 1693560853283 
</span></span><span class="line" line="53"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/01 17:34:13 ClientB x=1 1693560853288 
</span></span><span class="line" line="54"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/01 17:34:13 ClientB x=1 1693560853298
</span></span><span class="line" line="55"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">*/
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><hr data-v-89dedb08><p data-v-9dc9c102><!--[-->為了使系統線性一致需要新增另外一個約束“只要有任何一個Client讀取x都必須返回最新值<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-3.png" alt="圖 9-3 任何一個讀取返回新值後，所有後續讀取（在相同或其他客戶端上）也必須返回新值。" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-3 任何一個讀取返回新值後，所有後續讀取（在相同或其他客戶端上）也必須返回新值。<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->描述：<!--]--></p><p data-v-9dc9c102><!--[-->這張圖是與上一個圖的比較,這張圖是最後想要達到的目標(線性一致)也就是我不管C到底在哪個時間點真正寫入,只要A已經讀到1的話,B永遠不能讀到其他值一定要是1<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-4.png" alt="圖 9-4 視覺化讀取和寫入看起來已經生效的時間點。 B 的最後讀取不是線性一致性的" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-4 視覺化讀取和寫入看起來已經生效的時間點。 B 的最後讀取不是線性一致性的<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->描述：<!--]--></p><p data-v-9dc9c102><!--[-->這邊想要描述如果write與cas混用會發生什麼問題<!--]--></p><p data-v-9dc9c102><!--[-->D最後出錯了原因是他一開始沒有用cas先比較資料庫原本有的內容是什麼等到他想用cas的時候發現cas(2,0,3) 2≠0 所以error,<!--]--></p><p data-v-9dc9c102><!--[-->C想用cas更新資料庫,而C最後一次的記憶體裡面x=2所以cas(2,2,4) 2=2所以x更新成4<!--]--></p><h3 id="第七章cascompare-and-swap的解釋-補全" data-v-4cf5bb93><a href="#第七章cascompare-and-swap的解釋-補全" data-v-4cf5bb93><!--[-->第七章CAS(Compare and Swap)的解釋 <del>*補全</del><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->第7章”事務”有提到<a href="https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e6%af%94%e8%bc%83%e4%b8%a6%e8%a8%ad%e5%ae%9a%ef%bc%88cas%ef%bc%89" rel="nofollow" data-v-692834dd><!--[-->CAS<!--]--></a>與ACID<!--]--></p><p data-v-9dc9c102><!--[-->cas(實例數值(內存數值),期望數值,更新數值)  = True or False<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>  participant T1
</span></span><span class="line" line="3"><span>  participant Memory
</span></span><span class="line" line="4"><span>  participant T2
</span></span><span class="line" line="5"><span>  Note over Memory: x=77
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span>    T2-&gt;&gt;Memory: 讀取數值 (Read x)
</span></span><span class="line" line="8"><span>  Memory-&gt;&gt;T2: 返回 77
</span></span><span class="line" line="9"><span>  T1-&gt;&gt;Memory: 讀取數值 (Read x)
</span></span><span class="line" line="10"><span>  Memory-&gt;&gt;T1: 返回 77
</span></span><span class="line" line="11"><span>    
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span>  Note over T1,T2: 開始競爭搶做cas更新
</span></span><span class="line" line="14"><span>    
</span></span><span class="line" line="15"><span>    Note over T1,Memory: T1先搶到開始做cas
</span></span><span class="line" line="16"><span>  T1-&gt;&gt;Memory: CAS(77, 77, 78) 
</span></span><span class="line" line="17"><span>  Note over Memory: 比較 77 == 77
</span></span><span class="line" line="18"><span>  Memory-&gt;&gt;T1: CAS成功，更新為78
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span>    Note over Memory: x=78
</span></span><span class="line" line="21"><span>  Note over Memory,T2: T2比T1晚一步做cas
</span></span><span class="line" line="22"><span>  T2-&gt;&gt;Memory: CAS(78, 77, 7788)
</span></span><span class="line" line="23"><span>  Note over Memory: 比較 78 != 77
</span></span><span class="line" line="24"><span>  Memory-&gt;&gt;T2: CAS失敗
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span>  Note over Memory: 最終數值為 x=78
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->*重點：<!--]--></p><p data-v-9dc9c102><!--[-->CAS只在乎寫，而初始值的讀取可以是刻意先去讀或者是曾經讀過<!--]--></p><p data-v-9dc9c102><!--[-->沒有先讀的cas不能比較<!--]--></p><h3 id="test-1" data-v-4cf5bb93><a href="#test-1" data-v-4cf5bb93><!--[-->test<!--]--><!----></a></h3><div class="highlight-go prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-go shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">type</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> CAS</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> struct</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="2"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    value </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">int
</span></span><span class="line" line="3"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="4"><span emptylineplaceholder="true">
</span></span><span class="line" line="5"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">c </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">CAS</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">CompareAndSwap</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">expected</span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic"> int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">newValue</span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic"> int</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">bool</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="6"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> c.value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">==</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> expected {
</span></span><span class="line" line="7"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        c.value </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> newValue
</span></span><span class="line" line="8"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        return</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> true
</span></span><span class="line" line="9"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="10"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    return</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> false
</span></span><span class="line" line="11"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->第7章說CAS是輕型事務所以用redis了解了一下事務<!--]--></p><p data-v-9dc9c102><!--[-->最後對於cas的理解就像是redis的watch會去監視某個key當某個key被併發寫入時就會發出錯誤停止事務<!--]--></p><div class="highlight-bash prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-bash shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">go</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">{</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> //A
</span></span><span class="line" line="2"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    WATCH</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> x
</span></span><span class="line" line="3"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    MULTI
</span></span><span class="line" line="4"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    SET</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> x</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> &quot;newValueFromA&quot;
</span></span><span class="line" line="5"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    EXEC
</span></span><span class="line" line="6"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">}</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="7"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">go</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">{</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> //B
</span></span><span class="line" line="8"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    WATCH</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> x
</span></span><span class="line" line="9"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    MULTI
</span></span><span class="line" line="10"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    SET</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> x</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> &quot;newValueFromB&quot;
</span></span><span class="line" line="11"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">    EXEC
</span></span><span class="line" line="12"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">}</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="13"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">/*
</span></span><span class="line" line="14"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">2023/09/04</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> 00:06:19</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> Goroutine</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> A</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> aborted:</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> redis:</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> transaction</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> failed
</span></span><span class="line" line="15"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">2023/09/04</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> 00:06:19</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> Goroutine</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> B</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> succeeded
</span></span><span class="line" line="16"><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">2023/09/04</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> 00:06:19</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> Final</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> value</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> of</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> x:</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74"> newValueFromB
</span></span><span class="line" line="17"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">*</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">/
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h3 id="test-2" data-v-4cf5bb93><a href="#test-2" data-v-4cf5bb93><!--[-->test<!--]--><!----></a></h3><div class="highlight-go prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-go shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">package</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> main
</span></span><span class="line" line="2"><span emptylineplaceholder="true">
</span></span><span class="line" line="3"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">import</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> (
</span></span><span class="line" line="4"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">context</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="5"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">log</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="6"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">sync</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">    &quot;</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74">github.com/go-redis/redis/v8</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;
</span></span><span class="line" line="9"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="10"><span emptylineplaceholder="true">
</span></span><span class="line" line="11"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E"> main</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">() {
</span></span><span class="line" line="12"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    var</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> ctx </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> context.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Background</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="13"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    rdb </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> redis.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">NewClient</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">&amp;</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">redis</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Options</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">{
</span></span><span class="line" line="14"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        Addr:     </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;localhost:6379&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">,
</span></span><span class="line" line="15"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        Password: </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;redis&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">,
</span></span><span class="line" line="16"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    })
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    var</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> wg </span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">sync</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">WaitGroup
</span></span><span class="line" line="19"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Add</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">2</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="20"><span emptylineplaceholder="true">
</span></span><span class="line" line="21"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    go</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">() { 
</span></span><span class="line" line="22"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        defer</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Done</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> rdb.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Watch</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">tx</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> *</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">redis</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Tx</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">error</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            _, err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> tx.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">TxPipelined</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">pipe</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> redis</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Pipeliner</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">error</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="27"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">                pipe.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Set</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;x&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;newValueFromA&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="28"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">                return</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> nil
</span></span><span class="line" line="29"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            })
</span></span><span class="line" line="30"><span emptylineplaceholder="true">
</span></span><span class="line" line="31"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">            return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> err
</span></span><span class="line" line="32"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;x&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="33"><span emptylineplaceholder="true">
</span></span><span class="line" line="34"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">!=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> nil</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="35"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Printf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Goroutine A aborted: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">%v</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, err)
</span></span><span class="line" line="36"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        } </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">else</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="37"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Printf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Goroutine A succeeded&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="38"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }
</span></span><span class="line" line="39"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }()
</span></span><span class="line" line="40"><span emptylineplaceholder="true">
</span></span><span class="line" line="41"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    go</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">() { 
</span></span><span class="line" line="42"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        defer</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Done</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="43"><span emptylineplaceholder="true">
</span></span><span class="line" line="44"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> rdb.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Watch</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">tx</span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672"> *</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">redis</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Tx</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">error</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="45"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            _, err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> tx.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">TxPipelined</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">func</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic">pipe</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline"> redis</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">.</span><span style="--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline">Pipeliner</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">) </span><span style="--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic">error</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="46"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">                pipe.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Set</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;x&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;newValueFromB&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">0</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="47"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">                return</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> nil
</span></span><span class="line" line="48"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            })
</span></span><span class="line" line="49"><span emptylineplaceholder="true">
</span></span><span class="line" line="50"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">            return</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> err
</span></span><span class="line" line="51"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;x&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="52"><span emptylineplaceholder="true">
</span></span><span class="line" line="53"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">        if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">!=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> nil</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="54"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Printf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Goroutine B aborted: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">%v</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, err)
</span></span><span class="line" line="55"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        } </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">else</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="56"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">            log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Printf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Goroutine B succeeded&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">)
</span></span><span class="line" line="57"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        }
</span></span><span class="line" line="58"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }()
</span></span><span class="line" line="59"><span emptylineplaceholder="true">
</span></span><span class="line" line="60"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    wg.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Wait</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="61"><span emptylineplaceholder="true">
</span></span><span class="line" line="62"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    value, err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">:=</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> rdb.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Get</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(ctx, </span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;x&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">).</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Result</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">()
</span></span><span class="line" line="63"><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">    if</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> err </span><span style="--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672">!=</span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF"> nil</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2"> {
</span></span><span class="line" line="64"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">        log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Fatalf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Could not get x: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">%v</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, err)
</span></span><span class="line" line="65"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    }
</span></span><span class="line" line="66"><span emptylineplaceholder="true">
</span></span><span class="line" line="67"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">    log.</span><span style="--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E">Printf</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">(</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;Final value of x: </span><span style="--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF">%v</span><span style="--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74">&quot;</span><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">, value)
</span></span><span class="line" line="68"><span style="--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2">}
</span></span><span class="line" line="69"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">/*
</span></span><span class="line" line="70"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/04 00:06:19 Goroutine A aborted: redis: transaction failed
</span></span><span class="line" line="71"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/04 00:06:19 Goroutine B succeeded
</span></span><span class="line" line="72"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">2023/09/04 00:06:19 Final value of x: newValueFromB
</span></span><span class="line" line="73"><span style="--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F">*/
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h2 id="依賴線性一致性" data-v-70b0c1e2><a href="#依賴線性一致性" data-v-70b0c1e2><!--[-->依賴線性一致性<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->線性一致性在什麼情況下有用？觀看體育比賽的最後得分可能是一個輕率的例子：滯後了幾秒鐘的結果不太可能在這種情況下造成任何真正的傷害。然而對於少數領域，線性一致性是系統正確工作的一個重要條件。<!--]--></p><h3 id="鎖定和領導選舉" data-v-4cf5bb93><a href="#鎖定和領導選舉" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%8e%96%e5%ae%9a%e5%92%8c%e9%a0%98%e5%b0%8e%e9%81%b8%e8%88%89" rel="nofollow" data-v-692834dd><!--[-->鎖定和領導選舉<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->在單主複製架構中，只有一個領導者（也叫做主節點）負責執行所有寫操作，以預防腦裂現象，即避免多個節點同時認為自己是領導者。為了協調哪個節點可以成為領導者，系統會採用分散式鎖。這種鎖必須要達到線性一致性，也就是所有節點必須共識到誰擁有這把鎖。協調服務像 Apache ZooKeeper 和 etcd 常被用來實現這樣的分散式鎖和領導者選舉。儘管它們提供了線性一致性的寫操作，讀取數據可能仍是過時的，因為這些讀取操作可能由任何一個副本完成。<!--]--></p><h3 id="約束和唯一性保證" data-v-4cf5bb93><a href="#約束和唯一性保證" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b4%84%e6%9d%9f%e5%92%8c%e5%94%af%e4%b8%80%e6%80%a7%e4%bf%9d%e8%ad%89" rel="nofollow" data-v-692834dd><!--[-->約束和唯一性保證<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->在維持關聯式資料庫中的<strong data-v-84b57b07><!--[-->PRIMARY KEY<!--]--></strong>和<strong data-v-84b57b07><!--[-->UNIQUE<!--]--></strong>約束時，通常會使用線性一致性來確保所有節點達到共識。例如，在一個用戶註冊系統中，可能會選擇使用電郵作為唯一識別。如果沒有線性一致性，這可能導致資料不一致或用戶重複註冊。<!--]--></p><p data-v-9dc9c102><!--[-->對於更寬鬆的約束，如<strong data-v-84b57b07><!--[-->FOREIGN KEY<!--]--></strong>，線性一致性不一定是必須的。以電商平台為例，<strong data-v-84b57b07><!--[-->Orders<!--]--></strong> 表與 <strong data-v-84b57b07><!--[-->Products<!--]--></strong> 表是緊密相關的。新商品一旦加入 <strong data-v-84b57b07><!--[-->Products<!--]--></strong> 表，便可能會立即在搜索結果中出現，但相對應的訂單處理（涉及 <strong data-v-84b57b07><!--[-->Orders<!--]--></strong> 表）可能會因為庫存或價格等因素稍微延後。在這樣的情境下，最終一致性會是一個更靈活的選擇。<!--]--></p><h3 id="跨通道的時序依賴" data-v-4cf5bb93><a href="#跨通道的時序依賴" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e8%b7%a8%e9%80%9a%e9%81%93%e7%9a%84%e6%99%82%e5%ba%8f%e4%be%9d%e8%b3%b4" rel="nofollow" data-v-692834dd><!--[-->跨通道的時序依賴<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->圖9-1中有一個細節：如果Alice沒有喊德國贏了Bob就不會靠腰資料是舊的，是因為這個系統多了一個額外通道(通話)才導致發現線性不一致。<!--]--></p><p data-v-9dc9c102><!--[-->計算機系統也會出現類似的情況。例如，假設有一個網站，使用者可以上傳照片，一個後臺程序會調整照片大小，降低解析度以加快下載速度（縮圖）。該系統的架構和資料流如<strong data-v-84b57b07><!--[-->圖 9-5<!--]--></strong>所示<!--]--></p><p data-v-9dc9c102><!--[-->假設有一個網站使用者上傳照片，後台會縮小照片降低解析度增加下載速度(縮圖)。<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-5.png" alt="圖 9-5 Web 伺服器和影象縮放器透過檔案儲存和訊息佇列進行通訊，開啟競爭條件的可能性。" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-5 Web 伺服器和影象縮放器透過檔案儲存和訊息佇列進行通訊，開啟競爭條件的可能性。<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->描述：<!--]--></p><p data-v-9dc9c102><!--[-->1.使用者上傳照片(1.jpg)到Web server<!--]--></p><p data-v-9dc9c102><!--[-->2.Web server將照片(UUID.jpg)放到File storage(/temp)儲存<!--]--></p><p data-v-9dc9c102><!--[-->3.將一個訊息push到MQ(UUID.jpg,/temp)<!--]--></p><p data-v-9dc9c102><!--[-->4.MQ通知Image resizer要縮小的檔案位置(/temp/UUID.jpg)<!--]--></p><p data-v-9dc9c102><!--[-->5.Image resizer讀取File storage的照片(/temp/UUID.jpg)<!--]--></p><p data-v-9dc9c102><!--[-->6.Image resizer處理完縮小照片後上傳到File storage(/result/UUID.jpg)給使用者下載<!--]--></p><p data-v-9dc9c102><!--[-->如果MQ比File stroage複製的更快，可能會導致步驟5出現舊的影像或沒有影像，如果某個節點處理是舊的影像則就產生了永久性的不一致。<!--]--></p><p data-v-9dc9c102><!--[-->出現這個問題是因為Web server和Image resizer之間存在不同的通道：File storage與MQ，這兩個通道之間有可能產生競爭條件。這種狀況類似Alice與Bob語音通訊與網頁更新也存在了競爭條件。<!--]--></p><p data-v-9dc9c102><!--[-->線性一致性並不是避免這種競爭條件的唯一方法，只是這種方式最容易理解，如果可以透過控制MQ則可以使用第五章(<strong data-v-84b57b07><!--[-->Read-Your-Writes Consistency<!--]--></strong>)類似的方法，但是會有而外的複雜代價。<!--]--></p><h3 id="第五章read-your-writes-consistency-補全" data-v-4cf5bb93><a href="#第五章read-your-writes-consistency-補全" data-v-4cf5bb93><!--[-->第五章<strong data-v-84b57b07><!--[-->Read-Your-Writes Consistency ~~<!--]--></strong>*補全~~<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->當使用者寫入一則評論，有可能重新整理頁面發現剛剛寫入的資料不見了(可能從其他節點讀取但是那個節點根本還沒有被Leader更新)，因此使用者困惑了可能會再次寫入剛剛的評論，所以要在寫入Leader的時候直接讀取使用者評論，這樣就可以避免使用者讀取到尚未最終一致性的資料。<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig5-3.png" alt="圖 5-3 使用者寫入後從舊副本中讀取資料。需要寫後讀 (read-after-write) 的一致性來防止這種異常" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 5-3 使用者寫入後從舊副本中讀取資料。需要寫後讀 (read-after-write) 的一致性來防止這種異常<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->描述：<!--]--></p><p data-v-9dc9c102><!--[-->1.User寫評論到Leader然後<!--]--></p><p data-v-9dc9c102><!--[-->2.使用者去Follower2讀取剛剛的comments並沒有剛剛寫入55555的評論<!--]--></p><p data-v-9dc9c102><!--[-->3.Leader過了一段時間才完成最終一致性這時候User才能取到真剛剛寫入的55555<!--]--></p><p data-v-9dc9c102><!--[-->總結：<!--]--></p><p data-v-9dc9c102><!--[-->可以利用寫入Leader寫入回傳的ok來處理讀自己寫的假資料至少讓他不要去Follower2去查看發現資料不對<!--]--></p><h2 id="實現線性一致的系統" data-v-70b0c1e2><a href="#實現線性一致的系統" data-v-70b0c1e2><!--[-->實現線性一致的系統<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->由於線性一致性本質上意味著 “表現得好像只有一個數據副本，而且所有的操作都是原子的”，所以最簡單的答案就是，真的只用一個數據副本。但是這種方法無法容錯：如果持有該副本的節點失效，資料將會丟失，或者至少無法訪問，直到節點重新啟動。<!--]--></p><p data-v-9dc9c102><!--[-->使系統容錯最常用的方法是使用複製。我們再來回顧 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5" rel="nofollow" data-v-692834dd><!--[-->第五章<!--]--></a><!--]--></strong> 中的複製方法，並比較它們是否可以滿足線性一致性：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->單主複製（可能線性一致）<br>在具有單主複製功能的系統中（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e9%a0%98%e5%b0%8e%e8%80%85%e8%88%87%e8%bf%bd%e9%9a%a8%e8%80%85" rel="nofollow" data-v-692834dd><!--[-->領導者與追隨者<!--]--></a><!--]--></strong>”），主庫具有用於寫入的資料的主副本，而追隨者在其他節點上保留資料的備份副本。如果從主庫或同步更新的從庫讀取資料，它們 <strong data-v-84b57b07><!--[-->可能（potential）<!--]--></strong> 是線性一致性的 <span>^iv</span>。然而，實際上並不是每個單主資料庫都是線性一致性的，無論是因為設計的原因（例如，因為使用了快照隔離）還是因為在併發處理上存在錯誤【10】。<br>從主庫讀取依賴一個假設，你確切地知道領導者是誰。正如在 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e7%9c%9f%e7%9b%b8%e7%94%b1%e5%a4%9a%e6%95%b8%e6%89%80%e5%ae%9a%e7%be%a9" rel="nofollow" data-v-692834dd><!--[-->真相由多數所定義<!--]--></a><!--]--></strong>” 中所討論的那樣，一個節點很可能會認為它是領導者，而事實上並非如此 —— 如果具有錯覺的領導者繼續為請求提供服務，可能違反線性一致性【20】。使用非同步複製，故障切換時甚至可能會丟失已提交的寫入（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e8%99%95%e7%90%86%e7%af%80%e9%bb%9e%e5%ae%95%e6%a9%9f" rel="nofollow" data-v-692834dd><!--[-->處理節點宕機<!--]--></a><!--]--></strong>”），這同時違反了永續性和線性一致性。<!--]--></li><li data-v-4c2f5fb9><!--[-->共識演算法（線性一致）<br>一些在本章後面討論的共識演算法，與單主複製類似。然而，共識協議包含防止腦裂和陳舊副本的措施。正是由於這些細節，共識演算法可以安全地實現線性一致性儲存。例如，Zookeeper 【21】和 etcd 【22】就是這樣工作的。<!--]--></li><li data-v-4c2f5fb9><!--[-->多主複製（非線性一致）<br>具有多主程式複製的系統通常不是線性一致的，因為它們同時在多個節點上處理寫入，並將其非同步複製到其他節點。因此，它們可能會產生需要被解決的寫入衝突（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e8%99%95%e7%90%86%e5%af%ab%e5%85%a5%e8%a1%9d%e7%aa%81" rel="nofollow" data-v-692834dd><!--[-->處理寫入衝突<!--]--></a><!--]--></strong>”）。這種衝突是因為缺少單一資料副本所導致的。<!--]--></li><li data-v-4c2f5fb9><!--[-->無主複製（也許不是線性一致的）<br>對於無主複製的系統（Dynamo 風格；請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e7%84%a1%e4%b8%bb%e8%a4%87%e8%a3%bd" rel="nofollow" data-v-692834dd><!--[-->無主複製<!--]--></a><!--]--></strong>”），有時候人們會聲稱透過要求法定人數讀寫(w+r&gt;n)可以獲得 “強一致性”。這取決於法定人數的具體配置，以及強一致性如何定義（通常不完全正確）。<br>基於日曆時鐘（例如，在 Cassandra 中；請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e4%be%9d%e8%b3%b4%e5%90%8c%e6%ad%a5%e6%99%82%e9%90%98" rel="nofollow" data-v-692834dd><!--[-->依賴同步時鐘<!--]--></a><!--]--></strong>”）的 “最後寫入勝利” 衝突解決方法幾乎可以確定是非線性一致的，由於時鐘偏差，不能保證時鐘的時間戳與實際事件順序一致。寬鬆的法定人數（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e5%af%ac%e9%ac%86%e7%9a%84%e6%b3%95%e5%ae%9a%e4%ba%ba%e6%95%b8%e8%88%87%e6%8f%90%e7%a4%ba%e7%a7%bb%e4%ba%a4" rel="nofollow" data-v-692834dd><!--[-->寬鬆的法定人數與提示移交<!--]--></a><!--]--></strong>”）也破壞了線性一致的可能性。即使使用嚴格的法定人數，非線性一致的行為也是可能的，如下節所示。<h3 id="第五章無主複製-補全" data-v-4cf5bb93><a href="#第五章無主複製-補全" data-v-4cf5bb93><!--[-->第五章無主複製 <del>補全</del><!--]--><!----></a></h3><br>使用者每次都讀寫多個複製件<br>讀寫法定人數：<br>公式 w+r&gt;n 讀加寫要大於總結點<br>因爲n=3 w=2 r=2 所以2+2&gt;3成立<br><img src="https://vonng.github.io/ddia/img/fig5-10.png" alt="圖 5-10 法定寫入，法定讀取，並在節點中斷後讀修復。" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 5-10 法定寫入，法定讀取，並在節點中斷後讀修復。<!--]--></strong><br>敘述：<br>1.UserA寫入N1 N2 ‘me-new.jpg’(因為N3死掉了)<br>2.UserB讀取N1 N2 N3 結果發現N3的版本是6其他是7<br>3.UserB就將N3 ’me-new.jpg’的version設定成7<br>結論：<br>無主複製就是要將監督機制直接寫在使用者身上(應用層)而不是讓資料庫自己去發現<!--]--></li><!--]--></ul><h3 id="線性一致性和法定人數" data-v-4cf5bb93><a href="#線性一致性和法定人數" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%92%8c%e6%b3%95%e5%ae%9a%e4%ba%ba%e6%95%b8" rel="nofollow" data-v-692834dd><!--[-->線性一致性和法定人數<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->直覺上無主複製模型中嚴格的法定人數應該是線性一致的。但是當可變的網路延遲就能產生競爭條件。<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-6.png" alt="圖 9-6 非線性一致的執行，儘管使用了嚴格的法定人數" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-6 非線性一致的執行，儘管使用了嚴格的法定人數<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->敘述：<!--]--></p><p data-v-9dc9c102><!--[-->w = 3 r = 2 n = 3<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->x=0<!--]--></li><li data-v-4c2f5fb9><!--[-->Writer 寫入x = 1 到 N1 N2 N3(最快寫入)<!--]--></li><li data-v-4c2f5fb9><!--[-->ReaderA 讀取N1(X) N2(x=0) N3(x=1)<!--]--></li><li data-v-4c2f5fb9><!--[-->ReaderB 讀取N1(x=0) N2(x=0) N3(X)<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->就算法定人數正確也無法保證線性一致，所以最安全的做法就是當作無主複製系統不能提供線性一致<!--]--></p><h2 id="線性一致性的代價" data-v-70b0c1e2><a href="#線性一致性的代價" data-v-70b0c1e2><!--[-->線性一致性的代價<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->一些複製方法可以提供線性一致性，另一些複製方法則不能，因此深入地探討線性一致性的優缺點是很有趣的。<!--]--></p><p data-v-9dc9c102><!--[-->我們已經在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5" rel="nofollow" data-v-692834dd><!--[-->第五章<!--]--></a><!--]--></strong> 中討論了不同複製方法的一些用例。例如對多資料中心的複製而言，多主複製通常是理想的選擇（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e9%81%8b%e7%b6%ad%e5%a4%9a%e5%80%8b%e6%95%b8%e6%93%9a%e4%b8%ad%e5%bf%83" rel="nofollow" data-v-692834dd><!--[-->運維多個數據中心<!--]--></a><!--]--></strong>”）。<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/img/fig9-7.png" rel="nofollow" data-v-692834dd><!--[-->圖 9-7<!--]--></a><!--]--></strong> 說明了這種部署的一個例子。<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-7.png" alt="圖 9-7 網路中斷迫使線性一致性和可用性之間做出選擇。" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-7 網路中斷迫使線性一致性和可用性之間做出選擇。<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->敘述：<!--]--></p><p data-v-9dc9c102><!--[-->多主資料庫：兩個datacenter還是可以單獨使用等到網路恢復後只需要排隊並交換<!--]--></p><p data-v-9dc9c102><!--[-->單主複製：從庫資料中心無法寫入也不能執行任何線性一致的讀取，但是還是可以不使用線性一致的讀取但是讀的資料可能是舊的。<!--]--></p><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->整體來說不管多主單主都無法避免斷線帶來的線性不一致<!--]--></p><h3 id="cap定理" data-v-4cf5bb93><a href="#cap定理" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=cap%e5%ae%9a%e7%90%86" rel="nofollow" data-v-692834dd><!--[-->CAP定理<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->這個問題不僅僅是單主複製和多主複製的後果：任何線性一致的資料庫都有這個問題，不管它是如何實現的。這個問題也不僅僅侷限於多資料中心部署，而可能發生在任何不可靠的網路上，即使在同一個資料中心內也是如此。問題面臨的權衡如下：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果應用需要線性一致性，且某些副本因為網路問題與其他副本斷開連線，那麼這些副本掉線時不能處理請求。請求必須等到網路問題解決，或直接返回錯誤。（無論哪種方式，服務都 <strong data-v-84b57b07><!--[-->不可用<!--]--></strong>）。<!--]--></li><li data-v-4c2f5fb9><!--[-->如果應用不需要線性一致性，那麼某個副本即使與其他副本斷開連線，也可以獨立處理請求（例如多主複製）。在這種情況下，應用可以在網路問題解決前保持可用，但其行為不是線性一致的。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->這兩種選擇有時分別稱為 CP（在網路分割槽下一致但不可用）和 AP（在網路分割槽下可用但不一致）。 但是，這種分類方案存在一些缺陷【9】，所以最好不要這樣用。<!--]--></p><p data-v-9dc9c102><!--[-->補充：<!--]--></p><p data-v-9dc9c102><!--[-->一致性（Consistency）:<!--]--></p><p data-v-9dc9c102><!--[-->所有節點在同一時刻可以看到相同的數據。<!--]--></p><p data-v-9dc9c102><!--[-->可用性（Availability）:<!--]--></p><p data-v-9dc9c102><!--[-->每次請求都會在有限的時間內收到一個明確的成功或失敗回應。<!--]--></p><p data-v-9dc9c102><!--[-->分區容錯性（Partition tolerance）:<!--]--></p><p data-v-9dc9c102><!--[-->即使網絡分區（Partition）發生，系統依然能正常運作。<!--]--></p><p data-v-9dc9c102><!--[-->CAP定理認為必須要在一致性與可用性作出權衡<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->可以有一個 CP（一致性和分區容錯性） 的系統，比如 ZooKeeper。<!--]--></li><li data-v-4c2f5fb9><!--[-->可以有一個 CA（一致性和可用性） 的系統，但這基本上只能在單一節點的情況下實現，一旦涉及到分布式，網絡分區是無法避免的。<!--]--></li><li data-v-4c2f5fb9><!--[-->可以有一個 AP（可用性和分區容錯性） 的系統，比如 Cassandra 或 Couchbase。<!--]--></li><!--]--></ul><h3 id="線性一致性和網路延遲" data-v-4cf5bb93><a href="#線性一致性和網路延遲" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%92%8c%e7%b6%b2%e8%b7%af%e5%bb%b6%e9%81%b2" rel="nofollow" data-v-692834dd><!--[-->線性一致性和網路延遲<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->1.連cpu上的記憶體都不一定是線性一致性的：<!--]--></p><p data-v-9dc9c102><!--[-->如果一個 CPU 核上執行的執行緒寫入某個記憶體地址，而另一個 CPU 核上執行的執行緒不久之後讀取相同的地址，並沒有保證一定能讀到第一個執行緒寫入的值（除非使用了 記憶體屏障（memory barrier） 或 圍欄（fence）【44】）。<!--]--></p><p data-v-9dc9c102><!--[-->而且CPU核心與核心之間的通訊基本都是正常的狀況下還有可能發生線性不一致性。<!--]--></p><p data-v-9dc9c102><!--[-->2.以CPU來說是為了提高效能而選擇犧牲線性一致性而不是為了容錯<!--]--></p><p data-v-9dc9c102><!--[-->3.可能找不到高效並且線性一致性的系統<!--]--></p><h2 id="_93-順序保證" data-v-70b0c1e2><a href="#_93-順序保證" data-v-70b0c1e2><!--[-->9.3 順序保證<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->這小節主要要探討圖9-4順序<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5" rel="nofollow" data-v-692834dd><!--[-->第五章<!--]--></a><!--]--></strong> 中我們看到，領導者在單主複製中的主要目的就是，在複製日誌中確定 <strong data-v-84b57b07><!--[-->寫入順序（order of write）<!--]--></strong>—— 也就是從庫應用這些寫入的順序。如果不存在一個領導者，則併發操作可能導致衝突（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e8%99%95%e7%90%86%e5%af%ab%e5%85%a5%e8%a1%9d%e7%aa%81" rel="nofollow" data-v-692834dd><!--[-->處理寫入衝突<!--]--></a><!--]--></strong>”）。<!--]--></li><li data-v-4c2f5fb9><!--[-->在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch7" rel="nofollow" data-v-692834dd><!--[-->第七章<!--]--></a><!--]--></strong> 中討論的 <strong data-v-84b57b07><!--[-->可序列化<!--]--></strong>，是關於事務表現的像按 <strong data-v-84b57b07><!--[-->某種先後順序（some sequential order）<!--]--></strong> 執行的保證。它可以字面意義上地以 <strong data-v-84b57b07><!--[-->序列順序（serial order）<!--]--></strong> 執行事務來實現，或者允許並行執行，但同時防止序列化衝突來實現（透過鎖或中止事務）。<!--]--></li><li data-v-4c2f5fb9><!--[-->在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8" rel="nofollow" data-v-692834dd><!--[-->第八章<!--]--></a><!--]--></strong> 討論過的在分散式系統中使用時間戳和時鐘（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e4%be%9d%e8%b3%b4%e5%90%8c%e6%ad%a5%e6%99%82%e9%90%98" rel="nofollow" data-v-692834dd><!--[-->依賴同步時鐘<!--]--></a><!--]--></strong>”）是另一種將順序引入無序世界的嘗試，例如，確定兩個寫入操作哪一個更晚發生。<!--]--></li><!--]--></ul><h2 id="順序與因果關係因果一致性-causally-consistent" data-v-70b0c1e2><a href="#順序與因果關係因果一致性-causally-consistent" data-v-70b0c1e2><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%a0%86%e5%ba%8f%e8%88%87%e5%9b%a0%e6%9e%9c%e9%97%9c%e4%bf%82" rel="nofollow" data-v-692834dd><!--[-->順序與因果關係<!--]--></a>(因果一致性 causally consistent)<!--]--></strong><!--]--><!----></a></h2><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->5-5<strong data-v-84b57b07><!--[-->一致字首讀：有因果關係<!--]--></strong><br><img src="https://vonng.github.io/ddia/img/fig5-5.png" alt="圖 5-5 如果某些分割槽的複製速度慢於其他分割槽，那麼觀察者可能會在看到問題之前先看到答案。" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 5-5 如果某些分割槽的複製速度慢於其他分割槽，那麼觀察者可能會在看到問題之前先看到答案。<!--]--></strong><br>通常，問題和答案之間存在明確的因果關係，因為要回答一個問題，首先要有問題的存在。<br>因果關係例子：<br>在一個線上問答社區，通常需要先有人提出問題，然後其他人才能看到並回答這個問題。如果由於網絡延遲，有人先看到了回答而後看到問題，這違反了正常的因果順序。<!--]--></li><li data-v-4c2f5fb9><!--[-->5-9<strong data-v-84b57b07><!--[-->複製和網路延遲：有因果關係<!--]--></strong><br><img src="https://vonng.github.io/ddia/img/fig5-9.png" alt="圖 5-9 使用多主複製時，寫入可能會以錯誤的順序到達某些副本。" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 5-9 使用多主複製時，寫入可能會以錯誤的順序到達某些副本。<!--]--></strong><br>在這個情境下，明確的因果關係是，一個記錄必須先被創建，然後才能被更新。<br>因果關係例子：<br>如果在家中的多台電腦上同步文件，通常必須先在一台電腦上創建文件，然後它才能被同步到其他電腦上。如果由於網絡延遲，文件的更新在某台電腦上先於文件的創建被接收到，這違反了正常的因果順序。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->檢測併發寫入：有可能有因果關係<!--]--></strong><br><img src="https://vonng.github.io/ddia/img/fig5-12.png" alt="圖 5-12 併發寫入 Dynamo 風格的資料儲存：沒有明確定義的順序。" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 5-12 併發寫入 Dynamo 風格的資料儲存：沒有明確定義的順序。<!--]--></strong><br>在這個情境下，可能存在因果關係，例如，如果操作A影響了操作B的結果，那麼就存在因果關係。但如果A和B是獨立並行的，則不存在因果關係。<br>因果關係例子：<br>在超市結賬時，如果兩個人同時到達結賬台，需要確定哪個人應該先結賬以保持秩序。這種順序決定了誰先誰後，存在因果關係。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->事務快照隔離(<a href="https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e5%bf%ab%e7%85%a7%e9%9a%94%e9%9b%a2%e5%92%8c%e5%8f%af%e9%87%8d%e8%a4%87%e8%ae%80" rel="nofollow" data-v-692834dd><!--[-->快照隔離和可重複讀<!--]--></a>)：有因果關係<!--]--></strong><br><img src="https://vonng.github.io/ddia/img/fig7-6.png" alt="圖 7-6 讀取偏差：Alice 觀察資料庫處於不一致的狀態" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 7-6 讀取偏差：Alice 觀察資料庫處於不一致的狀態<!--]--></strong><br>不可重複讀，除非知道因果關係要不然重複讀取會產生不一致<br>因果關係例子：<br>查看社交媒體的時候看到了一個回覆，理所當然的，你會期望能夠看到被回覆的原始帖子，因為回覆（效果）依賴於原始帖子（原因）。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->寫偏差(<a href="https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e5%af%ab%e5%85%a5%e5%81%8f%e5%b7%ae%e8%88%87%e5%b9%bb%e8%ae%80" rel="nofollow" data-v-692834dd><!--[-->寫入偏差與幻讀<!--]--></a>):可能有因果關係<!--]--></strong><br><img src="https://vonng.github.io/ddia/img/fig7-8.png" alt="圖 7-8 寫入偏差導致應用程式錯誤的示例" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 7-8 寫入偏差導致應用程式錯誤的示例<!--]--></strong><br>Alice依賴Bob的on_call狀態，Bob也依賴Alice的on_call狀態<br>寫偏差的情境下可能存在因果關係，例如，某個事務的結果可能依賴於另一個事務的狀態。<br>因果關係例子：<br>在一個忙碌的餐廳，如果兩個服務員同時去搶一個空出來的桌子給等待的客人，但由於沒有及時通信，可能會導致兩組客人被安排到同一個桌子，這是因果關係管理的失敗。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->因果依賴和時序(Alice &amp; Bob 看球賽)：有因果關係<!--]--></strong><br><img src="https://vonng.github.io/ddia/img/fig9-1.png" alt="圖 9-1 這個系統是非線性一致的，導致了球迷的困惑" class="prose-img" loading="lazy" data-v-57b8b35b><br><strong data-v-84b57b07><!--[-->圖 9-1 這個系統是非線性一致的，導致了球迷的困惑<!--]--></strong><br>在這個情境下，存在明確的因果關係，比如進球（原因）和球員慶祝（效果）。<br>因果關係例子：<br>在觀看足球比賽時，球員的慶祝是依賴於先前的進球事件。進球是原因，球員的慶祝是效果，二者之間存在明確的因果關係。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->結論：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->因果一致性<!--]--></strong>：重視操作之間的因果關係。如果操作A在因果上先於操作B，那麼系統應保證所有節點上A的效果都會在B的效果之前被看到。這使得系統能夠保留操作的自然順序，但不保證全局的操作順序。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->線性一致性<!--]--></strong>：要求系統中的所有操作都能夠按照某一全局順序（通常是時間順序）來呈現，使得所有操作看起來就像是在一個單一的、原子的、全局順序的時間點上發生的。這提供了一個非常強的一致性保證，但可能會降低系統的性能和可用性。<!--]--></li><!--]--></ul><h3 id="因果順序不是全序的" data-v-4cf5bb93><a href="#因果順序不是全序的" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%9b%a0%e6%9e%9c%e9%a0%86%e5%ba%8f%e4%b8%8d%e6%98%af%e5%85%a8%e5%ba%8f%e7%9a%84" rel="nofollow" data-v-692834dd><!--[-->因果順序不是全序的<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->全序(total order)：<!--]--></strong> 允許任意兩個元素進行比較，所以如果有兩個元素，你總是可以說出哪個更大，哪個更小。例如，自然數集是全序的：給定兩個自然數，比如說 5 和 13，那麼你可以知道，13 大於 5。<!--]--></p><p data-v-9dc9c102><!--[-->偏序(partially ordered)：考慮三個集合：A={1,2}，B={2,3}，和C={1,2,3}。在這裡，A和B是無法比較的，因為它們之間沒有子集關係。但是，A和C可以比較，因為A是C的子集，記作A⊂C。<!--]--></p><p data-v-9dc9c102><!--[-->全序和偏序之間的差異反映在不同的資料庫一致性模型中：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->線性一致性<br>線性一致的系統中，操作是全序的：如果系統表現的就好像只有一個數據副本，並且所有操作都是原子性的，這意味著對任何兩個操作，我們總是能判定哪個操作先發生。這個全序在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/img/fig9-4.png" rel="nofollow" data-v-692834dd><!--[-->圖 9-4<!--]--></a><!--]--></strong> 中以時間線表示。<!--]--></li><li data-v-4c2f5fb9><!--[-->因果性<br>我們說過，如果兩個操作都沒有在彼此 <strong data-v-84b57b07><!--[-->之前發生<!--]--></strong>，那麼這兩個操作是併發的（請參閱 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e2%80%9c%e6%ad%a4%e5%89%8d%e7%99%bc%e7%94%9f%e2%80%9d%e7%9a%84%e9%97%9c%e4%bf%82%e5%92%8c%e4%bd%b5%e7%99%bc" rel="nofollow" data-v-692834dd><!--[-->“此前發生” 的關係和併發<!--]--></a><!--]--></strong>）。換句話說，如果兩個事件是因果相關的（一個發生在另一個事件之前），則它們之間是有序的，但如果它們是併發的，則它們之間的順序是無法比較的。這意味著因果關係定義了一個偏序，而不是一個全序：一些操作相互之間是有順序的，但有些則是無法比較的。併發是偏序的<!--]--></li><!--]--></ul><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>graph TD;
</span></span><span class="line" line="2"><span>        全序
</span></span><span class="line" line="3"><span>    A[任務 A];
</span></span><span class="line" line="4"><span>    B[任務 B];
</span></span><span class="line" line="5"><span>    C[任務 C];
</span></span><span class="line" line="6"><span>    D[任務 D];
</span></span><span class="line" line="7"><span>    E[任務 E];
</span></span><span class="line" line="8"><span>    全序 --&gt; A;
</span></span><span class="line" line="9"><span>    A --&gt; B;
</span></span><span class="line" line="10"><span>    B --&gt; C;
</span></span><span class="line" line="11"><span>    C --&gt; D;
</span></span><span class="line" line="12"><span>    D --&gt; E;
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span>        偏序
</span></span><span class="line" line="15"><span>        A1[任務 A];
</span></span><span class="line" line="16"><span>    B1[任務 B];
</span></span><span class="line" line="17"><span>    C1[任務 C];
</span></span><span class="line" line="18"><span>    D1[任務 D];
</span></span><span class="line" line="19"><span>    E1[任務 E];
</span></span><span class="line" line="20"><span>    F1[任務 F];
</span></span><span class="line" line="21"><span>    
</span></span><span class="line" line="22"><span>        偏序--&gt;A1;
</span></span><span class="line" line="23"><span>    A1 --&gt; B1;
</span></span><span class="line" line="24"><span>    B1 --&gt; D1;
</span></span><span class="line" line="25"><span>    A1 --&gt; C1;
</span></span><span class="line" line="26"><span>    C1 --&gt; E1;
</span></span><span class="line" line="27"><span>    D1 --&gt; F1;
</span></span><span class="line" line="28"><span>    E1 --&gt; F1;
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->如果你熟悉像 Git 這樣的分散式版本控制系統，那麼其版本歷史與因果關係圖極其相似。通常，一個 <strong data-v-84b57b07><!--[-->提交（Commit）<!--]--></strong> 發生在另一個提交之後，在一條直線上。但是有時你會遇到分支（當多個人同時在一個專案上工作時），<strong data-v-84b57b07><!--[-->合併（Merge）<!--]--></strong> 會在這些併發建立的提交相融合時建立。因為知道develop發生過什麼事情再去看5-22e4a46才知道是全序的<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>gitGraph:
</span></span><span class="line" line="2"><span>options
</span></span><span class="line" line="3"><span>{
</span></span><span class="line" line="4"><span>    &quot;nodeSpacing&quot;: 150,
</span></span><span class="line" line="5"><span>    &quot;nodeRadius&quot;: 10
</span></span><span class="line" line="6"><span>}
</span></span><span class="line" line="7"><span>end
</span></span><span class="line" line="8"><span>commit
</span></span><span class="line" line="9"><span>commit
</span></span><span class="line" line="10"><span>branch develop
</span></span><span class="line" line="11"><span>checkout develop
</span></span><span class="line" line="12"><span>commit
</span></span><span class="line" line="13"><span>commit
</span></span><span class="line" line="14"><span>checkout main
</span></span><span class="line" line="15"><span>merge develop
</span></span><span class="line" line="16"><span>commit
</span></span><span class="line" line="17"><span>commit
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h3 id="線性一致性強於因果一致性" data-v-4cf5bb93><a href="#線性一致性強於因果一致性" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%bc%b7%e6%96%bc%e5%9b%a0%e6%9e%9c%e4%b8%80%e8%87%b4%e6%80%a7" rel="nofollow" data-v-692834dd><!--[-->線性一致性強於因果一致性<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->線性一致性隱含了因果關係，也就是說，任何線性一致的系統都能正確地保持因果性，即使在有多個通訊通道的情況下也能自動保證，無需進行特殊的操作如傳遞時間戳。這種隱含的關係使得線性一致性成為了一個非常強大而又直觀的一致性模型。<!--]--></p><p data-v-9dc9c102><!--[-->許多分散式系統看起來需要線性一致性但實際上只要保證網路不延遲其實使用因果一致性就算是最強的一致性模型。<!--]--></p><h3 id="捕獲因果關係" data-v-4cf5bb93><a href="#捕獲因果關係" data-v-4cf5bb93><!--[-->捕獲因果關係<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->為了保持因果性，系統必須能夠識別操作間的“發生在先前”（happened before）關係。這形成了一種偏序（partial ordering）關係，意味著在某些情況下，可以明確地說一個操作發生在另一個操作之前，而在其他情況下（如併發操作），則無法做出此判定。<!--]--></p><p data-v-9dc9c102><!--[-->為了明確因果依賴，需要有方式描述系統中各節點的“知識”。這種“知識”是指節點在進行某些操作時，對系統中其他事件的了解。例如，如果一個節點在發出寫入Y的請求時已經看到了X的值，那麼就可能存在一個因果關係，表示X是Y發生的原因。這種情況類似於在欺詐指控的刑事調查中常見的問題，例如在做出某個決定Y時，CEO是否知道了X的情況。在這種情況下，X和Y之間的因果關係是基於節點（或在刑事調查中的CEO）在執行操作時所具有的知識。這種分析方式可以幫助確定事件之間的因果依賴，並且對於維持系統的因果一致性至關重要。<!--]--></p><p data-v-9dc9c102><!--[-->為了確定因果順序，資料庫需要知道應用讀取了哪個版本的資料。這就是為什麼在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/img/fig5-13.png" rel="nofollow" data-v-692834dd><!--[-->圖 5-13<!--]--></a><!--]--></strong> 中，來自先前操作的版本號在寫入時被傳回到資料庫的原因。在 SSI 的衝突檢測中會出現類似的想法，如 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e5%8f%af%e5%ba%8f%e5%88%97%e5%8c%96%e5%bf%ab%e7%85%a7%e9%9a%94%e9%9b%a2" rel="nofollow" data-v-692834dd><!--[-->可序列化快照隔離<!--]--></a><!--]--></strong>” 中所述：當事務要提交時，資料庫將檢查它所讀取的資料版本是否仍然是最新的。為此，資料庫跟蹤哪些資料被哪些事務所讀取。<!--]--></p><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->我們可以從資料庫的版本“知識點”來捕獲因果關係，由於這個知識是找出因果的關鍵所以可能會製造出衝突讓多節點系統保持一致性<!--]--></p><h2 id="序列號順序" data-v-70b0c1e2><a href="#序列號順序" data-v-70b0c1e2><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%ba%8f%e5%88%97%e8%99%9f%e9%a0%86%e5%ba%8f" rel="nofollow" data-v-692834dd><!--[-->序列號順序<!--]--></a><!--]--></strong><!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->雖然因果是一個重要的理論概念，但是要跟蹤所有的因果關係是不切實際的，還好有一個更好的方法，我們可以使用 <strong data-v-84b57b07><!--[-->序列號（sequence number）<!--]--></strong> 或 <strong data-v-84b57b07><!--[-->時間戳（timestamp）<!--]--></strong> 來排序事件，時間戳不一定要來自於日曆時鐘，可以用使用邏輯時鐘，因為日曆時鐘會有“不可靠時鐘”問題，典型的邏輯時鐘實現是使用每次操作自增計數器。<!--]--></p><p data-v-9dc9c102><!--[-->使用自增計數器可以提供比較值越大的後發生，我們可以使用因果一致的全序來產生序列號，這樣就可以產生一個比因果性更嚴格的順序。<!--]--></p><p data-v-9dc9c102><!--[-->一個因果關係不一致的全序很容易建立但是是垃圾，例如我們隨機產生了一個UUID但是這個序列根本沒辦法為我們提供操作的先後順序，或者是否觀察的出來操作是否是併發的。<!--]--></p><p data-v-9dc9c102><!--[-->在單主複製的資料庫中，複製日誌定義因果一致的寫操作，主庫可以為每個動作採用自增計數，而從每個操作分配一個遞增的序列號。如果一個從庫按照複製日誌的順序來寫入，這樣一來從庫的狀態會始終是因果一致的。就算從庫落後於領導者也能保持因果一致，因為有複製日誌的序列讓從庫知道先後順序該如何寫入。<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant 主庫
</span></span><span class="line" line="3"><span>    participant 複製日誌
</span></span><span class="line" line="4"><span>    participant 從庫
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span>    主庫-&gt;&gt;複製日誌: 操作1 (序列號: 1)
</span></span><span class="line" line="7"><span>    複製日誌--&gt;&gt;從庫: 操作1 (序列號: 1)
</span></span><span class="line" line="8"><span>    主庫-&gt;&gt;複製日誌: 操作2 (序列號: 2)
</span></span><span class="line" line="9"><span>    複製日誌--&gt;&gt;從庫: 操作2 (序列號: 2)
</span></span><span class="line" line="10"><span>    主庫-&gt;&gt;複製日誌: 操作3 (序列號: 3)
</span></span><span class="line" line="11"><span>    複製日誌--&gt;&gt;從庫: 操作3 (序列號: 3)
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h3 id="非因果序列號生成器" data-v-4cf5bb93><a href="#非因果序列號生成器" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%9d%9e%e5%9b%a0%e6%9e%9c%e5%ba%8f%e5%88%97%e8%99%9f%e7%94%9f%e6%88%90%e5%99%a8" rel="nofollow" data-v-692834dd><!--[-->非因果序列號生成器<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->如果主庫不存在（可能因為使用了多主資料庫或無主資料庫，或者因為使用了分割槽的資料庫），如何為操作生成序列號就沒有那麼明顯了。在實踐中有各種各樣的方法：<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->每個節點都可以生成自己獨立的一組序列號。例如有兩個節點，一個節點只能生成奇數，而另一個節點只能生成偶數。通常，可以在序列號的二進位制表示中預留一些位，用於唯一的節點識別符號，這樣可以確保兩個不同的節點永遠不會生成相同的序列號。<div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Node1 as 節點1 (奇數序列號)
</span></span><span class="line" line="3"><span>    participant Node2 as 節點2 (偶數序列號)
</span></span><span class="line" line="4"><span>    Note over Node1,Node2: 每個節點可以生成自己獨立的一組序列號
</span></span><span class="line" line="5"><span>    Node1-&gt;&gt;Node2: 操作1 (序列號: 1)
</span></span><span class="line" line="6"><span>    Node2-&gt;&gt;Node1: 操作2 (序列號: 2)
</span></span><span class="line" line="7"><span>    Node1-&gt;&gt;Node2: 操作3 (序列號: 3)
</span></span><span class="line" line="8"><span>    Node2-&gt;&gt;Node1: 操作4 (序列號: 4)
</span></span><span class="line" line="9"><span>    Note over Node1,Node2: 兩個不同的節點永遠不會生成相同的序列號
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><!--]--></li><li data-v-4c2f5fb9><!--[-->可以將日曆時鐘（物理時鐘）的時間戳附加到每個操作上【55】。這種時間戳並不連續，但是如果它具有足夠高的解析度，那也許足以提供一個操作的全序關係。這一事實應用於* 最後寫入勝利 * 的衝突解決方法中（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e6%9c%89%e5%ba%8f%e4%ba%8b%e4%bb%b6%e7%9a%84%e6%99%82%e9%96%93%e6%88%b3" rel="nofollow" data-v-692834dd><!--[-->有序事件的時間戳<!--]--></a><!--]--></strong>”）。
”最後只有操作三可以成功寫入”<div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Node1 as 節點1
</span></span><span class="line" line="3"><span>    participant Node2 as 節點2
</span></span><span class="line" line="4"><span>    Note over Node1,Node2: 操作依賴物理時鐘
</span></span><span class="line" line="5"><span>    Node1-&gt;&gt;Node2: 操作1 (時間戳: 08:00:00)
</span></span><span class="line" line="6"><span>    Node2-&gt;&gt;Node1: 操作2 (時間戳: 08:01:00)
</span></span><span class="line" line="7"><span>    Node1-&gt;&gt;Node2: 操作3 (時間戳: 08:02:00)
</span></span><span class="line" line="8"><span>    Note over Node1, Node2: 最後只有操作三可以成功寫入
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><!--]--></li><li data-v-4c2f5fb9><!--[-->可以預先分配序列號區塊。例如，節點 A 可能要求從序列號 1 到 1,000 區塊的所有權，而節點 B 可能要求序列號 1,001 到 2,000 區塊的所有權。然後每個節點可以獨立分配所屬區塊中的序列號，並在序列號告急時請求分配一個新的區塊。<div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant NodeA as 節點A
</span></span><span class="line" line="3"><span>    participant NodeB as 節點B
</span></span><span class="line" line="4"><span>    Note over NodeA,NodeB: 預先分配序列號區塊
</span></span><span class="line" line="5"><span>    NodeA-&gt;&gt;NodeB: 操作1 (序列號: 500)
</span></span><span class="line" line="6"><span>    NodeB-&gt;&gt;NodeA: 操作2 (序列號: 1500)
</span></span><span class="line" line="7"><span>    NodeA-&gt;&gt;NodeB: 操作3 (序列號: 800)
</span></span><span class="line" line="8"><span>    NodeB-&gt;&gt;NodeA: 操作4 (序列號: 1600)
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><br>這三個選項都比單一主庫的自增計數器表現要好，並且更具可伸縮性。它們為每個操作生成一個唯一的，近似自增的序列號。然而它們都有同一個問題：生成的序列號與因果不一致。<ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->每個節點每秒可以處理不同數量的操作。因此，如果一個節點產生偶數序列號而另一個產生奇數序列號，則偶數計數器可能落後於奇數計數器，反之亦然。如果你有一個奇數編號的操作和一個偶數編號的操作，你無法準確地說出哪一個操作在因果上先發生。<div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Node1 as 節點1 (奇數序列號)
</span></span><span class="line" line="3"><span>    participant Node2 as 節點2 (偶數序列號)
</span></span><span class="line" line="4"><span>    
</span></span><span class="line" line="5"><span>    Note over Node1,Node2: 每個節點每秒可以處理不同數量的操作
</span></span><span class="line" line="6"><span>    
</span></span><span class="line" line="7"><span>    Node1-&gt;&gt;Node2: 操作1 (序列號: 1, 時間: 08:00:00)
</span></span><span class="line" line="8"><span>    Note over Node1: 節點1 快速處理操作
</span></span><span class="line" line="9"><span>    Node1-&gt;&gt;Node2: 操作3 (序列號: 3, 時間: 08:00:01)
</span></span><span class="line" line="10"><span>    
</span></span><span class="line" line="11"><span>    Note over Node2: 節點2 較慢地處理操作
</span></span><span class="line" line="12"><span>    Node2-&gt;&gt;Node1: 操作2 (序列號: 2, 時間: 08:00:05)
</span></span><span class="line" line="13"><span>    Node2-&gt;&gt;Node1: 操作4 (序列號: 4, 時間: 08:00:10)
</span></span><span class="line" line="14"><span>    
</span></span><span class="line" line="15"><span>    Note over Node1,Node2: 無法確定操作2和操作3哪個在因果上先發生
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><!--]--></li><li data-v-4c2f5fb9><!--[-->來自物理時鐘的時間戳會受到時鐘偏移的影響，這可能會使其與因果不一致。例如 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/img/fig8-3.png" rel="nofollow" data-v-692834dd><!--[-->圖 8-3<!--]--></a><!--]--></strong> 展示了一個例子，其中因果上晚發生的操作，卻被分配了一個更早的時間戳。可以使物理時鐘時間戳與因果關係保持一致：在 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e5%85%a8%e5%9f%9f%e6%80%a7%e5%bf%ab%e7%85%a7%e7%9a%84%e5%90%8c%e6%ad%a5%e6%99%82%e9%90%98" rel="nofollow" data-v-692834dd><!--[-->全域性快照的同步時鐘<!--]--></a><!--]--></strong>” 中，我們討論了 Google 的 Spanner，它可以估計預期的時鐘偏差，並在提交寫入之前等待不確定性間隔。這種方法確保了實際上靠後的事務會有更大的時間戳。但是大多數時鐘不能提供這種所需的不確定性度量。<div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Node1 as 節點1
</span></span><span class="line" line="3"><span>    participant Node2 as 節點2
</span></span><span class="line" line="4"><span>    Note over Node1,Node2: 時鐘偏移影響
</span></span><span class="line" line="5"><span>    Node1-&gt;&gt;Node2: 操作1 (時間戳: 10:00:01)
</span></span><span class="line" line="6"><span>    Node2-&gt;&gt;Node1: 操作2 (時間戳: 10:00:00, 因果上晚於操作1)
</span></span><span class="line" line="7"><span>    Note over Node1,Node2: 因果關係與時間戳不一致
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><!--]--></li><li data-v-4c2f5fb9><!--[-->在分配區塊的情況下，某個操作可能會被賦予一個範圍在 1,001 到 2,000 內的序列號，然而一個因果上更晚的操作可能被賦予一個範圍在 1 到 1,000 之間的數字。這裡序列號與因果關係也是不一致的。<div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant NodeA as 節點A
</span></span><span class="line" line="3"><span>    participant NodeB as 節點B
</span></span><span class="line" line="4"><span>    Note over NodeA,NodeB: 序列號與因果不一致
</span></span><span class="line" line="5"><span>    NodeA-&gt;&gt;NodeB: 操作1 (序列號: 1500)
</span></span><span class="line" line="6"><span>    NodeB-&gt;&gt;NodeA: 操作2 (序列號: 500, 因果上晚於操作1)
</span></span><span class="line" line="7"><span>    Note over NodeA,NodeB: 因果關係與序列號不一致
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><!--]--></li><!--]--></ol><!--]--></li><!--]--></ol><h3 id="蘭伯特時間戳" data-v-4cf5bb93><a href="#蘭伯特時間戳" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e8%98%ad%e4%bc%af%e7%89%b9%e6%99%82%e9%96%93%e6%88%b3" rel="nofollow" data-v-692834dd><!--[-->蘭伯特時間戳<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->儘管剛才描述的三個序列號生成器與因果不一致，但實際上有一個簡單的方法來產生與因果關係一致的序列號。它被稱為蘭伯特時間戳，萊斯利・蘭伯特（Leslie Lamport）於 1978 年提出【56】<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-8.png" alt="圖 9-8 Lamport 時間戳提供了與因果關係一致的全序。" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-8 Lamport 時間戳提供了與因果關係一致的全序。<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->目標：<!--]--></p><p data-v-9dc9c102><!--[-->Client(Count節點計數器,Node節點名稱) → 使用者攜帶個節點最大值並且在操作兩個節點時更新節點最大值<!--]--></p><p data-v-9dc9c102><!--[-->解說：<!--]--></p><p data-v-9dc9c102><!--[-->每次被操作Node1 與 Node2都會c都會+1，ClientA先存取Node1所以Node1 c=1 中間一段時間都是ClientB存取Node2不管存取幾次因為Node2的C持續的增加，只要ClinetA某次存取到Node2就可以因為讀取到Node2的c而去更新自己的最大值<!--]--></p><p data-v-9dc9c102><!--[-->EX:ClientA(1,1)→ClientA(5,2)→因為曾經讀取過Node2的最大計數值所以ClientA可以更新Node1的c=6，最後產生ClientA(6,1)
因為使用這樣的計數方式可以看得出彼此的因果關係<!--]--></p><div class="table-wrapper" data-v-78f198db><table data-v-78f198db><!--[--><thead data-v-81e7d1ab><!--[--><tr data-v-759aaa1b><!--[--><th data-v-40ddd69b><!--[-->ClinetA<!--]--></th><th data-v-40ddd69b><!--[-->ClientB<!--]--></th><!--]--></tr><!--]--></thead><tbody><!--[--><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->(1,1)<!--]--></td><td data-v-5f84e3ba><!--[-->(1,2)<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->(5,2)<!--]--></td><td data-v-5f84e3ba><!--[-->(2,2)<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[-->(6,1)<!--]--></td><td data-v-5f84e3ba><!--[-->(3,2)<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><!--]--></td><td data-v-5f84e3ba><!--[-->(4,2)<!--]--></td><!--]--></tr><tr data-v-759aaa1b><!--[--><td data-v-5f84e3ba><!--[--><!--]--></td><td data-v-5f84e3ba><!--[-->(6,2)<!--]--></td><!--]--></tr><!--]--></tbody><!--]--></table></div><p data-v-9dc9c102><!--[-->就算不看圖以資料形式看待也大概猜的的出來兩個Node之間有版本差異<!--]--></p><h3 id="光有時間戳排序還不夠" data-v-4cf5bb93><a href="#光有時間戳排序還不夠" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%85%89%e6%9c%89%e6%99%82%e9%96%93%e6%88%b3%e6%8e%92%e5%ba%8f%e9%82%84%e4%b8%8d%e5%a4%a0" rel="nofollow" data-v-692834dd><!--[-->光有時間戳排序還不夠<!--]--></a><!--]--></strong><!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->雖然蘭伯特時間戳定義了一個與因果一致的全序，但它還不足以解決分散式系統中的許多常見問題。<!--]--></p><p data-v-9dc9c102><!--[-->例如：<!--]--></p><p data-v-9dc9c102><!--[-->同時間有兩個使用者要創建同一個名稱的帳號Alice<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant User1 as 使用者1
</span></span><span class="line" line="3"><span>    participant User2 as 使用者2
</span></span><span class="line" line="4"><span>    participant NodeA as 節點A
</span></span><span class="line" line="5"><span>    participant NodeB as 節點B
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span>    Note over User1,User2: 嘗試創建相同的使用者名稱
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span>    User1-&gt;&gt;NodeA: 請求創建帳戶 (使用者名稱: Alice)
</span></span><span class="line" line="10"><span>    User2-&gt;&gt;NodeB: 請求創建帳戶 (使用者名稱: Alice)
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line" line="12"><span>    Note over NodeA,NodeB: 生成蘭伯特時間戳
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span>    NodeA-&gt;&gt;NodeB: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)
</span></span><span class="line" line="15"><span>    Note right of NodeB: 網路延遲
</span></span><span class="line" line="16"><span emptylineplaceholder="true">
</span></span><span class="line" line="17"><span>    NodeB-&gt;&gt;NodeA: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)
</span></span><span class="line" line="18"><span>    Note right of NodeA: 網路延遲
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span>    Note over NodeA,NodeB: 由於網路問題，節點無法準確比較蘭伯特時間戳，無法確定哪個請求先來。
</span></span><span class="line" line="21"><span emptylineplaceholder="true">
</span></span><span class="line" line="22"><span>    alt 網路恢復
</span></span><span class="line" line="23"><span>        NodeA-&gt;&gt;NodeB: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)
</span></span><span class="line" line="24"><span>        NodeB-&gt;&gt;NodeA: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)
</span></span><span class="line" line="25"><span>        Note over NodeA,NodeB: 現在可以比較蘭伯特時間戳，但已經太遲了。
</span></span><span class="line" line="26"><span>    else 網路未恢復
</span></span><span class="line" line="27"><span>        Note over NodeA,NodeB: 系統被拖至停機，無法解決請求。
</span></span><span class="line" line="28"><span>    end
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->請求發送:<!--]--></strong> 使用者1和使用者2分別向節點A和節點B發送請求，試圖創建使用相同名稱的帳戶。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->生成蘭伯特時間戳:<!--]--></strong> 節點A和節點B在接收到請求時生成蘭伯特時間戳。假設節點A生成的時間戳為L1，節點B生成的時間戳為L2。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->嘗試通知:<!--]--></strong> 節點A嘗試通知節點B它的請求和時間戳L1，而節點B嘗試通知節點A它的請求和時間戳L2。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->網路延遲:<!--]--></strong> 由於網路延遲或其他網路問題，這些通知可能會延遲到達，或者可能根本無法到達(節點A與節點B之間的網路延遲)。這使得節點之間無法立即比較蘭伯特時間戳，也就無法確定哪個請求先到來。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->網路恢復（如果恢復的話）:<!--]--></strong> 如果網路最終恢復，節點A和節點B可以重新通知對方它們的請求和蘭伯特時間戳。現在，它們可以比較蘭伯特時間戳來確定哪個請求先到來。但是，這可能已經太遲了，因為使用者可能已經不再等待，或者系統可能已經因其他原因而進入不一致的狀態。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->網路未恢復:<!--]--></strong> 如果網路未能恢復，節點A和節點B無法確定哪個請求先到來，這可能導致系統被拖至停機，無法解決這些請求。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->即使使用了蘭伯特時間戳（Lamport Timestamps）來確定全序關係，仍然會因為操作的不確定性導致並不完全全序。只有在所有的操作都被收集後，操作的全序才會出現。如何確定全序關係已經塵埃落定，這將在 <strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad" rel="nofollow" data-v-692834dd><!--[-->全序廣播<!--]--></a><!--]--></strong> 一節中詳細說明。<!--]--></p><h2 id="全序廣播" data-v-70b0c1e2><a href="#全序廣播" data-v-70b0c1e2><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad" rel="nofollow" data-v-692834dd><!--[-->全序廣播<!--]--></a><!--]--></strong><!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->單CPU核心的操作順序<!--]--></strong>：當程式在單個CPU核心上運行時，定義操作的全序相對簡單，因為操作的順序就是它們被CPU執行的順序。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->分散式系統的操作順序<!--]--></strong>：在分散式系統中，各節點可能在不同的時間執行操作，使得確定全域性操作順序變得困難。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->時間戳或序列號排序的局限性<!--]--></strong>：雖然可以通過時間戳或序列號來排序操作，但是這種方法不如單主複製有效，尤其是在需要確保唯一性時。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->單主複製<!--]--></strong>：單主複製通過選擇一個節點作為主庫來確定操作的全序，並在主庫的單個CPU核心上對所有操作進行排序。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->吞吐量和故障恢復的挑戰<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果系統的吞吐量需求超過了單個主庫的處理能力，則需要考慮如何擴展系統。<!--]--></li><li data-v-4c2f5fb9><!--[-->如果主庫失效，則需要考慮如何進行故障切換，以保證系統的持續運行。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->全序廣播和原子廣播<!--]--></strong>：這兩種技術旨在解決分散式系統中的全序問題，確保所有節點都以相同的順序看到所有操作，即使在面對節點失效或網路問題的時候也能保持一致性。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->全序廣播必須滿足兩個條件：<!--]--></p><p data-v-9dc9c102><!--[-->1.可靠交付<!--]--></p><p data-v-9dc9c102><!--[-->沒有訊息丟失：如果訊息被傳遞到一個節點，它將被傳遞到所有節點。<!--]--></p><p data-v-9dc9c102><!--[-->2.全序交付<!--]--></p><p data-v-9dc9c102><!--[-->訊息以相同的順序傳遞給每個節點。<!--]--></p><p data-v-9dc9c102><!--[-->正確的全序廣播演算法必須始終保證可靠性和有序性，即使節點或網路出現故障。當然在網路中斷的時候，訊息是傳不出去的，但是演算法可以不斷重試，以便在網路最終修復時，訊息能及時透過並送達（當然它們必須仍然按照正確的順序傳遞）。<!--]--></p><h3 id="使用全序廣播" data-v-4cf5bb93><a href="#使用全序廣播" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%bd%bf%e7%94%a8%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad" rel="nofollow" data-v-692834dd><!--[-->使用全序廣播<!--]--></a><!--]--></strong><!--]--><!----></a></h3><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->共識服務與全序廣播<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->類似 ZooKeeper 和 etcd 的共識服務實際上實現了全序廣播，顯示了全序廣播與共識之間的密切聯繫。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料庫複製<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->全序廣播是資料庫複製所需的，每個訊息代表一次資料庫的寫入，所有副本按相同的順序處理相同的寫入，保證副本間的一致性，這被稱為狀態機複製。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->可序列化的事務<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->使用全序廣播可以實現可序列化的事務，每個訊息代表一個確定性事務，並且每個節點以相同的順序處理這些訊息，保證資料庫的分割槽和副本的一致性。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->訊息順序的固化<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在全序廣播中，訊息順序在訊息送達時被固化，不允許追溯地將訊息插入順序中的較早位置，使全序廣播比時間戳排序更強。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->日誌的建立<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->全序廣播也是建立日誌的一種方式，傳遞訊息就像追加寫入日誌，所有節點必須以相同的順序傳遞相同的訊息，以確保所有節點都可以讀取日誌並看到相同的訊息序列。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->防護令牌的鎖服務<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在實現提供防護令牌的鎖服務中，全序廣播也非常有用。每個獲取鎖的請求都作為一條訊息追加到日誌末尾，並按日誌中的順序依次編號，這些序列號可以作為防護令牌使用。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><h3 id="使用全序廣播實現線性一致的儲存" data-v-4cf5bb93><a href="#使用全序廣播實現線性一致的儲存" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%bd%bf%e7%94%a8%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad%e5%af%a6%e7%8f%be%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e7%9a%84%e5%84%b2%e5%ad%98" rel="nofollow" data-v-692834dd><!--[-->使用全序廣播實現線性一致的儲存<!--]--></a><!--]--></strong><!--]--><!----></a></h3><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->基於全序廣播建立線性一致儲存<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->全序廣播保證訊息以固定的順序可靠地傳送，而線性一致性則保證讀取能看見最新的寫入值。基於全序廣播，可以構建線性一致的儲存系統。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->利用 CAS (比較並設定) 原子操作<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->對每個可能的使用者名稱，創建一個帶有 CAS 原子操作的線性一致暫存器，以確保使用者名稱的唯一性。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->僅追加日誌的全序廣播<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->以僅追加日誌的形式實現全序廣播，並通過在日誌中追加和讀取訊息來實現線性一致的 CAS 操作。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->處理併發寫入<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->由於日誌項以相同的順序送達所有節點，可以選擇衝突寫入中的第一個作為勝利者，並中止後來者，以此確保所有節點對某個寫入是提交還是中止達成一致。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->線性一致的讀取<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->為了使讀取也線性一致，可以選擇：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在日誌中追加訊息並等待該訊息被讀回來執行實際的讀取操作；<!--]--></li><li data-v-4c2f5fb9><!--[-->查詢最新日誌訊息的位置，等待所有訊息傳達後再執行讀取；<!--]--></li><li data-v-4c2f5fb9><!--[-->或從同步更新的副本中進行讀取以確保結果是最新的。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->全序廣播就是確保所有電腦（節點）收到的訊息順序都是一樣的，好比是把訊息按照1、2、3、4的順序發給每台電腦，讓每台電腦都按照這個順序來處理事情。這樣做的好處是，當多人同時要求做某件事（比如同時要求建立同一個使用者名稱的帳戶）時，全序廣播可以確定一個固定的順序來處理這些要求，避免亂七八糟的情況發生。也能確保即便網路有延遲，訊息還是能按照正確的順序被送達和處理。全序廣播也能支援一些特定的操作，比如比較然後設定（CAS），確保這些操作能正確無誤地完成。最後，全序廣播通過讓所有電腦按照相同的順序來處理事情，使得每台電腦的狀態都能保持一致。所以，全序廣播是實現線性一致儲存（讓所有電腦的資料保持一致）的一個重要方法。<!--]--></p><h3 id="使用線性一致性儲存實現全序廣播" data-v-4cf5bb93><a href="#使用線性一致性儲存實現全序廣播" data-v-4cf5bb93><!--[--><strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%bd%bf%e7%94%a8%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%84%b2%e5%ad%98%e5%af%a6%e7%8f%be%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad" rel="nofollow" data-v-692834dd><!--[-->使用線性一致性儲存實現全序廣播<!--]--></a><!--]--></strong><!--]--><!----></a></h3><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->利用線性一致性儲存實現全序廣播的方法<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->利用線性一致的暫存器儲存一個整數，並提供原子的自增並返回操作或原子CAS操作。<!--]--></li><li data-v-4c2f5fb9><!--[-->對於每個要透過全序廣播發送的訊息，首先執行自增並返回操作，獲得一個序列號，然後將此序列號附加到訊息中。<!--]--></li><li data-v-4c2f5fb9><!--[-->之後將訊息傳送到所有節點，收件人按照序列號的順序依序傳遞訊息。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->與蘭伯特時間戳的區別<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->自增線性一致性暫存器獲得的是一個沒有間隙的序列，與蘭伯特時間戳的隨機序列不同，這是全序廣播和時間戳排序間的關鍵區別。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->實現困難<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在單節點情況下實現線性一致性暫存器相對簡單，但在分散式環境中，特別是當節點出錯或網路連接中斷時，實現變得困難。<!--]--></li><li data-v-4c2f5fb9><!--[-->要實現原子性的自增並返回操作，需要深入思考線性一致性的序列號生成器，並可能需要一個共識演算法。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->與共識問題的關聯<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->線性一致的CAS或自增並返回暫存器與全序廣播都與共識問題等價，意味著解決了其中一個問題，就可以轉化為解決其他問題的方案。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->利用線性一致性儲存來做全序廣播就是，先有一個特別的儲存空間，它能夠自動增加一個數字，每當有新訊息要發送時，就先讓這個數字加一，然後把這個數字貼到訊息上，接著把訊息發給所有的電腦節點。這樣，每個電腦節點收到訊息時，就按照貼在訊息上的數字順序來處理它們。如果發現有數字跳號了，就先等一下，直到收到缺的那個訊息。如果在這過程中，有電腦節點出了問題或是網路有問題，也有辦法找回並繼續增加那個數字，保證不會亂掉順序。<!--]--></p><p data-v-9dc9c102><!--[-->兩者比較：<!--]--></p><p data-v-9dc9c102><!--[-->使用全序廣播實現線性一致的儲存，就像是有一個郵差負責把信依照特定的順序送到大家手上，每個人都按照收信的順序來讀信，這樣就保證了大家都有相同的理解。這個郵差就像是全序廣播，他保證信件按照一定的順序送到每個人手上，而每個人的儲存空間就像是他們手中的信件，按照順序來讀和理解。<!--]--></p><p data-v-9dc9c102><!--[-->使用線性一致性儲存實現全序廣播，就像是大家都有一個共用的信箱，每個人都可以在裡面放信，但信箱有一個特殊的鎖，只允許按照一定的順序打開來取信。這個信箱就是線性一致性儲存，它保證大家按照一定的順序來放入和取出信件，而全序廣播就是透過這個信箱來保證信件的順序。<!--]--></p><p data-v-9dc9c102><!--[-->簡單來說，前者是靠郵差（全序廣播）來保證信件順序，讓儲存保持一致；後者是靠信箱（線性一致性儲存）來保證信件順序，進而實現全序廣播。<!--]--></p><p data-v-9dc9c102><!--[-->蘭伯特時間戳VS全序廣播<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant User1 as 使用者1
</span></span><span class="line" line="3"><span>    participant User2 as 使用者2
</span></span><span class="line" line="4"><span>    participant NodeA as 節點A
</span></span><span class="line" line="5"><span>    participant NodeB as 節點B
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span>    Note over User1,User2: 嘗試創建相同的使用者名稱
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span>    User1-&gt;&gt;NodeA: 請求創建帳戶 (使用者名稱: Alice)
</span></span><span class="line" line="10"><span>    User2-&gt;&gt;NodeB: 請求創建帳戶 (使用者名稱: Alice)
</span></span><span class="line" line="11"><span emptylineplaceholder="true">
</span></span><span class="line" line="12"><span>    Note over NodeA,NodeB: 生成蘭伯特時間戳
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span>    NodeA-&gt;&gt;NodeB: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)
</span></span><span class="line" line="15"><span>    Note right of NodeB: 網路延遲
</span></span><span class="line" line="16"><span emptylineplaceholder="true">
</span></span><span class="line" line="17"><span>    NodeB-&gt;&gt;NodeA: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)
</span></span><span class="line" line="18"><span>    Note right of NodeA: 網路延遲
</span></span><span class="line" line="19"><span emptylineplaceholder="true">
</span></span><span class="line" line="20"><span>    Note over NodeA,NodeB: 由於網路問題，節點無法準確比較蘭伯特時間戳，無法確定哪個請求先來。
</span></span><span class="line" line="21"><span emptylineplaceholder="true">
</span></span><span class="line" line="22"><span>    alt 網路恢復
</span></span><span class="line" line="23"><span>        NodeA-&gt;&gt;NodeB: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)
</span></span><span class="line" line="24"><span>        NodeB-&gt;&gt;NodeA: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)
</span></span><span class="line" line="25"><span>        Note over NodeA,NodeB: 現在可以比較蘭伯特時間戳，但已經太遲了。
</span></span><span class="line" line="26"><span>    else 網路未恢復
</span></span><span class="line" line="27"><span>        Note over NodeA,NodeB: 系統被拖至停機，無法解決請求。
</span></span><span class="line" line="28"><span>    end
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant User1 as 使用者1
</span></span><span class="line" line="3"><span>    participant User2 as 使用者2
</span></span><span class="line" line="4"><span>    participant NodeA as 節點A
</span></span><span class="line" line="5"><span>    participant NodeB as 節點B
</span></span><span class="line" line="6"><span>    participant TotalOrderBroadcast as 全序廣播服務
</span></span><span class="line" line="7"><span emptylineplaceholder="true">
</span></span><span class="line" line="8"><span>    Note over User1,User2: 嘗試創建相同的使用者名稱
</span></span><span class="line" line="9"><span emptylineplaceholder="true">
</span></span><span class="line" line="10"><span>    User1-&gt;&gt;NodeA: 請求創建帳戶 (使用者名稱: Alice)
</span></span><span class="line" line="11"><span>    User2-&gt;&gt;NodeB: 請求創建帳戶 (使用者名稱: Alice)
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span>    NodeA-&gt;&gt;TotalOrderBroadcast: 發送創建請求 (使用者名稱: Alice)
</span></span><span class="line" line="14"><span>    NodeB-&gt;&gt;TotalOrderBroadcast: 發送創建請求 (使用者名稱: Alice)
</span></span><span class="line" line="15"><span emptylineplaceholder="true">
</span></span><span class="line" line="16"><span>    Note over TotalOrderBroadcast: 全序廣播服務確保所有節點看到相同順序的消息
</span></span><span class="line" line="17"><span emptylineplaceholder="true">
</span></span><span class="line" line="18"><span>    TotalOrderBroadcast-&gt;&gt;NodeA: 傳遞創建請求 (使用者名稱: Alice, 順序: 1)
</span></span><span class="line" line="19"><span>    TotalOrderBroadcast-&gt;&gt;NodeB: 傳遞創建請求 (使用者名稱: Alice, 順序: 1)
</span></span><span class="line" line="20"><span emptylineplaceholder="true">
</span></span><span class="line" line="21"><span>    TotalOrderBroadcast-&gt;&gt;NodeA: 傳遞創建請求 (使用者名稱: Alice, 順序: 2)
</span></span><span class="line" line="22"><span>    TotalOrderBroadcast-&gt;&gt;NodeB: 傳遞創建請求 (使用者名稱: Alice, 順序: 2)
</span></span><span class="line" line="23"><span emptylineplaceholder="true">
</span></span><span class="line" line="24"><span>    Note over NodeA,NodeB: 節點根據全序廣播服務的順序處理請求
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span>    alt 順序1的請求成功，順序2的請求失敗
</span></span><span class="line" line="27"><span>        NodeA-&gt;&gt;User1: 回應請求成功
</span></span><span class="line" line="28"><span>        NodeB-&gt;&gt;User2: 回應請求失敗
</span></span><span class="line" line="29"><span>    else 順序2的請求成功，順序1的請求失敗
</span></span><span class="line" line="30"><span>        NodeA-&gt;&gt;User1: 回應請求失敗
</span></span><span class="line" line="31"><span>        NodeB-&gt;&gt;User2: 回應請求成功
</span></span><span class="line" line="32"><span>    end
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h2 id="_94-分散式事務與共識" data-v-70b0c1e2><a href="#_94-分散式事務與共識" data-v-70b0c1e2><!--[-->9.4 分散式事務與共識<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->共識：目標是讓幾個節點達成一致<!--]--></p><p data-v-9dc9c102><!--[-->領導選舉：<!--]--></p><p data-v-9dc9c102><!--[-->單主複製的資料庫中所有節點需要與某個領導者達成一致，如果一些節點由於網路而故障可能會對領導權歸屬引起爭議。所以共識對於避免錯誤的故障切換至關重要，錯誤的切換會導致兩個節點都認為自己是領導者(腦裂現象)。<!--]--></p><p data-v-9dc9c102><!--[-->原子提交：<!--]--></p><p data-v-9dc9c102><!--[-->在多節點或多分割槽的資料庫中，為保持事務的原子性（全部提交或全部回滾），所有節點需對事務結果達成共識，此問題稱為原子提交。原子提交與共識稍有區別但可相互簡化，非阻塞的原子提交比共識更為困難。<!--]--></p><h2 id="共識的不可能性" data-v-70b0c1e2><a href="#共識的不可能性" data-v-70b0c1e2><!--[-->共識的不可能性<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->FLP結果指出，在有節點可能崩潰風險的情況下，無法總是達成共識。這個結果是基於非同步系統模型。然而，若演算法能使用超時或其他方法來識別可能崩潰的節點，或者利用隨機數，共識成為可能。儘管FLP展示了理論上的限制，但現實中的分散式系統通常能達成共識。在探討原子提交問題時，兩階段提交（2PC）演算法常被用來解決，它是一種共識演算法，但不是最佳的。通過學習2PC，可以進一步探索更好的一致性演算法，如ZooKeeper的Zab和etcd的Raft。<!--]--></p><h2 id="原子提交與兩階段提交" data-v-70b0c1e2><a href="#原子提交與兩階段提交" data-v-70b0c1e2><!--[-->原子提交與兩階段提交<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->原子性：<!--]--></p><p data-v-9dc9c102><!--[-->事務的方式通常都是用撤銷或丟棄的方式來解決衝突，原子性可以防止失敗的事物攪亂資料庫，避免了資料庫陷入半成品結果與半更新。<!--]--></p><p data-v-9dc9c102><!--[-->這對多物件事務和維護次級索引的資料庫非常重要，每個次級索引都是與主資料分離的資料結構，因此如果修改了一些資料，則還需要在次級索引中進行相應的更改。<!--]--></p><p data-v-9dc9c102><!--[-->原子性可以確保次級索引與主資料庫保持一致。<!--]--></p><h3 id="從單節點到分散式原子提交" data-v-4cf5bb93><a href="#從單節點到分散式原子提交" data-v-4cf5bb93><!--[-->從單節點到分散式原子提交<!--]--><!----></a></h3><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->在單個數據庫節點執行的事務，原子性通常由儲存引擎實現。<!--]--></p><p data-v-9dc9c102><!--[-->當客戶端請求資料庫節點提交事務時，資料庫將使事務的寫入持久化（通常在預寫式日誌中，請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch3?id=%e8%ae%93b%e6%a8%b9%e6%9b%b4%e5%8f%af%e9%9d%a0" rel="nofollow" data-v-692834dd><!--[-->讓 B 樹更可靠<!--]--></a><!--]--></strong>”），然後將提交記錄追加到磁碟中的日誌裡。如果資料庫在這個過程中間崩潰，當節點重啟時，事務會從日誌中恢復：如果提交記錄在崩潰之前成功地寫入磁碟，則認為事務被提交；否則來自該事務的任何寫入都被回滾。<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Client as 客戶端
</span></span><span class="line" line="3"><span>    participant Database as 資料庫節點
</span></span><span class="line" line="4"><span>    participant WAL as 預寫式日誌
</span></span><span class="line" line="5"><span>    participant Disk as 磁碟
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span>    Client-&gt;&gt;Database: 提交事務請求
</span></span><span class="line" line="8"><span>    Database-&gt;&gt;WAL: 寫入事務資料
</span></span><span class="line" line="9"><span>    WAL--&gt;&gt;Database: 確認寫入
</span></span><span class="line" line="10"><span>    Database-&gt;&gt;Disk: 將提交記錄追加到日誌
</span></span><span class="line" line="11"><span>    Disk--&gt;&gt;Database: 確認寫入
</span></span><span class="line" line="12"><span>    Database--&gt;&gt;Client: 提交成功
</span></span><span class="line" line="13"><span emptylineplaceholder="true">
</span></span><span class="line" line="14"><span>    alt 崩潰然後重啟
</span></span><span class="line" line="15"><span>        Database-&gt;&gt;Disk: 檢查日誌
</span></span><span class="line" line="16"><span>        alt 提交記錄已寫入
</span></span><span class="line" line="17"><span>            Disk--&gt;&gt;Database: 事務已提交
</span></span><span class="line" line="18"><span>        else 提交記錄未寫入
</span></span><span class="line" line="19"><span>            Disk--&gt;&gt;Database: 回滾事務
</span></span><span class="line" line="20"><span>        end
</span></span><span class="line" line="21"><span>    end
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->單節點：<!--]--></p><p data-v-9dc9c102><!--[-->事務的提交主要取決於資料持久化落盤的 <strong data-v-84b57b07><!--[-->順序<!--]--></strong>：首先是資料，然後是提交記錄。事務提交或終止的關鍵決定時刻是磁碟完成寫入提交記錄的時刻：在此之前，仍有可能中止（由於崩潰），但在此之後，事務已經提交（即使資料庫崩潰）。因此，是單一的裝置（連線到單個磁碟的控制器，且掛載在單臺機器上）使得提交具有原子性。<!--]--></p><p data-v-9dc9c102><!--[-->多節點：<!--]--></p><p data-v-9dc9c102><!--[-->僅向所有節點發送提交請求並獨立提交每個節點的事務是不夠的。這樣很容易發生違反原子性的情況：提交在某些節點上成功，而在其他節點上失敗：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->某些節點可能會檢測到違反約束或衝突，因此需要中止，而其他節點則可以成功進行提交。假設某個節點已經有某個唯一鍵所以被迫停止某些節點因為沒有違反則成功<!--]--></li><li data-v-4c2f5fb9><!--[-->某些提交請求可能在網路中丟失，最終由於超時而中止，而其他提交請求則通過。順序會有問題<!--]--></li><li data-v-4c2f5fb9><!--[-->在提交記錄完全寫入之前，某些節點可能會崩潰，並在恢復時回滾，而其他節點則成功提交。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->如果某些節點提交了事務，但其他節點卻放棄了這些事務，那麼這些節點就會彼此不一致。而且一旦在某個節點上提交了一個事務，如果事後發現它在其它節點上被中止了，它是無法撤回的。出於這個原因，一旦確定事務中的所有其他節點也將提交，節點就必須進行提交。<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant 節點1
</span></span><span class="line" line="3"><span>    participant 節點2
</span></span><span class="line" line="4"><span>    participant 節點3
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span>    節點1-&gt;&gt;節點2: 嘗試提交事務
</span></span><span class="line" line="7"><span>    節點1-&gt;&gt;節點3: 嘗試提交事務
</span></span><span class="line" line="8"><span>    Note right of 節點3: 事務已提交
</span></span><span class="line" line="9"><span>    節點2-&gt;&gt;節點1: 放棄事務
</span></span><span class="line" line="10"><span>    Note right of 節點1: 事務已放棄
</span></span><span class="line" line="11"><span>    Note left of 節點2: 節點間存在不一致狀態
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->事務提交必須是不可撤銷的 ，事務提交之後，不能改變主意，並追溯性地中止事務。這個規則的原因是，一旦資料被提交，其結果就對其他事務可見，因此其他客戶端可能會開始依賴這些資料。這個原則構成了 <strong data-v-84b57b07><!--[-->讀已提交<!--]--></strong> 隔離等級的基礎，在 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e8%ae%80%e5%b7%b2%e6%8f%90%e4%ba%a4" rel="nofollow" data-v-692834dd><!--[-->讀已提交<!--]--></a><!--]--></strong>” 一節中討論了這個問題。如果一個事務在提交後被允許中止，所有那些讀取了 <strong data-v-84b57b07><!--[-->已提交卻又被追溯宣告不存在資料<!--]--></strong> 的事務也必須回滾。<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant 節點
</span></span><span class="line" line="3"><span>    participant 客戶端1
</span></span><span class="line" line="4"><span>    participant 客戶端2
</span></span><span class="line" line="5"><span emptylineplaceholder="true">
</span></span><span class="line" line="6"><span>    客戶端1-&gt;&gt;節點: 提交事務
</span></span><span class="line" line="7"><span>    Note right of 節點: 事務已提交
</span></span><span class="line" line="8"><span>    節點-&gt;&gt;客戶端2: 通知已提交事務
</span></span><span class="line" line="9"><span>    客戶端2-&gt;&gt;節點: 讀取已提交數據
</span></span><span class="line" line="10"><span>    Note right of 節點: 事務被撤銷（不允許）
</span></span><span class="line" line="11"><span>    節點-&gt;&gt;客戶端1: 通知事務被撤銷（錯誤）
</span></span><span class="line" line="12"><span>    節點-&gt;&gt;客戶端2: 通知事務被撤銷（錯誤）
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->雖然還是有辦法在事務事後執行一個補償機制來取消，但從資料庫的角度，跨事務正確性的保證都必須要是應用自己處理。<!--]--></p><h2 id="兩階段提交簡介" data-v-70b0c1e2><a href="#兩階段提交簡介" data-v-70b0c1e2><!--[-->兩階段提交簡介<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->兩階段提交（two-phase commit）<!--]--></strong> 是一種用於實現跨多個節點的原子事務提交的演算法，即確保所有節點提交或所有節點中止。它是分散式資料庫中的經典演算法。2PC 在某些資料庫內部使用，也以 <strong data-v-84b57b07><!--[-->XA 事務<!--]--></strong> 的形式對應用可用（例如 Java Transaction API 支援）或以 SOAP Web 服務的 <code class="" data-v-2f6bd69d><!--[-->WS-AtomicTransaction<!--]--></code> 形式提供給應用。<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-9.png" alt="說明了 2PC 的基本流程。2PC 中的提交 / 中止過程分為兩個階段（因此而得名），而不是單節點事務中的單個提交請求。" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[-->說明了 2PC 的基本流程。2PC 中的提交 / 中止過程分為兩個階段（因此而得名），而不是單節點事務中的單個提交請求。<!--]--></p><p data-v-9dc9c102><!--[-->使用者經過協調者進行通訊，而協調者會進行兩個步驟<!--]--></p><p data-v-9dc9c102><!--[-->1.先跟節點溝通說要寫入資料<!--]--></p><p data-v-9dc9c102><!--[-->2.問各節點準備好了?<!--]--></p><p data-v-9dc9c102><!--[-->3.認後提交<!--]--></p><p data-v-9dc9c102><!--[-->協調者(事務管理器):<!--]--></p><p data-v-9dc9c102><!--[-->1.通常會在多節點事務出現<!--]--></p><p data-v-9dc9c102><!--[-->2.通常以庫的方式實現(Java EE)，也可以像是程式或是服務的方式Narayana、JOTM、BTM 或 MSDTC。<!--]--></p><p data-v-9dc9c102><!--[-->參與者:<!--]--></p><p data-v-9dc9c102><!--[-->1.資料庫節點在於2PC通常會稱為餐與者<!--]--></p><p data-v-9dc9c102><!--[-->比喻:<!--]--></p><p data-v-9dc9c102><!--[-->西方傳統結婚儀式<!--]--></p><p data-v-9dc9c102><!--[-->1.牧師先問雙方是否要結婚(雙方是否都在)<!--]--></p><p data-v-9dc9c102><!--[-->2.雙方回復”我願意”<!--]--></p><p data-v-9dc9c102><!--[-->3.牧師宣布正式成為夫妻<!--]--></p><h2 id="系統承諾" data-v-70b0c1e2><a href="#系統承諾" data-v-70b0c1e2><!--[-->系統承諾<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->2PC之所以可以保證原子性解說:<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->當應用想要啟動一個分散式事務時，它向協調者請求一個事務 ID。此事務 ID 是全域性唯一的。<!--]--></li><li data-v-4c2f5fb9><!--[-->應用在每個參與者上啟動單節點事務，並在單節點事務上捎帶上這個全域性事務 ID。所有的讀寫都是在這些單節點事務中各自完成的。如果在這個階段出現任何問題（例如，節點崩潰或請求超時），則協調者或任何參與者都可以中止。<!--]--></li><li data-v-4c2f5fb9><!--[-->當應用準備提交時，協調者向所有參與者傳送一個 <strong data-v-84b57b07><!--[-->準備<!--]--></strong> 請求，並打上全域性事務 ID 的標記。如果任意一個請求失敗或超時，則協調者向所有參與者傳送針對該事務 ID 的中止請求。<!--]--></li><li data-v-4c2f5fb9><!--[-->參與者收到準備請求時，需要確保在任意情況下都的確可以提交事務。這包括將所有事務資料寫入磁碟（出現崩潰、電源故障或硬碟空間不足都不能是稍後拒絕提交的理由）以及檢查是否存在任何衝突或違反約束。透過向協調者回答 “是”，節點承諾，只要請求，這個事務一定可以不出差錯地提交。換句話說，參與者放棄了中止事務的權利，但沒有實際提交。<!--]--></li><li data-v-4c2f5fb9><!--[-->當協調者收到所有準備請求的答覆時，會就提交或中止事務作出明確的決定（只有在所有參與者投贊成票的情況下才會提交）。協調者必須把這個決定寫到磁碟上的事務日誌中，如果它隨後就崩潰，恢復後也能知道自己所做的決定。這被稱為 <strong data-v-84b57b07><!--[-->提交點（commit point）<!--]--></strong>。<!--]--></li><li data-v-4c2f5fb9><!--[-->一旦協調者的決定落盤，提交或中止請求會發送給所有參與者。如果這個請求失敗或超時，協調者必須永遠保持重試，直到成功為止。沒有回頭路：如果已經做出決定，不管需要多少次重試它都必須被執行。如果參與者在此期間崩潰，事務將在其恢復後提交 —— 由於參與者投了贊成，因此恢復後它不能拒絕提交。<!--]--></li><!--]--></ol><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant App as 應用
</span></span><span class="line" line="3"><span>    participant Coordinator as 協調者
</span></span><span class="line" line="4"><span>    participant Node1 as 參與者1
</span></span><span class="line" line="5"><span>    participant Node2 as 參與者2
</span></span><span class="line" line="6"><span>    App-&gt;&gt;Coordinator: 請求事務ID
</span></span><span class="line" line="7"><span>    Coordinator-&gt;&gt;App: 返回事務ID
</span></span><span class="line" line="8"><span>    App-&gt;&gt;Node1: 啟動單節點事務(事務ID)
</span></span><span class="line" line="9"><span>    App-&gt;&gt;Node2: 啟動單節點事務(事務ID)
</span></span><span class="line" line="10"><span>    Note over Node1,Node2: 執行事務中...
</span></span><span class="line" line="11"><span>    App-&gt;&gt;Coordinator: 準備提交
</span></span><span class="line" line="12"><span>    Coordinator-&gt;&gt;Node1: 準備請求(事務ID)
</span></span><span class="line" line="13"><span>    Coordinator-&gt;&gt;Node2: 準備請求(事務ID)
</span></span><span class="line" line="14"><span>    Node1-&gt;&gt;Coordinator: 是
</span></span><span class="line" line="15"><span>    Node2-&gt;&gt;Coordinator: 是
</span></span><span class="line" line="16"><span>    Note over Coordinator: 所有參與者都已準備好
</span></span><span class="line" line="17"><span>    Coordinator-&gt;&gt;Coordinator: 決定提交並記錄到事務日誌
</span></span><span class="line" line="18"><span>    Coordinator-&gt;&gt;Node1: 提交請求(事務ID)
</span></span><span class="line" line="19"><span>    Coordinator-&gt;&gt;Node2: 提交請求(事務ID)
</span></span><span class="line" line="20"><span>    Node1-&gt;&gt;Coordinator: 提交成功
</span></span><span class="line" line="21"><span>    Node2-&gt;&gt;Coordinator: 提交成功
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->結論:<!--]--></p><p data-v-9dc9c102><!--[-->2PC可以保證原子性的原因是”協調者追蹤決定並使其不可撤銷”<!--]--></p><p data-v-9dc9c102><!--[-->比喻:<!--]--></p><p data-v-9dc9c102><!--[-->回到西方結婚儀式<!--]--></p><p data-v-9dc9c102><!--[-->1.牧師再問雙方是否要結婚(只要其中一放放棄牧師就不可能會繼續事務)<!--]--></p><p data-v-9dc9c102><!--[-->2.其中有一個人昏倒(沒有聽到&quot;正式宣布成為夫妻”)因為說出我願意了所以還是有效<!--]--></p><p data-v-9dc9c102><!--[-->3.當昏倒的那個人醒來，可以透過查詢牧師的預約日誌查詢是否結婚成功<!--]--></p><h2 id="協調者失效" data-v-70b0c1e2><a href="#協調者失效" data-v-70b0c1e2><!--[-->協調者失效<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->如果任何一個準備請求超時，協調者就會終止事務。如果提交或終止請求失敗。協調者將會無條件重試。<!--]--></p><p data-v-9dc9c102><!--[-->如果再准便前請求失敗，參與者可以安全終止事務，必須等待協調者回復提交終止或是成功，一旦協調者出現網路或是崩潰問題，餐與者就只能傻傻等待。所以參與者對於這種事務狀態稱為存疑或不確定。<!--]--></p><p data-v-9dc9c102><!--[--><img src="https://vonng.github.io/ddia/img/fig9-10.png" alt="圖 9-10 參與者投贊成票後，協調者崩潰。資料庫 1 不知道是否提交或中止" class="prose-img" loading="lazy" data-v-57b8b35b><!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->圖 9-10 參與者投贊成票後，協調者崩潰。資料庫 1 不知道是否提交或中止<!--]--></strong><!--]--></p><p data-v-9dc9c102><!--[-->這張圖說明了協調者在提交部分出現問題導致參與者1只能呆呆的等待，少了協調者的訊息參與者不會知道事務已經提交或是放棄。在這種狀況底下只能等待協調者，所以這就是為什麼參與者需要在提交或終止之前先將”我願意”寫到日誌的原因因為最後的提交還是有可能失敗，任何沒有寫在事務日誌的提交紀錄都會被終止，所以2PC的提交點就是協調者的常規單節點原子原則。<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Coordinator as 協調者
</span></span><span class="line" line="3"><span>    participant Node1 as 參與者1
</span></span><span class="line" line="4"><span>    participant Node2 as 參與者2
</span></span><span class="line" line="5"><span>    participant Log1 as 參與者1日誌
</span></span><span class="line" line="6"><span>    participant LogC as 協調者日誌
</span></span><span class="line" line="7"><span>    
</span></span><span class="line" line="8"><span>    Coordinator-&gt;&gt;Node1: 準備請求(事務ID)
</span></span><span class="line" line="9"><span>    Coordinator-&gt;&gt;Node2: 準備請求(事務ID)
</span></span><span class="line" line="10"><span>    Node1-&gt;&gt;Log1: 寫入&quot;我願意&quot;(事務ID)
</span></span><span class="line" line="11"><span>    Node2-&gt;&gt;Coordinator: 是(事務ID)
</span></span><span class="line" line="12"><span>    Coordinator-&gt;&gt;LogC: 寫入決定:提交(事務ID)
</span></span><span class="line" line="13"><span>    Note over Coordinator: 協調者出現問題，暫時無法通訊
</span></span><span class="line" line="14"><span>    Note over Node1: 等待協調者的提交/中止請求...
</span></span><span class="line" line="15"><span>    Note over Coordinator: 協調者恢復
</span></span><span class="line" line="16"><span>    Coordinator-&gt;&gt;LogC: 讀取事務日誌(事務ID)
</span></span><span class="line" line="17"><span>    Coordinator-&gt;&gt;Node1: 提交請求(事務ID)
</span></span><span class="line" line="18"><span>    Coordinator-&gt;&gt;Node2: 提交請求(事務ID)
</span></span><span class="line" line="19"><span>    Node1-&gt;&gt;Coordinator: 提交成功(事務ID)
</span></span><span class="line" line="20"><span>    Node2-&gt;&gt;Coordinator: 提交成功(事務ID)
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h2 id="三階段提交" data-v-70b0c1e2><a href="#三階段提交" data-v-70b0c1e2><!--[-->三階段提交<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->1.兩階段提交（2PC）被視為阻塞的原子提交協議，因為在協調者故障時會造成參與者的等待。<!--]--></p><p data-v-9dc9c102><!--[-->2.三階段提交（3PC）作為2PC的替代方案，但其有效性依賴於有限的網路延遲和節點響應時間，這在實際系統中不常見。<!--]--></p><p data-v-9dc9c102><!--[-->3.非阻塞原子提交需要完美的故障檢測器以可靠地判斷節點的狀態，但在無限延遲的網路中，超時不是一個可靠的故障檢測機制。<!--]--></p><p data-v-9dc9c102><!--[-->4.由於這些挑戰，2PC仍被使用，儘管存在協調者故障的可能性。<!--]--></p><h2 id="實踐中的分散式事務" data-v-70b0c1e2><a href="#實踐中的分散式事務" data-v-70b0c1e2><!--[-->實踐中的分散式事務<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹:<!--]--></p><p data-v-9dc9c102><!--[-->分散式事務的名聲譭譽參半，尤其是那些透過兩階段提交實現的。一方面，它被視作提供了一個難以實現的重要的安全性保證；另一方面，它們因為導致運維問題，造成效能下降，做出超過能力範圍的承諾而飽受批評。許多雲服務由於其導致的運維問題，而選擇不實現分散式事務。<!--]--></p><p data-v-9dc9c102><!--[-->報告顯示MySQL的分散事務比單節點事務慢了10倍以上，2PC不只需要使用較高的效能大部分時間都是在處理崩潰恢復所需的強制寫入(fsync)與網路往返。<!--]--></p><p data-v-9dc9c102><!--[-->fsync:<!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[--><code class="" data-v-2f6bd69d><!--[-->fsync<!--]--></code><!--]--></strong> 是一個在多種操作系統中使用的系統呼叫，其主要目的是確保指定的文件描述符（file descriptor）所關聯的文件的所有元數據和元信息已經從操作系統的緩衝區寫入到底層存儲系統。當一個程序寫入文件時，操作系統可能會將數據暫時保留在緩衝區中，以便稍後再將它寫入磁碟，以提高效率。然而，在某些情況下，程序可能需要確保數據已經被實際寫入磁碟，以防止在系統崩潰或其他故障情況下失去數據。<!--]--></p><p data-v-9dc9c102><!--[-->分散式事務:<!--]--></p><p data-v-9dc9c102><!--[-->1.資料庫內部的分散式事務<!--]--></p><p data-v-9dc9c102><!--[-->相同的資料庫例如 MySQL Cluster的NDB與VoltDB，所有參與事務的節點都是使用相同的資料庫軟體。<!--]--></p><p data-v-9dc9c102><!--[-->2.異構分散式事務<!--]--></p><p data-v-9dc9c102><!--[-->由兩種或是兩種以上不同技術組成，甚至是非資料庫系統(訊息代理)。跨系統的分散式事務必須要確保原子提交。<!--]--></p><h2 id="恰好一次的訊息處理" data-v-70b0c1e2><a href="#恰好一次的訊息處理" data-v-70b0c1e2><!--[-->恰好一次的訊息處理<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->異構的分散式事務只要能提供提交原子性來視線安全提交並且保證只被處理一次，假設郵件伺服器不支援2PC，如果訊息處理失敗並重試則可能導致重複發送郵件問題，但是如果訊息都可以在事務終止回滾，那這樣處理流程就可以安全地重試而且就好像什麼錯誤都沒有發生過一樣。<!--]--></p><h2 id="xa事務" data-v-70b0c1e2><a href="#xa事務" data-v-70b0c1e2><!--[-->XA事務<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->1.X/Open XA（擴充套件架構，eXtended Architecture）**是一個於1991年推出的標準，旨在通過兩階段提交實現異構技術間的整合，廣泛應用於許多傳統關聯式資料庫和訊息代理中。<!--]--></p><p data-v-9dc9c102><!--[-->2.<strong data-v-84b57b07><!--[-->XA非網路協議，而是一個C API<!--]--></strong>，用於連線至事務協調者。它也有在其他語言例如Java中的實現，如Java事務API (JTA)。<!--]--></p><p data-v-9dc9c102><!--[-->3.<strong data-v-84b57b07><!--[-->事務協調者需實現XA API<!--]--></strong>，通常是作為一個庫載入到發起事務的應用程序中，並使用本地磁碟上的日誌記錄事務的決定（提交/中止）。<!--]--></p><p data-v-9dc9c102><!--[-->4.<strong data-v-84b57b07><!--[-->如果應用程序崩潰，協調者也會失效<!--]--></strong>。必須重啟伺服器並讓協調程序庫讀取日誌以恢復每個事務的提交/中止結果，然後協調者才能要求參與者提交或中止。<!--]--></p><p data-v-9dc9c102><!--[-->5.<strong data-v-84b57b07><!--[-->通訊必須透過客戶端庫<!--]--></strong>，因為資料庫伺服器不能直接聯絡協調者。這意味著所有的事務協調都是通過應用程序進行的。<!--]--></p><p data-v-9dc9c102><!--[-->結論:<!--]--></p><p data-v-9dc9c102><!--[-->XA事務就是一種以API的形式讓許多想要整合不同系統上事務用的通用溝通介面，並保證數據的一致性與完整性。我的認知是XA事務就是多系統的協調者<!--]--></p><p data-v-9dc9c102><!--[-->假設:<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->初始化事務<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->您的應用程序首先會向事務協調者發起一個新的事務。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->準備階段<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->應用程序將執行必要的操作，例如：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在MySQL中插入一條新的記錄。<!--]--></li><li data-v-4c2f5fb9><!--[-->在Redis中設置一個新的key-value對。<!--]--></li><li data-v-4c2f5fb9><!--[-->在RabbitMQ中發布一條新的訊息。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[-->每個系統的操作都會通過XA API告知事務協調者它們已經準備好提交或回滾。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->提交或回滾<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如果所有的操作都成功準備好，事務協調者會告知所有的系統提交事務。<!--]--></li><li data-v-4c2f5fb9><!--[-->如果任何一個操作報告它不能提交，或者在準備階段出現錯誤，事務協調者會告知所有的系統回滾事務。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->結束事務<!--]--></strong><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->一旦所有的系統都報告事務已經被提交或回滾，事務協調者會結束這個事務。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant App as Application
</span></span><span class="line" line="3"><span>    participant TM as Transaction Manager
</span></span><span class="line" line="4"><span>    participant MySQL
</span></span><span class="line" line="5"><span>    participant Redis
</span></span><span class="line" line="6"><span>    participant RabbitMQ
</span></span><span class="line" line="7"><span>    
</span></span><span class="line" line="8"><span>    App-&gt;&gt;TM: Start Transaction
</span></span><span class="line" line="9"><span>    TM-&gt;&gt;MySQL: Prepare
</span></span><span class="line" line="10"><span>    TM-&gt;&gt;Redis: Prepare
</span></span><span class="line" line="11"><span>    TM-&gt;&gt;RabbitMQ: Prepare
</span></span><span class="line" line="12"><span>    MySQL-&gt;&gt;TM: Ready
</span></span><span class="line" line="13"><span>    Redis-&gt;&gt;TM: Ready
</span></span><span class="line" line="14"><span>    RabbitMQ-&gt;&gt;TM: Ready
</span></span><span class="line" line="15"><span>    TM-&gt;&gt;MySQL: Commit
</span></span><span class="line" line="16"><span>    TM-&gt;&gt;Redis: Commit
</span></span><span class="line" line="17"><span>    TM-&gt;&gt;RabbitMQ: Commit
</span></span><span class="line" line="18"><span>    MySQL-&gt;&gt;TM: Acknowledge Commit
</span></span><span class="line" line="19"><span>    Redis-&gt;&gt;TM: Acknowledge Commit
</span></span><span class="line" line="20"><span>    RabbitMQ-&gt;&gt;TM: Acknowledge Commit
</span></span><span class="line" line="21"><span>    TM-&gt;&gt;App: Transaction Completed
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><p data-v-9dc9c102><!--[-->這是我想像中XA事務當作協調者可能會做的事情<!--]--></p><h2 id="懷疑持有鎖" data-v-70b0c1e2><a href="#懷疑持有鎖" data-v-70b0c1e2><!--[-->懷疑持有鎖<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->為什麼我們這麼關心存疑事務？系統的其他部分就不能繼續正常工作，無視那些終將被清理的存疑事務嗎？<!--]--></p><p data-v-9dc9c102><!--[-->1.如果其他部分如果繼續運作會導致髒寫，或是資料不一致性。<!--]--></p><p data-v-9dc9c102><!--[-->2.如果協調者崩潰，事務必須在整個存疑期間持有這個鎖，這可能導致應用大面積不可用，直到存疑事務得到解決。<!--]--></p><p data-v-9dc9c102><!--[-->3.存疑事務是問題的核心，因為它們持有資料庫的鎖，並阻止其他事務訪問相同的資料行。<!--]--></p><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->回到9-9這裡存疑事務並沒有說明的很清楚但是經過查證過後應該是9-9的灰色部分locks held by transaction，在這個狀況底下所有需要使用事務的節點都會被這個鎖卡死。<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant 協調者
</span></span><span class="line" line="3"><span>    participant 資料庫
</span></span><span class="line" line="4"><span>    participant 事務A
</span></span><span class="line" line="5"><span>    participant 事務B
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span>    事務A-&gt;&gt;資料庫: 開始事務, 獲取行鎖
</span></span><span class="line" line="8"><span>    Note right of 資料庫: 行鎖被持有
</span></span><span class="line" line="9"><span>    資料庫--&gt;&gt;協調者: 通知事務A的行鎖
</span></span><span class="line" line="10"><span>    協調者-&gt;&gt;資料庫: 保持行鎖直至提交或中止
</span></span><span class="line" line="11"><span>    事務B-&gt;&gt;資料庫: 開始事務, 嘗試獲取相同行的鎖
</span></span><span class="line" line="12"><span>    Note right of 資料庫: 事務B被阻塞
</span></span><span class="line" line="13"><span>    資料庫--&gt;&gt;協調者: 通知事務B的阻塞
</span></span><span class="line" line="14"><span>    協調者--&gt;&gt;事務A: 請求提交或中止事務
</span></span><span class="line" line="15"><span>    事務A-&gt;&gt;資料庫: 提交事務
</span></span><span class="line" line="16"><span>    資料庫--&gt;&gt;協調者: 通知事務A的提交
</span></span><span class="line" line="17"><span>    協調者-&gt;&gt;資料庫: 釋放事務A的行鎖
</span></span><span class="line" line="18"><span>    Note right of 資料庫: 行鎖被釋放
</span></span><span class="line" line="19"><span>    資料庫--&gt;&gt;事務B: 獲取行鎖, 繼續事務
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><h2 id="從協調者故障中恢復" data-v-70b0c1e2><a href="#從協調者故障中恢復" data-v-70b0c1e2><!--[-->從協調者故障中恢復<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->理論上協調者崩潰後並重新啟動，應該可以從日誌中恢復，並解決所有的存疑事務。然而實際的系統很有可能會產生孤立的事務，孤立事務會出現在協調者無法確認事務結果的狀況發生(例如事務日誌由於軟體錯誤丟失或損壞)。當然這種狀況事務基本上無法自己解決，所以這些鎖就會卡在資料庫中阻塞其他事務。<!--]--></p><p data-v-9dc9c102><!--[-->真正的原因是因為2PC的實踐中即時重新啟動也會保留存疑事務鎖(為了保持原子性保證)，唯一的方式就是讓管理者手動決定提交還是回滾，這時候管理者就要一一去查看存疑事務的參與者(昏倒的那個請他再說一次我願意，或是有點像是git的同一份文件多人修改需要人為解決衝突)。<!--]--></p><p data-v-9dc9c102><!--[-->許多XA的實踐都有一個叫做啟發式決策，允許參與者單方面決定提交或是放棄，無需協調者作出最終決定。但是壞處就是可能破壞了原子性，有趣的是啟發式代表的是可能破壞原子性的委婉說法，啟發式決策只是為了逃出災難性的情況而準備(<del>其實發錢或是發張電影票或許可以解決</del>)。<!--]--></p><h2 id="分散式事務的限制" data-v-70b0c1e2><a href="#分散式事務的限制" data-v-70b0c1e2><!--[-->分散式事務的限制<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->XA事務解決了多個參與者相互一致的實現和重要問題，但也引入了嚴重的維運問題，事務協調者本身就是一種資料庫，因此需要像其他重要資料庫一樣小心操作。<!--]--></p><p data-v-9dc9c102><!--[-->1.如果協調者沒有HA，可能會導致存疑事務鎖死，令人驚訝的是好像很多協調者都沒有HA或者只有基本的複製支援
2.引入協調者後，間接地引入了系統狀態。通常的HTTP服務是無狀態的，但一旦加入了協調者，協調者的日誌就必須持久化以保存系統的狀態。因此，在協調者資料庫崩潰後，必須能夠恢復存疑事務。<!--]--></p><p data-v-9dc9c102><!--[-->3.由於XA協議要兼容多種不同的資料系統，它必須採用所有系統共通的基本機能。例如，XA無法檢測跨不同系統的死鎖，因為這需要一個標準的協議來交換各個事務正在等待的鎖的資訊，而XA並未提供這樣的協議。<!--]--></p><p data-v-9dc9c102><!--[-->4.相對於XA，針對資料庫內部的分散式事務，限制不是那麼嚴格。例如，可以實現分散式版本的SSI。然而，仍然存在一些問題：使用兩階段提交（2PC）成功提交一個事務需要得到所有參與者的回應。所以，如果系統的任何一部分出現故障，事務就會失敗。因此，分散式事務有放大失效（amplifying failures）的風險，這與我們構建容錯系統的目標是相違背的。<!--]--></p><h2 id="容錯共識" data-v-70b0c1e2><a href="#容錯共識" data-v-70b0c1e2><!--[-->容錯共識<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->共識＝多個節點就某個事件達成一致<!--]--></p><p data-v-9dc9c102><!--[-->例如多個人同時嘗試定飛機最後一個位置，共識演算法可以用來確定這些互不相容的操作，最終決定哪一個是贏家<!--]--></p><p data-v-9dc9c102><!--[-->一個或多個節點可以提議某些值，而共識演算法決定採用某個值。<!--]--></p><p data-v-9dc9c102><!--[-->例如：<!--]--></p><p data-v-9dc9c102><!--[-->在訂飛機票的時候，當同時多個客戶嘗試訂購最後一個座位時，處理request的每個節點可以提議將要服務的客戶ID，而決定指明哪個客戶訂到座位<!--]--></p><p data-v-9dc9c102><!--[-->共識演算法必須滿足以下性質：<!--]--></p><p data-v-9dc9c102><!--[-->統一共識，相當於不可靠故障檢測器的非同步系統中的常規共識，學術文獻通常指的是process而不是節點。在這裡使用節點。<!--]--></p><p data-v-9dc9c102><!--[-->屬性解釋：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->一致同意（Uniform agreement）<br>沒有兩個節點的決定不同。<!--]--></li><li data-v-4c2f5fb9><!--[-->完整性（Integrity）<br>沒有節點決定兩次。<!--]--></li><li data-v-4c2f5fb9><!--[-->有效性（Validity）<br>如果一個節點決定了值 <code class="" data-v-2f6bd69d><!--[-->v<!--]--></code> ，則 <code class="" data-v-2f6bd69d><!--[-->v<!--]--></code> 由某個節點所提議。<!--]--></li><li data-v-4c2f5fb9><!--[-->終止（Termination）<br>由所有未崩潰的節點來最終決定值。<!--]--></li><!--]--></ul><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->共識核心屬性<!--]--></strong>：<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在共識演算法的領域中，&quot;一致同意&quot;（Agreement）、&quot;完整性&quot;（Integrity）和&quot;有效性&quot;（Validity）是三個基本的屬性，它們共同定義了一個良好共識演算法的基本要求。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->一致同意（Agreement）<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->這個屬性要求所有非失效的節點必須達成共識，即它們都必須同意同一個值。所有人必須達成相同的決定。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->完整性（Integrity）<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->完整性要求一個值一旦被選定，就不應該被改變。換句話說，每個節點只能接受一個值，並且一旦值被決定，就不能更改。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->有效性（Validity）<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->有效性要求被選定的值必須是由某個節點提議的值，而不應是一個隨意創造的值。這個屬性主要是為了避免某些“偽”解決方案。一個演算法可能始終選擇**<code class="" data-v-2f6bd69d><!--[-->null<!--]--></code>**作為共識值，無論節點們提議了什麼值。這個演算法滿足了一致同意和完整性（因為它始終選擇同一個值並且不會更改它），但它不滿足有效性，因為它選擇的值並不是由節點提議的。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><br>這三個屬性合起來確保了共識演算法的基本要求：所有非失效的節點能夠達成共識，選定一個由節點提議的值，並且一旦這個值被選定，就不能再被更改。這是實現分布式系統一致性的基本框架，並確保了系統的穩定性和可靠性。<br>如果不關心容錯，那麼滿足前三個屬性很容易：你可以將一個節點硬編碼為 “獨裁者”，並讓該節點做出所有的決定。但如果該節點失效，那麼系統就無法再做出任何決定。事實上，這就是我們在兩階段提交的情況中所看到的：如果協調者失效，那麼存疑的參與者就無法決定提交還是中止。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->獨裁者節點與協調者的影響<!--]--></strong>：<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->硬編碼一個節點作為“獨裁者”可以輕易達成共識，但若該節點失效，系統不能做出決定。<!--]--></li><li data-v-4c2f5fb9><!--[-->兩階段提交的情況下，若協調者失效，存疑的參與者不能決定提交還是中止。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->終止屬性與容錯<!--]--></strong>：<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->終止屬性要求共識演算法不能無限期地等待，即使有節點失效，也必須達成決定。<!--]--></li><li data-v-4c2f5fb9><!--[-->終止屬性取決於，不超過一半節點不可用。<!--]--></li><li data-v-4c2f5fb9><!--[-->即使大多數節點失效或網路存在問題，共識的實現仍需保證安全屬性（一致同意，完整性和有效性）。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->拜占庭錯誤((n+1)/3)與共識<!--]--></strong>：<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->大多數共識演算法假設不存在拜占庭錯誤，即節點都會正確遵循協議。<!--]--></li><li data-v-4c2f5fb9><!--[-->穩健地達成共識是可能的，只要少於三分之一的節點存在拜占庭錯誤。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><h2 id="共識演算法和全序廣播" data-v-70b0c1e2><a href="#共識演算法和全序廣播" data-v-70b0c1e2><!--[-->共識演算法和全序廣播<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->最著名的容錯共識演算法是檢視戳複製(VSR, Viewstamped Replication)。但是本書不介紹!!!暸解共通的高階思想就足夠了，除非自己要實現一個共識系統。<!--]--></p><p data-v-9dc9c102><!--[-->大多數的共識演算法實際上並不直接使用剛剛提到的這些模型(提議與決定單個值，並滿足一致同意、完整性、有效性和終止屬性)。取而代之的反而是值的順序，同時也促使了全序廣播演算法。<!--]--></p><p data-v-9dc9c102><!--[-->全序廣播要求將訊息按照相同的順序，恰好傳送一次，準確地送到所有節點。<!--]--></p><p data-v-9dc9c102><!--[-->所以全序廣播相當於重複進行了多輪共識(每次共識決定與一次訊息傳遞相對應)：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->由於 <strong data-v-84b57b07><!--[-->一致同意<!--]--></strong> 屬性，所有節點決定以相同的順序傳遞相同的訊息。<!--]--></li><li data-v-4c2f5fb9><!--[-->由於 <strong data-v-84b57b07><!--[-->完整性<!--]--></strong> 屬性，訊息不會重複。<!--]--></li><li data-v-4c2f5fb9><!--[-->由於 <strong data-v-84b57b07><!--[-->有效性<!--]--></strong> 屬性，訊息不會被損壞，也不能憑空編造。<!--]--></li><li data-v-4c2f5fb9><!--[-->由於 <strong data-v-84b57b07><!--[-->終止<!--]--></strong> 屬性，訊息不會丟失。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->視戳複製，Raft 和 Zab 直接實現了全序廣播，因為這樣做比重複 <strong data-v-84b57b07><!--[-->一次一值（one value a time）<!--]--></strong> 的共識更高效。在 Paxos 的情況下，這種最佳化被稱為 Multi-Paxos。<!--]--></p><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->全序廣播棒棒，支持了共識演算法所需要基本要求一致同意……等等屬性<!--]--></p><h2 id="單主複製與共識" data-v-70b0c1e2><a href="#單主複製與共識" data-v-70b0c1e2><!--[-->單主複製與共識<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->為什麼在第五章沒有擔心過共識問題？因為單主複製將所有操作都交給主庫並以相同的順序丟給從庫，使從庫的副本保持在最新狀態。<!--]--></p><p data-v-9dc9c102><!--[-->如果主庫是由維運人員手動操作那就是一種獨裁型別的共識演算法：只有一個節點被允許接受寫入，如果該節點發生故障，則整個系統無法寫入，直到維運人員處理。這樣的系統在實踐中表現良好，但是無法滿足終止屬性，因為需要人為干預才能取得進展。<!--]--></p><p data-v-9dc9c102><!--[-->某些資料庫會自動執行領導者選舉，但是會導致腦裂，因為領導者之間需要共識演算法。<!--]--></p><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->要有共識演算法要先有領導者，而選出領導者TMD又要有共識演算法所以，先有雞還是先有蛋的問題出現了！<!--]--></p><h2 id="紀元編號和法定人數" data-v-70b0c1e2><a href="#紀元編號和法定人數" data-v-70b0c1e2><!--[-->紀元編號和法定人數<!--]--><!----></a></h2><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者與紀元編號的關係<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->共識協議通常內部有領導者的概念，但不能保證領導者的獨一無二。通過紀元編號（在不同協議中可能有不同名稱）來確保在每個時期，領導者是唯一的。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者選舉<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->當現任領導者被認為失效時，節點間會開始新的領導者選舉，並賦予新的紀元編號，以保證紀元編號的全序且單調遞增。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者衝突的解決<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->若不同時期的領導者之間出現衝突，則以紀元編號較高的領導者為准。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->法定人數<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->一個領導者在做出任何決定前，必須先從法定人數的節點中獲得贊成。通常需要兩輪投票：一輪選出領導者，一輪對領導者的提議進行投票。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->投票過程與2PC的區別<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->這個投票過程與兩階段提交（2PC）相似，但區別在於領導者的產生方式及投票要求。共識演算法只需要多數節點的贊成，並且有明確的恢復過程來保證系統的安全屬性。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->在領導者選拔裡弄了一個更嚴謹的紀元編號與法定人數並讓編號最大的人當選領導者，投票過程就是更嚴謹的2PC<!--]--></p><div class="highlight-mermaid prose-code" meta data-v-a67e2655><!----><!--[--><pre class="language-mermaid shiki shiki-themes github-dark github-light monokai" style=""><!--[--><code><span class="line" line="1"><span>sequenceDiagram
</span></span><span class="line" line="2"><span>    participant Node1
</span></span><span class="line" line="3"><span>    participant Node2
</span></span><span class="line" line="4"><span>    participant Node3
</span></span><span class="line" line="5"><span>    participant Node4
</span></span><span class="line" line="6"><span emptylineplaceholder="true">
</span></span><span class="line" line="7"><span>    Note over Node1,Node4: 初始狀態 (領導者: Node1)
</span></span><span class="line" line="8"><span emptylineplaceholder="true">
</span></span><span class="line" line="9"><span>    alt 領導者失效
</span></span><span class="line" line="10"><span>        Node1-&gt;&gt;Node1: 領導者失效
</span></span><span class="line" line="11"><span>    end
</span></span><span class="line" line="12"><span emptylineplaceholder="true">
</span></span><span class="line" line="13"><span>    Note over Node1,Node4: 紀元編號 1 開始
</span></span><span class="line" line="14"><span emptylineplaceholder="true">
</span></span><span class="line" line="15"><span>    Node2-&gt;&gt;+Node3: 領導者失效，開始領導者選舉 (紀元編號: 1)
</span></span><span class="line" line="16"><span>    Node3-&gt;&gt;+Node2: 投票給 Node2 (紀元編號: 1)
</span></span><span class="line" line="17"><span>    Node4-&gt;&gt;+Node2: 投票給 Node2 (紀元編號: 1)
</span></span><span class="line" line="18"><span emptylineplaceholder="true">
</span></span><span class="line" line="19"><span>    Note over Node2,Node4: Node2 以多數票當選為領導者
</span></span><span class="line" line="20"><span emptylineplaceholder="true">
</span></span><span class="line" line="21"><span>    Node2-&gt;&gt;Node3: 提議值 (紀元編號: 1)
</span></span><span class="line" line="22"><span>    Node2-&gt;&gt;Node4: 提議值 (紀元編號: 1)
</span></span><span class="line" line="23"><span>    Node3-&gt;&gt;Node2: 贊成提議 (紀元編號: 1)
</span></span><span class="line" line="24"><span>    Node4-&gt;&gt;Node2: 贊成提議 (紀元編號: 1)
</span></span><span class="line" line="25"><span emptylineplaceholder="true">
</span></span><span class="line" line="26"><span>    Note over Node2,Node4: 提議值被以多數票接受
</span></span><span class="line" line="27"><span emptylineplaceholder="true">
</span></span><span class="line" line="28"><span>    alt 領導者失效
</span></span><span class="line" line="29"><span>        Node2-&gt;&gt;Node2: 領導者失效
</span></span><span class="line" line="30"><span>    end
</span></span><span class="line" line="31"><span emptylineplaceholder="true">
</span></span><span class="line" line="32"><span>    Note over Node2,Node4: 紀元編號 2 開始
</span></span><span class="line" line="33"><span emptylineplaceholder="true">
</span></span><span class="line" line="34"><span>    alt Node1恢復
</span></span><span class="line" line="35"><span>        Node1-&gt;&gt;Node1: Node1恢復
</span></span><span class="line" line="36"><span>    end
</span></span><span class="line" line="37"><span emptylineplaceholder="true">
</span></span><span class="line" line="38"><span>    Node1-&gt;&gt;+Node3: 領導者失效，開始領導者選舉 (紀元編號: 2)
</span></span><span class="line" line="39"><span>    Node3-&gt;&gt;+Node1: 投票給 Node1 (紀元編號: 2)
</span></span><span class="line" line="40"><span>    Node4-&gt;&gt;+Node1: 投票給 Node1 (紀元編號: 2)
</span></span><span class="line" line="41"><span emptylineplaceholder="true">
</span></span><span class="line" line="42"><span>    Note over Node1,Node4: Node1 以多數票當選為領導者
</span></span><span class="line" line="43"><span emptylineplaceholder="true">
</span></span><span class="line" line="44"><span>    Node1-&gt;&gt;Node3: 提議值 (紀元編號: 2)
</span></span><span class="line" line="45"><span>    Node1-&gt;&gt;Node4: 提議值 (紀元編號: 2)
</span></span><span class="line" line="46"><span>    Node3-&gt;&gt;Node1: 贊成提議 (紀元編號: 2)
</span></span><span class="line" line="47"><span>    Node4-&gt;&gt;Node1: 贊成提議 (紀元編號: 2)
</span></span><span class="line" line="48"><span emptylineplaceholder="true">
</span></span><span class="line" line="49"><span>    Note over Node1,Node4: 提議值被以多數票接受
</span></span><span class="line" line="50"><span>alt Node2恢復
</span></span><span class="line" line="51"><span>        Node2-&gt;&gt;Node2: Node2恢復
</span></span><span class="line" line="52"><span>    end
</span></span><span class="line" line="53"><span>    alt 領導者衝突的解決
</span></span><span class="line" line="54"><span>        Node2-&gt;&gt;Node1: 嘗試成為領導者 (紀元編號: 2)
</span></span><span class="line" line="55"><span>        Node1-&gt;&gt;Node2: 以更高的紀元編號解決衝突 (紀元編號: 3)
</span></span><span class="line" line="56"><span>    end
</span></span><span class="line" line="57"><span emptylineplaceholder="true">
</span></span><span class="line" line="58"><span>    Note over Node1,Node4: Node1 保持為領導者
</span></span></code><!--]--></pre><!--]--><button class="copy-button" data-v-a67e2655 data-v-4a003820><span class="sr-only" data-v-4a003820>Copy to clipboard</span><span class="icon-wrapper" data-v-4a003820><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-4a003820 style="" width="18px" height="18px" viewBox="0 0 256 256" data-v-e610b8e3><path fill="currentColor" d="M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z"/></svg></span></button></div><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->初始狀態<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->系統初始時，Node1 是領導者。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者失效 (Node1)<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node1 失效，系統進入紀元編號1。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者選舉 (紀元編號 1)<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node2、Node3 和 Node4 開始領導者選舉。Node3 和 Node4 投票給 Node2，Node2 以多數票當選為新的領導者。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->提議和投票 (紀元編號 1)<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node2 提出一個提議值，並得到 Node3 和 Node4 的贊成，提議值被多數票接受。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者失效 (Node2)<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node2 失效，系統進入紀元編號2。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Node1恢復<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node1 恢復並參與接下來的領導者選舉。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者選舉 (紀元編號 2)<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node1、Node3 和 Node4 開始領導者選舉。Node3 和 Node4 投票給 Node1，Node1 以多數票當選為新的領導者。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->提議和投票 (紀元編號 2)<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node1 提出一個提議值，並得到 Node3 和 Node4 的贊成，提議值被多數票接受。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->Node2恢復<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node2 恢復並嘗試重新成為領導者。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者衝突的解決<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->Node2 嘗試在紀元編號2成為領導者，但 Node1 以更高的紀元編號（3）回應，以解決領導者衝突，並保持為領導者。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><h2 id="共識的局限性" data-v-70b0c1e2><a href="#共識的局限性" data-v-70b0c1e2><!--[-->共識的局限性<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->共識演算法為分散式系統提供了基本的安全屬性，如一致同意、完整性和有效性，並在多數節點正常運作時保持容錯和進展。但它有其侷限性：<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->同步複製問題<!--]--></strong>：共識演算法依賴同步複製來確保一致性，與常見的非同步複製相比，可能會在效能上有所損失。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->節點數量要求<!--]--></strong>：至少需要三個節點以容忍單節點故障，五個節點以容忍兩個節點故障。如果網路故障導致節點間連線中斷，只有多數節點所在的網路能繼續運作。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->固定節點集合<!--]--></strong>：多數共識演算法假設參與投票的節點是固定的，雖然有動態成員擴充套件，但理解和實施較為困難。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->超時檢測的依賴<!--]--></strong>：共識系統依賴超時來檢測失效節點，但在網路延遲高度變化的環境中可能會導致錯誤的失效檢測和領導者選舉，影響效能。<!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->對網路問題的敏感性<!--]--></strong>：例如，Raft 在特定的網路連線不可靠時可能會出現領導者頻繁切換的問題，影響系統進展。這類問題在其他一致性演算法中也存在，而設計能夠健壯應對不可靠網路的演算法仍是開放的研究領域。<!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->Raft：<!--]--></p><p data-v-9dc9c102><!--[--><strong data-v-84b57b07><!--[-->Raft<!--]--></strong>是一種用於替代<a href="https://zh.wikipedia.org/wiki/Paxos" rel="nofollow" data-v-692834dd><!--[-->Paxos<!--]--></a>的<a href="https://zh.wikipedia.org/wiki/%E5%85%B1%E8%AD%98%E6%A9%9F%E5%88%B6" rel="nofollow" data-v-692834dd><!--[-->共識<!--]--></a>演算法。相比於<a href="https://zh.wikipedia.org/wiki/Paxos" rel="nofollow" data-v-692834dd><!--[-->Paxos<!--]--></a>，Raft的目標是提供更清晰的邏輯分工使得演算法本身能被更好地理解，同時它安全性更高，並能提供一些額外的特性。<a href="https://zh.wikipedia.org/wiki/Raft#cite_note-raft-1" rel="nofollow" data-v-692834dd><!--[-->[1]<!--]--></a><a href="https://zh.wikipedia.org/wiki/Raft#cite_note-raft-paper-2" rel="nofollow" data-v-692834dd><!--[-->[2]<!--]--></a>:1Raft能為在<a href="https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%9B%86%E7%BE%A4" rel="nofollow" data-v-692834dd><!--[-->電腦叢集<!--]--></a>之間部署<a href="https://zh.wikipedia.org/wiki/%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA" rel="nofollow" data-v-692834dd><!--[-->有限狀態機<!--]--></a>提供一種通用方法，並確保叢集內的任意節點在某種狀態轉換上保持一致。Raft演算法的開源實現眾多，在<a href="https://zh.wikipedia.org/wiki/Go" rel="nofollow" data-v-692834dd><!--[-->Go<!--]--></a>、<a href="https://zh.wikipedia.org/wiki/C%2B%2B" rel="nofollow" data-v-692834dd><!--[-->C++<!--]--></a>、<a href="https://zh.wikipedia.org/wiki/Java" rel="nofollow" data-v-692834dd><!--[-->Java<!--]--></a>以及 <a href="https://zh.wikipedia.org/wiki/Scala" rel="nofollow" data-v-692834dd><!--[-->Scala<!--]--></a>中都有完整的代碼實現。Raft這一名字來源於&quot;Reliable, Replicated, Redundant, And Fault-Tolerant&quot;（「可靠、可複製、可冗餘、可容錯」）的首字母縮寫。<a href="https://zh.wikipedia.org/wiki/Raft#cite_note-3" rel="nofollow" data-v-692834dd><!--[-->[3]<!--]--></a><!--]--></p><p data-v-9dc9c102><!--[-->叢集內的節點都對選舉出的領袖採取信任，因此Raft不是一種<a href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98" rel="nofollow" data-v-692834dd><!--[-->拜占庭容錯<!--]--></a>演算法。<a href="https://zh.wikipedia.org/wiki/Raft#cite_note-raft-paper-2" rel="nofollow" data-v-692834dd><!--[-->[2]<!--]--></a><!--]--></p><p data-v-9dc9c102><!--[-->拜占庭將軍問題：<!--]--></p><p data-v-9dc9c102><!--[-->一組<a href="https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B8%9D%E5%9C%8B" rel="nofollow" data-v-692834dd><!--[-->拜占庭<!--]--></a>將軍分別各率領一支軍隊共同圍困一座城市。為了簡化問題，將各支軍隊的行動策略限定為進攻或撤離兩種。因為部分軍隊進攻部分軍隊撤離可能會造成災難性後果，因此各位將軍必須通過投票來達成一致策略，即所有軍隊一起進攻或所有軍隊一起撤離。因為各位將軍分處城市不同方向，他們只能通過信使互相聯絡。在投票過程中每位將軍都將自己投票給進攻還是撤退的資訊通過信使分別通知其他所有將軍，這樣一來每位將軍根據自己的投票和其他所有將軍送來的資訊就可以知道共同的投票結果而決定行動策略。<!--]--></p><h2 id="成員與協調服務" data-v-70b0c1e2><a href="#成員與協調服務" data-v-70b0c1e2><!--[-->成員與協調服務<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->介紹：<!--]--></p><p data-v-9dc9c102><!--[-->ZooKeeper 和 etcd 被設計為容納少量完全可以放在記憶體中的資料（雖然它們仍然會寫入磁碟以保證永續性），所以你不會想著把所有應用資料放到這裡。這些少量資料會透過容錯的全序廣播演算法複製到所有節點上。正如前面所討論的那樣，資料庫複製需要的就是全序廣播：如果每條訊息代表對資料庫的寫入，則以相同的順序應用相同的寫入操作可以使副本之間保持一致。<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->線性一致性的原子操作<br>使用原子 CAS 操作可以實現鎖：如果多個節點同時嘗試執行相同的操作，只有一個節點會成功。共識協議保證了操作的原子性和線性一致性，即使節點發生故障或網路在任意時刻中斷。分散式鎖通常以 <strong data-v-84b57b07><!--[-->租約（lease）<!--]--></strong> 的形式實現，租約有一個到期時間，以便在客戶端失效的情況下最終能被釋放（請參閱 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e7%a8%8b%e5%ba%8f%e6%9a%ab%e5%81%9c" rel="nofollow" data-v-692834dd><!--[-->程序暫停<!--]--></a><!--]--></strong>”）。<!--]--></li><li data-v-4c2f5fb9><!--[-->操作的全序排序<br>如 “<strong data-v-84b57b07><!--[--><a href="https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e9%a0%98%e5%b0%8e%e8%80%85%e5%92%8c%e9%8e%96" rel="nofollow" data-v-692834dd><!--[-->領導者和鎖<!--]--></a><!--]--></strong>” 中所述，當某個資源受到鎖或租約的保護時，你需要一個防護令牌來防止客戶端在程序暫停的情況下彼此衝突。防護令牌是每次鎖被獲取時單調增加的數字。ZooKeeper 透過全序化所有操作來提供這個功能，它為每個操作提供一個單調遞增的事務 ID（<code class="" data-v-2f6bd69d><!--[-->zxid<!--]--></code>）和版本號（<code class="" data-v-2f6bd69d><!--[-->cversion<!--]--></code>）【15】。<!--]--></li><li data-v-4c2f5fb9><!--[-->失效檢測<br>客戶端在 ZooKeeper 伺服器上維護一個長期會話，客戶端和伺服器週期性地交換心跳包來檢查節點是否還活著。即使連線暫時中斷，或者 ZooKeeper 節點失效，會話仍保持在活躍狀態。但如果心跳停止的持續時間超出會話超時，ZooKeeper 會宣告該會話已死亡。當會話超時時（ZooKeeper 稱這些節點為 <strong data-v-84b57b07><!--[-->臨時節點<!--]--></strong>，即 ephemeral nodes），會話持有的任何鎖都可以配置為自動釋放。<!--]--></li><li data-v-4c2f5fb9><!--[-->變更通知<br>客戶端不僅可以讀取其他客戶端建立的鎖和值，還可以監聽它們的變更。因此，客戶端可以知道另一個客戶端何時加入叢集（基於新客戶端寫入 ZooKeeper 的值），或發生故障（因其會話超時，而其臨時節點消失）。透過訂閱通知，客戶端不用再透過頻繁輪詢的方式來找出變更。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->在這些功能中，只有線性一致的原子操作才真的需要共識。但正是這些功能的組合，使得像 ZooKeeper 這樣的系統在分散式協調中非常有用。<!--]--></p><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->在使用分散式資料庫時其實要考慮哪些資訊是必須線性一致性的，如果需要線性一致性的資料再放入像是ZooKeeper這種分散式資料庫保證線性一致性的原子操作。或是說如果是最終一致性的內容就不需要放到這種分散式資料庫的架構讓node之間彼此慢慢溝通就好了。<!--]--></p><h2 id="將工作分配給節點" data-v-70b0c1e2><a href="#將工作分配給節點" data-v-70b0c1e2><!--[-->將工作分配給節點<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->ZooKeeper/Chubby 模型執行良好的一個例子是，如果你有幾個程序例項或服務，需要選擇其中一個例項作為主庫或首選服務。如果領導者失敗，其他節點之一應該接管。這對單主資料庫當然非常實用，但對作業排程程式和類似的有狀態系統也很好用。<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者選舉與失敗恢復<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->ZooKeeper或Chubby模型可以用於選擇主節點或首選服務，並在主節點失效時由其他節點接管，這在單主資料庫、作業排程系統和其他有狀態系統中非常實用。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資源分割槽的分配與再平衡<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->通過使用ZooKeeper，可以決定將哪個分割槽分配給哪個節點，並在新節點加入或節點失效時重新平衡負載。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->原子操作、臨時節點與通知<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->ZooKeeper提供了原子操作、臨時節點和通知功能，有助於實現分割槽的再平衡和失效節點的工作接管，並能讓系統自動從故障中恢復。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->高層工具的支援<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->例如Apache Curator，它是基於ZooKeeper客戶端API而提供更高層的工具，降低了從頭實現共識演算法的困難和風險。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->協調節點的外包<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->ZooKeeper允許在固定數量的節點上執行多數票選舉，而非在數千個節點上，並“外包”一些協調節點的工作，如共識、操作排序和故障檢測，以支援大量的客戶端。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->資料型別的緩慢變化<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->ZooKeeper適合管理變化緩慢的資料，而不是每秒會改變數千或數百萬次的執行時狀態資料。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->其他工具的配合<!--]--></strong>：
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->如Apache BookKeeper，可以用於複製應用狀態，與ZooKeeper配合使用，提供更完整的分散式系統解決方案。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><p data-v-9dc9c102><!--[-->結論：<!--]--></p><p data-v-9dc9c102><!--[-->各種工具特性與應用方式<!--]--></p><h2 id="服務發現" data-v-70b0c1e2><a href="#服務發現" data-v-70b0c1e2><!--[-->服務發現<!--]--><!----></a></h2><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->服務發現<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->ZooKeeper、etcd 和 Consul 常用於服務發現，即確定連接到特定服務所需的 IP 地址。在雲資料中心，由於虛擬機器的動態性，服務的 IP 地址通常不是事先知道的。服務可配置為在啟動時註冊其網路端點，以便其他服務能夠找到它們。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->共識與服務發現<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->服務發現不一定需要共識，而是更重視可用性和對網路中斷的魯棒性。傳統上，DNS 用於查詢服務的 IP 地址，並通過多層快取來提高效能和可用性，它不保證線性一致性。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者選舉<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->與服務發現不同，領導者選舉需要共識。如果共識系統已經識別出領導者，這些資訊可以用於幫助其他服務找出領導者。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->只讀快取副本<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->一些共識系統支援只讀快取副本，這些副本能非同步接收共識演算法的所有決策日誌，但不參與投票，從而能夠處理不需要線性一致性的讀取請求，降低了需求共識的情境，同時保持了系統的效能與可用性。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><h2 id="成員資格服務" data-v-70b0c1e2><a href="#成員資格服務" data-v-70b0c1e2><!--[-->成員資格服務<!--]--><!----></a></h2><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->成員資格服務的核心功能<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->它主要用於確定哪些節點目前是活動的，並且是叢集的活動成員。由於無限的網路延遲，無法可靠地檢測到另一個節點是否失效，但通過共識，節點可以達成一致意見，決定哪些節點應被認為是存在或不存在。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->共識在故障檢測中的角色<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->透過共識來進行故障檢測可以協助節點就哪些節點是存在或不存在達成一致。雖然可能會有節點被錯誤地宣告死亡，但對系統來說，知道哪些節點是當前的成員是非常有用的。<!--]--></li><!--]--></ul><!--]--></li><li data-v-4c2f5fb9><!--[--><strong data-v-84b57b07><!--[-->領導者選舉與成員資格<!--]--></strong>:
<ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->在選擇領導者時，例如可能簡單地選擇當前成員中編號最小的成員。但如果不同的節點對現有成員有不同的意見，這種方法將不起作用。成員資格服務確保節點對叢集的現有成員有一致的理解，從而促進了有效的領導者選舉。<!--]--></li><!--]--></ul><!--]--></li><!--]--></ol><h2 id="_95-本章小結" data-v-70b0c1e2><a href="#_95-本章小結" data-v-70b0c1e2><!--[-->9.5 本章小結<!--]--><!----></a></h2><p data-v-9dc9c102><!--[-->達成共識意味著以這樣一種方式決定某件事：所有節點一致同意所做決定，且這一決定不可撤銷。透過深入挖掘，結果我們發現很廣泛的一系列問題實際上都可以歸結為共識問題，並且彼此等價（從這個意義上來講，如果你有其中之一的解決方案，就可以輕易將它轉換為其他問題的解決方案）。這些等價的問題包括：<!--]--></p><ul data-v-5bd61aad><!--[--><li data-v-4c2f5fb9><!--[-->線性一致性的 CAS 暫存器<br>暫存器需要基於當前值是否等於操作給出的引數，原子地 <strong data-v-84b57b07><!--[-->決定<!--]--></strong> 是否設定新值。<!--]--></li><li data-v-4c2f5fb9><!--[-->原子事務提交<br>資料庫必須 <strong data-v-84b57b07><!--[-->決定<!--]--></strong> 是否提交或中止分散式事務。<!--]--></li><li data-v-4c2f5fb9><!--[-->全序廣播<br>訊息系統必須 <strong data-v-84b57b07><!--[-->決定<!--]--></strong> 傳遞訊息的順序。<!--]--></li><li data-v-4c2f5fb9><!--[-->鎖和租約<br>當幾個客戶端爭搶鎖或租約時，由鎖來 <strong data-v-84b57b07><!--[-->決定<!--]--></strong> 哪個客戶端成功獲得鎖。<!--]--></li><li data-v-4c2f5fb9><!--[-->成員 / 協調服務<br>給定某種故障檢測器（例如超時），系統必須 <strong data-v-84b57b07><!--[-->決定<!--]--></strong> 哪些節點活著，哪些節點因為會話超時需要被宣告死亡。<!--]--></li><li data-v-4c2f5fb9><!--[-->唯一性約束<br>當多個事務同時嘗試使用相同的鍵建立衝突記錄時，約束必須 <strong data-v-84b57b07><!--[-->決定<!--]--></strong> 哪一個被允許，哪些因為違反約束而失敗。<!--]--></li><!--]--></ul><p data-v-9dc9c102><!--[-->如果領導者失效，或者如果網路中斷導致領導者不可達，這樣的系統就無法取得任何進展。應對這種情況可以有三種方法：<!--]--></p><ol data-v-e6ab85be><!--[--><li data-v-4c2f5fb9><!--[-->等待領導者恢復，接受系統將在這段時間阻塞的事實。許多 XA/JTA 事務協調者選擇這個選項。這種方法並不能完全達成共識，因為它不能滿足 <strong data-v-84b57b07><!--[-->終止<!--]--></strong> 屬性的要求：如果領導者續命失敗，系統可能會永久阻塞。<!--]--></li><li data-v-4c2f5fb9><!--[-->人工故障切換，讓人類選擇一個新的領導者節點，並重新配置系統使之生效，許多關係型資料庫都採用這種方方式。這是一種來自 “天意” 的共識 —— 由計算機系統之外的運維人員做出決定。故障切換的速度受到人類行動速度的限制，通常要比計算機慢（得多）。<!--]--></li><li data-v-4c2f5fb9><!--[-->使用演算法自動選擇一個新的領導者。這種方法需要一種共識演算法，使用成熟的演算法來正確處理惡劣的網路條件是明智之舉【107】。<!--]--></li><!--]--></ol><style>html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}</style></div><!--]--><!--]--><!--[--><div class="docs-page-bottom" data-v-a6339876 data-v-70e24a2d><div class="edit-link" data-v-70e24a2d><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-70e24a2d style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="currentColor" d="M21 12a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H5a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1m-15 .76V17a1 1 0 0 0 1 1h4.24a1 1 0 0 0 .71-.29l6.92-6.93L21.71 8a1 1 0 0 0 0-1.42l-4.24-4.29a1 1 0 0 0-1.42 0l-2.82 2.83l-6.94 6.93a1 1 0 0 0-.29.71m10.76-8.35l2.83 2.83l-1.42 1.42l-2.83-2.83ZM8 13.17l5.93-5.93l2.83 2.83L10.83 16H8Z"/></svg><!--[--><a href="https://github.com/codesensegroup/code-study/edit/master/content/5.ddia/9.chapter9.md" rel="noopener noreferrer" data-v-70e24a2d data-v-692834dd><!--[--><span data-v-70e24a2d> 在GitHub上在編輯此頁面 </span><!--]--></a><!--]--></div></div><div class="docs-prev-next" data-v-a6339876 data-v-30e1aea1><a href="/code-study/ddia/chapter5" class="prev" data-v-30e1aea1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-30e1aea1 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m11 17l-5-5m0 0l5-5m-5 5h12"/></svg><div class="wrapper" data-v-30e1aea1><span class="directory" data-v-30e1aea1>Ddia</span><span class="title" data-v-30e1aea1>05 複製</span></div></a><a href="/code-study/clean-arch/chapter1" class="next" data-v-30e1aea1><div class="wrapper" data-v-30e1aea1><span class="directory" data-v-30e1aea1>Clean Arch</span><span class="title" data-v-30e1aea1>01 什麼是設計與結構</span></div><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-30e1aea1 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m13 7l5 5m0 0l-5 5m5-5H6"/></svg></a></div><!--]--></article><div class="toc" data-v-a6339876><div class="toc-wrapper" data-v-a6339876><button data-v-a6339876><span class="title" data-v-a6339876>Table of Contents</span><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-a6339876 style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m9 5l7 7l-7 7"/></svg></button><div class="docs-toc-wrapper" data-v-a6339876><div class="docs-toc" data-v-a6339876 data-v-ebd2b6b2><!--[--><div class="docs-toc-title" data-v-ebd2b6b2><span data-v-ebd2b6b2>Table of Contents</span></div><ul class="docs-toc-links" data-v-ebd2b6b2 data-v-a97df893><!--[--><li class="depth-2" data-v-a97df893><a href="#一致性與共識" class="" data-v-a97df893>一致性與共識</a><!----></li><li class="depth-2" data-v-a97df893><a href="#目錄" class="" data-v-a97df893>目錄</a><!----></li><li class="depth-2" data-v-a97df893><a href="#_91-一致性保證" class="" data-v-a97df893>9.1 一致性保證</a><!----></li><li class="depth-2" data-v-a97df893><a href="#_92-線性一致性" class="" data-v-a97df893>9.2 線性一致性</a><!----></li><li class="depth-2" data-v-a97df893><a href="#是什麼東西可以讓系統線性一致" class="" data-v-a97df893>是什麼東西可以讓系統線性一致**？**</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#test" class="" data-v-a97df893>test</a><!----></li><li class="depth-3" data-v-a97df893><a href="#第七章cascompare-and-swap的解釋-補全" class="" data-v-a97df893>第七章CAS(Compare and Swap)的解釋 *補全</a><!----></li><li class="depth-3" data-v-a97df893><a href="#test-1" class="" data-v-a97df893>test</a><!----></li><li class="depth-3" data-v-a97df893><a href="#test-2" class="" data-v-a97df893>test</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#依賴線性一致性" class="" data-v-a97df893>依賴線性一致性</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#鎖定和領導選舉" class="" data-v-a97df893>鎖定和領導選舉</a><!----></li><li class="depth-3" data-v-a97df893><a href="#約束和唯一性保證" class="" data-v-a97df893>約束和唯一性保證</a><!----></li><li class="depth-3" data-v-a97df893><a href="#跨通道的時序依賴" class="" data-v-a97df893>跨通道的時序依賴</a><!----></li><li class="depth-3" data-v-a97df893><a href="#第五章read-your-writes-consistency-補全" class="" data-v-a97df893>第五章Read-Your-Writes Consistency ~~*補全~~</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#實現線性一致的系統" class="" data-v-a97df893>實現線性一致的系統</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#線性一致性和法定人數" class="" data-v-a97df893>線性一致性和法定人數</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#線性一致性的代價" class="" data-v-a97df893>線性一致性的代價</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#cap定理" class="" data-v-a97df893>CAP定理</a><!----></li><li class="depth-3" data-v-a97df893><a href="#線性一致性和網路延遲" class="" data-v-a97df893>線性一致性和網路延遲</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#_93-順序保證" class="" data-v-a97df893>9.3 順序保證</a><!----></li><li class="depth-2" data-v-a97df893><a href="#順序與因果關係因果一致性-causally-consistent" class="" data-v-a97df893>順序與因果關係(因果一致性 causally consistent)</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#因果順序不是全序的" class="" data-v-a97df893>因果順序不是全序的</a><!----></li><li class="depth-3" data-v-a97df893><a href="#線性一致性強於因果一致性" class="" data-v-a97df893>線性一致性強於因果一致性</a><!----></li><li class="depth-3" data-v-a97df893><a href="#捕獲因果關係" class="" data-v-a97df893>捕獲因果關係</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#序列號順序" class="" data-v-a97df893>序列號順序</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#非因果序列號生成器" class="" data-v-a97df893>非因果序列號生成器</a><!----></li><li class="depth-3" data-v-a97df893><a href="#蘭伯特時間戳" class="" data-v-a97df893>蘭伯特時間戳</a><!----></li><li class="depth-3" data-v-a97df893><a href="#光有時間戳排序還不夠" class="" data-v-a97df893>光有時間戳排序還不夠</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#全序廣播" class="" data-v-a97df893>全序廣播</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#使用全序廣播" class="" data-v-a97df893>使用全序廣播</a><!----></li><li class="depth-3" data-v-a97df893><a href="#使用全序廣播實現線性一致的儲存" class="" data-v-a97df893>使用全序廣播實現線性一致的儲存</a><!----></li><li class="depth-3" data-v-a97df893><a href="#使用線性一致性儲存實現全序廣播" class="" data-v-a97df893>使用線性一致性儲存實現全序廣播</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#_94-分散式事務與共識" class="" data-v-a97df893>9.4 分散式事務與共識</a><!----></li><li class="depth-2" data-v-a97df893><a href="#共識的不可能性" class="" data-v-a97df893>共識的不可能性</a><!----></li><li class="depth-2" data-v-a97df893><a href="#原子提交與兩階段提交" class="" data-v-a97df893>原子提交與兩階段提交</a><ul class="docs-toc-links" data-v-a97df893 data-v-a97df893><!--[--><li class="depth-3" data-v-a97df893><a href="#從單節點到分散式原子提交" class="" data-v-a97df893>從單節點到分散式原子提交</a><!----></li><!--]--></ul></li><li class="depth-2" data-v-a97df893><a href="#兩階段提交簡介" class="" data-v-a97df893>兩階段提交簡介</a><!----></li><li class="depth-2" data-v-a97df893><a href="#系統承諾" class="" data-v-a97df893>系統承諾</a><!----></li><li class="depth-2" data-v-a97df893><a href="#協調者失效" class="" data-v-a97df893>協調者失效</a><!----></li><li class="depth-2" data-v-a97df893><a href="#三階段提交" class="" data-v-a97df893>三階段提交</a><!----></li><li class="depth-2" data-v-a97df893><a href="#實踐中的分散式事務" class="" data-v-a97df893>實踐中的分散式事務</a><!----></li><li class="depth-2" data-v-a97df893><a href="#恰好一次的訊息處理" class="" data-v-a97df893>恰好一次的訊息處理</a><!----></li><li class="depth-2" data-v-a97df893><a href="#xa事務" class="" data-v-a97df893>XA事務</a><!----></li><li class="depth-2" data-v-a97df893><a href="#懷疑持有鎖" class="" data-v-a97df893>懷疑持有鎖</a><!----></li><li class="depth-2" data-v-a97df893><a href="#從協調者故障中恢復" class="" data-v-a97df893>從協調者故障中恢復</a><!----></li><li class="depth-2" data-v-a97df893><a href="#分散式事務的限制" class="" data-v-a97df893>分散式事務的限制</a><!----></li><li class="depth-2" data-v-a97df893><a href="#容錯共識" class="" data-v-a97df893>容錯共識</a><!----></li><li class="depth-2" data-v-a97df893><a href="#共識演算法和全序廣播" class="" data-v-a97df893>共識演算法和全序廣播</a><!----></li><li class="depth-2" data-v-a97df893><a href="#單主複製與共識" class="" data-v-a97df893>單主複製與共識</a><!----></li><li class="depth-2" data-v-a97df893><a href="#紀元編號和法定人數" class="" data-v-a97df893>紀元編號和法定人數</a><!----></li><li class="depth-2" data-v-a97df893><a href="#共識的局限性" class="" data-v-a97df893>共識的局限性</a><!----></li><li class="depth-2" data-v-a97df893><a href="#成員與協調服務" class="" data-v-a97df893>成員與協調服務</a><!----></li><li class="depth-2" data-v-a97df893><a href="#將工作分配給節點" class="" data-v-a97df893>將工作分配給節點</a><!----></li><li class="depth-2" data-v-a97df893><a href="#服務發現" class="" data-v-a97df893>服務發現</a><!----></li><li class="depth-2" data-v-a97df893><a href="#成員資格服務" class="" data-v-a97df893>成員資格服務</a><!----></li><li class="depth-2" data-v-a97df893><a href="#_95-本章小結" class="" data-v-a97df893>9.5 本章小結</a><!----></li><!--]--></ul><!--]--></div></div></div></div><button class="reading-mode-toggle" aria-label="進入閱讀模式" title="進入閱讀模式 (F)" data-v-a6339876 data-v-ef98344c><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="icon" data-v-ef98344c style="" width="1em" height="1em" viewBox="0 0 24 24" data-v-e610b8e3><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18s-3.332.477-4.5 1.253"/></svg></button><!--]--></div></div><!--]--></main><footer class="h-20 relative w-full z-20 text-center flex flex-col items-center justify-center" data-v-5c2f7786 data-v-47825797><div class="font-light" data-v-47825797>© 2022 Code Sense</div><div class="busuanzi flex" data-v-47825797><span class="flex" id="busuanzi_container_site_uv" data-v-47825797><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 20 20" fill="currentColor" class="mt-1 mr-1 w-4 h-4" data-v-47825797><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><span class="site-uv" title="訪客總數" data-v-47825797><span id="busuanzi_value_site_uv" data-v-47825797></span></span></span><span class="mx-2" data-v-47825797>|</span><span class="flex" id="busuanzi_container_site_pv" data-v-47825797><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 20 20" fill="currentColor" class="mt-1 mr-1 w-4 h-4" data-v-47825797><path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path></svg><span class="site-pv" title="總瀏覽次數" data-v-47825797><span id="busuanzi_value_site_pv" data-v-47825797></span></span></span></div></footer></div></div><div id="teleports"></div><script type="application/json" data-nuxt-data="nuxt-app" data-ssr="true" id="__NUXT_DATA__" data-src="/code-study/ddia/chapter9/_payload.json?8cb8952e-8b29-4692-9461-5c70d236bedc">[{"state":1,"once":11750,"_errors":11751,"serverRendered":5,"path":11,"prerenderedAt":11754},["Reactive",2],{"$scolor-mode":3,"$sdd-pages":7,"$sdd-surrounds":11489,"$sdd-globals":11512,"$sdd-navigation":11514,"$sicons":11715,"$sreading-mode":6,"$sasideScroll":11741,"$sdocus-docs-aside-collapse-map-/":11742,"$sdocus-docs-aside-collapse-map-/sdi-aig":11743,"$sdocus-docs-aside-collapse-map-/clean-arch":11744,"$sdocus-docs-aside-collapse-map-/ddia":11745,"$sdocus-docs-aside-collapse-map-/cicd-2.0":11746,"$sdocus-docs-aside-collapse-map-/web-api":11747,"$sdocus-docs-aside-collapse-map-/workshop":11748,"$sdocus-docs-aside-collapse-map-/api":11749},{"preference":4,"value":4,"unknown":5,"forced":6},"system",true,false,["ShallowRef",8],["ShallowReactive",9],{"/ddia/chapter9":10},{"_path":11,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":14,"description":13,"pageTitle":15,"contributors":16,"body":18,"_type":11482,"_id":11483,"_source":11484,"_file":11485,"_stem":11486,"_extension":11487,"layout":11488},"/ddia/chapter9","ddia","","09 一致性與共識","Chapter 09 一致性與共識",[17],"tomoffice",{"type":19,"children":20,"toc":11413},"root",[21,29,35,40,130,136,142,147,152,290,296,301,306,337,346,353,358,363,368,373,379,383,388,396,403,408,412,417,423,1619,1623,1628,1636,1643,1647,1652,1660,1667,1671,1676,1681,1686,1697,1711,1716,1928,1933,1938,1943,1948,2152,2157,2162,2456,2461,3808,3813,3817,3822,3835,3840,3853,3872,3910,3923,3928,3940,3945,3953,3960,3964,3969,3974,3979,3984,3989,3994,3999,4004,4016,4029,4034,4042,4049,4053,4058,4063,4068,4073,4078,4083,4087,4092,4108,4336,4349,4353,4358,4366,4373,4377,4382,4406,4410,4415,4420,4424,4429,4468,4476,4483,4487,4492,4497,4501,4506,4520,4524,4529,4549,4554,4559,4564,4569,4574,4579,4584,4589,4594,4612,4625,4630,4635,4640,4645,4650,4656,4660,4665,4762,4778,5029,5033,5055,5068,5078,5083,5088,5141,5370,5389,5525,5538,5543,5548,5553,5558,5563,5592,5596,5601,5614,5632,5637,5642,5647,5740,5753,5758,6293,6306,6311,6319,6326,6331,6336,6341,6346,6351,6434,6439,6452,6457,6462,6467,6688,6751,6755,6772,6783,6787,6863,6868,6873,6878,6883,6888,6893,6906,7011,7024,7130,7134,7139,7152,7238,7242,7247,7252,7257,7262,7267,7272,7474,7720,7726,7730,7735,7740,7745,7750,7755,7760,7764,7769,7774,7778,7783,7788,7793,7798,7803,7807,7812,7829,8000,8005,8017,8022,8027,8045,8050,8143,8173,8274,8279,8284,8288,8313,8321,8325,8330,8335,8340,8345,8350,8355,8360,8365,8370,8375,8380,8385,8390,8395,8400,8405,8452,8626,8631,8636,8640,8645,8650,8655,8660,8665,8670,8675,8683,8690,8695,8853,8858,8863,8868,8873,8878,8883,8888,8893,8898,8903,8917,8922,8927,8932,8937,8942,8947,8952,8958,8963,8975,8987,8999,9011,9015,9020,9025,9120,9293,9298,9303,9308,9313,9318,9323,9327,9332,9489,9494,9499,9504,9516,9521,9526,9531,9536,9541,9546,9550,9555,9560,9565,9569,9574,9579,9584,9589,9647,9806,9811,9816,9821,9826,9831,9879,9891,9895,9900,9905,9910,9915,9920,9924,9929,9934,10023,10027,10032,10481,10653,10658,10663,10716,10721,10832,10851,10856,10870,10875,10879,10884,10980,10985,10989,10994,10999,11004,11126,11130,11135,11140,11209,11214,11268,11274,11279,11378,11383,11407],{"type":22,"tag":23,"props":24,"children":26},"element","h1",{"id":25},"設計資料密集型應用-ch9",[27],{"type":28,"value":25},"text",{"type":22,"tag":30,"props":31,"children":33},"h2",{"id":32},"一致性與共識",[34],{"type":28,"value":32},{"type":22,"tag":30,"props":36,"children":38},{"id":37},"目錄",[39],{"type":28,"value":37},{"type":22,"tag":41,"props":42,"children":43},"ul",{},[44,63,78,93,112],{"type":22,"tag":45,"props":46,"children":47},"li",{},[48,50],{"type":28,"value":49},"9.1 ",{"type":22,"tag":51,"props":52,"children":53},"strong",{},[54],{"type":22,"tag":55,"props":56,"children":60},"a",{"href":57,"rel":58},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%b8%80%e8%87%b4%e6%80%a7%e4%bf%9d%e8%ad%89",[59],"nofollow",[61],{"type":28,"value":62},"一致性保證",{"type":22,"tag":45,"props":64,"children":65},{},[66,68],{"type":28,"value":67},"9.2 ",{"type":22,"tag":51,"props":69,"children":70},{},[71],{"type":22,"tag":55,"props":72,"children":75},{"href":73,"rel":74},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7",[59],[76],{"type":28,"value":77},"線性一致性",{"type":22,"tag":45,"props":79,"children":80},{},[81,83],{"type":28,"value":82},"9.3 ",{"type":22,"tag":51,"props":84,"children":85},{},[86],{"type":22,"tag":55,"props":87,"children":90},{"href":88,"rel":89},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%a0%86%e5%ba%8f%e4%bf%9d%e8%ad%89",[59],[91],{"type":28,"value":92},"順序保證",{"type":22,"tag":45,"props":94,"children":95},{},[96,98],{"type":28,"value":97},"9.4 ",{"type":22,"tag":51,"props":99,"children":100},{},[101],{"type":22,"tag":55,"props":102,"children":105},{"href":103,"rel":104},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%88%86%e6%95%a3%e5%bc%8f%e4%ba%8b%e5%8b%99%e8%88%87%e5%85%b1%e8%ad%98",[59],[106],{"type":22,"tag":107,"props":108,"children":109},"del",{},[110],{"type":28,"value":111},"分散式事務與共識",{"type":22,"tag":45,"props":113,"children":114},{},[115,117],{"type":28,"value":116},"9.5 ",{"type":22,"tag":51,"props":118,"children":119},{},[120],{"type":22,"tag":55,"props":121,"children":124},{"href":122,"rel":123},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e6%9c%ac%e7%ab%a0%e5%b0%8f%e7%b5%90",[59],[125],{"type":22,"tag":107,"props":126,"children":127},{},[128],{"type":28,"value":129},"本章小結",{"type":22,"tag":30,"props":131,"children":133},{"id":132},"_91-一致性保證",[134],{"type":28,"value":135},"9.1 一致性保證",{"type":22,"tag":137,"props":138,"children":139},"p",{},[140],{"type":28,"value":141},"大多數複製的資料庫至少提供了最終一致性，這意味著如果你停止向資料庫寫入資料並等待一段不確定的時間，那麼最終所有的讀取請求都會返回相同的值。換句話說，不一致性是暫時的，最終會自行解決（假設網路中的任何故障最終都會被修復。",{"type":22,"tag":137,"props":143,"children":144},{},[145],{"type":28,"value":146},"對於應用開發人員而言，最終一致性是很困難的，因為它與普通單執行緒程式中變數的行為有很大區別。如果將一個值賦給一個變數，然後很快地再次讀取，不可能讀到舊的值，或者讀取失敗。資料庫表面上看起來像一個你可以讀寫的變數，但實際上它有更複雜的語義。",{"type":22,"tag":137,"props":148,"children":149},{},[150],{"type":28,"value":151},"我們在使用弱一致性的資料庫時必須了解弱一致性的局限性,因為錯誤常常很難找到也很難測試，因為應用可能在大多數情況下執行良好。當系統出現故障（例如網路中斷）或高併發時，最終一致性的邊緣情況才會顯現出來。",{"type":22,"tag":153,"props":154,"children":155},"table",{},[156,178],{"type":22,"tag":157,"props":158,"children":159},"thead",{},[160],{"type":22,"tag":161,"props":162,"children":163},"tr",{},[164,168,173],{"type":22,"tag":165,"props":166,"children":167},"th",{},[],{"type":22,"tag":165,"props":169,"children":170},{},[171],{"type":28,"value":172},"強一致性",{"type":22,"tag":165,"props":174,"children":175},{},[176],{"type":28,"value":177},"弱一致性",{"type":22,"tag":179,"props":180,"children":181},"tbody",{},[182,201,219,237,255,272],{"type":22,"tag":161,"props":183,"children":184},{},[185,191,196],{"type":22,"tag":186,"props":187,"children":188},"td",{},[189],{"type":28,"value":190},"解釋",{"type":22,"tag":186,"props":192,"children":193},{},[194],{"type":28,"value":195},"強一至性表示，一旦一個操作（如寫入）完成，該操作的效果會立即反映在接下來所有的讀取操作上，無論這些讀取操作是從哪個節點發出的。",{"type":22,"tag":186,"props":197,"children":198},{},[199],{"type":28,"value":200},"在弱一至性模型下，寫入操作的效果可能不會立即反映在隨後的讀取操作中，特別是來自其他節點的讀取操作。",{"type":22,"tag":161,"props":202,"children":203},{},[204,209,214],{"type":22,"tag":186,"props":205,"children":206},{},[207],{"type":28,"value":208},"例子",{"type":22,"tag":186,"props":210,"children":211},{},[212],{"type":28,"value":213},"假設你在銀行轉帳，當錢從一個帳戶轉到另一個帳戶後，不管是你自己還是其他任何人，只要查詢餘額，都會立即看到最新的數字。",{"type":22,"tag":186,"props":215,"children":216},{},[217],{"type":28,"value":218},"假設你更新了你的社交媒體狀態。你的朋友可能會在幾秒鐘後或幾分鐘後才看到這個更新，取決於各種因素（如網絡延遲、緩存等）。",{"type":22,"tag":161,"props":220,"children":221},{},[222,227,232],{"type":22,"tag":186,"props":223,"children":224},{},[225],{"type":28,"value":226},"模型",{"type":22,"tag":186,"props":228,"children":229},{},[230],{"type":28,"value":231},"線性一致性(linearizability)最強",{"type":22,"tag":186,"props":233,"children":234},{},[235],{"type":28,"value":236},"最終一致性(Eventual Consistency)",{"type":22,"tag":161,"props":238,"children":239},{},[240,245,250],{"type":22,"tag":186,"props":241,"children":242},{},[243],{"type":28,"value":244},"容錯性",{"type":22,"tag":186,"props":246,"children":247},{},[248],{"type":28,"value":249},"少",{"type":22,"tag":186,"props":251,"children":252},{},[253],{"type":28,"value":254},"高",{"type":22,"tag":161,"props":256,"children":257},{},[258,263,267],{"type":22,"tag":186,"props":259,"children":260},{},[261],{"type":28,"value":262},"所需資源",{"type":22,"tag":186,"props":264,"children":265},{},[266],{"type":28,"value":254},{"type":22,"tag":186,"props":268,"children":269},{},[270],{"type":28,"value":271},"低",{"type":22,"tag":161,"props":273,"children":274},{},[275,280,285],{"type":22,"tag":186,"props":276,"children":277},{},[278],{"type":28,"value":279},"實踐",{"type":22,"tag":186,"props":281,"children":282},{},[283],{"type":28,"value":284},"易",{"type":22,"tag":186,"props":286,"children":287},{},[288],{"type":28,"value":289},"難",{"type":22,"tag":30,"props":291,"children":293},{"id":292},"_92-線性一致性",[294],{"type":28,"value":295},"9.2 線性一致性",{"type":22,"tag":137,"props":297,"children":298},{},[299],{"type":28,"value":300},"介紹：",{"type":22,"tag":137,"props":302,"children":303},{},[304],{"type":28,"value":305},"在最終一致的資料庫，如果你在同一時刻問兩個不同副本相同的問題，可能會得到兩個不同的答案。這很讓人困惑。如果資料庫可以提供只有一個副本的假象（即，只有一個數據副本），那麼事情就簡單太多了。每個客戶端都會有相同的資料檢視，且不必擔心複製滯後了。",{"type":22,"tag":137,"props":307,"children":308},{},[309,311,316,318,323,325,330,332],{"type":28,"value":310},"這種抽象的想法也稱為",{"type":22,"tag":51,"props":312,"children":313},{},[314],{"type":28,"value":315},"原子一致性（atomic consistency）",{"type":28,"value":317},"【7】，",{"type":22,"tag":51,"props":319,"children":320},{},[321],{"type":28,"value":322},"強一致性（strong consistency）",{"type":28,"value":324},"，",{"type":22,"tag":51,"props":326,"children":327},{},[328],{"type":28,"value":329},"立即一致性（immediate consistency）",{"type":28,"value":331}," 或 ",{"type":22,"tag":51,"props":333,"children":334},{},[335],{"type":28,"value":336},"外部一致性（external consistency ）",{"type":22,"tag":137,"props":338,"children":339},{},[340],{"type":22,"tag":341,"props":342,"children":345},"img",{"alt":343,"src":344},"圖 9-1 這個系統是非線性一致的，導致了球迷的困惑","https://vonng.github.io/ddia/img/fig9-1.png",[],{"type":22,"tag":137,"props":347,"children":348},{},[349],{"type":22,"tag":51,"props":350,"children":351},{},[352],{"type":28,"value":343},{"type":22,"tag":137,"props":354,"children":355},{},[356],{"type":28,"value":357},"描述：",{"type":22,"tag":137,"props":359,"children":360},{},[361],{"type":28,"value":362},"計分員成功寫入德國獲勝到Leader",{"type":22,"tag":137,"props":364,"children":365},{},[366],{"type":28,"value":367},"Leader開始寫入Foll1 Foll2",{"type":22,"tag":137,"props":369,"children":370},{},[371],{"type":28,"value":372},"Alice用手機看到德國贏了然後Bob因為Leader寫入的時間差以為比賽還在進行",{"type":22,"tag":30,"props":374,"children":376},{"id":375},"是什麼東西可以讓系統線性一致",[377],{"type":28,"value":378},"是什麼東西可以讓系統線性一致**？**",{"type":22,"tag":137,"props":380,"children":381},{},[382],{"type":28,"value":300},{"type":22,"tag":137,"props":384,"children":385},{},[386],{"type":28,"value":387},"真正的想法就是如何讓操作多個資料庫像在單一操作一個資料庫一樣",{"type":22,"tag":137,"props":389,"children":390},{},[391],{"type":22,"tag":341,"props":392,"children":395},{"alt":393,"src":394},"圖 9-2 如果讀取請求與寫入請求併發，則可能會返回舊值或新值","https://vonng.github.io/ddia/img/fig9-2.png",[],{"type":22,"tag":137,"props":397,"children":398},{},[399],{"type":22,"tag":51,"props":400,"children":401},{},[402],{"type":28,"value":393},{"type":22,"tag":137,"props":404,"children":405},{},[406],{"type":28,"value":407},"x稱為暫存器,可以是鍵或是資料庫的行或是資料庫的一個文件",{"type":22,"tag":137,"props":409,"children":410},{},[411],{"type":28,"value":357},{"type":22,"tag":137,"props":413,"children":414},{},[415],{"type":28,"value":416},"A與B會在C寫入中產生不確定性",{"type":22,"tag":418,"props":419,"children":421},"h3",{"id":420},"test",[422],{"type":28,"value":420},{"type":22,"tag":424,"props":425,"children":429},"pre",{"className":426,"code":427,"language":428,"meta":13,"style":13},"language-go shiki shiki-themes github-dark github-light monokai","package main\n\nimport (\n    \"log\"\n    \"math/rand\"\n    \"sync\"\n    \"time\"\n)\n\ntype DB struct {\n    Value int\n}\ntype Client struct {\n    Name string\n    wg   *sync.WaitGroup\n}\n\nfunc (c *Client) Read(db *DB) {\n    defer c.wg.Done()\n    for i := 0; i \u003C 3; i++ {\n        time.Sleep(time.Millisecond * time.Duration(rand.Intn(10)))\n        log.Printf(\"%s x=%d %v \\n\", c.Name, db.Value, time.Now().UnixMilli())\n    }\n}\n\nfunc (c *Client) Write(db *DB, i int) {\n    defer c.wg.Done()\n    time.Sleep(time.Millisecond * time.Duration(rand.Intn(10)))\n    db.Value = i\n}\n\nfunc main() {\n    rand.Seed(time.Now().UnixNano())\n    wg := &sync.WaitGroup{}\n\n    wg.Add(3)\n    db := &DB{Value: 0}\n    clientA := &Client{Name: \"ClientA\", wg: wg}\n    clientB := &Client{Name: \"ClientB\", wg: wg}\n    clientC := &Client{Name: \"ClientC\", wg: wg}\n\n    go clientA.Read(db)\n    go clientB.Read(db)\n    go clientC.Write(db, 1)\n\n    wg.Wait()\n}\n/*\n2023/09/01 17:34:13 ClientA x=0 1693560853277 \n2023/09/01 17:34:13 ClientA x=0 1693560853278 \n2023/09/01 17:34:13 ClientB x=0 1693560853278 \n2023/09/01 17:34:13 ClientA x=0 1693560853283 \n2023/09/01 17:34:13 ClientB x=1 1693560853288 \n2023/09/01 17:34:13 ClientB x=1 1693560853298\n*/\n","go",[430],{"type":22,"tag":431,"props":432,"children":433},"code",{"__ignoreMap":13},[434,452,461,476,497,514,531,548,557,565,589,604,613,634,648,676,684,692,757,781,835,892,969,978,986,994,1062,1082,1131,1150,1158,1166,1184,1220,1256,1264,1291,1326,1362,1396,1430,1438,1461,1482,1513,1521,1538,1546,1556,1565,1574,1583,1592,1601,1610],{"type":22,"tag":435,"props":436,"children":439},"span",{"class":437,"line":438},"line",1,[440,446],{"type":22,"tag":435,"props":441,"children":443},{"style":442},"--shiki-dark:#F97583;--shiki-default:#D73A49;--shiki-sepia:#F92672",[444],{"type":28,"value":445},"package",{"type":22,"tag":435,"props":447,"children":449},{"style":448},"--shiki-dark:#B392F0;--shiki-dark-text-decoration:inherit;--shiki-default:#6F42C1;--shiki-default-text-decoration:inherit;--shiki-sepia:#A6E22E;--shiki-sepia-text-decoration:underline",[450],{"type":28,"value":451}," main\n",{"type":22,"tag":435,"props":453,"children":455},{"class":437,"line":454},2,[456],{"type":22,"tag":435,"props":457,"children":458},{"emptyLinePlaceholder":5},[459],{"type":28,"value":460},"\n",{"type":22,"tag":435,"props":462,"children":464},{"class":437,"line":463},3,[465,470],{"type":22,"tag":435,"props":466,"children":467},{"style":442},[468],{"type":28,"value":469},"import",{"type":22,"tag":435,"props":471,"children":473},{"style":472},"--shiki-dark:#E1E4E8;--shiki-default:#24292E;--shiki-sepia:#F8F8F2",[474],{"type":28,"value":475}," (\n",{"type":22,"tag":435,"props":477,"children":479},{"class":437,"line":478},4,[480,486,492],{"type":22,"tag":435,"props":481,"children":483},{"style":482},"--shiki-dark:#9ECBFF;--shiki-default:#032F62;--shiki-sepia:#E6DB74",[484],{"type":28,"value":485},"    \"",{"type":22,"tag":435,"props":487,"children":489},{"style":488},"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#E6DB74",[490],{"type":28,"value":491},"log",{"type":22,"tag":435,"props":493,"children":494},{"style":482},[495],{"type":28,"value":496},"\"\n",{"type":22,"tag":435,"props":498,"children":500},{"class":437,"line":499},5,[501,505,510],{"type":22,"tag":435,"props":502,"children":503},{"style":482},[504],{"type":28,"value":485},{"type":22,"tag":435,"props":506,"children":507},{"style":488},[508],{"type":28,"value":509},"math/rand",{"type":22,"tag":435,"props":511,"children":512},{"style":482},[513],{"type":28,"value":496},{"type":22,"tag":435,"props":515,"children":517},{"class":437,"line":516},6,[518,522,527],{"type":22,"tag":435,"props":519,"children":520},{"style":482},[521],{"type":28,"value":485},{"type":22,"tag":435,"props":523,"children":524},{"style":488},[525],{"type":28,"value":526},"sync",{"type":22,"tag":435,"props":528,"children":529},{"style":482},[530],{"type":28,"value":496},{"type":22,"tag":435,"props":532,"children":534},{"class":437,"line":533},7,[535,539,544],{"type":22,"tag":435,"props":536,"children":537},{"style":482},[538],{"type":28,"value":485},{"type":22,"tag":435,"props":540,"children":541},{"style":488},[542],{"type":28,"value":543},"time",{"type":22,"tag":435,"props":545,"children":546},{"style":482},[547],{"type":28,"value":496},{"type":22,"tag":435,"props":549,"children":551},{"class":437,"line":550},8,[552],{"type":22,"tag":435,"props":553,"children":554},{"style":472},[555],{"type":28,"value":556},")\n",{"type":22,"tag":435,"props":558,"children":560},{"class":437,"line":559},9,[561],{"type":22,"tag":435,"props":562,"children":563},{"emptyLinePlaceholder":5},[564],{"type":28,"value":460},{"type":22,"tag":435,"props":566,"children":568},{"class":437,"line":567},10,[569,574,579,584],{"type":22,"tag":435,"props":570,"children":571},{"style":442},[572],{"type":28,"value":573},"type",{"type":22,"tag":435,"props":575,"children":576},{"style":448},[577],{"type":28,"value":578}," DB",{"type":22,"tag":435,"props":580,"children":581},{"style":442},[582],{"type":28,"value":583}," struct",{"type":22,"tag":435,"props":585,"children":586},{"style":472},[587],{"type":28,"value":588}," {\n",{"type":22,"tag":435,"props":590,"children":592},{"class":437,"line":591},11,[593,598],{"type":22,"tag":435,"props":594,"children":595},{"style":472},[596],{"type":28,"value":597},"    Value ",{"type":22,"tag":435,"props":599,"children":601},{"style":600},"--shiki-dark:#F97583;--shiki-dark-font-style:inherit;--shiki-default:#D73A49;--shiki-default-font-style:inherit;--shiki-sepia:#66D9EF;--shiki-sepia-font-style:italic",[602],{"type":28,"value":603},"int\n",{"type":22,"tag":435,"props":605,"children":607},{"class":437,"line":606},12,[608],{"type":22,"tag":435,"props":609,"children":610},{"style":472},[611],{"type":28,"value":612},"}\n",{"type":22,"tag":435,"props":614,"children":616},{"class":437,"line":615},13,[617,621,626,630],{"type":22,"tag":435,"props":618,"children":619},{"style":442},[620],{"type":28,"value":573},{"type":22,"tag":435,"props":622,"children":623},{"style":448},[624],{"type":28,"value":625}," Client",{"type":22,"tag":435,"props":627,"children":628},{"style":442},[629],{"type":28,"value":583},{"type":22,"tag":435,"props":631,"children":632},{"style":472},[633],{"type":28,"value":588},{"type":22,"tag":435,"props":635,"children":637},{"class":437,"line":636},14,[638,643],{"type":22,"tag":435,"props":639,"children":640},{"style":472},[641],{"type":28,"value":642},"    Name ",{"type":22,"tag":435,"props":644,"children":645},{"style":600},[646],{"type":28,"value":647},"string\n",{"type":22,"tag":435,"props":649,"children":651},{"class":437,"line":650},15,[652,657,662,666,671],{"type":22,"tag":435,"props":653,"children":654},{"style":472},[655],{"type":28,"value":656},"    wg   ",{"type":22,"tag":435,"props":658,"children":659},{"style":442},[660],{"type":28,"value":661},"*",{"type":22,"tag":435,"props":663,"children":664},{"style":448},[665],{"type":28,"value":526},{"type":22,"tag":435,"props":667,"children":668},{"style":472},[669],{"type":28,"value":670},".",{"type":22,"tag":435,"props":672,"children":673},{"style":448},[674],{"type":28,"value":675},"WaitGroup\n",{"type":22,"tag":435,"props":677,"children":679},{"class":437,"line":678},16,[680],{"type":22,"tag":435,"props":681,"children":682},{"style":472},[683],{"type":28,"value":612},{"type":22,"tag":435,"props":685,"children":687},{"class":437,"line":686},17,[688],{"type":22,"tag":435,"props":689,"children":690},{"emptyLinePlaceholder":5},[691],{"type":28,"value":460},{"type":22,"tag":435,"props":693,"children":695},{"class":437,"line":694},18,[696,701,706,712,716,721,726,732,737,742,747,752],{"type":22,"tag":435,"props":697,"children":698},{"style":442},[699],{"type":28,"value":700},"func",{"type":22,"tag":435,"props":702,"children":703},{"style":472},[704],{"type":28,"value":705}," (",{"type":22,"tag":435,"props":707,"children":709},{"style":708},"--shiki-dark:#FFAB70;--shiki-dark-font-style:inherit;--shiki-default:#E36209;--shiki-default-font-style:inherit;--shiki-sepia:#FD971F;--shiki-sepia-font-style:italic",[710],{"type":28,"value":711},"c ",{"type":22,"tag":435,"props":713,"children":714},{"style":442},[715],{"type":28,"value":661},{"type":22,"tag":435,"props":717,"children":718},{"style":448},[719],{"type":28,"value":720},"Client",{"type":22,"tag":435,"props":722,"children":723},{"style":472},[724],{"type":28,"value":725},") ",{"type":22,"tag":435,"props":727,"children":729},{"style":728},"--shiki-dark:#B392F0;--shiki-default:#6F42C1;--shiki-sepia:#A6E22E",[730],{"type":28,"value":731},"Read",{"type":22,"tag":435,"props":733,"children":734},{"style":472},[735],{"type":28,"value":736},"(",{"type":22,"tag":435,"props":738,"children":739},{"style":708},[740],{"type":28,"value":741},"db",{"type":22,"tag":435,"props":743,"children":744},{"style":442},[745],{"type":28,"value":746}," *",{"type":22,"tag":435,"props":748,"children":749},{"style":448},[750],{"type":28,"value":751},"DB",{"type":22,"tag":435,"props":753,"children":754},{"style":472},[755],{"type":28,"value":756},") {\n",{"type":22,"tag":435,"props":758,"children":760},{"class":437,"line":759},19,[761,766,771,776],{"type":22,"tag":435,"props":762,"children":763},{"style":442},[764],{"type":28,"value":765},"    defer",{"type":22,"tag":435,"props":767,"children":768},{"style":472},[769],{"type":28,"value":770}," c.wg.",{"type":22,"tag":435,"props":772,"children":773},{"style":728},[774],{"type":28,"value":775},"Done",{"type":22,"tag":435,"props":777,"children":778},{"style":472},[779],{"type":28,"value":780},"()\n",{"type":22,"tag":435,"props":782,"children":784},{"class":437,"line":783},20,[785,790,795,800,806,811,816,821,826,831],{"type":22,"tag":435,"props":786,"children":787},{"style":442},[788],{"type":28,"value":789},"    for",{"type":22,"tag":435,"props":791,"children":792},{"style":472},[793],{"type":28,"value":794}," i ",{"type":22,"tag":435,"props":796,"children":797},{"style":442},[798],{"type":28,"value":799},":=",{"type":22,"tag":435,"props":801,"children":803},{"style":802},"--shiki-dark:#79B8FF;--shiki-default:#005CC5;--shiki-sepia:#AE81FF",[804],{"type":28,"value":805}," 0",{"type":22,"tag":435,"props":807,"children":808},{"style":472},[809],{"type":28,"value":810},"; i ",{"type":22,"tag":435,"props":812,"children":813},{"style":442},[814],{"type":28,"value":815},"\u003C",{"type":22,"tag":435,"props":817,"children":818},{"style":802},[819],{"type":28,"value":820}," 3",{"type":22,"tag":435,"props":822,"children":823},{"style":472},[824],{"type":28,"value":825},"; i",{"type":22,"tag":435,"props":827,"children":828},{"style":442},[829],{"type":28,"value":830},"++",{"type":22,"tag":435,"props":832,"children":833},{"style":472},[834],{"type":28,"value":588},{"type":22,"tag":435,"props":836,"children":838},{"class":437,"line":837},21,[839,844,849,854,858,863,868,873,878,882,887],{"type":22,"tag":435,"props":840,"children":841},{"style":472},[842],{"type":28,"value":843},"        time.",{"type":22,"tag":435,"props":845,"children":846},{"style":728},[847],{"type":28,"value":848},"Sleep",{"type":22,"tag":435,"props":850,"children":851},{"style":472},[852],{"type":28,"value":853},"(time.Millisecond ",{"type":22,"tag":435,"props":855,"children":856},{"style":442},[857],{"type":28,"value":661},{"type":22,"tag":435,"props":859,"children":860},{"style":472},[861],{"type":28,"value":862}," time.",{"type":22,"tag":435,"props":864,"children":865},{"style":728},[866],{"type":28,"value":867},"Duration",{"type":22,"tag":435,"props":869,"children":870},{"style":472},[871],{"type":28,"value":872},"(rand.",{"type":22,"tag":435,"props":874,"children":875},{"style":728},[876],{"type":28,"value":877},"Intn",{"type":22,"tag":435,"props":879,"children":880},{"style":472},[881],{"type":28,"value":736},{"type":22,"tag":435,"props":883,"children":884},{"style":802},[885],{"type":28,"value":886},"10",{"type":22,"tag":435,"props":888,"children":889},{"style":472},[890],{"type":28,"value":891},")))\n",{"type":22,"tag":435,"props":893,"children":895},{"class":437,"line":894},22,[896,901,906,910,915,920,925,930,935,940,944,949,954,959,964],{"type":22,"tag":435,"props":897,"children":898},{"style":472},[899],{"type":28,"value":900},"        log.",{"type":22,"tag":435,"props":902,"children":903},{"style":728},[904],{"type":28,"value":905},"Printf",{"type":22,"tag":435,"props":907,"children":908},{"style":472},[909],{"type":28,"value":736},{"type":22,"tag":435,"props":911,"children":912},{"style":482},[913],{"type":28,"value":914},"\"",{"type":22,"tag":435,"props":916,"children":917},{"style":802},[918],{"type":28,"value":919},"%s",{"type":22,"tag":435,"props":921,"children":922},{"style":482},[923],{"type":28,"value":924}," x=",{"type":22,"tag":435,"props":926,"children":927},{"style":802},[928],{"type":28,"value":929},"%d",{"type":22,"tag":435,"props":931,"children":932},{"style":802},[933],{"type":28,"value":934}," %v",{"type":22,"tag":435,"props":936,"children":937},{"style":802},[938],{"type":28,"value":939}," \\n",{"type":22,"tag":435,"props":941,"children":942},{"style":482},[943],{"type":28,"value":914},{"type":22,"tag":435,"props":945,"children":946},{"style":472},[947],{"type":28,"value":948},", c.Name, db.Value, time.",{"type":22,"tag":435,"props":950,"children":951},{"style":728},[952],{"type":28,"value":953},"Now",{"type":22,"tag":435,"props":955,"children":956},{"style":472},[957],{"type":28,"value":958},"().",{"type":22,"tag":435,"props":960,"children":961},{"style":728},[962],{"type":28,"value":963},"UnixMilli",{"type":22,"tag":435,"props":965,"children":966},{"style":472},[967],{"type":28,"value":968},"())\n",{"type":22,"tag":435,"props":970,"children":972},{"class":437,"line":971},23,[973],{"type":22,"tag":435,"props":974,"children":975},{"style":472},[976],{"type":28,"value":977},"    }\n",{"type":22,"tag":435,"props":979,"children":981},{"class":437,"line":980},24,[982],{"type":22,"tag":435,"props":983,"children":984},{"style":472},[985],{"type":28,"value":612},{"type":22,"tag":435,"props":987,"children":989},{"class":437,"line":988},25,[990],{"type":22,"tag":435,"props":991,"children":992},{"emptyLinePlaceholder":5},[993],{"type":28,"value":460},{"type":22,"tag":435,"props":995,"children":997},{"class":437,"line":996},26,[998,1002,1006,1010,1014,1018,1022,1027,1031,1035,1039,1043,1048,1053,1058],{"type":22,"tag":435,"props":999,"children":1000},{"style":442},[1001],{"type":28,"value":700},{"type":22,"tag":435,"props":1003,"children":1004},{"style":472},[1005],{"type":28,"value":705},{"type":22,"tag":435,"props":1007,"children":1008},{"style":708},[1009],{"type":28,"value":711},{"type":22,"tag":435,"props":1011,"children":1012},{"style":442},[1013],{"type":28,"value":661},{"type":22,"tag":435,"props":1015,"children":1016},{"style":448},[1017],{"type":28,"value":720},{"type":22,"tag":435,"props":1019,"children":1020},{"style":472},[1021],{"type":28,"value":725},{"type":22,"tag":435,"props":1023,"children":1024},{"style":728},[1025],{"type":28,"value":1026},"Write",{"type":22,"tag":435,"props":1028,"children":1029},{"style":472},[1030],{"type":28,"value":736},{"type":22,"tag":435,"props":1032,"children":1033},{"style":708},[1034],{"type":28,"value":741},{"type":22,"tag":435,"props":1036,"children":1037},{"style":442},[1038],{"type":28,"value":746},{"type":22,"tag":435,"props":1040,"children":1041},{"style":448},[1042],{"type":28,"value":751},{"type":22,"tag":435,"props":1044,"children":1045},{"style":472},[1046],{"type":28,"value":1047},", ",{"type":22,"tag":435,"props":1049,"children":1050},{"style":708},[1051],{"type":28,"value":1052},"i",{"type":22,"tag":435,"props":1054,"children":1055},{"style":600},[1056],{"type":28,"value":1057}," int",{"type":22,"tag":435,"props":1059,"children":1060},{"style":472},[1061],{"type":28,"value":756},{"type":22,"tag":435,"props":1063,"children":1065},{"class":437,"line":1064},27,[1066,1070,1074,1078],{"type":22,"tag":435,"props":1067,"children":1068},{"style":442},[1069],{"type":28,"value":765},{"type":22,"tag":435,"props":1071,"children":1072},{"style":472},[1073],{"type":28,"value":770},{"type":22,"tag":435,"props":1075,"children":1076},{"style":728},[1077],{"type":28,"value":775},{"type":22,"tag":435,"props":1079,"children":1080},{"style":472},[1081],{"type":28,"value":780},{"type":22,"tag":435,"props":1083,"children":1085},{"class":437,"line":1084},28,[1086,1091,1095,1099,1103,1107,1111,1115,1119,1123,1127],{"type":22,"tag":435,"props":1087,"children":1088},{"style":472},[1089],{"type":28,"value":1090},"    time.",{"type":22,"tag":435,"props":1092,"children":1093},{"style":728},[1094],{"type":28,"value":848},{"type":22,"tag":435,"props":1096,"children":1097},{"style":472},[1098],{"type":28,"value":853},{"type":22,"tag":435,"props":1100,"children":1101},{"style":442},[1102],{"type":28,"value":661},{"type":22,"tag":435,"props":1104,"children":1105},{"style":472},[1106],{"type":28,"value":862},{"type":22,"tag":435,"props":1108,"children":1109},{"style":728},[1110],{"type":28,"value":867},{"type":22,"tag":435,"props":1112,"children":1113},{"style":472},[1114],{"type":28,"value":872},{"type":22,"tag":435,"props":1116,"children":1117},{"style":728},[1118],{"type":28,"value":877},{"type":22,"tag":435,"props":1120,"children":1121},{"style":472},[1122],{"type":28,"value":736},{"type":22,"tag":435,"props":1124,"children":1125},{"style":802},[1126],{"type":28,"value":886},{"type":22,"tag":435,"props":1128,"children":1129},{"style":472},[1130],{"type":28,"value":891},{"type":22,"tag":435,"props":1132,"children":1134},{"class":437,"line":1133},29,[1135,1140,1145],{"type":22,"tag":435,"props":1136,"children":1137},{"style":472},[1138],{"type":28,"value":1139},"    db.Value ",{"type":22,"tag":435,"props":1141,"children":1142},{"style":442},[1143],{"type":28,"value":1144},"=",{"type":22,"tag":435,"props":1146,"children":1147},{"style":472},[1148],{"type":28,"value":1149}," i\n",{"type":22,"tag":435,"props":1151,"children":1153},{"class":437,"line":1152},30,[1154],{"type":22,"tag":435,"props":1155,"children":1156},{"style":472},[1157],{"type":28,"value":612},{"type":22,"tag":435,"props":1159,"children":1161},{"class":437,"line":1160},31,[1162],{"type":22,"tag":435,"props":1163,"children":1164},{"emptyLinePlaceholder":5},[1165],{"type":28,"value":460},{"type":22,"tag":435,"props":1167,"children":1169},{"class":437,"line":1168},32,[1170,1174,1179],{"type":22,"tag":435,"props":1171,"children":1172},{"style":442},[1173],{"type":28,"value":700},{"type":22,"tag":435,"props":1175,"children":1176},{"style":728},[1177],{"type":28,"value":1178}," main",{"type":22,"tag":435,"props":1180,"children":1181},{"style":472},[1182],{"type":28,"value":1183},"() {\n",{"type":22,"tag":435,"props":1185,"children":1187},{"class":437,"line":1186},33,[1188,1193,1198,1203,1207,1211,1216],{"type":22,"tag":435,"props":1189,"children":1190},{"style":472},[1191],{"type":28,"value":1192},"    rand.",{"type":22,"tag":435,"props":1194,"children":1195},{"style":728},[1196],{"type":28,"value":1197},"Seed",{"type":22,"tag":435,"props":1199,"children":1200},{"style":472},[1201],{"type":28,"value":1202},"(time.",{"type":22,"tag":435,"props":1204,"children":1205},{"style":728},[1206],{"type":28,"value":953},{"type":22,"tag":435,"props":1208,"children":1209},{"style":472},[1210],{"type":28,"value":958},{"type":22,"tag":435,"props":1212,"children":1213},{"style":728},[1214],{"type":28,"value":1215},"UnixNano",{"type":22,"tag":435,"props":1217,"children":1218},{"style":472},[1219],{"type":28,"value":968},{"type":22,"tag":435,"props":1221,"children":1223},{"class":437,"line":1222},34,[1224,1229,1233,1238,1242,1246,1251],{"type":22,"tag":435,"props":1225,"children":1226},{"style":472},[1227],{"type":28,"value":1228},"    wg ",{"type":22,"tag":435,"props":1230,"children":1231},{"style":442},[1232],{"type":28,"value":799},{"type":22,"tag":435,"props":1234,"children":1235},{"style":442},[1236],{"type":28,"value":1237}," &",{"type":22,"tag":435,"props":1239,"children":1240},{"style":448},[1241],{"type":28,"value":526},{"type":22,"tag":435,"props":1243,"children":1244},{"style":472},[1245],{"type":28,"value":670},{"type":22,"tag":435,"props":1247,"children":1248},{"style":448},[1249],{"type":28,"value":1250},"WaitGroup",{"type":22,"tag":435,"props":1252,"children":1253},{"style":472},[1254],{"type":28,"value":1255},"{}\n",{"type":22,"tag":435,"props":1257,"children":1259},{"class":437,"line":1258},35,[1260],{"type":22,"tag":435,"props":1261,"children":1262},{"emptyLinePlaceholder":5},[1263],{"type":28,"value":460},{"type":22,"tag":435,"props":1265,"children":1267},{"class":437,"line":1266},36,[1268,1273,1278,1282,1287],{"type":22,"tag":435,"props":1269,"children":1270},{"style":472},[1271],{"type":28,"value":1272},"    wg.",{"type":22,"tag":435,"props":1274,"children":1275},{"style":728},[1276],{"type":28,"value":1277},"Add",{"type":22,"tag":435,"props":1279,"children":1280},{"style":472},[1281],{"type":28,"value":736},{"type":22,"tag":435,"props":1283,"children":1284},{"style":802},[1285],{"type":28,"value":1286},"3",{"type":22,"tag":435,"props":1288,"children":1289},{"style":472},[1290],{"type":28,"value":556},{"type":22,"tag":435,"props":1292,"children":1294},{"class":437,"line":1293},37,[1295,1300,1304,1308,1312,1317,1322],{"type":22,"tag":435,"props":1296,"children":1297},{"style":472},[1298],{"type":28,"value":1299},"    db ",{"type":22,"tag":435,"props":1301,"children":1302},{"style":442},[1303],{"type":28,"value":799},{"type":22,"tag":435,"props":1305,"children":1306},{"style":442},[1307],{"type":28,"value":1237},{"type":22,"tag":435,"props":1309,"children":1310},{"style":448},[1311],{"type":28,"value":751},{"type":22,"tag":435,"props":1313,"children":1314},{"style":472},[1315],{"type":28,"value":1316},"{Value: ",{"type":22,"tag":435,"props":1318,"children":1319},{"style":802},[1320],{"type":28,"value":1321},"0",{"type":22,"tag":435,"props":1323,"children":1324},{"style":472},[1325],{"type":28,"value":612},{"type":22,"tag":435,"props":1327,"children":1329},{"class":437,"line":1328},38,[1330,1335,1339,1343,1347,1352,1357],{"type":22,"tag":435,"props":1331,"children":1332},{"style":472},[1333],{"type":28,"value":1334},"    clientA ",{"type":22,"tag":435,"props":1336,"children":1337},{"style":442},[1338],{"type":28,"value":799},{"type":22,"tag":435,"props":1340,"children":1341},{"style":442},[1342],{"type":28,"value":1237},{"type":22,"tag":435,"props":1344,"children":1345},{"style":448},[1346],{"type":28,"value":720},{"type":22,"tag":435,"props":1348,"children":1349},{"style":472},[1350],{"type":28,"value":1351},"{Name: ",{"type":22,"tag":435,"props":1353,"children":1354},{"style":482},[1355],{"type":28,"value":1356},"\"ClientA\"",{"type":22,"tag":435,"props":1358,"children":1359},{"style":472},[1360],{"type":28,"value":1361},", wg: wg}\n",{"type":22,"tag":435,"props":1363,"children":1365},{"class":437,"line":1364},39,[1366,1371,1375,1379,1383,1387,1392],{"type":22,"tag":435,"props":1367,"children":1368},{"style":472},[1369],{"type":28,"value":1370},"    clientB ",{"type":22,"tag":435,"props":1372,"children":1373},{"style":442},[1374],{"type":28,"value":799},{"type":22,"tag":435,"props":1376,"children":1377},{"style":442},[1378],{"type":28,"value":1237},{"type":22,"tag":435,"props":1380,"children":1381},{"style":448},[1382],{"type":28,"value":720},{"type":22,"tag":435,"props":1384,"children":1385},{"style":472},[1386],{"type":28,"value":1351},{"type":22,"tag":435,"props":1388,"children":1389},{"style":482},[1390],{"type":28,"value":1391},"\"ClientB\"",{"type":22,"tag":435,"props":1393,"children":1394},{"style":472},[1395],{"type":28,"value":1361},{"type":22,"tag":435,"props":1397,"children":1399},{"class":437,"line":1398},40,[1400,1405,1409,1413,1417,1421,1426],{"type":22,"tag":435,"props":1401,"children":1402},{"style":472},[1403],{"type":28,"value":1404},"    clientC ",{"type":22,"tag":435,"props":1406,"children":1407},{"style":442},[1408],{"type":28,"value":799},{"type":22,"tag":435,"props":1410,"children":1411},{"style":442},[1412],{"type":28,"value":1237},{"type":22,"tag":435,"props":1414,"children":1415},{"style":448},[1416],{"type":28,"value":720},{"type":22,"tag":435,"props":1418,"children":1419},{"style":472},[1420],{"type":28,"value":1351},{"type":22,"tag":435,"props":1422,"children":1423},{"style":482},[1424],{"type":28,"value":1425},"\"ClientC\"",{"type":22,"tag":435,"props":1427,"children":1428},{"style":472},[1429],{"type":28,"value":1361},{"type":22,"tag":435,"props":1431,"children":1433},{"class":437,"line":1432},41,[1434],{"type":22,"tag":435,"props":1435,"children":1436},{"emptyLinePlaceholder":5},[1437],{"type":28,"value":460},{"type":22,"tag":435,"props":1439,"children":1441},{"class":437,"line":1440},42,[1442,1447,1452,1456],{"type":22,"tag":435,"props":1443,"children":1444},{"style":442},[1445],{"type":28,"value":1446},"    go",{"type":22,"tag":435,"props":1448,"children":1449},{"style":472},[1450],{"type":28,"value":1451}," clientA.",{"type":22,"tag":435,"props":1453,"children":1454},{"style":728},[1455],{"type":28,"value":731},{"type":22,"tag":435,"props":1457,"children":1458},{"style":472},[1459],{"type":28,"value":1460},"(db)\n",{"type":22,"tag":435,"props":1462,"children":1464},{"class":437,"line":1463},43,[1465,1469,1474,1478],{"type":22,"tag":435,"props":1466,"children":1467},{"style":442},[1468],{"type":28,"value":1446},{"type":22,"tag":435,"props":1470,"children":1471},{"style":472},[1472],{"type":28,"value":1473}," clientB.",{"type":22,"tag":435,"props":1475,"children":1476},{"style":728},[1477],{"type":28,"value":731},{"type":22,"tag":435,"props":1479,"children":1480},{"style":472},[1481],{"type":28,"value":1460},{"type":22,"tag":435,"props":1483,"children":1485},{"class":437,"line":1484},44,[1486,1490,1495,1499,1504,1509],{"type":22,"tag":435,"props":1487,"children":1488},{"style":442},[1489],{"type":28,"value":1446},{"type":22,"tag":435,"props":1491,"children":1492},{"style":472},[1493],{"type":28,"value":1494}," clientC.",{"type":22,"tag":435,"props":1496,"children":1497},{"style":728},[1498],{"type":28,"value":1026},{"type":22,"tag":435,"props":1500,"children":1501},{"style":472},[1502],{"type":28,"value":1503},"(db, ",{"type":22,"tag":435,"props":1505,"children":1506},{"style":802},[1507],{"type":28,"value":1508},"1",{"type":22,"tag":435,"props":1510,"children":1511},{"style":472},[1512],{"type":28,"value":556},{"type":22,"tag":435,"props":1514,"children":1516},{"class":437,"line":1515},45,[1517],{"type":22,"tag":435,"props":1518,"children":1519},{"emptyLinePlaceholder":5},[1520],{"type":28,"value":460},{"type":22,"tag":435,"props":1522,"children":1524},{"class":437,"line":1523},46,[1525,1529,1534],{"type":22,"tag":435,"props":1526,"children":1527},{"style":472},[1528],{"type":28,"value":1272},{"type":22,"tag":435,"props":1530,"children":1531},{"style":728},[1532],{"type":28,"value":1533},"Wait",{"type":22,"tag":435,"props":1535,"children":1536},{"style":472},[1537],{"type":28,"value":780},{"type":22,"tag":435,"props":1539,"children":1541},{"class":437,"line":1540},47,[1542],{"type":22,"tag":435,"props":1543,"children":1544},{"style":472},[1545],{"type":28,"value":612},{"type":22,"tag":435,"props":1547,"children":1549},{"class":437,"line":1548},48,[1550],{"type":22,"tag":435,"props":1551,"children":1553},{"style":1552},"--shiki-dark:#6A737D;--shiki-default:#6A737D;--shiki-sepia:#88846F",[1554],{"type":28,"value":1555},"/*\n",{"type":22,"tag":435,"props":1557,"children":1559},{"class":437,"line":1558},49,[1560],{"type":22,"tag":435,"props":1561,"children":1562},{"style":1552},[1563],{"type":28,"value":1564},"2023/09/01 17:34:13 ClientA x=0 1693560853277 \n",{"type":22,"tag":435,"props":1566,"children":1568},{"class":437,"line":1567},50,[1569],{"type":22,"tag":435,"props":1570,"children":1571},{"style":1552},[1572],{"type":28,"value":1573},"2023/09/01 17:34:13 ClientA x=0 1693560853278 \n",{"type":22,"tag":435,"props":1575,"children":1577},{"class":437,"line":1576},51,[1578],{"type":22,"tag":435,"props":1579,"children":1580},{"style":1552},[1581],{"type":28,"value":1582},"2023/09/01 17:34:13 ClientB x=0 1693560853278 \n",{"type":22,"tag":435,"props":1584,"children":1586},{"class":437,"line":1585},52,[1587],{"type":22,"tag":435,"props":1588,"children":1589},{"style":1552},[1590],{"type":28,"value":1591},"2023/09/01 17:34:13 ClientA x=0 1693560853283 \n",{"type":22,"tag":435,"props":1593,"children":1595},{"class":437,"line":1594},53,[1596],{"type":22,"tag":435,"props":1597,"children":1598},{"style":1552},[1599],{"type":28,"value":1600},"2023/09/01 17:34:13 ClientB x=1 1693560853288 \n",{"type":22,"tag":435,"props":1602,"children":1604},{"class":437,"line":1603},54,[1605],{"type":22,"tag":435,"props":1606,"children":1607},{"style":1552},[1608],{"type":28,"value":1609},"2023/09/01 17:34:13 ClientB x=1 1693560853298\n",{"type":22,"tag":435,"props":1611,"children":1613},{"class":437,"line":1612},55,[1614],{"type":22,"tag":435,"props":1615,"children":1616},{"style":1552},[1617],{"type":28,"value":1618},"*/\n",{"type":22,"tag":1620,"props":1621,"children":1622},"hr",{},[],{"type":22,"tag":137,"props":1624,"children":1625},{},[1626],{"type":28,"value":1627},"為了使系統線性一致需要新增另外一個約束“只要有任何一個Client讀取x都必須返回最新值",{"type":22,"tag":137,"props":1629,"children":1630},{},[1631],{"type":22,"tag":341,"props":1632,"children":1635},{"alt":1633,"src":1634},"圖 9-3 任何一個讀取返回新值後，所有後續讀取（在相同或其他客戶端上）也必須返回新值。","https://vonng.github.io/ddia/img/fig9-3.png",[],{"type":22,"tag":137,"props":1637,"children":1638},{},[1639],{"type":22,"tag":51,"props":1640,"children":1641},{},[1642],{"type":28,"value":1633},{"type":22,"tag":137,"props":1644,"children":1645},{},[1646],{"type":28,"value":357},{"type":22,"tag":137,"props":1648,"children":1649},{},[1650],{"type":28,"value":1651},"這張圖是與上一個圖的比較,這張圖是最後想要達到的目標(線性一致)也就是我不管C到底在哪個時間點真正寫入,只要A已經讀到1的話,B永遠不能讀到其他值一定要是1",{"type":22,"tag":137,"props":1653,"children":1654},{},[1655],{"type":22,"tag":341,"props":1656,"children":1659},{"alt":1657,"src":1658},"圖 9-4 視覺化讀取和寫入看起來已經生效的時間點。 B 的最後讀取不是線性一致性的","https://vonng.github.io/ddia/img/fig9-4.png",[],{"type":22,"tag":137,"props":1661,"children":1662},{},[1663],{"type":22,"tag":51,"props":1664,"children":1665},{},[1666],{"type":28,"value":1657},{"type":22,"tag":137,"props":1668,"children":1669},{},[1670],{"type":28,"value":357},{"type":22,"tag":137,"props":1672,"children":1673},{},[1674],{"type":28,"value":1675},"這邊想要描述如果write與cas混用會發生什麼問題",{"type":22,"tag":137,"props":1677,"children":1678},{},[1679],{"type":28,"value":1680},"D最後出錯了原因是他一開始沒有用cas先比較資料庫原本有的內容是什麼等到他想用cas的時候發現cas(2,0,3) 2≠0 所以error,",{"type":22,"tag":137,"props":1682,"children":1683},{},[1684],{"type":28,"value":1685},"C想用cas更新資料庫,而C最後一次的記憶體裡面x=2所以cas(2,2,4) 2=2所以x更新成4",{"type":22,"tag":418,"props":1687,"children":1689},{"id":1688},"第七章cascompare-and-swap的解釋-補全",[1690,1692],{"type":28,"value":1691},"第七章CAS(Compare and Swap)的解釋 ",{"type":22,"tag":107,"props":1693,"children":1694},{},[1695],{"type":28,"value":1696},"*補全",{"type":22,"tag":137,"props":1698,"children":1699},{},[1700,1702,1709],{"type":28,"value":1701},"第7章”事務”有提到",{"type":22,"tag":55,"props":1703,"children":1706},{"href":1704,"rel":1705},"https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e6%af%94%e8%bc%83%e4%b8%a6%e8%a8%ad%e5%ae%9a%ef%bc%88cas%ef%bc%89",[59],[1707],{"type":28,"value":1708},"CAS",{"type":28,"value":1710},"與ACID",{"type":22,"tag":137,"props":1712,"children":1713},{},[1714],{"type":28,"value":1715},"cas(實例數值(內存數值),期望數值,更新數值)  = True or False",{"type":22,"tag":424,"props":1717,"children":1721},{"className":1718,"code":1719,"language":1720,"meta":13,"style":13},"language-mermaid shiki shiki-themes github-dark github-light monokai","sequenceDiagram\n  participant T1\n  participant Memory\n  participant T2\n  Note over Memory: x=77\n\n    T2->>Memory: 讀取數值 (Read x)\n  Memory->>T2: 返回 77\n  T1->>Memory: 讀取數值 (Read x)\n  Memory->>T1: 返回 77\n    \n\n  Note over T1,T2: 開始競爭搶做cas更新\n    \n    Note over T1,Memory: T1先搶到開始做cas\n  T1->>Memory: CAS(77, 77, 78) \n  Note over Memory: 比較 77 == 77\n  Memory->>T1: CAS成功，更新為78\n\n    Note over Memory: x=78\n  Note over Memory,T2: T2比T1晚一步做cas\n  T2->>Memory: CAS(78, 77, 7788)\n  Note over Memory: 比較 78 != 77\n  Memory->>T2: CAS失敗\n\n  Note over Memory: 最終數值為 x=78\n","mermaid",[1722],{"type":22,"tag":431,"props":1723,"children":1724},{"__ignoreMap":13},[1725,1733,1741,1749,1757,1765,1772,1780,1788,1796,1804,1812,1819,1827,1834,1842,1850,1858,1866,1873,1881,1889,1897,1905,1913,1920],{"type":22,"tag":435,"props":1726,"children":1727},{"class":437,"line":438},[1728],{"type":22,"tag":435,"props":1729,"children":1730},{},[1731],{"type":28,"value":1732},"sequenceDiagram\n",{"type":22,"tag":435,"props":1734,"children":1735},{"class":437,"line":454},[1736],{"type":22,"tag":435,"props":1737,"children":1738},{},[1739],{"type":28,"value":1740},"  participant T1\n",{"type":22,"tag":435,"props":1742,"children":1743},{"class":437,"line":463},[1744],{"type":22,"tag":435,"props":1745,"children":1746},{},[1747],{"type":28,"value":1748},"  participant Memory\n",{"type":22,"tag":435,"props":1750,"children":1751},{"class":437,"line":478},[1752],{"type":22,"tag":435,"props":1753,"children":1754},{},[1755],{"type":28,"value":1756},"  participant T2\n",{"type":22,"tag":435,"props":1758,"children":1759},{"class":437,"line":499},[1760],{"type":22,"tag":435,"props":1761,"children":1762},{},[1763],{"type":28,"value":1764},"  Note over Memory: x=77\n",{"type":22,"tag":435,"props":1766,"children":1767},{"class":437,"line":516},[1768],{"type":22,"tag":435,"props":1769,"children":1770},{"emptyLinePlaceholder":5},[1771],{"type":28,"value":460},{"type":22,"tag":435,"props":1773,"children":1774},{"class":437,"line":533},[1775],{"type":22,"tag":435,"props":1776,"children":1777},{},[1778],{"type":28,"value":1779},"    T2->>Memory: 讀取數值 (Read x)\n",{"type":22,"tag":435,"props":1781,"children":1782},{"class":437,"line":550},[1783],{"type":22,"tag":435,"props":1784,"children":1785},{},[1786],{"type":28,"value":1787},"  Memory->>T2: 返回 77\n",{"type":22,"tag":435,"props":1789,"children":1790},{"class":437,"line":559},[1791],{"type":22,"tag":435,"props":1792,"children":1793},{},[1794],{"type":28,"value":1795},"  T1->>Memory: 讀取數值 (Read x)\n",{"type":22,"tag":435,"props":1797,"children":1798},{"class":437,"line":567},[1799],{"type":22,"tag":435,"props":1800,"children":1801},{},[1802],{"type":28,"value":1803},"  Memory->>T1: 返回 77\n",{"type":22,"tag":435,"props":1805,"children":1806},{"class":437,"line":591},[1807],{"type":22,"tag":435,"props":1808,"children":1809},{},[1810],{"type":28,"value":1811},"    \n",{"type":22,"tag":435,"props":1813,"children":1814},{"class":437,"line":606},[1815],{"type":22,"tag":435,"props":1816,"children":1817},{"emptyLinePlaceholder":5},[1818],{"type":28,"value":460},{"type":22,"tag":435,"props":1820,"children":1821},{"class":437,"line":615},[1822],{"type":22,"tag":435,"props":1823,"children":1824},{},[1825],{"type":28,"value":1826},"  Note over T1,T2: 開始競爭搶做cas更新\n",{"type":22,"tag":435,"props":1828,"children":1829},{"class":437,"line":636},[1830],{"type":22,"tag":435,"props":1831,"children":1832},{},[1833],{"type":28,"value":1811},{"type":22,"tag":435,"props":1835,"children":1836},{"class":437,"line":650},[1837],{"type":22,"tag":435,"props":1838,"children":1839},{},[1840],{"type":28,"value":1841},"    Note over T1,Memory: T1先搶到開始做cas\n",{"type":22,"tag":435,"props":1843,"children":1844},{"class":437,"line":678},[1845],{"type":22,"tag":435,"props":1846,"children":1847},{},[1848],{"type":28,"value":1849},"  T1->>Memory: CAS(77, 77, 78) \n",{"type":22,"tag":435,"props":1851,"children":1852},{"class":437,"line":686},[1853],{"type":22,"tag":435,"props":1854,"children":1855},{},[1856],{"type":28,"value":1857},"  Note over Memory: 比較 77 == 77\n",{"type":22,"tag":435,"props":1859,"children":1860},{"class":437,"line":694},[1861],{"type":22,"tag":435,"props":1862,"children":1863},{},[1864],{"type":28,"value":1865},"  Memory->>T1: CAS成功，更新為78\n",{"type":22,"tag":435,"props":1867,"children":1868},{"class":437,"line":759},[1869],{"type":22,"tag":435,"props":1870,"children":1871},{"emptyLinePlaceholder":5},[1872],{"type":28,"value":460},{"type":22,"tag":435,"props":1874,"children":1875},{"class":437,"line":783},[1876],{"type":22,"tag":435,"props":1877,"children":1878},{},[1879],{"type":28,"value":1880},"    Note over Memory: x=78\n",{"type":22,"tag":435,"props":1882,"children":1883},{"class":437,"line":837},[1884],{"type":22,"tag":435,"props":1885,"children":1886},{},[1887],{"type":28,"value":1888},"  Note over Memory,T2: T2比T1晚一步做cas\n",{"type":22,"tag":435,"props":1890,"children":1891},{"class":437,"line":894},[1892],{"type":22,"tag":435,"props":1893,"children":1894},{},[1895],{"type":28,"value":1896},"  T2->>Memory: CAS(78, 77, 7788)\n",{"type":22,"tag":435,"props":1898,"children":1899},{"class":437,"line":971},[1900],{"type":22,"tag":435,"props":1901,"children":1902},{},[1903],{"type":28,"value":1904},"  Note over Memory: 比較 78 != 77\n",{"type":22,"tag":435,"props":1906,"children":1907},{"class":437,"line":980},[1908],{"type":22,"tag":435,"props":1909,"children":1910},{},[1911],{"type":28,"value":1912},"  Memory->>T2: CAS失敗\n",{"type":22,"tag":435,"props":1914,"children":1915},{"class":437,"line":988},[1916],{"type":22,"tag":435,"props":1917,"children":1918},{"emptyLinePlaceholder":5},[1919],{"type":28,"value":460},{"type":22,"tag":435,"props":1921,"children":1922},{"class":437,"line":996},[1923],{"type":22,"tag":435,"props":1924,"children":1925},{},[1926],{"type":28,"value":1927},"  Note over Memory: 最終數值為 x=78\n",{"type":22,"tag":137,"props":1929,"children":1930},{},[1931],{"type":28,"value":1932},"*重點：",{"type":22,"tag":137,"props":1934,"children":1935},{},[1936],{"type":28,"value":1937},"CAS只在乎寫，而初始值的讀取可以是刻意先去讀或者是曾經讀過",{"type":22,"tag":137,"props":1939,"children":1940},{},[1941],{"type":28,"value":1942},"沒有先讀的cas不能比較",{"type":22,"tag":418,"props":1944,"children":1946},{"id":1945},"test-1",[1947],{"type":28,"value":420},{"type":22,"tag":424,"props":1949,"children":1951},{"className":426,"code":1950,"language":428,"meta":13,"style":13},"type CAS struct {\n    value int\n}\n\nfunc (c *CAS) CompareAndSwap(expected int, newValue int) bool {\n    if c.value == expected {\n        c.value = newValue\n        return true\n    }\n    return false\n}\n",[1952],{"type":22,"tag":431,"props":1953,"children":1954},{"__ignoreMap":13},[1955,1975,1987,1994,2001,2072,2095,2112,2125,2132,2145],{"type":22,"tag":435,"props":1956,"children":1957},{"class":437,"line":438},[1958,1962,1967,1971],{"type":22,"tag":435,"props":1959,"children":1960},{"style":442},[1961],{"type":28,"value":573},{"type":22,"tag":435,"props":1963,"children":1964},{"style":448},[1965],{"type":28,"value":1966}," CAS",{"type":22,"tag":435,"props":1968,"children":1969},{"style":442},[1970],{"type":28,"value":583},{"type":22,"tag":435,"props":1972,"children":1973},{"style":472},[1974],{"type":28,"value":588},{"type":22,"tag":435,"props":1976,"children":1977},{"class":437,"line":454},[1978,1983],{"type":22,"tag":435,"props":1979,"children":1980},{"style":472},[1981],{"type":28,"value":1982},"    value ",{"type":22,"tag":435,"props":1984,"children":1985},{"style":600},[1986],{"type":28,"value":603},{"type":22,"tag":435,"props":1988,"children":1989},{"class":437,"line":463},[1990],{"type":22,"tag":435,"props":1991,"children":1992},{"style":472},[1993],{"type":28,"value":612},{"type":22,"tag":435,"props":1995,"children":1996},{"class":437,"line":478},[1997],{"type":22,"tag":435,"props":1998,"children":1999},{"emptyLinePlaceholder":5},[2000],{"type":28,"value":460},{"type":22,"tag":435,"props":2002,"children":2003},{"class":437,"line":499},[2004,2008,2012,2016,2020,2024,2028,2033,2037,2042,2046,2050,2055,2059,2063,2068],{"type":22,"tag":435,"props":2005,"children":2006},{"style":442},[2007],{"type":28,"value":700},{"type":22,"tag":435,"props":2009,"children":2010},{"style":472},[2011],{"type":28,"value":705},{"type":22,"tag":435,"props":2013,"children":2014},{"style":708},[2015],{"type":28,"value":711},{"type":22,"tag":435,"props":2017,"children":2018},{"style":442},[2019],{"type":28,"value":661},{"type":22,"tag":435,"props":2021,"children":2022},{"style":448},[2023],{"type":28,"value":1708},{"type":22,"tag":435,"props":2025,"children":2026},{"style":472},[2027],{"type":28,"value":725},{"type":22,"tag":435,"props":2029,"children":2030},{"style":728},[2031],{"type":28,"value":2032},"CompareAndSwap",{"type":22,"tag":435,"props":2034,"children":2035},{"style":472},[2036],{"type":28,"value":736},{"type":22,"tag":435,"props":2038,"children":2039},{"style":708},[2040],{"type":28,"value":2041},"expected",{"type":22,"tag":435,"props":2043,"children":2044},{"style":600},[2045],{"type":28,"value":1057},{"type":22,"tag":435,"props":2047,"children":2048},{"style":472},[2049],{"type":28,"value":1047},{"type":22,"tag":435,"props":2051,"children":2052},{"style":708},[2053],{"type":28,"value":2054},"newValue",{"type":22,"tag":435,"props":2056,"children":2057},{"style":600},[2058],{"type":28,"value":1057},{"type":22,"tag":435,"props":2060,"children":2061},{"style":472},[2062],{"type":28,"value":725},{"type":22,"tag":435,"props":2064,"children":2065},{"style":600},[2066],{"type":28,"value":2067},"bool",{"type":22,"tag":435,"props":2069,"children":2070},{"style":472},[2071],{"type":28,"value":588},{"type":22,"tag":435,"props":2073,"children":2074},{"class":437,"line":516},[2075,2080,2085,2090],{"type":22,"tag":435,"props":2076,"children":2077},{"style":442},[2078],{"type":28,"value":2079},"    if",{"type":22,"tag":435,"props":2081,"children":2082},{"style":472},[2083],{"type":28,"value":2084}," c.value ",{"type":22,"tag":435,"props":2086,"children":2087},{"style":442},[2088],{"type":28,"value":2089},"==",{"type":22,"tag":435,"props":2091,"children":2092},{"style":472},[2093],{"type":28,"value":2094}," expected {\n",{"type":22,"tag":435,"props":2096,"children":2097},{"class":437,"line":533},[2098,2103,2107],{"type":22,"tag":435,"props":2099,"children":2100},{"style":472},[2101],{"type":28,"value":2102},"        c.value ",{"type":22,"tag":435,"props":2104,"children":2105},{"style":442},[2106],{"type":28,"value":1144},{"type":22,"tag":435,"props":2108,"children":2109},{"style":472},[2110],{"type":28,"value":2111}," newValue\n",{"type":22,"tag":435,"props":2113,"children":2114},{"class":437,"line":550},[2115,2120],{"type":22,"tag":435,"props":2116,"children":2117},{"style":442},[2118],{"type":28,"value":2119},"        return",{"type":22,"tag":435,"props":2121,"children":2122},{"style":802},[2123],{"type":28,"value":2124}," true\n",{"type":22,"tag":435,"props":2126,"children":2127},{"class":437,"line":559},[2128],{"type":22,"tag":435,"props":2129,"children":2130},{"style":472},[2131],{"type":28,"value":977},{"type":22,"tag":435,"props":2133,"children":2134},{"class":437,"line":567},[2135,2140],{"type":22,"tag":435,"props":2136,"children":2137},{"style":442},[2138],{"type":28,"value":2139},"    return",{"type":22,"tag":435,"props":2141,"children":2142},{"style":802},[2143],{"type":28,"value":2144}," false\n",{"type":22,"tag":435,"props":2146,"children":2147},{"class":437,"line":591},[2148],{"type":22,"tag":435,"props":2149,"children":2150},{"style":472},[2151],{"type":28,"value":612},{"type":22,"tag":137,"props":2153,"children":2154},{},[2155],{"type":28,"value":2156},"第7章說CAS是輕型事務所以用redis了解了一下事務",{"type":22,"tag":137,"props":2158,"children":2159},{},[2160],{"type":28,"value":2161},"最後對於cas的理解就像是redis的watch會去監視某個key當某個key被併發寫入時就會發出錯誤停止事務",{"type":22,"tag":424,"props":2163,"children":2167},{"className":2164,"code":2165,"language":2166,"meta":13,"style":13},"language-bash shiki shiki-themes github-dark github-light monokai","go func(){ //A\n    WATCH x\n    MULTI\n    SET x \"newValueFromA\"\n    EXEC\n}()\ngo func(){ //B\n    WATCH x\n    MULTI\n    SET x \"newValueFromB\"\n    EXEC\n}()\n/*\n2023/09/04 00:06:19 Goroutine A aborted: redis: transaction failed\n2023/09/04 00:06:19 Goroutine B succeeded\n2023/09/04 00:06:19 Final value of x: newValueFromB\n*/\n","bash",[2168],{"type":22,"tag":431,"props":2169,"children":2170},{"__ignoreMap":13},[2171,2198,2211,2219,2237,2245,2257,2281,2292,2299,2315,2322,2333,2340,2383,2408,2444],{"type":22,"tag":435,"props":2172,"children":2173},{"class":437,"line":438},[2174,2178,2183,2188,2193],{"type":22,"tag":435,"props":2175,"children":2176},{"style":728},[2177],{"type":28,"value":428},{"type":22,"tag":435,"props":2179,"children":2180},{"style":482},[2181],{"type":28,"value":2182}," func",{"type":22,"tag":435,"props":2184,"children":2185},{"style":472},[2186],{"type":28,"value":2187},"()",{"type":22,"tag":435,"props":2189,"children":2190},{"style":482},[2191],{"type":28,"value":2192},"{",{"type":22,"tag":435,"props":2194,"children":2195},{"style":482},[2196],{"type":28,"value":2197}," //A\n",{"type":22,"tag":435,"props":2199,"children":2200},{"class":437,"line":454},[2201,2206],{"type":22,"tag":435,"props":2202,"children":2203},{"style":728},[2204],{"type":28,"value":2205},"    WATCH",{"type":22,"tag":435,"props":2207,"children":2208},{"style":482},[2209],{"type":28,"value":2210}," x\n",{"type":22,"tag":435,"props":2212,"children":2213},{"class":437,"line":463},[2214],{"type":22,"tag":435,"props":2215,"children":2216},{"style":728},[2217],{"type":28,"value":2218},"    MULTI\n",{"type":22,"tag":435,"props":2220,"children":2221},{"class":437,"line":478},[2222,2227,2232],{"type":22,"tag":435,"props":2223,"children":2224},{"style":728},[2225],{"type":28,"value":2226},"    SET",{"type":22,"tag":435,"props":2228,"children":2229},{"style":482},[2230],{"type":28,"value":2231}," x",{"type":22,"tag":435,"props":2233,"children":2234},{"style":482},[2235],{"type":28,"value":2236}," \"newValueFromA\"\n",{"type":22,"tag":435,"props":2238,"children":2239},{"class":437,"line":499},[2240],{"type":22,"tag":435,"props":2241,"children":2242},{"style":728},[2243],{"type":28,"value":2244},"    EXEC\n",{"type":22,"tag":435,"props":2246,"children":2247},{"class":437,"line":516},[2248,2253],{"type":22,"tag":435,"props":2249,"children":2250},{"style":728},[2251],{"type":28,"value":2252},"}",{"type":22,"tag":435,"props":2254,"children":2255},{"style":472},[2256],{"type":28,"value":780},{"type":22,"tag":435,"props":2258,"children":2259},{"class":437,"line":533},[2260,2264,2268,2272,2276],{"type":22,"tag":435,"props":2261,"children":2262},{"style":728},[2263],{"type":28,"value":428},{"type":22,"tag":435,"props":2265,"children":2266},{"style":482},[2267],{"type":28,"value":2182},{"type":22,"tag":435,"props":2269,"children":2270},{"style":472},[2271],{"type":28,"value":2187},{"type":22,"tag":435,"props":2273,"children":2274},{"style":482},[2275],{"type":28,"value":2192},{"type":22,"tag":435,"props":2277,"children":2278},{"style":482},[2279],{"type":28,"value":2280}," //B\n",{"type":22,"tag":435,"props":2282,"children":2283},{"class":437,"line":550},[2284,2288],{"type":22,"tag":435,"props":2285,"children":2286},{"style":728},[2287],{"type":28,"value":2205},{"type":22,"tag":435,"props":2289,"children":2290},{"style":482},[2291],{"type":28,"value":2210},{"type":22,"tag":435,"props":2293,"children":2294},{"class":437,"line":559},[2295],{"type":22,"tag":435,"props":2296,"children":2297},{"style":728},[2298],{"type":28,"value":2218},{"type":22,"tag":435,"props":2300,"children":2301},{"class":437,"line":567},[2302,2306,2310],{"type":22,"tag":435,"props":2303,"children":2304},{"style":728},[2305],{"type":28,"value":2226},{"type":22,"tag":435,"props":2307,"children":2308},{"style":482},[2309],{"type":28,"value":2231},{"type":22,"tag":435,"props":2311,"children":2312},{"style":482},[2313],{"type":28,"value":2314}," \"newValueFromB\"\n",{"type":22,"tag":435,"props":2316,"children":2317},{"class":437,"line":591},[2318],{"type":22,"tag":435,"props":2319,"children":2320},{"style":728},[2321],{"type":28,"value":2244},{"type":22,"tag":435,"props":2323,"children":2324},{"class":437,"line":606},[2325,2329],{"type":22,"tag":435,"props":2326,"children":2327},{"style":728},[2328],{"type":28,"value":2252},{"type":22,"tag":435,"props":2330,"children":2331},{"style":472},[2332],{"type":28,"value":780},{"type":22,"tag":435,"props":2334,"children":2335},{"class":437,"line":615},[2336],{"type":22,"tag":435,"props":2337,"children":2338},{"style":728},[2339],{"type":28,"value":1555},{"type":22,"tag":435,"props":2341,"children":2342},{"class":437,"line":636},[2343,2348,2353,2358,2363,2368,2373,2378],{"type":22,"tag":435,"props":2344,"children":2345},{"style":728},[2346],{"type":28,"value":2347},"2023/09/04",{"type":22,"tag":435,"props":2349,"children":2350},{"style":482},[2351],{"type":28,"value":2352}," 00:06:19",{"type":22,"tag":435,"props":2354,"children":2355},{"style":482},[2356],{"type":28,"value":2357}," Goroutine",{"type":22,"tag":435,"props":2359,"children":2360},{"style":482},[2361],{"type":28,"value":2362}," A",{"type":22,"tag":435,"props":2364,"children":2365},{"style":482},[2366],{"type":28,"value":2367}," aborted:",{"type":22,"tag":435,"props":2369,"children":2370},{"style":482},[2371],{"type":28,"value":2372}," redis:",{"type":22,"tag":435,"props":2374,"children":2375},{"style":482},[2376],{"type":28,"value":2377}," transaction",{"type":22,"tag":435,"props":2379,"children":2380},{"style":482},[2381],{"type":28,"value":2382}," failed\n",{"type":22,"tag":435,"props":2384,"children":2385},{"class":437,"line":650},[2386,2390,2394,2398,2403],{"type":22,"tag":435,"props":2387,"children":2388},{"style":728},[2389],{"type":28,"value":2347},{"type":22,"tag":435,"props":2391,"children":2392},{"style":482},[2393],{"type":28,"value":2352},{"type":22,"tag":435,"props":2395,"children":2396},{"style":482},[2397],{"type":28,"value":2357},{"type":22,"tag":435,"props":2399,"children":2400},{"style":482},[2401],{"type":28,"value":2402}," B",{"type":22,"tag":435,"props":2404,"children":2405},{"style":482},[2406],{"type":28,"value":2407}," succeeded\n",{"type":22,"tag":435,"props":2409,"children":2410},{"class":437,"line":678},[2411,2415,2419,2424,2429,2434,2439],{"type":22,"tag":435,"props":2412,"children":2413},{"style":728},[2414],{"type":28,"value":2347},{"type":22,"tag":435,"props":2416,"children":2417},{"style":482},[2418],{"type":28,"value":2352},{"type":22,"tag":435,"props":2420,"children":2421},{"style":482},[2422],{"type":28,"value":2423}," Final",{"type":22,"tag":435,"props":2425,"children":2426},{"style":482},[2427],{"type":28,"value":2428}," value",{"type":22,"tag":435,"props":2430,"children":2431},{"style":482},[2432],{"type":28,"value":2433}," of",{"type":22,"tag":435,"props":2435,"children":2436},{"style":482},[2437],{"type":28,"value":2438}," x:",{"type":22,"tag":435,"props":2440,"children":2441},{"style":482},[2442],{"type":28,"value":2443}," newValueFromB\n",{"type":22,"tag":435,"props":2445,"children":2446},{"class":437,"line":686},[2447,2451],{"type":22,"tag":435,"props":2448,"children":2449},{"style":442},[2450],{"type":28,"value":661},{"type":22,"tag":435,"props":2452,"children":2453},{"style":472},[2454],{"type":28,"value":2455},"/\n",{"type":22,"tag":418,"props":2457,"children":2459},{"id":2458},"test-2",[2460],{"type":28,"value":420},{"type":22,"tag":424,"props":2462,"children":2464},{"className":426,"code":2463,"language":428,"meta":13,"style":13},"package main\n\nimport (\n    \"context\"\n    \"log\"\n    \"sync\"\n\n    \"github.com/go-redis/redis/v8\"\n)\n\nfunc main() {\n    var ctx = context.Background()\n    rdb := redis.NewClient(&redis.Options{\n        Addr:     \"localhost:6379\",\n        Password: \"redis\",\n    })\n\n    var wg sync.WaitGroup\n    wg.Add(2)\n\n    go func() { \n        defer wg.Done()\n\n        err := rdb.Watch(ctx, func(tx *redis.Tx) error {\n\n            _, err := tx.TxPipelined(ctx, func(pipe redis.Pipeliner) error {\n                pipe.Set(ctx, \"x\", \"newValueFromA\", 0)\n                return nil\n            })\n\n            return err\n        }, \"x\")\n\n        if err != nil {\n            log.Printf(\"Goroutine A aborted: %v\", err)\n        } else {\n            log.Printf(\"Goroutine A succeeded\")\n        }\n    }()\n\n    go func() { \n        defer wg.Done()\n\n        err := rdb.Watch(ctx, func(tx *redis.Tx) error {\n            _, err := tx.TxPipelined(ctx, func(pipe redis.Pipeliner) error {\n                pipe.Set(ctx, \"x\", \"newValueFromB\", 0)\n                return nil\n            })\n\n            return err\n        }, \"x\")\n\n        if err != nil {\n            log.Printf(\"Goroutine B aborted: %v\", err)\n        } else {\n            log.Printf(\"Goroutine B succeeded\")\n        }\n    }()\n\n    wg.Wait()\n\n    value, err := rdb.Get(ctx, \"x\").Result()\n    if err != nil {\n        log.Fatalf(\"Could not get x: %v\", err)\n    }\n\n    log.Printf(\"Final value of x: %v\", value)\n}\n/*\n2023/09/04 00:06:19 Goroutine A aborted: redis: transaction failed\n2023/09/04 00:06:19 Goroutine B succeeded\n2023/09/04 00:06:19 Final value of x: newValueFromB\n*/\n",[2465],{"type":22,"tag":431,"props":2466,"children":2467},{"__ignoreMap":13},[2468,2479,2486,2497,2513,2528,2543,2550,2566,2573,2580,2595,2626,2676,2694,2711,2719,2726,2750,2774,2781,2797,2818,2825,2895,2902,2967,3010,3023,3031,3038,3051,3067,3074,3101,3136,3153,3177,3185,3193,3200,3215,3234,3241,3304,3363,3403,3414,3421,3428,3439,3454,3461,3484,3516,3531,3556,3564,3572,3580,3596,3604,3648,3672,3706,3714,3722,3757,3765,3773,3782,3791,3800],{"type":22,"tag":435,"props":2469,"children":2470},{"class":437,"line":438},[2471,2475],{"type":22,"tag":435,"props":2472,"children":2473},{"style":442},[2474],{"type":28,"value":445},{"type":22,"tag":435,"props":2476,"children":2477},{"style":448},[2478],{"type":28,"value":451},{"type":22,"tag":435,"props":2480,"children":2481},{"class":437,"line":454},[2482],{"type":22,"tag":435,"props":2483,"children":2484},{"emptyLinePlaceholder":5},[2485],{"type":28,"value":460},{"type":22,"tag":435,"props":2487,"children":2488},{"class":437,"line":463},[2489,2493],{"type":22,"tag":435,"props":2490,"children":2491},{"style":442},[2492],{"type":28,"value":469},{"type":22,"tag":435,"props":2494,"children":2495},{"style":472},[2496],{"type":28,"value":475},{"type":22,"tag":435,"props":2498,"children":2499},{"class":437,"line":478},[2500,2504,2509],{"type":22,"tag":435,"props":2501,"children":2502},{"style":482},[2503],{"type":28,"value":485},{"type":22,"tag":435,"props":2505,"children":2506},{"style":488},[2507],{"type":28,"value":2508},"context",{"type":22,"tag":435,"props":2510,"children":2511},{"style":482},[2512],{"type":28,"value":496},{"type":22,"tag":435,"props":2514,"children":2515},{"class":437,"line":499},[2516,2520,2524],{"type":22,"tag":435,"props":2517,"children":2518},{"style":482},[2519],{"type":28,"value":485},{"type":22,"tag":435,"props":2521,"children":2522},{"style":488},[2523],{"type":28,"value":491},{"type":22,"tag":435,"props":2525,"children":2526},{"style":482},[2527],{"type":28,"value":496},{"type":22,"tag":435,"props":2529,"children":2530},{"class":437,"line":516},[2531,2535,2539],{"type":22,"tag":435,"props":2532,"children":2533},{"style":482},[2534],{"type":28,"value":485},{"type":22,"tag":435,"props":2536,"children":2537},{"style":488},[2538],{"type":28,"value":526},{"type":22,"tag":435,"props":2540,"children":2541},{"style":482},[2542],{"type":28,"value":496},{"type":22,"tag":435,"props":2544,"children":2545},{"class":437,"line":533},[2546],{"type":22,"tag":435,"props":2547,"children":2548},{"emptyLinePlaceholder":5},[2549],{"type":28,"value":460},{"type":22,"tag":435,"props":2551,"children":2552},{"class":437,"line":550},[2553,2557,2562],{"type":22,"tag":435,"props":2554,"children":2555},{"style":482},[2556],{"type":28,"value":485},{"type":22,"tag":435,"props":2558,"children":2559},{"style":488},[2560],{"type":28,"value":2561},"github.com/go-redis/redis/v8",{"type":22,"tag":435,"props":2563,"children":2564},{"style":482},[2565],{"type":28,"value":496},{"type":22,"tag":435,"props":2567,"children":2568},{"class":437,"line":559},[2569],{"type":22,"tag":435,"props":2570,"children":2571},{"style":472},[2572],{"type":28,"value":556},{"type":22,"tag":435,"props":2574,"children":2575},{"class":437,"line":567},[2576],{"type":22,"tag":435,"props":2577,"children":2578},{"emptyLinePlaceholder":5},[2579],{"type":28,"value":460},{"type":22,"tag":435,"props":2581,"children":2582},{"class":437,"line":591},[2583,2587,2591],{"type":22,"tag":435,"props":2584,"children":2585},{"style":442},[2586],{"type":28,"value":700},{"type":22,"tag":435,"props":2588,"children":2589},{"style":728},[2590],{"type":28,"value":1178},{"type":22,"tag":435,"props":2592,"children":2593},{"style":472},[2594],{"type":28,"value":1183},{"type":22,"tag":435,"props":2596,"children":2597},{"class":437,"line":606},[2598,2603,2608,2612,2617,2622],{"type":22,"tag":435,"props":2599,"children":2600},{"style":442},[2601],{"type":28,"value":2602},"    var",{"type":22,"tag":435,"props":2604,"children":2605},{"style":472},[2606],{"type":28,"value":2607}," ctx ",{"type":22,"tag":435,"props":2609,"children":2610},{"style":442},[2611],{"type":28,"value":1144},{"type":22,"tag":435,"props":2613,"children":2614},{"style":472},[2615],{"type":28,"value":2616}," context.",{"type":22,"tag":435,"props":2618,"children":2619},{"style":728},[2620],{"type":28,"value":2621},"Background",{"type":22,"tag":435,"props":2623,"children":2624},{"style":472},[2625],{"type":28,"value":780},{"type":22,"tag":435,"props":2627,"children":2628},{"class":437,"line":615},[2629,2634,2638,2643,2648,2652,2657,2662,2666,2671],{"type":22,"tag":435,"props":2630,"children":2631},{"style":472},[2632],{"type":28,"value":2633},"    rdb ",{"type":22,"tag":435,"props":2635,"children":2636},{"style":442},[2637],{"type":28,"value":799},{"type":22,"tag":435,"props":2639,"children":2640},{"style":472},[2641],{"type":28,"value":2642}," redis.",{"type":22,"tag":435,"props":2644,"children":2645},{"style":728},[2646],{"type":28,"value":2647},"NewClient",{"type":22,"tag":435,"props":2649,"children":2650},{"style":472},[2651],{"type":28,"value":736},{"type":22,"tag":435,"props":2653,"children":2654},{"style":442},[2655],{"type":28,"value":2656},"&",{"type":22,"tag":435,"props":2658,"children":2659},{"style":448},[2660],{"type":28,"value":2661},"redis",{"type":22,"tag":435,"props":2663,"children":2664},{"style":472},[2665],{"type":28,"value":670},{"type":22,"tag":435,"props":2667,"children":2668},{"style":448},[2669],{"type":28,"value":2670},"Options",{"type":22,"tag":435,"props":2672,"children":2673},{"style":472},[2674],{"type":28,"value":2675},"{\n",{"type":22,"tag":435,"props":2677,"children":2678},{"class":437,"line":636},[2679,2684,2689],{"type":22,"tag":435,"props":2680,"children":2681},{"style":472},[2682],{"type":28,"value":2683},"        Addr:     ",{"type":22,"tag":435,"props":2685,"children":2686},{"style":482},[2687],{"type":28,"value":2688},"\"localhost:6379\"",{"type":22,"tag":435,"props":2690,"children":2691},{"style":472},[2692],{"type":28,"value":2693},",\n",{"type":22,"tag":435,"props":2695,"children":2696},{"class":437,"line":650},[2697,2702,2707],{"type":22,"tag":435,"props":2698,"children":2699},{"style":472},[2700],{"type":28,"value":2701},"        Password: ",{"type":22,"tag":435,"props":2703,"children":2704},{"style":482},[2705],{"type":28,"value":2706},"\"redis\"",{"type":22,"tag":435,"props":2708,"children":2709},{"style":472},[2710],{"type":28,"value":2693},{"type":22,"tag":435,"props":2712,"children":2713},{"class":437,"line":678},[2714],{"type":22,"tag":435,"props":2715,"children":2716},{"style":472},[2717],{"type":28,"value":2718},"    })\n",{"type":22,"tag":435,"props":2720,"children":2721},{"class":437,"line":686},[2722],{"type":22,"tag":435,"props":2723,"children":2724},{"emptyLinePlaceholder":5},[2725],{"type":28,"value":460},{"type":22,"tag":435,"props":2727,"children":2728},{"class":437,"line":694},[2729,2733,2738,2742,2746],{"type":22,"tag":435,"props":2730,"children":2731},{"style":442},[2732],{"type":28,"value":2602},{"type":22,"tag":435,"props":2734,"children":2735},{"style":472},[2736],{"type":28,"value":2737}," wg ",{"type":22,"tag":435,"props":2739,"children":2740},{"style":448},[2741],{"type":28,"value":526},{"type":22,"tag":435,"props":2743,"children":2744},{"style":472},[2745],{"type":28,"value":670},{"type":22,"tag":435,"props":2747,"children":2748},{"style":448},[2749],{"type":28,"value":675},{"type":22,"tag":435,"props":2751,"children":2752},{"class":437,"line":759},[2753,2757,2761,2765,2770],{"type":22,"tag":435,"props":2754,"children":2755},{"style":472},[2756],{"type":28,"value":1272},{"type":22,"tag":435,"props":2758,"children":2759},{"style":728},[2760],{"type":28,"value":1277},{"type":22,"tag":435,"props":2762,"children":2763},{"style":472},[2764],{"type":28,"value":736},{"type":22,"tag":435,"props":2766,"children":2767},{"style":802},[2768],{"type":28,"value":2769},"2",{"type":22,"tag":435,"props":2771,"children":2772},{"style":472},[2773],{"type":28,"value":556},{"type":22,"tag":435,"props":2775,"children":2776},{"class":437,"line":783},[2777],{"type":22,"tag":435,"props":2778,"children":2779},{"emptyLinePlaceholder":5},[2780],{"type":28,"value":460},{"type":22,"tag":435,"props":2782,"children":2783},{"class":437,"line":837},[2784,2788,2792],{"type":22,"tag":435,"props":2785,"children":2786},{"style":442},[2787],{"type":28,"value":1446},{"type":22,"tag":435,"props":2789,"children":2790},{"style":442},[2791],{"type":28,"value":2182},{"type":22,"tag":435,"props":2793,"children":2794},{"style":472},[2795],{"type":28,"value":2796},"() { \n",{"type":22,"tag":435,"props":2798,"children":2799},{"class":437,"line":894},[2800,2805,2810,2814],{"type":22,"tag":435,"props":2801,"children":2802},{"style":442},[2803],{"type":28,"value":2804},"        defer",{"type":22,"tag":435,"props":2806,"children":2807},{"style":472},[2808],{"type":28,"value":2809}," wg.",{"type":22,"tag":435,"props":2811,"children":2812},{"style":728},[2813],{"type":28,"value":775},{"type":22,"tag":435,"props":2815,"children":2816},{"style":472},[2817],{"type":28,"value":780},{"type":22,"tag":435,"props":2819,"children":2820},{"class":437,"line":971},[2821],{"type":22,"tag":435,"props":2822,"children":2823},{"emptyLinePlaceholder":5},[2824],{"type":28,"value":460},{"type":22,"tag":435,"props":2826,"children":2827},{"class":437,"line":980},[2828,2833,2837,2842,2847,2852,2856,2860,2865,2869,2873,2877,2882,2886,2891],{"type":22,"tag":435,"props":2829,"children":2830},{"style":472},[2831],{"type":28,"value":2832},"        err ",{"type":22,"tag":435,"props":2834,"children":2835},{"style":442},[2836],{"type":28,"value":799},{"type":22,"tag":435,"props":2838,"children":2839},{"style":472},[2840],{"type":28,"value":2841}," rdb.",{"type":22,"tag":435,"props":2843,"children":2844},{"style":728},[2845],{"type":28,"value":2846},"Watch",{"type":22,"tag":435,"props":2848,"children":2849},{"style":472},[2850],{"type":28,"value":2851},"(ctx, ",{"type":22,"tag":435,"props":2853,"children":2854},{"style":442},[2855],{"type":28,"value":700},{"type":22,"tag":435,"props":2857,"children":2858},{"style":472},[2859],{"type":28,"value":736},{"type":22,"tag":435,"props":2861,"children":2862},{"style":708},[2863],{"type":28,"value":2864},"tx",{"type":22,"tag":435,"props":2866,"children":2867},{"style":442},[2868],{"type":28,"value":746},{"type":22,"tag":435,"props":2870,"children":2871},{"style":448},[2872],{"type":28,"value":2661},{"type":22,"tag":435,"props":2874,"children":2875},{"style":472},[2876],{"type":28,"value":670},{"type":22,"tag":435,"props":2878,"children":2879},{"style":448},[2880],{"type":28,"value":2881},"Tx",{"type":22,"tag":435,"props":2883,"children":2884},{"style":472},[2885],{"type":28,"value":725},{"type":22,"tag":435,"props":2887,"children":2888},{"style":600},[2889],{"type":28,"value":2890},"error",{"type":22,"tag":435,"props":2892,"children":2893},{"style":472},[2894],{"type":28,"value":588},{"type":22,"tag":435,"props":2896,"children":2897},{"class":437,"line":988},[2898],{"type":22,"tag":435,"props":2899,"children":2900},{"emptyLinePlaceholder":5},[2901],{"type":28,"value":460},{"type":22,"tag":435,"props":2903,"children":2904},{"class":437,"line":996},[2905,2910,2914,2919,2924,2928,2932,2936,2941,2946,2950,2955,2959,2963],{"type":22,"tag":435,"props":2906,"children":2907},{"style":472},[2908],{"type":28,"value":2909},"            _, err ",{"type":22,"tag":435,"props":2911,"children":2912},{"style":442},[2913],{"type":28,"value":799},{"type":22,"tag":435,"props":2915,"children":2916},{"style":472},[2917],{"type":28,"value":2918}," tx.",{"type":22,"tag":435,"props":2920,"children":2921},{"style":728},[2922],{"type":28,"value":2923},"TxPipelined",{"type":22,"tag":435,"props":2925,"children":2926},{"style":472},[2927],{"type":28,"value":2851},{"type":22,"tag":435,"props":2929,"children":2930},{"style":442},[2931],{"type":28,"value":700},{"type":22,"tag":435,"props":2933,"children":2934},{"style":472},[2935],{"type":28,"value":736},{"type":22,"tag":435,"props":2937,"children":2938},{"style":708},[2939],{"type":28,"value":2940},"pipe",{"type":22,"tag":435,"props":2942,"children":2943},{"style":448},[2944],{"type":28,"value":2945}," redis",{"type":22,"tag":435,"props":2947,"children":2948},{"style":472},[2949],{"type":28,"value":670},{"type":22,"tag":435,"props":2951,"children":2952},{"style":448},[2953],{"type":28,"value":2954},"Pipeliner",{"type":22,"tag":435,"props":2956,"children":2957},{"style":472},[2958],{"type":28,"value":725},{"type":22,"tag":435,"props":2960,"children":2961},{"style":600},[2962],{"type":28,"value":2890},{"type":22,"tag":435,"props":2964,"children":2965},{"style":472},[2966],{"type":28,"value":588},{"type":22,"tag":435,"props":2968,"children":2969},{"class":437,"line":1064},[2970,2975,2980,2984,2989,2993,2998,3002,3006],{"type":22,"tag":435,"props":2971,"children":2972},{"style":472},[2973],{"type":28,"value":2974},"                pipe.",{"type":22,"tag":435,"props":2976,"children":2977},{"style":728},[2978],{"type":28,"value":2979},"Set",{"type":22,"tag":435,"props":2981,"children":2982},{"style":472},[2983],{"type":28,"value":2851},{"type":22,"tag":435,"props":2985,"children":2986},{"style":482},[2987],{"type":28,"value":2988},"\"x\"",{"type":22,"tag":435,"props":2990,"children":2991},{"style":472},[2992],{"type":28,"value":1047},{"type":22,"tag":435,"props":2994,"children":2995},{"style":482},[2996],{"type":28,"value":2997},"\"newValueFromA\"",{"type":22,"tag":435,"props":2999,"children":3000},{"style":472},[3001],{"type":28,"value":1047},{"type":22,"tag":435,"props":3003,"children":3004},{"style":802},[3005],{"type":28,"value":1321},{"type":22,"tag":435,"props":3007,"children":3008},{"style":472},[3009],{"type":28,"value":556},{"type":22,"tag":435,"props":3011,"children":3012},{"class":437,"line":1084},[3013,3018],{"type":22,"tag":435,"props":3014,"children":3015},{"style":442},[3016],{"type":28,"value":3017},"                return",{"type":22,"tag":435,"props":3019,"children":3020},{"style":802},[3021],{"type":28,"value":3022}," nil\n",{"type":22,"tag":435,"props":3024,"children":3025},{"class":437,"line":1133},[3026],{"type":22,"tag":435,"props":3027,"children":3028},{"style":472},[3029],{"type":28,"value":3030},"            })\n",{"type":22,"tag":435,"props":3032,"children":3033},{"class":437,"line":1152},[3034],{"type":22,"tag":435,"props":3035,"children":3036},{"emptyLinePlaceholder":5},[3037],{"type":28,"value":460},{"type":22,"tag":435,"props":3039,"children":3040},{"class":437,"line":1160},[3041,3046],{"type":22,"tag":435,"props":3042,"children":3043},{"style":442},[3044],{"type":28,"value":3045},"            return",{"type":22,"tag":435,"props":3047,"children":3048},{"style":472},[3049],{"type":28,"value":3050}," err\n",{"type":22,"tag":435,"props":3052,"children":3053},{"class":437,"line":1168},[3054,3059,3063],{"type":22,"tag":435,"props":3055,"children":3056},{"style":472},[3057],{"type":28,"value":3058},"        }, ",{"type":22,"tag":435,"props":3060,"children":3061},{"style":482},[3062],{"type":28,"value":2988},{"type":22,"tag":435,"props":3064,"children":3065},{"style":472},[3066],{"type":28,"value":556},{"type":22,"tag":435,"props":3068,"children":3069},{"class":437,"line":1186},[3070],{"type":22,"tag":435,"props":3071,"children":3072},{"emptyLinePlaceholder":5},[3073],{"type":28,"value":460},{"type":22,"tag":435,"props":3075,"children":3076},{"class":437,"line":1222},[3077,3082,3087,3092,3097],{"type":22,"tag":435,"props":3078,"children":3079},{"style":442},[3080],{"type":28,"value":3081},"        if",{"type":22,"tag":435,"props":3083,"children":3084},{"style":472},[3085],{"type":28,"value":3086}," err ",{"type":22,"tag":435,"props":3088,"children":3089},{"style":442},[3090],{"type":28,"value":3091},"!=",{"type":22,"tag":435,"props":3093,"children":3094},{"style":802},[3095],{"type":28,"value":3096}," nil",{"type":22,"tag":435,"props":3098,"children":3099},{"style":472},[3100],{"type":28,"value":588},{"type":22,"tag":435,"props":3102,"children":3103},{"class":437,"line":1258},[3104,3109,3113,3117,3122,3127,3131],{"type":22,"tag":435,"props":3105,"children":3106},{"style":472},[3107],{"type":28,"value":3108},"            log.",{"type":22,"tag":435,"props":3110,"children":3111},{"style":728},[3112],{"type":28,"value":905},{"type":22,"tag":435,"props":3114,"children":3115},{"style":472},[3116],{"type":28,"value":736},{"type":22,"tag":435,"props":3118,"children":3119},{"style":482},[3120],{"type":28,"value":3121},"\"Goroutine A aborted: ",{"type":22,"tag":435,"props":3123,"children":3124},{"style":802},[3125],{"type":28,"value":3126},"%v",{"type":22,"tag":435,"props":3128,"children":3129},{"style":482},[3130],{"type":28,"value":914},{"type":22,"tag":435,"props":3132,"children":3133},{"style":472},[3134],{"type":28,"value":3135},", err)\n",{"type":22,"tag":435,"props":3137,"children":3138},{"class":437,"line":1266},[3139,3144,3149],{"type":22,"tag":435,"props":3140,"children":3141},{"style":472},[3142],{"type":28,"value":3143},"        } ",{"type":22,"tag":435,"props":3145,"children":3146},{"style":442},[3147],{"type":28,"value":3148},"else",{"type":22,"tag":435,"props":3150,"children":3151},{"style":472},[3152],{"type":28,"value":588},{"type":22,"tag":435,"props":3154,"children":3155},{"class":437,"line":1293},[3156,3160,3164,3168,3173],{"type":22,"tag":435,"props":3157,"children":3158},{"style":472},[3159],{"type":28,"value":3108},{"type":22,"tag":435,"props":3161,"children":3162},{"style":728},[3163],{"type":28,"value":905},{"type":22,"tag":435,"props":3165,"children":3166},{"style":472},[3167],{"type":28,"value":736},{"type":22,"tag":435,"props":3169,"children":3170},{"style":482},[3171],{"type":28,"value":3172},"\"Goroutine A succeeded\"",{"type":22,"tag":435,"props":3174,"children":3175},{"style":472},[3176],{"type":28,"value":556},{"type":22,"tag":435,"props":3178,"children":3179},{"class":437,"line":1328},[3180],{"type":22,"tag":435,"props":3181,"children":3182},{"style":472},[3183],{"type":28,"value":3184},"        }\n",{"type":22,"tag":435,"props":3186,"children":3187},{"class":437,"line":1364},[3188],{"type":22,"tag":435,"props":3189,"children":3190},{"style":472},[3191],{"type":28,"value":3192},"    }()\n",{"type":22,"tag":435,"props":3194,"children":3195},{"class":437,"line":1398},[3196],{"type":22,"tag":435,"props":3197,"children":3198},{"emptyLinePlaceholder":5},[3199],{"type":28,"value":460},{"type":22,"tag":435,"props":3201,"children":3202},{"class":437,"line":1432},[3203,3207,3211],{"type":22,"tag":435,"props":3204,"children":3205},{"style":442},[3206],{"type":28,"value":1446},{"type":22,"tag":435,"props":3208,"children":3209},{"style":442},[3210],{"type":28,"value":2182},{"type":22,"tag":435,"props":3212,"children":3213},{"style":472},[3214],{"type":28,"value":2796},{"type":22,"tag":435,"props":3216,"children":3217},{"class":437,"line":1440},[3218,3222,3226,3230],{"type":22,"tag":435,"props":3219,"children":3220},{"style":442},[3221],{"type":28,"value":2804},{"type":22,"tag":435,"props":3223,"children":3224},{"style":472},[3225],{"type":28,"value":2809},{"type":22,"tag":435,"props":3227,"children":3228},{"style":728},[3229],{"type":28,"value":775},{"type":22,"tag":435,"props":3231,"children":3232},{"style":472},[3233],{"type":28,"value":780},{"type":22,"tag":435,"props":3235,"children":3236},{"class":437,"line":1463},[3237],{"type":22,"tag":435,"props":3238,"children":3239},{"emptyLinePlaceholder":5},[3240],{"type":28,"value":460},{"type":22,"tag":435,"props":3242,"children":3243},{"class":437,"line":1484},[3244,3248,3252,3256,3260,3264,3268,3272,3276,3280,3284,3288,3292,3296,3300],{"type":22,"tag":435,"props":3245,"children":3246},{"style":472},[3247],{"type":28,"value":2832},{"type":22,"tag":435,"props":3249,"children":3250},{"style":442},[3251],{"type":28,"value":799},{"type":22,"tag":435,"props":3253,"children":3254},{"style":472},[3255],{"type":28,"value":2841},{"type":22,"tag":435,"props":3257,"children":3258},{"style":728},[3259],{"type":28,"value":2846},{"type":22,"tag":435,"props":3261,"children":3262},{"style":472},[3263],{"type":28,"value":2851},{"type":22,"tag":435,"props":3265,"children":3266},{"style":442},[3267],{"type":28,"value":700},{"type":22,"tag":435,"props":3269,"children":3270},{"style":472},[3271],{"type":28,"value":736},{"type":22,"tag":435,"props":3273,"children":3274},{"style":708},[3275],{"type":28,"value":2864},{"type":22,"tag":435,"props":3277,"children":3278},{"style":442},[3279],{"type":28,"value":746},{"type":22,"tag":435,"props":3281,"children":3282},{"style":448},[3283],{"type":28,"value":2661},{"type":22,"tag":435,"props":3285,"children":3286},{"style":472},[3287],{"type":28,"value":670},{"type":22,"tag":435,"props":3289,"children":3290},{"style":448},[3291],{"type":28,"value":2881},{"type":22,"tag":435,"props":3293,"children":3294},{"style":472},[3295],{"type":28,"value":725},{"type":22,"tag":435,"props":3297,"children":3298},{"style":600},[3299],{"type":28,"value":2890},{"type":22,"tag":435,"props":3301,"children":3302},{"style":472},[3303],{"type":28,"value":588},{"type":22,"tag":435,"props":3305,"children":3306},{"class":437,"line":1515},[3307,3311,3315,3319,3323,3327,3331,3335,3339,3343,3347,3351,3355,3359],{"type":22,"tag":435,"props":3308,"children":3309},{"style":472},[3310],{"type":28,"value":2909},{"type":22,"tag":435,"props":3312,"children":3313},{"style":442},[3314],{"type":28,"value":799},{"type":22,"tag":435,"props":3316,"children":3317},{"style":472},[3318],{"type":28,"value":2918},{"type":22,"tag":435,"props":3320,"children":3321},{"style":728},[3322],{"type":28,"value":2923},{"type":22,"tag":435,"props":3324,"children":3325},{"style":472},[3326],{"type":28,"value":2851},{"type":22,"tag":435,"props":3328,"children":3329},{"style":442},[3330],{"type":28,"value":700},{"type":22,"tag":435,"props":3332,"children":3333},{"style":472},[3334],{"type":28,"value":736},{"type":22,"tag":435,"props":3336,"children":3337},{"style":708},[3338],{"type":28,"value":2940},{"type":22,"tag":435,"props":3340,"children":3341},{"style":448},[3342],{"type":28,"value":2945},{"type":22,"tag":435,"props":3344,"children":3345},{"style":472},[3346],{"type":28,"value":670},{"type":22,"tag":435,"props":3348,"children":3349},{"style":448},[3350],{"type":28,"value":2954},{"type":22,"tag":435,"props":3352,"children":3353},{"style":472},[3354],{"type":28,"value":725},{"type":22,"tag":435,"props":3356,"children":3357},{"style":600},[3358],{"type":28,"value":2890},{"type":22,"tag":435,"props":3360,"children":3361},{"style":472},[3362],{"type":28,"value":588},{"type":22,"tag":435,"props":3364,"children":3365},{"class":437,"line":1523},[3366,3370,3374,3378,3382,3386,3391,3395,3399],{"type":22,"tag":435,"props":3367,"children":3368},{"style":472},[3369],{"type":28,"value":2974},{"type":22,"tag":435,"props":3371,"children":3372},{"style":728},[3373],{"type":28,"value":2979},{"type":22,"tag":435,"props":3375,"children":3376},{"style":472},[3377],{"type":28,"value":2851},{"type":22,"tag":435,"props":3379,"children":3380},{"style":482},[3381],{"type":28,"value":2988},{"type":22,"tag":435,"props":3383,"children":3384},{"style":472},[3385],{"type":28,"value":1047},{"type":22,"tag":435,"props":3387,"children":3388},{"style":482},[3389],{"type":28,"value":3390},"\"newValueFromB\"",{"type":22,"tag":435,"props":3392,"children":3393},{"style":472},[3394],{"type":28,"value":1047},{"type":22,"tag":435,"props":3396,"children":3397},{"style":802},[3398],{"type":28,"value":1321},{"type":22,"tag":435,"props":3400,"children":3401},{"style":472},[3402],{"type":28,"value":556},{"type":22,"tag":435,"props":3404,"children":3405},{"class":437,"line":1540},[3406,3410],{"type":22,"tag":435,"props":3407,"children":3408},{"style":442},[3409],{"type":28,"value":3017},{"type":22,"tag":435,"props":3411,"children":3412},{"style":802},[3413],{"type":28,"value":3022},{"type":22,"tag":435,"props":3415,"children":3416},{"class":437,"line":1548},[3417],{"type":22,"tag":435,"props":3418,"children":3419},{"style":472},[3420],{"type":28,"value":3030},{"type":22,"tag":435,"props":3422,"children":3423},{"class":437,"line":1558},[3424],{"type":22,"tag":435,"props":3425,"children":3426},{"emptyLinePlaceholder":5},[3427],{"type":28,"value":460},{"type":22,"tag":435,"props":3429,"children":3430},{"class":437,"line":1567},[3431,3435],{"type":22,"tag":435,"props":3432,"children":3433},{"style":442},[3434],{"type":28,"value":3045},{"type":22,"tag":435,"props":3436,"children":3437},{"style":472},[3438],{"type":28,"value":3050},{"type":22,"tag":435,"props":3440,"children":3441},{"class":437,"line":1576},[3442,3446,3450],{"type":22,"tag":435,"props":3443,"children":3444},{"style":472},[3445],{"type":28,"value":3058},{"type":22,"tag":435,"props":3447,"children":3448},{"style":482},[3449],{"type":28,"value":2988},{"type":22,"tag":435,"props":3451,"children":3452},{"style":472},[3453],{"type":28,"value":556},{"type":22,"tag":435,"props":3455,"children":3456},{"class":437,"line":1585},[3457],{"type":22,"tag":435,"props":3458,"children":3459},{"emptyLinePlaceholder":5},[3460],{"type":28,"value":460},{"type":22,"tag":435,"props":3462,"children":3463},{"class":437,"line":1594},[3464,3468,3472,3476,3480],{"type":22,"tag":435,"props":3465,"children":3466},{"style":442},[3467],{"type":28,"value":3081},{"type":22,"tag":435,"props":3469,"children":3470},{"style":472},[3471],{"type":28,"value":3086},{"type":22,"tag":435,"props":3473,"children":3474},{"style":442},[3475],{"type":28,"value":3091},{"type":22,"tag":435,"props":3477,"children":3478},{"style":802},[3479],{"type":28,"value":3096},{"type":22,"tag":435,"props":3481,"children":3482},{"style":472},[3483],{"type":28,"value":588},{"type":22,"tag":435,"props":3485,"children":3486},{"class":437,"line":1603},[3487,3491,3495,3499,3504,3508,3512],{"type":22,"tag":435,"props":3488,"children":3489},{"style":472},[3490],{"type":28,"value":3108},{"type":22,"tag":435,"props":3492,"children":3493},{"style":728},[3494],{"type":28,"value":905},{"type":22,"tag":435,"props":3496,"children":3497},{"style":472},[3498],{"type":28,"value":736},{"type":22,"tag":435,"props":3500,"children":3501},{"style":482},[3502],{"type":28,"value":3503},"\"Goroutine B aborted: ",{"type":22,"tag":435,"props":3505,"children":3506},{"style":802},[3507],{"type":28,"value":3126},{"type":22,"tag":435,"props":3509,"children":3510},{"style":482},[3511],{"type":28,"value":914},{"type":22,"tag":435,"props":3513,"children":3514},{"style":472},[3515],{"type":28,"value":3135},{"type":22,"tag":435,"props":3517,"children":3518},{"class":437,"line":1612},[3519,3523,3527],{"type":22,"tag":435,"props":3520,"children":3521},{"style":472},[3522],{"type":28,"value":3143},{"type":22,"tag":435,"props":3524,"children":3525},{"style":442},[3526],{"type":28,"value":3148},{"type":22,"tag":435,"props":3528,"children":3529},{"style":472},[3530],{"type":28,"value":588},{"type":22,"tag":435,"props":3532,"children":3534},{"class":437,"line":3533},56,[3535,3539,3543,3547,3552],{"type":22,"tag":435,"props":3536,"children":3537},{"style":472},[3538],{"type":28,"value":3108},{"type":22,"tag":435,"props":3540,"children":3541},{"style":728},[3542],{"type":28,"value":905},{"type":22,"tag":435,"props":3544,"children":3545},{"style":472},[3546],{"type":28,"value":736},{"type":22,"tag":435,"props":3548,"children":3549},{"style":482},[3550],{"type":28,"value":3551},"\"Goroutine B succeeded\"",{"type":22,"tag":435,"props":3553,"children":3554},{"style":472},[3555],{"type":28,"value":556},{"type":22,"tag":435,"props":3557,"children":3559},{"class":437,"line":3558},57,[3560],{"type":22,"tag":435,"props":3561,"children":3562},{"style":472},[3563],{"type":28,"value":3184},{"type":22,"tag":435,"props":3565,"children":3567},{"class":437,"line":3566},58,[3568],{"type":22,"tag":435,"props":3569,"children":3570},{"style":472},[3571],{"type":28,"value":3192},{"type":22,"tag":435,"props":3573,"children":3575},{"class":437,"line":3574},59,[3576],{"type":22,"tag":435,"props":3577,"children":3578},{"emptyLinePlaceholder":5},[3579],{"type":28,"value":460},{"type":22,"tag":435,"props":3581,"children":3583},{"class":437,"line":3582},60,[3584,3588,3592],{"type":22,"tag":435,"props":3585,"children":3586},{"style":472},[3587],{"type":28,"value":1272},{"type":22,"tag":435,"props":3589,"children":3590},{"style":728},[3591],{"type":28,"value":1533},{"type":22,"tag":435,"props":3593,"children":3594},{"style":472},[3595],{"type":28,"value":780},{"type":22,"tag":435,"props":3597,"children":3599},{"class":437,"line":3598},61,[3600],{"type":22,"tag":435,"props":3601,"children":3602},{"emptyLinePlaceholder":5},[3603],{"type":28,"value":460},{"type":22,"tag":435,"props":3605,"children":3607},{"class":437,"line":3606},62,[3608,3613,3617,3621,3626,3630,3634,3639,3644],{"type":22,"tag":435,"props":3609,"children":3610},{"style":472},[3611],{"type":28,"value":3612},"    value, err ",{"type":22,"tag":435,"props":3614,"children":3615},{"style":442},[3616],{"type":28,"value":799},{"type":22,"tag":435,"props":3618,"children":3619},{"style":472},[3620],{"type":28,"value":2841},{"type":22,"tag":435,"props":3622,"children":3623},{"style":728},[3624],{"type":28,"value":3625},"Get",{"type":22,"tag":435,"props":3627,"children":3628},{"style":472},[3629],{"type":28,"value":2851},{"type":22,"tag":435,"props":3631,"children":3632},{"style":482},[3633],{"type":28,"value":2988},{"type":22,"tag":435,"props":3635,"children":3636},{"style":472},[3637],{"type":28,"value":3638},").",{"type":22,"tag":435,"props":3640,"children":3641},{"style":728},[3642],{"type":28,"value":3643},"Result",{"type":22,"tag":435,"props":3645,"children":3646},{"style":472},[3647],{"type":28,"value":780},{"type":22,"tag":435,"props":3649,"children":3651},{"class":437,"line":3650},63,[3652,3656,3660,3664,3668],{"type":22,"tag":435,"props":3653,"children":3654},{"style":442},[3655],{"type":28,"value":2079},{"type":22,"tag":435,"props":3657,"children":3658},{"style":472},[3659],{"type":28,"value":3086},{"type":22,"tag":435,"props":3661,"children":3662},{"style":442},[3663],{"type":28,"value":3091},{"type":22,"tag":435,"props":3665,"children":3666},{"style":802},[3667],{"type":28,"value":3096},{"type":22,"tag":435,"props":3669,"children":3670},{"style":472},[3671],{"type":28,"value":588},{"type":22,"tag":435,"props":3673,"children":3675},{"class":437,"line":3674},64,[3676,3680,3685,3689,3694,3698,3702],{"type":22,"tag":435,"props":3677,"children":3678},{"style":472},[3679],{"type":28,"value":900},{"type":22,"tag":435,"props":3681,"children":3682},{"style":728},[3683],{"type":28,"value":3684},"Fatalf",{"type":22,"tag":435,"props":3686,"children":3687},{"style":472},[3688],{"type":28,"value":736},{"type":22,"tag":435,"props":3690,"children":3691},{"style":482},[3692],{"type":28,"value":3693},"\"Could not get x: ",{"type":22,"tag":435,"props":3695,"children":3696},{"style":802},[3697],{"type":28,"value":3126},{"type":22,"tag":435,"props":3699,"children":3700},{"style":482},[3701],{"type":28,"value":914},{"type":22,"tag":435,"props":3703,"children":3704},{"style":472},[3705],{"type":28,"value":3135},{"type":22,"tag":435,"props":3707,"children":3709},{"class":437,"line":3708},65,[3710],{"type":22,"tag":435,"props":3711,"children":3712},{"style":472},[3713],{"type":28,"value":977},{"type":22,"tag":435,"props":3715,"children":3717},{"class":437,"line":3716},66,[3718],{"type":22,"tag":435,"props":3719,"children":3720},{"emptyLinePlaceholder":5},[3721],{"type":28,"value":460},{"type":22,"tag":435,"props":3723,"children":3725},{"class":437,"line":3724},67,[3726,3731,3735,3739,3744,3748,3752],{"type":22,"tag":435,"props":3727,"children":3728},{"style":472},[3729],{"type":28,"value":3730},"    log.",{"type":22,"tag":435,"props":3732,"children":3733},{"style":728},[3734],{"type":28,"value":905},{"type":22,"tag":435,"props":3736,"children":3737},{"style":472},[3738],{"type":28,"value":736},{"type":22,"tag":435,"props":3740,"children":3741},{"style":482},[3742],{"type":28,"value":3743},"\"Final value of x: ",{"type":22,"tag":435,"props":3745,"children":3746},{"style":802},[3747],{"type":28,"value":3126},{"type":22,"tag":435,"props":3749,"children":3750},{"style":482},[3751],{"type":28,"value":914},{"type":22,"tag":435,"props":3753,"children":3754},{"style":472},[3755],{"type":28,"value":3756},", value)\n",{"type":22,"tag":435,"props":3758,"children":3760},{"class":437,"line":3759},68,[3761],{"type":22,"tag":435,"props":3762,"children":3763},{"style":472},[3764],{"type":28,"value":612},{"type":22,"tag":435,"props":3766,"children":3768},{"class":437,"line":3767},69,[3769],{"type":22,"tag":435,"props":3770,"children":3771},{"style":1552},[3772],{"type":28,"value":1555},{"type":22,"tag":435,"props":3774,"children":3776},{"class":437,"line":3775},70,[3777],{"type":22,"tag":435,"props":3778,"children":3779},{"style":1552},[3780],{"type":28,"value":3781},"2023/09/04 00:06:19 Goroutine A aborted: redis: transaction failed\n",{"type":22,"tag":435,"props":3783,"children":3785},{"class":437,"line":3784},71,[3786],{"type":22,"tag":435,"props":3787,"children":3788},{"style":1552},[3789],{"type":28,"value":3790},"2023/09/04 00:06:19 Goroutine B succeeded\n",{"type":22,"tag":435,"props":3792,"children":3794},{"class":437,"line":3793},72,[3795],{"type":22,"tag":435,"props":3796,"children":3797},{"style":1552},[3798],{"type":28,"value":3799},"2023/09/04 00:06:19 Final value of x: newValueFromB\n",{"type":22,"tag":435,"props":3801,"children":3803},{"class":437,"line":3802},73,[3804],{"type":22,"tag":435,"props":3805,"children":3806},{"style":1552},[3807],{"type":28,"value":1618},{"type":22,"tag":30,"props":3809,"children":3811},{"id":3810},"依賴線性一致性",[3812],{"type":28,"value":3810},{"type":22,"tag":137,"props":3814,"children":3815},{},[3816],{"type":28,"value":300},{"type":22,"tag":137,"props":3818,"children":3819},{},[3820],{"type":28,"value":3821},"線性一致性在什麼情況下有用？觀看體育比賽的最後得分可能是一個輕率的例子：滯後了幾秒鐘的結果不太可能在這種情況下造成任何真正的傷害。然而對於少數領域，線性一致性是系統正確工作的一個重要條件。",{"type":22,"tag":418,"props":3823,"children":3825},{"id":3824},"鎖定和領導選舉",[3826],{"type":22,"tag":51,"props":3827,"children":3828},{},[3829],{"type":22,"tag":55,"props":3830,"children":3833},{"href":3831,"rel":3832},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%8e%96%e5%ae%9a%e5%92%8c%e9%a0%98%e5%b0%8e%e9%81%b8%e8%88%89",[59],[3834],{"type":28,"value":3824},{"type":22,"tag":137,"props":3836,"children":3837},{},[3838],{"type":28,"value":3839},"在單主複製架構中，只有一個領導者（也叫做主節點）負責執行所有寫操作，以預防腦裂現象，即避免多個節點同時認為自己是領導者。為了協調哪個節點可以成為領導者，系統會採用分散式鎖。這種鎖必須要達到線性一致性，也就是所有節點必須共識到誰擁有這把鎖。協調服務像 Apache ZooKeeper 和 etcd 常被用來實現這樣的分散式鎖和領導者選舉。儘管它們提供了線性一致性的寫操作，讀取數據可能仍是過時的，因為這些讀取操作可能由任何一個副本完成。",{"type":22,"tag":418,"props":3841,"children":3843},{"id":3842},"約束和唯一性保證",[3844],{"type":22,"tag":51,"props":3845,"children":3846},{},[3847],{"type":22,"tag":55,"props":3848,"children":3851},{"href":3849,"rel":3850},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b4%84%e6%9d%9f%e5%92%8c%e5%94%af%e4%b8%80%e6%80%a7%e4%bf%9d%e8%ad%89",[59],[3852],{"type":28,"value":3842},{"type":22,"tag":137,"props":3854,"children":3855},{},[3856,3858,3863,3865,3870],{"type":28,"value":3857},"在維持關聯式資料庫中的",{"type":22,"tag":51,"props":3859,"children":3860},{},[3861],{"type":28,"value":3862},"PRIMARY KEY",{"type":28,"value":3864},"和",{"type":22,"tag":51,"props":3866,"children":3867},{},[3868],{"type":28,"value":3869},"UNIQUE",{"type":28,"value":3871},"約束時，通常會使用線性一致性來確保所有節點達到共識。例如，在一個用戶註冊系統中，可能會選擇使用電郵作為唯一識別。如果沒有線性一致性，這可能導致資料不一致或用戶重複註冊。",{"type":22,"tag":137,"props":3873,"children":3874},{},[3875,3877,3882,3884,3889,3891,3896,3898,3902,3904,3908],{"type":28,"value":3876},"對於更寬鬆的約束，如",{"type":22,"tag":51,"props":3878,"children":3879},{},[3880],{"type":28,"value":3881},"FOREIGN KEY",{"type":28,"value":3883},"，線性一致性不一定是必須的。以電商平台為例，",{"type":22,"tag":51,"props":3885,"children":3886},{},[3887],{"type":28,"value":3888},"Orders",{"type":28,"value":3890}," 表與 ",{"type":22,"tag":51,"props":3892,"children":3893},{},[3894],{"type":28,"value":3895},"Products",{"type":28,"value":3897}," 表是緊密相關的。新商品一旦加入 ",{"type":22,"tag":51,"props":3899,"children":3900},{},[3901],{"type":28,"value":3895},{"type":28,"value":3903}," 表，便可能會立即在搜索結果中出現，但相對應的訂單處理（涉及 ",{"type":22,"tag":51,"props":3905,"children":3906},{},[3907],{"type":28,"value":3888},{"type":28,"value":3909}," 表）可能會因為庫存或價格等因素稍微延後。在這樣的情境下，最終一致性會是一個更靈活的選擇。",{"type":22,"tag":418,"props":3911,"children":3913},{"id":3912},"跨通道的時序依賴",[3914],{"type":22,"tag":51,"props":3915,"children":3916},{},[3917],{"type":22,"tag":55,"props":3918,"children":3921},{"href":3919,"rel":3920},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e8%b7%a8%e9%80%9a%e9%81%93%e7%9a%84%e6%99%82%e5%ba%8f%e4%be%9d%e8%b3%b4",[59],[3922],{"type":28,"value":3912},{"type":22,"tag":137,"props":3924,"children":3925},{},[3926],{"type":28,"value":3927},"圖9-1中有一個細節：如果Alice沒有喊德國贏了Bob就不會靠腰資料是舊的，是因為這個系統多了一個額外通道(通話)才導致發現線性不一致。",{"type":22,"tag":137,"props":3929,"children":3930},{},[3931,3933,3938],{"type":28,"value":3932},"計算機系統也會出現類似的情況。例如，假設有一個網站，使用者可以上傳照片，一個後臺程序會調整照片大小，降低解析度以加快下載速度（縮圖）。該系統的架構和資料流如",{"type":22,"tag":51,"props":3934,"children":3935},{},[3936],{"type":28,"value":3937},"圖 9-5",{"type":28,"value":3939},"所示",{"type":22,"tag":137,"props":3941,"children":3942},{},[3943],{"type":28,"value":3944},"假設有一個網站使用者上傳照片，後台會縮小照片降低解析度增加下載速度(縮圖)。",{"type":22,"tag":137,"props":3946,"children":3947},{},[3948],{"type":22,"tag":341,"props":3949,"children":3952},{"alt":3950,"src":3951},"圖 9-5 Web 伺服器和影象縮放器透過檔案儲存和訊息佇列進行通訊，開啟競爭條件的可能性。","https://vonng.github.io/ddia/img/fig9-5.png",[],{"type":22,"tag":137,"props":3954,"children":3955},{},[3956],{"type":22,"tag":51,"props":3957,"children":3958},{},[3959],{"type":28,"value":3950},{"type":22,"tag":137,"props":3961,"children":3962},{},[3963],{"type":28,"value":357},{"type":22,"tag":137,"props":3965,"children":3966},{},[3967],{"type":28,"value":3968},"1.使用者上傳照片(1.jpg)到Web server",{"type":22,"tag":137,"props":3970,"children":3971},{},[3972],{"type":28,"value":3973},"2.Web server將照片(UUID.jpg)放到File storage(/temp)儲存",{"type":22,"tag":137,"props":3975,"children":3976},{},[3977],{"type":28,"value":3978},"3.將一個訊息push到MQ(UUID.jpg,/temp)",{"type":22,"tag":137,"props":3980,"children":3981},{},[3982],{"type":28,"value":3983},"4.MQ通知Image resizer要縮小的檔案位置(/temp/UUID.jpg)",{"type":22,"tag":137,"props":3985,"children":3986},{},[3987],{"type":28,"value":3988},"5.Image resizer讀取File storage的照片(/temp/UUID.jpg)",{"type":22,"tag":137,"props":3990,"children":3991},{},[3992],{"type":28,"value":3993},"6.Image resizer處理完縮小照片後上傳到File storage(/result/UUID.jpg)給使用者下載",{"type":22,"tag":137,"props":3995,"children":3996},{},[3997],{"type":28,"value":3998},"如果MQ比File stroage複製的更快，可能會導致步驟5出現舊的影像或沒有影像，如果某個節點處理是舊的影像則就產生了永久性的不一致。",{"type":22,"tag":137,"props":4000,"children":4001},{},[4002],{"type":28,"value":4003},"出現這個問題是因為Web server和Image resizer之間存在不同的通道：File storage與MQ，這兩個通道之間有可能產生競爭條件。這種狀況類似Alice與Bob語音通訊與網頁更新也存在了競爭條件。",{"type":22,"tag":137,"props":4005,"children":4006},{},[4007,4009,4014],{"type":28,"value":4008},"線性一致性並不是避免這種競爭條件的唯一方法，只是這種方式最容易理解，如果可以透過控制MQ則可以使用第五章(",{"type":22,"tag":51,"props":4010,"children":4011},{},[4012],{"type":28,"value":4013},"Read-Your-Writes Consistency",{"type":28,"value":4015},")類似的方法，但是會有而外的複雜代價。",{"type":22,"tag":418,"props":4017,"children":4019},{"id":4018},"第五章read-your-writes-consistency-補全",[4020,4022,4027],{"type":28,"value":4021},"第五章",{"type":22,"tag":51,"props":4023,"children":4024},{},[4025],{"type":28,"value":4026},"Read-Your-Writes Consistency ~~",{"type":28,"value":4028},"*補全~~",{"type":22,"tag":137,"props":4030,"children":4031},{},[4032],{"type":28,"value":4033},"當使用者寫入一則評論，有可能重新整理頁面發現剛剛寫入的資料不見了(可能從其他節點讀取但是那個節點根本還沒有被Leader更新)，因此使用者困惑了可能會再次寫入剛剛的評論，所以要在寫入Leader的時候直接讀取使用者評論，這樣就可以避免使用者讀取到尚未最終一致性的資料。",{"type":22,"tag":137,"props":4035,"children":4036},{},[4037],{"type":22,"tag":341,"props":4038,"children":4041},{"alt":4039,"src":4040},"圖 5-3 使用者寫入後從舊副本中讀取資料。需要寫後讀 (read-after-write) 的一致性來防止這種異常","https://vonng.github.io/ddia/img/fig5-3.png",[],{"type":22,"tag":137,"props":4043,"children":4044},{},[4045],{"type":22,"tag":51,"props":4046,"children":4047},{},[4048],{"type":28,"value":4039},{"type":22,"tag":137,"props":4050,"children":4051},{},[4052],{"type":28,"value":357},{"type":22,"tag":137,"props":4054,"children":4055},{},[4056],{"type":28,"value":4057},"1.User寫評論到Leader然後",{"type":22,"tag":137,"props":4059,"children":4060},{},[4061],{"type":28,"value":4062},"2.使用者去Follower2讀取剛剛的comments並沒有剛剛寫入55555的評論",{"type":22,"tag":137,"props":4064,"children":4065},{},[4066],{"type":28,"value":4067},"3.Leader過了一段時間才完成最終一致性這時候User才能取到真剛剛寫入的55555",{"type":22,"tag":137,"props":4069,"children":4070},{},[4071],{"type":28,"value":4072},"總結：",{"type":22,"tag":137,"props":4074,"children":4075},{},[4076],{"type":28,"value":4077},"可以利用寫入Leader寫入回傳的ok來處理讀自己寫的假資料至少讓他不要去Follower2去查看發現資料不對",{"type":22,"tag":30,"props":4079,"children":4081},{"id":4080},"實現線性一致的系統",[4082],{"type":28,"value":4080},{"type":22,"tag":137,"props":4084,"children":4085},{},[4086],{"type":28,"value":300},{"type":22,"tag":137,"props":4088,"children":4089},{},[4090],{"type":28,"value":4091},"由於線性一致性本質上意味著 “表現得好像只有一個數據副本，而且所有的操作都是原子的”，所以最簡單的答案就是，真的只用一個數據副本。但是這種方法無法容錯：如果持有該副本的節點失效，資料將會丟失，或者至少無法訪問，直到節點重新啟動。",{"type":22,"tag":137,"props":4093,"children":4094},{},[4095,4097,4106],{"type":28,"value":4096},"使系統容錯最常用的方法是使用複製。我們再來回顧 ",{"type":22,"tag":51,"props":4098,"children":4099},{},[4100],{"type":22,"tag":55,"props":4101,"children":4104},{"href":4102,"rel":4103},"https://vonng.github.io/ddia/#/zh-tw/ch5",[59],[4105],{"type":28,"value":4021},{"type":28,"value":4107}," 中的複製方法，並比較它們是否可以滿足線性一致性：",{"type":22,"tag":41,"props":4109,"children":4110},{},[4111,4177,4187,4209],{"type":22,"tag":45,"props":4112,"children":4113},{},[4114,4116,4120,4122,4132,4134,4139,4141,4146,4148,4151,4153,4163,4165,4175],{"type":28,"value":4115},"單主複製（可能線性一致）",{"type":22,"tag":4117,"props":4118,"children":4119},"br",{},[],{"type":28,"value":4121},"在具有單主複製功能的系統中（請參閱 “",{"type":22,"tag":51,"props":4123,"children":4124},{},[4125],{"type":22,"tag":55,"props":4126,"children":4129},{"href":4127,"rel":4128},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e9%a0%98%e5%b0%8e%e8%80%85%e8%88%87%e8%bf%bd%e9%9a%a8%e8%80%85",[59],[4130],{"type":28,"value":4131},"領導者與追隨者",{"type":28,"value":4133},"”），主庫具有用於寫入的資料的主副本，而追隨者在其他節點上保留資料的備份副本。如果從主庫或同步更新的從庫讀取資料，它們 ",{"type":22,"tag":51,"props":4135,"children":4136},{},[4137],{"type":28,"value":4138},"可能（potential）",{"type":28,"value":4140}," 是線性一致性的 ",{"type":22,"tag":435,"props":4142,"children":4143},{},[4144],{"type":28,"value":4145},"^iv",{"type":28,"value":4147},"。然而，實際上並不是每個單主資料庫都是線性一致性的，無論是因為設計的原因（例如，因為使用了快照隔離）還是因為在併發處理上存在錯誤【10】。",{"type":22,"tag":4117,"props":4149,"children":4150},{},[],{"type":28,"value":4152},"從主庫讀取依賴一個假設，你確切地知道領導者是誰。正如在 “",{"type":22,"tag":51,"props":4154,"children":4155},{},[4156],{"type":22,"tag":55,"props":4157,"children":4160},{"href":4158,"rel":4159},"https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e7%9c%9f%e7%9b%b8%e7%94%b1%e5%a4%9a%e6%95%b8%e6%89%80%e5%ae%9a%e7%be%a9",[59],[4161],{"type":28,"value":4162},"真相由多數所定義",{"type":28,"value":4164},"” 中所討論的那樣，一個節點很可能會認為它是領導者，而事實上並非如此 —— 如果具有錯覺的領導者繼續為請求提供服務，可能違反線性一致性【20】。使用非同步複製，故障切換時甚至可能會丟失已提交的寫入（請參閱 “",{"type":22,"tag":51,"props":4166,"children":4167},{},[4168],{"type":22,"tag":55,"props":4169,"children":4172},{"href":4170,"rel":4171},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e8%99%95%e7%90%86%e7%af%80%e9%bb%9e%e5%ae%95%e6%a9%9f",[59],[4173],{"type":28,"value":4174},"處理節點宕機",{"type":28,"value":4176},"”），這同時違反了永續性和線性一致性。",{"type":22,"tag":45,"props":4178,"children":4179},{},[4180,4182,4185],{"type":28,"value":4181},"共識演算法（線性一致）",{"type":22,"tag":4117,"props":4183,"children":4184},{},[],{"type":28,"value":4186},"一些在本章後面討論的共識演算法，與單主複製類似。然而，共識協議包含防止腦裂和陳舊副本的措施。正是由於這些細節，共識演算法可以安全地實現線性一致性儲存。例如，Zookeeper 【21】和 etcd 【22】就是這樣工作的。",{"type":22,"tag":45,"props":4188,"children":4189},{},[4190,4192,4195,4197,4207],{"type":28,"value":4191},"多主複製（非線性一致）",{"type":22,"tag":4117,"props":4193,"children":4194},{},[],{"type":28,"value":4196},"具有多主程式複製的系統通常不是線性一致的，因為它們同時在多個節點上處理寫入，並將其非同步複製到其他節點。因此，它們可能會產生需要被解決的寫入衝突（請參閱 “",{"type":22,"tag":51,"props":4198,"children":4199},{},[4200],{"type":22,"tag":55,"props":4201,"children":4204},{"href":4202,"rel":4203},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e8%99%95%e7%90%86%e5%af%ab%e5%85%a5%e8%a1%9d%e7%aa%81",[59],[4205],{"type":28,"value":4206},"處理寫入衝突",{"type":28,"value":4208},"”）。這種衝突是因為缺少單一資料副本所導致的。",{"type":22,"tag":45,"props":4210,"children":4211},{},[4212,4214,4217,4219,4229,4231,4234,4236,4246,4248,4258,4260,4271,4274,4276,4279,4281,4284,4286,4289,4291,4294,4299,4302,4306,4309,4311,4314,4316,4319,4321,4324,4326,4329,4331,4334],{"type":28,"value":4213},"無主複製（也許不是線性一致的）",{"type":22,"tag":4117,"props":4215,"children":4216},{},[],{"type":28,"value":4218},"對於無主複製的系統（Dynamo 風格；請參閱 “",{"type":22,"tag":51,"props":4220,"children":4221},{},[4222],{"type":22,"tag":55,"props":4223,"children":4226},{"href":4224,"rel":4225},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e7%84%a1%e4%b8%bb%e8%a4%87%e8%a3%bd",[59],[4227],{"type":28,"value":4228},"無主複製",{"type":28,"value":4230},"”），有時候人們會聲稱透過要求法定人數讀寫(w+r>n)可以獲得 “強一致性”。這取決於法定人數的具體配置，以及強一致性如何定義（通常不完全正確）。",{"type":22,"tag":4117,"props":4232,"children":4233},{},[],{"type":28,"value":4235},"基於日曆時鐘（例如，在 Cassandra 中；請參閱 “",{"type":22,"tag":51,"props":4237,"children":4238},{},[4239],{"type":22,"tag":55,"props":4240,"children":4243},{"href":4241,"rel":4242},"https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e4%be%9d%e8%b3%b4%e5%90%8c%e6%ad%a5%e6%99%82%e9%90%98",[59],[4244],{"type":28,"value":4245},"依賴同步時鐘",{"type":28,"value":4247},"”）的 “最後寫入勝利” 衝突解決方法幾乎可以確定是非線性一致的，由於時鐘偏差，不能保證時鐘的時間戳與實際事件順序一致。寬鬆的法定人數（請參閱 “",{"type":22,"tag":51,"props":4249,"children":4250},{},[4251],{"type":22,"tag":55,"props":4252,"children":4255},{"href":4253,"rel":4254},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e5%af%ac%e9%ac%86%e7%9a%84%e6%b3%95%e5%ae%9a%e4%ba%ba%e6%95%b8%e8%88%87%e6%8f%90%e7%a4%ba%e7%a7%bb%e4%ba%a4",[59],[4256],{"type":28,"value":4257},"寬鬆的法定人數與提示移交",{"type":28,"value":4259},"”）也破壞了線性一致的可能性。即使使用嚴格的法定人數，非線性一致的行為也是可能的，如下節所示。",{"type":22,"tag":418,"props":4261,"children":4263},{"id":4262},"第五章無主複製-補全",[4264,4266],{"type":28,"value":4265},"第五章無主複製 ",{"type":22,"tag":107,"props":4267,"children":4268},{},[4269],{"type":28,"value":4270},"補全",{"type":22,"tag":4117,"props":4272,"children":4273},{},[],{"type":28,"value":4275},"使用者每次都讀寫多個複製件",{"type":22,"tag":4117,"props":4277,"children":4278},{},[],{"type":28,"value":4280},"讀寫法定人數：",{"type":22,"tag":4117,"props":4282,"children":4283},{},[],{"type":28,"value":4285},"公式 w+r>n 讀加寫要大於總結點",{"type":22,"tag":4117,"props":4287,"children":4288},{},[],{"type":28,"value":4290},"因爲n=3 w=2 r=2 所以2+2>3成立",{"type":22,"tag":4117,"props":4292,"children":4293},{},[],{"type":22,"tag":341,"props":4295,"children":4298},{"alt":4296,"src":4297},"圖 5-10 法定寫入，法定讀取，並在節點中斷後讀修復。","https://vonng.github.io/ddia/img/fig5-10.png",[],{"type":22,"tag":4117,"props":4300,"children":4301},{},[],{"type":22,"tag":51,"props":4303,"children":4304},{},[4305],{"type":28,"value":4296},{"type":22,"tag":4117,"props":4307,"children":4308},{},[],{"type":28,"value":4310},"敘述：",{"type":22,"tag":4117,"props":4312,"children":4313},{},[],{"type":28,"value":4315},"1.UserA寫入N1 N2 ‘me-new.jpg’(因為N3死掉了)",{"type":22,"tag":4117,"props":4317,"children":4318},{},[],{"type":28,"value":4320},"2.UserB讀取N1 N2 N3 結果發現N3的版本是6其他是7",{"type":22,"tag":4117,"props":4322,"children":4323},{},[],{"type":28,"value":4325},"3.UserB就將N3 ’me-new.jpg’的version設定成7",{"type":22,"tag":4117,"props":4327,"children":4328},{},[],{"type":28,"value":4330},"結論：",{"type":22,"tag":4117,"props":4332,"children":4333},{},[],{"type":28,"value":4335},"無主複製就是要將監督機制直接寫在使用者身上(應用層)而不是讓資料庫自己去發現",{"type":22,"tag":418,"props":4337,"children":4339},{"id":4338},"線性一致性和法定人數",[4340],{"type":22,"tag":51,"props":4341,"children":4342},{},[4343],{"type":22,"tag":55,"props":4344,"children":4347},{"href":4345,"rel":4346},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%92%8c%e6%b3%95%e5%ae%9a%e4%ba%ba%e6%95%b8",[59],[4348],{"type":28,"value":4338},{"type":22,"tag":137,"props":4350,"children":4351},{},[4352],{"type":28,"value":300},{"type":22,"tag":137,"props":4354,"children":4355},{},[4356],{"type":28,"value":4357},"直覺上無主複製模型中嚴格的法定人數應該是線性一致的。但是當可變的網路延遲就能產生競爭條件。",{"type":22,"tag":137,"props":4359,"children":4360},{},[4361],{"type":22,"tag":341,"props":4362,"children":4365},{"alt":4363,"src":4364},"圖 9-6 非線性一致的執行，儘管使用了嚴格的法定人數","https://vonng.github.io/ddia/img/fig9-6.png",[],{"type":22,"tag":137,"props":4367,"children":4368},{},[4369],{"type":22,"tag":51,"props":4370,"children":4371},{},[4372],{"type":28,"value":4363},{"type":22,"tag":137,"props":4374,"children":4375},{},[4376],{"type":28,"value":4310},{"type":22,"tag":137,"props":4378,"children":4379},{},[4380],{"type":28,"value":4381},"w = 3 r = 2 n = 3",{"type":22,"tag":4383,"props":4384,"children":4385},"ol",{},[4386,4391,4396,4401],{"type":22,"tag":45,"props":4387,"children":4388},{},[4389],{"type":28,"value":4390},"x=0",{"type":22,"tag":45,"props":4392,"children":4393},{},[4394],{"type":28,"value":4395},"Writer 寫入x = 1 到 N1 N2 N3(最快寫入)",{"type":22,"tag":45,"props":4397,"children":4398},{},[4399],{"type":28,"value":4400},"ReaderA 讀取N1(X) N2(x=0) N3(x=1)",{"type":22,"tag":45,"props":4402,"children":4403},{},[4404],{"type":28,"value":4405},"ReaderB 讀取N1(x=0) N2(x=0) N3(X)",{"type":22,"tag":137,"props":4407,"children":4408},{},[4409],{"type":28,"value":4330},{"type":22,"tag":137,"props":4411,"children":4412},{},[4413],{"type":28,"value":4414},"就算法定人數正確也無法保證線性一致，所以最安全的做法就是當作無主複製系統不能提供線性一致",{"type":22,"tag":30,"props":4416,"children":4418},{"id":4417},"線性一致性的代價",[4419],{"type":28,"value":4417},{"type":22,"tag":137,"props":4421,"children":4422},{},[4423],{"type":28,"value":300},{"type":22,"tag":137,"props":4425,"children":4426},{},[4427],{"type":28,"value":4428},"一些複製方法可以提供線性一致性，另一些複製方法則不能，因此深入地探討線性一致性的優缺點是很有趣的。",{"type":22,"tag":137,"props":4430,"children":4431},{},[4432,4434,4442,4444,4454,4456,4466],{"type":28,"value":4433},"我們已經在 ",{"type":22,"tag":51,"props":4435,"children":4436},{},[4437],{"type":22,"tag":55,"props":4438,"children":4440},{"href":4102,"rel":4439},[59],[4441],{"type":28,"value":4021},{"type":28,"value":4443}," 中討論了不同複製方法的一些用例。例如對多資料中心的複製而言，多主複製通常是理想的選擇（請參閱 “",{"type":22,"tag":51,"props":4445,"children":4446},{},[4447],{"type":22,"tag":55,"props":4448,"children":4451},{"href":4449,"rel":4450},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e9%81%8b%e7%b6%ad%e5%a4%9a%e5%80%8b%e6%95%b8%e6%93%9a%e4%b8%ad%e5%bf%83",[59],[4452],{"type":28,"value":4453},"運維多個數據中心",{"type":28,"value":4455},"”）。",{"type":22,"tag":51,"props":4457,"children":4458},{},[4459],{"type":22,"tag":55,"props":4460,"children":4463},{"href":4461,"rel":4462},"https://vonng.github.io/ddia/#/img/fig9-7.png",[59],[4464],{"type":28,"value":4465},"圖 9-7",{"type":28,"value":4467}," 說明了這種部署的一個例子。",{"type":22,"tag":137,"props":4469,"children":4470},{},[4471],{"type":22,"tag":341,"props":4472,"children":4475},{"alt":4473,"src":4474},"圖 9-7 網路中斷迫使線性一致性和可用性之間做出選擇。","https://vonng.github.io/ddia/img/fig9-7.png",[],{"type":22,"tag":137,"props":4477,"children":4478},{},[4479],{"type":22,"tag":51,"props":4480,"children":4481},{},[4482],{"type":28,"value":4473},{"type":22,"tag":137,"props":4484,"children":4485},{},[4486],{"type":28,"value":4310},{"type":22,"tag":137,"props":4488,"children":4489},{},[4490],{"type":28,"value":4491},"多主資料庫：兩個datacenter還是可以單獨使用等到網路恢復後只需要排隊並交換",{"type":22,"tag":137,"props":4493,"children":4494},{},[4495],{"type":28,"value":4496},"單主複製：從庫資料中心無法寫入也不能執行任何線性一致的讀取，但是還是可以不使用線性一致的讀取但是讀的資料可能是舊的。",{"type":22,"tag":137,"props":4498,"children":4499},{},[4500],{"type":28,"value":4330},{"type":22,"tag":137,"props":4502,"children":4503},{},[4504],{"type":28,"value":4505},"整體來說不管多主單主都無法避免斷線帶來的線性不一致",{"type":22,"tag":418,"props":4507,"children":4509},{"id":4508},"cap定理",[4510],{"type":22,"tag":51,"props":4511,"children":4512},{},[4513],{"type":22,"tag":55,"props":4514,"children":4517},{"href":4515,"rel":4516},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=cap%e5%ae%9a%e7%90%86",[59],[4518],{"type":28,"value":4519},"CAP定理",{"type":22,"tag":137,"props":4521,"children":4522},{},[4523],{"type":28,"value":300},{"type":22,"tag":137,"props":4525,"children":4526},{},[4527],{"type":28,"value":4528},"這個問題不僅僅是單主複製和多主複製的後果：任何線性一致的資料庫都有這個問題，不管它是如何實現的。這個問題也不僅僅侷限於多資料中心部署，而可能發生在任何不可靠的網路上，即使在同一個資料中心內也是如此。問題面臨的權衡如下：",{"type":22,"tag":41,"props":4530,"children":4531},{},[4532,4544],{"type":22,"tag":45,"props":4533,"children":4534},{},[4535,4537,4542],{"type":28,"value":4536},"如果應用需要線性一致性，且某些副本因為網路問題與其他副本斷開連線，那麼這些副本掉線時不能處理請求。請求必須等到網路問題解決，或直接返回錯誤。（無論哪種方式，服務都 ",{"type":22,"tag":51,"props":4538,"children":4539},{},[4540],{"type":28,"value":4541},"不可用",{"type":28,"value":4543},"）。",{"type":22,"tag":45,"props":4545,"children":4546},{},[4547],{"type":28,"value":4548},"如果應用不需要線性一致性，那麼某個副本即使與其他副本斷開連線，也可以獨立處理請求（例如多主複製）。在這種情況下，應用可以在網路問題解決前保持可用，但其行為不是線性一致的。",{"type":22,"tag":137,"props":4550,"children":4551},{},[4552],{"type":28,"value":4553},"這兩種選擇有時分別稱為 CP（在網路分割槽下一致但不可用）和 AP（在網路分割槽下可用但不一致）。 但是，這種分類方案存在一些缺陷【9】，所以最好不要這樣用。",{"type":22,"tag":137,"props":4555,"children":4556},{},[4557],{"type":28,"value":4558},"補充：",{"type":22,"tag":137,"props":4560,"children":4561},{},[4562],{"type":28,"value":4563},"一致性（Consistency）:",{"type":22,"tag":137,"props":4565,"children":4566},{},[4567],{"type":28,"value":4568},"所有節點在同一時刻可以看到相同的數據。",{"type":22,"tag":137,"props":4570,"children":4571},{},[4572],{"type":28,"value":4573},"可用性（Availability）:",{"type":22,"tag":137,"props":4575,"children":4576},{},[4577],{"type":28,"value":4578},"每次請求都會在有限的時間內收到一個明確的成功或失敗回應。",{"type":22,"tag":137,"props":4580,"children":4581},{},[4582],{"type":28,"value":4583},"分區容錯性（Partition tolerance）:",{"type":22,"tag":137,"props":4585,"children":4586},{},[4587],{"type":28,"value":4588},"即使網絡分區（Partition）發生，系統依然能正常運作。",{"type":22,"tag":137,"props":4590,"children":4591},{},[4592],{"type":28,"value":4593},"CAP定理認為必須要在一致性與可用性作出權衡",{"type":22,"tag":41,"props":4595,"children":4596},{},[4597,4602,4607],{"type":22,"tag":45,"props":4598,"children":4599},{},[4600],{"type":28,"value":4601},"可以有一個 CP（一致性和分區容錯性） 的系統，比如 ZooKeeper。",{"type":22,"tag":45,"props":4603,"children":4604},{},[4605],{"type":28,"value":4606},"可以有一個 CA（一致性和可用性） 的系統，但這基本上只能在單一節點的情況下實現，一旦涉及到分布式，網絡分區是無法避免的。",{"type":22,"tag":45,"props":4608,"children":4609},{},[4610],{"type":28,"value":4611},"可以有一個 AP（可用性和分區容錯性） 的系統，比如 Cassandra 或 Couchbase。",{"type":22,"tag":418,"props":4613,"children":4615},{"id":4614},"線性一致性和網路延遲",[4616],{"type":22,"tag":51,"props":4617,"children":4618},{},[4619],{"type":22,"tag":55,"props":4620,"children":4623},{"href":4621,"rel":4622},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%92%8c%e7%b6%b2%e8%b7%af%e5%bb%b6%e9%81%b2",[59],[4624],{"type":28,"value":4614},{"type":22,"tag":137,"props":4626,"children":4627},{},[4628],{"type":28,"value":4629},"1.連cpu上的記憶體都不一定是線性一致性的：",{"type":22,"tag":137,"props":4631,"children":4632},{},[4633],{"type":28,"value":4634},"如果一個 CPU 核上執行的執行緒寫入某個記憶體地址，而另一個 CPU 核上執行的執行緒不久之後讀取相同的地址，並沒有保證一定能讀到第一個執行緒寫入的值（除非使用了 記憶體屏障（memory barrier） 或 圍欄（fence）【44】）。",{"type":22,"tag":137,"props":4636,"children":4637},{},[4638],{"type":28,"value":4639},"而且CPU核心與核心之間的通訊基本都是正常的狀況下還有可能發生線性不一致性。",{"type":22,"tag":137,"props":4641,"children":4642},{},[4643],{"type":28,"value":4644},"2.以CPU來說是為了提高效能而選擇犧牲線性一致性而不是為了容錯",{"type":22,"tag":137,"props":4646,"children":4647},{},[4648],{"type":28,"value":4649},"3.可能找不到高效並且線性一致性的系統",{"type":22,"tag":30,"props":4651,"children":4653},{"id":4652},"_93-順序保證",[4654],{"type":28,"value":4655},"9.3 順序保證",{"type":22,"tag":137,"props":4657,"children":4658},{},[4659],{"type":28,"value":300},{"type":22,"tag":137,"props":4661,"children":4662},{},[4663],{"type":28,"value":4664},"這小節主要要探討圖9-4順序",{"type":22,"tag":41,"props":4666,"children":4667},{},[4668,4699,4736],{"type":22,"tag":45,"props":4669,"children":4670},{},[4671,4673,4681,4683,4688,4690,4698],{"type":28,"value":4672},"在 ",{"type":22,"tag":51,"props":4674,"children":4675},{},[4676],{"type":22,"tag":55,"props":4677,"children":4679},{"href":4102,"rel":4678},[59],[4680],{"type":28,"value":4021},{"type":28,"value":4682}," 中我們看到，領導者在單主複製中的主要目的就是，在複製日誌中確定 ",{"type":22,"tag":51,"props":4684,"children":4685},{},[4686],{"type":28,"value":4687},"寫入順序（order of write）",{"type":28,"value":4689},"—— 也就是從庫應用這些寫入的順序。如果不存在一個領導者，則併發操作可能導致衝突（請參閱 “",{"type":22,"tag":51,"props":4691,"children":4692},{},[4693],{"type":22,"tag":55,"props":4694,"children":4696},{"href":4202,"rel":4695},[59],[4697],{"type":28,"value":4206},{"type":28,"value":4455},{"type":22,"tag":45,"props":4700,"children":4701},{},[4702,4703,4713,4715,4720,4722,4727,4729,4734],{"type":28,"value":4672},{"type":22,"tag":51,"props":4704,"children":4705},{},[4706],{"type":22,"tag":55,"props":4707,"children":4710},{"href":4708,"rel":4709},"https://vonng.github.io/ddia/#/zh-tw/ch7",[59],[4711],{"type":28,"value":4712},"第七章",{"type":28,"value":4714}," 中討論的 ",{"type":22,"tag":51,"props":4716,"children":4717},{},[4718],{"type":28,"value":4719},"可序列化",{"type":28,"value":4721},"，是關於事務表現的像按 ",{"type":22,"tag":51,"props":4723,"children":4724},{},[4725],{"type":28,"value":4726},"某種先後順序（some sequential order）",{"type":28,"value":4728}," 執行的保證。它可以字面意義上地以 ",{"type":22,"tag":51,"props":4730,"children":4731},{},[4732],{"type":28,"value":4733},"序列順序（serial order）",{"type":28,"value":4735}," 執行事務來實現，或者允許並行執行，但同時防止序列化衝突來實現（透過鎖或中止事務）。",{"type":22,"tag":45,"props":4737,"children":4738},{},[4739,4740,4750,4752,4760],{"type":28,"value":4672},{"type":22,"tag":51,"props":4741,"children":4742},{},[4743],{"type":22,"tag":55,"props":4744,"children":4747},{"href":4745,"rel":4746},"https://vonng.github.io/ddia/#/zh-tw/ch8",[59],[4748],{"type":28,"value":4749},"第八章",{"type":28,"value":4751}," 討論過的在分散式系統中使用時間戳和時鐘（請參閱 “",{"type":22,"tag":51,"props":4753,"children":4754},{},[4755],{"type":22,"tag":55,"props":4756,"children":4758},{"href":4241,"rel":4757},[59],[4759],{"type":28,"value":4245},{"type":28,"value":4761},"”）是另一種將順序引入無序世界的嘗試，例如，確定兩個寫入操作哪一個更晚發生。",{"type":22,"tag":30,"props":4763,"children":4765},{"id":4764},"順序與因果關係因果一致性-causally-consistent",[4766],{"type":22,"tag":51,"props":4767,"children":4768},{},[4769,4776],{"type":22,"tag":55,"props":4770,"children":4773},{"href":4771,"rel":4772},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%a0%86%e5%ba%8f%e8%88%87%e5%9b%a0%e6%9e%9c%e9%97%9c%e4%bf%82",[59],[4774],{"type":28,"value":4775},"順序與因果關係",{"type":28,"value":4777},"(因果一致性 causally consistent)",{"type":22,"tag":41,"props":4779,"children":4780},{},[4781,4821,4860,4897,4943,4994],{"type":22,"tag":45,"props":4782,"children":4783},{},[4784,4786,4791,4794,4799,4802,4806,4809,4811,4814,4816,4819],{"type":28,"value":4785},"5-5",{"type":22,"tag":51,"props":4787,"children":4788},{},[4789],{"type":28,"value":4790},"一致字首讀：有因果關係",{"type":22,"tag":4117,"props":4792,"children":4793},{},[],{"type":22,"tag":341,"props":4795,"children":4798},{"alt":4796,"src":4797},"圖 5-5 如果某些分割槽的複製速度慢於其他分割槽，那麼觀察者可能會在看到問題之前先看到答案。","https://vonng.github.io/ddia/img/fig5-5.png",[],{"type":22,"tag":4117,"props":4800,"children":4801},{},[],{"type":22,"tag":51,"props":4803,"children":4804},{},[4805],{"type":28,"value":4796},{"type":22,"tag":4117,"props":4807,"children":4808},{},[],{"type":28,"value":4810},"通常，問題和答案之間存在明確的因果關係，因為要回答一個問題，首先要有問題的存在。",{"type":22,"tag":4117,"props":4812,"children":4813},{},[],{"type":28,"value":4815},"因果關係例子：",{"type":22,"tag":4117,"props":4817,"children":4818},{},[],{"type":28,"value":4820},"在一個線上問答社區，通常需要先有人提出問題，然後其他人才能看到並回答這個問題。如果由於網絡延遲，有人先看到了回答而後看到問題，這違反了正常的因果順序。",{"type":22,"tag":45,"props":4822,"children":4823},{},[4824,4826,4831,4834,4839,4842,4846,4849,4851,4854,4855,4858],{"type":28,"value":4825},"5-9",{"type":22,"tag":51,"props":4827,"children":4828},{},[4829],{"type":28,"value":4830},"複製和網路延遲：有因果關係",{"type":22,"tag":4117,"props":4832,"children":4833},{},[],{"type":22,"tag":341,"props":4835,"children":4838},{"alt":4836,"src":4837},"圖 5-9 使用多主複製時，寫入可能會以錯誤的順序到達某些副本。","https://vonng.github.io/ddia/img/fig5-9.png",[],{"type":22,"tag":4117,"props":4840,"children":4841},{},[],{"type":22,"tag":51,"props":4843,"children":4844},{},[4845],{"type":28,"value":4836},{"type":22,"tag":4117,"props":4847,"children":4848},{},[],{"type":28,"value":4850},"在這個情境下，明確的因果關係是，一個記錄必須先被創建，然後才能被更新。",{"type":22,"tag":4117,"props":4852,"children":4853},{},[],{"type":28,"value":4815},{"type":22,"tag":4117,"props":4856,"children":4857},{},[],{"type":28,"value":4859},"如果在家中的多台電腦上同步文件，通常必須先在一台電腦上創建文件，然後它才能被同步到其他電腦上。如果由於網絡延遲，文件的更新在某台電腦上先於文件的創建被接收到，這違反了正常的因果順序。",{"type":22,"tag":45,"props":4861,"children":4862},{},[4863,4868,4871,4876,4879,4883,4886,4888,4891,4892,4895],{"type":22,"tag":51,"props":4864,"children":4865},{},[4866],{"type":28,"value":4867},"檢測併發寫入：有可能有因果關係",{"type":22,"tag":4117,"props":4869,"children":4870},{},[],{"type":22,"tag":341,"props":4872,"children":4875},{"alt":4873,"src":4874},"圖 5-12 併發寫入 Dynamo 風格的資料儲存：沒有明確定義的順序。","https://vonng.github.io/ddia/img/fig5-12.png",[],{"type":22,"tag":4117,"props":4877,"children":4878},{},[],{"type":22,"tag":51,"props":4880,"children":4881},{},[4882],{"type":28,"value":4873},{"type":22,"tag":4117,"props":4884,"children":4885},{},[],{"type":28,"value":4887},"在這個情境下，可能存在因果關係，例如，如果操作A影響了操作B的結果，那麼就存在因果關係。但如果A和B是獨立並行的，則不存在因果關係。",{"type":22,"tag":4117,"props":4889,"children":4890},{},[],{"type":28,"value":4815},{"type":22,"tag":4117,"props":4893,"children":4894},{},[],{"type":28,"value":4896},"在超市結賬時，如果兩個人同時到達結賬台，需要確定哪個人應該先結賬以保持秩序。這種順序決定了誰先誰後，存在因果關係。",{"type":22,"tag":45,"props":4898,"children":4899},{},[4900,4914,4917,4922,4925,4929,4932,4934,4937,4938,4941],{"type":22,"tag":51,"props":4901,"children":4902},{},[4903,4905,4912],{"type":28,"value":4904},"事務快照隔離(",{"type":22,"tag":55,"props":4906,"children":4909},{"href":4907,"rel":4908},"https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e5%bf%ab%e7%85%a7%e9%9a%94%e9%9b%a2%e5%92%8c%e5%8f%af%e9%87%8d%e8%a4%87%e8%ae%80",[59],[4910],{"type":28,"value":4911},"快照隔離和可重複讀",{"type":28,"value":4913},")：有因果關係",{"type":22,"tag":4117,"props":4915,"children":4916},{},[],{"type":22,"tag":341,"props":4918,"children":4921},{"alt":4919,"src":4920},"圖 7-6 讀取偏差：Alice 觀察資料庫處於不一致的狀態","https://vonng.github.io/ddia/img/fig7-6.png",[],{"type":22,"tag":4117,"props":4923,"children":4924},{},[],{"type":22,"tag":51,"props":4926,"children":4927},{},[4928],{"type":28,"value":4919},{"type":22,"tag":4117,"props":4930,"children":4931},{},[],{"type":28,"value":4933},"不可重複讀，除非知道因果關係要不然重複讀取會產生不一致",{"type":22,"tag":4117,"props":4935,"children":4936},{},[],{"type":28,"value":4815},{"type":22,"tag":4117,"props":4939,"children":4940},{},[],{"type":28,"value":4942},"查看社交媒體的時候看到了一個回覆，理所當然的，你會期望能夠看到被回覆的原始帖子，因為回覆（效果）依賴於原始帖子（原因）。",{"type":22,"tag":45,"props":4944,"children":4945},{},[4946,4960,4963,4968,4971,4975,4978,4980,4983,4985,4988,4989,4992],{"type":22,"tag":51,"props":4947,"children":4948},{},[4949,4951,4958],{"type":28,"value":4950},"寫偏差(",{"type":22,"tag":55,"props":4952,"children":4955},{"href":4953,"rel":4954},"https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e5%af%ab%e5%85%a5%e5%81%8f%e5%b7%ae%e8%88%87%e5%b9%bb%e8%ae%80",[59],[4956],{"type":28,"value":4957},"寫入偏差與幻讀",{"type":28,"value":4959},"):可能有因果關係",{"type":22,"tag":4117,"props":4961,"children":4962},{},[],{"type":22,"tag":341,"props":4964,"children":4967},{"alt":4965,"src":4966},"圖 7-8 寫入偏差導致應用程式錯誤的示例","https://vonng.github.io/ddia/img/fig7-8.png",[],{"type":22,"tag":4117,"props":4969,"children":4970},{},[],{"type":22,"tag":51,"props":4972,"children":4973},{},[4974],{"type":28,"value":4965},{"type":22,"tag":4117,"props":4976,"children":4977},{},[],{"type":28,"value":4979},"Alice依賴Bob的on_call狀態，Bob也依賴Alice的on_call狀態",{"type":22,"tag":4117,"props":4981,"children":4982},{},[],{"type":28,"value":4984},"寫偏差的情境下可能存在因果關係，例如，某個事務的結果可能依賴於另一個事務的狀態。",{"type":22,"tag":4117,"props":4986,"children":4987},{},[],{"type":28,"value":4815},{"type":22,"tag":4117,"props":4990,"children":4991},{},[],{"type":28,"value":4993},"在一個忙碌的餐廳，如果兩個服務員同時去搶一個空出來的桌子給等待的客人，但由於沒有及時通信，可能會導致兩組客人被安排到同一個桌子，這是因果關係管理的失敗。",{"type":22,"tag":45,"props":4995,"children":4996},{},[4997,5002,5005,5008,5011,5015,5018,5020,5023,5024,5027],{"type":22,"tag":51,"props":4998,"children":4999},{},[5000],{"type":28,"value":5001},"因果依賴和時序(Alice & Bob 看球賽)：有因果關係",{"type":22,"tag":4117,"props":5003,"children":5004},{},[],{"type":22,"tag":341,"props":5006,"children":5007},{"alt":343,"src":344},[],{"type":22,"tag":4117,"props":5009,"children":5010},{},[],{"type":22,"tag":51,"props":5012,"children":5013},{},[5014],{"type":28,"value":343},{"type":22,"tag":4117,"props":5016,"children":5017},{},[],{"type":28,"value":5019},"在這個情境下，存在明確的因果關係，比如進球（原因）和球員慶祝（效果）。",{"type":22,"tag":4117,"props":5021,"children":5022},{},[],{"type":28,"value":4815},{"type":22,"tag":4117,"props":5025,"children":5026},{},[],{"type":28,"value":5028},"在觀看足球比賽時，球員的慶祝是依賴於先前的進球事件。進球是原因，球員的慶祝是效果，二者之間存在明確的因果關係。",{"type":22,"tag":137,"props":5030,"children":5031},{},[5032],{"type":28,"value":4330},{"type":22,"tag":41,"props":5034,"children":5035},{},[5036,5046],{"type":22,"tag":45,"props":5037,"children":5038},{},[5039,5044],{"type":22,"tag":51,"props":5040,"children":5041},{},[5042],{"type":28,"value":5043},"因果一致性",{"type":28,"value":5045},"：重視操作之間的因果關係。如果操作A在因果上先於操作B，那麼系統應保證所有節點上A的效果都會在B的效果之前被看到。這使得系統能夠保留操作的自然順序，但不保證全局的操作順序。",{"type":22,"tag":45,"props":5047,"children":5048},{},[5049,5053],{"type":22,"tag":51,"props":5050,"children":5051},{},[5052],{"type":28,"value":77},{"type":28,"value":5054},"：要求系統中的所有操作都能夠按照某一全局順序（通常是時間順序）來呈現，使得所有操作看起來就像是在一個單一的、原子的、全局順序的時間點上發生的。這提供了一個非常強的一致性保證，但可能會降低系統的性能和可用性。",{"type":22,"tag":418,"props":5056,"children":5058},{"id":5057},"因果順序不是全序的",[5059],{"type":22,"tag":51,"props":5060,"children":5061},{},[5062],{"type":22,"tag":55,"props":5063,"children":5066},{"href":5064,"rel":5065},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%9b%a0%e6%9e%9c%e9%a0%86%e5%ba%8f%e4%b8%8d%e6%98%af%e5%85%a8%e5%ba%8f%e7%9a%84",[59],[5067],{"type":28,"value":5057},{"type":22,"tag":137,"props":5069,"children":5070},{},[5071,5076],{"type":22,"tag":51,"props":5072,"children":5073},{},[5074],{"type":28,"value":5075},"全序(total order)：",{"type":28,"value":5077}," 允許任意兩個元素進行比較，所以如果有兩個元素，你總是可以說出哪個更大，哪個更小。例如，自然數集是全序的：給定兩個自然數，比如說 5 和 13，那麼你可以知道，13 大於 5。",{"type":22,"tag":137,"props":5079,"children":5080},{},[5081],{"type":28,"value":5082},"偏序(partially ordered)：考慮三個集合：A={1,2}，B={2,3}，和C={1,2,3}。在這裡，A和B是無法比較的，因為它們之間沒有子集關係。但是，A和C可以比較，因為A是C的子集，記作A⊂C。",{"type":22,"tag":137,"props":5084,"children":5085},{},[5086],{"type":28,"value":5087},"全序和偏序之間的差異反映在不同的資料庫一致性模型中：",{"type":22,"tag":41,"props":5089,"children":5090},{},[5091,5112],{"type":22,"tag":45,"props":5092,"children":5093},{},[5094,5095,5098,5100,5110],{"type":28,"value":77},{"type":22,"tag":4117,"props":5096,"children":5097},{},[],{"type":28,"value":5099},"線性一致的系統中，操作是全序的：如果系統表現的就好像只有一個數據副本，並且所有操作都是原子性的，這意味著對任何兩個操作，我們總是能判定哪個操作先發生。這個全序在 ",{"type":22,"tag":51,"props":5101,"children":5102},{},[5103],{"type":22,"tag":55,"props":5104,"children":5107},{"href":5105,"rel":5106},"https://vonng.github.io/ddia/#/img/fig9-4.png",[59],[5108],{"type":28,"value":5109},"圖 9-4",{"type":28,"value":5111}," 中以時間線表示。",{"type":22,"tag":45,"props":5113,"children":5114},{},[5115,5117,5120,5122,5127,5129,5139],{"type":28,"value":5116},"因果性",{"type":22,"tag":4117,"props":5118,"children":5119},{},[],{"type":28,"value":5121},"我們說過，如果兩個操作都沒有在彼此 ",{"type":22,"tag":51,"props":5123,"children":5124},{},[5125],{"type":28,"value":5126},"之前發生",{"type":28,"value":5128},"，那麼這兩個操作是併發的（請參閱 ",{"type":22,"tag":51,"props":5130,"children":5131},{},[5132],{"type":22,"tag":55,"props":5133,"children":5136},{"href":5134,"rel":5135},"https://vonng.github.io/ddia/#/zh-tw/ch5?id=%e2%80%9c%e6%ad%a4%e5%89%8d%e7%99%bc%e7%94%9f%e2%80%9d%e7%9a%84%e9%97%9c%e4%bf%82%e5%92%8c%e4%bd%b5%e7%99%bc",[59],[5137],{"type":28,"value":5138},"“此前發生” 的關係和併發",{"type":28,"value":5140},"）。換句話說，如果兩個事件是因果相關的（一個發生在另一個事件之前），則它們之間是有序的，但如果它們是併發的，則它們之間的順序是無法比較的。這意味著因果關係定義了一個偏序，而不是一個全序：一些操作相互之間是有順序的，但有些則是無法比較的。併發是偏序的",{"type":22,"tag":424,"props":5142,"children":5144},{"className":1718,"code":5143,"language":1720,"meta":13,"style":13},"graph TD;\n        全序\n    A[任務 A];\n    B[任務 B];\n    C[任務 C];\n    D[任務 D];\n    E[任務 E];\n    全序 --> A;\n    A --> B;\n    B --> C;\n    C --> D;\n    D --> E;\n\n        偏序\n        A1[任務 A];\n    B1[任務 B];\n    C1[任務 C];\n    D1[任務 D];\n    E1[任務 E];\n    F1[任務 F];\n    \n        偏序-->A1;\n    A1 --> B1;\n    B1 --> D1;\n    A1 --> C1;\n    C1 --> E1;\n    D1 --> F1;\n    E1 --> F1;\n",[5145],{"type":22,"tag":431,"props":5146,"children":5147},{"__ignoreMap":13},[5148,5156,5164,5172,5180,5188,5196,5204,5212,5220,5228,5236,5244,5251,5259,5267,5275,5283,5291,5299,5307,5314,5322,5330,5338,5346,5354,5362],{"type":22,"tag":435,"props":5149,"children":5150},{"class":437,"line":438},[5151],{"type":22,"tag":435,"props":5152,"children":5153},{},[5154],{"type":28,"value":5155},"graph TD;\n",{"type":22,"tag":435,"props":5157,"children":5158},{"class":437,"line":454},[5159],{"type":22,"tag":435,"props":5160,"children":5161},{},[5162],{"type":28,"value":5163},"        全序\n",{"type":22,"tag":435,"props":5165,"children":5166},{"class":437,"line":463},[5167],{"type":22,"tag":435,"props":5168,"children":5169},{},[5170],{"type":28,"value":5171},"    A[任務 A];\n",{"type":22,"tag":435,"props":5173,"children":5174},{"class":437,"line":478},[5175],{"type":22,"tag":435,"props":5176,"children":5177},{},[5178],{"type":28,"value":5179},"    B[任務 B];\n",{"type":22,"tag":435,"props":5181,"children":5182},{"class":437,"line":499},[5183],{"type":22,"tag":435,"props":5184,"children":5185},{},[5186],{"type":28,"value":5187},"    C[任務 C];\n",{"type":22,"tag":435,"props":5189,"children":5190},{"class":437,"line":516},[5191],{"type":22,"tag":435,"props":5192,"children":5193},{},[5194],{"type":28,"value":5195},"    D[任務 D];\n",{"type":22,"tag":435,"props":5197,"children":5198},{"class":437,"line":533},[5199],{"type":22,"tag":435,"props":5200,"children":5201},{},[5202],{"type":28,"value":5203},"    E[任務 E];\n",{"type":22,"tag":435,"props":5205,"children":5206},{"class":437,"line":550},[5207],{"type":22,"tag":435,"props":5208,"children":5209},{},[5210],{"type":28,"value":5211},"    全序 --> A;\n",{"type":22,"tag":435,"props":5213,"children":5214},{"class":437,"line":559},[5215],{"type":22,"tag":435,"props":5216,"children":5217},{},[5218],{"type":28,"value":5219},"    A --> B;\n",{"type":22,"tag":435,"props":5221,"children":5222},{"class":437,"line":567},[5223],{"type":22,"tag":435,"props":5224,"children":5225},{},[5226],{"type":28,"value":5227},"    B --> C;\n",{"type":22,"tag":435,"props":5229,"children":5230},{"class":437,"line":591},[5231],{"type":22,"tag":435,"props":5232,"children":5233},{},[5234],{"type":28,"value":5235},"    C --> D;\n",{"type":22,"tag":435,"props":5237,"children":5238},{"class":437,"line":606},[5239],{"type":22,"tag":435,"props":5240,"children":5241},{},[5242],{"type":28,"value":5243},"    D --> E;\n",{"type":22,"tag":435,"props":5245,"children":5246},{"class":437,"line":615},[5247],{"type":22,"tag":435,"props":5248,"children":5249},{"emptyLinePlaceholder":5},[5250],{"type":28,"value":460},{"type":22,"tag":435,"props":5252,"children":5253},{"class":437,"line":636},[5254],{"type":22,"tag":435,"props":5255,"children":5256},{},[5257],{"type":28,"value":5258},"        偏序\n",{"type":22,"tag":435,"props":5260,"children":5261},{"class":437,"line":650},[5262],{"type":22,"tag":435,"props":5263,"children":5264},{},[5265],{"type":28,"value":5266},"        A1[任務 A];\n",{"type":22,"tag":435,"props":5268,"children":5269},{"class":437,"line":678},[5270],{"type":22,"tag":435,"props":5271,"children":5272},{},[5273],{"type":28,"value":5274},"    B1[任務 B];\n",{"type":22,"tag":435,"props":5276,"children":5277},{"class":437,"line":686},[5278],{"type":22,"tag":435,"props":5279,"children":5280},{},[5281],{"type":28,"value":5282},"    C1[任務 C];\n",{"type":22,"tag":435,"props":5284,"children":5285},{"class":437,"line":694},[5286],{"type":22,"tag":435,"props":5287,"children":5288},{},[5289],{"type":28,"value":5290},"    D1[任務 D];\n",{"type":22,"tag":435,"props":5292,"children":5293},{"class":437,"line":759},[5294],{"type":22,"tag":435,"props":5295,"children":5296},{},[5297],{"type":28,"value":5298},"    E1[任務 E];\n",{"type":22,"tag":435,"props":5300,"children":5301},{"class":437,"line":783},[5302],{"type":22,"tag":435,"props":5303,"children":5304},{},[5305],{"type":28,"value":5306},"    F1[任務 F];\n",{"type":22,"tag":435,"props":5308,"children":5309},{"class":437,"line":837},[5310],{"type":22,"tag":435,"props":5311,"children":5312},{},[5313],{"type":28,"value":1811},{"type":22,"tag":435,"props":5315,"children":5316},{"class":437,"line":894},[5317],{"type":22,"tag":435,"props":5318,"children":5319},{},[5320],{"type":28,"value":5321},"        偏序-->A1;\n",{"type":22,"tag":435,"props":5323,"children":5324},{"class":437,"line":971},[5325],{"type":22,"tag":435,"props":5326,"children":5327},{},[5328],{"type":28,"value":5329},"    A1 --> B1;\n",{"type":22,"tag":435,"props":5331,"children":5332},{"class":437,"line":980},[5333],{"type":22,"tag":435,"props":5334,"children":5335},{},[5336],{"type":28,"value":5337},"    B1 --> D1;\n",{"type":22,"tag":435,"props":5339,"children":5340},{"class":437,"line":988},[5341],{"type":22,"tag":435,"props":5342,"children":5343},{},[5344],{"type":28,"value":5345},"    A1 --> C1;\n",{"type":22,"tag":435,"props":5347,"children":5348},{"class":437,"line":996},[5349],{"type":22,"tag":435,"props":5350,"children":5351},{},[5352],{"type":28,"value":5353},"    C1 --> E1;\n",{"type":22,"tag":435,"props":5355,"children":5356},{"class":437,"line":1064},[5357],{"type":22,"tag":435,"props":5358,"children":5359},{},[5360],{"type":28,"value":5361},"    D1 --> F1;\n",{"type":22,"tag":435,"props":5363,"children":5364},{"class":437,"line":1084},[5365],{"type":22,"tag":435,"props":5366,"children":5367},{},[5368],{"type":28,"value":5369},"    E1 --> F1;\n",{"type":22,"tag":137,"props":5371,"children":5372},{},[5373,5375,5380,5382,5387],{"type":28,"value":5374},"如果你熟悉像 Git 這樣的分散式版本控制系統，那麼其版本歷史與因果關係圖極其相似。通常，一個 ",{"type":22,"tag":51,"props":5376,"children":5377},{},[5378],{"type":28,"value":5379},"提交（Commit）",{"type":28,"value":5381}," 發生在另一個提交之後，在一條直線上。但是有時你會遇到分支（當多個人同時在一個專案上工作時），",{"type":22,"tag":51,"props":5383,"children":5384},{},[5385],{"type":28,"value":5386},"合併（Merge）",{"type":28,"value":5388}," 會在這些併發建立的提交相融合時建立。因為知道develop發生過什麼事情再去看5-22e4a46才知道是全序的",{"type":22,"tag":424,"props":5390,"children":5392},{"className":1718,"code":5391,"language":1720,"meta":13,"style":13},"gitGraph:\noptions\n{\n    \"nodeSpacing\": 150,\n    \"nodeRadius\": 10\n}\nend\ncommit\ncommit\nbranch develop\ncheckout develop\ncommit\ncommit\ncheckout main\nmerge develop\ncommit\ncommit\n",[5393],{"type":22,"tag":431,"props":5394,"children":5395},{"__ignoreMap":13},[5396,5404,5412,5419,5427,5435,5442,5450,5458,5465,5473,5481,5488,5495,5503,5511,5518],{"type":22,"tag":435,"props":5397,"children":5398},{"class":437,"line":438},[5399],{"type":22,"tag":435,"props":5400,"children":5401},{},[5402],{"type":28,"value":5403},"gitGraph:\n",{"type":22,"tag":435,"props":5405,"children":5406},{"class":437,"line":454},[5407],{"type":22,"tag":435,"props":5408,"children":5409},{},[5410],{"type":28,"value":5411},"options\n",{"type":22,"tag":435,"props":5413,"children":5414},{"class":437,"line":463},[5415],{"type":22,"tag":435,"props":5416,"children":5417},{},[5418],{"type":28,"value":2675},{"type":22,"tag":435,"props":5420,"children":5421},{"class":437,"line":478},[5422],{"type":22,"tag":435,"props":5423,"children":5424},{},[5425],{"type":28,"value":5426},"    \"nodeSpacing\": 150,\n",{"type":22,"tag":435,"props":5428,"children":5429},{"class":437,"line":499},[5430],{"type":22,"tag":435,"props":5431,"children":5432},{},[5433],{"type":28,"value":5434},"    \"nodeRadius\": 10\n",{"type":22,"tag":435,"props":5436,"children":5437},{"class":437,"line":516},[5438],{"type":22,"tag":435,"props":5439,"children":5440},{},[5441],{"type":28,"value":612},{"type":22,"tag":435,"props":5443,"children":5444},{"class":437,"line":533},[5445],{"type":22,"tag":435,"props":5446,"children":5447},{},[5448],{"type":28,"value":5449},"end\n",{"type":22,"tag":435,"props":5451,"children":5452},{"class":437,"line":550},[5453],{"type":22,"tag":435,"props":5454,"children":5455},{},[5456],{"type":28,"value":5457},"commit\n",{"type":22,"tag":435,"props":5459,"children":5460},{"class":437,"line":559},[5461],{"type":22,"tag":435,"props":5462,"children":5463},{},[5464],{"type":28,"value":5457},{"type":22,"tag":435,"props":5466,"children":5467},{"class":437,"line":567},[5468],{"type":22,"tag":435,"props":5469,"children":5470},{},[5471],{"type":28,"value":5472},"branch develop\n",{"type":22,"tag":435,"props":5474,"children":5475},{"class":437,"line":591},[5476],{"type":22,"tag":435,"props":5477,"children":5478},{},[5479],{"type":28,"value":5480},"checkout develop\n",{"type":22,"tag":435,"props":5482,"children":5483},{"class":437,"line":606},[5484],{"type":22,"tag":435,"props":5485,"children":5486},{},[5487],{"type":28,"value":5457},{"type":22,"tag":435,"props":5489,"children":5490},{"class":437,"line":615},[5491],{"type":22,"tag":435,"props":5492,"children":5493},{},[5494],{"type":28,"value":5457},{"type":22,"tag":435,"props":5496,"children":5497},{"class":437,"line":636},[5498],{"type":22,"tag":435,"props":5499,"children":5500},{},[5501],{"type":28,"value":5502},"checkout main\n",{"type":22,"tag":435,"props":5504,"children":5505},{"class":437,"line":650},[5506],{"type":22,"tag":435,"props":5507,"children":5508},{},[5509],{"type":28,"value":5510},"merge develop\n",{"type":22,"tag":435,"props":5512,"children":5513},{"class":437,"line":678},[5514],{"type":22,"tag":435,"props":5515,"children":5516},{},[5517],{"type":28,"value":5457},{"type":22,"tag":435,"props":5519,"children":5520},{"class":437,"line":686},[5521],{"type":22,"tag":435,"props":5522,"children":5523},{},[5524],{"type":28,"value":5457},{"type":22,"tag":418,"props":5526,"children":5528},{"id":5527},"線性一致性強於因果一致性",[5529],{"type":22,"tag":51,"props":5530,"children":5531},{},[5532],{"type":22,"tag":55,"props":5533,"children":5536},{"href":5534,"rel":5535},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%bc%b7%e6%96%bc%e5%9b%a0%e6%9e%9c%e4%b8%80%e8%87%b4%e6%80%a7",[59],[5537],{"type":28,"value":5527},{"type":22,"tag":137,"props":5539,"children":5540},{},[5541],{"type":28,"value":5542},"線性一致性隱含了因果關係，也就是說，任何線性一致的系統都能正確地保持因果性，即使在有多個通訊通道的情況下也能自動保證，無需進行特殊的操作如傳遞時間戳。這種隱含的關係使得線性一致性成為了一個非常強大而又直觀的一致性模型。",{"type":22,"tag":137,"props":5544,"children":5545},{},[5546],{"type":28,"value":5547},"許多分散式系統看起來需要線性一致性但實際上只要保證網路不延遲其實使用因果一致性就算是最強的一致性模型。",{"type":22,"tag":418,"props":5549,"children":5551},{"id":5550},"捕獲因果關係",[5552],{"type":28,"value":5550},{"type":22,"tag":137,"props":5554,"children":5555},{},[5556],{"type":28,"value":5557},"為了保持因果性，系統必須能夠識別操作間的“發生在先前”（happened before）關係。這形成了一種偏序（partial ordering）關係，意味著在某些情況下，可以明確地說一個操作發生在另一個操作之前，而在其他情況下（如併發操作），則無法做出此判定。",{"type":22,"tag":137,"props":5559,"children":5560},{},[5561],{"type":28,"value":5562},"為了明確因果依賴，需要有方式描述系統中各節點的“知識”。這種“知識”是指節點在進行某些操作時，對系統中其他事件的了解。例如，如果一個節點在發出寫入Y的請求時已經看到了X的值，那麼就可能存在一個因果關係，表示X是Y發生的原因。這種情況類似於在欺詐指控的刑事調查中常見的問題，例如在做出某個決定Y時，CEO是否知道了X的情況。在這種情況下，X和Y之間的因果關係是基於節點（或在刑事調查中的CEO）在執行操作時所具有的知識。這種分析方式可以幫助確定事件之間的因果依賴，並且對於維持系統的因果一致性至關重要。",{"type":22,"tag":137,"props":5564,"children":5565},{},[5566,5568,5578,5580,5590],{"type":28,"value":5567},"為了確定因果順序，資料庫需要知道應用讀取了哪個版本的資料。這就是為什麼在 ",{"type":22,"tag":51,"props":5569,"children":5570},{},[5571],{"type":22,"tag":55,"props":5572,"children":5575},{"href":5573,"rel":5574},"https://vonng.github.io/ddia/#/img/fig5-13.png",[59],[5576],{"type":28,"value":5577},"圖 5-13",{"type":28,"value":5579}," 中，來自先前操作的版本號在寫入時被傳回到資料庫的原因。在 SSI 的衝突檢測中會出現類似的想法，如 “",{"type":22,"tag":51,"props":5581,"children":5582},{},[5583],{"type":22,"tag":55,"props":5584,"children":5587},{"href":5585,"rel":5586},"https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e5%8f%af%e5%ba%8f%e5%88%97%e5%8c%96%e5%bf%ab%e7%85%a7%e9%9a%94%e9%9b%a2",[59],[5588],{"type":28,"value":5589},"可序列化快照隔離",{"type":28,"value":5591},"” 中所述：當事務要提交時，資料庫將檢查它所讀取的資料版本是否仍然是最新的。為此，資料庫跟蹤哪些資料被哪些事務所讀取。",{"type":22,"tag":137,"props":5593,"children":5594},{},[5595],{"type":28,"value":4330},{"type":22,"tag":137,"props":5597,"children":5598},{},[5599],{"type":28,"value":5600},"我們可以從資料庫的版本“知識點”來捕獲因果關係，由於這個知識是找出因果的關鍵所以可能會製造出衝突讓多節點系統保持一致性",{"type":22,"tag":30,"props":5602,"children":5604},{"id":5603},"序列號順序",[5605],{"type":22,"tag":51,"props":5606,"children":5607},{},[5608],{"type":22,"tag":55,"props":5609,"children":5612},{"href":5610,"rel":5611},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%ba%8f%e5%88%97%e8%99%9f%e9%a0%86%e5%ba%8f",[59],[5613],{"type":28,"value":5603},{"type":22,"tag":137,"props":5615,"children":5616},{},[5617,5619,5624,5625,5630],{"type":28,"value":5618},"雖然因果是一個重要的理論概念，但是要跟蹤所有的因果關係是不切實際的，還好有一個更好的方法，我們可以使用 ",{"type":22,"tag":51,"props":5620,"children":5621},{},[5622],{"type":28,"value":5623},"序列號（sequence number）",{"type":28,"value":331},{"type":22,"tag":51,"props":5626,"children":5627},{},[5628],{"type":28,"value":5629},"時間戳（timestamp）",{"type":28,"value":5631}," 來排序事件，時間戳不一定要來自於日曆時鐘，可以用使用邏輯時鐘，因為日曆時鐘會有“不可靠時鐘”問題，典型的邏輯時鐘實現是使用每次操作自增計數器。",{"type":22,"tag":137,"props":5633,"children":5634},{},[5635],{"type":28,"value":5636},"使用自增計數器可以提供比較值越大的後發生，我們可以使用因果一致的全序來產生序列號，這樣就可以產生一個比因果性更嚴格的順序。",{"type":22,"tag":137,"props":5638,"children":5639},{},[5640],{"type":28,"value":5641},"一個因果關係不一致的全序很容易建立但是是垃圾，例如我們隨機產生了一個UUID但是這個序列根本沒辦法為我們提供操作的先後順序，或者是否觀察的出來操作是否是併發的。",{"type":22,"tag":137,"props":5643,"children":5644},{},[5645],{"type":28,"value":5646},"在單主複製的資料庫中，複製日誌定義因果一致的寫操作，主庫可以為每個動作採用自增計數，而從每個操作分配一個遞增的序列號。如果一個從庫按照複製日誌的順序來寫入，這樣一來從庫的狀態會始終是因果一致的。就算從庫落後於領導者也能保持因果一致，因為有複製日誌的序列讓從庫知道先後順序該如何寫入。",{"type":22,"tag":424,"props":5648,"children":5650},{"className":1718,"code":5649,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant 主庫\n    participant 複製日誌\n    participant 從庫\n\n    主庫->>複製日誌: 操作1 (序列號: 1)\n    複製日誌-->>從庫: 操作1 (序列號: 1)\n    主庫->>複製日誌: 操作2 (序列號: 2)\n    複製日誌-->>從庫: 操作2 (序列號: 2)\n    主庫->>複製日誌: 操作3 (序列號: 3)\n    複製日誌-->>從庫: 操作3 (序列號: 3)\n",[5651],{"type":22,"tag":431,"props":5652,"children":5653},{"__ignoreMap":13},[5654,5661,5669,5677,5685,5692,5700,5708,5716,5724,5732],{"type":22,"tag":435,"props":5655,"children":5656},{"class":437,"line":438},[5657],{"type":22,"tag":435,"props":5658,"children":5659},{},[5660],{"type":28,"value":1732},{"type":22,"tag":435,"props":5662,"children":5663},{"class":437,"line":454},[5664],{"type":22,"tag":435,"props":5665,"children":5666},{},[5667],{"type":28,"value":5668},"    participant 主庫\n",{"type":22,"tag":435,"props":5670,"children":5671},{"class":437,"line":463},[5672],{"type":22,"tag":435,"props":5673,"children":5674},{},[5675],{"type":28,"value":5676},"    participant 複製日誌\n",{"type":22,"tag":435,"props":5678,"children":5679},{"class":437,"line":478},[5680],{"type":22,"tag":435,"props":5681,"children":5682},{},[5683],{"type":28,"value":5684},"    participant 從庫\n",{"type":22,"tag":435,"props":5686,"children":5687},{"class":437,"line":499},[5688],{"type":22,"tag":435,"props":5689,"children":5690},{"emptyLinePlaceholder":5},[5691],{"type":28,"value":460},{"type":22,"tag":435,"props":5693,"children":5694},{"class":437,"line":516},[5695],{"type":22,"tag":435,"props":5696,"children":5697},{},[5698],{"type":28,"value":5699},"    主庫->>複製日誌: 操作1 (序列號: 1)\n",{"type":22,"tag":435,"props":5701,"children":5702},{"class":437,"line":533},[5703],{"type":22,"tag":435,"props":5704,"children":5705},{},[5706],{"type":28,"value":5707},"    複製日誌-->>從庫: 操作1 (序列號: 1)\n",{"type":22,"tag":435,"props":5709,"children":5710},{"class":437,"line":550},[5711],{"type":22,"tag":435,"props":5712,"children":5713},{},[5714],{"type":28,"value":5715},"    主庫->>複製日誌: 操作2 (序列號: 2)\n",{"type":22,"tag":435,"props":5717,"children":5718},{"class":437,"line":559},[5719],{"type":22,"tag":435,"props":5720,"children":5721},{},[5722],{"type":28,"value":5723},"    複製日誌-->>從庫: 操作2 (序列號: 2)\n",{"type":22,"tag":435,"props":5725,"children":5726},{"class":437,"line":567},[5727],{"type":22,"tag":435,"props":5728,"children":5729},{},[5730],{"type":28,"value":5731},"    主庫->>複製日誌: 操作3 (序列號: 3)\n",{"type":22,"tag":435,"props":5733,"children":5734},{"class":437,"line":591},[5735],{"type":22,"tag":435,"props":5736,"children":5737},{},[5738],{"type":28,"value":5739},"    複製日誌-->>從庫: 操作3 (序列號: 3)\n",{"type":22,"tag":418,"props":5741,"children":5743},{"id":5742},"非因果序列號生成器",[5744],{"type":22,"tag":51,"props":5745,"children":5746},{},[5747],{"type":22,"tag":55,"props":5748,"children":5751},{"href":5749,"rel":5750},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e9%9d%9e%e5%9b%a0%e6%9e%9c%e5%ba%8f%e5%88%97%e8%99%9f%e7%94%9f%e6%88%90%e5%99%a8",[59],[5752],{"type":28,"value":5742},{"type":22,"tag":137,"props":5754,"children":5755},{},[5756],{"type":28,"value":5757},"如果主庫不存在（可能因為使用了多主資料庫或無主資料庫，或者因為使用了分割槽的資料庫），如何為操作生成序列號就沒有那麼明顯了。在實踐中有各種各樣的方法：",{"type":22,"tag":4383,"props":5759,"children":5760},{},[5761,5844,5931],{"type":22,"tag":45,"props":5762,"children":5763},{},[5764,5766],{"type":28,"value":5765},"每個節點都可以生成自己獨立的一組序列號。例如有兩個節點，一個節點只能生成奇數，而另一個節點只能生成偶數。通常，可以在序列號的二進位制表示中預留一些位，用於唯一的節點識別符號，這樣可以確保兩個不同的節點永遠不會生成相同的序列號。",{"type":22,"tag":424,"props":5767,"children":5769},{"className":1718,"code":5768,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Node1 as 節點1 (奇數序列號)\n    participant Node2 as 節點2 (偶數序列號)\n    Note over Node1,Node2: 每個節點可以生成自己獨立的一組序列號\n    Node1->>Node2: 操作1 (序列號: 1)\n    Node2->>Node1: 操作2 (序列號: 2)\n    Node1->>Node2: 操作3 (序列號: 3)\n    Node2->>Node1: 操作4 (序列號: 4)\n    Note over Node1,Node2: 兩個不同的節點永遠不會生成相同的序列號\n",[5770],{"type":22,"tag":431,"props":5771,"children":5772},{"__ignoreMap":13},[5773,5780,5788,5796,5804,5812,5820,5828,5836],{"type":22,"tag":435,"props":5774,"children":5775},{"class":437,"line":438},[5776],{"type":22,"tag":435,"props":5777,"children":5778},{},[5779],{"type":28,"value":1732},{"type":22,"tag":435,"props":5781,"children":5782},{"class":437,"line":454},[5783],{"type":22,"tag":435,"props":5784,"children":5785},{},[5786],{"type":28,"value":5787},"    participant Node1 as 節點1 (奇數序列號)\n",{"type":22,"tag":435,"props":5789,"children":5790},{"class":437,"line":463},[5791],{"type":22,"tag":435,"props":5792,"children":5793},{},[5794],{"type":28,"value":5795},"    participant Node2 as 節點2 (偶數序列號)\n",{"type":22,"tag":435,"props":5797,"children":5798},{"class":437,"line":478},[5799],{"type":22,"tag":435,"props":5800,"children":5801},{},[5802],{"type":28,"value":5803},"    Note over Node1,Node2: 每個節點可以生成自己獨立的一組序列號\n",{"type":22,"tag":435,"props":5805,"children":5806},{"class":437,"line":499},[5807],{"type":22,"tag":435,"props":5808,"children":5809},{},[5810],{"type":28,"value":5811},"    Node1->>Node2: 操作1 (序列號: 1)\n",{"type":22,"tag":435,"props":5813,"children":5814},{"class":437,"line":516},[5815],{"type":22,"tag":435,"props":5816,"children":5817},{},[5818],{"type":28,"value":5819},"    Node2->>Node1: 操作2 (序列號: 2)\n",{"type":22,"tag":435,"props":5821,"children":5822},{"class":437,"line":533},[5823],{"type":22,"tag":435,"props":5824,"children":5825},{},[5826],{"type":28,"value":5827},"    Node1->>Node2: 操作3 (序列號: 3)\n",{"type":22,"tag":435,"props":5829,"children":5830},{"class":437,"line":550},[5831],{"type":22,"tag":435,"props":5832,"children":5833},{},[5834],{"type":28,"value":5835},"    Node2->>Node1: 操作4 (序列號: 4)\n",{"type":22,"tag":435,"props":5837,"children":5838},{"class":437,"line":559},[5839],{"type":22,"tag":435,"props":5840,"children":5841},{},[5842],{"type":28,"value":5843},"    Note over Node1,Node2: 兩個不同的節點永遠不會生成相同的序列號\n",{"type":22,"tag":45,"props":5845,"children":5846},{},[5847,5849,5859,5861],{"type":28,"value":5848},"可以將日曆時鐘（物理時鐘）的時間戳附加到每個操作上【55】。這種時間戳並不連續，但是如果它具有足夠高的解析度，那也許足以提供一個操作的全序關係。這一事實應用於* 最後寫入勝利 * 的衝突解決方法中（請參閱 “",{"type":22,"tag":51,"props":5850,"children":5851},{},[5852],{"type":22,"tag":55,"props":5853,"children":5856},{"href":5854,"rel":5855},"https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e6%9c%89%e5%ba%8f%e4%ba%8b%e4%bb%b6%e7%9a%84%e6%99%82%e9%96%93%e6%88%b3",[59],[5857],{"type":28,"value":5858},"有序事件的時間戳",{"type":28,"value":5860},"”）。\n”最後只有操作三可以成功寫入”",{"type":22,"tag":424,"props":5862,"children":5864},{"className":1718,"code":5863,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Node1 as 節點1\n    participant Node2 as 節點2\n    Note over Node1,Node2: 操作依賴物理時鐘\n    Node1->>Node2: 操作1 (時間戳: 08:00:00)\n    Node2->>Node1: 操作2 (時間戳: 08:01:00)\n    Node1->>Node2: 操作3 (時間戳: 08:02:00)\n    Note over Node1, Node2: 最後只有操作三可以成功寫入\n",[5865],{"type":22,"tag":431,"props":5866,"children":5867},{"__ignoreMap":13},[5868,5875,5883,5891,5899,5907,5915,5923],{"type":22,"tag":435,"props":5869,"children":5870},{"class":437,"line":438},[5871],{"type":22,"tag":435,"props":5872,"children":5873},{},[5874],{"type":28,"value":1732},{"type":22,"tag":435,"props":5876,"children":5877},{"class":437,"line":454},[5878],{"type":22,"tag":435,"props":5879,"children":5880},{},[5881],{"type":28,"value":5882},"    participant Node1 as 節點1\n",{"type":22,"tag":435,"props":5884,"children":5885},{"class":437,"line":463},[5886],{"type":22,"tag":435,"props":5887,"children":5888},{},[5889],{"type":28,"value":5890},"    participant Node2 as 節點2\n",{"type":22,"tag":435,"props":5892,"children":5893},{"class":437,"line":478},[5894],{"type":22,"tag":435,"props":5895,"children":5896},{},[5897],{"type":28,"value":5898},"    Note over Node1,Node2: 操作依賴物理時鐘\n",{"type":22,"tag":435,"props":5900,"children":5901},{"class":437,"line":499},[5902],{"type":22,"tag":435,"props":5903,"children":5904},{},[5905],{"type":28,"value":5906},"    Node1->>Node2: 操作1 (時間戳: 08:00:00)\n",{"type":22,"tag":435,"props":5908,"children":5909},{"class":437,"line":516},[5910],{"type":22,"tag":435,"props":5911,"children":5912},{},[5913],{"type":28,"value":5914},"    Node2->>Node1: 操作2 (時間戳: 08:01:00)\n",{"type":22,"tag":435,"props":5916,"children":5917},{"class":437,"line":533},[5918],{"type":22,"tag":435,"props":5919,"children":5920},{},[5921],{"type":28,"value":5922},"    Node1->>Node2: 操作3 (時間戳: 08:02:00)\n",{"type":22,"tag":435,"props":5924,"children":5925},{"class":437,"line":550},[5926],{"type":22,"tag":435,"props":5927,"children":5928},{},[5929],{"type":28,"value":5930},"    Note over Node1, Node2: 最後只有操作三可以成功寫入\n",{"type":22,"tag":45,"props":5932,"children":5933},{},[5934,5936,6006,6009,6011],{"type":28,"value":5935},"可以預先分配序列號區塊。例如，節點 A 可能要求從序列號 1 到 1,000 區塊的所有權，而節點 B 可能要求序列號 1,001 到 2,000 區塊的所有權。然後每個節點可以獨立分配所屬區塊中的序列號，並在序列號告急時請求分配一個新的區塊。",{"type":22,"tag":424,"props":5937,"children":5939},{"className":1718,"code":5938,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant NodeA as 節點A\n    participant NodeB as 節點B\n    Note over NodeA,NodeB: 預先分配序列號區塊\n    NodeA->>NodeB: 操作1 (序列號: 500)\n    NodeB->>NodeA: 操作2 (序列號: 1500)\n    NodeA->>NodeB: 操作3 (序列號: 800)\n    NodeB->>NodeA: 操作4 (序列號: 1600)\n",[5940],{"type":22,"tag":431,"props":5941,"children":5942},{"__ignoreMap":13},[5943,5950,5958,5966,5974,5982,5990,5998],{"type":22,"tag":435,"props":5944,"children":5945},{"class":437,"line":438},[5946],{"type":22,"tag":435,"props":5947,"children":5948},{},[5949],{"type":28,"value":1732},{"type":22,"tag":435,"props":5951,"children":5952},{"class":437,"line":454},[5953],{"type":22,"tag":435,"props":5954,"children":5955},{},[5956],{"type":28,"value":5957},"    participant NodeA as 節點A\n",{"type":22,"tag":435,"props":5959,"children":5960},{"class":437,"line":463},[5961],{"type":22,"tag":435,"props":5962,"children":5963},{},[5964],{"type":28,"value":5965},"    participant NodeB as 節點B\n",{"type":22,"tag":435,"props":5967,"children":5968},{"class":437,"line":478},[5969],{"type":22,"tag":435,"props":5970,"children":5971},{},[5972],{"type":28,"value":5973},"    Note over NodeA,NodeB: 預先分配序列號區塊\n",{"type":22,"tag":435,"props":5975,"children":5976},{"class":437,"line":499},[5977],{"type":22,"tag":435,"props":5978,"children":5979},{},[5980],{"type":28,"value":5981},"    NodeA->>NodeB: 操作1 (序列號: 500)\n",{"type":22,"tag":435,"props":5983,"children":5984},{"class":437,"line":516},[5985],{"type":22,"tag":435,"props":5986,"children":5987},{},[5988],{"type":28,"value":5989},"    NodeB->>NodeA: 操作2 (序列號: 1500)\n",{"type":22,"tag":435,"props":5991,"children":5992},{"class":437,"line":533},[5993],{"type":22,"tag":435,"props":5994,"children":5995},{},[5996],{"type":28,"value":5997},"    NodeA->>NodeB: 操作3 (序列號: 800)\n",{"type":22,"tag":435,"props":5999,"children":6000},{"class":437,"line":550},[6001],{"type":22,"tag":435,"props":6002,"children":6003},{},[6004],{"type":28,"value":6005},"    NodeB->>NodeA: 操作4 (序列號: 1600)\n",{"type":22,"tag":4117,"props":6007,"children":6008},{},[],{"type":28,"value":6010},"這三個選項都比單一主庫的自增計數器表現要好，並且更具可伸縮性。它們為每個操作生成一個唯一的，近似自增的序列號。然而它們都有同一個問題：生成的序列號與因果不一致。",{"type":22,"tag":4383,"props":6012,"children":6013},{},[6014,6139,6228],{"type":22,"tag":45,"props":6015,"children":6016},{},[6017,6019],{"type":28,"value":6018},"每個節點每秒可以處理不同數量的操作。因此，如果一個節點產生偶數序列號而另一個產生奇數序列號，則偶數計數器可能落後於奇數計數器，反之亦然。如果你有一個奇數編號的操作和一個偶數編號的操作，你無法準確地說出哪一個操作在因果上先發生。",{"type":22,"tag":424,"props":6020,"children":6022},{"className":1718,"code":6021,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Node1 as 節點1 (奇數序列號)\n    participant Node2 as 節點2 (偶數序列號)\n    \n    Note over Node1,Node2: 每個節點每秒可以處理不同數量的操作\n    \n    Node1->>Node2: 操作1 (序列號: 1, 時間: 08:00:00)\n    Note over Node1: 節點1 快速處理操作\n    Node1->>Node2: 操作3 (序列號: 3, 時間: 08:00:01)\n    \n    Note over Node2: 節點2 較慢地處理操作\n    Node2->>Node1: 操作2 (序列號: 2, 時間: 08:00:05)\n    Node2->>Node1: 操作4 (序列號: 4, 時間: 08:00:10)\n    \n    Note over Node1,Node2: 無法確定操作2和操作3哪個在因果上先發生\n",[6023],{"type":22,"tag":431,"props":6024,"children":6025},{"__ignoreMap":13},[6026,6033,6040,6047,6054,6062,6069,6077,6085,6093,6100,6108,6116,6124,6131],{"type":22,"tag":435,"props":6027,"children":6028},{"class":437,"line":438},[6029],{"type":22,"tag":435,"props":6030,"children":6031},{},[6032],{"type":28,"value":1732},{"type":22,"tag":435,"props":6034,"children":6035},{"class":437,"line":454},[6036],{"type":22,"tag":435,"props":6037,"children":6038},{},[6039],{"type":28,"value":5787},{"type":22,"tag":435,"props":6041,"children":6042},{"class":437,"line":463},[6043],{"type":22,"tag":435,"props":6044,"children":6045},{},[6046],{"type":28,"value":5795},{"type":22,"tag":435,"props":6048,"children":6049},{"class":437,"line":478},[6050],{"type":22,"tag":435,"props":6051,"children":6052},{},[6053],{"type":28,"value":1811},{"type":22,"tag":435,"props":6055,"children":6056},{"class":437,"line":499},[6057],{"type":22,"tag":435,"props":6058,"children":6059},{},[6060],{"type":28,"value":6061},"    Note over Node1,Node2: 每個節點每秒可以處理不同數量的操作\n",{"type":22,"tag":435,"props":6063,"children":6064},{"class":437,"line":516},[6065],{"type":22,"tag":435,"props":6066,"children":6067},{},[6068],{"type":28,"value":1811},{"type":22,"tag":435,"props":6070,"children":6071},{"class":437,"line":533},[6072],{"type":22,"tag":435,"props":6073,"children":6074},{},[6075],{"type":28,"value":6076},"    Node1->>Node2: 操作1 (序列號: 1, 時間: 08:00:00)\n",{"type":22,"tag":435,"props":6078,"children":6079},{"class":437,"line":550},[6080],{"type":22,"tag":435,"props":6081,"children":6082},{},[6083],{"type":28,"value":6084},"    Note over Node1: 節點1 快速處理操作\n",{"type":22,"tag":435,"props":6086,"children":6087},{"class":437,"line":559},[6088],{"type":22,"tag":435,"props":6089,"children":6090},{},[6091],{"type":28,"value":6092},"    Node1->>Node2: 操作3 (序列號: 3, 時間: 08:00:01)\n",{"type":22,"tag":435,"props":6094,"children":6095},{"class":437,"line":567},[6096],{"type":22,"tag":435,"props":6097,"children":6098},{},[6099],{"type":28,"value":1811},{"type":22,"tag":435,"props":6101,"children":6102},{"class":437,"line":591},[6103],{"type":22,"tag":435,"props":6104,"children":6105},{},[6106],{"type":28,"value":6107},"    Note over Node2: 節點2 較慢地處理操作\n",{"type":22,"tag":435,"props":6109,"children":6110},{"class":437,"line":606},[6111],{"type":22,"tag":435,"props":6112,"children":6113},{},[6114],{"type":28,"value":6115},"    Node2->>Node1: 操作2 (序列號: 2, 時間: 08:00:05)\n",{"type":22,"tag":435,"props":6117,"children":6118},{"class":437,"line":615},[6119],{"type":22,"tag":435,"props":6120,"children":6121},{},[6122],{"type":28,"value":6123},"    Node2->>Node1: 操作4 (序列號: 4, 時間: 08:00:10)\n",{"type":22,"tag":435,"props":6125,"children":6126},{"class":437,"line":636},[6127],{"type":22,"tag":435,"props":6128,"children":6129},{},[6130],{"type":28,"value":1811},{"type":22,"tag":435,"props":6132,"children":6133},{"class":437,"line":650},[6134],{"type":22,"tag":435,"props":6135,"children":6136},{},[6137],{"type":28,"value":6138},"    Note over Node1,Node2: 無法確定操作2和操作3哪個在因果上先發生\n",{"type":22,"tag":45,"props":6140,"children":6141},{},[6142,6144,6154,6156,6166,6168],{"type":28,"value":6143},"來自物理時鐘的時間戳會受到時鐘偏移的影響，這可能會使其與因果不一致。例如 ",{"type":22,"tag":51,"props":6145,"children":6146},{},[6147],{"type":22,"tag":55,"props":6148,"children":6151},{"href":6149,"rel":6150},"https://vonng.github.io/ddia/#/img/fig8-3.png",[59],[6152],{"type":28,"value":6153},"圖 8-3",{"type":28,"value":6155}," 展示了一個例子，其中因果上晚發生的操作，卻被分配了一個更早的時間戳。可以使物理時鐘時間戳與因果關係保持一致：在 “",{"type":22,"tag":51,"props":6157,"children":6158},{},[6159],{"type":22,"tag":55,"props":6160,"children":6163},{"href":6161,"rel":6162},"https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e5%85%a8%e5%9f%9f%e6%80%a7%e5%bf%ab%e7%85%a7%e7%9a%84%e5%90%8c%e6%ad%a5%e6%99%82%e9%90%98",[59],[6164],{"type":28,"value":6165},"全域性快照的同步時鐘",{"type":28,"value":6167},"” 中，我們討論了 Google 的 Spanner，它可以估計預期的時鐘偏差，並在提交寫入之前等待不確定性間隔。這種方法確保了實際上靠後的事務會有更大的時間戳。但是大多數時鐘不能提供這種所需的不確定性度量。",{"type":22,"tag":424,"props":6169,"children":6171},{"className":1718,"code":6170,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Node1 as 節點1\n    participant Node2 as 節點2\n    Note over Node1,Node2: 時鐘偏移影響\n    Node1->>Node2: 操作1 (時間戳: 10:00:01)\n    Node2->>Node1: 操作2 (時間戳: 10:00:00, 因果上晚於操作1)\n    Note over Node1,Node2: 因果關係與時間戳不一致\n",[6172],{"type":22,"tag":431,"props":6173,"children":6174},{"__ignoreMap":13},[6175,6182,6189,6196,6204,6212,6220],{"type":22,"tag":435,"props":6176,"children":6177},{"class":437,"line":438},[6178],{"type":22,"tag":435,"props":6179,"children":6180},{},[6181],{"type":28,"value":1732},{"type":22,"tag":435,"props":6183,"children":6184},{"class":437,"line":454},[6185],{"type":22,"tag":435,"props":6186,"children":6187},{},[6188],{"type":28,"value":5882},{"type":22,"tag":435,"props":6190,"children":6191},{"class":437,"line":463},[6192],{"type":22,"tag":435,"props":6193,"children":6194},{},[6195],{"type":28,"value":5890},{"type":22,"tag":435,"props":6197,"children":6198},{"class":437,"line":478},[6199],{"type":22,"tag":435,"props":6200,"children":6201},{},[6202],{"type":28,"value":6203},"    Note over Node1,Node2: 時鐘偏移影響\n",{"type":22,"tag":435,"props":6205,"children":6206},{"class":437,"line":499},[6207],{"type":22,"tag":435,"props":6208,"children":6209},{},[6210],{"type":28,"value":6211},"    Node1->>Node2: 操作1 (時間戳: 10:00:01)\n",{"type":22,"tag":435,"props":6213,"children":6214},{"class":437,"line":516},[6215],{"type":22,"tag":435,"props":6216,"children":6217},{},[6218],{"type":28,"value":6219},"    Node2->>Node1: 操作2 (時間戳: 10:00:00, 因果上晚於操作1)\n",{"type":22,"tag":435,"props":6221,"children":6222},{"class":437,"line":533},[6223],{"type":22,"tag":435,"props":6224,"children":6225},{},[6226],{"type":28,"value":6227},"    Note over Node1,Node2: 因果關係與時間戳不一致\n",{"type":22,"tag":45,"props":6229,"children":6230},{},[6231,6233],{"type":28,"value":6232},"在分配區塊的情況下，某個操作可能會被賦予一個範圍在 1,001 到 2,000 內的序列號，然而一個因果上更晚的操作可能被賦予一個範圍在 1 到 1,000 之間的數字。這裡序列號與因果關係也是不一致的。",{"type":22,"tag":424,"props":6234,"children":6236},{"className":1718,"code":6235,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant NodeA as 節點A\n    participant NodeB as 節點B\n    Note over NodeA,NodeB: 序列號與因果不一致\n    NodeA->>NodeB: 操作1 (序列號: 1500)\n    NodeB->>NodeA: 操作2 (序列號: 500, 因果上晚於操作1)\n    Note over NodeA,NodeB: 因果關係與序列號不一致\n",[6237],{"type":22,"tag":431,"props":6238,"children":6239},{"__ignoreMap":13},[6240,6247,6254,6261,6269,6277,6285],{"type":22,"tag":435,"props":6241,"children":6242},{"class":437,"line":438},[6243],{"type":22,"tag":435,"props":6244,"children":6245},{},[6246],{"type":28,"value":1732},{"type":22,"tag":435,"props":6248,"children":6249},{"class":437,"line":454},[6250],{"type":22,"tag":435,"props":6251,"children":6252},{},[6253],{"type":28,"value":5957},{"type":22,"tag":435,"props":6255,"children":6256},{"class":437,"line":463},[6257],{"type":22,"tag":435,"props":6258,"children":6259},{},[6260],{"type":28,"value":5965},{"type":22,"tag":435,"props":6262,"children":6263},{"class":437,"line":478},[6264],{"type":22,"tag":435,"props":6265,"children":6266},{},[6267],{"type":28,"value":6268},"    Note over NodeA,NodeB: 序列號與因果不一致\n",{"type":22,"tag":435,"props":6270,"children":6271},{"class":437,"line":499},[6272],{"type":22,"tag":435,"props":6273,"children":6274},{},[6275],{"type":28,"value":6276},"    NodeA->>NodeB: 操作1 (序列號: 1500)\n",{"type":22,"tag":435,"props":6278,"children":6279},{"class":437,"line":516},[6280],{"type":22,"tag":435,"props":6281,"children":6282},{},[6283],{"type":28,"value":6284},"    NodeB->>NodeA: 操作2 (序列號: 500, 因果上晚於操作1)\n",{"type":22,"tag":435,"props":6286,"children":6287},{"class":437,"line":533},[6288],{"type":22,"tag":435,"props":6289,"children":6290},{},[6291],{"type":28,"value":6292},"    Note over NodeA,NodeB: 因果關係與序列號不一致\n",{"type":22,"tag":418,"props":6294,"children":6296},{"id":6295},"蘭伯特時間戳",[6297],{"type":22,"tag":51,"props":6298,"children":6299},{},[6300],{"type":22,"tag":55,"props":6301,"children":6304},{"href":6302,"rel":6303},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e8%98%ad%e4%bc%af%e7%89%b9%e6%99%82%e9%96%93%e6%88%b3",[59],[6305],{"type":28,"value":6295},{"type":22,"tag":137,"props":6307,"children":6308},{},[6309],{"type":28,"value":6310},"儘管剛才描述的三個序列號生成器與因果不一致，但實際上有一個簡單的方法來產生與因果關係一致的序列號。它被稱為蘭伯特時間戳，萊斯利・蘭伯特（Leslie Lamport）於 1978 年提出【56】",{"type":22,"tag":137,"props":6312,"children":6313},{},[6314],{"type":22,"tag":341,"props":6315,"children":6318},{"alt":6316,"src":6317},"圖 9-8 Lamport 時間戳提供了與因果關係一致的全序。","https://vonng.github.io/ddia/img/fig9-8.png",[],{"type":22,"tag":137,"props":6320,"children":6321},{},[6322],{"type":22,"tag":51,"props":6323,"children":6324},{},[6325],{"type":28,"value":6316},{"type":22,"tag":137,"props":6327,"children":6328},{},[6329],{"type":28,"value":6330},"目標：",{"type":22,"tag":137,"props":6332,"children":6333},{},[6334],{"type":28,"value":6335},"Client(Count節點計數器,Node節點名稱) → 使用者攜帶個節點最大值並且在操作兩個節點時更新節點最大值",{"type":22,"tag":137,"props":6337,"children":6338},{},[6339],{"type":28,"value":6340},"解說：",{"type":22,"tag":137,"props":6342,"children":6343},{},[6344],{"type":28,"value":6345},"每次被操作Node1 與 Node2都會c都會+1，ClientA先存取Node1所以Node1 c=1 中間一段時間都是ClientB存取Node2不管存取幾次因為Node2的C持續的增加，只要ClinetA某次存取到Node2就可以因為讀取到Node2的c而去更新自己的最大值",{"type":22,"tag":137,"props":6347,"children":6348},{},[6349],{"type":28,"value":6350},"EX:ClientA(1,1)→ClientA(5,2)→因為曾經讀取過Node2的最大計數值所以ClientA可以更新Node1的c=6，最後產生ClientA(6,1)\n因為使用這樣的計數方式可以看得出彼此的因果關係",{"type":22,"tag":153,"props":6352,"children":6353},{},[6354,6370],{"type":22,"tag":157,"props":6355,"children":6356},{},[6357],{"type":22,"tag":161,"props":6358,"children":6359},{},[6360,6365],{"type":22,"tag":165,"props":6361,"children":6362},{},[6363],{"type":28,"value":6364},"ClinetA",{"type":22,"tag":165,"props":6366,"children":6367},{},[6368],{"type":28,"value":6369},"ClientB",{"type":22,"tag":179,"props":6371,"children":6372},{},[6373,6386,6399,6412,6423],{"type":22,"tag":161,"props":6374,"children":6375},{},[6376,6381],{"type":22,"tag":186,"props":6377,"children":6378},{},[6379],{"type":28,"value":6380},"(1,1)",{"type":22,"tag":186,"props":6382,"children":6383},{},[6384],{"type":28,"value":6385},"(1,2)",{"type":22,"tag":161,"props":6387,"children":6388},{},[6389,6394],{"type":22,"tag":186,"props":6390,"children":6391},{},[6392],{"type":28,"value":6393},"(5,2)",{"type":22,"tag":186,"props":6395,"children":6396},{},[6397],{"type":28,"value":6398},"(2,2)",{"type":22,"tag":161,"props":6400,"children":6401},{},[6402,6407],{"type":22,"tag":186,"props":6403,"children":6404},{},[6405],{"type":28,"value":6406},"(6,1)",{"type":22,"tag":186,"props":6408,"children":6409},{},[6410],{"type":28,"value":6411},"(3,2)",{"type":22,"tag":161,"props":6413,"children":6414},{},[6415,6418],{"type":22,"tag":186,"props":6416,"children":6417},{},[],{"type":22,"tag":186,"props":6419,"children":6420},{},[6421],{"type":28,"value":6422},"(4,2)",{"type":22,"tag":161,"props":6424,"children":6425},{},[6426,6429],{"type":22,"tag":186,"props":6427,"children":6428},{},[],{"type":22,"tag":186,"props":6430,"children":6431},{},[6432],{"type":28,"value":6433},"(6,2)",{"type":22,"tag":137,"props":6435,"children":6436},{},[6437],{"type":28,"value":6438},"就算不看圖以資料形式看待也大概猜的的出來兩個Node之間有版本差異",{"type":22,"tag":418,"props":6440,"children":6442},{"id":6441},"光有時間戳排序還不夠",[6443],{"type":22,"tag":51,"props":6444,"children":6445},{},[6446],{"type":22,"tag":55,"props":6447,"children":6450},{"href":6448,"rel":6449},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%85%89%e6%9c%89%e6%99%82%e9%96%93%e6%88%b3%e6%8e%92%e5%ba%8f%e9%82%84%e4%b8%8d%e5%a4%a0",[59],[6451],{"type":28,"value":6441},{"type":22,"tag":137,"props":6453,"children":6454},{},[6455],{"type":28,"value":6456},"雖然蘭伯特時間戳定義了一個與因果一致的全序，但它還不足以解決分散式系統中的許多常見問題。",{"type":22,"tag":137,"props":6458,"children":6459},{},[6460],{"type":28,"value":6461},"例如：",{"type":22,"tag":137,"props":6463,"children":6464},{},[6465],{"type":28,"value":6466},"同時間有兩個使用者要創建同一個名稱的帳號Alice",{"type":22,"tag":424,"props":6468,"children":6470},{"className":1718,"code":6469,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant User1 as 使用者1\n    participant User2 as 使用者2\n    participant NodeA as 節點A\n    participant NodeB as 節點B\n\n    Note over User1,User2: 嘗試創建相同的使用者名稱\n\n    User1->>NodeA: 請求創建帳戶 (使用者名稱: Alice)\n    User2->>NodeB: 請求創建帳戶 (使用者名稱: Alice)\n\n    Note over NodeA,NodeB: 生成蘭伯特時間戳\n\n    NodeA->>NodeB: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)\n    Note right of NodeB: 網路延遲\n\n    NodeB->>NodeA: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)\n    Note right of NodeA: 網路延遲\n\n    Note over NodeA,NodeB: 由於網路問題，節點無法準確比較蘭伯特時間戳，無法確定哪個請求先來。\n\n    alt 網路恢復\n        NodeA->>NodeB: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)\n        NodeB->>NodeA: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)\n        Note over NodeA,NodeB: 現在可以比較蘭伯特時間戳，但已經太遲了。\n    else 網路未恢復\n        Note over NodeA,NodeB: 系統被拖至停機，無法解決請求。\n    end\n",[6471],{"type":22,"tag":431,"props":6472,"children":6473},{"__ignoreMap":13},[6474,6481,6489,6497,6504,6511,6518,6526,6533,6541,6549,6556,6564,6571,6579,6587,6594,6602,6610,6617,6625,6632,6640,6648,6656,6664,6672,6680],{"type":22,"tag":435,"props":6475,"children":6476},{"class":437,"line":438},[6477],{"type":22,"tag":435,"props":6478,"children":6479},{},[6480],{"type":28,"value":1732},{"type":22,"tag":435,"props":6482,"children":6483},{"class":437,"line":454},[6484],{"type":22,"tag":435,"props":6485,"children":6486},{},[6487],{"type":28,"value":6488},"    participant User1 as 使用者1\n",{"type":22,"tag":435,"props":6490,"children":6491},{"class":437,"line":463},[6492],{"type":22,"tag":435,"props":6493,"children":6494},{},[6495],{"type":28,"value":6496},"    participant User2 as 使用者2\n",{"type":22,"tag":435,"props":6498,"children":6499},{"class":437,"line":478},[6500],{"type":22,"tag":435,"props":6501,"children":6502},{},[6503],{"type":28,"value":5957},{"type":22,"tag":435,"props":6505,"children":6506},{"class":437,"line":499},[6507],{"type":22,"tag":435,"props":6508,"children":6509},{},[6510],{"type":28,"value":5965},{"type":22,"tag":435,"props":6512,"children":6513},{"class":437,"line":516},[6514],{"type":22,"tag":435,"props":6515,"children":6516},{"emptyLinePlaceholder":5},[6517],{"type":28,"value":460},{"type":22,"tag":435,"props":6519,"children":6520},{"class":437,"line":533},[6521],{"type":22,"tag":435,"props":6522,"children":6523},{},[6524],{"type":28,"value":6525},"    Note over User1,User2: 嘗試創建相同的使用者名稱\n",{"type":22,"tag":435,"props":6527,"children":6528},{"class":437,"line":550},[6529],{"type":22,"tag":435,"props":6530,"children":6531},{"emptyLinePlaceholder":5},[6532],{"type":28,"value":460},{"type":22,"tag":435,"props":6534,"children":6535},{"class":437,"line":559},[6536],{"type":22,"tag":435,"props":6537,"children":6538},{},[6539],{"type":28,"value":6540},"    User1->>NodeA: 請求創建帳戶 (使用者名稱: Alice)\n",{"type":22,"tag":435,"props":6542,"children":6543},{"class":437,"line":567},[6544],{"type":22,"tag":435,"props":6545,"children":6546},{},[6547],{"type":28,"value":6548},"    User2->>NodeB: 請求創建帳戶 (使用者名稱: Alice)\n",{"type":22,"tag":435,"props":6550,"children":6551},{"class":437,"line":591},[6552],{"type":22,"tag":435,"props":6553,"children":6554},{"emptyLinePlaceholder":5},[6555],{"type":28,"value":460},{"type":22,"tag":435,"props":6557,"children":6558},{"class":437,"line":606},[6559],{"type":22,"tag":435,"props":6560,"children":6561},{},[6562],{"type":28,"value":6563},"    Note over NodeA,NodeB: 生成蘭伯特時間戳\n",{"type":22,"tag":435,"props":6565,"children":6566},{"class":437,"line":615},[6567],{"type":22,"tag":435,"props":6568,"children":6569},{"emptyLinePlaceholder":5},[6570],{"type":28,"value":460},{"type":22,"tag":435,"props":6572,"children":6573},{"class":437,"line":636},[6574],{"type":22,"tag":435,"props":6575,"children":6576},{},[6577],{"type":28,"value":6578},"    NodeA->>NodeB: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)\n",{"type":22,"tag":435,"props":6580,"children":6581},{"class":437,"line":650},[6582],{"type":22,"tag":435,"props":6583,"children":6584},{},[6585],{"type":28,"value":6586},"    Note right of NodeB: 網路延遲\n",{"type":22,"tag":435,"props":6588,"children":6589},{"class":437,"line":678},[6590],{"type":22,"tag":435,"props":6591,"children":6592},{"emptyLinePlaceholder":5},[6593],{"type":28,"value":460},{"type":22,"tag":435,"props":6595,"children":6596},{"class":437,"line":686},[6597],{"type":22,"tag":435,"props":6598,"children":6599},{},[6600],{"type":28,"value":6601},"    NodeB->>NodeA: 通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)\n",{"type":22,"tag":435,"props":6603,"children":6604},{"class":437,"line":694},[6605],{"type":22,"tag":435,"props":6606,"children":6607},{},[6608],{"type":28,"value":6609},"    Note right of NodeA: 網路延遲\n",{"type":22,"tag":435,"props":6611,"children":6612},{"class":437,"line":759},[6613],{"type":22,"tag":435,"props":6614,"children":6615},{"emptyLinePlaceholder":5},[6616],{"type":28,"value":460},{"type":22,"tag":435,"props":6618,"children":6619},{"class":437,"line":783},[6620],{"type":22,"tag":435,"props":6621,"children":6622},{},[6623],{"type":28,"value":6624},"    Note over NodeA,NodeB: 由於網路問題，節點無法準確比較蘭伯特時間戳，無法確定哪個請求先來。\n",{"type":22,"tag":435,"props":6626,"children":6627},{"class":437,"line":837},[6628],{"type":22,"tag":435,"props":6629,"children":6630},{"emptyLinePlaceholder":5},[6631],{"type":28,"value":460},{"type":22,"tag":435,"props":6633,"children":6634},{"class":437,"line":894},[6635],{"type":22,"tag":435,"props":6636,"children":6637},{},[6638],{"type":28,"value":6639},"    alt 網路恢復\n",{"type":22,"tag":435,"props":6641,"children":6642},{"class":437,"line":971},[6643],{"type":22,"tag":435,"props":6644,"children":6645},{},[6646],{"type":28,"value":6647},"        NodeA->>NodeB: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L1)\n",{"type":22,"tag":435,"props":6649,"children":6650},{"class":437,"line":980},[6651],{"type":22,"tag":435,"props":6652,"children":6653},{},[6654],{"type":28,"value":6655},"        NodeB->>NodeA: 重新通知創建請求 (使用者名稱: Alice, 蘭伯特時間戳: L2)\n",{"type":22,"tag":435,"props":6657,"children":6658},{"class":437,"line":988},[6659],{"type":22,"tag":435,"props":6660,"children":6661},{},[6662],{"type":28,"value":6663},"        Note over NodeA,NodeB: 現在可以比較蘭伯特時間戳，但已經太遲了。\n",{"type":22,"tag":435,"props":6665,"children":6666},{"class":437,"line":996},[6667],{"type":22,"tag":435,"props":6668,"children":6669},{},[6670],{"type":28,"value":6671},"    else 網路未恢復\n",{"type":22,"tag":435,"props":6673,"children":6674},{"class":437,"line":1064},[6675],{"type":22,"tag":435,"props":6676,"children":6677},{},[6678],{"type":28,"value":6679},"        Note over NodeA,NodeB: 系統被拖至停機，無法解決請求。\n",{"type":22,"tag":435,"props":6681,"children":6682},{"class":437,"line":1084},[6683],{"type":22,"tag":435,"props":6684,"children":6685},{},[6686],{"type":28,"value":6687},"    end\n",{"type":22,"tag":4383,"props":6689,"children":6690},{},[6691,6701,6711,6721,6731,6741],{"type":22,"tag":45,"props":6692,"children":6693},{},[6694,6699],{"type":22,"tag":51,"props":6695,"children":6696},{},[6697],{"type":28,"value":6698},"請求發送:",{"type":28,"value":6700}," 使用者1和使用者2分別向節點A和節點B發送請求，試圖創建使用相同名稱的帳戶。",{"type":22,"tag":45,"props":6702,"children":6703},{},[6704,6709],{"type":22,"tag":51,"props":6705,"children":6706},{},[6707],{"type":28,"value":6708},"生成蘭伯特時間戳:",{"type":28,"value":6710}," 節點A和節點B在接收到請求時生成蘭伯特時間戳。假設節點A生成的時間戳為L1，節點B生成的時間戳為L2。",{"type":22,"tag":45,"props":6712,"children":6713},{},[6714,6719],{"type":22,"tag":51,"props":6715,"children":6716},{},[6717],{"type":28,"value":6718},"嘗試通知:",{"type":28,"value":6720}," 節點A嘗試通知節點B它的請求和時間戳L1，而節點B嘗試通知節點A它的請求和時間戳L2。",{"type":22,"tag":45,"props":6722,"children":6723},{},[6724,6729],{"type":22,"tag":51,"props":6725,"children":6726},{},[6727],{"type":28,"value":6728},"網路延遲:",{"type":28,"value":6730}," 由於網路延遲或其他網路問題，這些通知可能會延遲到達，或者可能根本無法到達(節點A與節點B之間的網路延遲)。這使得節點之間無法立即比較蘭伯特時間戳，也就無法確定哪個請求先到來。",{"type":22,"tag":45,"props":6732,"children":6733},{},[6734,6739],{"type":22,"tag":51,"props":6735,"children":6736},{},[6737],{"type":28,"value":6738},"網路恢復（如果恢復的話）:",{"type":28,"value":6740}," 如果網路最終恢復，節點A和節點B可以重新通知對方它們的請求和蘭伯特時間戳。現在，它們可以比較蘭伯特時間戳來確定哪個請求先到來。但是，這可能已經太遲了，因為使用者可能已經不再等待，或者系統可能已經因其他原因而進入不一致的狀態。",{"type":22,"tag":45,"props":6742,"children":6743},{},[6744,6749],{"type":22,"tag":51,"props":6745,"children":6746},{},[6747],{"type":28,"value":6748},"網路未恢復:",{"type":28,"value":6750}," 如果網路未能恢復，節點A和節點B無法確定哪個請求先到來，這可能導致系統被拖至停機，無法解決這些請求。",{"type":22,"tag":137,"props":6752,"children":6753},{},[6754],{"type":28,"value":4330},{"type":22,"tag":137,"props":6756,"children":6757},{},[6758,6760,6770],{"type":28,"value":6759},"即使使用了蘭伯特時間戳（Lamport Timestamps）來確定全序關係，仍然會因為操作的不確定性導致並不完全全序。只有在所有的操作都被收集後，操作的全序才會出現。如何確定全序關係已經塵埃落定，這將在 ",{"type":22,"tag":51,"props":6761,"children":6762},{},[6763],{"type":22,"tag":55,"props":6764,"children":6767},{"href":6765,"rel":6766},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad",[59],[6768],{"type":28,"value":6769},"全序廣播",{"type":28,"value":6771}," 一節中詳細說明。",{"type":22,"tag":30,"props":6773,"children":6774},{"id":6769},[6775],{"type":22,"tag":51,"props":6776,"children":6777},{},[6778],{"type":22,"tag":55,"props":6779,"children":6781},{"href":6765,"rel":6780},[59],[6782],{"type":28,"value":6769},{"type":22,"tag":137,"props":6784,"children":6785},{},[6786],{"type":28,"value":300},{"type":22,"tag":4383,"props":6788,"children":6789},{},[6790,6800,6810,6820,6830,6853],{"type":22,"tag":45,"props":6791,"children":6792},{},[6793,6798],{"type":22,"tag":51,"props":6794,"children":6795},{},[6796],{"type":28,"value":6797},"單CPU核心的操作順序",{"type":28,"value":6799},"：當程式在單個CPU核心上運行時，定義操作的全序相對簡單，因為操作的順序就是它們被CPU執行的順序。",{"type":22,"tag":45,"props":6801,"children":6802},{},[6803,6808],{"type":22,"tag":51,"props":6804,"children":6805},{},[6806],{"type":28,"value":6807},"分散式系統的操作順序",{"type":28,"value":6809},"：在分散式系統中，各節點可能在不同的時間執行操作，使得確定全域性操作順序變得困難。",{"type":22,"tag":45,"props":6811,"children":6812},{},[6813,6818],{"type":22,"tag":51,"props":6814,"children":6815},{},[6816],{"type":28,"value":6817},"時間戳或序列號排序的局限性",{"type":28,"value":6819},"：雖然可以通過時間戳或序列號來排序操作，但是這種方法不如單主複製有效，尤其是在需要確保唯一性時。",{"type":22,"tag":45,"props":6821,"children":6822},{},[6823,6828],{"type":22,"tag":51,"props":6824,"children":6825},{},[6826],{"type":28,"value":6827},"單主複製",{"type":28,"value":6829},"：單主複製通過選擇一個節點作為主庫來確定操作的全序，並在主庫的單個CPU核心上對所有操作進行排序。",{"type":22,"tag":45,"props":6831,"children":6832},{},[6833,6838,6840],{"type":22,"tag":51,"props":6834,"children":6835},{},[6836],{"type":28,"value":6837},"吞吐量和故障恢復的挑戰",{"type":28,"value":6839},"：\n",{"type":22,"tag":41,"props":6841,"children":6842},{},[6843,6848],{"type":22,"tag":45,"props":6844,"children":6845},{},[6846],{"type":28,"value":6847},"如果系統的吞吐量需求超過了單個主庫的處理能力，則需要考慮如何擴展系統。",{"type":22,"tag":45,"props":6849,"children":6850},{},[6851],{"type":28,"value":6852},"如果主庫失效，則需要考慮如何進行故障切換，以保證系統的持續運行。",{"type":22,"tag":45,"props":6854,"children":6855},{},[6856,6861],{"type":22,"tag":51,"props":6857,"children":6858},{},[6859],{"type":28,"value":6860},"全序廣播和原子廣播",{"type":28,"value":6862},"：這兩種技術旨在解決分散式系統中的全序問題，確保所有節點都以相同的順序看到所有操作，即使在面對節點失效或網路問題的時候也能保持一致性。",{"type":22,"tag":137,"props":6864,"children":6865},{},[6866],{"type":28,"value":6867},"全序廣播必須滿足兩個條件：",{"type":22,"tag":137,"props":6869,"children":6870},{},[6871],{"type":28,"value":6872},"1.可靠交付",{"type":22,"tag":137,"props":6874,"children":6875},{},[6876],{"type":28,"value":6877},"沒有訊息丟失：如果訊息被傳遞到一個節點，它將被傳遞到所有節點。",{"type":22,"tag":137,"props":6879,"children":6880},{},[6881],{"type":28,"value":6882},"2.全序交付",{"type":22,"tag":137,"props":6884,"children":6885},{},[6886],{"type":28,"value":6887},"訊息以相同的順序傳遞給每個節點。",{"type":22,"tag":137,"props":6889,"children":6890},{},[6891],{"type":28,"value":6892},"正確的全序廣播演算法必須始終保證可靠性和有序性，即使節點或網路出現故障。當然在網路中斷的時候，訊息是傳不出去的，但是演算法可以不斷重試，以便在網路最終修復時，訊息能及時透過並送達（當然它們必須仍然按照正確的順序傳遞）。",{"type":22,"tag":418,"props":6894,"children":6896},{"id":6895},"使用全序廣播",[6897],{"type":22,"tag":51,"props":6898,"children":6899},{},[6900],{"type":22,"tag":55,"props":6901,"children":6904},{"href":6902,"rel":6903},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%bd%bf%e7%94%a8%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad",[59],[6905],{"type":28,"value":6895},{"type":22,"tag":4383,"props":6907,"children":6908},{},[6909,6926,6943,6960,6977,6994],{"type":22,"tag":45,"props":6910,"children":6911},{},[6912,6917,6918],{"type":22,"tag":51,"props":6913,"children":6914},{},[6915],{"type":28,"value":6916},"共識服務與全序廣播",{"type":28,"value":6839},{"type":22,"tag":41,"props":6919,"children":6920},{},[6921],{"type":22,"tag":45,"props":6922,"children":6923},{},[6924],{"type":28,"value":6925},"類似 ZooKeeper 和 etcd 的共識服務實際上實現了全序廣播，顯示了全序廣播與共識之間的密切聯繫。",{"type":22,"tag":45,"props":6927,"children":6928},{},[6929,6934,6935],{"type":22,"tag":51,"props":6930,"children":6931},{},[6932],{"type":28,"value":6933},"資料庫複製",{"type":28,"value":6839},{"type":22,"tag":41,"props":6936,"children":6937},{},[6938],{"type":22,"tag":45,"props":6939,"children":6940},{},[6941],{"type":28,"value":6942},"全序廣播是資料庫複製所需的，每個訊息代表一次資料庫的寫入，所有副本按相同的順序處理相同的寫入，保證副本間的一致性，這被稱為狀態機複製。",{"type":22,"tag":45,"props":6944,"children":6945},{},[6946,6951,6952],{"type":22,"tag":51,"props":6947,"children":6948},{},[6949],{"type":28,"value":6950},"可序列化的事務",{"type":28,"value":6839},{"type":22,"tag":41,"props":6953,"children":6954},{},[6955],{"type":22,"tag":45,"props":6956,"children":6957},{},[6958],{"type":28,"value":6959},"使用全序廣播可以實現可序列化的事務，每個訊息代表一個確定性事務，並且每個節點以相同的順序處理這些訊息，保證資料庫的分割槽和副本的一致性。",{"type":22,"tag":45,"props":6961,"children":6962},{},[6963,6968,6969],{"type":22,"tag":51,"props":6964,"children":6965},{},[6966],{"type":28,"value":6967},"訊息順序的固化",{"type":28,"value":6839},{"type":22,"tag":41,"props":6970,"children":6971},{},[6972],{"type":22,"tag":45,"props":6973,"children":6974},{},[6975],{"type":28,"value":6976},"在全序廣播中，訊息順序在訊息送達時被固化，不允許追溯地將訊息插入順序中的較早位置，使全序廣播比時間戳排序更強。",{"type":22,"tag":45,"props":6978,"children":6979},{},[6980,6985,6986],{"type":22,"tag":51,"props":6981,"children":6982},{},[6983],{"type":28,"value":6984},"日誌的建立",{"type":28,"value":6839},{"type":22,"tag":41,"props":6987,"children":6988},{},[6989],{"type":22,"tag":45,"props":6990,"children":6991},{},[6992],{"type":28,"value":6993},"全序廣播也是建立日誌的一種方式，傳遞訊息就像追加寫入日誌，所有節點必須以相同的順序傳遞相同的訊息，以確保所有節點都可以讀取日誌並看到相同的訊息序列。",{"type":22,"tag":45,"props":6995,"children":6996},{},[6997,7002,7003],{"type":22,"tag":51,"props":6998,"children":6999},{},[7000],{"type":28,"value":7001},"防護令牌的鎖服務",{"type":28,"value":6839},{"type":22,"tag":41,"props":7004,"children":7005},{},[7006],{"type":22,"tag":45,"props":7007,"children":7008},{},[7009],{"type":28,"value":7010},"在實現提供防護令牌的鎖服務中，全序廣播也非常有用。每個獲取鎖的請求都作為一條訊息追加到日誌末尾，並按日誌中的順序依次編號，這些序列號可以作為防護令牌使用。",{"type":22,"tag":418,"props":7012,"children":7014},{"id":7013},"使用全序廣播實現線性一致的儲存",[7015],{"type":22,"tag":51,"props":7016,"children":7017},{},[7018],{"type":22,"tag":55,"props":7019,"children":7022},{"href":7020,"rel":7021},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%bd%bf%e7%94%a8%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad%e5%af%a6%e7%8f%be%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e7%9a%84%e5%84%b2%e5%ad%98",[59],[7023],{"type":28,"value":7013},{"type":22,"tag":4383,"props":7025,"children":7026},{},[7027,7044,7061,7078,7095],{"type":22,"tag":45,"props":7028,"children":7029},{},[7030,7035,7036],{"type":22,"tag":51,"props":7031,"children":7032},{},[7033],{"type":28,"value":7034},"基於全序廣播建立線性一致儲存",{"type":28,"value":6839},{"type":22,"tag":41,"props":7037,"children":7038},{},[7039],{"type":22,"tag":45,"props":7040,"children":7041},{},[7042],{"type":28,"value":7043},"全序廣播保證訊息以固定的順序可靠地傳送，而線性一致性則保證讀取能看見最新的寫入值。基於全序廣播，可以構建線性一致的儲存系統。",{"type":22,"tag":45,"props":7045,"children":7046},{},[7047,7052,7053],{"type":22,"tag":51,"props":7048,"children":7049},{},[7050],{"type":28,"value":7051},"利用 CAS (比較並設定) 原子操作",{"type":28,"value":6839},{"type":22,"tag":41,"props":7054,"children":7055},{},[7056],{"type":22,"tag":45,"props":7057,"children":7058},{},[7059],{"type":28,"value":7060},"對每個可能的使用者名稱，創建一個帶有 CAS 原子操作的線性一致暫存器，以確保使用者名稱的唯一性。",{"type":22,"tag":45,"props":7062,"children":7063},{},[7064,7069,7070],{"type":22,"tag":51,"props":7065,"children":7066},{},[7067],{"type":28,"value":7068},"僅追加日誌的全序廣播",{"type":28,"value":6839},{"type":22,"tag":41,"props":7071,"children":7072},{},[7073],{"type":22,"tag":45,"props":7074,"children":7075},{},[7076],{"type":28,"value":7077},"以僅追加日誌的形式實現全序廣播，並通過在日誌中追加和讀取訊息來實現線性一致的 CAS 操作。",{"type":22,"tag":45,"props":7079,"children":7080},{},[7081,7086,7087],{"type":22,"tag":51,"props":7082,"children":7083},{},[7084],{"type":28,"value":7085},"處理併發寫入",{"type":28,"value":6839},{"type":22,"tag":41,"props":7088,"children":7089},{},[7090],{"type":22,"tag":45,"props":7091,"children":7092},{},[7093],{"type":28,"value":7094},"由於日誌項以相同的順序送達所有節點，可以選擇衝突寫入中的第一個作為勝利者，並中止後來者，以此確保所有節點對某個寫入是提交還是中止達成一致。",{"type":22,"tag":45,"props":7096,"children":7097},{},[7098,7103,7104],{"type":22,"tag":51,"props":7099,"children":7100},{},[7101],{"type":28,"value":7102},"線性一致的讀取",{"type":28,"value":6839},{"type":22,"tag":41,"props":7105,"children":7106},{},[7107],{"type":22,"tag":45,"props":7108,"children":7109},{},[7110,7112],{"type":28,"value":7111},"為了使讀取也線性一致，可以選擇：\n",{"type":22,"tag":41,"props":7113,"children":7114},{},[7115,7120,7125],{"type":22,"tag":45,"props":7116,"children":7117},{},[7118],{"type":28,"value":7119},"在日誌中追加訊息並等待該訊息被讀回來執行實際的讀取操作；",{"type":22,"tag":45,"props":7121,"children":7122},{},[7123],{"type":28,"value":7124},"查詢最新日誌訊息的位置，等待所有訊息傳達後再執行讀取；",{"type":22,"tag":45,"props":7126,"children":7127},{},[7128],{"type":28,"value":7129},"或從同步更新的副本中進行讀取以確保結果是最新的。",{"type":22,"tag":137,"props":7131,"children":7132},{},[7133],{"type":28,"value":4330},{"type":22,"tag":137,"props":7135,"children":7136},{},[7137],{"type":28,"value":7138},"全序廣播就是確保所有電腦（節點）收到的訊息順序都是一樣的，好比是把訊息按照1、2、3、4的順序發給每台電腦，讓每台電腦都按照這個順序來處理事情。這樣做的好處是，當多人同時要求做某件事（比如同時要求建立同一個使用者名稱的帳戶）時，全序廣播可以確定一個固定的順序來處理這些要求，避免亂七八糟的情況發生。也能確保即便網路有延遲，訊息還是能按照正確的順序被送達和處理。全序廣播也能支援一些特定的操作，比如比較然後設定（CAS），確保這些操作能正確無誤地完成。最後，全序廣播通過讓所有電腦按照相同的順序來處理事情，使得每台電腦的狀態都能保持一致。所以，全序廣播是實現線性一致儲存（讓所有電腦的資料保持一致）的一個重要方法。",{"type":22,"tag":418,"props":7140,"children":7142},{"id":7141},"使用線性一致性儲存實現全序廣播",[7143],{"type":22,"tag":51,"props":7144,"children":7145},{},[7146],{"type":22,"tag":55,"props":7147,"children":7150},{"href":7148,"rel":7149},"https://vonng.github.io/ddia/#/zh-tw/ch9?id=%e4%bd%bf%e7%94%a8%e7%b7%9a%e6%80%a7%e4%b8%80%e8%87%b4%e6%80%a7%e5%84%b2%e5%ad%98%e5%af%a6%e7%8f%be%e5%85%a8%e5%ba%8f%e5%bb%a3%e6%92%ad",[59],[7151],{"type":28,"value":7141},{"type":22,"tag":4383,"props":7153,"children":7154},{},[7155,7182,7199,7221],{"type":22,"tag":45,"props":7156,"children":7157},{},[7158,7163,7164],{"type":22,"tag":51,"props":7159,"children":7160},{},[7161],{"type":28,"value":7162},"利用線性一致性儲存實現全序廣播的方法",{"type":28,"value":6839},{"type":22,"tag":41,"props":7165,"children":7166},{},[7167,7172,7177],{"type":22,"tag":45,"props":7168,"children":7169},{},[7170],{"type":28,"value":7171},"利用線性一致的暫存器儲存一個整數，並提供原子的自增並返回操作或原子CAS操作。",{"type":22,"tag":45,"props":7173,"children":7174},{},[7175],{"type":28,"value":7176},"對於每個要透過全序廣播發送的訊息，首先執行自增並返回操作，獲得一個序列號，然後將此序列號附加到訊息中。",{"type":22,"tag":45,"props":7178,"children":7179},{},[7180],{"type":28,"value":7181},"之後將訊息傳送到所有節點，收件人按照序列號的順序依序傳遞訊息。",{"type":22,"tag":45,"props":7183,"children":7184},{},[7185,7190,7191],{"type":22,"tag":51,"props":7186,"children":7187},{},[7188],{"type":28,"value":7189},"與蘭伯特時間戳的區別",{"type":28,"value":6839},{"type":22,"tag":41,"props":7192,"children":7193},{},[7194],{"type":22,"tag":45,"props":7195,"children":7196},{},[7197],{"type":28,"value":7198},"自增線性一致性暫存器獲得的是一個沒有間隙的序列，與蘭伯特時間戳的隨機序列不同，這是全序廣播和時間戳排序間的關鍵區別。",{"type":22,"tag":45,"props":7200,"children":7201},{},[7202,7207,7208],{"type":22,"tag":51,"props":7203,"children":7204},{},[7205],{"type":28,"value":7206},"實現困難",{"type":28,"value":6839},{"type":22,"tag":41,"props":7209,"children":7210},{},[7211,7216],{"type":22,"tag":45,"props":7212,"children":7213},{},[7214],{"type":28,"value":7215},"在單節點情況下實現線性一致性暫存器相對簡單，但在分散式環境中，特別是當節點出錯或網路連接中斷時，實現變得困難。",{"type":22,"tag":45,"props":7217,"children":7218},{},[7219],{"type":28,"value":7220},"要實現原子性的自增並返回操作，需要深入思考線性一致性的序列號生成器，並可能需要一個共識演算法。",{"type":22,"tag":45,"props":7222,"children":7223},{},[7224,7229,7230],{"type":22,"tag":51,"props":7225,"children":7226},{},[7227],{"type":28,"value":7228},"與共識問題的關聯",{"type":28,"value":6839},{"type":22,"tag":41,"props":7231,"children":7232},{},[7233],{"type":22,"tag":45,"props":7234,"children":7235},{},[7236],{"type":28,"value":7237},"線性一致的CAS或自增並返回暫存器與全序廣播都與共識問題等價，意味著解決了其中一個問題，就可以轉化為解決其他問題的方案。",{"type":22,"tag":137,"props":7239,"children":7240},{},[7241],{"type":28,"value":4330},{"type":22,"tag":137,"props":7243,"children":7244},{},[7245],{"type":28,"value":7246},"利用線性一致性儲存來做全序廣播就是，先有一個特別的儲存空間，它能夠自動增加一個數字，每當有新訊息要發送時，就先讓這個數字加一，然後把這個數字貼到訊息上，接著把訊息發給所有的電腦節點。這樣，每個電腦節點收到訊息時，就按照貼在訊息上的數字順序來處理它們。如果發現有數字跳號了，就先等一下，直到收到缺的那個訊息。如果在這過程中，有電腦節點出了問題或是網路有問題，也有辦法找回並繼續增加那個數字，保證不會亂掉順序。",{"type":22,"tag":137,"props":7248,"children":7249},{},[7250],{"type":28,"value":7251},"兩者比較：",{"type":22,"tag":137,"props":7253,"children":7254},{},[7255],{"type":28,"value":7256},"使用全序廣播實現線性一致的儲存，就像是有一個郵差負責把信依照特定的順序送到大家手上，每個人都按照收信的順序來讀信，這樣就保證了大家都有相同的理解。這個郵差就像是全序廣播，他保證信件按照一定的順序送到每個人手上，而每個人的儲存空間就像是他們手中的信件，按照順序來讀和理解。",{"type":22,"tag":137,"props":7258,"children":7259},{},[7260],{"type":28,"value":7261},"使用線性一致性儲存實現全序廣播，就像是大家都有一個共用的信箱，每個人都可以在裡面放信，但信箱有一個特殊的鎖，只允許按照一定的順序打開來取信。這個信箱就是線性一致性儲存，它保證大家按照一定的順序來放入和取出信件，而全序廣播就是透過這個信箱來保證信件的順序。",{"type":22,"tag":137,"props":7263,"children":7264},{},[7265],{"type":28,"value":7266},"簡單來說，前者是靠郵差（全序廣播）來保證信件順序，讓儲存保持一致；後者是靠信箱（線性一致性儲存）來保證信件順序，進而實現全序廣播。",{"type":22,"tag":137,"props":7268,"children":7269},{},[7270],{"type":28,"value":7271},"蘭伯特時間戳VS全序廣播",{"type":22,"tag":424,"props":7273,"children":7274},{"className":1718,"code":6469,"language":1720,"meta":13,"style":13},[7275],{"type":22,"tag":431,"props":7276,"children":7277},{"__ignoreMap":13},[7278,7285,7292,7299,7306,7313,7320,7327,7334,7341,7348,7355,7362,7369,7376,7383,7390,7397,7404,7411,7418,7425,7432,7439,7446,7453,7460,7467],{"type":22,"tag":435,"props":7279,"children":7280},{"class":437,"line":438},[7281],{"type":22,"tag":435,"props":7282,"children":7283},{},[7284],{"type":28,"value":1732},{"type":22,"tag":435,"props":7286,"children":7287},{"class":437,"line":454},[7288],{"type":22,"tag":435,"props":7289,"children":7290},{},[7291],{"type":28,"value":6488},{"type":22,"tag":435,"props":7293,"children":7294},{"class":437,"line":463},[7295],{"type":22,"tag":435,"props":7296,"children":7297},{},[7298],{"type":28,"value":6496},{"type":22,"tag":435,"props":7300,"children":7301},{"class":437,"line":478},[7302],{"type":22,"tag":435,"props":7303,"children":7304},{},[7305],{"type":28,"value":5957},{"type":22,"tag":435,"props":7307,"children":7308},{"class":437,"line":499},[7309],{"type":22,"tag":435,"props":7310,"children":7311},{},[7312],{"type":28,"value":5965},{"type":22,"tag":435,"props":7314,"children":7315},{"class":437,"line":516},[7316],{"type":22,"tag":435,"props":7317,"children":7318},{"emptyLinePlaceholder":5},[7319],{"type":28,"value":460},{"type":22,"tag":435,"props":7321,"children":7322},{"class":437,"line":533},[7323],{"type":22,"tag":435,"props":7324,"children":7325},{},[7326],{"type":28,"value":6525},{"type":22,"tag":435,"props":7328,"children":7329},{"class":437,"line":550},[7330],{"type":22,"tag":435,"props":7331,"children":7332},{"emptyLinePlaceholder":5},[7333],{"type":28,"value":460},{"type":22,"tag":435,"props":7335,"children":7336},{"class":437,"line":559},[7337],{"type":22,"tag":435,"props":7338,"children":7339},{},[7340],{"type":28,"value":6540},{"type":22,"tag":435,"props":7342,"children":7343},{"class":437,"line":567},[7344],{"type":22,"tag":435,"props":7345,"children":7346},{},[7347],{"type":28,"value":6548},{"type":22,"tag":435,"props":7349,"children":7350},{"class":437,"line":591},[7351],{"type":22,"tag":435,"props":7352,"children":7353},{"emptyLinePlaceholder":5},[7354],{"type":28,"value":460},{"type":22,"tag":435,"props":7356,"children":7357},{"class":437,"line":606},[7358],{"type":22,"tag":435,"props":7359,"children":7360},{},[7361],{"type":28,"value":6563},{"type":22,"tag":435,"props":7363,"children":7364},{"class":437,"line":615},[7365],{"type":22,"tag":435,"props":7366,"children":7367},{"emptyLinePlaceholder":5},[7368],{"type":28,"value":460},{"type":22,"tag":435,"props":7370,"children":7371},{"class":437,"line":636},[7372],{"type":22,"tag":435,"props":7373,"children":7374},{},[7375],{"type":28,"value":6578},{"type":22,"tag":435,"props":7377,"children":7378},{"class":437,"line":650},[7379],{"type":22,"tag":435,"props":7380,"children":7381},{},[7382],{"type":28,"value":6586},{"type":22,"tag":435,"props":7384,"children":7385},{"class":437,"line":678},[7386],{"type":22,"tag":435,"props":7387,"children":7388},{"emptyLinePlaceholder":5},[7389],{"type":28,"value":460},{"type":22,"tag":435,"props":7391,"children":7392},{"class":437,"line":686},[7393],{"type":22,"tag":435,"props":7394,"children":7395},{},[7396],{"type":28,"value":6601},{"type":22,"tag":435,"props":7398,"children":7399},{"class":437,"line":694},[7400],{"type":22,"tag":435,"props":7401,"children":7402},{},[7403],{"type":28,"value":6609},{"type":22,"tag":435,"props":7405,"children":7406},{"class":437,"line":759},[7407],{"type":22,"tag":435,"props":7408,"children":7409},{"emptyLinePlaceholder":5},[7410],{"type":28,"value":460},{"type":22,"tag":435,"props":7412,"children":7413},{"class":437,"line":783},[7414],{"type":22,"tag":435,"props":7415,"children":7416},{},[7417],{"type":28,"value":6624},{"type":22,"tag":435,"props":7419,"children":7420},{"class":437,"line":837},[7421],{"type":22,"tag":435,"props":7422,"children":7423},{"emptyLinePlaceholder":5},[7424],{"type":28,"value":460},{"type":22,"tag":435,"props":7426,"children":7427},{"class":437,"line":894},[7428],{"type":22,"tag":435,"props":7429,"children":7430},{},[7431],{"type":28,"value":6639},{"type":22,"tag":435,"props":7433,"children":7434},{"class":437,"line":971},[7435],{"type":22,"tag":435,"props":7436,"children":7437},{},[7438],{"type":28,"value":6647},{"type":22,"tag":435,"props":7440,"children":7441},{"class":437,"line":980},[7442],{"type":22,"tag":435,"props":7443,"children":7444},{},[7445],{"type":28,"value":6655},{"type":22,"tag":435,"props":7447,"children":7448},{"class":437,"line":988},[7449],{"type":22,"tag":435,"props":7450,"children":7451},{},[7452],{"type":28,"value":6663},{"type":22,"tag":435,"props":7454,"children":7455},{"class":437,"line":996},[7456],{"type":22,"tag":435,"props":7457,"children":7458},{},[7459],{"type":28,"value":6671},{"type":22,"tag":435,"props":7461,"children":7462},{"class":437,"line":1064},[7463],{"type":22,"tag":435,"props":7464,"children":7465},{},[7466],{"type":28,"value":6679},{"type":22,"tag":435,"props":7468,"children":7469},{"class":437,"line":1084},[7470],{"type":22,"tag":435,"props":7471,"children":7472},{},[7473],{"type":28,"value":6687},{"type":22,"tag":424,"props":7475,"children":7477},{"className":1718,"code":7476,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant User1 as 使用者1\n    participant User2 as 使用者2\n    participant NodeA as 節點A\n    participant NodeB as 節點B\n    participant TotalOrderBroadcast as 全序廣播服務\n\n    Note over User1,User2: 嘗試創建相同的使用者名稱\n\n    User1->>NodeA: 請求創建帳戶 (使用者名稱: Alice)\n    User2->>NodeB: 請求創建帳戶 (使用者名稱: Alice)\n\n    NodeA->>TotalOrderBroadcast: 發送創建請求 (使用者名稱: Alice)\n    NodeB->>TotalOrderBroadcast: 發送創建請求 (使用者名稱: Alice)\n\n    Note over TotalOrderBroadcast: 全序廣播服務確保所有節點看到相同順序的消息\n\n    TotalOrderBroadcast->>NodeA: 傳遞創建請求 (使用者名稱: Alice, 順序: 1)\n    TotalOrderBroadcast->>NodeB: 傳遞創建請求 (使用者名稱: Alice, 順序: 1)\n\n    TotalOrderBroadcast->>NodeA: 傳遞創建請求 (使用者名稱: Alice, 順序: 2)\n    TotalOrderBroadcast->>NodeB: 傳遞創建請求 (使用者名稱: Alice, 順序: 2)\n\n    Note over NodeA,NodeB: 節點根據全序廣播服務的順序處理請求\n\n    alt 順序1的請求成功，順序2的請求失敗\n        NodeA->>User1: 回應請求成功\n        NodeB->>User2: 回應請求失敗\n    else 順序2的請求成功，順序1的請求失敗\n        NodeA->>User1: 回應請求失敗\n        NodeB->>User2: 回應請求成功\n    end\n",[7478],{"type":22,"tag":431,"props":7479,"children":7480},{"__ignoreMap":13},[7481,7488,7495,7502,7509,7516,7524,7531,7538,7545,7552,7559,7566,7574,7582,7589,7597,7604,7612,7620,7627,7635,7643,7650,7658,7665,7673,7681,7689,7697,7705,7713],{"type":22,"tag":435,"props":7482,"children":7483},{"class":437,"line":438},[7484],{"type":22,"tag":435,"props":7485,"children":7486},{},[7487],{"type":28,"value":1732},{"type":22,"tag":435,"props":7489,"children":7490},{"class":437,"line":454},[7491],{"type":22,"tag":435,"props":7492,"children":7493},{},[7494],{"type":28,"value":6488},{"type":22,"tag":435,"props":7496,"children":7497},{"class":437,"line":463},[7498],{"type":22,"tag":435,"props":7499,"children":7500},{},[7501],{"type":28,"value":6496},{"type":22,"tag":435,"props":7503,"children":7504},{"class":437,"line":478},[7505],{"type":22,"tag":435,"props":7506,"children":7507},{},[7508],{"type":28,"value":5957},{"type":22,"tag":435,"props":7510,"children":7511},{"class":437,"line":499},[7512],{"type":22,"tag":435,"props":7513,"children":7514},{},[7515],{"type":28,"value":5965},{"type":22,"tag":435,"props":7517,"children":7518},{"class":437,"line":516},[7519],{"type":22,"tag":435,"props":7520,"children":7521},{},[7522],{"type":28,"value":7523},"    participant TotalOrderBroadcast as 全序廣播服務\n",{"type":22,"tag":435,"props":7525,"children":7526},{"class":437,"line":533},[7527],{"type":22,"tag":435,"props":7528,"children":7529},{"emptyLinePlaceholder":5},[7530],{"type":28,"value":460},{"type":22,"tag":435,"props":7532,"children":7533},{"class":437,"line":550},[7534],{"type":22,"tag":435,"props":7535,"children":7536},{},[7537],{"type":28,"value":6525},{"type":22,"tag":435,"props":7539,"children":7540},{"class":437,"line":559},[7541],{"type":22,"tag":435,"props":7542,"children":7543},{"emptyLinePlaceholder":5},[7544],{"type":28,"value":460},{"type":22,"tag":435,"props":7546,"children":7547},{"class":437,"line":567},[7548],{"type":22,"tag":435,"props":7549,"children":7550},{},[7551],{"type":28,"value":6540},{"type":22,"tag":435,"props":7553,"children":7554},{"class":437,"line":591},[7555],{"type":22,"tag":435,"props":7556,"children":7557},{},[7558],{"type":28,"value":6548},{"type":22,"tag":435,"props":7560,"children":7561},{"class":437,"line":606},[7562],{"type":22,"tag":435,"props":7563,"children":7564},{"emptyLinePlaceholder":5},[7565],{"type":28,"value":460},{"type":22,"tag":435,"props":7567,"children":7568},{"class":437,"line":615},[7569],{"type":22,"tag":435,"props":7570,"children":7571},{},[7572],{"type":28,"value":7573},"    NodeA->>TotalOrderBroadcast: 發送創建請求 (使用者名稱: Alice)\n",{"type":22,"tag":435,"props":7575,"children":7576},{"class":437,"line":636},[7577],{"type":22,"tag":435,"props":7578,"children":7579},{},[7580],{"type":28,"value":7581},"    NodeB->>TotalOrderBroadcast: 發送創建請求 (使用者名稱: Alice)\n",{"type":22,"tag":435,"props":7583,"children":7584},{"class":437,"line":650},[7585],{"type":22,"tag":435,"props":7586,"children":7587},{"emptyLinePlaceholder":5},[7588],{"type":28,"value":460},{"type":22,"tag":435,"props":7590,"children":7591},{"class":437,"line":678},[7592],{"type":22,"tag":435,"props":7593,"children":7594},{},[7595],{"type":28,"value":7596},"    Note over TotalOrderBroadcast: 全序廣播服務確保所有節點看到相同順序的消息\n",{"type":22,"tag":435,"props":7598,"children":7599},{"class":437,"line":686},[7600],{"type":22,"tag":435,"props":7601,"children":7602},{"emptyLinePlaceholder":5},[7603],{"type":28,"value":460},{"type":22,"tag":435,"props":7605,"children":7606},{"class":437,"line":694},[7607],{"type":22,"tag":435,"props":7608,"children":7609},{},[7610],{"type":28,"value":7611},"    TotalOrderBroadcast->>NodeA: 傳遞創建請求 (使用者名稱: Alice, 順序: 1)\n",{"type":22,"tag":435,"props":7613,"children":7614},{"class":437,"line":759},[7615],{"type":22,"tag":435,"props":7616,"children":7617},{},[7618],{"type":28,"value":7619},"    TotalOrderBroadcast->>NodeB: 傳遞創建請求 (使用者名稱: Alice, 順序: 1)\n",{"type":22,"tag":435,"props":7621,"children":7622},{"class":437,"line":783},[7623],{"type":22,"tag":435,"props":7624,"children":7625},{"emptyLinePlaceholder":5},[7626],{"type":28,"value":460},{"type":22,"tag":435,"props":7628,"children":7629},{"class":437,"line":837},[7630],{"type":22,"tag":435,"props":7631,"children":7632},{},[7633],{"type":28,"value":7634},"    TotalOrderBroadcast->>NodeA: 傳遞創建請求 (使用者名稱: Alice, 順序: 2)\n",{"type":22,"tag":435,"props":7636,"children":7637},{"class":437,"line":894},[7638],{"type":22,"tag":435,"props":7639,"children":7640},{},[7641],{"type":28,"value":7642},"    TotalOrderBroadcast->>NodeB: 傳遞創建請求 (使用者名稱: Alice, 順序: 2)\n",{"type":22,"tag":435,"props":7644,"children":7645},{"class":437,"line":971},[7646],{"type":22,"tag":435,"props":7647,"children":7648},{"emptyLinePlaceholder":5},[7649],{"type":28,"value":460},{"type":22,"tag":435,"props":7651,"children":7652},{"class":437,"line":980},[7653],{"type":22,"tag":435,"props":7654,"children":7655},{},[7656],{"type":28,"value":7657},"    Note over NodeA,NodeB: 節點根據全序廣播服務的順序處理請求\n",{"type":22,"tag":435,"props":7659,"children":7660},{"class":437,"line":988},[7661],{"type":22,"tag":435,"props":7662,"children":7663},{"emptyLinePlaceholder":5},[7664],{"type":28,"value":460},{"type":22,"tag":435,"props":7666,"children":7667},{"class":437,"line":996},[7668],{"type":22,"tag":435,"props":7669,"children":7670},{},[7671],{"type":28,"value":7672},"    alt 順序1的請求成功，順序2的請求失敗\n",{"type":22,"tag":435,"props":7674,"children":7675},{"class":437,"line":1064},[7676],{"type":22,"tag":435,"props":7677,"children":7678},{},[7679],{"type":28,"value":7680},"        NodeA->>User1: 回應請求成功\n",{"type":22,"tag":435,"props":7682,"children":7683},{"class":437,"line":1084},[7684],{"type":22,"tag":435,"props":7685,"children":7686},{},[7687],{"type":28,"value":7688},"        NodeB->>User2: 回應請求失敗\n",{"type":22,"tag":435,"props":7690,"children":7691},{"class":437,"line":1133},[7692],{"type":22,"tag":435,"props":7693,"children":7694},{},[7695],{"type":28,"value":7696},"    else 順序2的請求成功，順序1的請求失敗\n",{"type":22,"tag":435,"props":7698,"children":7699},{"class":437,"line":1152},[7700],{"type":22,"tag":435,"props":7701,"children":7702},{},[7703],{"type":28,"value":7704},"        NodeA->>User1: 回應請求失敗\n",{"type":22,"tag":435,"props":7706,"children":7707},{"class":437,"line":1160},[7708],{"type":22,"tag":435,"props":7709,"children":7710},{},[7711],{"type":28,"value":7712},"        NodeB->>User2: 回應請求成功\n",{"type":22,"tag":435,"props":7714,"children":7715},{"class":437,"line":1168},[7716],{"type":22,"tag":435,"props":7717,"children":7718},{},[7719],{"type":28,"value":6687},{"type":22,"tag":30,"props":7721,"children":7723},{"id":7722},"_94-分散式事務與共識",[7724],{"type":28,"value":7725},"9.4 分散式事務與共識",{"type":22,"tag":137,"props":7727,"children":7728},{},[7729],{"type":28,"value":300},{"type":22,"tag":137,"props":7731,"children":7732},{},[7733],{"type":28,"value":7734},"共識：目標是讓幾個節點達成一致",{"type":22,"tag":137,"props":7736,"children":7737},{},[7738],{"type":28,"value":7739},"領導選舉：",{"type":22,"tag":137,"props":7741,"children":7742},{},[7743],{"type":28,"value":7744},"單主複製的資料庫中所有節點需要與某個領導者達成一致，如果一些節點由於網路而故障可能會對領導權歸屬引起爭議。所以共識對於避免錯誤的故障切換至關重要，錯誤的切換會導致兩個節點都認為自己是領導者(腦裂現象)。",{"type":22,"tag":137,"props":7746,"children":7747},{},[7748],{"type":28,"value":7749},"原子提交：",{"type":22,"tag":137,"props":7751,"children":7752},{},[7753],{"type":28,"value":7754},"在多節點或多分割槽的資料庫中，為保持事務的原子性（全部提交或全部回滾），所有節點需對事務結果達成共識，此問題稱為原子提交。原子提交與共識稍有區別但可相互簡化，非阻塞的原子提交比共識更為困難。",{"type":22,"tag":30,"props":7756,"children":7758},{"id":7757},"共識的不可能性",[7759],{"type":28,"value":7757},{"type":22,"tag":137,"props":7761,"children":7762},{},[7763],{"type":28,"value":300},{"type":22,"tag":137,"props":7765,"children":7766},{},[7767],{"type":28,"value":7768},"FLP結果指出，在有節點可能崩潰風險的情況下，無法總是達成共識。這個結果是基於非同步系統模型。然而，若演算法能使用超時或其他方法來識別可能崩潰的節點，或者利用隨機數，共識成為可能。儘管FLP展示了理論上的限制，但現實中的分散式系統通常能達成共識。在探討原子提交問題時，兩階段提交（2PC）演算法常被用來解決，它是一種共識演算法，但不是最佳的。通過學習2PC，可以進一步探索更好的一致性演算法，如ZooKeeper的Zab和etcd的Raft。",{"type":22,"tag":30,"props":7770,"children":7772},{"id":7771},"原子提交與兩階段提交",[7773],{"type":28,"value":7771},{"type":22,"tag":137,"props":7775,"children":7776},{},[7777],{"type":28,"value":300},{"type":22,"tag":137,"props":7779,"children":7780},{},[7781],{"type":28,"value":7782},"原子性：",{"type":22,"tag":137,"props":7784,"children":7785},{},[7786],{"type":28,"value":7787},"事務的方式通常都是用撤銷或丟棄的方式來解決衝突，原子性可以防止失敗的事物攪亂資料庫，避免了資料庫陷入半成品結果與半更新。",{"type":22,"tag":137,"props":7789,"children":7790},{},[7791],{"type":28,"value":7792},"這對多物件事務和維護次級索引的資料庫非常重要，每個次級索引都是與主資料分離的資料結構，因此如果修改了一些資料，則還需要在次級索引中進行相應的更改。",{"type":22,"tag":137,"props":7794,"children":7795},{},[7796],{"type":28,"value":7797},"原子性可以確保次級索引與主資料庫保持一致。",{"type":22,"tag":418,"props":7799,"children":7801},{"id":7800},"從單節點到分散式原子提交",[7802],{"type":28,"value":7800},{"type":22,"tag":137,"props":7804,"children":7805},{},[7806],{"type":28,"value":300},{"type":22,"tag":137,"props":7808,"children":7809},{},[7810],{"type":28,"value":7811},"在單個數據庫節點執行的事務，原子性通常由儲存引擎實現。",{"type":22,"tag":137,"props":7813,"children":7814},{},[7815,7817,7827],{"type":28,"value":7816},"當客戶端請求資料庫節點提交事務時，資料庫將使事務的寫入持久化（通常在預寫式日誌中，請參閱 “",{"type":22,"tag":51,"props":7818,"children":7819},{},[7820],{"type":22,"tag":55,"props":7821,"children":7824},{"href":7822,"rel":7823},"https://vonng.github.io/ddia/#/zh-tw/ch3?id=%e8%ae%93b%e6%a8%b9%e6%9b%b4%e5%8f%af%e9%9d%a0",[59],[7825],{"type":28,"value":7826},"讓 B 樹更可靠",{"type":28,"value":7828},"”），然後將提交記錄追加到磁碟中的日誌裡。如果資料庫在這個過程中間崩潰，當節點重啟時，事務會從日誌中恢復：如果提交記錄在崩潰之前成功地寫入磁碟，則認為事務被提交；否則來自該事務的任何寫入都被回滾。",{"type":22,"tag":424,"props":7830,"children":7832},{"className":1718,"code":7831,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Client as 客戶端\n    participant Database as 資料庫節點\n    participant WAL as 預寫式日誌\n    participant Disk as 磁碟\n\n    Client->>Database: 提交事務請求\n    Database->>WAL: 寫入事務資料\n    WAL-->>Database: 確認寫入\n    Database->>Disk: 將提交記錄追加到日誌\n    Disk-->>Database: 確認寫入\n    Database-->>Client: 提交成功\n\n    alt 崩潰然後重啟\n        Database->>Disk: 檢查日誌\n        alt 提交記錄已寫入\n            Disk-->>Database: 事務已提交\n        else 提交記錄未寫入\n            Disk-->>Database: 回滾事務\n        end\n    end\n",[7833],{"type":22,"tag":431,"props":7834,"children":7835},{"__ignoreMap":13},[7836,7843,7851,7859,7867,7875,7882,7890,7898,7906,7914,7922,7930,7937,7945,7953,7961,7969,7977,7985,7993],{"type":22,"tag":435,"props":7837,"children":7838},{"class":437,"line":438},[7839],{"type":22,"tag":435,"props":7840,"children":7841},{},[7842],{"type":28,"value":1732},{"type":22,"tag":435,"props":7844,"children":7845},{"class":437,"line":454},[7846],{"type":22,"tag":435,"props":7847,"children":7848},{},[7849],{"type":28,"value":7850},"    participant Client as 客戶端\n",{"type":22,"tag":435,"props":7852,"children":7853},{"class":437,"line":463},[7854],{"type":22,"tag":435,"props":7855,"children":7856},{},[7857],{"type":28,"value":7858},"    participant Database as 資料庫節點\n",{"type":22,"tag":435,"props":7860,"children":7861},{"class":437,"line":478},[7862],{"type":22,"tag":435,"props":7863,"children":7864},{},[7865],{"type":28,"value":7866},"    participant WAL as 預寫式日誌\n",{"type":22,"tag":435,"props":7868,"children":7869},{"class":437,"line":499},[7870],{"type":22,"tag":435,"props":7871,"children":7872},{},[7873],{"type":28,"value":7874},"    participant Disk as 磁碟\n",{"type":22,"tag":435,"props":7876,"children":7877},{"class":437,"line":516},[7878],{"type":22,"tag":435,"props":7879,"children":7880},{"emptyLinePlaceholder":5},[7881],{"type":28,"value":460},{"type":22,"tag":435,"props":7883,"children":7884},{"class":437,"line":533},[7885],{"type":22,"tag":435,"props":7886,"children":7887},{},[7888],{"type":28,"value":7889},"    Client->>Database: 提交事務請求\n",{"type":22,"tag":435,"props":7891,"children":7892},{"class":437,"line":550},[7893],{"type":22,"tag":435,"props":7894,"children":7895},{},[7896],{"type":28,"value":7897},"    Database->>WAL: 寫入事務資料\n",{"type":22,"tag":435,"props":7899,"children":7900},{"class":437,"line":559},[7901],{"type":22,"tag":435,"props":7902,"children":7903},{},[7904],{"type":28,"value":7905},"    WAL-->>Database: 確認寫入\n",{"type":22,"tag":435,"props":7907,"children":7908},{"class":437,"line":567},[7909],{"type":22,"tag":435,"props":7910,"children":7911},{},[7912],{"type":28,"value":7913},"    Database->>Disk: 將提交記錄追加到日誌\n",{"type":22,"tag":435,"props":7915,"children":7916},{"class":437,"line":591},[7917],{"type":22,"tag":435,"props":7918,"children":7919},{},[7920],{"type":28,"value":7921},"    Disk-->>Database: 確認寫入\n",{"type":22,"tag":435,"props":7923,"children":7924},{"class":437,"line":606},[7925],{"type":22,"tag":435,"props":7926,"children":7927},{},[7928],{"type":28,"value":7929},"    Database-->>Client: 提交成功\n",{"type":22,"tag":435,"props":7931,"children":7932},{"class":437,"line":615},[7933],{"type":22,"tag":435,"props":7934,"children":7935},{"emptyLinePlaceholder":5},[7936],{"type":28,"value":460},{"type":22,"tag":435,"props":7938,"children":7939},{"class":437,"line":636},[7940],{"type":22,"tag":435,"props":7941,"children":7942},{},[7943],{"type":28,"value":7944},"    alt 崩潰然後重啟\n",{"type":22,"tag":435,"props":7946,"children":7947},{"class":437,"line":650},[7948],{"type":22,"tag":435,"props":7949,"children":7950},{},[7951],{"type":28,"value":7952},"        Database->>Disk: 檢查日誌\n",{"type":22,"tag":435,"props":7954,"children":7955},{"class":437,"line":678},[7956],{"type":22,"tag":435,"props":7957,"children":7958},{},[7959],{"type":28,"value":7960},"        alt 提交記錄已寫入\n",{"type":22,"tag":435,"props":7962,"children":7963},{"class":437,"line":686},[7964],{"type":22,"tag":435,"props":7965,"children":7966},{},[7967],{"type":28,"value":7968},"            Disk-->>Database: 事務已提交\n",{"type":22,"tag":435,"props":7970,"children":7971},{"class":437,"line":694},[7972],{"type":22,"tag":435,"props":7973,"children":7974},{},[7975],{"type":28,"value":7976},"        else 提交記錄未寫入\n",{"type":22,"tag":435,"props":7978,"children":7979},{"class":437,"line":759},[7980],{"type":22,"tag":435,"props":7981,"children":7982},{},[7983],{"type":28,"value":7984},"            Disk-->>Database: 回滾事務\n",{"type":22,"tag":435,"props":7986,"children":7987},{"class":437,"line":783},[7988],{"type":22,"tag":435,"props":7989,"children":7990},{},[7991],{"type":28,"value":7992},"        end\n",{"type":22,"tag":435,"props":7994,"children":7995},{"class":437,"line":837},[7996],{"type":22,"tag":435,"props":7997,"children":7998},{},[7999],{"type":28,"value":6687},{"type":22,"tag":137,"props":8001,"children":8002},{},[8003],{"type":28,"value":8004},"單節點：",{"type":22,"tag":137,"props":8006,"children":8007},{},[8008,8010,8015],{"type":28,"value":8009},"事務的提交主要取決於資料持久化落盤的 ",{"type":22,"tag":51,"props":8011,"children":8012},{},[8013],{"type":28,"value":8014},"順序",{"type":28,"value":8016},"：首先是資料，然後是提交記錄。事務提交或終止的關鍵決定時刻是磁碟完成寫入提交記錄的時刻：在此之前，仍有可能中止（由於崩潰），但在此之後，事務已經提交（即使資料庫崩潰）。因此，是單一的裝置（連線到單個磁碟的控制器，且掛載在單臺機器上）使得提交具有原子性。",{"type":22,"tag":137,"props":8018,"children":8019},{},[8020],{"type":28,"value":8021},"多節點：",{"type":22,"tag":137,"props":8023,"children":8024},{},[8025],{"type":28,"value":8026},"僅向所有節點發送提交請求並獨立提交每個節點的事務是不夠的。這樣很容易發生違反原子性的情況：提交在某些節點上成功，而在其他節點上失敗：",{"type":22,"tag":41,"props":8028,"children":8029},{},[8030,8035,8040],{"type":22,"tag":45,"props":8031,"children":8032},{},[8033],{"type":28,"value":8034},"某些節點可能會檢測到違反約束或衝突，因此需要中止，而其他節點則可以成功進行提交。假設某個節點已經有某個唯一鍵所以被迫停止某些節點因為沒有違反則成功",{"type":22,"tag":45,"props":8036,"children":8037},{},[8038],{"type":28,"value":8039},"某些提交請求可能在網路中丟失，最終由於超時而中止，而其他提交請求則通過。順序會有問題",{"type":22,"tag":45,"props":8041,"children":8042},{},[8043],{"type":28,"value":8044},"在提交記錄完全寫入之前，某些節點可能會崩潰，並在恢復時回滾，而其他節點則成功提交。",{"type":22,"tag":137,"props":8046,"children":8047},{},[8048],{"type":28,"value":8049},"如果某些節點提交了事務，但其他節點卻放棄了這些事務，那麼這些節點就會彼此不一致。而且一旦在某個節點上提交了一個事務，如果事後發現它在其它節點上被中止了，它是無法撤回的。出於這個原因，一旦確定事務中的所有其他節點也將提交，節點就必須進行提交。",{"type":22,"tag":424,"props":8051,"children":8053},{"className":1718,"code":8052,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant 節點1\n    participant 節點2\n    participant 節點3\n\n    節點1->>節點2: 嘗試提交事務\n    節點1->>節點3: 嘗試提交事務\n    Note right of 節點3: 事務已提交\n    節點2->>節點1: 放棄事務\n    Note right of 節點1: 事務已放棄\n    Note left of 節點2: 節點間存在不一致狀態\n",[8054],{"type":22,"tag":431,"props":8055,"children":8056},{"__ignoreMap":13},[8057,8064,8072,8080,8088,8095,8103,8111,8119,8127,8135],{"type":22,"tag":435,"props":8058,"children":8059},{"class":437,"line":438},[8060],{"type":22,"tag":435,"props":8061,"children":8062},{},[8063],{"type":28,"value":1732},{"type":22,"tag":435,"props":8065,"children":8066},{"class":437,"line":454},[8067],{"type":22,"tag":435,"props":8068,"children":8069},{},[8070],{"type":28,"value":8071},"    participant 節點1\n",{"type":22,"tag":435,"props":8073,"children":8074},{"class":437,"line":463},[8075],{"type":22,"tag":435,"props":8076,"children":8077},{},[8078],{"type":28,"value":8079},"    participant 節點2\n",{"type":22,"tag":435,"props":8081,"children":8082},{"class":437,"line":478},[8083],{"type":22,"tag":435,"props":8084,"children":8085},{},[8086],{"type":28,"value":8087},"    participant 節點3\n",{"type":22,"tag":435,"props":8089,"children":8090},{"class":437,"line":499},[8091],{"type":22,"tag":435,"props":8092,"children":8093},{"emptyLinePlaceholder":5},[8094],{"type":28,"value":460},{"type":22,"tag":435,"props":8096,"children":8097},{"class":437,"line":516},[8098],{"type":22,"tag":435,"props":8099,"children":8100},{},[8101],{"type":28,"value":8102},"    節點1->>節點2: 嘗試提交事務\n",{"type":22,"tag":435,"props":8104,"children":8105},{"class":437,"line":533},[8106],{"type":22,"tag":435,"props":8107,"children":8108},{},[8109],{"type":28,"value":8110},"    節點1->>節點3: 嘗試提交事務\n",{"type":22,"tag":435,"props":8112,"children":8113},{"class":437,"line":550},[8114],{"type":22,"tag":435,"props":8115,"children":8116},{},[8117],{"type":28,"value":8118},"    Note right of 節點3: 事務已提交\n",{"type":22,"tag":435,"props":8120,"children":8121},{"class":437,"line":559},[8122],{"type":22,"tag":435,"props":8123,"children":8124},{},[8125],{"type":28,"value":8126},"    節點2->>節點1: 放棄事務\n",{"type":22,"tag":435,"props":8128,"children":8129},{"class":437,"line":567},[8130],{"type":22,"tag":435,"props":8131,"children":8132},{},[8133],{"type":28,"value":8134},"    Note right of 節點1: 事務已放棄\n",{"type":22,"tag":435,"props":8136,"children":8137},{"class":437,"line":591},[8138],{"type":22,"tag":435,"props":8139,"children":8140},{},[8141],{"type":28,"value":8142},"    Note left of 節點2: 節點間存在不一致狀態\n",{"type":22,"tag":137,"props":8144,"children":8145},{},[8146,8148,8153,8155,8164,8166,8171],{"type":28,"value":8147},"事務提交必須是不可撤銷的 ，事務提交之後，不能改變主意，並追溯性地中止事務。這個規則的原因是，一旦資料被提交，其結果就對其他事務可見，因此其他客戶端可能會開始依賴這些資料。這個原則構成了 ",{"type":22,"tag":51,"props":8149,"children":8150},{},[8151],{"type":28,"value":8152},"讀已提交",{"type":28,"value":8154}," 隔離等級的基礎，在 “",{"type":22,"tag":51,"props":8156,"children":8157},{},[8158],{"type":22,"tag":55,"props":8159,"children":8162},{"href":8160,"rel":8161},"https://vonng.github.io/ddia/#/zh-tw/ch7?id=%e8%ae%80%e5%b7%b2%e6%8f%90%e4%ba%a4",[59],[8163],{"type":28,"value":8152},{"type":28,"value":8165},"” 一節中討論了這個問題。如果一個事務在提交後被允許中止，所有那些讀取了 ",{"type":22,"tag":51,"props":8167,"children":8168},{},[8169],{"type":28,"value":8170},"已提交卻又被追溯宣告不存在資料",{"type":28,"value":8172}," 的事務也必須回滾。",{"type":22,"tag":424,"props":8174,"children":8176},{"className":1718,"code":8175,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant 節點\n    participant 客戶端1\n    participant 客戶端2\n\n    客戶端1->>節點: 提交事務\n    Note right of 節點: 事務已提交\n    節點->>客戶端2: 通知已提交事務\n    客戶端2->>節點: 讀取已提交數據\n    Note right of 節點: 事務被撤銷（不允許）\n    節點->>客戶端1: 通知事務被撤銷（錯誤）\n    節點->>客戶端2: 通知事務被撤銷（錯誤）\n",[8177],{"type":22,"tag":431,"props":8178,"children":8179},{"__ignoreMap":13},[8180,8187,8195,8203,8211,8218,8226,8234,8242,8250,8258,8266],{"type":22,"tag":435,"props":8181,"children":8182},{"class":437,"line":438},[8183],{"type":22,"tag":435,"props":8184,"children":8185},{},[8186],{"type":28,"value":1732},{"type":22,"tag":435,"props":8188,"children":8189},{"class":437,"line":454},[8190],{"type":22,"tag":435,"props":8191,"children":8192},{},[8193],{"type":28,"value":8194},"    participant 節點\n",{"type":22,"tag":435,"props":8196,"children":8197},{"class":437,"line":463},[8198],{"type":22,"tag":435,"props":8199,"children":8200},{},[8201],{"type":28,"value":8202},"    participant 客戶端1\n",{"type":22,"tag":435,"props":8204,"children":8205},{"class":437,"line":478},[8206],{"type":22,"tag":435,"props":8207,"children":8208},{},[8209],{"type":28,"value":8210},"    participant 客戶端2\n",{"type":22,"tag":435,"props":8212,"children":8213},{"class":437,"line":499},[8214],{"type":22,"tag":435,"props":8215,"children":8216},{"emptyLinePlaceholder":5},[8217],{"type":28,"value":460},{"type":22,"tag":435,"props":8219,"children":8220},{"class":437,"line":516},[8221],{"type":22,"tag":435,"props":8222,"children":8223},{},[8224],{"type":28,"value":8225},"    客戶端1->>節點: 提交事務\n",{"type":22,"tag":435,"props":8227,"children":8228},{"class":437,"line":533},[8229],{"type":22,"tag":435,"props":8230,"children":8231},{},[8232],{"type":28,"value":8233},"    Note right of 節點: 事務已提交\n",{"type":22,"tag":435,"props":8235,"children":8236},{"class":437,"line":550},[8237],{"type":22,"tag":435,"props":8238,"children":8239},{},[8240],{"type":28,"value":8241},"    節點->>客戶端2: 通知已提交事務\n",{"type":22,"tag":435,"props":8243,"children":8244},{"class":437,"line":559},[8245],{"type":22,"tag":435,"props":8246,"children":8247},{},[8248],{"type":28,"value":8249},"    客戶端2->>節點: 讀取已提交數據\n",{"type":22,"tag":435,"props":8251,"children":8252},{"class":437,"line":567},[8253],{"type":22,"tag":435,"props":8254,"children":8255},{},[8256],{"type":28,"value":8257},"    Note right of 節點: 事務被撤銷（不允許）\n",{"type":22,"tag":435,"props":8259,"children":8260},{"class":437,"line":591},[8261],{"type":22,"tag":435,"props":8262,"children":8263},{},[8264],{"type":28,"value":8265},"    節點->>客戶端1: 通知事務被撤銷（錯誤）\n",{"type":22,"tag":435,"props":8267,"children":8268},{"class":437,"line":606},[8269],{"type":22,"tag":435,"props":8270,"children":8271},{},[8272],{"type":28,"value":8273},"    節點->>客戶端2: 通知事務被撤銷（錯誤）\n",{"type":22,"tag":137,"props":8275,"children":8276},{},[8277],{"type":28,"value":8278},"雖然還是有辦法在事務事後執行一個補償機制來取消，但從資料庫的角度，跨事務正確性的保證都必須要是應用自己處理。",{"type":22,"tag":30,"props":8280,"children":8282},{"id":8281},"兩階段提交簡介",[8283],{"type":28,"value":8281},{"type":22,"tag":137,"props":8285,"children":8286},{},[8287],{"type":28,"value":300},{"type":22,"tag":137,"props":8289,"children":8290},{},[8291,8296,8298,8303,8305,8311],{"type":22,"tag":51,"props":8292,"children":8293},{},[8294],{"type":28,"value":8295},"兩階段提交（two-phase commit）",{"type":28,"value":8297}," 是一種用於實現跨多個節點的原子事務提交的演算法，即確保所有節點提交或所有節點中止。它是分散式資料庫中的經典演算法。2PC 在某些資料庫內部使用，也以 ",{"type":22,"tag":51,"props":8299,"children":8300},{},[8301],{"type":28,"value":8302},"XA 事務",{"type":28,"value":8304}," 的形式對應用可用（例如 Java Transaction API 支援）或以 SOAP Web 服務的 ",{"type":22,"tag":431,"props":8306,"children":8308},{"className":8307},[],[8309],{"type":28,"value":8310},"WS-AtomicTransaction",{"type":28,"value":8312}," 形式提供給應用。",{"type":22,"tag":137,"props":8314,"children":8315},{},[8316],{"type":22,"tag":341,"props":8317,"children":8320},{"alt":8318,"src":8319},"說明了 2PC 的基本流程。2PC 中的提交 / 中止過程分為兩個階段（因此而得名），而不是單節點事務中的單個提交請求。","https://vonng.github.io/ddia/img/fig9-9.png",[],{"type":22,"tag":137,"props":8322,"children":8323},{},[8324],{"type":28,"value":8318},{"type":22,"tag":137,"props":8326,"children":8327},{},[8328],{"type":28,"value":8329},"使用者經過協調者進行通訊，而協調者會進行兩個步驟",{"type":22,"tag":137,"props":8331,"children":8332},{},[8333],{"type":28,"value":8334},"1.先跟節點溝通說要寫入資料",{"type":22,"tag":137,"props":8336,"children":8337},{},[8338],{"type":28,"value":8339},"2.問各節點準備好了?",{"type":22,"tag":137,"props":8341,"children":8342},{},[8343],{"type":28,"value":8344},"3.認後提交",{"type":22,"tag":137,"props":8346,"children":8347},{},[8348],{"type":28,"value":8349},"協調者(事務管理器):",{"type":22,"tag":137,"props":8351,"children":8352},{},[8353],{"type":28,"value":8354},"1.通常會在多節點事務出現",{"type":22,"tag":137,"props":8356,"children":8357},{},[8358],{"type":28,"value":8359},"2.通常以庫的方式實現(Java EE)，也可以像是程式或是服務的方式Narayana、JOTM、BTM 或 MSDTC。",{"type":22,"tag":137,"props":8361,"children":8362},{},[8363],{"type":28,"value":8364},"參與者:",{"type":22,"tag":137,"props":8366,"children":8367},{},[8368],{"type":28,"value":8369},"1.資料庫節點在於2PC通常會稱為餐與者",{"type":22,"tag":137,"props":8371,"children":8372},{},[8373],{"type":28,"value":8374},"比喻:",{"type":22,"tag":137,"props":8376,"children":8377},{},[8378],{"type":28,"value":8379},"西方傳統結婚儀式",{"type":22,"tag":137,"props":8381,"children":8382},{},[8383],{"type":28,"value":8384},"1.牧師先問雙方是否要結婚(雙方是否都在)",{"type":22,"tag":137,"props":8386,"children":8387},{},[8388],{"type":28,"value":8389},"2.雙方回復”我願意”",{"type":22,"tag":137,"props":8391,"children":8392},{},[8393],{"type":28,"value":8394},"3.牧師宣布正式成為夫妻",{"type":22,"tag":30,"props":8396,"children":8398},{"id":8397},"系統承諾",[8399],{"type":28,"value":8397},{"type":22,"tag":137,"props":8401,"children":8402},{},[8403],{"type":28,"value":8404},"2PC之所以可以保證原子性解說:",{"type":22,"tag":4383,"props":8406,"children":8407},{},[8408,8413,8418,8430,8435,8447],{"type":22,"tag":45,"props":8409,"children":8410},{},[8411],{"type":28,"value":8412},"當應用想要啟動一個分散式事務時，它向協調者請求一個事務 ID。此事務 ID 是全域性唯一的。",{"type":22,"tag":45,"props":8414,"children":8415},{},[8416],{"type":28,"value":8417},"應用在每個參與者上啟動單節點事務，並在單節點事務上捎帶上這個全域性事務 ID。所有的讀寫都是在這些單節點事務中各自完成的。如果在這個階段出現任何問題（例如，節點崩潰或請求超時），則協調者或任何參與者都可以中止。",{"type":22,"tag":45,"props":8419,"children":8420},{},[8421,8423,8428],{"type":28,"value":8422},"當應用準備提交時，協調者向所有參與者傳送一個 ",{"type":22,"tag":51,"props":8424,"children":8425},{},[8426],{"type":28,"value":8427},"準備",{"type":28,"value":8429}," 請求，並打上全域性事務 ID 的標記。如果任意一個請求失敗或超時，則協調者向所有參與者傳送針對該事務 ID 的中止請求。",{"type":22,"tag":45,"props":8431,"children":8432},{},[8433],{"type":28,"value":8434},"參與者收到準備請求時，需要確保在任意情況下都的確可以提交事務。這包括將所有事務資料寫入磁碟（出現崩潰、電源故障或硬碟空間不足都不能是稍後拒絕提交的理由）以及檢查是否存在任何衝突或違反約束。透過向協調者回答 “是”，節點承諾，只要請求，這個事務一定可以不出差錯地提交。換句話說，參與者放棄了中止事務的權利，但沒有實際提交。",{"type":22,"tag":45,"props":8436,"children":8437},{},[8438,8440,8445],{"type":28,"value":8439},"當協調者收到所有準備請求的答覆時，會就提交或中止事務作出明確的決定（只有在所有參與者投贊成票的情況下才會提交）。協調者必須把這個決定寫到磁碟上的事務日誌中，如果它隨後就崩潰，恢復後也能知道自己所做的決定。這被稱為 ",{"type":22,"tag":51,"props":8441,"children":8442},{},[8443],{"type":28,"value":8444},"提交點（commit point）",{"type":28,"value":8446},"。",{"type":22,"tag":45,"props":8448,"children":8449},{},[8450],{"type":28,"value":8451},"一旦協調者的決定落盤，提交或中止請求會發送給所有參與者。如果這個請求失敗或超時，協調者必須永遠保持重試，直到成功為止。沒有回頭路：如果已經做出決定，不管需要多少次重試它都必須被執行。如果參與者在此期間崩潰，事務將在其恢復後提交 —— 由於參與者投了贊成，因此恢復後它不能拒絕提交。",{"type":22,"tag":424,"props":8453,"children":8455},{"className":1718,"code":8454,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant App as 應用\n    participant Coordinator as 協調者\n    participant Node1 as 參與者1\n    participant Node2 as 參與者2\n    App->>Coordinator: 請求事務ID\n    Coordinator->>App: 返回事務ID\n    App->>Node1: 啟動單節點事務(事務ID)\n    App->>Node2: 啟動單節點事務(事務ID)\n    Note over Node1,Node2: 執行事務中...\n    App->>Coordinator: 準備提交\n    Coordinator->>Node1: 準備請求(事務ID)\n    Coordinator->>Node2: 準備請求(事務ID)\n    Node1->>Coordinator: 是\n    Node2->>Coordinator: 是\n    Note over Coordinator: 所有參與者都已準備好\n    Coordinator->>Coordinator: 決定提交並記錄到事務日誌\n    Coordinator->>Node1: 提交請求(事務ID)\n    Coordinator->>Node2: 提交請求(事務ID)\n    Node1->>Coordinator: 提交成功\n    Node2->>Coordinator: 提交成功\n",[8456],{"type":22,"tag":431,"props":8457,"children":8458},{"__ignoreMap":13},[8459,8466,8474,8482,8490,8498,8506,8514,8522,8530,8538,8546,8554,8562,8570,8578,8586,8594,8602,8610,8618],{"type":22,"tag":435,"props":8460,"children":8461},{"class":437,"line":438},[8462],{"type":22,"tag":435,"props":8463,"children":8464},{},[8465],{"type":28,"value":1732},{"type":22,"tag":435,"props":8467,"children":8468},{"class":437,"line":454},[8469],{"type":22,"tag":435,"props":8470,"children":8471},{},[8472],{"type":28,"value":8473},"    participant App as 應用\n",{"type":22,"tag":435,"props":8475,"children":8476},{"class":437,"line":463},[8477],{"type":22,"tag":435,"props":8478,"children":8479},{},[8480],{"type":28,"value":8481},"    participant Coordinator as 協調者\n",{"type":22,"tag":435,"props":8483,"children":8484},{"class":437,"line":478},[8485],{"type":22,"tag":435,"props":8486,"children":8487},{},[8488],{"type":28,"value":8489},"    participant Node1 as 參與者1\n",{"type":22,"tag":435,"props":8491,"children":8492},{"class":437,"line":499},[8493],{"type":22,"tag":435,"props":8494,"children":8495},{},[8496],{"type":28,"value":8497},"    participant Node2 as 參與者2\n",{"type":22,"tag":435,"props":8499,"children":8500},{"class":437,"line":516},[8501],{"type":22,"tag":435,"props":8502,"children":8503},{},[8504],{"type":28,"value":8505},"    App->>Coordinator: 請求事務ID\n",{"type":22,"tag":435,"props":8507,"children":8508},{"class":437,"line":533},[8509],{"type":22,"tag":435,"props":8510,"children":8511},{},[8512],{"type":28,"value":8513},"    Coordinator->>App: 返回事務ID\n",{"type":22,"tag":435,"props":8515,"children":8516},{"class":437,"line":550},[8517],{"type":22,"tag":435,"props":8518,"children":8519},{},[8520],{"type":28,"value":8521},"    App->>Node1: 啟動單節點事務(事務ID)\n",{"type":22,"tag":435,"props":8523,"children":8524},{"class":437,"line":559},[8525],{"type":22,"tag":435,"props":8526,"children":8527},{},[8528],{"type":28,"value":8529},"    App->>Node2: 啟動單節點事務(事務ID)\n",{"type":22,"tag":435,"props":8531,"children":8532},{"class":437,"line":567},[8533],{"type":22,"tag":435,"props":8534,"children":8535},{},[8536],{"type":28,"value":8537},"    Note over Node1,Node2: 執行事務中...\n",{"type":22,"tag":435,"props":8539,"children":8540},{"class":437,"line":591},[8541],{"type":22,"tag":435,"props":8542,"children":8543},{},[8544],{"type":28,"value":8545},"    App->>Coordinator: 準備提交\n",{"type":22,"tag":435,"props":8547,"children":8548},{"class":437,"line":606},[8549],{"type":22,"tag":435,"props":8550,"children":8551},{},[8552],{"type":28,"value":8553},"    Coordinator->>Node1: 準備請求(事務ID)\n",{"type":22,"tag":435,"props":8555,"children":8556},{"class":437,"line":615},[8557],{"type":22,"tag":435,"props":8558,"children":8559},{},[8560],{"type":28,"value":8561},"    Coordinator->>Node2: 準備請求(事務ID)\n",{"type":22,"tag":435,"props":8563,"children":8564},{"class":437,"line":636},[8565],{"type":22,"tag":435,"props":8566,"children":8567},{},[8568],{"type":28,"value":8569},"    Node1->>Coordinator: 是\n",{"type":22,"tag":435,"props":8571,"children":8572},{"class":437,"line":650},[8573],{"type":22,"tag":435,"props":8574,"children":8575},{},[8576],{"type":28,"value":8577},"    Node2->>Coordinator: 是\n",{"type":22,"tag":435,"props":8579,"children":8580},{"class":437,"line":678},[8581],{"type":22,"tag":435,"props":8582,"children":8583},{},[8584],{"type":28,"value":8585},"    Note over Coordinator: 所有參與者都已準備好\n",{"type":22,"tag":435,"props":8587,"children":8588},{"class":437,"line":686},[8589],{"type":22,"tag":435,"props":8590,"children":8591},{},[8592],{"type":28,"value":8593},"    Coordinator->>Coordinator: 決定提交並記錄到事務日誌\n",{"type":22,"tag":435,"props":8595,"children":8596},{"class":437,"line":694},[8597],{"type":22,"tag":435,"props":8598,"children":8599},{},[8600],{"type":28,"value":8601},"    Coordinator->>Node1: 提交請求(事務ID)\n",{"type":22,"tag":435,"props":8603,"children":8604},{"class":437,"line":759},[8605],{"type":22,"tag":435,"props":8606,"children":8607},{},[8608],{"type":28,"value":8609},"    Coordinator->>Node2: 提交請求(事務ID)\n",{"type":22,"tag":435,"props":8611,"children":8612},{"class":437,"line":783},[8613],{"type":22,"tag":435,"props":8614,"children":8615},{},[8616],{"type":28,"value":8617},"    Node1->>Coordinator: 提交成功\n",{"type":22,"tag":435,"props":8619,"children":8620},{"class":437,"line":837},[8621],{"type":22,"tag":435,"props":8622,"children":8623},{},[8624],{"type":28,"value":8625},"    Node2->>Coordinator: 提交成功\n",{"type":22,"tag":137,"props":8627,"children":8628},{},[8629],{"type":28,"value":8630},"結論:",{"type":22,"tag":137,"props":8632,"children":8633},{},[8634],{"type":28,"value":8635},"2PC可以保證原子性的原因是”協調者追蹤決定並使其不可撤銷”",{"type":22,"tag":137,"props":8637,"children":8638},{},[8639],{"type":28,"value":8374},{"type":22,"tag":137,"props":8641,"children":8642},{},[8643],{"type":28,"value":8644},"回到西方結婚儀式",{"type":22,"tag":137,"props":8646,"children":8647},{},[8648],{"type":28,"value":8649},"1.牧師再問雙方是否要結婚(只要其中一放放棄牧師就不可能會繼續事務)",{"type":22,"tag":137,"props":8651,"children":8652},{},[8653],{"type":28,"value":8654},"2.其中有一個人昏倒(沒有聽到\"正式宣布成為夫妻”)因為說出我願意了所以還是有效",{"type":22,"tag":137,"props":8656,"children":8657},{},[8658],{"type":28,"value":8659},"3.當昏倒的那個人醒來，可以透過查詢牧師的預約日誌查詢是否結婚成功",{"type":22,"tag":30,"props":8661,"children":8663},{"id":8662},"協調者失效",[8664],{"type":28,"value":8662},{"type":22,"tag":137,"props":8666,"children":8667},{},[8668],{"type":28,"value":8669},"如果任何一個準備請求超時，協調者就會終止事務。如果提交或終止請求失敗。協調者將會無條件重試。",{"type":22,"tag":137,"props":8671,"children":8672},{},[8673],{"type":28,"value":8674},"如果再准便前請求失敗，參與者可以安全終止事務，必須等待協調者回復提交終止或是成功，一旦協調者出現網路或是崩潰問題，餐與者就只能傻傻等待。所以參與者對於這種事務狀態稱為存疑或不確定。",{"type":22,"tag":137,"props":8676,"children":8677},{},[8678],{"type":22,"tag":341,"props":8679,"children":8682},{"alt":8680,"src":8681},"圖 9-10 參與者投贊成票後，協調者崩潰。資料庫 1 不知道是否提交或中止","https://vonng.github.io/ddia/img/fig9-10.png",[],{"type":22,"tag":137,"props":8684,"children":8685},{},[8686],{"type":22,"tag":51,"props":8687,"children":8688},{},[8689],{"type":28,"value":8680},{"type":22,"tag":137,"props":8691,"children":8692},{},[8693],{"type":28,"value":8694},"這張圖說明了協調者在提交部分出現問題導致參與者1只能呆呆的等待，少了協調者的訊息參與者不會知道事務已經提交或是放棄。在這種狀況底下只能等待協調者，所以這就是為什麼參與者需要在提交或終止之前先將”我願意”寫到日誌的原因因為最後的提交還是有可能失敗，任何沒有寫在事務日誌的提交紀錄都會被終止，所以2PC的提交點就是協調者的常規單節點原子原則。",{"type":22,"tag":424,"props":8696,"children":8698},{"className":1718,"code":8697,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Coordinator as 協調者\n    participant Node1 as 參與者1\n    participant Node2 as 參與者2\n    participant Log1 as 參與者1日誌\n    participant LogC as 協調者日誌\n    \n    Coordinator->>Node1: 準備請求(事務ID)\n    Coordinator->>Node2: 準備請求(事務ID)\n    Node1->>Log1: 寫入\"我願意\"(事務ID)\n    Node2->>Coordinator: 是(事務ID)\n    Coordinator->>LogC: 寫入決定:提交(事務ID)\n    Note over Coordinator: 協調者出現問題，暫時無法通訊\n    Note over Node1: 等待協調者的提交/中止請求...\n    Note over Coordinator: 協調者恢復\n    Coordinator->>LogC: 讀取事務日誌(事務ID)\n    Coordinator->>Node1: 提交請求(事務ID)\n    Coordinator->>Node2: 提交請求(事務ID)\n    Node1->>Coordinator: 提交成功(事務ID)\n    Node2->>Coordinator: 提交成功(事務ID)\n",[8699],{"type":22,"tag":431,"props":8700,"children":8701},{"__ignoreMap":13},[8702,8709,8716,8723,8730,8738,8746,8753,8760,8767,8775,8783,8791,8799,8807,8815,8823,8830,8837,8845],{"type":22,"tag":435,"props":8703,"children":8704},{"class":437,"line":438},[8705],{"type":22,"tag":435,"props":8706,"children":8707},{},[8708],{"type":28,"value":1732},{"type":22,"tag":435,"props":8710,"children":8711},{"class":437,"line":454},[8712],{"type":22,"tag":435,"props":8713,"children":8714},{},[8715],{"type":28,"value":8481},{"type":22,"tag":435,"props":8717,"children":8718},{"class":437,"line":463},[8719],{"type":22,"tag":435,"props":8720,"children":8721},{},[8722],{"type":28,"value":8489},{"type":22,"tag":435,"props":8724,"children":8725},{"class":437,"line":478},[8726],{"type":22,"tag":435,"props":8727,"children":8728},{},[8729],{"type":28,"value":8497},{"type":22,"tag":435,"props":8731,"children":8732},{"class":437,"line":499},[8733],{"type":22,"tag":435,"props":8734,"children":8735},{},[8736],{"type":28,"value":8737},"    participant Log1 as 參與者1日誌\n",{"type":22,"tag":435,"props":8739,"children":8740},{"class":437,"line":516},[8741],{"type":22,"tag":435,"props":8742,"children":8743},{},[8744],{"type":28,"value":8745},"    participant LogC as 協調者日誌\n",{"type":22,"tag":435,"props":8747,"children":8748},{"class":437,"line":533},[8749],{"type":22,"tag":435,"props":8750,"children":8751},{},[8752],{"type":28,"value":1811},{"type":22,"tag":435,"props":8754,"children":8755},{"class":437,"line":550},[8756],{"type":22,"tag":435,"props":8757,"children":8758},{},[8759],{"type":28,"value":8553},{"type":22,"tag":435,"props":8761,"children":8762},{"class":437,"line":559},[8763],{"type":22,"tag":435,"props":8764,"children":8765},{},[8766],{"type":28,"value":8561},{"type":22,"tag":435,"props":8768,"children":8769},{"class":437,"line":567},[8770],{"type":22,"tag":435,"props":8771,"children":8772},{},[8773],{"type":28,"value":8774},"    Node1->>Log1: 寫入\"我願意\"(事務ID)\n",{"type":22,"tag":435,"props":8776,"children":8777},{"class":437,"line":591},[8778],{"type":22,"tag":435,"props":8779,"children":8780},{},[8781],{"type":28,"value":8782},"    Node2->>Coordinator: 是(事務ID)\n",{"type":22,"tag":435,"props":8784,"children":8785},{"class":437,"line":606},[8786],{"type":22,"tag":435,"props":8787,"children":8788},{},[8789],{"type":28,"value":8790},"    Coordinator->>LogC: 寫入決定:提交(事務ID)\n",{"type":22,"tag":435,"props":8792,"children":8793},{"class":437,"line":615},[8794],{"type":22,"tag":435,"props":8795,"children":8796},{},[8797],{"type":28,"value":8798},"    Note over Coordinator: 協調者出現問題，暫時無法通訊\n",{"type":22,"tag":435,"props":8800,"children":8801},{"class":437,"line":636},[8802],{"type":22,"tag":435,"props":8803,"children":8804},{},[8805],{"type":28,"value":8806},"    Note over Node1: 等待協調者的提交/中止請求...\n",{"type":22,"tag":435,"props":8808,"children":8809},{"class":437,"line":650},[8810],{"type":22,"tag":435,"props":8811,"children":8812},{},[8813],{"type":28,"value":8814},"    Note over Coordinator: 協調者恢復\n",{"type":22,"tag":435,"props":8816,"children":8817},{"class":437,"line":678},[8818],{"type":22,"tag":435,"props":8819,"children":8820},{},[8821],{"type":28,"value":8822},"    Coordinator->>LogC: 讀取事務日誌(事務ID)\n",{"type":22,"tag":435,"props":8824,"children":8825},{"class":437,"line":686},[8826],{"type":22,"tag":435,"props":8827,"children":8828},{},[8829],{"type":28,"value":8601},{"type":22,"tag":435,"props":8831,"children":8832},{"class":437,"line":694},[8833],{"type":22,"tag":435,"props":8834,"children":8835},{},[8836],{"type":28,"value":8609},{"type":22,"tag":435,"props":8838,"children":8839},{"class":437,"line":759},[8840],{"type":22,"tag":435,"props":8841,"children":8842},{},[8843],{"type":28,"value":8844},"    Node1->>Coordinator: 提交成功(事務ID)\n",{"type":22,"tag":435,"props":8846,"children":8847},{"class":437,"line":783},[8848],{"type":22,"tag":435,"props":8849,"children":8850},{},[8851],{"type":28,"value":8852},"    Node2->>Coordinator: 提交成功(事務ID)\n",{"type":22,"tag":30,"props":8854,"children":8856},{"id":8855},"三階段提交",[8857],{"type":28,"value":8855},{"type":22,"tag":137,"props":8859,"children":8860},{},[8861],{"type":28,"value":8862},"1.兩階段提交（2PC）被視為阻塞的原子提交協議，因為在協調者故障時會造成參與者的等待。",{"type":22,"tag":137,"props":8864,"children":8865},{},[8866],{"type":28,"value":8867},"2.三階段提交（3PC）作為2PC的替代方案，但其有效性依賴於有限的網路延遲和節點響應時間，這在實際系統中不常見。",{"type":22,"tag":137,"props":8869,"children":8870},{},[8871],{"type":28,"value":8872},"3.非阻塞原子提交需要完美的故障檢測器以可靠地判斷節點的狀態，但在無限延遲的網路中，超時不是一個可靠的故障檢測機制。",{"type":22,"tag":137,"props":8874,"children":8875},{},[8876],{"type":28,"value":8877},"4.由於這些挑戰，2PC仍被使用，儘管存在協調者故障的可能性。",{"type":22,"tag":30,"props":8879,"children":8881},{"id":8880},"實踐中的分散式事務",[8882],{"type":28,"value":8880},{"type":22,"tag":137,"props":8884,"children":8885},{},[8886],{"type":28,"value":8887},"介紹:",{"type":22,"tag":137,"props":8889,"children":8890},{},[8891],{"type":28,"value":8892},"分散式事務的名聲譭譽參半，尤其是那些透過兩階段提交實現的。一方面，它被視作提供了一個難以實現的重要的安全性保證；另一方面，它們因為導致運維問題，造成效能下降，做出超過能力範圍的承諾而飽受批評。許多雲服務由於其導致的運維問題，而選擇不實現分散式事務。",{"type":22,"tag":137,"props":8894,"children":8895},{},[8896],{"type":28,"value":8897},"報告顯示MySQL的分散事務比單節點事務慢了10倍以上，2PC不只需要使用較高的效能大部分時間都是在處理崩潰恢復所需的強制寫入(fsync)與網路往返。",{"type":22,"tag":137,"props":8899,"children":8900},{},[8901],{"type":28,"value":8902},"fsync:",{"type":22,"tag":137,"props":8904,"children":8905},{},[8906,8915],{"type":22,"tag":51,"props":8907,"children":8908},{},[8909],{"type":22,"tag":431,"props":8910,"children":8912},{"className":8911},[],[8913],{"type":28,"value":8914},"fsync",{"type":28,"value":8916}," 是一個在多種操作系統中使用的系統呼叫，其主要目的是確保指定的文件描述符（file descriptor）所關聯的文件的所有元數據和元信息已經從操作系統的緩衝區寫入到底層存儲系統。當一個程序寫入文件時，操作系統可能會將數據暫時保留在緩衝區中，以便稍後再將它寫入磁碟，以提高效率。然而，在某些情況下，程序可能需要確保數據已經被實際寫入磁碟，以防止在系統崩潰或其他故障情況下失去數據。",{"type":22,"tag":137,"props":8918,"children":8919},{},[8920],{"type":28,"value":8921},"分散式事務:",{"type":22,"tag":137,"props":8923,"children":8924},{},[8925],{"type":28,"value":8926},"1.資料庫內部的分散式事務",{"type":22,"tag":137,"props":8928,"children":8929},{},[8930],{"type":28,"value":8931},"相同的資料庫例如 MySQL Cluster的NDB與VoltDB，所有參與事務的節點都是使用相同的資料庫軟體。",{"type":22,"tag":137,"props":8933,"children":8934},{},[8935],{"type":28,"value":8936},"2.異構分散式事務",{"type":22,"tag":137,"props":8938,"children":8939},{},[8940],{"type":28,"value":8941},"由兩種或是兩種以上不同技術組成，甚至是非資料庫系統(訊息代理)。跨系統的分散式事務必須要確保原子提交。",{"type":22,"tag":30,"props":8943,"children":8945},{"id":8944},"恰好一次的訊息處理",[8946],{"type":28,"value":8944},{"type":22,"tag":137,"props":8948,"children":8949},{},[8950],{"type":28,"value":8951},"異構的分散式事務只要能提供提交原子性來視線安全提交並且保證只被處理一次，假設郵件伺服器不支援2PC，如果訊息處理失敗並重試則可能導致重複發送郵件問題，但是如果訊息都可以在事務終止回滾，那這樣處理流程就可以安全地重試而且就好像什麼錯誤都沒有發生過一樣。",{"type":22,"tag":30,"props":8953,"children":8955},{"id":8954},"xa事務",[8956],{"type":28,"value":8957},"XA事務",{"type":22,"tag":137,"props":8959,"children":8960},{},[8961],{"type":28,"value":8962},"1.X/Open XA（擴充套件架構，eXtended Architecture）**是一個於1991年推出的標準，旨在通過兩階段提交實現異構技術間的整合，廣泛應用於許多傳統關聯式資料庫和訊息代理中。",{"type":22,"tag":137,"props":8964,"children":8965},{},[8966,8968,8973],{"type":28,"value":8967},"2.",{"type":22,"tag":51,"props":8969,"children":8970},{},[8971],{"type":28,"value":8972},"XA非網路協議，而是一個C API",{"type":28,"value":8974},"，用於連線至事務協調者。它也有在其他語言例如Java中的實現，如Java事務API (JTA)。",{"type":22,"tag":137,"props":8976,"children":8977},{},[8978,8980,8985],{"type":28,"value":8979},"3.",{"type":22,"tag":51,"props":8981,"children":8982},{},[8983],{"type":28,"value":8984},"事務協調者需實現XA API",{"type":28,"value":8986},"，通常是作為一個庫載入到發起事務的應用程序中，並使用本地磁碟上的日誌記錄事務的決定（提交/中止）。",{"type":22,"tag":137,"props":8988,"children":8989},{},[8990,8992,8997],{"type":28,"value":8991},"4.",{"type":22,"tag":51,"props":8993,"children":8994},{},[8995],{"type":28,"value":8996},"如果應用程序崩潰，協調者也會失效",{"type":28,"value":8998},"。必須重啟伺服器並讓協調程序庫讀取日誌以恢復每個事務的提交/中止結果，然後協調者才能要求參與者提交或中止。",{"type":22,"tag":137,"props":9000,"children":9001},{},[9002,9004,9009],{"type":28,"value":9003},"5.",{"type":22,"tag":51,"props":9005,"children":9006},{},[9007],{"type":28,"value":9008},"通訊必須透過客戶端庫",{"type":28,"value":9010},"，因為資料庫伺服器不能直接聯絡協調者。這意味著所有的事務協調都是通過應用程序進行的。",{"type":22,"tag":137,"props":9012,"children":9013},{},[9014],{"type":28,"value":8630},{"type":22,"tag":137,"props":9016,"children":9017},{},[9018],{"type":28,"value":9019},"XA事務就是一種以API的形式讓許多想要整合不同系統上事務用的通用溝通介面，並保證數據的一致性與完整性。我的認知是XA事務就是多系統的協調者",{"type":22,"tag":137,"props":9021,"children":9022},{},[9023],{"type":28,"value":9024},"假設:",{"type":22,"tag":4383,"props":9026,"children":9027},{},[9028,9044,9083,9104],{"type":22,"tag":45,"props":9029,"children":9030},{},[9031,9036],{"type":22,"tag":51,"props":9032,"children":9033},{},[9034],{"type":28,"value":9035},"初始化事務",{"type":22,"tag":41,"props":9037,"children":9038},{},[9039],{"type":22,"tag":45,"props":9040,"children":9041},{},[9042],{"type":28,"value":9043},"您的應用程序首先會向事務協調者發起一個新的事務。",{"type":22,"tag":45,"props":9045,"children":9046},{},[9047,9052],{"type":22,"tag":51,"props":9048,"children":9049},{},[9050],{"type":28,"value":9051},"準備階段",{"type":22,"tag":41,"props":9053,"children":9054},{},[9055,9078],{"type":22,"tag":45,"props":9056,"children":9057},{},[9058,9060],{"type":28,"value":9059},"應用程序將執行必要的操作，例如：\n",{"type":22,"tag":41,"props":9061,"children":9062},{},[9063,9068,9073],{"type":22,"tag":45,"props":9064,"children":9065},{},[9066],{"type":28,"value":9067},"在MySQL中插入一條新的記錄。",{"type":22,"tag":45,"props":9069,"children":9070},{},[9071],{"type":28,"value":9072},"在Redis中設置一個新的key-value對。",{"type":22,"tag":45,"props":9074,"children":9075},{},[9076],{"type":28,"value":9077},"在RabbitMQ中發布一條新的訊息。",{"type":22,"tag":45,"props":9079,"children":9080},{},[9081],{"type":28,"value":9082},"每個系統的操作都會通過XA API告知事務協調者它們已經準備好提交或回滾。",{"type":22,"tag":45,"props":9084,"children":9085},{},[9086,9091],{"type":22,"tag":51,"props":9087,"children":9088},{},[9089],{"type":28,"value":9090},"提交或回滾",{"type":22,"tag":41,"props":9092,"children":9093},{},[9094,9099],{"type":22,"tag":45,"props":9095,"children":9096},{},[9097],{"type":28,"value":9098},"如果所有的操作都成功準備好，事務協調者會告知所有的系統提交事務。",{"type":22,"tag":45,"props":9100,"children":9101},{},[9102],{"type":28,"value":9103},"如果任何一個操作報告它不能提交，或者在準備階段出現錯誤，事務協調者會告知所有的系統回滾事務。",{"type":22,"tag":45,"props":9105,"children":9106},{},[9107,9112],{"type":22,"tag":51,"props":9108,"children":9109},{},[9110],{"type":28,"value":9111},"結束事務",{"type":22,"tag":41,"props":9113,"children":9114},{},[9115],{"type":22,"tag":45,"props":9116,"children":9117},{},[9118],{"type":28,"value":9119},"一旦所有的系統都報告事務已經被提交或回滾，事務協調者會結束這個事務。",{"type":22,"tag":424,"props":9121,"children":9123},{"className":1718,"code":9122,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant App as Application\n    participant TM as Transaction Manager\n    participant MySQL\n    participant Redis\n    participant RabbitMQ\n    \n    App->>TM: Start Transaction\n    TM->>MySQL: Prepare\n    TM->>Redis: Prepare\n    TM->>RabbitMQ: Prepare\n    MySQL->>TM: Ready\n    Redis->>TM: Ready\n    RabbitMQ->>TM: Ready\n    TM->>MySQL: Commit\n    TM->>Redis: Commit\n    TM->>RabbitMQ: Commit\n    MySQL->>TM: Acknowledge Commit\n    Redis->>TM: Acknowledge Commit\n    RabbitMQ->>TM: Acknowledge Commit\n    TM->>App: Transaction Completed\n",[9124],{"type":22,"tag":431,"props":9125,"children":9126},{"__ignoreMap":13},[9127,9134,9142,9150,9158,9166,9174,9181,9189,9197,9205,9213,9221,9229,9237,9245,9253,9261,9269,9277,9285],{"type":22,"tag":435,"props":9128,"children":9129},{"class":437,"line":438},[9130],{"type":22,"tag":435,"props":9131,"children":9132},{},[9133],{"type":28,"value":1732},{"type":22,"tag":435,"props":9135,"children":9136},{"class":437,"line":454},[9137],{"type":22,"tag":435,"props":9138,"children":9139},{},[9140],{"type":28,"value":9141},"    participant App as Application\n",{"type":22,"tag":435,"props":9143,"children":9144},{"class":437,"line":463},[9145],{"type":22,"tag":435,"props":9146,"children":9147},{},[9148],{"type":28,"value":9149},"    participant TM as Transaction Manager\n",{"type":22,"tag":435,"props":9151,"children":9152},{"class":437,"line":478},[9153],{"type":22,"tag":435,"props":9154,"children":9155},{},[9156],{"type":28,"value":9157},"    participant MySQL\n",{"type":22,"tag":435,"props":9159,"children":9160},{"class":437,"line":499},[9161],{"type":22,"tag":435,"props":9162,"children":9163},{},[9164],{"type":28,"value":9165},"    participant Redis\n",{"type":22,"tag":435,"props":9167,"children":9168},{"class":437,"line":516},[9169],{"type":22,"tag":435,"props":9170,"children":9171},{},[9172],{"type":28,"value":9173},"    participant RabbitMQ\n",{"type":22,"tag":435,"props":9175,"children":9176},{"class":437,"line":533},[9177],{"type":22,"tag":435,"props":9178,"children":9179},{},[9180],{"type":28,"value":1811},{"type":22,"tag":435,"props":9182,"children":9183},{"class":437,"line":550},[9184],{"type":22,"tag":435,"props":9185,"children":9186},{},[9187],{"type":28,"value":9188},"    App->>TM: Start Transaction\n",{"type":22,"tag":435,"props":9190,"children":9191},{"class":437,"line":559},[9192],{"type":22,"tag":435,"props":9193,"children":9194},{},[9195],{"type":28,"value":9196},"    TM->>MySQL: Prepare\n",{"type":22,"tag":435,"props":9198,"children":9199},{"class":437,"line":567},[9200],{"type":22,"tag":435,"props":9201,"children":9202},{},[9203],{"type":28,"value":9204},"    TM->>Redis: Prepare\n",{"type":22,"tag":435,"props":9206,"children":9207},{"class":437,"line":591},[9208],{"type":22,"tag":435,"props":9209,"children":9210},{},[9211],{"type":28,"value":9212},"    TM->>RabbitMQ: Prepare\n",{"type":22,"tag":435,"props":9214,"children":9215},{"class":437,"line":606},[9216],{"type":22,"tag":435,"props":9217,"children":9218},{},[9219],{"type":28,"value":9220},"    MySQL->>TM: Ready\n",{"type":22,"tag":435,"props":9222,"children":9223},{"class":437,"line":615},[9224],{"type":22,"tag":435,"props":9225,"children":9226},{},[9227],{"type":28,"value":9228},"    Redis->>TM: Ready\n",{"type":22,"tag":435,"props":9230,"children":9231},{"class":437,"line":636},[9232],{"type":22,"tag":435,"props":9233,"children":9234},{},[9235],{"type":28,"value":9236},"    RabbitMQ->>TM: Ready\n",{"type":22,"tag":435,"props":9238,"children":9239},{"class":437,"line":650},[9240],{"type":22,"tag":435,"props":9241,"children":9242},{},[9243],{"type":28,"value":9244},"    TM->>MySQL: Commit\n",{"type":22,"tag":435,"props":9246,"children":9247},{"class":437,"line":678},[9248],{"type":22,"tag":435,"props":9249,"children":9250},{},[9251],{"type":28,"value":9252},"    TM->>Redis: Commit\n",{"type":22,"tag":435,"props":9254,"children":9255},{"class":437,"line":686},[9256],{"type":22,"tag":435,"props":9257,"children":9258},{},[9259],{"type":28,"value":9260},"    TM->>RabbitMQ: Commit\n",{"type":22,"tag":435,"props":9262,"children":9263},{"class":437,"line":694},[9264],{"type":22,"tag":435,"props":9265,"children":9266},{},[9267],{"type":28,"value":9268},"    MySQL->>TM: Acknowledge Commit\n",{"type":22,"tag":435,"props":9270,"children":9271},{"class":437,"line":759},[9272],{"type":22,"tag":435,"props":9273,"children":9274},{},[9275],{"type":28,"value":9276},"    Redis->>TM: Acknowledge Commit\n",{"type":22,"tag":435,"props":9278,"children":9279},{"class":437,"line":783},[9280],{"type":22,"tag":435,"props":9281,"children":9282},{},[9283],{"type":28,"value":9284},"    RabbitMQ->>TM: Acknowledge Commit\n",{"type":22,"tag":435,"props":9286,"children":9287},{"class":437,"line":837},[9288],{"type":22,"tag":435,"props":9289,"children":9290},{},[9291],{"type":28,"value":9292},"    TM->>App: Transaction Completed\n",{"type":22,"tag":137,"props":9294,"children":9295},{},[9296],{"type":28,"value":9297},"這是我想像中XA事務當作協調者可能會做的事情",{"type":22,"tag":30,"props":9299,"children":9301},{"id":9300},"懷疑持有鎖",[9302],{"type":28,"value":9300},{"type":22,"tag":137,"props":9304,"children":9305},{},[9306],{"type":28,"value":9307},"為什麼我們這麼關心存疑事務？系統的其他部分就不能繼續正常工作，無視那些終將被清理的存疑事務嗎？",{"type":22,"tag":137,"props":9309,"children":9310},{},[9311],{"type":28,"value":9312},"1.如果其他部分如果繼續運作會導致髒寫，或是資料不一致性。",{"type":22,"tag":137,"props":9314,"children":9315},{},[9316],{"type":28,"value":9317},"2.如果協調者崩潰，事務必須在整個存疑期間持有這個鎖，這可能導致應用大面積不可用，直到存疑事務得到解決。",{"type":22,"tag":137,"props":9319,"children":9320},{},[9321],{"type":28,"value":9322},"3.存疑事務是問題的核心，因為它們持有資料庫的鎖，並阻止其他事務訪問相同的資料行。",{"type":22,"tag":137,"props":9324,"children":9325},{},[9326],{"type":28,"value":4330},{"type":22,"tag":137,"props":9328,"children":9329},{},[9330],{"type":28,"value":9331},"回到9-9這裡存疑事務並沒有說明的很清楚但是經過查證過後應該是9-9的灰色部分locks held by transaction，在這個狀況底下所有需要使用事務的節點都會被這個鎖卡死。",{"type":22,"tag":424,"props":9333,"children":9335},{"className":1718,"code":9334,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant 協調者\n    participant 資料庫\n    participant 事務A\n    participant 事務B\n\n    事務A->>資料庫: 開始事務, 獲取行鎖\n    Note right of 資料庫: 行鎖被持有\n    資料庫-->>協調者: 通知事務A的行鎖\n    協調者->>資料庫: 保持行鎖直至提交或中止\n    事務B->>資料庫: 開始事務, 嘗試獲取相同行的鎖\n    Note right of 資料庫: 事務B被阻塞\n    資料庫-->>協調者: 通知事務B的阻塞\n    協調者-->>事務A: 請求提交或中止事務\n    事務A->>資料庫: 提交事務\n    資料庫-->>協調者: 通知事務A的提交\n    協調者->>資料庫: 釋放事務A的行鎖\n    Note right of 資料庫: 行鎖被釋放\n    資料庫-->>事務B: 獲取行鎖, 繼續事務\n",[9336],{"type":22,"tag":431,"props":9337,"children":9338},{"__ignoreMap":13},[9339,9346,9354,9362,9370,9378,9385,9393,9401,9409,9417,9425,9433,9441,9449,9457,9465,9473,9481],{"type":22,"tag":435,"props":9340,"children":9341},{"class":437,"line":438},[9342],{"type":22,"tag":435,"props":9343,"children":9344},{},[9345],{"type":28,"value":1732},{"type":22,"tag":435,"props":9347,"children":9348},{"class":437,"line":454},[9349],{"type":22,"tag":435,"props":9350,"children":9351},{},[9352],{"type":28,"value":9353},"    participant 協調者\n",{"type":22,"tag":435,"props":9355,"children":9356},{"class":437,"line":463},[9357],{"type":22,"tag":435,"props":9358,"children":9359},{},[9360],{"type":28,"value":9361},"    participant 資料庫\n",{"type":22,"tag":435,"props":9363,"children":9364},{"class":437,"line":478},[9365],{"type":22,"tag":435,"props":9366,"children":9367},{},[9368],{"type":28,"value":9369},"    participant 事務A\n",{"type":22,"tag":435,"props":9371,"children":9372},{"class":437,"line":499},[9373],{"type":22,"tag":435,"props":9374,"children":9375},{},[9376],{"type":28,"value":9377},"    participant 事務B\n",{"type":22,"tag":435,"props":9379,"children":9380},{"class":437,"line":516},[9381],{"type":22,"tag":435,"props":9382,"children":9383},{"emptyLinePlaceholder":5},[9384],{"type":28,"value":460},{"type":22,"tag":435,"props":9386,"children":9387},{"class":437,"line":533},[9388],{"type":22,"tag":435,"props":9389,"children":9390},{},[9391],{"type":28,"value":9392},"    事務A->>資料庫: 開始事務, 獲取行鎖\n",{"type":22,"tag":435,"props":9394,"children":9395},{"class":437,"line":550},[9396],{"type":22,"tag":435,"props":9397,"children":9398},{},[9399],{"type":28,"value":9400},"    Note right of 資料庫: 行鎖被持有\n",{"type":22,"tag":435,"props":9402,"children":9403},{"class":437,"line":559},[9404],{"type":22,"tag":435,"props":9405,"children":9406},{},[9407],{"type":28,"value":9408},"    資料庫-->>協調者: 通知事務A的行鎖\n",{"type":22,"tag":435,"props":9410,"children":9411},{"class":437,"line":567},[9412],{"type":22,"tag":435,"props":9413,"children":9414},{},[9415],{"type":28,"value":9416},"    協調者->>資料庫: 保持行鎖直至提交或中止\n",{"type":22,"tag":435,"props":9418,"children":9419},{"class":437,"line":591},[9420],{"type":22,"tag":435,"props":9421,"children":9422},{},[9423],{"type":28,"value":9424},"    事務B->>資料庫: 開始事務, 嘗試獲取相同行的鎖\n",{"type":22,"tag":435,"props":9426,"children":9427},{"class":437,"line":606},[9428],{"type":22,"tag":435,"props":9429,"children":9430},{},[9431],{"type":28,"value":9432},"    Note right of 資料庫: 事務B被阻塞\n",{"type":22,"tag":435,"props":9434,"children":9435},{"class":437,"line":615},[9436],{"type":22,"tag":435,"props":9437,"children":9438},{},[9439],{"type":28,"value":9440},"    資料庫-->>協調者: 通知事務B的阻塞\n",{"type":22,"tag":435,"props":9442,"children":9443},{"class":437,"line":636},[9444],{"type":22,"tag":435,"props":9445,"children":9446},{},[9447],{"type":28,"value":9448},"    協調者-->>事務A: 請求提交或中止事務\n",{"type":22,"tag":435,"props":9450,"children":9451},{"class":437,"line":650},[9452],{"type":22,"tag":435,"props":9453,"children":9454},{},[9455],{"type":28,"value":9456},"    事務A->>資料庫: 提交事務\n",{"type":22,"tag":435,"props":9458,"children":9459},{"class":437,"line":678},[9460],{"type":22,"tag":435,"props":9461,"children":9462},{},[9463],{"type":28,"value":9464},"    資料庫-->>協調者: 通知事務A的提交\n",{"type":22,"tag":435,"props":9466,"children":9467},{"class":437,"line":686},[9468],{"type":22,"tag":435,"props":9469,"children":9470},{},[9471],{"type":28,"value":9472},"    協調者->>資料庫: 釋放事務A的行鎖\n",{"type":22,"tag":435,"props":9474,"children":9475},{"class":437,"line":694},[9476],{"type":22,"tag":435,"props":9477,"children":9478},{},[9479],{"type":28,"value":9480},"    Note right of 資料庫: 行鎖被釋放\n",{"type":22,"tag":435,"props":9482,"children":9483},{"class":437,"line":759},[9484],{"type":22,"tag":435,"props":9485,"children":9486},{},[9487],{"type":28,"value":9488},"    資料庫-->>事務B: 獲取行鎖, 繼續事務\n",{"type":22,"tag":30,"props":9490,"children":9492},{"id":9491},"從協調者故障中恢復",[9493],{"type":28,"value":9491},{"type":22,"tag":137,"props":9495,"children":9496},{},[9497],{"type":28,"value":9498},"理論上協調者崩潰後並重新啟動，應該可以從日誌中恢復，並解決所有的存疑事務。然而實際的系統很有可能會產生孤立的事務，孤立事務會出現在協調者無法確認事務結果的狀況發生(例如事務日誌由於軟體錯誤丟失或損壞)。當然這種狀況事務基本上無法自己解決，所以這些鎖就會卡在資料庫中阻塞其他事務。",{"type":22,"tag":137,"props":9500,"children":9501},{},[9502],{"type":28,"value":9503},"真正的原因是因為2PC的實踐中即時重新啟動也會保留存疑事務鎖(為了保持原子性保證)，唯一的方式就是讓管理者手動決定提交還是回滾，這時候管理者就要一一去查看存疑事務的參與者(昏倒的那個請他再說一次我願意，或是有點像是git的同一份文件多人修改需要人為解決衝突)。",{"type":22,"tag":137,"props":9505,"children":9506},{},[9507,9509,9514],{"type":28,"value":9508},"許多XA的實踐都有一個叫做啟發式決策，允許參與者單方面決定提交或是放棄，無需協調者作出最終決定。但是壞處就是可能破壞了原子性，有趣的是啟發式代表的是可能破壞原子性的委婉說法，啟發式決策只是為了逃出災難性的情況而準備(",{"type":22,"tag":107,"props":9510,"children":9511},{},[9512],{"type":28,"value":9513},"其實發錢或是發張電影票或許可以解決",{"type":28,"value":9515},")。",{"type":22,"tag":30,"props":9517,"children":9519},{"id":9518},"分散式事務的限制",[9520],{"type":28,"value":9518},{"type":22,"tag":137,"props":9522,"children":9523},{},[9524],{"type":28,"value":9525},"XA事務解決了多個參與者相互一致的實現和重要問題，但也引入了嚴重的維運問題，事務協調者本身就是一種資料庫，因此需要像其他重要資料庫一樣小心操作。",{"type":22,"tag":137,"props":9527,"children":9528},{},[9529],{"type":28,"value":9530},"1.如果協調者沒有HA，可能會導致存疑事務鎖死，令人驚訝的是好像很多協調者都沒有HA或者只有基本的複製支援\n2.引入協調者後，間接地引入了系統狀態。通常的HTTP服務是無狀態的，但一旦加入了協調者，協調者的日誌就必須持久化以保存系統的狀態。因此，在協調者資料庫崩潰後，必須能夠恢復存疑事務。",{"type":22,"tag":137,"props":9532,"children":9533},{},[9534],{"type":28,"value":9535},"3.由於XA協議要兼容多種不同的資料系統，它必須採用所有系統共通的基本機能。例如，XA無法檢測跨不同系統的死鎖，因為這需要一個標準的協議來交換各個事務正在等待的鎖的資訊，而XA並未提供這樣的協議。",{"type":22,"tag":137,"props":9537,"children":9538},{},[9539],{"type":28,"value":9540},"4.相對於XA，針對資料庫內部的分散式事務，限制不是那麼嚴格。例如，可以實現分散式版本的SSI。然而，仍然存在一些問題：使用兩階段提交（2PC）成功提交一個事務需要得到所有參與者的回應。所以，如果系統的任何一部分出現故障，事務就會失敗。因此，分散式事務有放大失效（amplifying failures）的風險，這與我們構建容錯系統的目標是相違背的。",{"type":22,"tag":30,"props":9542,"children":9544},{"id":9543},"容錯共識",[9545],{"type":28,"value":9543},{"type":22,"tag":137,"props":9547,"children":9548},{},[9549],{"type":28,"value":300},{"type":22,"tag":137,"props":9551,"children":9552},{},[9553],{"type":28,"value":9554},"共識＝多個節點就某個事件達成一致",{"type":22,"tag":137,"props":9556,"children":9557},{},[9558],{"type":28,"value":9559},"例如多個人同時嘗試定飛機最後一個位置，共識演算法可以用來確定這些互不相容的操作，最終決定哪一個是贏家",{"type":22,"tag":137,"props":9561,"children":9562},{},[9563],{"type":28,"value":9564},"一個或多個節點可以提議某些值，而共識演算法決定採用某個值。",{"type":22,"tag":137,"props":9566,"children":9567},{},[9568],{"type":28,"value":6461},{"type":22,"tag":137,"props":9570,"children":9571},{},[9572],{"type":28,"value":9573},"在訂飛機票的時候，當同時多個客戶嘗試訂購最後一個座位時，處理request的每個節點可以提議將要服務的客戶ID，而決定指明哪個客戶訂到座位",{"type":22,"tag":137,"props":9575,"children":9576},{},[9577],{"type":28,"value":9578},"共識演算法必須滿足以下性質：",{"type":22,"tag":137,"props":9580,"children":9581},{},[9582],{"type":28,"value":9583},"統一共識，相當於不可靠故障檢測器的非同步系統中的常規共識，學術文獻通常指的是process而不是節點。在這裡使用節點。",{"type":22,"tag":137,"props":9585,"children":9586},{},[9587],{"type":28,"value":9588},"屬性解釋：",{"type":22,"tag":41,"props":9590,"children":9591},{},[9592,9602,9612,9637],{"type":22,"tag":45,"props":9593,"children":9594},{},[9595,9597,9600],{"type":28,"value":9596},"一致同意（Uniform agreement）",{"type":22,"tag":4117,"props":9598,"children":9599},{},[],{"type":28,"value":9601},"沒有兩個節點的決定不同。",{"type":22,"tag":45,"props":9603,"children":9604},{},[9605,9607,9610],{"type":28,"value":9606},"完整性（Integrity）",{"type":22,"tag":4117,"props":9608,"children":9609},{},[],{"type":28,"value":9611},"沒有節點決定兩次。",{"type":22,"tag":45,"props":9613,"children":9614},{},[9615,9617,9620,9622,9628,9630,9635],{"type":28,"value":9616},"有效性（Validity）",{"type":22,"tag":4117,"props":9618,"children":9619},{},[],{"type":28,"value":9621},"如果一個節點決定了值 ",{"type":22,"tag":431,"props":9623,"children":9625},{"className":9624},[],[9626],{"type":28,"value":9627},"v",{"type":28,"value":9629}," ，則 ",{"type":22,"tag":431,"props":9631,"children":9633},{"className":9632},[],[9634],{"type":28,"value":9627},{"type":28,"value":9636}," 由某個節點所提議。",{"type":22,"tag":45,"props":9638,"children":9639},{},[9640,9642,9645],{"type":28,"value":9641},"終止（Termination）",{"type":22,"tag":4117,"props":9643,"children":9644},{},[],{"type":28,"value":9646},"由所有未崩潰的節點來最終決定值。",{"type":22,"tag":4383,"props":9648,"children":9649},{},[9650,9735,9757,9784],{"type":22,"tag":45,"props":9651,"children":9652},{},[9653,9658,9660,9725,9728,9730,9733],{"type":22,"tag":51,"props":9654,"children":9655},{},[9656],{"type":28,"value":9657},"共識核心屬性",{"type":28,"value":9659},"：",{"type":22,"tag":41,"props":9661,"children":9662},{},[9663,9668,9685,9701],{"type":22,"tag":45,"props":9664,"children":9665},{},[9666],{"type":28,"value":9667},"在共識演算法的領域中，\"一致同意\"（Agreement）、\"完整性\"（Integrity）和\"有效性\"（Validity）是三個基本的屬性，它們共同定義了一個良好共識演算法的基本要求。",{"type":22,"tag":45,"props":9669,"children":9670},{},[9671,9676,9677],{"type":22,"tag":51,"props":9672,"children":9673},{},[9674],{"type":28,"value":9675},"一致同意（Agreement）",{"type":28,"value":6839},{"type":22,"tag":41,"props":9678,"children":9679},{},[9680],{"type":22,"tag":45,"props":9681,"children":9682},{},[9683],{"type":28,"value":9684},"這個屬性要求所有非失效的節點必須達成共識，即它們都必須同意同一個值。所有人必須達成相同的決定。",{"type":22,"tag":45,"props":9686,"children":9687},{},[9688,9692,9693],{"type":22,"tag":51,"props":9689,"children":9690},{},[9691],{"type":28,"value":9606},{"type":28,"value":6839},{"type":22,"tag":41,"props":9694,"children":9695},{},[9696],{"type":22,"tag":45,"props":9697,"children":9698},{},[9699],{"type":28,"value":9700},"完整性要求一個值一旦被選定，就不應該被改變。換句話說，每個節點只能接受一個值，並且一旦值被決定，就不能更改。",{"type":22,"tag":45,"props":9702,"children":9703},{},[9704,9708,9709],{"type":22,"tag":51,"props":9705,"children":9706},{},[9707],{"type":28,"value":9616},{"type":28,"value":6839},{"type":22,"tag":41,"props":9710,"children":9711},{},[9712],{"type":22,"tag":45,"props":9713,"children":9714},{},[9715,9717,9723],{"type":28,"value":9716},"有效性要求被選定的值必須是由某個節點提議的值，而不應是一個隨意創造的值。這個屬性主要是為了避免某些“偽”解決方案。一個演算法可能始終選擇**",{"type":22,"tag":431,"props":9718,"children":9720},{"className":9719},[],[9721],{"type":28,"value":9722},"null",{"type":28,"value":9724},"**作為共識值，無論節點們提議了什麼值。這個演算法滿足了一致同意和完整性（因為它始終選擇同一個值並且不會更改它），但它不滿足有效性，因為它選擇的值並不是由節點提議的。",{"type":22,"tag":4117,"props":9726,"children":9727},{},[],{"type":28,"value":9729},"這三個屬性合起來確保了共識演算法的基本要求：所有非失效的節點能夠達成共識，選定一個由節點提議的值，並且一旦這個值被選定，就不能再被更改。這是實現分布式系統一致性的基本框架，並確保了系統的穩定性和可靠性。",{"type":22,"tag":4117,"props":9731,"children":9732},{},[],{"type":28,"value":9734},"如果不關心容錯，那麼滿足前三個屬性很容易：你可以將一個節點硬編碼為 “獨裁者”，並讓該節點做出所有的決定。但如果該節點失效，那麼系統就無法再做出任何決定。事實上，這就是我們在兩階段提交的情況中所看到的：如果協調者失效，那麼存疑的參與者就無法決定提交還是中止。",{"type":22,"tag":45,"props":9736,"children":9737},{},[9738,9743,9744],{"type":22,"tag":51,"props":9739,"children":9740},{},[9741],{"type":28,"value":9742},"獨裁者節點與協調者的影響",{"type":28,"value":9659},{"type":22,"tag":41,"props":9745,"children":9746},{},[9747,9752],{"type":22,"tag":45,"props":9748,"children":9749},{},[9750],{"type":28,"value":9751},"硬編碼一個節點作為“獨裁者”可以輕易達成共識，但若該節點失效，系統不能做出決定。",{"type":22,"tag":45,"props":9753,"children":9754},{},[9755],{"type":28,"value":9756},"兩階段提交的情況下，若協調者失效，存疑的參與者不能決定提交還是中止。",{"type":22,"tag":45,"props":9758,"children":9759},{},[9760,9765,9766],{"type":22,"tag":51,"props":9761,"children":9762},{},[9763],{"type":28,"value":9764},"終止屬性與容錯",{"type":28,"value":9659},{"type":22,"tag":41,"props":9767,"children":9768},{},[9769,9774,9779],{"type":22,"tag":45,"props":9770,"children":9771},{},[9772],{"type":28,"value":9773},"終止屬性要求共識演算法不能無限期地等待，即使有節點失效，也必須達成決定。",{"type":22,"tag":45,"props":9775,"children":9776},{},[9777],{"type":28,"value":9778},"終止屬性取決於，不超過一半節點不可用。",{"type":22,"tag":45,"props":9780,"children":9781},{},[9782],{"type":28,"value":9783},"即使大多數節點失效或網路存在問題，共識的實現仍需保證安全屬性（一致同意，完整性和有效性）。",{"type":22,"tag":45,"props":9785,"children":9786},{},[9787,9792,9793],{"type":22,"tag":51,"props":9788,"children":9789},{},[9790],{"type":28,"value":9791},"拜占庭錯誤((n+1)/3)與共識",{"type":28,"value":9659},{"type":22,"tag":41,"props":9794,"children":9795},{},[9796,9801],{"type":22,"tag":45,"props":9797,"children":9798},{},[9799],{"type":28,"value":9800},"大多數共識演算法假設不存在拜占庭錯誤，即節點都會正確遵循協議。",{"type":22,"tag":45,"props":9802,"children":9803},{},[9804],{"type":28,"value":9805},"穩健地達成共識是可能的，只要少於三分之一的節點存在拜占庭錯誤。",{"type":22,"tag":30,"props":9807,"children":9809},{"id":9808},"共識演算法和全序廣播",[9810],{"type":28,"value":9808},{"type":22,"tag":137,"props":9812,"children":9813},{},[9814],{"type":28,"value":9815},"最著名的容錯共識演算法是檢視戳複製(VSR, Viewstamped Replication)。但是本書不介紹!!!暸解共通的高階思想就足夠了，除非自己要實現一個共識系統。",{"type":22,"tag":137,"props":9817,"children":9818},{},[9819],{"type":28,"value":9820},"大多數的共識演算法實際上並不直接使用剛剛提到的這些模型(提議與決定單個值，並滿足一致同意、完整性、有效性和終止屬性)。取而代之的反而是值的順序，同時也促使了全序廣播演算法。",{"type":22,"tag":137,"props":9822,"children":9823},{},[9824],{"type":28,"value":9825},"全序廣播要求將訊息按照相同的順序，恰好傳送一次，準確地送到所有節點。",{"type":22,"tag":137,"props":9827,"children":9828},{},[9829],{"type":28,"value":9830},"所以全序廣播相當於重複進行了多輪共識(每次共識決定與一次訊息傳遞相對應)：",{"type":22,"tag":41,"props":9832,"children":9833},{},[9834,9846,9857,9868],{"type":22,"tag":45,"props":9835,"children":9836},{},[9837,9839,9844],{"type":28,"value":9838},"由於 ",{"type":22,"tag":51,"props":9840,"children":9841},{},[9842],{"type":28,"value":9843},"一致同意",{"type":28,"value":9845}," 屬性，所有節點決定以相同的順序傳遞相同的訊息。",{"type":22,"tag":45,"props":9847,"children":9848},{},[9849,9850,9855],{"type":28,"value":9838},{"type":22,"tag":51,"props":9851,"children":9852},{},[9853],{"type":28,"value":9854},"完整性",{"type":28,"value":9856}," 屬性，訊息不會重複。",{"type":22,"tag":45,"props":9858,"children":9859},{},[9860,9861,9866],{"type":28,"value":9838},{"type":22,"tag":51,"props":9862,"children":9863},{},[9864],{"type":28,"value":9865},"有效性",{"type":28,"value":9867}," 屬性，訊息不會被損壞，也不能憑空編造。",{"type":22,"tag":45,"props":9869,"children":9870},{},[9871,9872,9877],{"type":28,"value":9838},{"type":22,"tag":51,"props":9873,"children":9874},{},[9875],{"type":28,"value":9876},"終止",{"type":28,"value":9878}," 屬性，訊息不會丟失。",{"type":22,"tag":137,"props":9880,"children":9881},{},[9882,9884,9889],{"type":28,"value":9883},"視戳複製，Raft 和 Zab 直接實現了全序廣播，因為這樣做比重複 ",{"type":22,"tag":51,"props":9885,"children":9886},{},[9887],{"type":28,"value":9888},"一次一值（one value a time）",{"type":28,"value":9890}," 的共識更高效。在 Paxos 的情況下，這種最佳化被稱為 Multi-Paxos。",{"type":22,"tag":137,"props":9892,"children":9893},{},[9894],{"type":28,"value":4330},{"type":22,"tag":137,"props":9896,"children":9897},{},[9898],{"type":28,"value":9899},"全序廣播棒棒，支持了共識演算法所需要基本要求一致同意……等等屬性",{"type":22,"tag":30,"props":9901,"children":9903},{"id":9902},"單主複製與共識",[9904],{"type":28,"value":9902},{"type":22,"tag":137,"props":9906,"children":9907},{},[9908],{"type":28,"value":9909},"為什麼在第五章沒有擔心過共識問題？因為單主複製將所有操作都交給主庫並以相同的順序丟給從庫，使從庫的副本保持在最新狀態。",{"type":22,"tag":137,"props":9911,"children":9912},{},[9913],{"type":28,"value":9914},"如果主庫是由維運人員手動操作那就是一種獨裁型別的共識演算法：只有一個節點被允許接受寫入，如果該節點發生故障，則整個系統無法寫入，直到維運人員處理。這樣的系統在實踐中表現良好，但是無法滿足終止屬性，因為需要人為干預才能取得進展。",{"type":22,"tag":137,"props":9916,"children":9917},{},[9918],{"type":28,"value":9919},"某些資料庫會自動執行領導者選舉，但是會導致腦裂，因為領導者之間需要共識演算法。",{"type":22,"tag":137,"props":9921,"children":9922},{},[9923],{"type":28,"value":4330},{"type":22,"tag":137,"props":9925,"children":9926},{},[9927],{"type":28,"value":9928},"要有共識演算法要先有領導者，而選出領導者TMD又要有共識演算法所以，先有雞還是先有蛋的問題出現了！",{"type":22,"tag":30,"props":9930,"children":9932},{"id":9931},"紀元編號和法定人數",[9933],{"type":28,"value":9931},{"type":22,"tag":4383,"props":9935,"children":9936},{},[9937,9955,9972,9989,10006],{"type":22,"tag":45,"props":9938,"children":9939},{},[9940,9945,9947],{"type":22,"tag":51,"props":9941,"children":9942},{},[9943],{"type":28,"value":9944},"領導者與紀元編號的關係",{"type":28,"value":9946},":\n",{"type":22,"tag":41,"props":9948,"children":9949},{},[9950],{"type":22,"tag":45,"props":9951,"children":9952},{},[9953],{"type":28,"value":9954},"共識協議通常內部有領導者的概念，但不能保證領導者的獨一無二。通過紀元編號（在不同協議中可能有不同名稱）來確保在每個時期，領導者是唯一的。",{"type":22,"tag":45,"props":9956,"children":9957},{},[9958,9963,9964],{"type":22,"tag":51,"props":9959,"children":9960},{},[9961],{"type":28,"value":9962},"領導者選舉",{"type":28,"value":9946},{"type":22,"tag":41,"props":9965,"children":9966},{},[9967],{"type":22,"tag":45,"props":9968,"children":9969},{},[9970],{"type":28,"value":9971},"當現任領導者被認為失效時，節點間會開始新的領導者選舉，並賦予新的紀元編號，以保證紀元編號的全序且單調遞增。",{"type":22,"tag":45,"props":9973,"children":9974},{},[9975,9980,9981],{"type":22,"tag":51,"props":9976,"children":9977},{},[9978],{"type":28,"value":9979},"領導者衝突的解決",{"type":28,"value":9946},{"type":22,"tag":41,"props":9982,"children":9983},{},[9984],{"type":22,"tag":45,"props":9985,"children":9986},{},[9987],{"type":28,"value":9988},"若不同時期的領導者之間出現衝突，則以紀元編號較高的領導者為准。",{"type":22,"tag":45,"props":9990,"children":9991},{},[9992,9997,9998],{"type":22,"tag":51,"props":9993,"children":9994},{},[9995],{"type":28,"value":9996},"法定人數",{"type":28,"value":9946},{"type":22,"tag":41,"props":9999,"children":10000},{},[10001],{"type":22,"tag":45,"props":10002,"children":10003},{},[10004],{"type":28,"value":10005},"一個領導者在做出任何決定前，必須先從法定人數的節點中獲得贊成。通常需要兩輪投票：一輪選出領導者，一輪對領導者的提議進行投票。",{"type":22,"tag":45,"props":10007,"children":10008},{},[10009,10014,10015],{"type":22,"tag":51,"props":10010,"children":10011},{},[10012],{"type":28,"value":10013},"投票過程與2PC的區別",{"type":28,"value":9946},{"type":22,"tag":41,"props":10016,"children":10017},{},[10018],{"type":22,"tag":45,"props":10019,"children":10020},{},[10021],{"type":28,"value":10022},"這個投票過程與兩階段提交（2PC）相似，但區別在於領導者的產生方式及投票要求。共識演算法只需要多數節點的贊成，並且有明確的恢復過程來保證系統的安全屬性。",{"type":22,"tag":137,"props":10024,"children":10025},{},[10026],{"type":28,"value":4330},{"type":22,"tag":137,"props":10028,"children":10029},{},[10030],{"type":28,"value":10031},"在領導者選拔裡弄了一個更嚴謹的紀元編號與法定人數並讓編號最大的人當選領導者，投票過程就是更嚴謹的2PC",{"type":22,"tag":424,"props":10033,"children":10035},{"className":1718,"code":10034,"language":1720,"meta":13,"style":13},"sequenceDiagram\n    participant Node1\n    participant Node2\n    participant Node3\n    participant Node4\n\n    Note over Node1,Node4: 初始狀態 (領導者: Node1)\n\n    alt 領導者失效\n        Node1->>Node1: 領導者失效\n    end\n\n    Note over Node1,Node4: 紀元編號 1 開始\n\n    Node2->>+Node3: 領導者失效，開始領導者選舉 (紀元編號: 1)\n    Node3->>+Node2: 投票給 Node2 (紀元編號: 1)\n    Node4->>+Node2: 投票給 Node2 (紀元編號: 1)\n\n    Note over Node2,Node4: Node2 以多數票當選為領導者\n\n    Node2->>Node3: 提議值 (紀元編號: 1)\n    Node2->>Node4: 提議值 (紀元編號: 1)\n    Node3->>Node2: 贊成提議 (紀元編號: 1)\n    Node4->>Node2: 贊成提議 (紀元編號: 1)\n\n    Note over Node2,Node4: 提議值被以多數票接受\n\n    alt 領導者失效\n        Node2->>Node2: 領導者失效\n    end\n\n    Note over Node2,Node4: 紀元編號 2 開始\n\n    alt Node1恢復\n        Node1->>Node1: Node1恢復\n    end\n\n    Node1->>+Node3: 領導者失效，開始領導者選舉 (紀元編號: 2)\n    Node3->>+Node1: 投票給 Node1 (紀元編號: 2)\n    Node4->>+Node1: 投票給 Node1 (紀元編號: 2)\n\n    Note over Node1,Node4: Node1 以多數票當選為領導者\n\n    Node1->>Node3: 提議值 (紀元編號: 2)\n    Node1->>Node4: 提議值 (紀元編號: 2)\n    Node3->>Node1: 贊成提議 (紀元編號: 2)\n    Node4->>Node1: 贊成提議 (紀元編號: 2)\n\n    Note over Node1,Node4: 提議值被以多數票接受\nalt Node2恢復\n        Node2->>Node2: Node2恢復\n    end\n    alt 領導者衝突的解決\n        Node2->>Node1: 嘗試成為領導者 (紀元編號: 2)\n        Node1->>Node2: 以更高的紀元編號解決衝突 (紀元編號: 3)\n    end\n\n    Note over Node1,Node4: Node1 保持為領導者\n",[10036],{"type":22,"tag":431,"props":10037,"children":10038},{"__ignoreMap":13},[10039,10046,10054,10062,10070,10078,10085,10093,10100,10108,10116,10123,10130,10138,10145,10153,10161,10169,10176,10184,10191,10199,10207,10215,10223,10230,10238,10245,10252,10260,10267,10274,10282,10289,10297,10305,10312,10319,10327,10335,10343,10350,10358,10365,10373,10381,10389,10397,10404,10412,10420,10428,10435,10443,10451,10459,10466,10473],{"type":22,"tag":435,"props":10040,"children":10041},{"class":437,"line":438},[10042],{"type":22,"tag":435,"props":10043,"children":10044},{},[10045],{"type":28,"value":1732},{"type":22,"tag":435,"props":10047,"children":10048},{"class":437,"line":454},[10049],{"type":22,"tag":435,"props":10050,"children":10051},{},[10052],{"type":28,"value":10053},"    participant Node1\n",{"type":22,"tag":435,"props":10055,"children":10056},{"class":437,"line":463},[10057],{"type":22,"tag":435,"props":10058,"children":10059},{},[10060],{"type":28,"value":10061},"    participant Node2\n",{"type":22,"tag":435,"props":10063,"children":10064},{"class":437,"line":478},[10065],{"type":22,"tag":435,"props":10066,"children":10067},{},[10068],{"type":28,"value":10069},"    participant Node3\n",{"type":22,"tag":435,"props":10071,"children":10072},{"class":437,"line":499},[10073],{"type":22,"tag":435,"props":10074,"children":10075},{},[10076],{"type":28,"value":10077},"    participant Node4\n",{"type":22,"tag":435,"props":10079,"children":10080},{"class":437,"line":516},[10081],{"type":22,"tag":435,"props":10082,"children":10083},{"emptyLinePlaceholder":5},[10084],{"type":28,"value":460},{"type":22,"tag":435,"props":10086,"children":10087},{"class":437,"line":533},[10088],{"type":22,"tag":435,"props":10089,"children":10090},{},[10091],{"type":28,"value":10092},"    Note over Node1,Node4: 初始狀態 (領導者: Node1)\n",{"type":22,"tag":435,"props":10094,"children":10095},{"class":437,"line":550},[10096],{"type":22,"tag":435,"props":10097,"children":10098},{"emptyLinePlaceholder":5},[10099],{"type":28,"value":460},{"type":22,"tag":435,"props":10101,"children":10102},{"class":437,"line":559},[10103],{"type":22,"tag":435,"props":10104,"children":10105},{},[10106],{"type":28,"value":10107},"    alt 領導者失效\n",{"type":22,"tag":435,"props":10109,"children":10110},{"class":437,"line":567},[10111],{"type":22,"tag":435,"props":10112,"children":10113},{},[10114],{"type":28,"value":10115},"        Node1->>Node1: 領導者失效\n",{"type":22,"tag":435,"props":10117,"children":10118},{"class":437,"line":591},[10119],{"type":22,"tag":435,"props":10120,"children":10121},{},[10122],{"type":28,"value":6687},{"type":22,"tag":435,"props":10124,"children":10125},{"class":437,"line":606},[10126],{"type":22,"tag":435,"props":10127,"children":10128},{"emptyLinePlaceholder":5},[10129],{"type":28,"value":460},{"type":22,"tag":435,"props":10131,"children":10132},{"class":437,"line":615},[10133],{"type":22,"tag":435,"props":10134,"children":10135},{},[10136],{"type":28,"value":10137},"    Note over Node1,Node4: 紀元編號 1 開始\n",{"type":22,"tag":435,"props":10139,"children":10140},{"class":437,"line":636},[10141],{"type":22,"tag":435,"props":10142,"children":10143},{"emptyLinePlaceholder":5},[10144],{"type":28,"value":460},{"type":22,"tag":435,"props":10146,"children":10147},{"class":437,"line":650},[10148],{"type":22,"tag":435,"props":10149,"children":10150},{},[10151],{"type":28,"value":10152},"    Node2->>+Node3: 領導者失效，開始領導者選舉 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10154,"children":10155},{"class":437,"line":678},[10156],{"type":22,"tag":435,"props":10157,"children":10158},{},[10159],{"type":28,"value":10160},"    Node3->>+Node2: 投票給 Node2 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10162,"children":10163},{"class":437,"line":686},[10164],{"type":22,"tag":435,"props":10165,"children":10166},{},[10167],{"type":28,"value":10168},"    Node4->>+Node2: 投票給 Node2 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10170,"children":10171},{"class":437,"line":694},[10172],{"type":22,"tag":435,"props":10173,"children":10174},{"emptyLinePlaceholder":5},[10175],{"type":28,"value":460},{"type":22,"tag":435,"props":10177,"children":10178},{"class":437,"line":759},[10179],{"type":22,"tag":435,"props":10180,"children":10181},{},[10182],{"type":28,"value":10183},"    Note over Node2,Node4: Node2 以多數票當選為領導者\n",{"type":22,"tag":435,"props":10185,"children":10186},{"class":437,"line":783},[10187],{"type":22,"tag":435,"props":10188,"children":10189},{"emptyLinePlaceholder":5},[10190],{"type":28,"value":460},{"type":22,"tag":435,"props":10192,"children":10193},{"class":437,"line":837},[10194],{"type":22,"tag":435,"props":10195,"children":10196},{},[10197],{"type":28,"value":10198},"    Node2->>Node3: 提議值 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10200,"children":10201},{"class":437,"line":894},[10202],{"type":22,"tag":435,"props":10203,"children":10204},{},[10205],{"type":28,"value":10206},"    Node2->>Node4: 提議值 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10208,"children":10209},{"class":437,"line":971},[10210],{"type":22,"tag":435,"props":10211,"children":10212},{},[10213],{"type":28,"value":10214},"    Node3->>Node2: 贊成提議 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10216,"children":10217},{"class":437,"line":980},[10218],{"type":22,"tag":435,"props":10219,"children":10220},{},[10221],{"type":28,"value":10222},"    Node4->>Node2: 贊成提議 (紀元編號: 1)\n",{"type":22,"tag":435,"props":10224,"children":10225},{"class":437,"line":988},[10226],{"type":22,"tag":435,"props":10227,"children":10228},{"emptyLinePlaceholder":5},[10229],{"type":28,"value":460},{"type":22,"tag":435,"props":10231,"children":10232},{"class":437,"line":996},[10233],{"type":22,"tag":435,"props":10234,"children":10235},{},[10236],{"type":28,"value":10237},"    Note over Node2,Node4: 提議值被以多數票接受\n",{"type":22,"tag":435,"props":10239,"children":10240},{"class":437,"line":1064},[10241],{"type":22,"tag":435,"props":10242,"children":10243},{"emptyLinePlaceholder":5},[10244],{"type":28,"value":460},{"type":22,"tag":435,"props":10246,"children":10247},{"class":437,"line":1084},[10248],{"type":22,"tag":435,"props":10249,"children":10250},{},[10251],{"type":28,"value":10107},{"type":22,"tag":435,"props":10253,"children":10254},{"class":437,"line":1133},[10255],{"type":22,"tag":435,"props":10256,"children":10257},{},[10258],{"type":28,"value":10259},"        Node2->>Node2: 領導者失效\n",{"type":22,"tag":435,"props":10261,"children":10262},{"class":437,"line":1152},[10263],{"type":22,"tag":435,"props":10264,"children":10265},{},[10266],{"type":28,"value":6687},{"type":22,"tag":435,"props":10268,"children":10269},{"class":437,"line":1160},[10270],{"type":22,"tag":435,"props":10271,"children":10272},{"emptyLinePlaceholder":5},[10273],{"type":28,"value":460},{"type":22,"tag":435,"props":10275,"children":10276},{"class":437,"line":1168},[10277],{"type":22,"tag":435,"props":10278,"children":10279},{},[10280],{"type":28,"value":10281},"    Note over Node2,Node4: 紀元編號 2 開始\n",{"type":22,"tag":435,"props":10283,"children":10284},{"class":437,"line":1186},[10285],{"type":22,"tag":435,"props":10286,"children":10287},{"emptyLinePlaceholder":5},[10288],{"type":28,"value":460},{"type":22,"tag":435,"props":10290,"children":10291},{"class":437,"line":1222},[10292],{"type":22,"tag":435,"props":10293,"children":10294},{},[10295],{"type":28,"value":10296},"    alt Node1恢復\n",{"type":22,"tag":435,"props":10298,"children":10299},{"class":437,"line":1258},[10300],{"type":22,"tag":435,"props":10301,"children":10302},{},[10303],{"type":28,"value":10304},"        Node1->>Node1: Node1恢復\n",{"type":22,"tag":435,"props":10306,"children":10307},{"class":437,"line":1266},[10308],{"type":22,"tag":435,"props":10309,"children":10310},{},[10311],{"type":28,"value":6687},{"type":22,"tag":435,"props":10313,"children":10314},{"class":437,"line":1293},[10315],{"type":22,"tag":435,"props":10316,"children":10317},{"emptyLinePlaceholder":5},[10318],{"type":28,"value":460},{"type":22,"tag":435,"props":10320,"children":10321},{"class":437,"line":1328},[10322],{"type":22,"tag":435,"props":10323,"children":10324},{},[10325],{"type":28,"value":10326},"    Node1->>+Node3: 領導者失效，開始領導者選舉 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10328,"children":10329},{"class":437,"line":1364},[10330],{"type":22,"tag":435,"props":10331,"children":10332},{},[10333],{"type":28,"value":10334},"    Node3->>+Node1: 投票給 Node1 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10336,"children":10337},{"class":437,"line":1398},[10338],{"type":22,"tag":435,"props":10339,"children":10340},{},[10341],{"type":28,"value":10342},"    Node4->>+Node1: 投票給 Node1 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10344,"children":10345},{"class":437,"line":1432},[10346],{"type":22,"tag":435,"props":10347,"children":10348},{"emptyLinePlaceholder":5},[10349],{"type":28,"value":460},{"type":22,"tag":435,"props":10351,"children":10352},{"class":437,"line":1440},[10353],{"type":22,"tag":435,"props":10354,"children":10355},{},[10356],{"type":28,"value":10357},"    Note over Node1,Node4: Node1 以多數票當選為領導者\n",{"type":22,"tag":435,"props":10359,"children":10360},{"class":437,"line":1463},[10361],{"type":22,"tag":435,"props":10362,"children":10363},{"emptyLinePlaceholder":5},[10364],{"type":28,"value":460},{"type":22,"tag":435,"props":10366,"children":10367},{"class":437,"line":1484},[10368],{"type":22,"tag":435,"props":10369,"children":10370},{},[10371],{"type":28,"value":10372},"    Node1->>Node3: 提議值 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10374,"children":10375},{"class":437,"line":1515},[10376],{"type":22,"tag":435,"props":10377,"children":10378},{},[10379],{"type":28,"value":10380},"    Node1->>Node4: 提議值 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10382,"children":10383},{"class":437,"line":1523},[10384],{"type":22,"tag":435,"props":10385,"children":10386},{},[10387],{"type":28,"value":10388},"    Node3->>Node1: 贊成提議 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10390,"children":10391},{"class":437,"line":1540},[10392],{"type":22,"tag":435,"props":10393,"children":10394},{},[10395],{"type":28,"value":10396},"    Node4->>Node1: 贊成提議 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10398,"children":10399},{"class":437,"line":1548},[10400],{"type":22,"tag":435,"props":10401,"children":10402},{"emptyLinePlaceholder":5},[10403],{"type":28,"value":460},{"type":22,"tag":435,"props":10405,"children":10406},{"class":437,"line":1558},[10407],{"type":22,"tag":435,"props":10408,"children":10409},{},[10410],{"type":28,"value":10411},"    Note over Node1,Node4: 提議值被以多數票接受\n",{"type":22,"tag":435,"props":10413,"children":10414},{"class":437,"line":1567},[10415],{"type":22,"tag":435,"props":10416,"children":10417},{},[10418],{"type":28,"value":10419},"alt Node2恢復\n",{"type":22,"tag":435,"props":10421,"children":10422},{"class":437,"line":1576},[10423],{"type":22,"tag":435,"props":10424,"children":10425},{},[10426],{"type":28,"value":10427},"        Node2->>Node2: Node2恢復\n",{"type":22,"tag":435,"props":10429,"children":10430},{"class":437,"line":1585},[10431],{"type":22,"tag":435,"props":10432,"children":10433},{},[10434],{"type":28,"value":6687},{"type":22,"tag":435,"props":10436,"children":10437},{"class":437,"line":1594},[10438],{"type":22,"tag":435,"props":10439,"children":10440},{},[10441],{"type":28,"value":10442},"    alt 領導者衝突的解決\n",{"type":22,"tag":435,"props":10444,"children":10445},{"class":437,"line":1603},[10446],{"type":22,"tag":435,"props":10447,"children":10448},{},[10449],{"type":28,"value":10450},"        Node2->>Node1: 嘗試成為領導者 (紀元編號: 2)\n",{"type":22,"tag":435,"props":10452,"children":10453},{"class":437,"line":1612},[10454],{"type":22,"tag":435,"props":10455,"children":10456},{},[10457],{"type":28,"value":10458},"        Node1->>Node2: 以更高的紀元編號解決衝突 (紀元編號: 3)\n",{"type":22,"tag":435,"props":10460,"children":10461},{"class":437,"line":3533},[10462],{"type":22,"tag":435,"props":10463,"children":10464},{},[10465],{"type":28,"value":6687},{"type":22,"tag":435,"props":10467,"children":10468},{"class":437,"line":3558},[10469],{"type":22,"tag":435,"props":10470,"children":10471},{"emptyLinePlaceholder":5},[10472],{"type":28,"value":460},{"type":22,"tag":435,"props":10474,"children":10475},{"class":437,"line":3566},[10476],{"type":22,"tag":435,"props":10477,"children":10478},{},[10479],{"type":28,"value":10480},"    Note over Node1,Node4: Node1 保持為領導者\n",{"type":22,"tag":4383,"props":10482,"children":10483},{},[10484,10501,10518,10535,10552,10569,10586,10603,10620,10637],{"type":22,"tag":45,"props":10485,"children":10486},{},[10487,10492,10493],{"type":22,"tag":51,"props":10488,"children":10489},{},[10490],{"type":28,"value":10491},"初始狀態",{"type":28,"value":9946},{"type":22,"tag":41,"props":10494,"children":10495},{},[10496],{"type":22,"tag":45,"props":10497,"children":10498},{},[10499],{"type":28,"value":10500},"系統初始時，Node1 是領導者。",{"type":22,"tag":45,"props":10502,"children":10503},{},[10504,10509,10510],{"type":22,"tag":51,"props":10505,"children":10506},{},[10507],{"type":28,"value":10508},"領導者失效 (Node1)",{"type":28,"value":9946},{"type":22,"tag":41,"props":10511,"children":10512},{},[10513],{"type":22,"tag":45,"props":10514,"children":10515},{},[10516],{"type":28,"value":10517},"Node1 失效，系統進入紀元編號1。",{"type":22,"tag":45,"props":10519,"children":10520},{},[10521,10526,10527],{"type":22,"tag":51,"props":10522,"children":10523},{},[10524],{"type":28,"value":10525},"領導者選舉 (紀元編號 1)",{"type":28,"value":9946},{"type":22,"tag":41,"props":10528,"children":10529},{},[10530],{"type":22,"tag":45,"props":10531,"children":10532},{},[10533],{"type":28,"value":10534},"Node2、Node3 和 Node4 開始領導者選舉。Node3 和 Node4 投票給 Node2，Node2 以多數票當選為新的領導者。",{"type":22,"tag":45,"props":10536,"children":10537},{},[10538,10543,10544],{"type":22,"tag":51,"props":10539,"children":10540},{},[10541],{"type":28,"value":10542},"提議和投票 (紀元編號 1)",{"type":28,"value":9946},{"type":22,"tag":41,"props":10545,"children":10546},{},[10547],{"type":22,"tag":45,"props":10548,"children":10549},{},[10550],{"type":28,"value":10551},"Node2 提出一個提議值，並得到 Node3 和 Node4 的贊成，提議值被多數票接受。",{"type":22,"tag":45,"props":10553,"children":10554},{},[10555,10560,10561],{"type":22,"tag":51,"props":10556,"children":10557},{},[10558],{"type":28,"value":10559},"領導者失效 (Node2)",{"type":28,"value":9946},{"type":22,"tag":41,"props":10562,"children":10563},{},[10564],{"type":22,"tag":45,"props":10565,"children":10566},{},[10567],{"type":28,"value":10568},"Node2 失效，系統進入紀元編號2。",{"type":22,"tag":45,"props":10570,"children":10571},{},[10572,10577,10578],{"type":22,"tag":51,"props":10573,"children":10574},{},[10575],{"type":28,"value":10576},"Node1恢復",{"type":28,"value":9946},{"type":22,"tag":41,"props":10579,"children":10580},{},[10581],{"type":22,"tag":45,"props":10582,"children":10583},{},[10584],{"type":28,"value":10585},"Node1 恢復並參與接下來的領導者選舉。",{"type":22,"tag":45,"props":10587,"children":10588},{},[10589,10594,10595],{"type":22,"tag":51,"props":10590,"children":10591},{},[10592],{"type":28,"value":10593},"領導者選舉 (紀元編號 2)",{"type":28,"value":9946},{"type":22,"tag":41,"props":10596,"children":10597},{},[10598],{"type":22,"tag":45,"props":10599,"children":10600},{},[10601],{"type":28,"value":10602},"Node1、Node3 和 Node4 開始領導者選舉。Node3 和 Node4 投票給 Node1，Node1 以多數票當選為新的領導者。",{"type":22,"tag":45,"props":10604,"children":10605},{},[10606,10611,10612],{"type":22,"tag":51,"props":10607,"children":10608},{},[10609],{"type":28,"value":10610},"提議和投票 (紀元編號 2)",{"type":28,"value":9946},{"type":22,"tag":41,"props":10613,"children":10614},{},[10615],{"type":22,"tag":45,"props":10616,"children":10617},{},[10618],{"type":28,"value":10619},"Node1 提出一個提議值，並得到 Node3 和 Node4 的贊成，提議值被多數票接受。",{"type":22,"tag":45,"props":10621,"children":10622},{},[10623,10628,10629],{"type":22,"tag":51,"props":10624,"children":10625},{},[10626],{"type":28,"value":10627},"Node2恢復",{"type":28,"value":9946},{"type":22,"tag":41,"props":10630,"children":10631},{},[10632],{"type":22,"tag":45,"props":10633,"children":10634},{},[10635],{"type":28,"value":10636},"Node2 恢復並嘗試重新成為領導者。",{"type":22,"tag":45,"props":10638,"children":10639},{},[10640,10644,10645],{"type":22,"tag":51,"props":10641,"children":10642},{},[10643],{"type":28,"value":9979},{"type":28,"value":9946},{"type":22,"tag":41,"props":10646,"children":10647},{},[10648],{"type":22,"tag":45,"props":10649,"children":10650},{},[10651],{"type":28,"value":10652},"Node2 嘗試在紀元編號2成為領導者，但 Node1 以更高的紀元編號（3）回應，以解決領導者衝突，並保持為領導者。",{"type":22,"tag":30,"props":10654,"children":10656},{"id":10655},"共識的局限性",[10657],{"type":28,"value":10655},{"type":22,"tag":137,"props":10659,"children":10660},{},[10661],{"type":28,"value":10662},"共識演算法為分散式系統提供了基本的安全屬性，如一致同意、完整性和有效性，並在多數節點正常運作時保持容錯和進展。但它有其侷限性：",{"type":22,"tag":4383,"props":10664,"children":10665},{},[10666,10676,10686,10696,10706],{"type":22,"tag":45,"props":10667,"children":10668},{},[10669,10674],{"type":22,"tag":51,"props":10670,"children":10671},{},[10672],{"type":28,"value":10673},"同步複製問題",{"type":28,"value":10675},"：共識演算法依賴同步複製來確保一致性，與常見的非同步複製相比，可能會在效能上有所損失。",{"type":22,"tag":45,"props":10677,"children":10678},{},[10679,10684],{"type":22,"tag":51,"props":10680,"children":10681},{},[10682],{"type":28,"value":10683},"節點數量要求",{"type":28,"value":10685},"：至少需要三個節點以容忍單節點故障，五個節點以容忍兩個節點故障。如果網路故障導致節點間連線中斷，只有多數節點所在的網路能繼續運作。",{"type":22,"tag":45,"props":10687,"children":10688},{},[10689,10694],{"type":22,"tag":51,"props":10690,"children":10691},{},[10692],{"type":28,"value":10693},"固定節點集合",{"type":28,"value":10695},"：多數共識演算法假設參與投票的節點是固定的，雖然有動態成員擴充套件，但理解和實施較為困難。",{"type":22,"tag":45,"props":10697,"children":10698},{},[10699,10704],{"type":22,"tag":51,"props":10700,"children":10701},{},[10702],{"type":28,"value":10703},"超時檢測的依賴",{"type":28,"value":10705},"：共識系統依賴超時來檢測失效節點，但在網路延遲高度變化的環境中可能會導致錯誤的失效檢測和領導者選舉，影響效能。",{"type":22,"tag":45,"props":10707,"children":10708},{},[10709,10714],{"type":22,"tag":51,"props":10710,"children":10711},{},[10712],{"type":28,"value":10713},"對網路問題的敏感性",{"type":28,"value":10715},"：例如，Raft 在特定的網路連線不可靠時可能會出現領導者頻繁切換的問題，影響系統進展。這類問題在其他一致性演算法中也存在，而設計能夠健壯應對不可靠網路的演算法仍是開放的研究領域。",{"type":22,"tag":137,"props":10717,"children":10718},{},[10719],{"type":28,"value":10720},"Raft：",{"type":22,"tag":137,"props":10722,"children":10723},{},[10724,10729,10731,10738,10740,10747,10749,10754,10756,10763,10770,10772,10779,10781,10788,10790,10797,10799,10806,10807,10814,10816,10823,10825],{"type":22,"tag":51,"props":10725,"children":10726},{},[10727],{"type":28,"value":10728},"Raft",{"type":28,"value":10730},"是一種用於替代",{"type":22,"tag":55,"props":10732,"children":10735},{"href":10733,"rel":10734},"https://zh.wikipedia.org/wiki/Paxos",[59],[10736],{"type":28,"value":10737},"Paxos",{"type":28,"value":10739},"的",{"type":22,"tag":55,"props":10741,"children":10744},{"href":10742,"rel":10743},"https://zh.wikipedia.org/wiki/%E5%85%B1%E8%AD%98%E6%A9%9F%E5%88%B6",[59],[10745],{"type":28,"value":10746},"共識",{"type":28,"value":10748},"演算法。相比於",{"type":22,"tag":55,"props":10750,"children":10752},{"href":10733,"rel":10751},[59],[10753],{"type":28,"value":10737},{"type":28,"value":10755},"，Raft的目標是提供更清晰的邏輯分工使得演算法本身能被更好地理解，同時它安全性更高，並能提供一些額外的特性。",{"type":22,"tag":55,"props":10757,"children":10760},{"href":10758,"rel":10759},"https://zh.wikipedia.org/wiki/Raft#cite_note-raft-1",[59],[10761],{"type":28,"value":10762},"[1]",{"type":22,"tag":55,"props":10764,"children":10767},{"href":10765,"rel":10766},"https://zh.wikipedia.org/wiki/Raft#cite_note-raft-paper-2",[59],[10768],{"type":28,"value":10769},"[2]",{"type":28,"value":10771},":1Raft能為在",{"type":22,"tag":55,"props":10773,"children":10776},{"href":10774,"rel":10775},"https://zh.wikipedia.org/wiki/%E8%AE%A1%E7%AE%97%E6%9C%BA%E9%9B%86%E7%BE%A4",[59],[10777],{"type":28,"value":10778},"電腦叢集",{"type":28,"value":10780},"之間部署",{"type":22,"tag":55,"props":10782,"children":10785},{"href":10783,"rel":10784},"https://zh.wikipedia.org/wiki/%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA",[59],[10786],{"type":28,"value":10787},"有限狀態機",{"type":28,"value":10789},"提供一種通用方法，並確保叢集內的任意節點在某種狀態轉換上保持一致。Raft演算法的開源實現眾多，在",{"type":22,"tag":55,"props":10791,"children":10794},{"href":10792,"rel":10793},"https://zh.wikipedia.org/wiki/Go",[59],[10795],{"type":28,"value":10796},"Go",{"type":28,"value":10798},"、",{"type":22,"tag":55,"props":10800,"children":10803},{"href":10801,"rel":10802},"https://zh.wikipedia.org/wiki/C%2B%2B",[59],[10804],{"type":28,"value":10805},"C++",{"type":28,"value":10798},{"type":22,"tag":55,"props":10808,"children":10811},{"href":10809,"rel":10810},"https://zh.wikipedia.org/wiki/Java",[59],[10812],{"type":28,"value":10813},"Java",{"type":28,"value":10815},"以及 ",{"type":22,"tag":55,"props":10817,"children":10820},{"href":10818,"rel":10819},"https://zh.wikipedia.org/wiki/Scala",[59],[10821],{"type":28,"value":10822},"Scala",{"type":28,"value":10824},"中都有完整的代碼實現。Raft這一名字來源於\"Reliable, Replicated, Redundant, And Fault-Tolerant\"（「可靠、可複製、可冗餘、可容錯」）的首字母縮寫。",{"type":22,"tag":55,"props":10826,"children":10829},{"href":10827,"rel":10828},"https://zh.wikipedia.org/wiki/Raft#cite_note-3",[59],[10830],{"type":28,"value":10831},"[3]",{"type":22,"tag":137,"props":10833,"children":10834},{},[10835,10837,10844,10846],{"type":28,"value":10836},"叢集內的節點都對選舉出的領袖採取信任，因此Raft不是一種",{"type":22,"tag":55,"props":10838,"children":10841},{"href":10839,"rel":10840},"https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B0%86%E5%86%9B%E9%97%AE%E9%A2%98",[59],[10842],{"type":28,"value":10843},"拜占庭容錯",{"type":28,"value":10845},"演算法。",{"type":22,"tag":55,"props":10847,"children":10849},{"href":10765,"rel":10848},[59],[10850],{"type":28,"value":10769},{"type":22,"tag":137,"props":10852,"children":10853},{},[10854],{"type":28,"value":10855},"拜占庭將軍問題：",{"type":22,"tag":137,"props":10857,"children":10858},{},[10859,10861,10868],{"type":28,"value":10860},"一組",{"type":22,"tag":55,"props":10862,"children":10865},{"href":10863,"rel":10864},"https://zh.wikipedia.org/wiki/%E6%8B%9C%E5%8D%A0%E5%BA%AD%E5%B8%9D%E5%9C%8B",[59],[10866],{"type":28,"value":10867},"拜占庭",{"type":28,"value":10869},"將軍分別各率領一支軍隊共同圍困一座城市。為了簡化問題，將各支軍隊的行動策略限定為進攻或撤離兩種。因為部分軍隊進攻部分軍隊撤離可能會造成災難性後果，因此各位將軍必須通過投票來達成一致策略，即所有軍隊一起進攻或所有軍隊一起撤離。因為各位將軍分處城市不同方向，他們只能通過信使互相聯絡。在投票過程中每位將軍都將自己投票給進攻還是撤退的資訊通過信使分別通知其他所有將軍，這樣一來每位將軍根據自己的投票和其他所有將軍送來的資訊就可以知道共同的投票結果而決定行動策略。",{"type":22,"tag":30,"props":10871,"children":10873},{"id":10872},"成員與協調服務",[10874],{"type":28,"value":10872},{"type":22,"tag":137,"props":10876,"children":10877},{},[10878],{"type":28,"value":300},{"type":22,"tag":137,"props":10880,"children":10881},{},[10882],{"type":28,"value":10883},"ZooKeeper 和 etcd 被設計為容納少量完全可以放在記憶體中的資料（雖然它們仍然會寫入磁碟以保證永續性），所以你不會想著把所有應用資料放到這裡。這些少量資料會透過容錯的全序廣播演算法複製到所有節點上。正如前面所討論的那樣，資料庫複製需要的就是全序廣播：如果每條訊息代表對資料庫的寫入，則以相同的順序應用相同的寫入操作可以使副本之間保持一致。",{"type":22,"tag":41,"props":10885,"children":10886},{},[10887,10915,10953,10970],{"type":22,"tag":45,"props":10888,"children":10889},{},[10890,10892,10895,10897,10902,10904,10914],{"type":28,"value":10891},"線性一致性的原子操作",{"type":22,"tag":4117,"props":10893,"children":10894},{},[],{"type":28,"value":10896},"使用原子 CAS 操作可以實現鎖：如果多個節點同時嘗試執行相同的操作，只有一個節點會成功。共識協議保證了操作的原子性和線性一致性，即使節點發生故障或網路在任意時刻中斷。分散式鎖通常以 ",{"type":22,"tag":51,"props":10898,"children":10899},{},[10900],{"type":28,"value":10901},"租約（lease）",{"type":28,"value":10903}," 的形式實現，租約有一個到期時間，以便在客戶端失效的情況下最終能被釋放（請參閱 “",{"type":22,"tag":51,"props":10905,"children":10906},{},[10907],{"type":22,"tag":55,"props":10908,"children":10911},{"href":10909,"rel":10910},"https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e7%a8%8b%e5%ba%8f%e6%9a%ab%e5%81%9c",[59],[10912],{"type":28,"value":10913},"程序暫停",{"type":28,"value":4455},{"type":22,"tag":45,"props":10916,"children":10917},{},[10918,10920,10923,10925,10935,10937,10943,10945,10951],{"type":28,"value":10919},"操作的全序排序",{"type":22,"tag":4117,"props":10921,"children":10922},{},[],{"type":28,"value":10924},"如 “",{"type":22,"tag":51,"props":10926,"children":10927},{},[10928],{"type":22,"tag":55,"props":10929,"children":10932},{"href":10930,"rel":10931},"https://vonng.github.io/ddia/#/zh-tw/ch8?id=%e9%a0%98%e5%b0%8e%e8%80%85%e5%92%8c%e9%8e%96",[59],[10933],{"type":28,"value":10934},"領導者和鎖",{"type":28,"value":10936},"” 中所述，當某個資源受到鎖或租約的保護時，你需要一個防護令牌來防止客戶端在程序暫停的情況下彼此衝突。防護令牌是每次鎖被獲取時單調增加的數字。ZooKeeper 透過全序化所有操作來提供這個功能，它為每個操作提供一個單調遞增的事務 ID（",{"type":22,"tag":431,"props":10938,"children":10940},{"className":10939},[],[10941],{"type":28,"value":10942},"zxid",{"type":28,"value":10944},"）和版本號（",{"type":22,"tag":431,"props":10946,"children":10948},{"className":10947},[],[10949],{"type":28,"value":10950},"cversion",{"type":28,"value":10952},"）【15】。",{"type":22,"tag":45,"props":10954,"children":10955},{},[10956,10958,10961,10963,10968],{"type":28,"value":10957},"失效檢測",{"type":22,"tag":4117,"props":10959,"children":10960},{},[],{"type":28,"value":10962},"客戶端在 ZooKeeper 伺服器上維護一個長期會話，客戶端和伺服器週期性地交換心跳包來檢查節點是否還活著。即使連線暫時中斷，或者 ZooKeeper 節點失效，會話仍保持在活躍狀態。但如果心跳停止的持續時間超出會話超時，ZooKeeper 會宣告該會話已死亡。當會話超時時（ZooKeeper 稱這些節點為 ",{"type":22,"tag":51,"props":10964,"children":10965},{},[10966],{"type":28,"value":10967},"臨時節點",{"type":28,"value":10969},"，即 ephemeral nodes），會話持有的任何鎖都可以配置為自動釋放。",{"type":22,"tag":45,"props":10971,"children":10972},{},[10973,10975,10978],{"type":28,"value":10974},"變更通知",{"type":22,"tag":4117,"props":10976,"children":10977},{},[],{"type":28,"value":10979},"客戶端不僅可以讀取其他客戶端建立的鎖和值，還可以監聽它們的變更。因此，客戶端可以知道另一個客戶端何時加入叢集（基於新客戶端寫入 ZooKeeper 的值），或發生故障（因其會話超時，而其臨時節點消失）。透過訂閱通知，客戶端不用再透過頻繁輪詢的方式來找出變更。",{"type":22,"tag":137,"props":10981,"children":10982},{},[10983],{"type":28,"value":10984},"在這些功能中，只有線性一致的原子操作才真的需要共識。但正是這些功能的組合，使得像 ZooKeeper 這樣的系統在分散式協調中非常有用。",{"type":22,"tag":137,"props":10986,"children":10987},{},[10988],{"type":28,"value":4330},{"type":22,"tag":137,"props":10990,"children":10991},{},[10992],{"type":28,"value":10993},"在使用分散式資料庫時其實要考慮哪些資訊是必須線性一致性的，如果需要線性一致性的資料再放入像是ZooKeeper這種分散式資料庫保證線性一致性的原子操作。或是說如果是最終一致性的內容就不需要放到這種分散式資料庫的架構讓node之間彼此慢慢溝通就好了。",{"type":22,"tag":30,"props":10995,"children":10997},{"id":10996},"將工作分配給節點",[10998],{"type":28,"value":10996},{"type":22,"tag":137,"props":11000,"children":11001},{},[11002],{"type":28,"value":11003},"ZooKeeper/Chubby 模型執行良好的一個例子是，如果你有幾個程序例項或服務，需要選擇其中一個例項作為主庫或首選服務。如果領導者失敗，其他節點之一應該接管。這對單主資料庫當然非常實用，但對作業排程程式和類似的有狀態系統也很好用。",{"type":22,"tag":4383,"props":11005,"children":11006},{},[11007,11024,11041,11058,11075,11092,11109],{"type":22,"tag":45,"props":11008,"children":11009},{},[11010,11015,11016],{"type":22,"tag":51,"props":11011,"children":11012},{},[11013],{"type":28,"value":11014},"領導者選舉與失敗恢復",{"type":28,"value":6839},{"type":22,"tag":41,"props":11017,"children":11018},{},[11019],{"type":22,"tag":45,"props":11020,"children":11021},{},[11022],{"type":28,"value":11023},"ZooKeeper或Chubby模型可以用於選擇主節點或首選服務，並在主節點失效時由其他節點接管，這在單主資料庫、作業排程系統和其他有狀態系統中非常實用。",{"type":22,"tag":45,"props":11025,"children":11026},{},[11027,11032,11033],{"type":22,"tag":51,"props":11028,"children":11029},{},[11030],{"type":28,"value":11031},"資源分割槽的分配與再平衡",{"type":28,"value":6839},{"type":22,"tag":41,"props":11034,"children":11035},{},[11036],{"type":22,"tag":45,"props":11037,"children":11038},{},[11039],{"type":28,"value":11040},"通過使用ZooKeeper，可以決定將哪個分割槽分配給哪個節點，並在新節點加入或節點失效時重新平衡負載。",{"type":22,"tag":45,"props":11042,"children":11043},{},[11044,11049,11050],{"type":22,"tag":51,"props":11045,"children":11046},{},[11047],{"type":28,"value":11048},"原子操作、臨時節點與通知",{"type":28,"value":6839},{"type":22,"tag":41,"props":11051,"children":11052},{},[11053],{"type":22,"tag":45,"props":11054,"children":11055},{},[11056],{"type":28,"value":11057},"ZooKeeper提供了原子操作、臨時節點和通知功能，有助於實現分割槽的再平衡和失效節點的工作接管，並能讓系統自動從故障中恢復。",{"type":22,"tag":45,"props":11059,"children":11060},{},[11061,11066,11067],{"type":22,"tag":51,"props":11062,"children":11063},{},[11064],{"type":28,"value":11065},"高層工具的支援",{"type":28,"value":6839},{"type":22,"tag":41,"props":11068,"children":11069},{},[11070],{"type":22,"tag":45,"props":11071,"children":11072},{},[11073],{"type":28,"value":11074},"例如Apache Curator，它是基於ZooKeeper客戶端API而提供更高層的工具，降低了從頭實現共識演算法的困難和風險。",{"type":22,"tag":45,"props":11076,"children":11077},{},[11078,11083,11084],{"type":22,"tag":51,"props":11079,"children":11080},{},[11081],{"type":28,"value":11082},"協調節點的外包",{"type":28,"value":6839},{"type":22,"tag":41,"props":11085,"children":11086},{},[11087],{"type":22,"tag":45,"props":11088,"children":11089},{},[11090],{"type":28,"value":11091},"ZooKeeper允許在固定數量的節點上執行多數票選舉，而非在數千個節點上，並“外包”一些協調節點的工作，如共識、操作排序和故障檢測，以支援大量的客戶端。",{"type":22,"tag":45,"props":11093,"children":11094},{},[11095,11100,11101],{"type":22,"tag":51,"props":11096,"children":11097},{},[11098],{"type":28,"value":11099},"資料型別的緩慢變化",{"type":28,"value":6839},{"type":22,"tag":41,"props":11102,"children":11103},{},[11104],{"type":22,"tag":45,"props":11105,"children":11106},{},[11107],{"type":28,"value":11108},"ZooKeeper適合管理變化緩慢的資料，而不是每秒會改變數千或數百萬次的執行時狀態資料。",{"type":22,"tag":45,"props":11110,"children":11111},{},[11112,11117,11118],{"type":22,"tag":51,"props":11113,"children":11114},{},[11115],{"type":28,"value":11116},"其他工具的配合",{"type":28,"value":6839},{"type":22,"tag":41,"props":11119,"children":11120},{},[11121],{"type":22,"tag":45,"props":11122,"children":11123},{},[11124],{"type":28,"value":11125},"如Apache BookKeeper，可以用於複製應用狀態，與ZooKeeper配合使用，提供更完整的分散式系統解決方案。",{"type":22,"tag":137,"props":11127,"children":11128},{},[11129],{"type":28,"value":4330},{"type":22,"tag":137,"props":11131,"children":11132},{},[11133],{"type":28,"value":11134},"各種工具特性與應用方式",{"type":22,"tag":30,"props":11136,"children":11138},{"id":11137},"服務發現",[11139],{"type":28,"value":11137},{"type":22,"tag":4383,"props":11141,"children":11142},{},[11143,11159,11176,11192],{"type":22,"tag":45,"props":11144,"children":11145},{},[11146,11150,11151],{"type":22,"tag":51,"props":11147,"children":11148},{},[11149],{"type":28,"value":11137},{"type":28,"value":9946},{"type":22,"tag":41,"props":11152,"children":11153},{},[11154],{"type":22,"tag":45,"props":11155,"children":11156},{},[11157],{"type":28,"value":11158},"ZooKeeper、etcd 和 Consul 常用於服務發現，即確定連接到特定服務所需的 IP 地址。在雲資料中心，由於虛擬機器的動態性，服務的 IP 地址通常不是事先知道的。服務可配置為在啟動時註冊其網路端點，以便其他服務能夠找到它們。",{"type":22,"tag":45,"props":11160,"children":11161},{},[11162,11167,11168],{"type":22,"tag":51,"props":11163,"children":11164},{},[11165],{"type":28,"value":11166},"共識與服務發現",{"type":28,"value":9946},{"type":22,"tag":41,"props":11169,"children":11170},{},[11171],{"type":22,"tag":45,"props":11172,"children":11173},{},[11174],{"type":28,"value":11175},"服務發現不一定需要共識，而是更重視可用性和對網路中斷的魯棒性。傳統上，DNS 用於查詢服務的 IP 地址，並通過多層快取來提高效能和可用性，它不保證線性一致性。",{"type":22,"tag":45,"props":11177,"children":11178},{},[11179,11183,11184],{"type":22,"tag":51,"props":11180,"children":11181},{},[11182],{"type":28,"value":9962},{"type":28,"value":9946},{"type":22,"tag":41,"props":11185,"children":11186},{},[11187],{"type":22,"tag":45,"props":11188,"children":11189},{},[11190],{"type":28,"value":11191},"與服務發現不同，領導者選舉需要共識。如果共識系統已經識別出領導者，這些資訊可以用於幫助其他服務找出領導者。",{"type":22,"tag":45,"props":11193,"children":11194},{},[11195,11200,11201],{"type":22,"tag":51,"props":11196,"children":11197},{},[11198],{"type":28,"value":11199},"只讀快取副本",{"type":28,"value":9946},{"type":22,"tag":41,"props":11202,"children":11203},{},[11204],{"type":22,"tag":45,"props":11205,"children":11206},{},[11207],{"type":28,"value":11208},"一些共識系統支援只讀快取副本，這些副本能非同步接收共識演算法的所有決策日誌，但不參與投票，從而能夠處理不需要線性一致性的讀取請求，降低了需求共識的情境，同時保持了系統的效能與可用性。",{"type":22,"tag":30,"props":11210,"children":11212},{"id":11211},"成員資格服務",[11213],{"type":28,"value":11211},{"type":22,"tag":4383,"props":11215,"children":11216},{},[11217,11234,11251],{"type":22,"tag":45,"props":11218,"children":11219},{},[11220,11225,11226],{"type":22,"tag":51,"props":11221,"children":11222},{},[11223],{"type":28,"value":11224},"成員資格服務的核心功能",{"type":28,"value":9946},{"type":22,"tag":41,"props":11227,"children":11228},{},[11229],{"type":22,"tag":45,"props":11230,"children":11231},{},[11232],{"type":28,"value":11233},"它主要用於確定哪些節點目前是活動的，並且是叢集的活動成員。由於無限的網路延遲，無法可靠地檢測到另一個節點是否失效，但通過共識，節點可以達成一致意見，決定哪些節點應被認為是存在或不存在。",{"type":22,"tag":45,"props":11235,"children":11236},{},[11237,11242,11243],{"type":22,"tag":51,"props":11238,"children":11239},{},[11240],{"type":28,"value":11241},"共識在故障檢測中的角色",{"type":28,"value":9946},{"type":22,"tag":41,"props":11244,"children":11245},{},[11246],{"type":22,"tag":45,"props":11247,"children":11248},{},[11249],{"type":28,"value":11250},"透過共識來進行故障檢測可以協助節點就哪些節點是存在或不存在達成一致。雖然可能會有節點被錯誤地宣告死亡，但對系統來說，知道哪些節點是當前的成員是非常有用的。",{"type":22,"tag":45,"props":11252,"children":11253},{},[11254,11259,11260],{"type":22,"tag":51,"props":11255,"children":11256},{},[11257],{"type":28,"value":11258},"領導者選舉與成員資格",{"type":28,"value":9946},{"type":22,"tag":41,"props":11261,"children":11262},{},[11263],{"type":22,"tag":45,"props":11264,"children":11265},{},[11266],{"type":28,"value":11267},"在選擇領導者時，例如可能簡單地選擇當前成員中編號最小的成員。但如果不同的節點對現有成員有不同的意見，這種方法將不起作用。成員資格服務確保節點對叢集的現有成員有一致的理解，從而促進了有效的領導者選舉。",{"type":22,"tag":30,"props":11269,"children":11271},{"id":11270},"_95-本章小結",[11272],{"type":28,"value":11273},"9.5 本章小結",{"type":22,"tag":137,"props":11275,"children":11276},{},[11277],{"type":28,"value":11278},"達成共識意味著以這樣一種方式決定某件事：所有節點一致同意所做決定，且這一決定不可撤銷。透過深入挖掘，結果我們發現很廣泛的一系列問題實際上都可以歸結為共識問題，並且彼此等價（從這個意義上來講，如果你有其中之一的解決方案，就可以輕易將它轉換為其他問題的解決方案）。這些等價的問題包括：",{"type":22,"tag":41,"props":11280,"children":11281},{},[11282,11299,11315,11330,11346,11362],{"type":22,"tag":45,"props":11283,"children":11284},{},[11285,11287,11290,11292,11297],{"type":28,"value":11286},"線性一致性的 CAS 暫存器",{"type":22,"tag":4117,"props":11288,"children":11289},{},[],{"type":28,"value":11291},"暫存器需要基於當前值是否等於操作給出的引數，原子地 ",{"type":22,"tag":51,"props":11293,"children":11294},{},[11295],{"type":28,"value":11296},"決定",{"type":28,"value":11298}," 是否設定新值。",{"type":22,"tag":45,"props":11300,"children":11301},{},[11302,11304,11307,11309,11313],{"type":28,"value":11303},"原子事務提交",{"type":22,"tag":4117,"props":11305,"children":11306},{},[],{"type":28,"value":11308},"資料庫必須 ",{"type":22,"tag":51,"props":11310,"children":11311},{},[11312],{"type":28,"value":11296},{"type":28,"value":11314}," 是否提交或中止分散式事務。",{"type":22,"tag":45,"props":11316,"children":11317},{},[11318,11319,11322,11324,11328],{"type":28,"value":6769},{"type":22,"tag":4117,"props":11320,"children":11321},{},[],{"type":28,"value":11323},"訊息系統必須 ",{"type":22,"tag":51,"props":11325,"children":11326},{},[11327],{"type":28,"value":11296},{"type":28,"value":11329}," 傳遞訊息的順序。",{"type":22,"tag":45,"props":11331,"children":11332},{},[11333,11335,11338,11340,11344],{"type":28,"value":11334},"鎖和租約",{"type":22,"tag":4117,"props":11336,"children":11337},{},[],{"type":28,"value":11339},"當幾個客戶端爭搶鎖或租約時，由鎖來 ",{"type":22,"tag":51,"props":11341,"children":11342},{},[11343],{"type":28,"value":11296},{"type":28,"value":11345}," 哪個客戶端成功獲得鎖。",{"type":22,"tag":45,"props":11347,"children":11348},{},[11349,11351,11354,11356,11360],{"type":28,"value":11350},"成員 / 協調服務",{"type":22,"tag":4117,"props":11352,"children":11353},{},[],{"type":28,"value":11355},"給定某種故障檢測器（例如超時），系統必須 ",{"type":22,"tag":51,"props":11357,"children":11358},{},[11359],{"type":28,"value":11296},{"type":28,"value":11361}," 哪些節點活著，哪些節點因為會話超時需要被宣告死亡。",{"type":22,"tag":45,"props":11363,"children":11364},{},[11365,11367,11370,11372,11376],{"type":28,"value":11366},"唯一性約束",{"type":22,"tag":4117,"props":11368,"children":11369},{},[],{"type":28,"value":11371},"當多個事務同時嘗試使用相同的鍵建立衝突記錄時，約束必須 ",{"type":22,"tag":51,"props":11373,"children":11374},{},[11375],{"type":28,"value":11296},{"type":28,"value":11377}," 哪一個被允許，哪些因為違反約束而失敗。",{"type":22,"tag":137,"props":11379,"children":11380},{},[11381],{"type":28,"value":11382},"如果領導者失效，或者如果網路中斷導致領導者不可達，這樣的系統就無法取得任何進展。應對這種情況可以有三種方法：",{"type":22,"tag":4383,"props":11384,"children":11385},{},[11386,11397,11402],{"type":22,"tag":45,"props":11387,"children":11388},{},[11389,11391,11395],{"type":28,"value":11390},"等待領導者恢復，接受系統將在這段時間阻塞的事實。許多 XA/JTA 事務協調者選擇這個選項。這種方法並不能完全達成共識，因為它不能滿足 ",{"type":22,"tag":51,"props":11392,"children":11393},{},[11394],{"type":28,"value":9876},{"type":28,"value":11396}," 屬性的要求：如果領導者續命失敗，系統可能會永久阻塞。",{"type":22,"tag":45,"props":11398,"children":11399},{},[11400],{"type":28,"value":11401},"人工故障切換，讓人類選擇一個新的領導者節點，並重新配置系統使之生效，許多關係型資料庫都採用這種方方式。這是一種來自 “天意” 的共識 —— 由計算機系統之外的運維人員做出決定。故障切換的速度受到人類行動速度的限制，通常要比計算機慢（得多）。",{"type":22,"tag":45,"props":11403,"children":11404},{},[11405],{"type":28,"value":11406},"使用演算法自動選擇一個新的領導者。這種方法需要一種共識演算法，使用成熟的演算法來正確處理惡劣的網路條件是明智之舉【107】。",{"type":22,"tag":11408,"props":11409,"children":11410},"style",{},[11411],{"type":28,"value":11412},"html .dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html.dark .shiki span {color: var(--shiki-dark);background: var(--shiki-dark-bg);font-style: var(--shiki-dark-font-style);font-weight: var(--shiki-dark-font-weight);text-decoration: var(--shiki-dark-text-decoration);}html .default .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .shiki span {color: var(--shiki-default);background: var(--shiki-default-bg);font-style: var(--shiki-default-font-style);font-weight: var(--shiki-default-font-weight);text-decoration: var(--shiki-default-text-decoration);}html .sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}html.sepia .shiki span {color: var(--shiki-sepia);background: var(--shiki-sepia-bg);font-style: var(--shiki-sepia-font-style);font-weight: var(--shiki-sepia-font-weight);text-decoration: var(--shiki-sepia-text-decoration);}",{"title":13,"searchDepth":454,"depth":454,"links":11414},[11415,11416,11417,11418,11419,11426,11433,11436,11440,11441,11447,11452,11457,11458,11459,11462,11463,11464,11465,11466,11467,11468,11469,11470,11471,11472,11473,11474,11475,11476,11477,11478,11479,11480,11481],{"id":32,"depth":454,"text":32},{"id":37,"depth":454,"text":37},{"id":132,"depth":454,"text":135},{"id":292,"depth":454,"text":295},{"id":375,"depth":454,"text":378,"children":11420},[11421,11422,11424,11425],{"id":420,"depth":463,"text":420},{"id":1688,"depth":463,"text":11423},"第七章CAS(Compare and Swap)的解釋 *補全",{"id":1945,"depth":463,"text":420},{"id":2458,"depth":463,"text":420},{"id":3810,"depth":454,"text":3810,"children":11427},[11428,11429,11430,11431],{"id":3824,"depth":463,"text":3824},{"id":3842,"depth":463,"text":3842},{"id":3912,"depth":463,"text":3912},{"id":4018,"depth":463,"text":11432},"第五章Read-Your-Writes Consistency ~~*補全~~",{"id":4080,"depth":454,"text":4080,"children":11434},[11435],{"id":4338,"depth":463,"text":4338},{"id":4417,"depth":454,"text":4417,"children":11437},[11438,11439],{"id":4508,"depth":463,"text":4519},{"id":4614,"depth":463,"text":4614},{"id":4652,"depth":454,"text":4655},{"id":4764,"depth":454,"text":11442,"children":11443},"順序與因果關係(因果一致性 causally consistent)",[11444,11445,11446],{"id":5057,"depth":463,"text":5057},{"id":5527,"depth":463,"text":5527},{"id":5550,"depth":463,"text":5550},{"id":5603,"depth":454,"text":5603,"children":11448},[11449,11450,11451],{"id":5742,"depth":463,"text":5742},{"id":6295,"depth":463,"text":6295},{"id":6441,"depth":463,"text":6441},{"id":6769,"depth":454,"text":6769,"children":11453},[11454,11455,11456],{"id":6895,"depth":463,"text":6895},{"id":7013,"depth":463,"text":7013},{"id":7141,"depth":463,"text":7141},{"id":7722,"depth":454,"text":7725},{"id":7757,"depth":454,"text":7757},{"id":7771,"depth":454,"text":7771,"children":11460},[11461],{"id":7800,"depth":463,"text":7800},{"id":8281,"depth":454,"text":8281},{"id":8397,"depth":454,"text":8397},{"id":8662,"depth":454,"text":8662},{"id":8855,"depth":454,"text":8855},{"id":8880,"depth":454,"text":8880},{"id":8944,"depth":454,"text":8944},{"id":8954,"depth":454,"text":8957},{"id":9300,"depth":454,"text":9300},{"id":9491,"depth":454,"text":9491},{"id":9518,"depth":454,"text":9518},{"id":9543,"depth":454,"text":9543},{"id":9808,"depth":454,"text":9808},{"id":9902,"depth":454,"text":9902},{"id":9931,"depth":454,"text":9931},{"id":10655,"depth":454,"text":10655},{"id":10872,"depth":454,"text":10872},{"id":10996,"depth":454,"text":10996},{"id":11137,"depth":454,"text":11137},{"id":11211,"depth":454,"text":11211},{"id":11270,"depth":454,"text":11273},"markdown","content:5.ddia:9.chapter9.md","content","5.ddia/9.chapter9.md","5.ddia/9.chapter9","md","default",["ShallowRef",11490],["ShallowReactive",11491],{"/ddia/chapter9":11492},[11493,11502],{"_path":11494,"_dir":12,"_draft":6,"_partial":6,"_locale":13,"title":11495,"description":13,"pageTitle":11496,"contributors":11497,"_type":11482,"_id":11499,"_source":11484,"_file":11500,"_stem":11501,"_extension":11487},"/ddia/chapter5","05 複製","Chapter 05 複製",[11498],"pomeloJ","content:5.ddia:5.chapter5.md","5.ddia/5.chapter5.md","5.ddia/5.chapter5",{"_path":11503,"_dir":11504,"_draft":6,"_partial":6,"_locale":13,"title":11505,"description":13,"pageTitle":11506,"contributors":11507,"_type":11482,"_id":11509,"_source":11484,"_file":11510,"_stem":11511,"_extension":11487},"/clean-arch/chapter1","clean-arch","01 什麼是設計與結構","Chapter 1 什麼是設計與結構",[11508],"changemyminds","content:6.clean-arch:1.chapter1.md","6.clean-arch/1.chapter1.md","6.clean-arch/1.chapter1",["ShallowRef",11513],{},[11515,11529,11552,11566,11598,11614,11692],{"title":11516,"_path":11517,"children":11518,"icon":11528},"API","/api",[11519,11522,11525],{"title":11520,"_path":11521},"Components","/api/components",{"title":11523,"_path":11524},"Composables","/api/composables",{"title":11526,"_path":11527},"Layouts","/api/layouts","🛡️",{"title":11530,"_path":11531,"children":11532,"icon":11551},"技術分享","/workshop",[11533,11536,11539,11542,11545,11548],{"title":11534,"_path":11535},"使用Gitlab做CI/CD","/workshop/gitlab-cicd",{"title":11537,"_path":11538},"gRPC快速入門","/workshop/grpc",{"title":11540,"_path":11541},"Liquibase快速入門","/workshop/liquibase",{"title":11543,"_path":11544},"Redis快速入門","/workshop/redis",{"title":11546,"_path":11547},"Redis Ring","/workshop/redis-ring",{"title":11549,"_path":11550},"TDD技術分享 - Part1 灌輸","/workshop/tdd_part1","⚒️",{"title":11553,"_path":11554,"children":11555,"icon":11565},"Web API的設計與開發","/web-api",[11556,11559,11562],{"title":11557,"_path":11558},"第2章 EndPoint設計與請求形式","/web-api/chapter2",{"title":11560,"_path":11561},"第5章 開發方便更改設計的API","/web-api/chapter5",{"title":11563,"_path":11564},"第6章 開發牢固的WebAPI","/web-api/chapter6","📗",{"title":11567,"_path":11568,"children":11569,"icon":11597},"持續交付2.0：實務導向的DevOps","/cicd-2.0",[11570,11573,11576,11579,11582,11585,11588,11591,11594],{"title":11571,"_path":11572},"05 持續交付的軟體系統架構","/cicd-2.0/chapter5",{"title":11574,"_path":11575},"07 部署流水線原則與工具設計","/cicd-2.0/chapter7",{"title":11577,"_path":11578},"08 利於集成的分支策略","/cicd-2.0/chapter8",{"title":11580,"_path":11581},"09 持續整合","/cicd-2.0/chapter9",{"title":11583,"_path":11584},"10 自動化測試策略與方法","/cicd-2.0/chapter10",{"title":11586,"_path":11587},"11 軟件配置管理","/cicd-2.0/chapter11",{"title":11589,"_path":11590},"12 低風險發佈","/cicd-2.0/chapter12",{"title":11592,"_path":11593},"13 監測與決策","/cicd-2.0/chapter13",{"title":11595,"_path":11596},"16 研發推動的DevOps","/cicd-2.0/chapter16","🏷️",{"title":11599,"_path":11600,"children":11601,"icon":11613},"資料密集型應用系統設計","/ddia",[11602,11605,11608,11611,11612],{"title":11603,"_path":11604},"01 可靠性、可伸縮性和可維護性","/ddia/chapter1",{"title":11606,"_path":11607},"03 數據儲存與檢索","/ddia/chapter3",{"title":11609,"_path":11610},"04 編碼與演化","/ddia/chapter4",{"title":11495,"_path":11494},{"title":14,"_path":11},"📕",{"title":11615,"_path":11616,"children":11617,"icon":11691},"Clean Architecture - 無瑕的程式碼","/clean-arch",[11618,11619,11622,11625,11628,11631,11634,11637,11640,11643,11646,11649,11652,11655,11658,11661,11664,11667,11670,11673,11676,11679,11682,11685,11688],{"title":11505,"_path":11503},{"title":11620,"_path":11621},"02 兩種價值觀的故事","/clean-arch/chapter2",{"title":11623,"_path":11624},"03 範式概述","/clean-arch/chapter3",{"title":11626,"_path":11627},"04 結構化程式設計","/clean-arch/chapter4",{"title":11629,"_path":11630},"05 物件導向程式設計","/clean-arch/chapter5",{"title":11632,"_path":11633},"06 函數式程式設計","/clean-arch/chapter6",{"title":11635,"_path":11636},"12 元件","/clean-arch/chapter12",{"title":11638,"_path":11639},"13 元件內聚性","/clean-arch/chapter13",{"title":11641,"_path":11642},"14 元件耦合性","/clean-arch/chapter14",{"title":11644,"_path":11645},"15 什麼是架構","/clean-arch/chapter15",{"title":11647,"_path":11648},"16 獨立性","/clean-arch/chapter16",{"title":11650,"_path":11651},"18 邊界剖析","/clean-arch/chapter18",{"title":11653,"_path":11654},"19 POLICY AND LEVEL 策略與層次","/clean-arch/chapter19",{"title":11656,"_path":11657},"20 BUSINESS RULES 業務邏輯","/clean-arch/chapter20",{"title":11659,"_path":11660},"21 會尖叫的架構","/clean-arch/chapter21",{"title":11662,"_path":11663},"22 整潔的架構","/clean-arch/chapter22",{"title":11665,"_path":11666},"23 Presenter與Humble Object","/clean-arch/chapter23",{"title":11668,"_path":11669},"24 不完全邊界","/clean-arch/chapter24",{"title":11671,"_path":11672},"25 層與邊界","/clean-arch/chapter25",{"title":11674,"_path":11675},"30 資料庫細節","/clean-arch/chapter30",{"title":11677,"_path":11678},"31 WEB是細節","/clean-arch/chapter31",{"title":11680,"_path":11681},"32 框架也只是細節","/clean-arch/chapter32",{"title":11683,"_path":11684},"33 影片銷售系統案例研究","/clean-arch/chapter33",{"title":11686,"_path":11687},"Clean Architecture 第34章：The Missing Chapter","/clean-arch/chapter34",{"title":11689,"_path":11690},"99 來自於網路世界的書評","/clean-arch/chapter99","📘",{"title":11693,"_path":11694,"children":11695,"icon":11714},"System Design Interview: An Insider’s Guide","/sdi-aig",[11696,11699,11702,11705,11708,11711],{"title":11697,"_path":11698},"01 從 0 到百萬用戶","/sdi-aig/chapter1",{"title":11700,"_path":11701},"04 設計網路限速器","/sdi-aig/chapter4",{"title":11703,"_path":11704},"06 設計鍵值儲存系統","/sdi-aig/chapter6",{"title":11706,"_path":11707},"07 設計可用於分散式系統的唯一ID生成器","/sdi-aig/chapter7",{"title":11709,"_path":11710},"08 設計短網址生成器","/sdi-aig/chapter8",{"title":11712,"_path":11713},"09 設計網路爬蟲","/sdi-aig/chapter9","📖",{"📖":-1,"📘":-1,"📕":-1,"🏷️":-1,"📗":-1,"⚒️":-1,"🛡️":-1,"heroicons-outline:menu":11716,"el:group":11719,"mdi:github":11722,"lucide:chevrons-up-down":11724,"uil:edit":11726,"heroicons-outline:arrow-sm-left":11728,"heroicons-outline:arrow-sm-right":11730,"heroicons-outline:chevron-right":11732,"heroicons-outline:book-open":11734,"heroicons-outline:search":11736,"ph:copy":11738},{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11718},0,"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 6h16M4 12h16M4 18h16\"/>",{"left":11717,"top":11717,"width":11720,"height":11720,"rotate":11717,"vFlip":6,"hFlip":6,"body":11721},1200,"\u003Cpath fill=\"currentColor\" d=\"M596.847 188.488c-103.344 0-187.12 97.81-187.12 218.465c0 83.678 40.296 156.352 99.468 193.047l-68.617 31.801l-182.599 84.688c-17.64 8.821-26.444 23.778-26.444 44.947v201.102c1.451 25.143 16.537 48.577 40.996 48.974h649.62c27.924-2.428 42.05-24.92 42.325-48.974V761.436c0-21.169-8.804-36.126-26.443-44.947l-175.988-84.688l-73.138-34.65c56.744-37.521 95.061-108.624 95.061-190.197c-.001-120.656-83.778-218.466-187.121-218.466m-301.824 76.824c-44.473 1.689-79.719 20.933-106.497 51.596c-29.62 36.918-44.06 80.75-44.339 124.354c1.819 64.478 30.669 125.518 82.029 157.446L21.163 693.997C7.05 699.289 0 711.636 0 731.041v161.398c1.102 21.405 12.216 39.395 33.055 39.703h136.284V761.436c2.255-45.639 23.687-82.529 62.196-100.531l136.247-64.817c10.584-6.175 20.731-14.568 30.433-25.152c-56.176-86.676-63.977-190.491-27.773-281.801c-23.547-14.411-50.01-23.672-75.419-23.823m608.586 0c-29.083.609-55.96 11.319-78.039 26.444c35.217 92.137 25.503 196.016-26.482 276.52c11.467 13.23 23.404 23.377 35.753 30.434l130.965 62.195c39.897 21.881 60.47 59.098 60.866 100.532v170.707h140.235c23.063-1.991 32.893-20.387 33.093-39.704V731.042c0-17.641-7.05-29.987-21.163-37.045l-202.431-96.618c52.498-38.708 78.859-96.72 79.369-156.117c-1.396-47.012-15.757-90.664-44.339-124.354c-29.866-32.399-66.91-51.253-107.827-51.596\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11723},"\u003Cpath fill=\"currentColor\" d=\"M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5c.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34c-.46-1.16-1.11-1.47-1.11-1.47c-.91-.62.07-.6.07-.6c1 .07 1.53 1.03 1.53 1.03c.87 1.52 2.34 1.07 2.91.83c.09-.65.35-1.09.63-1.34c-2.22-.25-4.55-1.11-4.55-4.92c0-1.11.38-2 1.03-2.71c-.1-.25-.45-1.29.1-2.64c0 0 .84-.27 2.75 1.02c.79-.22 1.65-.33 2.5-.33s1.71.11 2.5.33c1.91-1.29 2.75-1.02 2.75-1.02c.55 1.35.2 2.39.1 2.64c.65.71 1.03 1.6 1.03 2.71c0 3.82-2.34 4.66-4.57 4.91c.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11725},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m7 15l5 5l5-5M7 9l5-5l5 5\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11727},"\u003Cpath fill=\"currentColor\" d=\"M21 12a1 1 0 0 0-1 1v6a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1h6a1 1 0 0 0 0-2H5a3 3 0 0 0-3 3v14a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-6a1 1 0 0 0-1-1m-15 .76V17a1 1 0 0 0 1 1h4.24a1 1 0 0 0 .71-.29l6.92-6.93L21.71 8a1 1 0 0 0 0-1.42l-4.24-4.29a1 1 0 0 0-1.42 0l-2.82 2.83l-6.94 6.93a1 1 0 0 0-.29.71m10.76-8.35l2.83 2.83l-1.42 1.42l-2.83-2.83ZM8 13.17l5.93-5.93l2.83 2.83L10.83 16H8Z\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11729},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m11 17l-5-5m0 0l5-5m-5 5h12\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11731},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m13 7l5 5m0 0l-5 5m5-5H6\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11733},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m9 5l7 7l-7 7\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11735},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18s-3.332.477-4.5 1.253\"/>",{"left":11717,"top":11717,"width":980,"height":980,"rotate":11717,"vFlip":6,"hFlip":6,"body":11737},"\u003Cpath fill=\"none\" stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m21 21l-6-6m2-5a7 7 0 1 1-14 0a7 7 0 0 1 14 0\"/>",{"left":11717,"top":11717,"width":11739,"height":11739,"rotate":11717,"vFlip":6,"hFlip":6,"body":11740},256,"\u003Cpath fill=\"currentColor\" d=\"M216 32H88a8 8 0 0 0-8 8v40H40a8 8 0 0 0-8 8v128a8 8 0 0 0 8 8h128a8 8 0 0 0 8-8v-40h40a8 8 0 0 0 8-8V40a8 8 0 0 0-8-8m-56 176H48V96h112Zm48-48h-32V88a8 8 0 0 0-8-8H96V48h112Z\"/>",{"parentPath":11600,"scrollTop":11717},{},{},{},{},{},{},{},{},["Set"],["ShallowReactive",11752],{"search-api":11753},null,1760542647088]</script>
<script>window.__NUXT__={};window.__NUXT__.config={public:{baseURL:"/code-study",mdc:{components:{prose:true,map:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"}},headings:{anchorLinks:{h1:false,h2:true,h3:true,h4:true,h5:false,h6:false}}},content:{locales:[],defaultLocale:"",integrity:1760542609693,experimental:{stripQueryParameters:false,advanceQuery:false,clientDB:false},respectPathCase:false,api:{baseURL:"/api/_content"},navigation:{fields:["icon","titleTemplate","header","main","aside","footer","layout"]},tags:{p:"prose-p",a:"prose-a",blockquote:"prose-blockquote","code-inline":"prose-code-inline",code:"ProseCodeInline",em:"prose-em",h1:"prose-h1",h2:"prose-h2",h3:"prose-h3",h4:"prose-h4",h5:"prose-h5",h6:"prose-h6",hr:"prose-hr",img:"prose-img",ul:"prose-ul",ol:"prose-ol",li:"prose-li",strong:"prose-strong",table:"prose-table",thead:"prose-thead",tbody:"prose-tbody",td:"prose-td",th:"prose-th",tr:"prose-tr"},highlight:{theme:{dark:"github-dark",default:"github-light",sepia:"monokai"},preload:["c","cpp","java","bash","xml","powershell","csharp","c#","go","kotlin","proto","sh","shell","zsh","graphql","groovy","json","js","ts","html","css","vue","diff","shell","markdown","yaml","bash","ini"],highlighter:"shiki",shikiEngine:"oniguruma",langs:["js","jsx","json","ts","tsx","vue","css","html","bash","md","mdc","yaml","c","cpp","java","bash","xml","powershell","csharp","c#","go","kotlin","proto","sh","shell","zsh","graphql","groovy","json","js","ts","html","css","vue","diff","shell","markdown","yaml","bash","ini"]},wsUrl:"",documentDriven:{page:true,navigation:true,surround:true,globals:{},layoutFallbacks:["theme"],injectPage:true},host:"",trailingSlash:false,search:"",contentHead:true,anchorLinks:{depth:4,exclude:[1]}},studio:{apiURL:"https://api.nuxt.studio",iframeMessagingAllowedOrigins:""}},app:{baseURL:"/code-study",buildId:"8cb8952e-8b29-4692-9461-5c70d236bedc",buildAssetsDir:"/_nuxt/",cdnURL:""}}</script></body></html>